<?xml version='1.0' encoding='UTF-8'?><?xml-stylesheet href="http://www.blogger.com/styles/atom.css" type="text/css"?><entry xmlns='http://www.w3.org/2005/Atom' xmlns:blogger='http://schemas.google.com/blogger/2008' xmlns:georss='http://www.georss.org/georss' xmlns:gd='http://schemas.google.com/g/2005' xmlns:thr='http://purl.org/syndication/thread/1.0'><id>tag:blogger.com,1999:blog-4838136820032157985.post-1353264177358891846</id><published>2022-03-31T09:00:00.003-07:00</published><updated>2022-08-24T12:04:44.188-07:00</updated><title type='text'>FORCEDENTRY: Sandbox Escape</title><content type='html'>&lt;style type=&quot;text/css&quot;&gt;ol{margin:0;padding:0}table td,table th{padding:0}.YDzVciBUld-c8{padding-top:16pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.YDzVciBUld-c7{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.YDzVciBUld-c1{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.YDzVciBUld-c16{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:right}.YDzVciBUld-c4{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.YDzVciBUld-c10{color:#434343;text-decoration:none;vertical-align:baseline;font-size:14pt;font-style:normal}.YDzVciBUld-c13{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:italic}.YDzVciBUld-c9{color:#000000;text-decoration:none;vertical-align:baseline;font-size:16pt;font-style:normal}.YDzVciBUld-c2{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.YDzVciBUld-c6{-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline;text-decoration-skip-ink:none}.YDzVciBUld-c17{background-color:#b6d7a8;font-family:&quot;Courier New&quot;;font-weight:700}.YDzVciBUld-c15{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.YDzVciBUld-c3{font-weight:400;font-family:&quot;Arial&quot;}.YDzVciBUld-c0{font-weight:400;font-family:&quot;Courier New&quot;}.YDzVciBUld-c11{color:inherit;text-decoration:inherit}.YDzVciBUld-c14{font-style:italic}.YDzVciBUld-c12{text-indent:36pt}.YDzVciBUld-c5{margin-left:36pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}p{margin:0;color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}&lt;/style&gt;&lt;/head&gt;&lt;body class=&quot;YDzVciBUld-c15&quot;&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Posted by Ian Beer &amp;amp; &lt;/span&gt;&lt;span&gt;Samuel Gro&amp;szlig;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;of Google Project Zero&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c13 YDzVciBUld-c3&quot;&gt;We want to thank Citizen Lab for sharing a sample of the FORCEDENTRY exploit with us, and Apple&amp;rsquo;s Security Engineering and Architecture (SEAR) group for collaborating with us on the technical analysis. Any editorial opinions reflected below are solely Project Zero&amp;rsquo;s and do not necessarily reflect those of the organizations we collaborated with during this research.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Late last year &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html&quot;&gt;we published a writeup&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;of the initial remote code execution stage of FORCEDENTRY, the zero-click iMessage exploit attributed by Citizen Lab to NSO.&lt;/span&gt;&lt;span&gt;&amp;nbsp;By sending a &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;.gif&lt;/span&gt;&lt;span&gt;&amp;nbsp;iMessage attachment (which was really a PDF) NSO were able to remotely trigger a heap buffer overflow in the ImageIO JBIG2 decoder. They used that vulnerability to bootstrap a powerful &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://en.wikipedia.org/wiki/Weird_machine&quot;&gt;weird machine&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;capable of loading the next stage in the infection process: the sandbox escape.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;In this post we&amp;#39;ll take a look at that sandbox escape. It&amp;#39;s notable for using only logic bugs. In fact it&amp;#39;s unclear where the features that it uses end and the vulnerabilities which it abuses begin. Both current and upcoming state-of-the-art mitigations such as Pointer Authentication and Memory Tagging have no impact at all on this sandbox escape.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;YDzVciBUld-c7&quot; id=&quot;h.80ze3m83kn16&quot;&gt;&lt;span class=&quot;YDzVciBUld-c9 YDzVciBUld-c3&quot;&gt;An observation&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;During our initial analysis of the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;.gif&lt;/span&gt;&lt;span&gt;&amp;nbsp;file Samuel noticed that rendering the image appeared to leak memory.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Running the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;heap&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;tool after releasing all the associated resources gave the following output:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;$ heap $pid&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;------------------------------------------------------------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;All zones: 4631 nodes (826336 bytes) &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp;COUNT &amp;nbsp; &amp;nbsp;BYTES &amp;nbsp; &amp;nbsp; AVG &amp;nbsp; CLASS_NAME &amp;nbsp; TYPE &amp;nbsp; BINARY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp;===== &amp;nbsp; &amp;nbsp;===== &amp;nbsp; &amp;nbsp; === &amp;nbsp; ========== &amp;nbsp; ==== &amp;nbsp; ====== &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; 1969 &amp;nbsp; 469120 &amp;nbsp; 238.3 &amp;nbsp; non-object &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;825 &amp;nbsp; &amp;nbsp;26400 &amp;nbsp; &amp;nbsp;32.0 &amp;nbsp; JBIG2Bitmap &amp;nbsp;C++ &amp;nbsp; CoreGraphics&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;heap&lt;/span&gt;&lt;span&gt;&amp;nbsp;was able to determine that the leaked memory contained &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;JBIG2Bitmap&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;objects.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Using the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;-address&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;option we could find all the individual leaked bitmap objects:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;$ heap -address JBIG2Bitmap $pid&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;and dump them out to files. &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;One of those objects was quite unlike the others:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;$ hexdump -C dumpXX.bin | head&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;00000000 &amp;nbsp;62 70 6c 69 73 74 30 30 &amp;nbsp;|bplist00|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;00000018 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;24 76 65 72 73 69 &amp;nbsp;| &amp;nbsp;$versi|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;00000020 &amp;nbsp;6f 6e 59 24 61 72 63 68 &amp;nbsp;|onY$arch|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;00000028 &amp;nbsp;69 76 65 72 58 24 6f 62 &amp;nbsp;|iverX$ob|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;00000030 &amp;nbsp;6a 65 63 74 73 54 24 74 &amp;nbsp;|jectsT$t|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;00000038 &amp;nbsp;6f 70 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;|op &amp;nbsp; &amp;nbsp; &amp;nbsp;|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;00000040 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;4e 53 4b 65 79 65 &amp;nbsp;| &amp;nbsp;NSKeye|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;00000048 &amp;nbsp;64 41 72 63 68 69 76 65 &amp;nbsp;|dArchive|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;It&amp;#39;s clearly a serialized &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6 YDzVciBUld-c0&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://developer.apple.com/documentation/foundation/nskeyedarchiver?language=objc&quot;&gt;NSKeyedArchiver&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. Definitely not what you&amp;#39;d expect to see in a &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;JBIG2Bitmap&lt;/span&gt;&lt;span&gt;&amp;nbsp;object. Running &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;strings&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;we see plenty of interesting things (noting that the URL below is redacted):&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;Objective-C class and selector names:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSFunctionExpression&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSConstantValueExpression&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSConstantValue&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;expressionValueWithObject:context:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;filteredArrayUsingPredicate:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;_web_removeFileOnlyAtPath:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;context:evaluateMobileSubscriberIdentity:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;performSelectorOnMainThread:withObject:waitUntilDone:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;The name of the file which delivered the exploit:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;XXX.gif&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;Filesystems paths:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;/tmp/com.apple.messages&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;/System/Library/PrivateFrameworks/SlideshowKit.framework/Frameworks/OpusFoundation.framework&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;a URL:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c5&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;https://XXX.cloudfront.net/YYY/ZZZ/megalodon?AAA&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Using &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;plutil&lt;/span&gt;&lt;span&gt;&amp;nbsp;we can convert the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;bplist00&lt;/span&gt;&lt;span&gt;&amp;nbsp;binary format to XML. Performing some post-processing and cleanup we can see that the top-level object in the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSKeyedArchiver&lt;/span&gt;&lt;span&gt;&amp;nbsp;is a serialized &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpression&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;object.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;YDzVciBUld-c7&quot; id=&quot;h.1ai2h2r4yshv&quot;&gt;&lt;span class=&quot;YDzVciBUld-c9 YDzVciBUld-c3&quot;&gt;NSExpression NSPredicate NSExpression&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;If you&amp;#39;ve ever used Core Data or tried to filter a Objective-C collection you might have come across &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicates&lt;/span&gt;&lt;span&gt;. &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://developer.apple.com/documentation/foundation/nspredicate?language=objc&quot;&gt;According to Apple&amp;#39;s public documentation&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;they are used &lt;/span&gt;&lt;span&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c14&quot;&gt;to define logical conditions for constraining a search for a fetch or for in-memory filtering&lt;/span&gt;&lt;span&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c13 YDzVciBUld-c3&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;For example, in Objective-C you could filter an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSArray&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;object like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; NSArray* names = @[@&amp;quot;one&amp;quot;, @&amp;quot;two&amp;quot;, @&amp;quot;three&amp;quot;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; NSPredicate* pred;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; pred = [NSPredicate predicateWithFormat:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; @&amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c17&quot;&gt;SELF beginswith[c] &amp;#39;t&amp;#39;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;quot;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; NSLog(@&amp;quot;%@&amp;quot;, [names filteredArrayUsingPredicate:pred]);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;The predicate is &amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;SELF beginswith[c] &amp;#39;t&amp;#39;&amp;quot;&lt;/span&gt;&lt;span&gt;. This prints an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSArray&lt;/span&gt;&lt;span&gt;&amp;nbsp;containing only &amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;two&lt;/span&gt;&lt;span&gt;&amp;quot; and &amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;three&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;quot;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;[NSPredicate predicateWithFormat]&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;builds a predicate object by parsing a small query language, a little like an SQL query. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicates&lt;/span&gt;&lt;span&gt;&amp;nbsp;can be built up from &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSExpressions&lt;/span&gt;&lt;span&gt;, connected by &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSComparisonPredicates&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;(like less-than, greater-than and so on.)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSExpressions&lt;/span&gt;&lt;span&gt;&amp;nbsp;themselves can be fairly complex, containing aggregate expressions (like &amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;IN&lt;/span&gt;&lt;span&gt;&amp;quot; and &amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CONTAINS&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;quot;), subqueries, set expressions, and, most interestingly, function expressions.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Prior to 2007 (in OS X 10.4 and below) function expressions were limited to just the following five extra built-in methods: &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;sum&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;count&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;min&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;max&lt;/span&gt;&lt;span&gt;, and &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;average&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;But starting in OS X 10.5 (which would also be around the launch of iOS in 2007) &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpressions&lt;/span&gt;&lt;span&gt;&amp;nbsp;were extended&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://developer.apple.com/documentation/foundation/nsexpression&quot;&gt;to allow &lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6 YDzVciBUld-c14&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://developer.apple.com/documentation/foundation/nsexpression&quot;&gt;arbitrary&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://developer.apple.com/documentation/foundation/nsexpression&quot;&gt;&amp;nbsp;method invocations&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;with the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;FUNCTION&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;keyword:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;quot;FUNCTION(&amp;#39;abc&amp;#39;, &amp;#39;stringByAppendingString&amp;#39;, &amp;#39;def&amp;#39;)&amp;quot; =&amp;gt; @&amp;quot;abcdef&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;FUNCTION&lt;/span&gt;&lt;span&gt;&amp;nbsp;takes a target object, a selector and an optional list of arguments then invokes the selector on the object, passing the arguments. In this case it will allocate an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSString&lt;/span&gt;&lt;span&gt;&amp;nbsp;object &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;@&amp;quot;abc&amp;quot;&lt;/span&gt;&lt;span&gt;&amp;nbsp;then invoke the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;stringByAppendingString:&lt;/span&gt;&lt;span&gt;&amp;nbsp;selector passing the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSString&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;@&amp;quot;def&amp;quot;&lt;/span&gt;&lt;span&gt;, which will evaluate to the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSString&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;@&amp;quot;abcdef&amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;In addition to the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;FUNCTION&lt;/span&gt;&lt;span&gt;&amp;nbsp;keyword there&amp;#39;s &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CAST&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;which allows full reflection-based access to all Objective-C types (as opposed to just being able to invoke selectors on literal strings and integers):&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;&amp;nbsp; &amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;FUNCTION(CAST(&amp;#39;NSFileManager&amp;#39;, &amp;#39;Class&amp;#39;), &amp;#39;defaultManager&amp;#39;)&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Here we can get access to the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFileManager&lt;/span&gt;&lt;span&gt;&amp;nbsp;class and call the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;defaultManager&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;selector to get a reference to a process&amp;#39;s shared file manager instance.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;These keywords exist in the string representation of &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicates&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSExpressions&lt;/span&gt;&lt;span&gt;. Parsing those strings involves creating a graph of &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSExpression&lt;/span&gt;&lt;span&gt;&amp;nbsp;objects, &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicate&lt;/span&gt;&lt;span&gt;&amp;nbsp;objects and their subclasses like &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpression&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;. It&amp;#39;s a serialized version of such a graph which is present in the JBIG2 bitmap.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicates&lt;/span&gt;&lt;span&gt;&amp;nbsp;using the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;FUNCTION&lt;/span&gt;&lt;span&gt;&amp;nbsp;keyword are effectively Objective-C scripts. With some tricks it&amp;#39;s possible to build nested function calls which can do almost anything you could do in procedural Objective-C. Figuring out some of those tricks was the key to the 2019 &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://realworldctf.com/&quot;&gt;Real World CTF&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://github.com/ChiChou/DezhouInstrumenz/&quot;&gt;DezhouInstrumenz&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;challenge, which would evaluate an attacker supplied &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSExpression&lt;/span&gt;&lt;span&gt;&amp;nbsp;format string. The &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://blog.chichou.me/2021/01/16/see-no-eval-runtime-code-execution-objc/&quot;&gt;writeup by the challenge author&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;is a great introduction to these ideas and I&amp;#39;d strongly recommend reading that now if you haven&amp;#39;t. The rest of this post builds on the tricks described in that post.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;YDzVciBUld-c7&quot; id=&quot;h.lu8fbgty57ln&quot;&gt;&lt;span class=&quot;YDzVciBUld-c9 YDzVciBUld-c3&quot;&gt;A tale of two parts&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;The only job of the JBIG2 logic gate machine described in the previous blog post is to cause the deserialization and evaluation of an embedded &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpression&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;. No attempt is made to get native code execution, ROP, JOP or any similar technique.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Prior to iOS 14.5 the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;isa&lt;/span&gt;&lt;span&gt;&amp;nbsp;field of an Objective-C object was not protected by Pointer Authentication Codes (&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PAC)&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span&gt;so the JBIG2 machine builds a fake Objective-C object with a fake &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;isa&lt;/span&gt;&lt;span&gt;&amp;nbsp;such that the invocation of the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;dealloc&lt;/span&gt;&lt;span&gt;&amp;nbsp;selector causes the deserialization and evaluation of the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpression&lt;/span&gt;&lt;span&gt;. This is very similar to the technique used by &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://googleprojectzero.blogspot.com/2020/01/remote-iphone-exploitation-part-3.html&quot;&gt;Samuel in the 2020 SLOP post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;This &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpression&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;has two purposes:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Firstly, it allocates and leaks an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;ASMKeepAlive&lt;/span&gt;&lt;span&gt;&amp;nbsp;object then tries to cover its tracks by finding and deleting the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;.gif&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;file which delivered the exploit.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Secondly, it builds a payload &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicate&lt;/span&gt;&lt;span&gt;&amp;nbsp;object then triggers a logic bug to get that &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicate&lt;/span&gt;&lt;span&gt;&amp;nbsp;object evaluated in the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CommCenter&lt;/span&gt;&lt;span&gt;&amp;nbsp;process, reachable from the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;IMTranscoderAgent&lt;/span&gt;&lt;span&gt;&amp;nbsp;sandbox via the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;com.apple.commcenter.xpc&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSXPC&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;service.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;Let&amp;#39;s look at those two parts separately:&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;YDzVciBUld-c7&quot; id=&quot;h.t2uistlubhwq&quot;&gt;&lt;span class=&quot;YDzVciBUld-c9 YDzVciBUld-c3&quot;&gt;Covering tracks&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;The outer level &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpression&lt;/span&gt;&lt;span&gt;&amp;nbsp;calls &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;performSelectorOnMainThread:withObject:waitUntilDone&lt;/span&gt;&lt;span&gt;&amp;nbsp;which in turn calls &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;makeObjectsPerformSelector:@&amp;quot;expressionValueWithObject:context:&amp;quot;&lt;/span&gt;&lt;span&gt;&amp;nbsp;on an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSArray&lt;/span&gt;&lt;span&gt;&amp;nbsp;of four &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpressions&lt;/span&gt;&lt;span&gt;. This allows the four independent &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpressions&lt;/span&gt;&lt;span&gt;&amp;nbsp;to be evaluated sequentially.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;With some manual cleanup we can recover pseudo-Objective-C versions of the serialized &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpressions&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;The first one does this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[[AMSKeepAlive alloc] initWithName:&amp;quot;KA&amp;quot;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;This allocates and then &lt;/span&gt;&lt;span&gt;leaks an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;AppleMediaServices&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;KeepAlive&lt;/span&gt;&lt;span&gt;&amp;nbsp;object&lt;/span&gt;&lt;span&gt;. The exact purpose of this is unclear.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;The second entry does this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[[NSFileManager defaultManager] _web_removeFileOnlyAtPath: &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; [@&amp;quot;/tmp/com.apple.messages&amp;quot; stringByAppendingPathComponent:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; [ [ [ [&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; [NSFileManager defaultManager]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; enumeratorAtPath: @&amp;quot;/tmp/com.apple.messages&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; allObjects&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; filteredArrayUsingPredicate:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; [&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; [NSPredicate predicateWithFormat:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; [&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; [@&amp;quot;SELF ENDSWITH &amp;#39;&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; stringByAppendingString: &amp;quot;XXX.gif&amp;quot;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; stringByAppendingString: &amp;quot;&amp;#39;&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; ] &amp;nbsp; ] ] ]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; firstObject&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; ]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; ]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Reading these single expression &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpressions&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;is a little tricky; breaking that down into a more procedural form it&amp;#39;s equivalent to this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSFileManager* fm = [NSFileManager defaultManager];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSDirectoryEnumerator* dir_enum;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;dir_enum = [fm enumeratorAtPath: @&amp;quot;/tmp/com.apple.messages&amp;quot;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSArray* allTmpFiles = [dir_enum allObjects];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSString* filter;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;filter = [&amp;quot;@&amp;quot;SELF ENDSWITH &amp;#39;&amp;quot; stringByAppendingString: &amp;quot;XXX.gif&amp;quot;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;filter = [filter stringByAppendingString: &amp;quot;&amp;#39;&amp;quot;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSPredicate* pred;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;pred = [NSPredicate predicateWithFormat: filter]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSArray* matches;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;matches = [allTmpFiles filteredArrayUsingPredicate: pred];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSString* gif_subpath = [matches firstObject];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSString* root = @&amp;quot;/tmp/com.apple.messages&amp;quot;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSString* full_path;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;full_path = [root stringByAppendingPathComponent: gifSubpath];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[fm _web_removeFileOnlyAtPath: full_path];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;This finds the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;XXX.gif&lt;/span&gt;&lt;span&gt;&amp;nbsp;file used to deliver the exploit which iMessage has stored somewhere under the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;/tmp/com.apple.messages&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;folder and deletes it&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;The other two &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpressions&lt;/span&gt;&lt;span&gt;&amp;nbsp;build a payload and then trigger its evaluation in &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CommCenter&lt;/span&gt;&lt;span&gt;. For that we need to look at &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSXPC&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;YDzVciBUld-c7&quot; id=&quot;h.3sby3b68al28&quot;&gt;&lt;span class=&quot;YDzVciBUld-c3 YDzVciBUld-c9&quot;&gt;NSXPC&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;NSXPC is a semi-transparent remote-procedure-call mechanism for Objective-C. It allows the instantiation of proxy objects in one process which transparently forward method calls to the &amp;quot;real&amp;quot; object in another process:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;/p&gt;
  
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjOvov7r0oFPPVDeNeBSf3Hspypl5AGeZj30ulogkGLGBXJZoy4lDoiunsF9MptZWtnpCyKST1rrP3JtdyqUCvpsAopFrlqp_3b9EuHUFh9FJqnT3iANV_Esl-InoKip8mUjW3BRjNnPOpaj1dQyfoyr5O8apA4yJzsZcPc5mnTeMEsOcqAZQKBsKr5/s1437/image1%286%29.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjOvov7r0oFPPVDeNeBSf3Hspypl5AGeZj30ulogkGLGBXJZoy4lDoiunsF9MptZWtnpCyKST1rrP3JtdyqUCvpsAopFrlqp_3b9EuHUFh9FJqnT3iANV_Esl-InoKip8mUjW3BRjNnPOpaj1dQyfoyr5O8apA4yJzsZcPc5mnTeMEsOcqAZQKBsKr5/s1200/image1%286%29.png&quot; border=&quot;0&quot; alt=&quot;&quot; style=&quot;max-height: 750; max-width: 600px;&quot; title=&quot;&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c16&quot;&gt;&lt;span class=&quot;YDzVciBUld-c13 YDzVciBUld-c3&quot;&gt;https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingXPCServices.html&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;I say NSXPC is only semi-transparent because it does enforce some restrictions on what objects are allowed to traverse process boundaries. Any object &amp;quot;exported&amp;quot; via &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSXPC&lt;/span&gt;&lt;span&gt;&amp;nbsp;must also define a &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;protocol&lt;/span&gt;&lt;span&gt;&amp;nbsp;which designates which methods can be invoked and the allowable types for each argument. The &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingXPCServices.html#//apple_ref/doc/uid/10000172i-SW6-SW7&quot;&gt;NSXPC programming guide&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;further explains the extra handling required for methods which require collections and other edge cases.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;The low-level serialization used by NSXPC is the same explored by Natalie Silvanovich in her 2019 blog post looking at &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://googleprojectzero.blogspot.com/2019/08/the-fully-remote-attack-surface-of.html&quot;&gt;the fully-remote attack surface of the iPhone&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. An important observation in that post was that &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c14&quot;&gt;subclasses of classes with any level of inheritance are also allowed, as is always the case with NSKeyedUnarchiver deserialization.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;This means that any &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;protocol&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;object which declares a particular type for a field will also, by design, accept any subclass of that type.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;The logical extreme of this would be that a protocol which declared an argument type of NSObject would allow any subclass, which is the vast majority of all Objective-C classes.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;YDzVciBUld-c7&quot; id=&quot;h.v64ixuc668lc&quot;&gt;&lt;span class=&quot;YDzVciBUld-c9 YDzVciBUld-c3&quot;&gt;Grep to the rescue&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;This is fairly easy to analyze automatically. Protocols are defined statically so we can just find them and check each one. Tools like &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://github.com/nst/RuntimeBrowser/&quot;&gt;RuntimeBrowser&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;http://stevenygard.com/projects/class-dump/&quot;&gt;classdump&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;can parse the static protocol definitions and output human-readable source code. Grepping the output of RuntimeBrowser like this is sufficient to find dozens of cases of &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSObject&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;pointers in Objective-C protocols:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; $ egrep -Rn &amp;quot;\(NSObject \*\)arg&amp;quot; *&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Not all the results are necessarily exposed via &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSXPC&lt;/span&gt;&lt;span&gt;, but some clearly are, including the following two matches in &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CoreTelephony.framework&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;Frameworks/CoreTelephony.framework/\&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;CTXPCServiceSubscriberInterface-Protocol.h:39:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;-(void)evaluateMobileSubscriberIdentity:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (CTXPCServiceSubscriptionContext *)arg1&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;identity:(NSObject *)arg2&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;completion:(void (^)(NSError *))arg3;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;Frameworks/CoreTelephony.framework/\&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;CTXPCServiceCarrierBundleInterface-Protocol.h:13:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;-(void)setWiFiCallingSettingPreferences:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;(CTXPCServiceSubscriptionContext *)arg1&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;key:(NSString *)arg2&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;value:(NSObject *)arg3&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;completion:(void (^)(NSError *))arg4;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;evaluateMobileSubscriberIdentity&lt;/span&gt;&lt;span&gt;&amp;nbsp;string appears in the list of selector-like strings we first saw when running strings on the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;bplist00&lt;/span&gt;&lt;span&gt;. Indeed, looking at the parsed and beautified &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpression&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;we see it doing this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[ [ [CoreTelephonyClient alloc] init]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; context:X&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; evaluateMobileSubscriberIdentity:Y]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;This is a wrapper around the lower-level &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSXPC&lt;/span&gt;&lt;span&gt;&amp;nbsp;code and the argument passed as &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;Y&lt;/span&gt;&lt;span&gt;&amp;nbsp;above to the CoreTelephonyClient method corresponds to the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;identity:(NSObject *)arg2&lt;/span&gt;&lt;span&gt;&amp;nbsp;argument passed via &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSXPC&lt;/span&gt;&lt;span&gt;&amp;nbsp;to &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CommCenter&lt;/span&gt;&lt;span&gt;&amp;nbsp;(which is the process that hosts &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;com.apple.commcenter.xpc&lt;/span&gt;&lt;span&gt;, the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSXPC&lt;/span&gt;&lt;span&gt;&amp;nbsp;service underlying the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CoreTelephonyClient&lt;/span&gt;&lt;span&gt;). Since the parameter is explicitly named as &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSObject*&lt;/span&gt;&lt;span&gt;&amp;nbsp;we can in fact pass any subclass of &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSObject*&lt;/span&gt;&lt;span&gt;, including an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicate&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;! Game over?&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;YDzVciBUld-c7&quot; id=&quot;h.7ums8k4ivkbp&quot;&gt;&lt;span class=&quot;YDzVciBUld-c9 YDzVciBUld-c3&quot;&gt;Parsing vs Evaluation&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;It&amp;#39;s not quite that easy. The &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://blog.chichou.me/2021/01/16/see-no-eval-runtime-code-execution-objc/&quot;&gt;DezhouInstrumentz writeup&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;discusses this attack surface and notes that there&amp;#39;s an extra, specific mitigation. When an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicate&lt;/span&gt;&lt;span&gt;&amp;nbsp;is deserialized by its &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;initWithCoder:&lt;/span&gt;&lt;span&gt;&amp;nbsp;implementation it sets a flag which disables evaluation of the predicate until the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;allowEvaluation&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;method is called.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;So whilst you certainly can pass an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicate*&lt;/span&gt;&lt;span&gt;&amp;nbsp;as the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;identity&lt;/span&gt;&lt;span&gt;&amp;nbsp;argument across NSXPC and get it deserialized in &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CommCenter,&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;the implementation of &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;evaluateMobileSubscriberIdentity:&lt;/span&gt;&lt;span&gt;&amp;nbsp;in &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CommCenter&lt;/span&gt;&lt;span&gt;&amp;nbsp;is definitely not going to call &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;allowEvaluation:&lt;/span&gt;&lt;span&gt;&amp;nbsp; to make the predicate safe for evaluation then &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;evaluateWithObject:&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;and then evaluate it.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;YDzVciBUld-c7&quot; id=&quot;h.34h1kqwr3d8t&quot;&gt;&lt;span class=&quot;YDzVciBUld-c9 YDzVciBUld-c3&quot;&gt;Old techniques, new tricks&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;From the exploit we can see that they in fact pass an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSArray&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;with two elements:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[0] = AVSpeechSynthesisVoice&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[1] = PTSection {rows = NSArray { [0] = PTRow() }&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;The first element is an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;AVSpeechSynthesisVoice&lt;/span&gt;&lt;span&gt;&amp;nbsp;object and the second is a &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTSection&lt;/span&gt;&lt;span&gt;&amp;nbsp;containing a single &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTRow&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;. Why?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTSection&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTRow&lt;/span&gt;&lt;span&gt;&amp;nbsp;are both defined in the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PrototypeTools&lt;/span&gt;&lt;span&gt;&amp;nbsp;private framework. &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PrototypeTools&lt;/span&gt;&lt;span&gt;&amp;nbsp;isn&amp;#39;t loaded in the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CommCenter&lt;/span&gt;&lt;span&gt;&amp;nbsp;target process. Let&amp;#39;s look at what happens when an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;AVSpeechSynthesisVoice&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;is deserialized:&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;YDzVciBUld-c7&quot; id=&quot;h.ihjz2r1jcklz&quot;&gt;&lt;span&gt;Finding a voice&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;AVSpeechSynthesisVoice&lt;/span&gt;&lt;span&gt;&amp;nbsp;is implemented in &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;AVFAudio.framework&lt;/span&gt;&lt;span&gt;, which &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c14&quot;&gt;is&lt;/span&gt;&lt;span&gt;&amp;nbsp;loaded in &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CommCenter&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;$ sudo vmmap `pgrep CommCenter` | grep AVFAudio&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;__TEXT &amp;nbsp;7ffa22c4c000-7ffa22d44000 r-x/r-x SM=COW \&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;/System/Library/Frameworks/AVFAudio.framework/Versions/A/AVFAudio&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Assuming that this was the first time that an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;AVSpeechSynthesisVoice&lt;/span&gt;&lt;span&gt;&amp;nbsp;object was created inside CommCenter (which is quite likely) the Objective-C runtime will call the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;initialize&lt;/span&gt;&lt;span&gt;&amp;nbsp;method on the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;AVSpeechSynthesisVoice&lt;/span&gt;&lt;span&gt;&amp;nbsp;class &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://developer.apple.com/documentation/objectivec/nsobject/1418639-initialize?language=objc&quot;&gt;before instantiating the first instance&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;[AVSpeechSynthesisVoice initialize]&lt;/span&gt;&lt;span&gt;&amp;nbsp;has a &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;dispatch_once&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;block with the following code:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSBundle* bundle;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;bundle = [NSBundle bundleWithPath:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;@&amp;quot;/System/Library/AccessibilityBundles/\&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;AXSpeechImplementation.bundle&amp;quot;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;if (![bundle isLoaded]) {&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; NSError err;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; [bundle loadAndReturnError:&amp;amp;err]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;So sending a serialized &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;AVSpeechSynthesisVoice&lt;/span&gt;&lt;span&gt;&amp;nbsp;object will cause &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CommCenter&lt;/span&gt;&lt;span&gt;&amp;nbsp;to load the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;/System/Library/AccessibilityBundles/AXSpeechImplementation.bundle&lt;/span&gt;&lt;span&gt;&amp;nbsp;library. With some scripting using otool -L to list dependencies we can &amp;nbsp;find the following dependency chain from &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;AXSpeechImplementation.bundle&lt;/span&gt;&lt;span&gt;&amp;nbsp;to &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PrototypeTools.framework&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[&amp;#39;/System/Library/AccessibilityBundles/\&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; AXSpeechImplementation.bundle/AXSpeechImplementation&amp;#39;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp;&amp;#39;/System/Library/AccessibilityBundles/\&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; AXSpeechImplementation.bundle/AXSpeechImplementation&amp;#39;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp;&amp;#39;/System/Library/PrivateFrameworks/\&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; AccessibilityUtilities.framework/AccessibilityUtilities&amp;#39;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp;&amp;#39;/System/Library/PrivateFrameworks/\&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; AccessibilitySharedSupport.framework/AccessibilitySharedSupport&amp;#39;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;#39;/System/Library/PrivateFrameworks/Sharing.framework/Sharing&amp;#39;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;#39;/System/Library/PrivateFrameworks/\&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; PrototypeTools.framework/PrototypeTools&amp;#39;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;This explains how the deserialization of a &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTSection&lt;/span&gt;&lt;span&gt;&amp;nbsp;will succeed. But what&amp;#39;s so special about &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTSections&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTRows&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;?&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;YDzVciBUld-c7&quot; id=&quot;h.tsdrbvcjutdl&quot;&gt;&lt;span&gt;Predicated Sections&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;[PTRow initwithcoder:]&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;contains the following snippet:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; self-&amp;gt;condition = [coder decodeObjectOfClass:NSPredicate&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;forKey:@&amp;quot;condition&amp;quot;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; [self-&amp;gt;condition allowEvaluation]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;This will deserialize an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicate&lt;/span&gt;&lt;span&gt;&amp;nbsp;object, assign it to the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTRow&lt;/span&gt;&lt;span&gt;&amp;nbsp;member variable &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;condition&lt;/span&gt;&lt;span&gt;&amp;nbsp;and call &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;allowEvaluation&lt;/span&gt;&lt;span&gt;. This is meant to indicate that the deserializing code considers this predicate safe, but there&amp;#39;s no attempt to perform any validation on the predicate contents here. They then need one more trick to find a path to which will additionally evaluate the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTRow&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;#39;s condition predicate.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Here&amp;#39;s a snippet from &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;[PTSection initWithCoder:]&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;NSSet* allowed = [NSSet setWithObjects: @[PTRow]]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;id* rows = [coder &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;decodeObjectOfClasses&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;:allowed forKey:@&amp;quot;rows&amp;quot;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[self initWithRows:rows]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;This deserializes an array of &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTRows&lt;/span&gt;&lt;span&gt;&amp;nbsp;and passes them to &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;[PTSection initWithRows]&lt;/span&gt;&lt;span&gt;&amp;nbsp;which assigns a copy of the array of &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTRows&lt;/span&gt;&lt;span&gt;&amp;nbsp;to&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;&amp;nbsp;PTSection-&amp;gt;rows&lt;/span&gt;&lt;span&gt;&amp;nbsp;then calls &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;[self &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;_reloadEnabledRows&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;]&lt;/span&gt;&lt;span&gt;&amp;nbsp;which in turn passes each row to &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[self _shouldEnableRow:]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;_shouldEnableRow:row {&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; if (row-&amp;gt;condition) {&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; return [row-&amp;gt;condition evaluateWithObject: self-&amp;gt;settings]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; }&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;And thus, by sending a &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTSection&lt;/span&gt;&lt;span&gt;&amp;nbsp;containing a single &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTRow&lt;/span&gt;&lt;span&gt;&amp;nbsp;with an attached condition &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicate&lt;/span&gt;&lt;span&gt;&amp;nbsp;they can cause the evaluation of an arbitrary &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicate&lt;/span&gt;&lt;span&gt;, effectively equivalent to arbitrary code execution in the context of &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CommCenter&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;. &lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;YDzVciBUld-c7&quot; id=&quot;h.9aaj7tmx81zt&quot;&gt;&lt;span class=&quot;YDzVciBUld-c9 YDzVciBUld-c3&quot;&gt;Payload 2&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicate&lt;/span&gt;&lt;span&gt;&amp;nbsp;attached to the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTRow&lt;/span&gt;&lt;span&gt;&amp;nbsp;uses a similar trick to the first payload to cause the evaluation of six independent &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpressions&lt;/span&gt;&lt;span&gt;, but this time in the context of the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;CommCenter&lt;/span&gt;&lt;span&gt;&amp;nbsp;process. &lt;/span&gt;&lt;span&gt;They&amp;#39;re presented here in pseudo Objective-C:&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;YDzVciBUld-c8&quot; id=&quot;h.4c2mqlgknm1m&quot;&gt;&lt;span class=&quot;YDzVciBUld-c10 YDzVciBUld-c3&quot;&gt;Expression 1&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[ &amp;nbsp;[CaliCalendarAnonymizer sharedAnonymizedStrings]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp;setObject:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;@[[NSURLComponents&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;componentsWithString:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;@&amp;quot;https://cloudfront.net/XXX/XXX/XXX?aaaa&amp;quot;], &amp;#39;0&amp;#39;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp;forKey: @&amp;quot;0&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;The use of &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;[CaliCalendarAnonymizer sharedAnonymizedStrings]&lt;/span&gt;&lt;span&gt;&amp;nbsp;is a trick to enable the array of independent &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpressions&lt;/span&gt;&lt;span&gt;&amp;nbsp;to have &amp;quot;local variables&amp;quot;. In this first case they create an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0 YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://developer.apple.com/documentation/foundation/nsurlcomponents&quot;&gt;NSURLComponents&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;object which is used to build parameterised URLs. This URL builder is then stored in the global dictionary returned by &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;[CaliCalendarAnonymizer sharedAnonymizedStrings]&lt;/span&gt;&lt;span&gt;&amp;nbsp;under the key &amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;quot;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;YDzVciBUld-c8&quot; id=&quot;h.f96qjcb9lnky&quot;&gt;&lt;span class=&quot;YDzVciBUld-c10 YDzVciBUld-c3&quot;&gt;Expression 2&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[[NSBundle&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; bundleWithPath:@&amp;quot;/System/Library/PrivateFrameworks/\&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;SlideshowKit.framework/Frameworks/OpusFoundation.framework&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp;] load]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;This causes the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;OpusFoundation&lt;/span&gt;&lt;span&gt;&amp;nbsp;library to be loaded. The exact reason for this is unclear, though the dependency graph of &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;OpusFoundation&lt;/span&gt;&lt;span&gt;&amp;nbsp;does include &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;AuthKit&lt;/span&gt;&lt;span&gt;&amp;nbsp;which is used by the next &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSFunctionExpression&lt;/span&gt;&lt;span&gt;. It&amp;#39;s possible that this payload is generic and might also be expected to work when evaluated in processes where &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;AuthKit&lt;/span&gt;&lt;span&gt;&amp;nbsp;isn&amp;#39;t loaded.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;YDzVciBUld-c8&quot; id=&quot;h.o9lhtiv01xpk&quot;&gt;&lt;span class=&quot;YDzVciBUld-c3 YDzVciBUld-c10&quot;&gt;Expression 3&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[ [ [CaliCalendarAnonymizer sharedAnonymizedStrings]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; objectForKey:@&amp;quot;0&amp;quot; ]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; setQueryItems:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; [ [ [NSArray arrayWithObject: &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;[NSURLQueryItem&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; queryItemWithName: @&amp;quot;m&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; value:[AKDevice _hardwareModel] ]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;] arrayByAddingObject: &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;[NSURLQueryItem&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; queryItemWithName: @&amp;quot;v&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; value:[AKDevice _buildNumber] ]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;] arrayByAddingObject:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;[NSURLQueryItem&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; queryItemWithName: @&amp;quot;u&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; value:[NSString randomString]]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;This grabs a reference to the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSURLComponents&lt;/span&gt;&lt;span&gt;&amp;nbsp;object stored under the &amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;0&lt;/span&gt;&lt;span&gt;&amp;quot; key in the global &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;sharedAnonymizedStrings&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;dictionary then parameterizes the HTTP query string with three values:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;[AKDevice _hardwareModel]&lt;/span&gt;&lt;span&gt;&amp;nbsp;returns a string like &amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;iPhone12,3&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;quot; which determines the exact device model.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;[AKDevice _buildNumber]&lt;/span&gt;&lt;span&gt;&amp;nbsp;returns a string like &amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;18A8395&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;quot; which in combination with the device model allows determining the exact firmware image running on the device.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;[NSString randomString]&lt;/span&gt;&lt;span&gt;&amp;nbsp;returns a decimal string representation of a 32-bit random integer like &amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;394681493&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;quot;.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;YDzVciBUld-c8&quot; id=&quot;h.ifxeb8zet13e&quot;&gt;&lt;span class=&quot;YDzVciBUld-c10 YDzVciBUld-c3&quot;&gt;Expression 4&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[ [CaliCalendarAnonymizer sharedAnonymizedString]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; setObject:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; [NSPropertyListSerialization&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; propertyListWithData:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; [[[NSData&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;dataWithContentsOfURL:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;[[[CaliCalendarAnonymizer sharedAnonymizedStrings]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;objectForKey:@&amp;quot;0&amp;quot;] URL]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ] AES128DecryptWithPassword:NSData(XXXX)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;] &amp;nbsp;decompressedDataUsingAlgorithm:3 error:]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;options: Class(NSConstantValueExpression)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; format: Class(NSConstantValueExpression)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; errors:Class(NSConstantValueExpression)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; ]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; forKey:@&amp;quot;1&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;The innermost reference to &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;sharedAnonymizedStrings&lt;/span&gt;&lt;span&gt;&amp;nbsp;here grabs the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSURLComponents&lt;/span&gt;&lt;span&gt;&amp;nbsp;object and builds the full url from the query string parameters set last earlier. That url is passed to &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;[NSData dataWithContentsOfURL:]&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;to fetch a data blob from a remote server.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;That data blob is decrypted with a hardcoded AES128 key, decompressed using zlib then parsed as a plist. That parsed plist is stored in the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;sharedAnonymizedStrings&lt;/span&gt;&lt;span&gt;&amp;nbsp;dictionary under the key &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;&amp;quot;1&amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;YDzVciBUld-c8&quot; id=&quot;h.rmw3ubtmn06v&quot;&gt;&lt;span class=&quot;YDzVciBUld-c10 YDzVciBUld-c3&quot;&gt;Expression 5&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[ [[NSThread mainThread] threadDictionary]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; addEntriesFromDictionary:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; [[CaliCalendarAnonymizer sharedAnonymizedStrings]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; objectForKey:@&amp;quot;1&amp;quot;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;This copies all the keys and values from the &amp;quot;next-stage&amp;quot; plist into the main thread&amp;#39;s theadDictionary.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;YDzVciBUld-c8&quot; id=&quot;h.qzgbnlme8c4b&quot;&gt;&lt;span class=&quot;YDzVciBUld-c10 YDzVciBUld-c3&quot;&gt;Expression 6&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;[ [NSExpression expressionWithFormat:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; [[[CaliCalendarAnonymizer sharedAnonymizedStrings]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; objectForKey:@&amp;quot;1&amp;quot;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; objectForKey: @&amp;quot;a&amp;quot;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c0 YDzVciBUld-c2&quot;&gt;&amp;nbsp; ]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; expressionValueWithObject:nil context:nil&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Finally, this fetches the value of the &amp;quot;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;a&lt;/span&gt;&lt;span&gt;&amp;quot; key from the next-stage plist, parses it as an &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSExpression&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;string and evaluates it.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;YDzVciBUld-c7&quot; id=&quot;h.5m5pj8ghutz4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c9 YDzVciBUld-c3&quot;&gt;End of the line&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;At this point we lose the ability to follow the exploit. The attackers have escaped the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;IMTranscoderAgent&lt;/span&gt;&lt;span&gt;&amp;nbsp;sandbox, requested a next-stage from the command and control server and executed it, all without any memory corruption or dependencies on particular versions of the operating system.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;In response to this exploit&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://developer.apple.com/documentation/ios-ipados-release-notes/ios-ipados-15_1-release-notes&quot;&gt;iOS 15.1 significantly reduced the computational power available to NSExpressions&lt;/a&gt;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4 YDzVciBUld-c12&quot;&gt;&lt;span class=&quot;YDzVciBUld-c3 YDzVciBUld-c13&quot;&gt;NSExpression immediately forbids certain operations that have significant side effects, like creating and destroying objects. Additionally, casting string class names into Class objects with NSConstantValueExpression is deprecated.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1 YDzVciBUld-c12&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;In addition the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTSection&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;PTRow&lt;/span&gt;&lt;span&gt;&amp;nbsp;objects have been hardened with the following check added around the parsing of serialized &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicates&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;if (os_variant_allows_internal_security_policies(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;quot;com.apple.PrototypeTools&amp;quot;) {&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;&amp;nbsp; [coder decodeObjectOfClass:NSPredicate forKey:@&amp;quot;condition]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c0&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Object deserialization across trust boundaries still presents an enormous attack surface however&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;YDzVciBUld-c7&quot; id=&quot;h.fyh8k0aja0xk&quot;&gt;&lt;span class=&quot;YDzVciBUld-c9 YDzVciBUld-c3&quot;&gt;Conclusion&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;Perhaps the most striking takeaway is the depth of the attack surface reachable from what would hopefully be a fairly constrained sandbox. With just two tricks (&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSObject&lt;/span&gt;&lt;span&gt;&amp;nbsp;pointers in protocols and library loading gadgets) it&amp;#39;s likely possible to attack almost every &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;initWithCoder&lt;/span&gt;&lt;span&gt;&amp;nbsp;implementation in the &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;dyld_shared_cache&lt;/span&gt;&lt;span&gt;. There are presumably many other classes in addition to &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSPredicate&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c0&quot;&gt;NSExpression&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&amp;nbsp;which provide the building blocks for logic-style exploits.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;The expressive power of NSXPC just seems fundamentally ill-suited for use across sandbox boundaries, even though it was designed with exactly that in mind. The attack surface reachable from inside a sandbox should be minimal, enumerable and reviewable. Ideally only code which is required for correct functionality should be reachable; it should be possible to determine exactly what that exposed code is and the amount of exposed code should be small enough that manually reviewing it is tractable. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;NSXPC requiring developers to explicitly add remotely-exposed methods to interface protocols is a great example of how to make the attack surface enumerable - you can at least find all the entry points fairly easily. However the support for inheritance means that the attack surface exposed there likely isn&amp;#39;t reviewable; it&amp;#39;s simply too large for anything beyond a basic&lt;/span&gt;&lt;span&gt;&amp;nbsp;example&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;Refactoring these critical IPC boundaries to be more prescriptive - only allowing a much narrower set of objects in this case - would be a good step towards making the attack surface reviewable. This would probably require fairly significant refactoring for NSXPC; it&amp;#39;s built around natively supporting the Objective-C inheritance model and is used very broadly. But without such changes the exposed attack surface is just too large to audit effectively.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c1&quot;&gt;&lt;span class=&quot;YDzVciBUld-c2 YDzVciBUld-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;YDzVciBUld-c4&quot;&gt;&lt;span&gt;The advent of Memory Tagging Extensions (MTE), likely shipping in multiple consumer devices across the ARM ecosystem this year,&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;YDzVciBUld-c6&quot;&gt;&lt;a class=&quot;YDzVciBUld-c111&quot; href=&quot;https://www.usenix.org/system/files/login/articles/login_summer19_03_serebryany.pdf&quot;&gt;is a big step in the defense against memory corruption exploitation&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. But attackers innovate too, and are likely already two steps ahead with a renewed focus on logic bugs. This sandbox escape exploit is likely a sign of the shift we can expect to see over the next few years if the promises of MTE can be delivered. And this exploit was far more extensible, reliable and generic than almost any memory corruption exploit could ever hope to be.&lt;/span&gt;&lt;/p&gt;</content><link rel='replies' type='application/atom+xml' href='https://googleprojectzero.blogspot.com/feeds/1353264177358891846/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='https://googleprojectzero.blogspot.com/2022/03/forcedentry-sandbox-escape.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/1353264177358891846'/><link rel='self' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/1353264177358891846'/><link rel='alternate' type='text/html' href='https://googleprojectzero.blogspot.com/2022/03/forcedentry-sandbox-escape.html' title='FORCEDENTRY: Sandbox Escape'/><author><name>Anonymous</name><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/blank.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjOvov7r0oFPPVDeNeBSf3Hspypl5AGeZj30ulogkGLGBXJZoy4lDoiunsF9MptZWtnpCyKST1rrP3JtdyqUCvpsAopFrlqp_3b9EuHUFh9FJqnT3iANV_Esl-InoKip8mUjW3BRjNnPOpaj1dQyfoyr5O8apA4yJzsZcPc5mnTeMEsOcqAZQKBsKr5/s72-c/image1%286%29.png" height="72" width="72"/><thr:total>0</thr:total></entry>