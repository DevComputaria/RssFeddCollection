<?xml version='1.0' encoding='UTF-8'?><?xml-stylesheet href="http://www.blogger.com/styles/atom.css" type="text/css"?><entry xmlns='http://www.w3.org/2005/Atom' xmlns:blogger='http://schemas.google.com/blogger/2008' xmlns:georss='http://www.georss.org/georss' xmlns:gd='http://schemas.google.com/g/2005' xmlns:thr='http://purl.org/syndication/thread/1.0'><id>tag:blogger.com,1999:blog-4838136820032157985.post-8408446653514773445</id><published>2021-06-29T08:58:00.002-07:00</published><updated>2021-06-29T09:31:17.503-07:00</updated><title type='text'>An EPYC escape: Case-study of a KVM breakout</title><content type='html'>&lt;style type=&quot;text/css&quot;&gt;@import url(&#39;https://themes.googleusercontent.com/fonts/css?kit=cGvuclDC_Z1vE_cnVEU6AfLhOPS0h0oMHpEhTRSdXHM5KEqTDahEV1ECVSsZOMl9_kmCvy597kDopqFAXvpeaA&#39;);.lst-kix_xko68zpk7do4-7&gt;li{counter-increment:lst-ctn-kix_xko68zpk7do4-7}ol.lst-kix_69oxjbhu0l4-6.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-6 0}ol.lst-kix_xko68zpk7do4-0.start{counter-reset:lst-ctn-kix_xko68zpk7do4-0 0}ol.lst-kix_44h6gatzfsnw-2{list-style-type:none}ol.lst-kix_xko68zpk7do4-6.start{counter-reset:lst-ctn-kix_xko68zpk7do4-6 0}ol.lst-kix_44h6gatzfsnw-1{list-style-type:none}ol.lst-kix_44h6gatzfsnw-0{list-style-type:none}ol.lst-kix_44h6gatzfsnw-6{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-6{list-style-type:none}ol.lst-kix_44h6gatzfsnw-5{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-5{list-style-type:none}ol.lst-kix_44h6gatzfsnw-4{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-4{list-style-type:none}ol.lst-kix_44h6gatzfsnw-3{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-3{list-style-type:none}.lst-kix_44h6gatzfsnw-4&gt;li{counter-increment:lst-ctn-kix_44h6gatzfsnw-4}ol.lst-kix_44h6gatzfsnw-8{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-8{list-style-type:none}ol.lst-kix_44h6gatzfsnw-7{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-7{list-style-type:none}ol.lst-kix_69oxjbhu0l4-0.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-0 0}.lst-kix_44h6gatzfsnw-6&gt;li{counter-increment:lst-ctn-kix_44h6gatzfsnw-6}.lst-kix_69oxjbhu0l4-6&gt;li{counter-increment:lst-ctn-kix_69oxjbhu0l4-6}ol.lst-kix_69oxjbhu0l4-1.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-1 0}.lst-kix_mpitsk6u2vh4-0&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_mpitsk6u2vh4-3&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_44h6gatzfsnw-8&gt;li{counter-increment:lst-ctn-kix_44h6gatzfsnw-8}.lst-kix_mpitsk6u2vh4-2&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_mpitsk6u2vh4-1&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_gmxrph3xv6dk-8&gt;li:before{content:&quot;-  &quot;}ul.lst-kix_yq73i8vx5c3y-7{list-style-type:none}.lst-kix_9lp8uyya2hbd-8&gt;li:before{content:&quot;-  &quot;}ul.lst-kix_yq73i8vx5c3y-6{list-style-type:none}.lst-kix_gmxrph3xv6dk-7&gt;li:before{content:&quot;-  &quot;}ul.lst-kix_yq73i8vx5c3y-5{list-style-type:none}.lst-kix_mpitsk6u2vh4-6&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_mpitsk6u2vh4-8&gt;li:before{content:&quot;\0025a0  &quot;}ul.lst-kix_yq73i8vx5c3y-4{list-style-type:none}ol.lst-kix_44h6gatzfsnw-4.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-4 0}ul.lst-kix_yq73i8vx5c3y-3{list-style-type:none}.lst-kix_9lp8uyya2hbd-6&gt;li:before{content:&quot;-  &quot;}.lst-kix_9lp8uyya2hbd-7&gt;li:before{content:&quot;-  &quot;}ul.lst-kix_yq73i8vx5c3y-2{list-style-type:none}ol.lst-kix_xko68zpk7do4-1.start{counter-reset:lst-ctn-kix_xko68zpk7do4-1 0}ul.lst-kix_yq73i8vx5c3y-1{list-style-type:none}.lst-kix_mpitsk6u2vh4-7&gt;li:before{content:&quot;\0025cb  &quot;}ul.lst-kix_yq73i8vx5c3y-0{list-style-type:none}.lst-kix_gmxrph3xv6dk-4&gt;li:before{content:&quot;-  &quot;}.lst-kix_xko68zpk7do4-3&gt;li{counter-increment:lst-ctn-kix_xko68zpk7do4-3}.lst-kix_gmxrph3xv6dk-5&gt;li:before{content:&quot;-  &quot;}.lst-kix_mpitsk6u2vh4-4&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_gmxrph3xv6dk-6&gt;li:before{content:&quot;-  &quot;}ul.lst-kix_5qxqo8l30oy3-2{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-1{list-style-type:none}ul.lst-kix_5qxqo8l30oy3-0{list-style-type:none}.lst-kix_mpitsk6u2vh4-5&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_69oxjbhu0l4-8&gt;li{counter-increment:lst-ctn-kix_69oxjbhu0l4-8}.lst-kix_gmxrph3xv6dk-0&gt;li:before{content:&quot;-  &quot;}.lst-kix_9lp8uyya2hbd-0&gt;li:before{content:&quot;-  &quot;}.lst-kix_9lp8uyya2hbd-1&gt;li:before{content:&quot;-  &quot;}.lst-kix_gmxrph3xv6dk-1&gt;li:before{content:&quot;-  &quot;}.lst-kix_69oxjbhu0l4-2&gt;li{counter-increment:lst-ctn-kix_69oxjbhu0l4-2}.lst-kix_9lp8uyya2hbd-2&gt;li:before{content:&quot;-  &quot;}.lst-kix_9lp8uyya2hbd-3&gt;li:before{content:&quot;-  &quot;}.lst-kix_xko68zpk7do4-0&gt;li{counter-increment:lst-ctn-kix_xko68zpk7do4-0}.lst-kix_9lp8uyya2hbd-4&gt;li:before{content:&quot;-  &quot;}.lst-kix_9lp8uyya2hbd-5&gt;li:before{content:&quot;-  &quot;}.lst-kix_gmxrph3xv6dk-3&gt;li:before{content:&quot;-  &quot;}.lst-kix_gmxrph3xv6dk-2&gt;li:before{content:&quot;-  &quot;}ol.lst-kix_44h6gatzfsnw-5.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-5 0}.lst-kix_44h6gatzfsnw-2&gt;li{counter-increment:lst-ctn-kix_44h6gatzfsnw-2}.lst-kix_6q7katqp5wyr-6&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_6q7katqp5wyr-8&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_69oxjbhu0l4-1&gt;li{counter-increment:lst-ctn-kix_69oxjbhu0l4-1}.lst-kix_6q7katqp5wyr-2&gt;li:before{content:&quot;\0025a0  &quot;}ol.lst-kix_44h6gatzfsnw-3.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-3 0}ol.lst-kix_69oxjbhu0l4-2{list-style-type:none}ol.lst-kix_69oxjbhu0l4-3{list-style-type:none}ol.lst-kix_69oxjbhu0l4-0{list-style-type:none}ol.lst-kix_69oxjbhu0l4-1{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-0{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-1{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-2{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-3{list-style-type:none}ol.lst-kix_69oxjbhu0l4-8{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-4{list-style-type:none}.lst-kix_6q7katqp5wyr-4&gt;li:before{content:&quot;\0025cb  &quot;}ul.lst-kix_p3qtgxnpnwqf-5{list-style-type:none}.lst-kix_dvq5vbolwb6x-4&gt;li:before{content:&quot;\0025cb  &quot;}ol.lst-kix_69oxjbhu0l4-6{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-6{list-style-type:none}ul.lst-kix_h05x1pycvl0d-0{list-style-type:none}ol.lst-kix_69oxjbhu0l4-7{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-7{list-style-type:none}ol.lst-kix_69oxjbhu0l4-4{list-style-type:none}ul.lst-kix_p3qtgxnpnwqf-8{list-style-type:none}ul.lst-kix_h05x1pycvl0d-2{list-style-type:none}ol.lst-kix_69oxjbhu0l4-5{list-style-type:none}ul.lst-kix_h05x1pycvl0d-1{list-style-type:none}ul.lst-kix_h05x1pycvl0d-4{list-style-type:none}ul.lst-kix_h05x1pycvl0d-3{list-style-type:none}ul.lst-kix_h05x1pycvl0d-6{list-style-type:none}ul.lst-kix_h05x1pycvl0d-5{list-style-type:none}.lst-kix_dvq5vbolwb6x-6&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_dvq5vbolwb6x-8&gt;li:before{content:&quot;\0025a0  &quot;}ul.lst-kix_h05x1pycvl0d-8{list-style-type:none}ul.lst-kix_h05x1pycvl0d-7{list-style-type:none}.lst-kix_rg61eog4va0o-7&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_69oxjbhu0l4-0&gt;li{counter-increment:lst-ctn-kix_69oxjbhu0l4-0}ul.lst-kix_gmxrph3xv6dk-6{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-5{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-8{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-7{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-2{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-1{list-style-type:none}ol.lst-kix_44h6gatzfsnw-0.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-0 0}ul.lst-kix_gmxrph3xv6dk-4{list-style-type:none}ul.lst-kix_vu6o8yw128np-1{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-3{list-style-type:none}ul.lst-kix_vu6o8yw128np-0{list-style-type:none}ul.lst-kix_qmksthfuerg1-0{list-style-type:none}ul.lst-kix_vu6o8yw128np-3{list-style-type:none}ul.lst-kix_vu6o8yw128np-2{list-style-type:none}ul.lst-kix_qmksthfuerg1-2{list-style-type:none}ul.lst-kix_gmxrph3xv6dk-0{list-style-type:none}ul.lst-kix_vu6o8yw128np-5{list-style-type:none}ul.lst-kix_qmksthfuerg1-1{list-style-type:none}ul.lst-kix_vu6o8yw128np-4{list-style-type:none}ul.lst-kix_qmksthfuerg1-4{list-style-type:none}ul.lst-kix_vu6o8yw128np-7{list-style-type:none}ul.lst-kix_qmksthfuerg1-3{list-style-type:none}ul.lst-kix_vu6o8yw128np-6{list-style-type:none}.lst-kix_z3dz91t3nune-1&gt;li:before{content:&quot;\0025cb  &quot;}ul.lst-kix_qmksthfuerg1-6{list-style-type:none}.lst-kix_p3qtgxnpnwqf-0&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_p3qtgxnpnwqf-2&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_vu6o8yw128np-0&gt;li:before{content:&quot;-  &quot;}.lst-kix_vu6o8yw128np-2&gt;li:before{content:&quot;-  &quot;}ul.lst-kix_qmksthfuerg1-5{list-style-type:none}ul.lst-kix_vu6o8yw128np-8{list-style-type:none}ul.lst-kix_qmksthfuerg1-8{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-1{list-style-type:none}ul.lst-kix_qmksthfuerg1-7{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-0{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-3{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-2{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-5{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-4{list-style-type:none}ul.lst-kix_mpitsk6u2vh4-7{list-style-type:none}.lst-kix_vu6o8yw128np-6&gt;li:before{content:&quot;-  &quot;}ul.lst-kix_mpitsk6u2vh4-6{list-style-type:none}.lst-kix_44h6gatzfsnw-3&gt;li{counter-increment:lst-ctn-kix_44h6gatzfsnw-3}ul.lst-kix_mpitsk6u2vh4-8{list-style-type:none}.lst-kix_rg61eog4va0o-1&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_z3dz91t3nune-3&gt;li:before{content:&quot;\0025cf  &quot;}ul.lst-kix_rg61eog4va0o-7{list-style-type:none}.lst-kix_rg61eog4va0o-3&gt;li:before{content:&quot;\0025cf  &quot;}ul.lst-kix_rg61eog4va0o-6{list-style-type:none}.lst-kix_p3qtgxnpnwqf-8&gt;li:before{content:&quot;\0025a0  &quot;}ul.lst-kix_rg61eog4va0o-5{list-style-type:none}ul.lst-kix_rg61eog4va0o-4{list-style-type:none}ul.lst-kix_rg61eog4va0o-3{list-style-type:none}ul.lst-kix_rg61eog4va0o-2{list-style-type:none}ul.lst-kix_rg61eog4va0o-1{list-style-type:none}ul.lst-kix_rg61eog4va0o-0{list-style-type:none}.lst-kix_p3qtgxnpnwqf-4&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_p3qtgxnpnwqf-6&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_vu6o8yw128np-4&gt;li:before{content:&quot;-  &quot;}ol.lst-kix_44h6gatzfsnw-1.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-1 0}.lst-kix_rg61eog4va0o-5&gt;li:before{content:&quot;\0025a0  &quot;}ul.lst-kix_rg61eog4va0o-8{list-style-type:none}.lst-kix_qmksthfuerg1-6&gt;li:before{content:&quot;\0025cf  &quot;}ol.lst-kix_44h6gatzfsnw-2.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-2 0}.lst-kix_fc4hxeeodeag-1&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_qmksthfuerg1-0&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_qmksthfuerg1-8&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_fc4hxeeodeag-3&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_6q7katqp5wyr-0&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_vu6o8yw128np-8&gt;li:before{content:&quot;-  &quot;}.lst-kix_yq73i8vx5c3y-5&gt;li:before{content:&quot;-  &quot;}.lst-kix_xko68zpk7do4-5&gt;li{counter-increment:lst-ctn-kix_xko68zpk7do4-5}.lst-kix_fc4hxeeodeag-7&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_qmksthfuerg1-2&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_z3dz91t3nune-5&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_yq73i8vx5c3y-1&gt;li:before{content:&quot;-  &quot;}.lst-kix_yq73i8vx5c3y-3&gt;li:before{content:&quot;-  &quot;}.lst-kix_fc4hxeeodeag-5&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_qmksthfuerg1-4&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_z3dz91t3nune-7&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_69oxjbhu0l4-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_69oxjbhu0l4-1,lower-latin) &quot;. &quot;}.lst-kix_69oxjbhu0l4-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_69oxjbhu0l4-3,decimal) &quot;. &quot;}.lst-kix_69oxjbhu0l4-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_69oxjbhu0l4-2,lower-roman) &quot;. &quot;}.lst-kix_69oxjbhu0l4-7&gt;li{counter-increment:lst-ctn-kix_69oxjbhu0l4-7}.lst-kix_69oxjbhu0l4-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_69oxjbhu0l4-5,lower-roman) &quot;. &quot;}.lst-kix_69oxjbhu0l4-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_69oxjbhu0l4-4,lower-latin) &quot;. &quot;}.lst-kix_yq73i8vx5c3y-6&gt;li:before{content:&quot;-  &quot;}.lst-kix_xko68zpk7do4-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xko68zpk7do4-6,decimal) &quot;. &quot;}.lst-kix_xko68zpk7do4-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xko68zpk7do4-5,lower-roman) &quot;. &quot;}.lst-kix_yq73i8vx5c3y-7&gt;li:before{content:&quot;-  &quot;}ol.lst-kix_xko68zpk7do4-3.start{counter-reset:lst-ctn-kix_xko68zpk7do4-3 0}.lst-kix_xko68zpk7do4-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xko68zpk7do4-4,lower-latin) &quot;. &quot;}.lst-kix_yq73i8vx5c3y-8&gt;li:before{content:&quot;-  &quot;}.lst-kix_xko68zpk7do4-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xko68zpk7do4-2,lower-roman) &quot;. &quot;}.lst-kix_xko68zpk7do4-6&gt;li{counter-increment:lst-ctn-kix_xko68zpk7do4-6}.lst-kix_xko68zpk7do4-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xko68zpk7do4-1,lower-latin) &quot;. &quot;}.lst-kix_xko68zpk7do4-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xko68zpk7do4-3,decimal) &quot;. &quot;}.lst-kix_69oxjbhu0l4-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_69oxjbhu0l4-0,decimal) &quot;. &quot;}ol.lst-kix_69oxjbhu0l4-3.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-3 0}.lst-kix_h05x1pycvl0d-4&gt;li:before{content:&quot;-  &quot;}.lst-kix_h05x1pycvl0d-6&gt;li:before{content:&quot;-  &quot;}.lst-kix_xko68zpk7do4-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xko68zpk7do4-0,decimal) &quot;. &quot;}.lst-kix_h05x1pycvl0d-1&gt;li:before{content:&quot;-  &quot;}.lst-kix_h05x1pycvl0d-5&gt;li:before{content:&quot;-  &quot;}.lst-kix_h05x1pycvl0d-0&gt;li:before{content:&quot;-  &quot;}.lst-kix_h05x1pycvl0d-8&gt;li:before{content:&quot;-  &quot;}ol.lst-kix_44h6gatzfsnw-7.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-7 0}.lst-kix_h05x1pycvl0d-7&gt;li:before{content:&quot;-  &quot;}ul.lst-kix_6q7katqp5wyr-0{list-style-type:none}.lst-kix_44h6gatzfsnw-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_44h6gatzfsnw-8,lower-roman) &quot;. &quot;}ul.lst-kix_6q7katqp5wyr-4{list-style-type:none}ul.lst-kix_6q7katqp5wyr-3{list-style-type:none}ul.lst-kix_6q7katqp5wyr-2{list-style-type:none}.lst-kix_69oxjbhu0l4-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_69oxjbhu0l4-6,decimal) &quot;. &quot;}ul.lst-kix_6q7katqp5wyr-1{list-style-type:none}.lst-kix_44h6gatzfsnw-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_44h6gatzfsnw-6,decimal) &quot;. &quot;}.lst-kix_69oxjbhu0l4-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_69oxjbhu0l4-7,lower-latin) &quot;. &quot;}.lst-kix_h05x1pycvl0d-2&gt;li:before{content:&quot;-  &quot;}.lst-kix_44h6gatzfsnw-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_44h6gatzfsnw-7,lower-latin) &quot;. &quot;}.lst-kix_69oxjbhu0l4-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_69oxjbhu0l4-8,lower-roman) &quot;. &quot;}.lst-kix_h05x1pycvl0d-3&gt;li:before{content:&quot;-  &quot;}.lst-kix_5qxqo8l30oy3-7&gt;li:before{content:&quot;\0025cb  &quot;}ul.lst-kix_dvq5vbolwb6x-0{list-style-type:none}ol.lst-kix_69oxjbhu0l4-8.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-8 0}.lst-kix_44h6gatzfsnw-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_44h6gatzfsnw-2,lower-roman) &quot;. &quot;}.lst-kix_44h6gatzfsnw-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_44h6gatzfsnw-4,lower-latin) &quot;. &quot;}ul.lst-kix_dvq5vbolwb6x-4{list-style-type:none}.lst-kix_xko68zpk7do4-4&gt;li{counter-increment:lst-ctn-kix_xko68zpk7do4-4}ul.lst-kix_dvq5vbolwb6x-3{list-style-type:none}.lst-kix_5qxqo8l30oy3-6&gt;li:before{content:&quot;\0025cf  &quot;}ul.lst-kix_dvq5vbolwb6x-2{list-style-type:none}.lst-kix_44h6gatzfsnw-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_44h6gatzfsnw-1,lower-latin) &quot;. &quot;}.lst-kix_44h6gatzfsnw-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_44h6gatzfsnw-5,lower-roman) &quot;. &quot;}ul.lst-kix_dvq5vbolwb6x-1{list-style-type:none}ul.lst-kix_6q7katqp5wyr-8{list-style-type:none}ul.lst-kix_6q7katqp5wyr-7{list-style-type:none}ul.lst-kix_6q7katqp5wyr-6{list-style-type:none}ul.lst-kix_6q7katqp5wyr-5{list-style-type:none}.lst-kix_5qxqo8l30oy3-1&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_5qxqo8l30oy3-0&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_5qxqo8l30oy3-8&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_44h6gatzfsnw-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_44h6gatzfsnw-3,decimal) &quot;. &quot;}ol.lst-kix_xko68zpk7do4-8.start{counter-reset:lst-ctn-kix_xko68zpk7do4-8 0}.lst-kix_5qxqo8l30oy3-2&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_5qxqo8l30oy3-3&gt;li:before{content:&quot;\0025cf  &quot;}ul.lst-kix_dvq5vbolwb6x-8{list-style-type:none}ul.lst-kix_dvq5vbolwb6x-7{list-style-type:none}ul.lst-kix_dvq5vbolwb6x-6{list-style-type:none}.lst-kix_44h6gatzfsnw-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_44h6gatzfsnw-0,decimal) &quot;. &quot;}ul.lst-kix_dvq5vbolwb6x-5{list-style-type:none}.lst-kix_5qxqo8l30oy3-5&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_5qxqo8l30oy3-4&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_69oxjbhu0l4-5&gt;li{counter-increment:lst-ctn-kix_69oxjbhu0l4-5}ol.lst-kix_69oxjbhu0l4-2.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-2 0}.lst-kix_dvq5vbolwb6x-3&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_dvq5vbolwb6x-2&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_dvq5vbolwb6x-1&gt;li:before{content:&quot;\0025cb  &quot;}ol.lst-kix_xko68zpk7do4-6{list-style-type:none}ol.lst-kix_xko68zpk7do4-7{list-style-type:none}.lst-kix_xko68zpk7do4-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xko68zpk7do4-7,lower-latin) &quot;. &quot;}ol.lst-kix_xko68zpk7do4-8{list-style-type:none}.lst-kix_dvq5vbolwb6x-0&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_xko68zpk7do4-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xko68zpk7do4-8,lower-roman) &quot;. &quot;}.lst-kix_44h6gatzfsnw-5&gt;li{counter-increment:lst-ctn-kix_44h6gatzfsnw-5}ol.lst-kix_xko68zpk7do4-0{list-style-type:none}ol.lst-kix_xko68zpk7do4-1{list-style-type:none}ol.lst-kix_xko68zpk7do4-2{list-style-type:none}ol.lst-kix_xko68zpk7do4-3{list-style-type:none}ol.lst-kix_xko68zpk7do4-4{list-style-type:none}ol.lst-kix_xko68zpk7do4-2.start{counter-reset:lst-ctn-kix_xko68zpk7do4-2 0}ol.lst-kix_xko68zpk7do4-5{list-style-type:none}.lst-kix_6q7katqp5wyr-7&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_xko68zpk7do4-1&gt;li{counter-increment:lst-ctn-kix_xko68zpk7do4-1}.lst-kix_6q7katqp5wyr-3&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_6q7katqp5wyr-1&gt;li:before{content:&quot;\0025cb  &quot;}ul.lst-kix_fc4hxeeodeag-1{list-style-type:none}ul.lst-kix_fc4hxeeodeag-0{list-style-type:none}ul.lst-kix_fc4hxeeodeag-3{list-style-type:none}ul.lst-kix_fc4hxeeodeag-2{list-style-type:none}ul.lst-kix_fc4hxeeodeag-5{list-style-type:none}ul.lst-kix_fc4hxeeodeag-4{list-style-type:none}ul.lst-kix_fc4hxeeodeag-7{list-style-type:none}.lst-kix_44h6gatzfsnw-0&gt;li{counter-increment:lst-ctn-kix_44h6gatzfsnw-0}ul.lst-kix_fc4hxeeodeag-6{list-style-type:none}ul.lst-kix_fc4hxeeodeag-8{list-style-type:none}ol.lst-kix_44h6gatzfsnw-6.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-6 0}.lst-kix_6q7katqp5wyr-5&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_dvq5vbolwb6x-5&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_44h6gatzfsnw-1&gt;li{counter-increment:lst-ctn-kix_44h6gatzfsnw-1}ol.lst-kix_69oxjbhu0l4-7.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-7 0}ul.lst-kix_z3dz91t3nune-0{list-style-type:none}ul.lst-kix_z3dz91t3nune-2{list-style-type:none}ul.lst-kix_z3dz91t3nune-1{list-style-type:none}ul.lst-kix_z3dz91t3nune-4{list-style-type:none}.lst-kix_dvq5vbolwb6x-7&gt;li:before{content:&quot;\0025cb  &quot;}ul.lst-kix_z3dz91t3nune-3{list-style-type:none}ul.lst-kix_z3dz91t3nune-6{list-style-type:none}ul.lst-kix_z3dz91t3nune-5{list-style-type:none}ul.lst-kix_z3dz91t3nune-8{list-style-type:none}ul.lst-kix_z3dz91t3nune-7{list-style-type:none}.lst-kix_rg61eog4va0o-8&gt;li:before{content:&quot;\0025a0  &quot;}ol.lst-kix_xko68zpk7do4-4.start{counter-reset:lst-ctn-kix_xko68zpk7do4-4 0}ul.lst-kix_yq73i8vx5c3y-8{list-style-type:none}ol.lst-kix_69oxjbhu0l4-4.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-4 0}ol.lst-kix_xko68zpk7do4-7.start{counter-reset:lst-ctn-kix_xko68zpk7do4-7 0}.lst-kix_69oxjbhu0l4-3&gt;li{counter-increment:lst-ctn-kix_69oxjbhu0l4-3}.lst-kix_p3qtgxnpnwqf-1&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_vu6o8yw128np-1&gt;li:before{content:&quot;-  &quot;}ol.lst-kix_xko68zpk7do4-5.start{counter-reset:lst-ctn-kix_xko68zpk7do4-5 0}.lst-kix_z3dz91t3nune-2&gt;li:before{content:&quot;\0025a0  &quot;}ol.lst-kix_44h6gatzfsnw-8.start{counter-reset:lst-ctn-kix_44h6gatzfsnw-8 0}.lst-kix_p3qtgxnpnwqf-3&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_fc4hxeeodeag-8&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_z3dz91t3nune-0&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_z3dz91t3nune-4&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_vu6o8yw128np-5&gt;li:before{content:&quot;-  &quot;}.lst-kix_69oxjbhu0l4-4&gt;li{counter-increment:lst-ctn-kix_69oxjbhu0l4-4}.lst-kix_vu6o8yw128np-7&gt;li:before{content:&quot;-  &quot;}.lst-kix_rg61eog4va0o-0&gt;li:before{content:&quot;\0025cf  &quot;}ul.lst-kix_9lp8uyya2hbd-8{list-style-type:none}.lst-kix_rg61eog4va0o-2&gt;li:before{content:&quot;\0025a0  &quot;}ul.lst-kix_9lp8uyya2hbd-6{list-style-type:none}ul.lst-kix_9lp8uyya2hbd-7{list-style-type:none}.lst-kix_p3qtgxnpnwqf-7&gt;li:before{content:&quot;\0025cb  &quot;}ul.lst-kix_9lp8uyya2hbd-4{list-style-type:none}ul.lst-kix_9lp8uyya2hbd-5{list-style-type:none}ul.lst-kix_9lp8uyya2hbd-2{list-style-type:none}.lst-kix_fc4hxeeodeag-0&gt;li:before{content:&quot;\0025cf  &quot;}ul.lst-kix_9lp8uyya2hbd-3{list-style-type:none}.lst-kix_p3qtgxnpnwqf-5&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_rg61eog4va0o-6&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_44h6gatzfsnw-7&gt;li{counter-increment:lst-ctn-kix_44h6gatzfsnw-7}.lst-kix_vu6o8yw128np-3&gt;li:before{content:&quot;-  &quot;}.lst-kix_rg61eog4va0o-4&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_qmksthfuerg1-5&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_yq73i8vx5c3y-0&gt;li:before{content:&quot;-  &quot;}ul.lst-kix_9lp8uyya2hbd-0{list-style-type:none}.lst-kix_qmksthfuerg1-1&gt;li:before{content:&quot;\0025cb  &quot;}ul.lst-kix_9lp8uyya2hbd-1{list-style-type:none}ol.lst-kix_69oxjbhu0l4-5.start{counter-reset:lst-ctn-kix_69oxjbhu0l4-5 0}.lst-kix_qmksthfuerg1-7&gt;li:before{content:&quot;\0025cb  &quot;}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_fc4hxeeodeag-2&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_xko68zpk7do4-2&gt;li{counter-increment:lst-ctn-kix_xko68zpk7do4-2}.lst-kix_xko68zpk7do4-8&gt;li{counter-increment:lst-ctn-kix_xko68zpk7do4-8}.lst-kix_z3dz91t3nune-8&gt;li:before{content:&quot;\0025a0  &quot;}.lst-kix_fc4hxeeodeag-4&gt;li:before{content:&quot;\0025cb  &quot;}.lst-kix_yq73i8vx5c3y-4&gt;li:before{content:&quot;-  &quot;}.lst-kix_z3dz91t3nune-6&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_qmksthfuerg1-3&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_fc4hxeeodeag-6&gt;li:before{content:&quot;\0025cf  &quot;}.lst-kix_yq73i8vx5c3y-2&gt;li:before{content:&quot;-  &quot;}ol{margin:0;padding:0}table td,table th{padding:0}.c17{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#e0e0e0;border-bottom-style:solid}.c32{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#000000;border-bottom-style:solid}.c4{margin-left:36pt;padding-top:0pt;padding-left:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.c8{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:&quot;Arial&quot;;font-style:normal}.c21{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:&quot;Arial&quot;;font-style:normal}.c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;font-style:normal}.c14{margin-left:36pt;padding-top:0pt;padding-left:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c20{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.c1{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#616161;font-weight:400}.c0{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#9c27b0;font-weight:400}.c3{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#000000;font-weight:400}.c24{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c27{color:#000000;font-weight:400;font-size:11pt;font-family:Consolas,&quot;Courier New&quot;}.c10{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#c53929;font-weight:400}.c38{color:#000000;font-weight:400;font-size:10pt;font-family:&quot;Roboto&quot;}.c16{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c5{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.c30{border-spacing:0;border-collapse:collapse;margin-right:auto}.c22{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#455a64;font-weight:400}.c29{color:#000000;font-weight:400;font-size:10pt;font-family:&quot;Arial&quot;}.c23{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;font-weight:400}.c31{background-color:#fafafa;font-size:10.5pt;font-family:&quot;Roboto&quot;}.c25{text-decoration:none;vertical-align:baseline;font-style:normal}.c37{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#616161}.c36{color:#9c27b0;font-size:10pt;font-family:Consolas,&quot;Courier New&quot;}.c15{font-family:Consolas,&quot;Courier New&quot;;color:#0d904f;font-weight:400}.c9{orphans:2;widows:2;height:11pt}.c13{orphans:2;widows:2}.c7{color:inherit;text-decoration:inherit}.c12{padding:0;margin:0}.c33{max-width:468pt;padding:72pt 72pt 72pt 72pt}.c35{margin-left:36pt}.c28{height:0pt}.c34{color:#0f9d58}.c19{height:1030.1pt}.c6{background-color:#ffffff}.c26{font-style:italic}.c11{height:11pt}.c18{font-weight:700}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}p{margin:0;color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}&lt;/style&gt;&lt;/head&gt;&lt;body class=&quot;c6 c33&quot;&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Posted by Felix Wilhelm, Project Zero&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;c20 c13&quot; id=&quot;h.atcddzti5hh2&quot;&gt;&lt;span class=&quot;c21&quot;&gt;Introduction&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;KVM (for Kernel-based Virtual Machine) is the de-facto standard hypervisor for Linux-based cloud environments. Outside of Azure, almost all large-scale cloud and hosting providers are running on top of KVM, turning it into one of the fundamental security boundaries in the cloud. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;In this blog post I describe a &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://bugs.chromium.org/p/project-zero/issues/detail?id=2177&amp;q=owner%3Afwilhelm%40google.com&amp;can=1&quot;&gt;vulnerability&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;in KVM&amp;rsquo;s AMD-specific code and discuss how this bug can be turned into a full virtual machine escape. &lt;/span&gt;&lt;span class=&quot;c18&quot;&gt;To the best of my knowledge, this is the first public writeup of a KVM guest-to-host breakout that does not rely on bugs in user space components such as QEMU. The discussed bug was assigned CVE-2021-29657, affects kernel versions &lt;/span&gt;&lt;span class=&quot;c18 c31&quot;&gt;v5.10-rc1 to v5.12-rc6&lt;/span&gt;&lt;span class=&quot;c18&quot;&gt;&amp;nbsp;and was patched at the end of &lt;/span&gt;&lt;span class=&quot;c16 c18&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=a58d9166a756a0f4a6618e4f593232593d6df134&quot;&gt;March&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;c18&quot;&gt;&amp;nbsp;2021&lt;/span&gt;&lt;span class=&quot;c18&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;As the bug only became exploitable in v5.10 and was discovered roughly 5 months later, most real world deployments of KVM should not be affected. I still think the issue is an interesting case study in the work required to build a stable guest-to-host escape against KVM and hope that this writeup can strengthen the case that hypervisor compromises are not only theoretical issues. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;I start with a short overview of KVM&amp;rsquo;s architecture, before diving into the bug and its exploitation.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;c20 c13&quot; id=&quot;h.t0ejvkqgm647&quot;&gt;&lt;span class=&quot;c21&quot;&gt;KVM&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;KVM is a Linux based open source hypervisor supporting hardware accelerated virtualization on x86, ARM, PowerPC and S/390. In contrast to the other big open source hypervisor Xen, KVM is deeply integrated with the Linux Kernel and builds on its scheduling, memory management and hardware integrations to provide efficient virtualization.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;KVM is implemented as one or more kernel modules (kvm.ko plus kvm-intel.ko or kvm-amd.ko on x86) that expose a low-level IOCTL-based &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://www.kernel.org/doc/html/latest/virt/kvm/api.html&quot;&gt;API&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;to user space processes over the /dev/kvm device. Using this API, a user space process (often called VMM for Virtual Machine Manager) can create new VMs, assign vCPUs and memory, and intercept memory or IO accesses to provide access to &lt;/span&gt;&lt;span&gt;emulate&lt;/span&gt;&lt;span&gt;d or virtualization-aware hardware devices. &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://www.qemu.org/&quot;&gt;QEMU&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;has been the standard user space choice for KVM-based virtualization for a long time, but in the last few years alternatives like &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://github.com/lkvm/lkvm&quot;&gt;LKVM&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://chromium.googlesource.com/chromiumos/platform/crosvm/&quot;&gt;crosvm&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;or &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://github.com/firecracker-microvm/firecracker&quot;&gt;Firecracker&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;have started to become popular. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;While KVM&amp;rsquo;s reliance on a separate user space component might seem complicated at first, it has a very nice benefit: Each VM running on a KVM host has a 1:1 mapping to a Linux process, making it managable using standard Linux tools. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;This means for example, that a guest&amp;#39;s memory can be inspected by dumping the allocated memory of its user space process or that resource limits for CPU time and memory can be applied easily. Additionally, KVM can offload most work related to device emulation to the userspace component. Outside of a couple of performance-sensitive devices related to interrupt handling, all of the complex low-level code for providing virtual disk, network or GPU access can be implemented in userspace. &amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;When looking at public writeups of KVM-related vulnerabilities and exploits it becomes clear that this design was a wise decision. The large majority of disclosed vulnerabilities and all publicly available exploits affect QEMU and its support for emulated/paravirtualized devices. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Even though KVM&amp;rsquo;s kernel attack surface is significantly smaller than the one exposed by a default QEMU configuration or similar user space VMMs, a KVM vulnerability has advantages that make it very valuable for an attacker: &lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;c12 lst-kix_vu6o8yw128np-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Whereas user space VMMs can be sandboxed to reduce the impact of a VM breakout, no such option is available for KVM itself. Once an attacker is able to achieve code execution (or similarly powerful primitives like write access to page tables) in the context of the host kernel, the system is fully compromised. &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Due to the somewhat poor security history of QEMU, new user space VMMs like crosvm or Firecracker are written in Rust, a memory safe language. Of course, there can still be non-memory safety vulnerabilities or problems due to incorrect or buggy usage of the KVM APIs, but using Rust effectively prevents the large majority of bugs that were discovered in C-based user space VMMs in the past. &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Finally, a pure KVM exploit can work against targets that use proprietary or heavily modified user space VMMs. While the big cloud providers do not go into much detail about their virtualization stacks publicly, it is safe to assume that they do not depend on an unmodified QEMU version for their production workloads. In contrast, KVM&amp;rsquo;s smaller code base makes heavy modifications unlikely (and KVM&amp;rsquo;s contributor list points at a strong tendency to upstream such modifications when they exist). &amp;nbsp;&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;c5 c9 c35&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9 c35&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;With these advantages in mind, I decided to spend some time hunting for a KVM vulnerability that could be turned into a guest-to-host escape. In the past, I had &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://bugs.chromium.org/p/project-zero/issues/list?q=vmx%20owner%3Afwilhelm&amp;can=1&quot;&gt;some success&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;with finding vulnerabilities in KVM&amp;rsquo;s support for nested virtualization on Intel CPUs so reviewing the same functionality for AMD seemed like a good starting point. This is even more true,&lt;/span&gt;&lt;span&gt;&amp;nbsp;because the recent increase of AMD&amp;rsquo;s market share in the server segment means that KVM&amp;rsquo;s AMD implementation is suddenly becoming a more interesting target than it was in the last years.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;Nested virtualization, the ability for a VM (called L1) to spawn nested guests (L2), was also a niche feature for a long time. However, due to hardware improvements that reduce its overhead and increasing customer demand it&amp;rsquo;s becoming more widely available. For example, Microsoft is heavily pushing for &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://docs.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-vbs&quot;&gt;Virtualization-based Security&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;as part of newer Windows versions, requiring nested virtualization to support cloud-hosted Windows installations. KVM enables support for nested virtualization on both AMD&lt;/span&gt;&lt;span&gt;&amp;nbsp;and&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;Intel by default, so if an administrator or the user space VMM does not explicitly disable it, it&amp;rsquo;s part of the attack surface for a malicious or compromised VM.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;AMD&amp;rsquo;s virtualization extension is called SVM (for Secure Virtual Machine) and in order to support nested virtualization, the host hypervisor needs to intercept all SVM instructions that are executed by its guests, emulate their behavior and keep its state in sync with the underlying hardware. As you might imagine, implementing this correctly is quite difficult with a large potential for complex logic flaws, making it a perfect target for manual code review.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;c20 c13&quot; id=&quot;h.edb97hffqtq9&quot;&gt;&lt;span class=&quot;c21&quot;&gt;The Bug&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;Before diving into the KVM codebase and the bug I discovered, I want to quickly introduce how AMD SVM works to make the rest of the post easier to understand. (For a thorough documentation see &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://www.amd.com/system/files/TechDocs/24593.pdf&quot;&gt;AMD64 Architecture Programmer&amp;rsquo;s Manual, Volume 2: System Programming Chapter 15&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.) SVM adds support for 6 new instructions to x86-64 if SVM support is enabled by setting the SVME bit in the EFER MSR. The most interesting of these instructions is &lt;/span&gt;&lt;span class=&quot;c26&quot;&gt;VMRUN&lt;/span&gt;&lt;span&gt;, which (as its name suggests) is responsible for running a guest VM. &lt;/span&gt;&lt;span class=&quot;c26&quot;&gt;VMRUN &lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;takes an implicit parameter via the RAX register pointing to the page-aligned physical address of a data structure called &amp;ldquo;virtual machine control block&amp;rdquo; (VMCB), which describes the state and configuration of the VM. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;The VMCB is split into two parts: First, the State Save area, which stores the values of all guest registers, including segment and control registers. Second, the Control area which describes the configuration of the VM. The Control area describes the virtualization features enabled for a VM, &amp;nbsp;sets which VM actions are intercepted to trigger a VM exit &lt;/span&gt;&lt;span&gt;and&lt;/span&gt;&lt;span&gt;&amp;nbsp;stores some fundamental configuration values such as the page table address used for &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://en.wikipedia.org/wiki/Second_Level_Address_Translation&quot;&gt;nested paging&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;If the VMCB is correctly prepared (and we are not already running in a VM), VMRUN will first save the host state in a memory region called the host save area, whose address is configured by writing a physical address to the VM_HSAVE_PA MSR. Once the host state is saved, the CPU switches to the VM context and VMRUN only returns once a VM exit is triggered for one reason or another. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;An interesting aspect of SVM is that a lot of the state recovery after a VM exit has to be done by the hypervisor. Once a VM exit occurs, only RIP, RSP and RAX are restored to the previous host values and all other general purpose registers still contain the guest values. In addition, a full context switch requires manual execution of the VMSAVE/VMLOAD instructions which save/load additional system registers (FS, SS, LDTR, STAR, LSTAR &amp;hellip;) from memory.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;For nested virtualization to work, KVM intercepts execution of the VMRUN instruction and creates its own VMCB based on the VMCB the L1 guest prepared (called vmcb12 in KVM terminology). Of course, KVM can&amp;rsquo;t trust the guest provided vmcb12 and needs to carefully validate all fields that end up in the real VMCB that gets passed to the hardware (known as vmcb02).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;Most of the KVM&amp;rsquo;s code for nested virtualization on AMD is implemented in &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/nested.c?h=v5.11&quot;&gt;arch/x86/kvm/svm/nested.c&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and the code that intercepts VMRUN instructions of nested guests is implemented in &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;nested_svm_vmrun&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.4603a0181df4522e440958d55a04b47d07a005d3&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.0&quot;&gt;&lt;/a&gt;&lt;table class=&quot;c30&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;c19&quot;&gt;&lt;td class=&quot;c17&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c0&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;nested_svm_vmrun&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vcpu_svm &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;ret&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb12&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;hsave &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;nested&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;kvm_host_map map&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; u64 vmcb12_gpa&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vmcb12_gpa &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;rax&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;; &lt;/span&gt;&lt;span class=&quot;c37 c18&quot;&gt;** &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;c18 c37&quot;&gt;&amp;nbsp;**&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ret &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;kvm_vcpu_map&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;gpa_to_gfn&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb12_gpa&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;); &lt;/span&gt;&lt;span class=&quot;c37 c18&quot;&gt;** &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;c37 c18&quot;&gt;&amp;nbsp;**&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;hellip; &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ret &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;kvm_skip_emulated_instruction&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vmcb12 &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;map&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;hva&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(!&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;nested_vmcb_checks&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb12&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{ ** &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;nbsp;**&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vmcb12&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;exit_code &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;SVM_EXIT_ERR&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vmcb12&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;exit_code_hi &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vmcb12&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;exit_info_1 &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vmcb12&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;exit_info_2 &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;goto&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;out&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c23&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c22&quot;&gt;/*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* Save the old vmcb, so we don&amp;#39;t need to pick what we save, but can&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* restore everything when a VMEXIT occurs&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;es &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;es&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;cs &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;cs&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;ss &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;ss&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;ds &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;ds&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;gdtr &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;gdtr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;idtr &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;idtr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;efer &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;arch&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;efer&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;cr0 &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;kvm_read_cr0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;cr4 &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;arch&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;cr4&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;rflags &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;kvm_get_rflags&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;rip &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;kvm_rip_read&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;rsp &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;rsp&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;rax &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;rax&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;npt_enabled&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;cr3 &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;cr3&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;else&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;cr3 &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;kvm_read_cr3&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; copy_vmcb_control_area&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;nested&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;nested_run_pending &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;enter_svm_guest_mode&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb12_gpa&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb12&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)) ** &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;nbsp;**&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;goto&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;out_exit_err&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;nested_svm_vmrun_msrpm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;))&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;goto&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;out&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;out_exit_err&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;nested&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;nested_run_pending &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;exit_code &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;SVM_EXIT_ERR&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;exit_code_hi &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;exit_info_1 &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;exit_info_2 &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nested_svm_vmexit&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c0&quot;&gt;out&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; kvm_vcpu_unmap&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;ret&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;c28&quot;&gt;&lt;td class=&quot;c17&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c0 c25&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c25 c6 c29&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;The function first fetches the value of RAX out of the currently active vmcb (&lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm-&amp;gt;vcmb&lt;/span&gt;&lt;span&gt;) in &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;1 &lt;/span&gt;&lt;span&gt;(numbers are marked in the code samples)&lt;/span&gt;&lt;span&gt;. For guests using nested paging (which is the only relevant configuration nowadays) RAX contains a guest physical address (GPA), which needs to be translated into a host physical address (HPA) first. &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;kvm_vcpu_map&lt;/span&gt;&lt;span&gt;&amp;nbsp;(&lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;) takes care of this translation and maps the underlying page to a host virtual address (HVA) that can be directly accessed by KVM. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;Once the VMCB is mapped, &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;nested_vmcb_checks&lt;/span&gt;&lt;span&gt;&amp;nbsp;is called for some basic validation in &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;3&lt;/span&gt;&lt;span&gt;. Afterwards, the L1 guest context which is stored in &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm-&amp;gt;vmcb&lt;/span&gt;&lt;span&gt;&amp;nbsp;is copied into the host save area &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm-&amp;gt;nested.hsave&lt;/span&gt;&lt;span&gt;&amp;nbsp;before KVM enters the nested guest context by calling &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;enter_svm_guest_mode&lt;/span&gt;&lt;span&gt;&amp;nbsp;(&lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;4&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span class=&quot;c27 c25&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c25 c27&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.f82e68744812c72d77d4c5e87e16205bdffc71d6&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.1&quot;&gt;&lt;/a&gt;&lt;table class=&quot;c30&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;c28&quot;&gt;&lt;td class=&quot;c17&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c0&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;enter_svm_guest_mode&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vcpu_svm &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;u64 vmcb12_gpa&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb12&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;ret&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;nested&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb12_gpa &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb12_gpa&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; load_nested_vmcb_control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb12&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nested_prepare_vmcb_save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb12&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nested_prepare_vmcb_control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ret &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;nested_svm_load_cr3&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb12&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;cr3&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nested_npt_enabled&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;));&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;ret&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;ret&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; svm_set_gif&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c0&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;load_nested_vmcb_control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vcpu_svm &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb_control_area &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; copy_vmcb_control_area&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;nested&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;ctl&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c27 c25&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;Looking at &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;enter_svm_guest_mode&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;we can see that KVM copies the vmcb12 control area directly into svm-&amp;gt;nested.ctl and does not perform any further checks on the copied value.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;Readers familiar with double fetch or Time-of-Check-to-Time-of-Use vulnerabilities might already see a potential issue here: The call to &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;nested_vmcb_checks&lt;/span&gt;&lt;span&gt;&amp;nbsp;at the beginning of &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;nested_svm_vmrun&lt;/span&gt;&lt;span&gt;&amp;nbsp;performs all of its checks on a copy of the VMCB that is stored in guest memory. This means that a guest with multiple CPU cores can modify fields in the VMCB after they are verified in &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;nested_vmcb_checks&lt;/span&gt;&lt;span&gt;, but before they are copied to svm-&amp;gt;nested.ctl in &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;load_nested_vmcb_control&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;Let&amp;rsquo;s look at &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;nested_vmcb_checks &lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;to see what kind of checks we can bypass with this approach: &lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.cbcfaf5d1ce5a2e639eabbdd57ddd415d5776511&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.2&quot;&gt;&lt;/a&gt;&lt;table class=&quot;c30&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;c28&quot;&gt;&lt;td class=&quot;c17&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c0&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;nested_vmcb_check_controls&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb_control_area &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb_is_intercept&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;INTERCEPT_VMRUN&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;asid &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;nested_ctl &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;SVM_NESTED_CTL_NP_ENABLE&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;npt_enabled&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;At first glance this looks pretty harmless. &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;control-&amp;gt;asid&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;isn&amp;rsquo;t used anywhere and the last check is only relevant for systems where nested paging isn&amp;rsquo;t supported. However, the first check turns out to be very interesting. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;For reasons unknown to me, SVM VMCBs contain a bit that enables or disables interception of the VMRUN instruction when executed inside a guest. Clearing this bit isn&amp;rsquo;t actually supported by hardware and results in an immediate VMEXIT, so the check in &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;nested_vmcb_check_controls&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;simply replicates this behavior. &amp;nbsp;When we race and bypass the check by repeatedly flipping the value of the INTERCEPT_VMRUN bit, we can end up in a situation where svm-&amp;gt;nested.ctl contains a 0 in place of the INTERCEPT_VMRUN bit. To understand the impact we first need to see how nested vmexit&amp;rsquo;s are handled in KVM: &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;The main SVM exit handler is the function &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;handle_exit&lt;/span&gt;&lt;span&gt;&amp;nbsp;in &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.c?h=v5.11&quot;&gt;arch/x86/kvm/svm.c&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, which is called whenever a VMexit occurs. When KVM is running a nested guest, it first has to check if the exit should be handled by itself or the L1 hypervisor. To do this it calls the function &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;nested_svm_exit_handled&lt;/span&gt;&lt;span&gt;&amp;nbsp;(&lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;5&lt;/span&gt;&lt;span&gt;) whi&lt;/span&gt;&lt;span&gt;ch will return &lt;/span&gt;&lt;span class=&quot;c6&quot;&gt;NESTED_EXIT_DONE if the vmexit will be handled by the L1 hypervisor and no further processing by the L0 hypervisor is needed&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.dbf1a4595680d452b12d73cacee8ee680ca43081&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.3&quot;&gt;&lt;/a&gt;&lt;table class=&quot;c30&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;c28&quot;&gt;&lt;td class=&quot;c17&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;handle_exit&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;kvm_vcpu &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;fastpath_t exit_fastpath&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vcpu_svm &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;to_svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;kvm_run &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;kvm_run &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; u32 exit_code &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;exit_code&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;hellip;&lt;/span&gt;&lt;span class=&quot;c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;is_guest_mode&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmexit&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; trace_kvm_nested_vmexit&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;exit_code&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;KVM_ISA_SVM&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vmexit &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;nested_svm_exit_special&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmexit &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;NESTED_EXIT_CONTINUE&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vmexit &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;nested_svm_exit_handled&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;**&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmexit &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;NESTED_EXIT_DONE&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c0&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;nested_svm_intercept&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vcpu_svm &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // exit_code&lt;/span&gt;&lt;span class=&quot;c23&quot;&gt;==INTERCEPT_VMRUN when the L2 guest executes vmrun&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c23&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;u32 exit_code &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;exit_code&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;; &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmexit &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;NESTED_EXIT_HOST&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;switch&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;exit_code&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;SVM_EXIT_MSR&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vmexit &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;nested_svm_exit_handled_msr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;SVM_EXIT_IOIO&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vmexit &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;nested_svm_intercept_ioio&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;hellip;&lt;/span&gt;&lt;span class=&quot;c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb_is_intercept&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;nested&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;ctl&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;exit_code&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;**&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vmexit &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;NESTED_EXIT_DONE&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmexit&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c0&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;nested_svm_exit_handled&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vcpu_svm &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmexit&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vmexit &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;nested_svm_intercept&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmexit &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;NESTED_EXIT_DONE&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; nested_svm_vmexit&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;**&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmexit&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c29 c25 c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c29 c25 c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c15 c6&quot;&gt;nested_svm_exit_handled&lt;/span&gt;&lt;span class=&quot;c6&quot;&gt;&amp;nbsp;first calls &lt;/span&gt;&lt;span class=&quot;c15 c6&quot;&gt;nested_svm_intercept (6)&lt;/span&gt;&lt;span class=&quot;c6&quot;&gt;&amp;nbsp;to see if the exit should be handled. When we trigger an exit by executing VMRUN in a L2 guest, the default case is executed (&lt;/span&gt;&lt;span class=&quot;c15 c6&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;c6&quot;&gt;) &lt;/span&gt;&lt;span class=&quot;c6&quot;&gt;to see if the INTERCEPT_VMRUN bit in svm-&amp;gt;nested.ctl is set. &lt;/span&gt;&lt;span class=&quot;c6&quot;&gt;Normally, this should always be the case and the function returns NESTED_EXIT_DONE to trigger a nested VM exit from L2 to L1 and to let the L1 hypervisor handle the exit (&lt;/span&gt;&lt;span class=&quot;c15 c6&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;c8 c6&quot;&gt;). (This way KVM supports infinite nesting of hypervisors).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8 c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c6&quot;&gt;However, if the L1 guest exploited the race condition described above svm-&amp;gt;nested.ctl won&amp;rsquo;t have the INTERCEPT_VMRUN bit set and the VM exit will be handled by KVM itself. This results in a second call to &lt;/span&gt;&lt;span class=&quot;c15 c6&quot;&gt;nested_svm_vmrun&lt;/span&gt;&lt;span class=&quot;c6&quot;&gt;&amp;nbsp;while still running inside the L2 guest context. &lt;/span&gt;&lt;span class=&quot;c15 c6&quot;&gt;nested_svm_vmrun&lt;/span&gt;&lt;span class=&quot;c6&quot;&gt;&amp;nbsp;isn&amp;rsquo;t written to handle this situation and will blindly overwrite the L1 context stored in &lt;/span&gt;&lt;span class=&quot;c15 c6&quot;&gt;svm-&amp;gt;nested.hsave&lt;/span&gt;&lt;span class=&quot;c6&quot;&gt;&amp;nbsp;with data from the currently active &lt;/span&gt;&lt;span class=&quot;c15 c6&quot;&gt;svm-&amp;gt;vmcb&lt;/span&gt;&lt;span class=&quot;c8 c6&quot;&gt;&amp;nbsp;which contains data for the L2 guest:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c25 c6 c38&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.a93b45d970c173b162741ed3aef6ddfd79d4b4d0&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.4&quot;&gt;&lt;/a&gt;&lt;table class=&quot;c30&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;c28&quot;&gt;&lt;td class=&quot;c17&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c6 c22&quot;&gt;/*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* Save the old vmcb, so we don&amp;#39;t need to pick what we save, but can&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* restore everything when a VMEXIT occurs&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;es &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;es&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;cs &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;cs&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;ss &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;ss&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;ds &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;ds&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;gdtr &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;gdtr&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;idtr &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;idtr&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;efer &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;svm&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;arch&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;efer&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;cr0 &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;kvm_read_cr0&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;cr4 &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;svm&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;arch&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;cr4&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;rflags &lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;kvm_get_rflags&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;rip &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;kvm_rip_read&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;rsp &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;rsp&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;rax &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;rax&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0 c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;npt_enabled&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;cr3 &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;vmcb&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;cr3&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0 c6&quot;&gt;else&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;cr3 &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;kvm_read_cr3&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2 c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; copy_vmcb_control_area&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;hsave&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;vmcb&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3 c6&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1 c6&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c1 c25&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;This becomes a security issue due to the way Model Specific Register (MSR) intercepts are handled for nested guests: &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;SVM uses a permission bitmap to control which MSRs can be accessed by a VM. The bitmap is a 8KB data structure with two bits per MSR, one of which controls read access and the other write access. A 1 bit in this position means the access is intercepted and triggers a vm exit, a 0 bit means the VM has direct access to the MSR. The HPA address of the bitmap is stored in the VMCB control area and for normal L1 KVM guests, the pages are allocated and pinned into memory as soon as a vCPU is created. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;For a nested guest, the MSR permission bitmap is stored in &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm-&amp;gt;nested.msrpm&lt;/span&gt;&lt;span&gt;&amp;nbsp;and its physical address is copied into the active VMCB (in &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm-&amp;gt;vmcb-&amp;gt;control.msrpm_base_pa&lt;/span&gt;&lt;span&gt;) while the nested guest is running. Using the described double invocation of &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;nested_svm_vmrun&lt;/span&gt;&lt;span&gt;, a malicious guest can copy this value into the &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm-&amp;gt;nested.hsave&lt;/span&gt;&lt;span&gt;&amp;nbsp;VMCB when &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;copy_vmcb_control_area&lt;/span&gt;&lt;span&gt;&amp;nbsp;is executed. This is interesting because the KVM&amp;rsquo;s hsave area normally only contains data from the L1 guest context so &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm-&amp;gt;nested.hsave.msrpm_base_pa&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;would normally point to the pinned vCPU-specific MSR bitmap pages. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;This edge case becomes exploitable thanks to a relatively recent change in KVM:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;Since commit &amp;ldquo;&lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit?h=v5.11&amp;id=2fcf4876ada8a293d3b92a1033b8b990a7c613d3&quot;&gt;2fcf4876: KVM: nSVM: implement on demand allocation of the nested state&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;rdquo; from last October, svm-&amp;gt;nested.msrpm is dynamically allocated and freed when a guest changes the SVME bit of the MSR_EFER register:&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.efa5f977707b49310504dc9b5788dd5552d59d85&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.5&quot;&gt;&lt;/a&gt;&lt;table class=&quot;c30&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;c28&quot;&gt;&lt;td class=&quot;c17&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c0&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;svm_set_efer&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;kvm_vcpu &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;u64 efer&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vcpu_svm &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;to_svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; u64 old_efer &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;arch&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;efer&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;arch&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;efer &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;efer&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;old_efer &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;EFER_SVME&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;efer &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;EFER_SVME&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(!(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;efer &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;EFER_SVME&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; svm_leave_nested&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; svm_set_gif&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c22&quot;&gt;/*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* Free the nested guest state, unless we are in SMM.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* In this case we will return to the nested guest&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* as soon as we leave SMM.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(!&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;is_smm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;))&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; svm_free_nested&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;For the &amp;ldquo;disable SVME&amp;rdquo; case, KVM will first call &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm_leave_nested&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;to forcibly leave potential&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;nested guests and then free the &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm-&amp;gt;nested&lt;/span&gt;&lt;span&gt;&amp;nbsp;data structures (including the backing pages for the MSR permission bitmap) in &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm_free_nested&lt;/span&gt;&lt;span&gt;. As &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm_leave_nested&lt;/span&gt;&lt;span&gt;&amp;nbsp;believes that &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm-&amp;gt;nested.hsave&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;contains the saved context of the L1 guest, it simply copies its control area to the real VMCB:&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.0a10403251049de5c610583af2a5a4988152b9bf&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.6&quot;&gt;&lt;/a&gt;&lt;table class=&quot;c30&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;c28&quot;&gt;&lt;td class=&quot;c17&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c0&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;svm_leave_nested&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vcpu_svm &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;is_guest_mode&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vcpu&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;hsave &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;nested&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;vmcb &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;svm&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; copy_vmcb_control_area&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;vmcb&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;hsave&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;control&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;But as mentioned before, &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm-&amp;gt;nested.hsave-&amp;gt;control.msrpm_base_pa&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;can still point to&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c15&quot;&gt;svm-&amp;gt;nested-&amp;gt;msrpm&lt;/span&gt;&lt;span&gt;. Once &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm_free_nested&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;is finished and KVM passes control back to the guest, the CPU will use the freed pages for its MSR permission checks. This gives a guest unrestricted access to host MSRs if the pages are reused and partially overwritten with zeros.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;To summarize, a malicious guest can gain access to host MSRs using the following approach:&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;c12 lst-kix_44h6gatzfsnw-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Enable the SVME bit in MSR_EFER to enable nested virtualization&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Repeatedly try to launch a L2 guest using the VMRUN instruction while flipping the INTERCEPT_VMRUN bit on a second CPU core. &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span&gt;If VMRUN succeeds, try to launch a &amp;ldquo;L3&amp;rdquo; guest using another invocation of VMRUN. If this fails, we have lost the race in step 2 and must try again. If VMRUN succeeds we have successfully overwritten &lt;/span&gt;&lt;span class=&quot;c15&quot;&gt;svm-&amp;gt;nested.hsave&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;with our L2 context. &amp;nbsp;&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Clear the SVME bit in MSR_EFER while still running in the &amp;ldquo;L3&amp;rdquo; context. This frees the MSR permission bitmap backing pages used by the L2 guest who is now executing again. &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Wait until the KVM host reuses the backing pages. This will potentially clear all or some of the bits, giving the guest access to host MSRs.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;When I initially discovered and reported this vulnerability, I was feeling pretty confident that this type of MSR access should be more or less equivalent to full code execution on the host. While my feeling turned out to be correct, getting there still took me multiple weeks of exploit development. In the next section I&amp;rsquo;ll describe the steps to turn this primitive into a guest-to-host escape.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;c13 c20&quot; id=&quot;h.j9bji8tg793n&quot;&gt;&lt;span&gt;The Exploit&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;Assuming our guest can get full unrestricted access to any MSR (which is only a question of timing thanks to init_on_alloc=1 being the default for most modern distributions), how can we escalate this into running arbitrary code in the context of the KVM host? To answer this question we first need to look at what kind of MSRs are supported on a modern AMD system. Looking at the &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://www.amd.com/system/files/TechDocs/52740_16h_Models_30h-3Fh_BKDG.pdf&quot;&gt;BIOS and Kernel Developer&amp;rsquo;s Guide&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;for recent AMD processors we can find a wide range of MSRs starting with well known and widely used ones such as EFER (the Extended Feature Enable Register) or LSTAR (the syscall target address) to rarely used ones like SMI_ON_IO_TRAP (can be used to generate a System Management Mode Interrupt when specific IO port ranges are accessed). &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;Looking at the list, several registers like LSTAR or KERNEL_GSBASE seem like interesting targets for redirecting the execution of the host kernel. Unrestricted access to these registers is actually &lt;/span&gt;&lt;span&gt;enabled by default&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;, however they are automatically restored to a valid state by KVM after a vmexit so modifying them does not lead to any changes in host behavior. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Still, there is one MSR that we previously mentioned and that seems to give us a straightforward way to achieve code execution: The VM_HSAVE_PA that stores the physical address of the host save area, which is used to restore the host context when a vmexit occurs. If we can point this MSR at a memory location under our control we should be able to fake a malicious host context and execute our own code after a vmexit.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;While this sounds pretty straightforward in theory, implementing it still has some challenges:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;c12 lst-kix_qmksthfuerg1-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span&gt;AMD is pretty clear about the fact that software should not touch the host save area in any way and that the data stored in this area is CPU-dependent: &amp;ldquo;&lt;/span&gt;&lt;span class=&quot;c26&quot;&gt;Processor implementations may store only part or none of host state in the memory area pointed to by VM_HSAVE_PA MSR and may store some or all host state in hidden on-chip memory. Different implementations may choose to save the hidden parts of the host&amp;rsquo;s segment registers as well as the selectors. For these reasons, software must not rely on the format or contents of the host state save area, nor attempt to change host state by modifying the contents of the host save area.&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;rdquo; (AMD64 Architecture Programmer&amp;rsquo;s Manual, Volume 2: System Programming, Page 477). To strengthen the point, the format of the host save area is undocumented. &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Debugging issues involving an invalid host state is very tedious as any issue leads to an immediate processor shutdown. Even worse, I wasn&amp;rsquo;t sure if rewriting the VM_HSAVE_PA MSR while running inside a VM can even work. It&amp;rsquo;s not really something that should happen during normal operation so in the worst case scenario, overwriting the MSR would just lead to an immediate crash.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Even if we can create a valid (but malicious) host save area in our guest, we still need some way to identify its host physical address (HPA). Because our guest runs with nested paging enabled, physical addresses that we can see in the guest (GPAs) are still one address translation away from their HPA equivalent.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;After spending some time scrolling through AMD&amp;rsquo;s documentation, I still decided that VM_HSAVE_PA seems to be the best way forward and decided to tackle these problems one by one. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;After dumping the host save area of a normal KVM guest running on an AMD EPYC 7351P CPU, the first problem goes away quickly: As it turns out, the host save area has the same layout as a normal VMCB with only a couple of relevant fields initialized. Even better, the initialized fields include all the saved host information documented in the AMD manual so the fear that all interesting host state is stored in on-chip memory seems to be unfounded. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.62ceb349a4c2f9332b305830fc836b9fe5914c31&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.7&quot;&gt;&lt;/a&gt;&lt;table class=&quot;c30&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;c28&quot;&gt;&lt;td class=&quot;c32&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;c24&quot;&gt;&lt;span class=&quot;c18&quot;&gt;Saving Host State.&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;To ensure that the host can resume operation after #VMEXIT, VMRUN saves at least the following host state information:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;c12 lst-kix_fc4hxeeodeag-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c14 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;CS.SEL, NEXT_RIP&amp;mdash;The CS selector and rIP of the instruction following the VMRUN. On #VMEXIT the host resumes running at this address.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c14 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;RFLAGS, RAX&amp;mdash;Host processor mode and the register used by VMRUN to address the VMCB.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c14 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;SS.SEL, RSP&amp;mdash;Stack pointer for host&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c14 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;CRO, CR3, CR4, EFER&amp;mdash;Paging/operating mode for host&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c14 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;IDTR, GDTR&amp;mdash;The pseudo-descriptors. VMRUN does not save or restore the host LDTR.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c14 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;ES.SEL and DS.SEL. &lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;Under the mistaken assumption that I solved the problem of creating a fake but valid host save area, I decided to look into building an infoleak that gives me the ability to translate GPAs to HPAs. A couple hours of manual reading led me to an AMD-specific performance monitoring feature called Instruction Based Sampling (&lt;/span&gt;&lt;span&gt;IBS&lt;/span&gt;&lt;span&gt;). When IBS is enabled by writing the right magic invocation to a set of MSRs, it samples every Nth instruction that is executed and collects a wide range of information about the instruction. This information is logged in another set of MSRs and can be used to analyze the performance of any piece of code running on the CPU. While most of the documentation for IBS is pretty sparse or hard to follow, the very useful open source project &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://github.com/jlgreathouse/AMD_IBS_Toolkit&quot;&gt;AMD IBS Toolkit&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;contains working code, a readable high level description of IBS and a lot of useful references. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;IBS supports two different modes of operation, one that samples Instruction fetches and one that samples micro-ops (which you can think of as the internal RISC representation of more complex x64 instructions). Depending on the operation mode, different data is collected. Besides a lot of caching and latency information that we don&amp;rsquo;t care about, fetch sampling also returns the virtual address and physical address of the fetched instruction. Op sampling is even more useful as it returns the virtual address of the underlying instruction as well as virtual and physical addresses accessed by any load or store micro op. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;Interestingly, &lt;/span&gt;&lt;span&gt;IBS does not seem to care about the virtualization context of its user and every physical address returned by it is an HPA&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;(of course this is not a problem outside of this exploit as guest accesses to the IBS MSR&amp;rsquo;s will normally be restricted). The wide range of data returned by IBS and the fact that it&amp;rsquo;s completely driven by MSR reads and writes make it the perfect tool for building infoleaks for our exploit. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Building a GPA -&amp;gt; HPA leak boils down to enabling IBS ops sampling, executing a lot of instructions that access a specific memory page in our VM and reading the IBS_DC_PHYS_AD MSR to find out its HPA:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.e9f6e96b7d3821fb7bfbf61c54c1f2f034c111dd&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.8&quot;&gt;&lt;/a&gt;&lt;table class=&quot;c30&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;c28&quot;&gt;&lt;td class=&quot;c17&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22&quot;&gt;// This function leaks the HPA of a guest page using&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22&quot;&gt;// AMD&amp;#39;s Instruction Based Sampling. We try to sample&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22&quot;&gt;// one of our memory loads/writes to *p, which will&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22&quot;&gt;// store the physical memory address in MSR_IBC_DH_PHYS_AD&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c0&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;u64 leak_guest_hpa&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;u8 &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;volatile&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;u8 &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;ptr &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;p&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; u64 ibs &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;scatter_bits&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0x2&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;IBS_OP_CUR_CNT_23&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; scatter_bits&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0x10&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;IBS_OP_MAX_CNT&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;IBS_OP_EN&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; wrmsr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;MSR_IBS_OP_CTL&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;ibs&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; u64 x &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;i &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;i &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0x1000&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;i&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;++)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; x &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;ptr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; ptr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;+=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;ptr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;i &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; ptr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;x&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;i &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; u64 valid &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;rdmsr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;MSR_IBS_OP_CTL&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;IBS_OP_VAL&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;valid&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; u64 op3 &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;rdmsr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;MSR_IBS_OP_DATA3&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;op3 &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;IBS_ST_OP&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;op3 &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;IBS_LD_OP&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;op3 &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;IBS_DC_PHY_ADDR_VALID&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; printf&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c23 c34&quot;&gt;&amp;quot;[x] leak_guest_hpa: %lx %lx %lx\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;rdmsr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;MSR_IBS_OP_RIP&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;),&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;rdmsr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;MSR_IBS_DC_PHYS_AD&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;rdmsr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;MSR_IBS_DC_LIN_AD&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;));&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c0&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;rdmsr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;MSR_IBS_DC_PHYS_AD&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;~(&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0xFFF&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; wrmsr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;MSR_IBS_OP_CTL&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;ibs&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c11&quot;&gt;&lt;span class=&quot;c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &amp;nbsp; wrmsr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;MSR_IBS_OP_CTL&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;ibs &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;IBS_OP_EN&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Using this infoleak primitive, I started to create a fake host save area by preparing my own page tables (for pointing CR3 at them), interrupt descriptor tables and segment descriptors and pointing RIP to a primitive shellcode that would write to the serial console. Of course, my first tries immediately crashed the whole system and even after spending multiple days to make sure everything was set up correctly, the system would crash immediately once I pointed the hsave MSR at my own location. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;After getting frustrated with the total lack of progress, watching my server reboot for the hundredth time, trying to come up with a different exploitation strategy for two weeks and learning about the surprising regularity of physical page migrations on Linux, I realized that I made an important mistake. Just because the CPU initializes all the expected fields in the host save area, it is not safe to assume that these fields are actually used for restoring the host context. Slow trial and error led to the discovery that my AMD EPYC CPU ignores everything in the host save area besides the values of the RIP, RSP and RAX registers.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;While this register control would make a local privilege escalation straightforward, escaping the VM boundary is a bit more complicated. RIP and RSP control make launching a kernel ROP chain the next logical step, but this requires us to first break the host kernel&amp;#39;s address randomization and to find a way to store controlled data at a known host virtual address (HVA). &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Fortunately, we have IBS as a powerful infoleak building primitive and can use it to gather all required information in a single run: &lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;c12 lst-kix_p3qtgxnpnwqf-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Leaking the host kernel&amp;#39;s (or more specifically kvm-amd.ko&amp;rsquo;s) base address can be done by enabling IBS sampling with a small sampling interval and immediately triggering a VM exit. When VM execution continues, the IBS result MSRs will contain the HVA of instructions executed by KVM during the exit handling. &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span&gt;The most powerful way to store data at a known HVA is to leak the location of the kernel&amp;rsquo;s linear mapping (also known as &lt;/span&gt;&lt;span&gt;physmap&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;), a 1:1 mapping of all physical pages on the system. This gives us a GPA-&amp;gt;HVA translation primitive by first using our GPA-&amp;gt;HPA infoleak from above and then adding the HPA to the physmap base address. Leaking the physmap is possible by sampling micro ops in the host kernel until we find a read or write operation, where the lower ~30 bits of the accessed virtual address and physical address are identical. &lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Having all these building blocks in place, we could now try to build a kernel ROP chain that executes some interesting payload. However, there is one important caveat. When we take over execution after a vmexit, the system is still in a somewhat unstable state. As mentioned above, SVM&amp;rsquo;s context switching is very minimal and we are at least one VMLOAD instruction and reenabling of interrupts away from a usable system. While it is surely possible to exploit this bug and to restore the original host context using a sufficiently complex ROP chain, I decided to find a way to run my own code instead.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;A couple of years ago, the Linux physmap was still mapped executable and executing our own code would be as simple as jumping to a physmap mapping of one of our guest pages. Of course, that is not possible anymore and the kernel tries hard to not have any memory pages mapped as writable and executable. Still, page protections only apply to virtual memory accesses so why not use an instruction that directly writes controlled data to a physical address? As you might remember from our initial discussion of SVM earlier in this chapter, SVM supports an instruction called VMSAVE to store hidden guest state (or host state) in a VMCB. Similar to VMRUN, VMSAVE takes a physical address to a VMCB stored in the RAX register as an implicit argument. It then writes the following register state to the VMCB:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;c12 lst-kix_dvq5vbolwb6x-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;FS, GS, TR, LDTR &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;KernelGsBase &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;STAR, LSTAR, CSTAR, SFMASK &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;SYSENTER_CS, SYSENTER_ESP, SYSENTER_EIP&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;For us, VMSAVE is interesting for a couple of reasons:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;c12 lst-kix_z3dz91t3nune-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;It is used as part of KVM&amp;rsquo;s normal SVM exit handler and can be easily integrated into a minimal ROP chain.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;It operates on physical addresses, so we can use it to write to an arbitrary memory location including KVM&amp;rsquo;s own code.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;All written registers still contain the guest values set by our VM, allowing us to control the written content with some restrictions&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;VMSAVE&amp;rsquo;s biggest downside as an exploitation primitive is that RAX needs to be page aligned, reducing our control of the target address. VMSAVE writes to the memory offsets 0x440-0x480 and 0x600-0x638 so we need to be careful about not corrupting any memory that&amp;rsquo;s in use. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;In our case this turns out to be a non-issue, as KVM contains a couple of code pages where functions that are rarely or never used (e.g cleanup_module or SEV specific code) are stored at these offsets. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;While we don&amp;rsquo;t have full control over the written data and valid register values are somewhat restricted, it is still possible to write a minimal stage0 shellcode to an arbitrary page in the host kernel by filling guest MSRs with the right values. My exploit uses the STAR, LSTAR and CSTAR registers for this which are written to the physical offsets 0x400, 0x408 and 0x410. As all three registers need to contain&lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://en.wikipedia.org/w/index.php?title=X86-64#Virtual_address_space_details&quot;&gt;&amp;nbsp;canonical addresses&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;, we can only use parts of the registers for our shellcode and use relative jumps to skip the unusable parts of the STAR and LSTAR MSRs:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.42d44951583ac9bd6dae4dc111d7e4042c6fe14e&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.9&quot;&gt;&lt;/a&gt;&lt;table class=&quot;c30&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;c28&quot;&gt;&lt;td class=&quot;c17&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c22&quot;&gt;&amp;nbsp; // mov cr0, rbx; &lt;/span&gt;&lt;span class=&quot;c22&quot;&gt;jmp&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; wrmsr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;MSR_STAR&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0x00000003ebc3220f&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c22&quot;&gt;// pop rdi; pop rsi; pop rcx; jmp&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; wrmsr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;MSR_LSTAR&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0x00000003&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;eb595e5fULL&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;c22&quot;&gt;// rep movsb; pop rdi; jmp rdi;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5&quot;&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp; wrmsr&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;MSR_CSTAR&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;c10&quot;&gt;0xe7ff5fa4f3&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;The above code makes use of the fact that we control the value of the RBX register and the stack when we return to it as part of our initial ROP chain. First, we copy the value of RBX (0x80040033) into CR0, which disables Write Protection (WP) for kernel memory accesses. This makes all of the kernel code writable on this CPU allowing us to copy a larger stage1 shellcode to an arbitrary unused memory location and jump to it.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Once the WP bit in cr0 is disabled and the stage1 payload executes, we have a wide range of options. For my proof-of-concept exploit I decided on a somewhat boring but easy-to-implement approach to spawn a random user space command: The host is still in a very weird state so our stage1 payload can&amp;rsquo;t directly call into other kernel functions, but we can easily backdoor a function pointer which will be called at some later point in time. KVM uses the kernel&amp;rsquo;s global workqueue feature to regularly synchronize a VM&amp;rsquo;s clock between different vCPUs. The function pointer responsible for this work is stored in the (per VM) kvm-&amp;gt;arch data structure as kvm-&amp;gt;arch.kvmclock_update_work. The stage1 payload overrides this function pointer with the address of a stage2 payload. To put the host into a usable state it then sets the VM_HSAVE_PA MSR back to its original value and restores RSP and RIP to call the original vmexit handler. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;The final stage2 payload executes at some later point in time as part of the kernel global work queue and uses the call_usermodehelper to run an arbitrary command with root privileges. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Let&amp;rsquo;s put all of this together and walk through the attacks step-by-step:&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;c12 lst-kix_69oxjbhu0l4-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Prepare the stage0 payload by splitting it up and setting the right guest MSRs.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Trigger the TOCTOU vulnerability in nested_svm_vmrun and free the MSR permission bitmap by disabling the SVME bit in the EFER MSR.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Wait for the pages to be reused and initialized to 0 to get unrestricted MSR access.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Prepare a fake host save area, a stack for the initial ROP chain and a staging memory area for the stage1 and stage2 payloads. &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Leak the HPA of the host save area, the HVA addresses of the stack and staging page and the kvm-amd.ko&amp;rsquo;s base address using the different IBS infoleaks.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Redirect execution to the VMSAVE gadget by setting RIP, RSP and RAX in the fake host save area, pointing the VM_HSAVE_PA MSR at it and triggering a VM exit.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;VMSAVE writes the stage0 payload to an unused offset in kvm-amd&amp;rsquo;s code segment, when the gadget returns stage0 gets executed.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;stage0 disables Write Protection in CR0 and overwrites an unused executable memory location with the stage1 and stage2 payloads, before jumping to stage1.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;stage1 overwrites kvm-&amp;gt;arch.kvmclock_update_work.work.func with a pointer to stage2 before restoring the original host context.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;At some later point in time kvm-&amp;gt;arch.kvmclock_update_work.work.func is called as part of the global kernel work_queue and stage2 spawns an arbitrary command using call_usermodehelper. &lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;Interested readers should take a look at the heavily documented &lt;/span&gt;&lt;span class=&quot;c16&quot;&gt;&lt;a class=&quot;c71&quot; href=&quot;https://bugs.chromium.org/p/project-zero/issues/detail?id=2177#c5&quot;&gt;proof-of-concept exploit&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;for the actual implementation. &lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;c20 c13&quot; id=&quot;h.jz5frebdego5&quot;&gt;&lt;span class=&quot;c21&quot;&gt;Conclusion&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;This blog post describes a KVM-only VM escape made possible by a small bug in KVM&amp;rsquo;s AMD-specific code for supporting nested virtualization. Luckily, the feature that made this bug exploitable was only included in two kernel versions (v5.10, v5.11) before the issue was spotted, reducing the real-life impact of the vulnerability to a minimum. &lt;/span&gt;&lt;span&gt;The bug and its exploit still serve as a demonstration that highly exploitable security vulnerabilities can still exist in the very core of a virtualization engine, which is almost certainly a small and well audited codebase&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;. While the attack surface of a hypervisor such as KVM is relatively small from a pure LoC perspective, its low level nature, close interaction with hardware and pure complexity makes it very hard to avoid security-critical bugs. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span&gt;While we have not seen any in-the-wild exploits targeting hypervisors outside of competitions like Pwn2Own, these capabilities are clearly achievable for a well-financed adversary. I&amp;rsquo;ve spent around two months on this research, working as an individual with only remote access to an AMD system. Looking at the potential ROI on an exploit like this, it seems safe to assume that more people are working on similar issues right now and that vulnerabilities in KVM, Hyper-V, Xen or VMware will be exploited in-the-wild sooner or later.&lt;/span&gt;&lt;span class=&quot;c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;What can we do about this? Security engineers working on Virtualization Security should push for as much attack surface reduction as possible. Moving complex functionality to memory-safe user space components is a big win even if it does not help against bugs like the one described above. Disabling unneeded or unreviewed features and performing regular in-depth code reviews for new changes can further reduce the risk of bugs slipping by. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c13&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Hosters, cloud providers and other enterprises that are relying on virtualization for multi-tenancy isolation should design their architecture in way that limits the impact of an attacker with an VM escape exploit:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;c12 lst-kix_rg61eog4va0o-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span&gt;Isolation of VM hosts: Machines that host untrusted VMs should be considered at least partially untrusted. While a VM escape can give an attacker full control over a single host, it should not be easily possible to move from one compromised host to another. This requires that the control plane and backend infrastructure is sufficiently hardened and that user resources like disk images or encryption keys are only exposed to hosts that need them. One&lt;/span&gt;&lt;span&gt;&amp;nbsp;way to limit the impact of a VM escape even further is to only run VMs of a specific customer or of a certain sensitivity on a single machine.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 li-bullet-0&quot;&gt;&lt;span class=&quot;c8&quot;&gt;Investing in detection capabilities: In most architectures, the behavior of a VM host should be very predictable, making a compromised host stick out quickly once an attacker tries to move to other systems. While it&amp;rsquo;s very hard to rule out the possibility of a vulnerability in your virtualization stack, good detection capabilities make life for an attacker much harder and increase the risk of quickly burning a high-value vulnerability. Agents running on the VM host can be a first (but bypassable) detection mechanism, but the focus should be on detecting unusual network communication and resource accesses.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;c5 c9 c35&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9 c35&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c5 c9&quot;&gt;&lt;span class=&quot;c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;</content><link rel='replies' type='application/atom+xml' href='https://googleprojectzero.blogspot.com/feeds/8408446653514773445/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='https://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/8408446653514773445'/><link rel='self' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/8408446653514773445'/><link rel='alternate' type='text/html' href='https://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html' title='An EPYC escape: Case-study of a KVM breakout'/><author><name>Anonymous</name><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/blank.gif'/></author><thr:total>0</thr:total></entry>