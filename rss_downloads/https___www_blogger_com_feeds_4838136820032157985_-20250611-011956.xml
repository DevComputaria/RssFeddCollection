<?xml version='1.0' encoding='UTF-8'?><?xml-stylesheet href="http://www.blogger.com/styles/atom.css" type="text/css"?><entry xmlns='http://www.w3.org/2005/Atom' xmlns:blogger='http://schemas.google.com/blogger/2008' xmlns:georss='http://www.georss.org/georss' xmlns:gd='http://schemas.google.com/g/2005' xmlns:thr='http://purl.org/syndication/thread/1.0'><id>tag:blogger.com,1999:blog-4838136820032157985.post-5973748726134682294</id><published>2022-06-23T09:01:00.002-07:00</published><updated>2022-08-24T11:58:33.315-07:00</updated><title type='text'>The curious tale of a fake Carrier.app</title><content type='html'>&lt;style type=&quot;text/css&quot;&gt;@import url(&#39;https://themes.googleusercontent.com/fonts/css?kit=cGvuclDC_Z1vE_cnVEU6Ae_NZQ7StBcqH_vXVqoPMX0&#39;);ol{margin:0;padding:0}table td,table th{padding:0}.HovzfPYjjR-c13{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#e0e0e0;border-bottom-style:solid}.HovzfPYjjR-c34{padding-top:0pt;padding-bottom:3pt;line-height:1.5;page-break-after:avoid;text-align:left}.HovzfPYjjR-c15{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.HovzfPYjjR-c17{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.HovzfPYjjR-c31{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:center}.HovzfPYjjR-c6{color:#000000;font-weight:400;font-size:11pt;font-family:&quot;Courier New&quot;}.HovzfPYjjR-c9{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#9c27b0;font-weight:400}.HovzfPYjjR-c0{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#000000;font-weight:400}.HovzfPYjjR-c30{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#455a64;font-weight:400}.HovzfPYjjR-c20{border-spacing:0;border-collapse:collapse;margin-right:auto}.HovzfPYjjR-c3{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.HovzfPYjjR-c14{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#3367d6;font-weight:400}.HovzfPYjjR-c16{color:#000000;font-weight:400;font-size:16pt;font-family:&quot;Arial&quot;}.HovzfPYjjR-c5{color:#000000;font-weight:400;font-size:11pt;font-family:&quot;Arial&quot;}.HovzfPYjjR-c27{color:#000000;font-weight:700;font-size:11pt;font-family:&quot;Arial&quot;}.HovzfPYjjR-c23{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#c53929;font-weight:700}.HovzfPYjjR-c22{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#0f9d58;font-weight:400}.HovzfPYjjR-c1{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#616161;font-weight:400}.HovzfPYjjR-c4{font-size:10pt;font-family:Consolas,&quot;Courier New&quot;;color:#c53929;font-weight:400}.HovzfPYjjR-c24{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:right}.HovzfPYjjR-c21{color:#000000;font-weight:400;font-size:26pt;font-family:&quot;Arial&quot;}.HovzfPYjjR-c2{text-decoration:none;vertical-align:baseline;font-style:normal}.HovzfPYjjR-c33{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.HovzfPYjjR-c32{margin-left:22.5pt;text-indent:36pt}.HovzfPYjjR-c19{color:inherit;text-decoration:inherit}.HovzfPYjjR-c26{font-weight:700;font-family:&quot;Courier New&quot;}.HovzfPYjjR-c7{font-weight:400;font-family:&quot;Courier New&quot;}.HovzfPYjjR-c28{text-decoration:none;vertical-align:baseline}.HovzfPYjjR-c8{orphans:2;widows:2}.HovzfPYjjR-c29{font-weight:700}.HovzfPYjjR-c18{height:0pt}.HovzfPYjjR-c25{font-style:italic}.HovzfPYjjR-c11{background-color:#00ff00}.HovzfPYjjR-c12{margin-right:-45pt}.HovzfPYjjR-c10{height:11pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}p{margin:0;color:#000000;font-size:11pt;font-family:&quot;Arial&quot;}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:&quot;Arial&quot;;line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}&lt;/style&gt;&lt;body class=&quot;HovzfPYjjR-c33&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;Posted by Ian Beer, Google Project Zero&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c29&quot;&gt;NOTE: This issue was CVE-2021-30983 was fixed in iOS 15.2 in December 2021.&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c2 HovzfPYjjR-c27&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;Towards the end of 2021 Google&#39;s Threat Analysis Group (TAG) shared an iPhone app&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;with me:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEioBjlvs-GjJW9ZocxERk7cU6J-bBcWIjauCAzuI6QoMvdQENbSjF6elAZ0yUpLbHfTmOzfdKWBhB_FFR8X9UF1yMqN9XSMmJSUDZ_uVX_zctpmYMaD0G6V7bi68tdJ2C-e3eyM715_cTywzOWAgSbPyazbNtMv65p0lWewhacxCox_vrztKXdRZdjB/s1874/Screenshot%202022-06-22%20at%2016.52.33.png&quot; style=&quot;display: block; padding: 1em 0; text-align: center;&quot;&gt;&lt;img alt=&quot;App splash screen showing the Vodafone carrier logo and the text My Vodafone.&quot; border=&quot;0&quot; src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEioBjlvs-GjJW9ZocxERk7cU6J-bBcWIjauCAzuI6QoMvdQENbSjF6elAZ0yUpLbHfTmOzfdKWBhB_FFR8X9UF1yMqN9XSMmJSUDZ_uVX_zctpmYMaD0G6V7bi68tdJ2C-e3eyM715_cTywzOWAgSbPyazbNtMv65p0lWewhacxCox_vrztKXdRZdjB/s1200/Screenshot%202022-06-22%20at%2016.52.33.png&quot; style=&quot;max-height: 750px; max-width: 600px;&quot; title=&quot;App splash screen showing the Vodafone carrier logo and the text My Vodafone.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;img /&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c24 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c25&quot;&gt;App splash screen showing the Vodafone carrier logo and the text &quot;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c25&quot;&gt;My Vodafone&lt;/span&gt;&lt;span class=&quot;c5 c28 c25&quot;&gt;&quot; (not the legitimate Vodadone app)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;Although this looks like the real &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://apps.apple.com/gb/app/my-vodafone/id370901726&quot;&gt;My Vodafone carrier app&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;available in the App Store, it didn&#39;t come from the App Store and is not the real application from Vodafone. TAG suspects that a target receives a link to this app in an SMS, after the attacker asks the carrier to disable the target&#39;s mobile data connection. The SMS claims that in order to restore mobile data connectivity, the target must install the carrier app and includes a link to download and install this fake app.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;This sideloading works because the app is signed with an enterprise certificate, which can be purchased for $299 via the Apple &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://developer.apple.com/programs/enterprise/&quot;&gt;Enterprise developer program&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. This program allows an eligible enterprise to obtain an Apple-signed &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;embedded.mobileprovision&lt;/span&gt;&lt;span&gt;&amp;nbsp;file with the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;ProvisionsAllDevices&lt;/span&gt;&lt;span&gt;&amp;nbsp;key set. An app signed with the developer certificate embedded within that &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;mobileprovision&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;file can be sideloaded on any iPhone, bypassing Apple&#39;s App Store review process. While we understand that the Enterprise developer program is designed for companies to push &quot;trusted apps&quot; to their staff&#39;s iOS devices, in this case, it appears that it was being used to sideload this fake carrier app.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;In collaboration with Project Zero, &lt;/span&gt;&lt;span&gt;&lt;a href=&quot;https://blog.google/threat-analysis-group/italian-spyware-vendor-targets-users-in-italy-and-kazakhstan/&quot; target=&quot;_blank&quot;&gt;TAG has published an additional post with more details around the targeting and the actor&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. The rest of this blogpost is dedicated to the technical analysis of the app and the exploits contained therein.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;HovzfPYjjR-c15 HovzfPYjjR-c8&quot; id=&quot;h.rengd0ayidhp&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c16 HovzfPYjjR-c2&quot;&gt;App structure&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The app is broken up into multiple frameworks. &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;InjectionKit.framework&lt;/span&gt;&lt;span&gt;&amp;nbsp;is a generic privilege escalation exploit wrapper, exposing the primitives you&#39;d expect (kernel memory access, entitlement injection, &lt;/span&gt;&lt;span&gt;amfid&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;bypasses) as well as higher-level operations like app installation, file creation and so on.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;Agent.framework&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c2 HovzfPYjjR-c5&quot;&gt;&amp;nbsp;is partially obfuscated but, as the name suggests, seems to be a basic agent able to find and exfiltrate interesting files from the device like the Whatsapp messages database.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;Six privilege escalation exploits are bundled with this app. Five are well-known, publicly available N-day exploits for older iOS versions. The sixth is not like those others at all.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;This blog post is the story of the last exploit and the month-long journey to understand it.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;HovzfPYjjR-c15 HovzfPYjjR-c8&quot; id=&quot;h.nr1ejtuvx4nm&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c16 HovzfPYjjR-c2&quot;&gt;Something&#39;s missing? Or am I missing something?&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;Although all the exploits were different, five of them shared a common high-level structure. An initial phase where the kernel heap was manipulated to control object placement. Then the triggering of a kernel vulnerability followed by well-known steps to turn that into something useful, perhaps by disclosing kernel memory then building an arbitrary kernel memory write primitive.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;The sixth exploit didn&#39;t have anything like that.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;Perhaps it could be triggering a kernel logic bug like Linuz Henze&#39;s &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://github.com/LinusHenze/Fugu14&quot;&gt;Fugu14&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;exploit, or a very bad memory safety issue which gave fairly direct kernel memory access. But neither of those seemed very plausible either. &lt;/span&gt;&lt;span&gt;It looked, quite simply, like an iOS kernel exploit from a decade ago, except one which was first quite carefully checking that it was only running on an iPhone 12 or 13.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;It contained log messages like:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; printf(&quot;Failed to prepare fake vtable: 0x%08x&quot;, ret);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;which seemed to happen far earlier than the exploit could possibly have defeated mitigations like K&lt;/span&gt;&lt;span&gt;ASLR&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;and PAC.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;Shortly after that was this log message:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; printf(&quot;Waiting for R/W primitives...&quot;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;Why would you need to wait?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;Then shortly after that:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; printf(&quot;Memory read/write and callfunc primitives ready!&quot;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;Up to that point the exploit made only four &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;IOConnectCallMethod&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;calls and there were no other obvious attempts at heap manipulation. But there was another log message which started to shed some light:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;&amp;nbsp; printf(&quot;Unexpected data read from DCP: 0x%08x&quot;, v49);&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;HovzfPYjjR-c15 HovzfPYjjR-c8&quot; id=&quot;h.dlybqvef2fq5&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c16 HovzfPYjjR-c2&quot;&gt;DCP?&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;In October 2021 Adam Donenfeld tweeted this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;img /&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgizH1ivW5VjBBB2oIDHbvRvevtn3SaYgaWlwf_F_bWSAb9b9kMrycHwATVj_tyHb22sjTc9jJmwQTc-ehvzmruznZtyWToUNiEfyif6nl3latUr3STT8P0YSL0MgxB8_t-CjNLdHITK0kpCcuYPJhFN7zuOX6s1DqOQVQxthrazNfK0ktsvn4Na1hl/s1988/Screenshot%202022-06-22%20at%2016.52.56.png&quot; style=&quot;display: block; padding: 1em 0; text-align: center;&quot;&gt;&lt;img alt=&quot;Screenshot of Tweet from @doadam on 11 Oct 2021, which is a retweet from @AmarSaar on 11 October 2021. The tweet from @AmarSaar reads &#39;So, another IOMFB vulnerability was exploited ITW (15.0.2). I bindiffed the patch and built a POC. And, because it&#39;s a great bug, I just finished writing a short blogpost with the tech details, to share this knowledge :) Check it out! https://saaramar.github.io/IOMFB_integer_overflow_poc/&#39; and the retweet from @doadam reads &#39;This has been moved to the display coprocessor (DCP) starting from 15, at least on iPhone 12 (and most probably other ones as well)&#39;.&quot; border=&quot;0&quot; src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgizH1ivW5VjBBB2oIDHbvRvevtn3SaYgaWlwf_F_bWSAb9b9kMrycHwATVj_tyHb22sjTc9jJmwQTc-ehvzmruznZtyWToUNiEfyif6nl3latUr3STT8P0YSL0MgxB8_t-CjNLdHITK0kpCcuYPJhFN7zuOX6s1DqOQVQxthrazNfK0ktsvn4Na1hl/s1200/Screenshot%202022-06-22%20at%2016.52.56.png&quot; style=&quot;max-height: 750; max-width: 600px;&quot; title=&quot;Screenshot of Tweet from @doadam on 11 Oct 2021, which is a retweet from @AmarSaar on 11 October 2021. The tweet from @AmarSaar reads &#39;So, another IOMFB vulnerability was exploited ITW (15.0.2). I bindiffed the patch and built a POC. And, because it&#39;s a great bug, I just finished writing a short blogpost with the tech details, to share this knowledge :) Check it out! https://saaramar.github.io/IOMFB_integer_overflow_poc/&#39; and the retweet from @doadam reads &#39;This has been moved to the display coprocessor (DCP) starting from 15, at least on iPhone 12 (and most probably other ones as well)&#39;.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;DCP is the &quot;Display Co-Processor&quot; which ships with iPhone 12 and above and all M1 Macs.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;There&#39;s little public information about the DCP; the most comprehensive comes from the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://asahilinux.org/&quot;&gt;Asahi linux project&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;which is porting linux to M1 Macs. In their &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://asahilinux.org/2021/08/progress-report-august-2021/&quot;&gt;August 2021&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://asahilinux.org/2021/10/progress-report-september-2021/&quot;&gt;September 2021&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;updates they discussed their DCP reverse-engineering efforts and the open-source DCP client written by &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://twitter.com/alyssarzg&quot;&gt;@alyssarzg&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;. Asahi describe the DCP like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;c3 c8 c32&quot;&gt;&lt;span class=&quot;c5 c28 c25&quot;&gt;On most mobile SoCs, the display controller is just a piece of hardware with simple registers. While this is true on the M1 as well, Apple decided to give it a twist. They added a coprocessor to the display engine (called DCP), which runs its own firmware (initialized by the system bootloader), and moved most of the display driver into the coprocessor. But instead of doing it at a natural driver boundary… they took half of their macOS C++ driver, moved it into the DCP, and created a remote procedure call interface so that each half can call methods on C++ objects on the other CPU! &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c8 HovzfPYjjR-c24&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://asahilinux.org/2021/08/progress-report-august-2021/&quot;&gt;https://asahilinux.org/2021/08/progress-report-august-2021/&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;The Asahi linux project reverse-engineered the API to talk to the DCP but they are restricted to using Apple&#39;s DCP firmware (loaded by iBoot) - they can&#39;t use a custom DCP firmware. Consequently their documentation is limited to the DCP RPC API with few details of the DCP internals.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;HovzfPYjjR-c15 HovzfPYjjR-c8&quot; id=&quot;h.nj6hztnr911v&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c2 HovzfPYjjR-c16&quot;&gt;Setting the stage&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;Before diving into DCP internals it&#39;s worth stepping back a little. What even is a co-processor in a modern, highly integrated SoC (System-on-a-Chip) and what might the consequences of compromising it be?&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;Years ago a co-processor would likely have been a physically separate chip. Nowadays a large number of these co-processors are integrated along with their interconnects directly onto a single die, even if they remain fairly independent systems. We can see in this M1 die shot from &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://www.techinsights.com/blog/two-new-apple-socs-two-market-events-apple-a14-and-m1&quot;&gt;Tech Insights&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;that the CPU cores in the middle and right hand side take up only around 10% of the die:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c31 HovzfPYjjR-c8&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c8 HovzfPYjjR-c31&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjjtJjSN0qdOa1cKBG72s9uuwcVKU5evSg9CiIPtpbbFox0fGgW7XZQU1Jj4IezjIdHC23sJbnklT6acyTFiqB-0-qmcj35Gq-ZZyTHP0DcfFkBztA0DL2P3lhYy2n0k8wgzmzaYX8IMeKosr4uuWMXT-wplsuJQmfR4LDgFzWAUZARvx5rfWjWiusz/s1116/Screenshot%202022-06-22%20at%2016.53.12.png&quot; style=&quot;display: block; padding: 1em 0; text-align: center;&quot;&gt;&lt;img alt=&quot;M1 die-shot from techinsights.com with possible location of DCP highlighted.&quot; border=&quot;0&quot; src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjjtJjSN0qdOa1cKBG72s9uuwcVKU5evSg9CiIPtpbbFox0fGgW7XZQU1Jj4IezjIdHC23sJbnklT6acyTFiqB-0-qmcj35Gq-ZZyTHP0DcfFkBztA0DL2P3lhYy2n0k8wgzmzaYX8IMeKosr4uuWMXT-wplsuJQmfR4LDgFzWAUZARvx5rfWjWiusz/s1116/Screenshot%202022-06-22%20at%2016.53.12.png&quot; style=&quot;max-height: 750; max-width: 600px;&quot; title=&quot;M1 die-shot from techinsights.com with possible location of DCP highlighted.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c24 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;c5 c25 c28&quot;&gt;M1 die-shot from techinsights.com with possible location of DCP added&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c24 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c17 HovzfPYjjR-c25&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://www.techinsights.com/blog/two-new-apple-socs-two-market-events-apple-a14-and-m1&quot;&gt;https://www.techinsights.com/blog/two-new-apple-socs-two-market-events-apple-a14-and-m1&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;Companies like &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://www.systemplus.fr/&quot;&gt;SystemPlus&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;perform &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://www.systemplus.fr/wp-content/uploads/2020/12/SP20608-Apple-M1-System-on-Chip-Sample.pdf&quot;&gt;very thorough analysis of these dies&lt;/a&gt;&lt;/span&gt;&lt;span&gt;. Based on their analysis the DCP is likely the rectangular region indicated on this M1 die. It takes up around the same amount of space as the four high-&lt;/span&gt;&lt;span&gt;efficiency&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;cores seen in the centre, though it seems to be mostly SRAM.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;With just this low-resolution image it&#39;s not really possible to say much more about the functionality or capabilities of the DCP and what level of system access it has. To answer those questions we&#39;ll need to take a look at the firmware.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;HovzfPYjjR-c15 HovzfPYjjR-c8&quot; id=&quot;h.mnw2kq5jkaze&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c16 HovzfPYjjR-c2&quot;&gt;My kingdom for a .dSYM!&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The first step is to get the DCP firmware image. iPhones (and now M1 macs) use &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;.ipsw&lt;/span&gt;&lt;span&gt;&amp;nbsp;files for system images. An &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;.ipsw&lt;/span&gt;&lt;span&gt;&amp;nbsp;is really just a &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;.zip&lt;/span&gt;&lt;span&gt;&amp;nbsp;archive and the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;Firmware/&lt;/span&gt;&lt;span&gt;&amp;nbsp;folder in the extracted &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;.zip&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;contains all the firmware for the co-processors, modems etc. The DCP firmware is this file:&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;display: none; page-break-before: always;&quot; /&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; Firmware/dcp/iphone13dcp.im4p&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;im4p&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;in this case is just a 25 byte header which we can discard:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; $ dd if=iphone13dcp.im4p of=iphone13dcp bs=25 skip=1&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c2 HovzfPYjjR-c6&quot;&gt;&amp;nbsp; $ file iphone13dcp&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; iphone13dcp: Mach-O 64-bit preload executable arm64&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;It&#39;s a Mach-O! Running &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;nm -a&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;to list all symbols shows that the binary has been fully stripped:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; $ nm -a iphone13dcp&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; iphone13dcp: no symbols&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;Function names make understanding code significantly easier. From looking at the handful of strings in the exploit some of them looked like they might be referencing symbols in a DCP firmware image (&quot;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;M3_CA_ResponseLUT read: 0x%08x&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&quot; for example) so I thought perhaps there might be a DCP firmware image where the symbols hadn&#39;t been stripped.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;Since the firmware images are distributed as &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;.zip&lt;/span&gt;&lt;span&gt;&amp;nbsp;files and Apple&#39;s servers support range requests with a bit of python and the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://github.com/marcograss/partialzip&quot;&gt;partialzip&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;tool&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;we can relatively easily and quickly get every beta and release DCP firmware. I checked over 300 distinct images; every single one was stripped.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;Guess we&#39;ll have to do this the hard way!&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;HovzfPYjjR-c15 HovzfPYjjR-c8&quot; id=&quot;h.m9onjpj2j9i&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c16 HovzfPYjjR-c2&quot;&gt;Day 1; Instruction 1&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;c3 c8 c12&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;$ otool -h raw_fw/iphone13dcp&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c12 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c12&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;raw_fw/iphone13dcp:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c12&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;Mach header&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c12&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;magic &amp;nbsp; &amp;nbsp; &amp;nbsp;cputype &amp;nbsp; cpusubtype caps filetype ncmds sizeofcmds flags&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c12&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;0xfeedfacf 0x100000C 0 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;0x00 5 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;5 &amp;nbsp; &amp;nbsp; 2240 &amp;nbsp; &amp;nbsp; &amp;nbsp; 0x00000001&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;That &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;cputype&lt;/span&gt;&lt;span&gt;&amp;nbsp;is plain &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;arm64&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;(ArmV8) without pointer authentication support. The binary is fairly large (3.7MB) and IDA&#39;s autoanalysis detects over 7000 functions.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;With any brand new binary I usually start with a brief look through the function names and the strings. The binary is stripped so there are no function name symbols but there are plenty of C++ function names as strings:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;img /&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhY8rBSaTDR2W5pSgk9ssaCqN8M8Nuhd5_x6FkNSqOI-jRDFVab_jrrkZlN1DS2FKf9zeAPPDFkE30kNCPpN3PES9RdvBLj4L6G78zq134bTQcR1VEe7J30tYPoqqZ82z1cPwUcvF2wzfoOEbDf3l_4ucxpuOZFC2NLyrMYV_luJ_5dysxanajqsi-N/s1830/Screenshot%202022-06-22%20at%2016.53.26.png&quot; style=&quot;display: block; padding: 1em 0; text-align: center;&quot;&gt;&lt;img alt=&quot;A short list of C++ prototypes like IOMFB::UPBlock_ALSS::init(IOMFB::UPPipe *).&quot; border=&quot;0&quot; src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhY8rBSaTDR2W5pSgk9ssaCqN8M8Nuhd5_x6FkNSqOI-jRDFVab_jrrkZlN1DS2FKf9zeAPPDFkE30kNCPpN3PES9RdvBLj4L6G78zq134bTQcR1VEe7J30tYPoqqZ82z1cPwUcvF2wzfoOEbDf3l_4ucxpuOZFC2NLyrMYV_luJ_5dysxanajqsi-N/s1200/Screenshot%202022-06-22%20at%2016.53.26.png&quot; style=&quot;max-height: 750; max-width: 600px;&quot; title=&quot;A short list of C++ prototypes like IOMFB::UPBlock_ALSS::init(IOMFB::UPPipe *).&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;The cross-references to those strings look like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.c7f36f1411586a1b165d5a48e181a07b7b9d07a6&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.0&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0x40000001LL&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&quot;UPBlock_ALSS.cpp&quot;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;341&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&quot;%s: capture buffer exhausted, aborting capture\n&quot;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&quot;void IOMFB::UPBlock_ALSS::send_data(uint64_t, uint32_t)&quot;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;This is almost certainly a logging macro which expands &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;__FILE__&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;&amp;nbsp;__LINE__&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;__PRETTY_FUNCTION__&lt;/span&gt;&lt;span&gt;. This allows us to start renaming functions and finding vtable pointers.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;HovzfPYjjR-c15 HovzfPYjjR-c8&quot; id=&quot;h.72tz1dtagcu2&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c16 HovzfPYjjR-c2&quot;&gt;Object structure&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;From the Asahi linux blog posts we know that the DCP is using an Apple-proprietary RTOS called RTKit for which there is very little public information. There are some strings in the binary with the exact version:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;ADD &amp;nbsp;X8, X8, #aLocalIphone13d@PAGEOFF ; &quot;local-iphone13dcp.release&quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;ADD &amp;nbsp;X9, X9, #aRtkitIos182640@PAGEOFF ; &quot;RTKit_iOS-1826.40.9.debug&quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;The code appears to be predominantly C++. There appear to be multiple C++ object hierarchies; those involved with this vulnerability look a bit like IOKit C++ objects. Their common base class looks like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.23741390b29a0e8a199a26eb39699e3e43f7695e&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.1&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;__cppobj RTKIT_RC_RTTI_BASE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; RTKIT_RC_RTTI_BASE_vtbl &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;__vftable &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c30&quot;&gt;/*VFT*/&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint32_t refcnt&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint32_t &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;typeid&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;};&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;(These structure definitions are in the format IDA uses for C++-like objects)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;RTKit&lt;/span&gt;&lt;span&gt;&amp;nbsp;base class has a vtable pointer, a reference count and a four-byte Run Time Type Information (RTTI) field - a 4-byte ASCII identifier like &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;BLHA&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;WOLO&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;MMAP&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;UNPI&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;OSST&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;OSBO&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;and so on. These identifiers look a bit cryptic but they&#39;re quite descriptive once you figure them out (and I&#39;ll describe the relevant ones as we encounter them.)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;The base type has the following associated vtable:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.e2f588f986d4c4d814dde7976c00d512e7353bbe&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.2&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c30&quot;&gt;/*VFT*/&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;RTKIT_RC_RTTI_BASE_vtbl&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;__cdecl &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;take_ref&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;RTKIT_RC_RTTI_BASE &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;__cdecl &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;drop_ref&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;RTKIT_RC_RTTI_BASE &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;__cdecl &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;take_global_type_ref&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;RTKIT_RC_RTTI_BASE &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;__cdecl &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;drop_global_type_ref&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;RTKIT_RC_RTTI_BASE &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;__cdecl &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;getClassName&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;RTKIT_RC_RTTI_BASE &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;__cdecl &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;dtor_a&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;RTKIT_RC_RTTI_BASE &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;__cdecl &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;unk&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;RTKIT_RC_RTTI_BASE &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;};&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;h2 class=&quot;HovzfPYjjR-c15 HovzfPYjjR-c8&quot; id=&quot;h.17hwrgmah5ee&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c16 HovzfPYjjR-c2&quot;&gt;Exploit flow&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The exploit running in the app starts by opening an IOKit user client for the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;AppleCLCD2&lt;/span&gt;&lt;span&gt;&amp;nbsp;service. &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;AppleCLCD&lt;/span&gt;&lt;span&gt;&amp;nbsp;seems to be the application processor of &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;IOMobileFrameBuffer&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;AppleCLCD2&lt;/span&gt;&lt;span&gt;&amp;nbsp;the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;DCP&lt;/span&gt;&lt;span&gt;&amp;nbsp;version.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The exploit only calls 3 different external method selectors on the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;AppleCLCD2&lt;/span&gt;&lt;span&gt;&amp;nbsp;user client: &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;68&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;78&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;79&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;The one with the largest and most interesting-looking input is 78, which corresponds to this user client method in the kernel driver:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.c1d0de88bea2ae99b6a4f974f60cac134013db41&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.3&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;IOReturn&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;IOMobileFramebufferUserClient&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;s_set_block&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;IOMobileFramebufferUserClient&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;reference&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;IOExternalMethodArguments&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;__int64 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;extra_args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; u8 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structureInput&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; structureInput &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structureInput&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;structureInput &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;scalarInputCount &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;scalarInputCount &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; extra_args &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0LL&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;else&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; extra_args &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;scalarInput &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;framebuffer_ap&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;set_block_dcp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;scalarInput&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;],&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;scalarInput&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;],&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;extra_args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;scalarInputCount &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;structureInput&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structureInputSize&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0xE00002C2&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;this unpacks the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;IOConnectCallMethod&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;arguments and passes them to:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.4b4f98b94b8ed8638b5222e4f9d81049bbe69fdb&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.4&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;IOMobileFramebufferAP&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;set_block_dcp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;IOMobileFramebufferAP&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; task &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;first_scalar_input&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;second_scalar_input&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;__int64 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;pointer_to_remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;scalar_input_count_minus_2&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;__int8 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;struct_input&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;__int64 struct_input_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;This method uses some autogenerated code to serialise the external method arguments into a buffer like this: &lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.26b4f1ef327e79bf7a370b395d86bddb90eb464f&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.5&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;arg_struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;task&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;task&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; u64 scalar_input_0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; u64 scalar_input_1&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; u64&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;remaining_scalar_inputs&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; u64 cntExtraScalars&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; u8&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;structInput&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; u64 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;CntStructInput&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;which is then passed to &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;UnifiedPipeline2::rpc&lt;/span&gt;&lt;span&gt;&amp;nbsp;along with a 4-byte ASCII method identifier (&#39;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;A435&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&#39; here):&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.afc7096b3986ce85a82073984786eb19b4fcdb59&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.6&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;UnifiedPipeline2&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;rpc&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&#39;A435&#39;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; arg_struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0x105Cu&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;retval_buf&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;4u&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;UnifiedPipeline2::rpc&lt;/span&gt;&lt;span&gt;&amp;nbsp;calls &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;DCPLink::rpc&lt;/span&gt;&lt;span&gt;&amp;nbsp;which calls &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;AppleDCPLinkService::rpc&lt;/span&gt;&lt;span&gt;&amp;nbsp;to perform one more level of serialisation which packs the method identifier and a &quot;stream identifier&quot; together with the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;arg_struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;shown above.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;AppleDCPLinkService::rpc&lt;/span&gt;&lt;span&gt;&amp;nbsp;then calls &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;rpc_caller_gated&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;to allocate space in a shared memory buffer, copy the buffer into there then signal to the DCP that a message is available.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;Effectively the implementation of the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;IOMobileFramebuffer&lt;/span&gt;&lt;span&gt;&amp;nbsp;user client has been moved on to the DCP and the external method interface is now a proxy shim, via shared memory, to the actual implementations of the external methods which &lt;/span&gt;&lt;span&gt;run on the DCP.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;HovzfPYjjR-c15 HovzfPYjjR-c8&quot; id=&quot;h.5nfahlo9nbh6&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c16 HovzfPYjjR-c2&quot;&gt;Exploit flow: the other side&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The next challenge is to find where the messages start being processed on the DCP. Looking through the log strings there&#39;s a function which is clearly called ​​&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;rpc_calle&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c26&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;_gated&lt;/span&gt;&lt;span&gt;&amp;nbsp;- quite likely that&#39;s the receive side of the function &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;rpc_calle&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c26&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;_gated&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;we saw earlier.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;rpc_callee_gated&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;unpacks the wire format then has an enormous switch statement which maps all the 4-letter RPC codes to function pointers:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.47d68344bf5cd802c2cfc796e38eefd94678d525&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.7&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;switch&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;rpc_id &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&#39;A000&#39;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;goto&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;LABEL_146&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&#39;A001&#39;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; handler_fptr &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;callback_handler_A001&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&#39;A002&#39;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; handler_fptr &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;callback_handler_A002&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&#39;A003&#39;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; handler_fptr &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;callback_handler_A003&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&#39;A004&#39;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; handler_fptr &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;callback_handler_A004&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&#39;A005&#39;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; handler_fptr &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;callback_handler_A005&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;At the the bottom of this switch statement is the invocation of the callback handler:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.727f8d6109f87f45ecfc47e4cbc67fff73f299cf&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.8&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;ret &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;handler_fptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; meta&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; in_struct_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; in_struct_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; out_struct_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; out_struct_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;in_struct_ptr&lt;/span&gt;&lt;span&gt;&amp;nbsp;points to a copy of the serialised &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;IOConnectCallMethod&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;arguments we saw being serialized earlier on the application processor:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.a1bc79b6e0e53aa6513e954a3be969c86fa9de29&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.9&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;arg_struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;task&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;task&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; u64 scalar_input_0&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; u64 scalar_input_1&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; u64&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;remaining_scalar_inputs&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; u32 cntExtraScalars&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; u8&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;structInput&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; u64 cntStructInput&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;The callback unpacks that buffer and calls a C++ virtual function:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.423c597cfa08d39f62002779d1150a8e593d7557&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.10&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;callback_handler_A435&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; u8&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;meta&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint32_t args_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;out_struct_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp; uint32_t out_struct_size&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; int64 instance_id&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint64_t instance&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;err&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;retval&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;result&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; instance_id &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;meta&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;instance_id&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; instance &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; global_instance_table&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;instance_id&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;IOMobileFramebufferType&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;instance &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; log_fatal&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&quot;IOMFB: %s: no instance for instance ID: %u\n&quot;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&quot;static T *IOMFB::InstanceTracker::instance&quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&quot;(IOMFB::InstanceTracker::tracked_entity_t, uint32_t)&quot;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&quot; [T = IOMobileFramebuffer]&quot;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; instance_id&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; err &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1 HovzfPYjjR-c11&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c11&quot;&gt;instance&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1 HovzfPYjjR-c11&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4 HovzfPYjjR-c11&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1 HovzfPYjjR-c11&quot;&gt;)-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c11&quot;&gt;vtable_0x378&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c30&quot;&gt;// virtual call&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;instance&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;),&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;scalar_input_0&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;scalar_input_1&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;cntExtraScalars&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structInput&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;args&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;cntStructInput&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; retval &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;convert_error&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; result &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;_DWORD &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;out_struct_ptr &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;retval&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;result&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The challenge here is to figure out where&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c11&quot;&gt;that virtual call&lt;/span&gt;&lt;span&gt;&amp;nbsp;goes&lt;/span&gt;&lt;span&gt;. The object is being looked up in a global table based on the instance id. We can&#39;t just set a breakpoint and whilst emulating the firmware is probably possible that would likely be a long project in itself. I took a hackier approach: we know that the vtable needs to be at least &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x380&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;bytes large so just go through all those vtables, decompile them and see if the prototypes look reasonable!&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;There&#39;s one clear match in the vtable for the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;UNPI&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;type:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.ac38f56155b7d2697b0aee9ae6858f6b42815b34&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.11&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;UNPI&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;set_block&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; UNPI&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;task&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;caller_task_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;first_scalar_input&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;second_scalar_input&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; uint32_t cnt_remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; uint8_t &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structure_input_buffer&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; uint64_t structure_input_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;Here&#39;s my reversed implementation of &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;UNPI::set_block&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.3aba48cdaac58ae867b60889bc2f2ff94e4953a6&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.12&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;UNPI&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;set_block&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; UNPI&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;task&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;caller_task_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;first_scalar_input&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;second_scalar_input&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; uint32_t cnt_remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; uint8_t &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structure_input_buffer&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; uint64_t structure_input_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;block_handler_holder &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;holder&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;metadispatcher metadisp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;second_scalar_input &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0x80000001LL&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; holder &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;UPPipeDCP_H13P&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;block_handler_holders&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;holder &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0x8000000BLL&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; metadisp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;address_of_some_zerofill_static_buffer &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;unk_3B8D18&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; metadisp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;handlers_holder &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;holder&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; metadisp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structure_input_buffer &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;structure_input_buffer&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; metadisp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structure_input_size &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;structure_input_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; metadisp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;remaining_scalar_inputs &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; metadisp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;cnt_remaining_sclar_input &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;cnt_remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; metadisp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;some_flags &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0x40000000LL&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; metadisp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;dispatcher_fptr &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;a_dispatcher&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; metadisp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;offset_of_something_which_looks_serialization_related &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;off_1C1308&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;metadispatch&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;holder&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;first_scalar_input&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;caller_task_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;structure_input_buffer&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;metadisp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;This method wraps up the arguments into another structure I&#39;ve called &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;metadispatcher&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.70518115c511a294cd855553b9003a0771a08ccd&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.13&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;__attribute__&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;aligned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)))&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;metadispatcher&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;uint64_t address_of_some_zerofill_static_buffer&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;uint64_t some_flags&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;__int64 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;__fastcall &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;dispatcher_fptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;metadispatcher &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;BlockHandler&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;__int64&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;_QWORD&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;uint64_t offset_of_something_which_looks_serialization_related&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;block_handler_holder &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;handlers_holder&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;uint64_t structure_input_buffer&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;uint64_t structure_input_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;uint64_t remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;uint32_t cnt_remaining_sclar_input&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;};&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;That metadispatcher object is then passed to this method:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.9e3136a3d4346cb21c1c8dc0948c6e7439c8fc5f&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.14&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;metadispatch&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;holder&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;first_scalar_input&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;caller_task_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;structure_input_buffer&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;metadisp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;In there we reach this code:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.b1eaf3e2e954d8f37bc987b98c30e92ce161e849&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.15&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; block_type_handler &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;lookup_a_handler_for_block_type_and_subtype&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;a1&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;first_scalar_input&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c30&quot;&gt;// block_type&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;a3&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c30&quot;&gt;// subtype&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The exploit calls this &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;set_block&lt;/span&gt;&lt;span&gt;&amp;nbsp;external method twice, passing two different values for &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;first_scalar_input&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;7&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;19&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;. Here we can see that those correspond to looking up two different block handler objects here.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The lookup function searches a linked list of block handler structures; the head of the list is stored at offset &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x1448&lt;/span&gt;&lt;span&gt;&amp;nbsp;in the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;UPPipeDCP_H13P&lt;/span&gt;&lt;span&gt;&amp;nbsp;object and registered dynamically by a method I&#39;ve named &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;add_handler_for_block_type&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.0dbaa54d4462638b9beda378f3267a7a7c4ded25&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.16&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;add_handler_for_block_type&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;block_handler_holder &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;handler_list&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;BlockHandler&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The logging code tells us that this is in a file called &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;IOMFBBlockManager.cpp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;. IDA finds 44 cross-references to this method, indicating that there are probably that many different block handlers. The structure of each registered block handler is something like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.3c5d4c46eb785d82b4debfb43373bde140bc52fe&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.17&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;__cppobj &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;BlockHandler&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;RTKIT_RC_RTTI_BASE&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint64_t field_16&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;handler_inner_types_entry &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;inner_types_array&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint32_t n_inner_types_array_entries&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint32_t field_36&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint8_t can_run_without_commandgate&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint32_t block_type&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint64_t list_link&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint64_t list_other_link&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint32_t some_other_type_field&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint32_t some_other_type_field2&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint32_t expected_structure_io_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint32_t field_76&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint64_t getBlock_Impl&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint64_t setBlock_Impl&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint64_t field_96&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint64_t back_ptr_to_UPPipeDCP_H13P&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;};&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The RTTI type is &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;BLHA&lt;/span&gt;&lt;span&gt;&amp;nbsp;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;BL&lt;/span&gt;&lt;span&gt;ock &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;HA&lt;/span&gt;&lt;span&gt;ndler.)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;For example, here&#39;s the codepath which builds and registers block handler type 24:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.15a6e240c53ab46ec843eed2902a63a7ce3a078d&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.18&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;BlockHandler&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;CXXnew&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;112LL&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;__vftable &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;BlockHandler_vtbl&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_super_vtable&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;block_type &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;refcnt &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;can_run_without_commandgate &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;some_other_type_field &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0LL&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;expected_structure_io_size &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0xD20&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;typeid&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;typeid_BLHA&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;();&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;typeid&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;typeid&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;modify_typeid_ref&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;typeid&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;__vftable &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;vtable_BLHA_subclass_type_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;inner_types_array &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0LL&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;n_inner_types_array_entries &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;getBlock_Impl &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;BLHA_24_getBlock_Impl&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;setBlock_Impl &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;BLHA_24_setBlock_Impl&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;field_96 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0LL&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;back_ptr_to_UPPipeDCP_H13P &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;a1&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;add_handler_for_block_type&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;list_holder&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;BLHA_24&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;Each block handler optionally has &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;getBlock_Impl&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;setBlock_Impl&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;function pointers which appear to implement the actual setting and getting operations.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;We can go through all the callsites which add block handlers; tell IDA the type of the arguments and name all the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;getBlock&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;setBlock&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;implementations:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;img /&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg-Z34Qgm9fUE2rzMwJWQ3j-w7InvtfHj5fs2qctSh0tTFmMbUpnrsQC4rUrhMf3_83uHAFinlM6xKqKXgUc2QR5IfL0gf4YEBM9Rqgrc6sNYsaCZ-JAe0PHlGa9VYcBgWfTqj5rTtin1mWTDG-I8K5M41EhA64KLNV54Sv9lvtbYIrkY2j37X6SniB/s1436/Screenshot%202022-06-22%20at%2016.53.47.png&quot; style=&quot;display: block; padding: 1em 0; text-align: center;&quot;&gt;&lt;img alt=&quot;The IDA Pro Names window showing a list of symbols like BLHA_15_getBlock_Impl.&quot; border=&quot;0&quot; src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg-Z34Qgm9fUE2rzMwJWQ3j-w7InvtfHj5fs2qctSh0tTFmMbUpnrsQC4rUrhMf3_83uHAFinlM6xKqKXgUc2QR5IfL0gf4YEBM9Rqgrc6sNYsaCZ-JAe0PHlGa9VYcBgWfTqj5rTtin1mWTDG-I8K5M41EhA64KLNV54Sv9lvtbYIrkY2j37X6SniB/s1200/Screenshot%202022-06-22%20at%2016.53.47.png&quot; style=&quot;max-height: 750; max-width: 600px;&quot; title=&quot;The IDA Pro Names window showing a list of symbols like BLHA_15_getBlock_Impl.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;You can perhaps see where this is going: that&#39;s looking like really quite a lot of reachable attack surface! Each of those &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;setBlock_Impl&lt;/span&gt;&lt;span&gt;&amp;nbsp;functions is reachable by passing a different value for the first scalar argument to &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;IOConnectCallMethod&lt;/span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;78&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;There&#39;s a little bit more reversing though to figure out how exactly to get controlled bytes to those &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;setBlock_Impl&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;functions:&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;HovzfPYjjR-c8 HovzfPYjjR-c15&quot; id=&quot;h.7aa6aljwlb56&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c16 HovzfPYjjR-c2&quot;&gt;Memory Mapping&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The raw &quot;block&quot; input to each of those &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;setBlock_Impl&lt;/span&gt;&lt;span&gt;&amp;nbsp;methods isn&#39;t passed inline in the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;IOConnectCallMethod&lt;/span&gt;&lt;span&gt;&amp;nbsp;structure input. There&#39;s another level of indirection: each individual block handler structure has an array of supported &quot;subtypes&quot; which contains metadata detailing where to find the (userspace) pointer to that subtype&#39;s input data in the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;IOConnectCallMethod&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;structure input. The first dword in the structure input is the id of this subtype - in this case for the block handler type 19 the metadata array has a single entry:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&amp;lt;2, 0, 0x5F8, 0x600&amp;gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The first value (&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;2&lt;/span&gt;&lt;span&gt;) is the subtype id and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x5f8&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x600&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;tell the DCP from what offset in the structure input data to read a pointer and size from. The DCP then requests a memory mapping from the AP for that memory from the calling task:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.aba9dc90c6ed53b6789430b30f81bcfaea4d57c4&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.19&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;wrap_MemoryDescriptor&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;withAddressRange&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structure_input_buffer &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;addr_offset&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;),&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structure_input_buffer &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;size_offset&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;),&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; caller_task_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;We saw earlier that the AP sends the DCP the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;struct task&lt;/span&gt;&lt;span&gt;&amp;nbsp;pointer of the calling task; when the DCP requests a memory mapping from a user task it sends those raw task struct pointers back to the AP such that the kernel can perform the mapping from the correct task. The memory mapping is abstracted as an &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;MDES&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;object on the DCP side; the implementation of the mapping involves the DCP making an RPC to the AP:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.3170af9bf4e5590254e3fb8ce48d68439d2d1c04&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.20&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;make_link_call&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c22&quot;&gt;&#39;D453&#39;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0x20&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0x14&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;which corresponds to a call to this method on the AP side:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.6497588dbb4a0e06e642bb1567a0fe45e731eabb&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.21&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;IOMFB&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;MemDescRelay&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;withAddressRange&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;task&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The DCP calls &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;::prepare&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;::map&lt;/span&gt;&lt;span&gt;&amp;nbsp;on the returned &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;MDES&lt;/span&gt;&lt;span&gt;&amp;nbsp;object (exactly like an &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;IOMemoryDescriptor&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;object in IOKit), gets the mapped pointer and size to pass via a few final levels of indirection to the block handler:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.9bfd168ba40a9f143ab7f16183ab117679ba2dbc&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.22&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;a_descriptor_with_controlled_stuff&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;dispatcher_fptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; a_descriptor_with_controlled_stuff&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; block_type_handler&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; important_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; important_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;where the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;dispatcher_fptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;looks like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.acd62f1b5ef2e8ae92523e3f984117951fec44d7&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.23&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;a_dispatcher&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;metadispatcher &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;disp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;BlockHandler&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;block_handler&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; __int64 controlled_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;controlled_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;block_handler&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;BlockHandler_setBlock&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;block_handler&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;disp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structure_input_buffer&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;disp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structure_input_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;disp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;disp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;cnt_remaining_sclar_input&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;disp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;handlers_holder&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;gate&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;controlled_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;controlled_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;You can see here just how useful it is to keep making structure definitions while reversing; there are so many levels of indirection that it&#39;s pretty much impossible to keep it all in your head.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;BlockHandler_setBlock&lt;/span&gt;&lt;span&gt;&amp;nbsp;is a virtual method on &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;BLHA&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;&amp;nbsp;This is the implementation for &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;BLHA&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;19:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.54f6196429ae58c591e0fbda962486be871b857c&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.24&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;BlockHandler19&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;setBlock&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;BlockHandler&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structure_input_buffer&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; int64 structure_input_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; int64 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;cnt_remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;CommandGate&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;gate&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;mapped_mdesc_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;mapped_mdesc_length&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;This uses a Command Gate (&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;GATI&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;) object (like a call gate in IOKit to serialise calls) to finally get close to actually calling the setBlock_Impl function.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;We need to reverse the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;gate_context&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;structure to follow the controlled data through the gate:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.ecbfc354e58e0a03f109ff9486e9e7688b91b2e0&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.25&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;__attribute__&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;aligned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)))&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;gate_context&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;BlockHandler&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;the_target_this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;uint64_t structure_input_buffer&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;uint32_t cnt_remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;uint32_t field_28&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;uint64_t controlled_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;uint32_t controlled_length&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;};&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;The callgate object uses that context object to finally call the BLHA setBlock handler:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.af3652c5bd10314e902473b353a7422786c1de2f&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.26&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;callback_used_by_callgate_in_block_19_setBlock&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;UnifiedPipeline&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;parent_pipeline&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;gate_context &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; int64 a3&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; int64 a4&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; int64 a5&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;context&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;the_target_this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;setBlock_Impl&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)(&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;context&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;the_target_this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;back_ptr_to_UPPipeDCP_H13P&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;context&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structure_input_buffer&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;context&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;context&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;cnt_remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;context&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;controlled_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;context&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;controlled_length&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;h2 class=&quot;HovzfPYjjR-c15 HovzfPYjjR-c8&quot; id=&quot;h.3xz0wc9abhwz&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c16 HovzfPYjjR-c2&quot;&gt;SetBlock_Impl&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;And finally we&#39;ve made it through the whole callstack following the controlled data from &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;IOConnectCallMethod&lt;/span&gt;&lt;span&gt;&amp;nbsp;in userspace on the AP to the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;setBlock_Impl&lt;/span&gt;&lt;span&gt;&amp;nbsp;methods on the DCP!&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The prototype of the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;setBlock_Impl&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;methods looks like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.ce1b657ebc4685a8be9f9a3720b828c0f9a2d7ce&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.27&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;setBlock_Impl&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;UPPipeDCP_H13P&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;pipe_parent&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;structure_input_buffer&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;cnt_remaining_scalar_inputs&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;ptr_via_memdesc&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;len_of_memdesc_mapped_buf&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The exploit calls two &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;setBlock_Impl&lt;/span&gt;&lt;span&gt;&amp;nbsp;methods; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;7&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;19&lt;/span&gt;&lt;span&gt;. 7 is fairly simple and seems to just be used to put controlled data in a known location. 19 is the buggy one. From the log strings we can tell that block type 19 handler is implemented in a file called &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;UniformityCompensator.cpp&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://www.benq.com/en-us/knowledge-center/knowledge/screen-uniformity.html&quot;&gt;Uniformity Compensation&lt;/a&gt;&lt;/span&gt;&lt;span&gt;&amp;nbsp;is a way to correct for inconsistencies in brightness and colour reproduction across a display panel. Block type 19 sets and gets a data structure containing this correction information. The &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;setBlock_Impl&lt;/span&gt;&lt;span&gt;&amp;nbsp;method calls &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;UniformityCompensator::set&lt;/span&gt;&lt;span&gt;&amp;nbsp;and reaches the following code snippet where &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;controlled_size&lt;/span&gt;&lt;span&gt;&amp;nbsp;is a fully-controlled u32 value read from the structure input and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;indirect_buffer_ptr&lt;/span&gt;&lt;span&gt;&amp;nbsp;points to the mapped buffer, the contents of which are also controlled:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;a id=&quot;t.7beb7cf889ce845693bd09783570df3d7b3034d3&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.28&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;uint8_t&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;pages &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;compensator&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;inline_buffer&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c30&quot;&gt;// +0x24&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;pg_cnt &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;pg_cnt &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;pg_cnt&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;++)&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; uint8_t&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;this_page &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;pages&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;i &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;i &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;controlled_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;i&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;++)&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;{&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; memcpy&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;this_page&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;indirect_buffer_ptr&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;controlled_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; indirect_buffer_ptr &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;+=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;controlled_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &amp;nbsp; this_page &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;+=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0x100&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; pages &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;+=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0x4000&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;}&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c6 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;There&#39;s a distinct lack of bounds checking on &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;controlled_size&lt;/span&gt;&lt;span&gt;. Based on the structure of the code it looks like it should be restricted to be less than or equal to &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;64&lt;/span&gt;&lt;span&gt;&amp;nbsp;(as that would result in the input being completely copied to the output buffer.) The &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;compensator-&amp;gt;inline_buffer&lt;/span&gt;&lt;span&gt;&amp;nbsp;buffer is inline in the compensator object. The structure of the code makes it look that that buffer is probably &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0xc000&lt;/span&gt;&lt;span&gt;&amp;nbsp;(three 16k pages) large. To verify this we need to find the allocation site of this compensator object.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;It&#39;s read from the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;pipe_parent&lt;/span&gt;&lt;span&gt;&amp;nbsp;object and we know that at this point &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;pipe_parent&lt;/span&gt;&lt;span&gt;&amp;nbsp;is a &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;UPPipeDCP_H13P&lt;/span&gt;&lt;span&gt;&amp;nbsp;object.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;There&#39;s only one write to that field, here in &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;UPPipeDCP_H13P::setup_tunables_base_target&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.76bc35a503bf64e16502962e6e6a4632f74fe58f&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.29&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;compensator &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c14&quot;&gt;CXXnew&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0xC608LL&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;);&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c9&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;compensator &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;compensator&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The compensator object is a &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0xc608&lt;/span&gt;&lt;span&gt;&amp;nbsp;byte allocation; the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0xc000&lt;/span&gt;&lt;span&gt;&amp;nbsp;sized buffer starts at offset &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x24&lt;/span&gt;&lt;span&gt;&amp;nbsp;so the allocation has enough space for &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0xc608-0x24=0xC5E4&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;bytes before corrupting neighbouring objects.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The structure input provided by the exploit for the block handler 19 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;setBlock&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;call looks like this:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.ab31ebe17a793d09fa94c11be61a4134ecf08386&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.30&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;struct_input_for_block_handler_19&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0x5F4&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;70&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c30&quot;&gt;// controlled_size&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;struct_input_for_block_handler_19&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0x5F8&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;address&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;struct_input_for_block_handler_19&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;0x600&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;a_size&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;This leads to a value of 70 (0x46) for &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;controlled_size&lt;/span&gt;&lt;span&gt;&amp;nbsp;in the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;UniformityCompensator::set&lt;/span&gt;&lt;span&gt;&amp;nbsp;snippet shown earlier. (&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x5f8&lt;/span&gt;&lt;span&gt;&amp;nbsp;and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x600&lt;/span&gt;&lt;span&gt;&amp;nbsp;correspond to the offsets we saw earlier in the subtype&#39;s table: &amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;&amp;lt;2, 0, 0x5F8, 0x600&amp;gt;)&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The inner loop increments the destination pointer by &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x100&lt;/span&gt;&lt;span&gt;&amp;nbsp;each iteration so &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x46&lt;/span&gt;&lt;span&gt;&amp;nbsp;loop iterations will write &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x4618&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;bytes.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The outer loop writes to three subsequent &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x4000&lt;/span&gt;&lt;span&gt;&amp;nbsp;byte blocks so the third (final) iteration starts writing at &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x24 + 0x8000&lt;/span&gt;&lt;span&gt;&amp;nbsp;and writes a total of &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x4618&lt;/span&gt;&lt;span&gt;&amp;nbsp;bytes, meaning the object would need to be &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0xC63C&lt;/span&gt;&lt;span&gt;&amp;nbsp;bytes; but we can see that it&#39;s only &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0xc608&lt;/span&gt;&lt;span&gt;, meaning that it will overflow the allocation size by &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x34&lt;/span&gt;&lt;span&gt;&amp;nbsp;bytes. The RTKit malloc implementation looks like it adds 8 bytes of metadata to each allocation so the next object starts at &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0xc610&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;How much input is consumed? The input is fully consumed with no &quot;rewinding&quot; so it&#39;s &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;3*0x46*0x46*4 = 0xe5b0&lt;/span&gt;&lt;span&gt;&amp;nbsp;bytes. Working backwards from the end of that buffer we know that the final &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0x34&lt;/span&gt;&lt;span&gt;&amp;nbsp;bytes of it go off the end of the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;0xc608&lt;/span&gt;&lt;span&gt;&amp;nbsp;allocation which means &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;+0xe57c&lt;/span&gt;&lt;span&gt;&amp;nbsp;in the input buffer will be the first byte which corrupts the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;8&lt;/span&gt;&lt;span&gt;&amp;nbsp;metadata bytes and &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;+0x8584&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;will be the first byte to corrupt the next object:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;a href=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjTc6JqgJIYvcwLtg14PNyjGRL4ds-1hzVvPPYmuSbJ3TiMHTXI3loB4Ib4caBv06WwUAa2H3eEldnlVKePnyUDTxYy6-W0VyMbVSn1YrcilcuOmjeYPwzdQ0ONiWlZbc34oZBXv6hftbOK57Qu_NupLfhgI-Iqc9U51KfJVF5YRk4YmBFcYdoaH27q/s1888/Screenshot%202022-06-22%20at%2016.54.15.png&quot; style=&quot;display: block; padding: 1em 0; text-align: center;&quot;&gt;&lt;img alt=&quot;A diagram showing that the end of the overflower object overlaps with the metadata and start of the target object.&quot; border=&quot;0&quot; src=&quot;https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjTc6JqgJIYvcwLtg14PNyjGRL4ds-1hzVvPPYmuSbJ3TiMHTXI3loB4Ib4caBv06WwUAa2H3eEldnlVKePnyUDTxYy6-W0VyMbVSn1YrcilcuOmjeYPwzdQ0ONiWlZbc34oZBXv6hftbOK57Qu_NupLfhgI-Iqc9U51KfJVF5YRk4YmBFcYdoaH27q/s1200/Screenshot%202022-06-22%20at%2016.54.15.png&quot; style=&quot;max-height: 750; max-width: 600px;&quot; title=&quot;A diagram showing that the end of the overflower object overlaps with the metadata and start of the target object.&quot; /&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;This matches up exactly with the overflow object which the exploit builds:&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;a id=&quot;t.87397a57c7bdef65de5578925dd0ccccbdee255a&quot;&gt;&lt;/a&gt;&lt;a id=&quot;t.31&quot;&gt;&lt;/a&gt;&lt;table class=&quot;HovzfPYjjR-c20&quot;&gt;&lt;tr class=&quot;HovzfPYjjR-c18&quot;&gt;&lt;td class=&quot;HovzfPYjjR-c13&quot; colspan=&quot;1&quot; rowspan=&quot;1&quot;&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; v24 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;address &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c23&quot;&gt;0xE584&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; v25 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;_DWORD &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)&amp;amp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;v54&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;48&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; v26 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;_OWORD &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)&amp;amp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;v54&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;32&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; v27 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;_OWORD &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)&amp;amp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;v54&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;];&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;_OWORD &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;address &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c23&quot;&gt;0xE584&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;_OWORD &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;v54&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;_OWORD &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;v24 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;v27&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;_OWORD &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;v24 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;32&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;v26&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;HovzfPYjjR-c3&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;_DWORD &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;*)(&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;v24 &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c4&quot;&gt;48&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c0&quot;&gt;&amp;nbsp;v25&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c1&quot;&gt;;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;The destination object seems to be allocated very early and the DCP RTKit environment appears to be very deterministic with no ASLR. Almost certainly they are attempting to corrupt a neighbouring C++ object with a fake vtable pointer.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;Unfortunately for our analysis the trail goes cold here and we can&#39;t fully recreate the rest of the exploit. The bytes for the fake DCP C++ object are read from a file in the app&#39;s temporary directory (&lt;/span&gt;&lt;span&gt;base64 encoded inside a JSON file under the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;exploit_struct_offsets&lt;/span&gt;&lt;span&gt;&amp;nbsp;key&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;) and I don&#39;t have a copy of that file. But based on the flow of the rest of the exploit it&#39;s pretty clear what happens next:&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;HovzfPYjjR-c15 HovzfPYjjR-c8&quot; id=&quot;h.wtkqcqujjnsf&quot;&gt;&lt;span&gt;sudo make me &lt;/span&gt;&lt;span&gt;a&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c16 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;DART mapping&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;The DCP, like other coprocessors on iPhone, sits behind a DART (Device Address Resolution Table.) This is like an SMMU (IOMMU in the x86 world) which forces an extra layer of physical address lookup between the DCP and physical memory. &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://googleprojectzero.blogspot.com/2017/10/over-air-vol-2-pt-3-exploiting-wi-fi.html&quot;&gt;DART was covered in great detail in Gal Beniamini&#39;s Over The Air - Vol. 2, Pt. 3 blog post&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;The DCP clearly needs to access lots of buffers owned by userspace tasks as well as memory managed by the kernel. To do this the DCP makes RPC calls back to the AP which modifies the DART entries accordingly. This appears to be exactly what the DCP exploit does: the D45X family of DCP-&amp;gt;AP RPC methods appear to expose an interface for requesting arbitrary physical as well as virtual addresses to be mapped into the DCP DART.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;The fake C++ object is most likely a stub which makes such calls on behalf of the exploit, allowing the exploit to read and write kernel memory.&lt;/span&gt;&lt;/p&gt;&lt;h2 class=&quot;HovzfPYjjR-c15 HovzfPYjjR-c8&quot; id=&quot;h.gkcey04fmfci&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c16 HovzfPYjjR-c2&quot;&gt;Conclusions&lt;/span&gt;&lt;/h2&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;Segmentation and isolation are in general a positive thing when it comes to security. However, splitting up an existing system into separate, intercommunicating parts can end up exposing unexpected code in unexpected ways.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;We&#39;ve had discussions within Project Zero about whether this DCP vulnerability is interesting at all. After all, if the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c7&quot;&gt;UniformityCompensator&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;code was going to be running on the Application Processors anyway then the Display Co-Processor didn&#39;t really introduce or cause this bug.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;Whilst that&#39;s true, it&#39;s also the case that the DCP certainly made exploitation of this bug significantly easier and more reliable than it would have been on the AP. Apple has invested heavily in memory corruption mitigations over the last few years, so moving an attack surface from a &quot;mitigation heavy&quot; environment to a &quot;mitigation light&quot; one is a regression in that sense.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;Another perspective is that the DCP just isn&#39;t isolated enough; perhaps the intention was to try to isolate the code on the DCP such that even if it&#39;s compromised it&#39;s limited in the effect it could have on the entire system. For example, there might be models where the DCP to AP RPC interface is much more restricted.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;But again there&#39;s a tradeoff: the more restrictive the RPC API, the more the DCP code has to be refactored - a significant investment. Currently, the codebase relies on being able to map arbitrary memory and the API involves passing userspace pointers back and forth.&lt;/span&gt;&lt;/p&gt;
 &lt;p class=&quot;c3 c8 c10&quot;&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;
 &lt;p class=&quot;HovzfPYjjR-c3 HovzfPYjjR-c8&quot;&gt;&lt;span&gt;I&#39;ve discussed in recent posts how attackers tend to be ahead of the curve. As the curve slowly shifts towards memory corruption exploitation getting more expensive, attackers are likely shifting too. We saw that in the &lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c17&quot;&gt;&lt;a class=&quot;HovzfPYjjR-c191&quot; href=&quot;https://googleprojectzero.blogspot.com/2022/03/forcedentry-sandbox-escape.html&quot;&gt;logic-bug sandbox escape used by NSO&lt;/a&gt;&lt;/span&gt;&lt;span class=&quot;HovzfPYjjR-c5 HovzfPYjjR-c2&quot;&gt;&amp;nbsp;and we see that here in this memory-corruption-based privilege escalation that side-stepped kernel mitigations by corrupting memory on a co-processor instead. Both are quite likely to continue working in some form in a post-memory tagging world. Both reveal the stunning depth of attack surface available to the motivated attacker. And both show that defensive security research still has a lot of work to do.&lt;/span&gt;&lt;/p&gt;&lt;/body&gt;</content><link rel='replies' type='application/atom+xml' href='https://googleprojectzero.blogspot.com/feeds/5973748726134682294/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='https://googleprojectzero.blogspot.com/2022/06/curious-case-carrier-app.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/5973748726134682294'/><link rel='self' type='application/atom+xml' href='https://www.blogger.com/feeds/4838136820032157985/posts/default/5973748726134682294'/><link rel='alternate' type='text/html' href='https://googleprojectzero.blogspot.com/2022/06/curious-case-carrier-app.html' title='The curious tale of a fake Carrier.app'/><author><name>Google Project Zero</name><uri>http://www.blogger.com/profile/08975904405228580347</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEioBjlvs-GjJW9ZocxERk7cU6J-bBcWIjauCAzuI6QoMvdQENbSjF6elAZ0yUpLbHfTmOzfdKWBhB_FFR8X9UF1yMqN9XSMmJSUDZ_uVX_zctpmYMaD0G6V7bi68tdJ2C-e3eyM715_cTywzOWAgSbPyazbNtMv65p0lWewhacxCox_vrztKXdRZdjB/s72-c/Screenshot%202022-06-22%20at%2016.52.33.png" height="72" width="72"/><thr:total>0</thr:total></entry>